-- MySQL dump 10.13  Distrib 5.5.35, for debian-linux-gnu (x86_64)
--
-- Host: localhost    Database: pg_test
-- ------------------------------------------------------
-- Server version	5.5.35-1ubuntu1

/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;
/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;
/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;
/*!40101 SET NAMES utf8 */;
/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;
/*!40103 SET TIME_ZONE='+00:00' */;
/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;
/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;
/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='NO_AUTO_VALUE_ON_ZERO' */;
/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;

--
-- Table structure for table `_t02_dg_proy`
--

DROP TABLE IF EXISTS `_t02_dg_proy`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `_t02_dg_proy` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t02_nro_exp` varchar(20) DEFAULT NULL,
  `t01_id_inst` int(11) NOT NULL,
  `t02_nom_proy` varchar(250) DEFAULT NULL,
  `t02_fch_apro` date DEFAULT NULL,
  `t02_fch_ini` date DEFAULT NULL,
  `t02_fch_ter` date DEFAULT NULL,
  `t02_fin` varchar(500) DEFAULT NULL,
  `t02_pro` varchar(500) DEFAULT NULL,
  `t02_ben_obj` varchar(5000) DEFAULT NULL,
  `t02_amb_geo` varchar(5000) DEFAULT NULL,
  `t02_pres_fe` double DEFAULT NULL,
  `t02_pres_eje` double NOT NULL COMMENT 'Presupuesto de la Intitucion ejecutora',
  `t02_pres_otro` double DEFAULT NULL,
  `t02_pres_tot` double DEFAULT NULL,
  `t02_moni_tema` int(11) DEFAULT NULL COMMENT 'Tomar el dato de t04_equi_proy para monitor temático',
  `t02_moni_fina` int(11) DEFAULT NULL COMMENT 'Tomar el dato de t04_equi_proy para monitor financiero',
  `t02_moni_ext` varchar(10) DEFAULT NULL COMMENT 'Tomar el dato de t01_inst_cto para monitor externo',
  `t02_sup_inst` int(11) DEFAULT NULL COMMENT 'Supervisor Institucional. Tomar el dato de la tabla t01_ejec_cto para supervisor',
  `t02_dire_proy` varchar(200) DEFAULT NULL,
  `t02_ciud_proy` varchar(50) DEFAULT NULL,
  `t02_tele_proy` varchar(30) DEFAULT NULL,
  `t02_fax_proy` varchar(30) DEFAULT NULL,
  `t02_mail_proy` varchar(50) DEFAULT NULL,
  `t02_estado` int(11) DEFAULT NULL,
  `t02_mto_line_base` double DEFAULT NULL COMMENT 'Almacena Monto Calculado de la Linea de Base 4%',
  `t02_mto_imprevisto` double DEFAULT NULL COMMENT 'Almacena Monto Calculo de Imprevistos 2%',
  `t02_est_imp` int(11) DEFAULT NULL,
  `t02_sect_prod` int(11) DEFAULT NULL COMMENT 'Sector Productivo',
  `t02_subsect_prod` int(11) DEFAULT NULL COMMENT 'SubSector Productivo',
  `t02_cre_fe` char(1) DEFAULT NULL,
  `t02_fch_isc` date DEFAULT NULL COMMENT 'Fecha de Inicio segun convenio',
  `t02_fch_ire` date DEFAULT NULL COMMENT 'Fecha de Inicio Real',
  `t02_fch_tre` date DEFAULT NULL COMMENT 'Fecha de Termino Real',
  `t02_fch_tam` date DEFAULT NULL COMMENT 'Fecha de termino con ampliacion',
  `t02_num_mes` int(3) DEFAULT NULL COMMENT 'Numero de meses',
  `t02_num_mes_amp` int(11) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `env_rev` tinyint(4) DEFAULT '0',
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`),
  KEY `t01_id_inst` (`t01_id_inst`) USING BTREE,
  CONSTRAINT `_t02_dg_proy_ibfk_1` FOREIGN KEY (`t01_id_inst`) REFERENCES `t01_dir_inst` (`t01_id_inst`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `_t08_comp`
--

DROP TABLE IF EXISTS `_t08_comp`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `_t08_comp` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL DEFAULT '0',
  `t08_comp_desc` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `t02_cod_proy` (`t02_cod_proy`,`t02_version`) USING BTREE,
  CONSTRAINT `_t08_comp_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `_t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `_t09_act`
--

DROP TABLE IF EXISTS `_t09_act`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `_t09_act` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL DEFAULT '0',
  `t09_act` varchar(250) DEFAULT NULL,
  `t09_obs` varchar(500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `t08_cod_comp` (`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `_t09_act_ibfk_1` FOREIGN KEY (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `_t08_comp` (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_acceso_directo`
--

DROP TABLE IF EXISTS `adm_acceso_directo`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_acceso_directo` (
  `per_cod` int(10) NOT NULL DEFAULT '0',
  `mnu_cod` varchar(10) NOT NULL,
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` timestamp NULL DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`per_cod`,`mnu_cod`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_caserios`
--

DROP TABLE IF EXISTS `adm_caserios`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_caserios` (
  `cod_dpto` char(2) NOT NULL DEFAULT '',
  `cod_prov` char(2) NOT NULL DEFAULT '',
  `cod_dist` char(2) NOT NULL DEFAULT '',
  `cod_case` char(4) NOT NULL COMMENT 'Codigo del Caserio',
  `nom_case` varchar(100) NOT NULL DEFAULT '',
  `usr_crea` varchar(15) DEFAULT NULL,
  `fch_crea` varchar(10) DEFAULT NULL,
  `usr_actu` varchar(15) DEFAULT NULL,
  `fch_actu` varchar(10) DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`cod_dpto`,`cod_prov`,`cod_dist`,`cod_case`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_concursos`
--

DROP TABLE IF EXISTS `adm_concursos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_concursos` (
  `num_conc` char(2) NOT NULL COMMENT 'Numero del Consurso',
  `anio_conc` int(11) DEFAULT NULL COMMENT 'Año del Consurso',
  `nom_conc` varchar(30) DEFAULT NULL COMMENT 'Nombre del Concurso',
  `abr_conc` varchar(10) DEFAULT NULL COMMENT 'Abreviatura del Concurso',
  `fec_crea` datetime DEFAULT NULL,
  `usr_crea` varchar(20) DEFAULT NULL,
  `coment_conc` varchar(200) DEFAULT NULL,
  `fec_actu` datetime DEFAULT NULL,
  `usr_actu` datetime DEFAULT NULL,
  PRIMARY KEY (`num_conc`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_concursos_tasas`
--

DROP TABLE IF EXISTS `adm_concursos_tasas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_concursos_tasas` (
  `num_conc` char(2) NOT NULL COMMENT 'Numero del Consurso',
  `cod_linea` int(11) NOT NULL COMMENT 'Codigo de Linea',
  `porc_gast_func` varchar(10) NOT NULL DEFAULT '0' COMMENT '% Gastos Funcionales',
  `porc_linea_base` varchar(10) NOT NULL DEFAULT '0' COMMENT '% Linea Base',
  `porc_imprev` varchar(10) NOT NULL DEFAULT '0' COMMENT '% Gastos Imprevistos',
  `porc_gast_superv_proy` varchar(10) NOT NULL DEFAULT '0' COMMENT '% Gastos Supervision de proyectos',
  `fec_crea` datetime DEFAULT NULL,
  `usr_crea` varchar(20) DEFAULT NULL,
  `fec_actu` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  UNIQUE KEY `concurso_linea` (`num_conc`,`cod_linea`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_md5_pwd`
--

DROP TABLE IF EXISTS `adm_md5_pwd`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_md5_pwd` (
  `codigo` varchar(20) NOT NULL,
  `codigomd5` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`codigo`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_mensajes`
--

DROP TABLE IF EXISTS `adm_mensajes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_mensajes` (
  `id_men` int(11) NOT NULL COMMENT 'Codigo del mensaje',
  `asu_men` varchar(200) DEFAULT NULL COMMENT 'Asunto del mensaje',
  `tex_men` varchar(900) DEFAULT NULL COMMENT 'Texto del Mensaje',
  `ori_men` varchar(70) DEFAULT NULL COMMENT 'El que origina el mensaje',
  `dest_men` varchar(400) DEFAULT NULL COMMENT 'Destino del Mensaje',
  `fec_men` date DEFAULT NULL COMMENT 'Fecha de envio del mensaje',
  `usu_men` varchar(30) DEFAULT NULL COMMENT 'usuario que envia el mensaje',
  `est_men` char(1) DEFAULT '0' COMMENT 'estado de mensaje',
  PRIMARY KEY (`id_men`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_menus`
--

DROP TABLE IF EXISTS `adm_menus`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_menus` (
  `mnu_cod` char(8) NOT NULL,
  `mnu_nomb` varchar(50) DEFAULT NULL,
  `mnu_apli` int(10) DEFAULT NULL,
  `mnu_link` varchar(250) DEFAULT NULL,
  `mnu_target` char(20) DEFAULT NULL,
  `mnu_parent` char(8) DEFAULT NULL,
  `mnu_activo` int(10) DEFAULT NULL,
  `mnu_class` varchar(30) DEFAULT NULL,
  `mnu_sort` int(10) DEFAULT NULL,
  `mnu_img` varchar(50) DEFAULT NULL,
  `mnu_admin` char(1) DEFAULT '0',
  PRIMARY KEY (`mnu_cod`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_menus_pagina`
--

DROP TABLE IF EXISTS `adm_menus_pagina`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_menus_pagina` (
  `mnu_cod` char(8) NOT NULL,
  `pag_cod` int(10) NOT NULL DEFAULT '0',
  `pag_nomb` varchar(50) DEFAULT NULL,
  `pag_link` varchar(100) DEFAULT NULL,
  `flg_act` char(1) DEFAULT '1',
  PRIMARY KEY (`mnu_cod`,`pag_cod`),
  CONSTRAINT `adm_menus_pagina_ibfk_1` FOREIGN KEY (`mnu_cod`) REFERENCES `adm_menus` (`mnu_cod`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_menus_perfil`
--

DROP TABLE IF EXISTS `adm_menus_perfil`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_menus_perfil` (
  `mnu_cod` char(8) NOT NULL,
  `per_cod` int(10) NOT NULL DEFAULT '0',
  `ver` char(1) DEFAULT NULL,
  `nuevo` char(1) DEFAULT NULL,
  `editar` char(1) DEFAULT NULL,
  `eliminar` char(1) DEFAULT NULL,
  `usu_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`mnu_cod`,`per_cod`),
  KEY `per_cod` (`per_cod`) USING BTREE,
  CONSTRAINT `adm_menus_perfil_ibfk_1` FOREIGN KEY (`mnu_cod`) REFERENCES `adm_menus` (`mnu_cod`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `adm_menus_perfil_ibfk_2` FOREIGN KEY (`per_cod`) REFERENCES `adm_perfiles` (`per_cod`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_parametros`
--

DROP TABLE IF EXISTS `adm_parametros`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_parametros` (
  `idparam` int(11) NOT NULL,
  `t01_cod_prog` varchar(15) DEFAULT NULL,
  `tit_proy` varchar(100) DEFAULT NULL,
  `mail_admin` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`idparam`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Parametros';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_perfiles`
--

DROP TABLE IF EXISTS `adm_perfiles`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_perfiles` (
  `per_cod` int(10) NOT NULL DEFAULT '0',
  `per_des` varchar(50) DEFAULT NULL,
  `per_abrev` varchar(15) DEFAULT NULL,
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` timestamp NULL DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` timestamp NULL DEFAULT NULL,
  PRIMARY KEY (`per_cod`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_reportes`
--

DROP TABLE IF EXISTS `adm_reportes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_reportes` (
  `cod_rpt` int(10) NOT NULL AUTO_INCREMENT,
  `tit_rpt` varchar(150) NOT NULL,
  `des_rpt` text,
  `url_rpt` varchar(150) DEFAULT NULL,
  `url_param` varchar(100) DEFAULT NULL,
  `cat_rpt` int(10) DEFAULT NULL,
  `orden` int(10) DEFAULT NULL,
  `fch_crea` timestamp NULL DEFAULT NULL,
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_actu` timestamp NULL DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `estado` int(10) DEFAULT NULL,
  PRIMARY KEY (`cod_rpt`)
) ENGINE=InnoDB AUTO_INCREMENT=82 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_reportes_categ`
--

DROP TABLE IF EXISTS `adm_reportes_categ`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_reportes_categ` (
  `cod_cate` int(10) NOT NULL AUTO_INCREMENT,
  `nom_cate` varchar(30) DEFAULT NULL,
  PRIMARY KEY (`cod_cate`)
) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_tablas`
--

DROP TABLE IF EXISTS `adm_tablas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_tablas` (
  `cod_tabla` int(10) NOT NULL DEFAULT '0',
  `nom_tabla` varchar(50) NOT NULL,
  `flg_act` int(10) DEFAULT NULL,
  PRIMARY KEY (`cod_tabla`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_tablas_aux`
--

DROP TABLE IF EXISTS `adm_tablas_aux`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_tablas_aux` (
  `codi` int(10) NOT NULL DEFAULT '0',
  `descrip` varchar(100) NOT NULL,
  `abrev` varchar(15) NOT NULL,
  `cod_ext` varchar(20) DEFAULT NULL,
  `flg_act` char(1) NOT NULL,
  `idTabla` int(10) NOT NULL DEFAULT '0',
  `orden` int(10) NOT NULL DEFAULT '1',
  `usu_crea` varchar(20) DEFAULT NULL,
  `fec_crea` date DEFAULT NULL,
  `usu_actu` varchar(20) DEFAULT NULL,
  `fec_actu` date DEFAULT NULL,
  PRIMARY KEY (`codi`,`orden`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_tablas_aux2`
--

DROP TABLE IF EXISTS `adm_tablas_aux2`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_tablas_aux2` (
  `codi` int(10) NOT NULL DEFAULT '0',
  `descrip` varchar(100) NOT NULL,
  `abrev` varchar(15) NOT NULL,
  `cod_ext` varchar(20) DEFAULT NULL,
  `flg_act` char(1) NOT NULL,
  `idTabla` int(10) NOT NULL DEFAULT '0',
  `id_tabla_aux` int(10) NOT NULL DEFAULT '0',
  `orden` int(10) DEFAULT NULL,
  `usu_crea` varchar(20) NOT NULL,
  `fec_crea` date NOT NULL DEFAULT '0000-00-00',
  `usu_actu` varchar(20) NOT NULL,
  `fec_actu` date NOT NULL DEFAULT '0000-00-00',
  PRIMARY KEY (`codi`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_tipo_avance_planes`
--

DROP TABLE IF EXISTS `adm_tipo_avance_planes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_tipo_avance_planes` (
  `codi` char(1) NOT NULL COMMENT 'P: En Proceso, C:Capacitado, R:Retirado',
  `descrip` varchar(30) NOT NULL COMMENT 'Nombre ',
  `valor` int(11) NOT NULL COMMENT 'Valor especifico',
  `observa` varchar(250) DEFAULT NULL,
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`codi`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_ubigeo`
--

DROP TABLE IF EXISTS `adm_ubigeo`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_ubigeo` (
  `cod_dpto` char(2) NOT NULL,
  `cod_prov` char(2) NOT NULL,
  `cod_dist` char(2) NOT NULL,
  `nom_ubig` varchar(50) NOT NULL,
  `usr_crea` varchar(15) DEFAULT NULL,
  `fch_crea` varchar(10) DEFAULT NULL,
  `usr_actu` varchar(15) DEFAULT NULL,
  `fch_actu` varchar(10) DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`cod_dpto`,`cod_prov`,`cod_dist`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_usuarios`
--

DROP TABLE IF EXISTS `adm_usuarios`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_usuarios` (
  `coduser` varchar(10) NOT NULL,
  `tipo_user` char(3) NOT NULL,
  `nom_user` varchar(50) NOT NULL,
  `clave_user` varchar(50) NOT NULL,
  `mail` varchar(50) DEFAULT NULL,
  `t01_id_uni` varchar(8) DEFAULT NULL,
  `t02_cod_proy` varchar(10) DEFAULT NULL,
  `estado` char(1) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` timestamp NULL DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` timestamp NULL DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`coduser`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_usuarios_accesos`
--

DROP TABLE IF EXISTS `adm_usuarios_accesos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_usuarios_accesos` (
  `coduser` varchar(10) NOT NULL,
  `idacceso` int(10) NOT NULL DEFAULT '0',
  `fch_ini` timestamp NULL DEFAULT NULL,
  `fch_fin` timestamp NULL DEFAULT NULL,
  `pub_ip` varchar(15) DEFAULT NULL,
  `pri_ip` varchar(15) DEFAULT NULL,
  PRIMARY KEY (`coduser`,`idacceso`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `adm_usuarios_activos`
--

DROP TABLE IF EXISTS `adm_usuarios_activos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `adm_usuarios_activos` (
  `coduser` varchar(10) NOT NULL,
  `fecha` datetime DEFAULT NULL,
  `pub_ip` varchar(15) DEFAULT NULL,
  `id_session` varchar(50) DEFAULT NULL COMMENT 'session_id()',
  `estado` char(1) DEFAULT NULL,
  PRIMARY KEY (`coduser`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t00_bancos`
--

DROP TABLE IF EXISTS `t00_bancos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t00_bancos` (
  `t00_cod_bco` int(11) NOT NULL COMMENT 'Codigo del Banco',
  `t00_nom_abre` varchar(15) NOT NULL COMMENT 'Nombre Abreviado',
  `t00_nom_lar` varchar(50) NOT NULL COMMENT 'Nombre Largo',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t00_cod_bco`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t00_linea`
--

DROP TABLE IF EXISTS `t00_linea`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t00_linea` (
  `t00_cod_linea` int(11) NOT NULL COMMENT 'Codigo de Linea',
  `t00_nom_abre` varchar(15) NOT NULL COMMENT 'Nombre Abreviado',
  `t00_nom_lar` varchar(50) NOT NULL COMMENT 'Nombre Largo',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t00_cod_linea`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t00_parametro`
--

DROP TABLE IF EXISTS `t00_parametro`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t00_parametro` (
  `t00_cod_param` int(11) NOT NULL COMMENT 'Codigo del Parametro',
  `t00_nom_abre` varchar(50) NOT NULL COMMENT 'Nombre de Parametro',
  `t00_nom_lar` varchar(20) NOT NULL COMMENT 'Valor de Parametro',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t00_cod_param`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t00_tasa`
--

DROP TABLE IF EXISTS `t00_tasa`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t00_tasa` (
  `t00_cod_tasa` int(11) NOT NULL COMMENT 'Codigo de Tasa',
  `t00_nom_abre` varchar(50) NOT NULL COMMENT 'Nombre de Tasa',
  `t00_nom_lar` varchar(20) NOT NULL COMMENT 'Valor de Tasa',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t00_cod_tasa`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t00_tipo_cuenta`
--

DROP TABLE IF EXISTS `t00_tipo_cuenta`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t00_tipo_cuenta` (
  `t00_cod_cta` int(11) NOT NULL COMMENT 'Codigo del Tipo de cuenta',
  `t00_nom_abre` varchar(15) NOT NULL COMMENT 'Nombre Abreviado',
  `t00_nom_lar` varchar(50) NOT NULL COMMENT 'Nombre Largo',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t00_cod_cta`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t00_tipo_moneda`
--

DROP TABLE IF EXISTS `t00_tipo_moneda`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t00_tipo_moneda` (
  `t00_cod_mon` int(11) NOT NULL COMMENT 'Codigo de la Moneda ',
  `t00_nom_abre` varchar(15) NOT NULL COMMENT 'Nombre Abreviado',
  `t00_nom_lar` varchar(50) NOT NULL COMMENT 'Nombre Largo',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t00_cod_mon`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t00_tipo_pago`
--

DROP TABLE IF EXISTS `t00_tipo_pago`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t00_tipo_pago` (
  `t00_tip_pago` int(11) NOT NULL COMMENT 'Codigo del Tipo Pago',
  `t00_nom_abre` varchar(15) NOT NULL COMMENT 'Nombre Abreviado',
  `t00_nom_lar` varchar(50) NOT NULL COMMENT 'Nombre Largo',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t00_tip_pago`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t01_dir_inst`
--

DROP TABLE IF EXISTS `t01_dir_inst`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t01_dir_inst` (
  `t01_id_inst` int(10) NOT NULL DEFAULT '0',
  `t01_ruc_inst` varchar(15) DEFAULT NULL,
  `t01_sig_inst` varchar(50) DEFAULT NULL,
  `t01_nom_inst` varchar(200) DEFAULT NULL,
  `t01_fch_fund` date DEFAULT NULL,
  `t01_pres_anio` double DEFAULT NULL,
  `t01_dpto` char(2) DEFAULT NULL,
  `t01_prov` char(2) DEFAULT NULL,
  `t01_dist` char(2) DEFAULT NULL,
  `t01_dire_inst` varchar(200) DEFAULT NULL,
  `t01_ciud_inst` varchar(50) DEFAULT NULL,
  `t01_fono_inst` varchar(50) DEFAULT NULL,
  `t01_fax_inst` varchar(50) DEFAULT NULL,
  `t01_mail_inst` varchar(50) DEFAULT NULL,
  `t01_web_inst` varchar(50) DEFAULT NULL,
  `t01_ape_rep` varchar(70) DEFAULT NULL,
  `t01_nom_rep` varchar(50) DEFAULT NULL,
  `t01_carg_rep` varchar(50) DEFAULT NULL,
  `t01_tipo_inst` int(10) DEFAULT NULL,
  `t01_fono2_inst` varchar(50) DEFAULT NULL,
  `t01_rpm_inst` varchar(10) DEFAULT NULL,
  `t01_next_inst` varchar(10) DEFAULT NULL,
  `t01_rpc_inst` varchar(15) DEFAULT NULL,
  `t01_rel_fe` varchar(100) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` timestamp NULL DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` timestamp NULL DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t01_id_inst`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t01_inst_ctas`
--

DROP TABLE IF EXISTS `t01_inst_ctas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t01_inst_ctas` (
  `t01_id_inst` int(11) NOT NULL COMMENT 'Id de la Institucion',
  `t01_id_cta` int(11) NOT NULL COMMENT 'Id de la cuenta',
  `t00_cod_bco` int(11) NOT NULL COMMENT 'Codigo del banco',
  `t00_cod_cta` int(11) NOT NULL COMMENT 'Tipo de Cuenta',
  `t01_nro_cta` varchar(20) NOT NULL COMMENT 'Numero de la Cuenta',
  `t00_cod_mon` int(11) NOT NULL COMMENT 'Tipo Moneda',
  `t01_txt_ref` varchar(100) DEFAULT NULL COMMENT 'Texto Referencial de la Cuenta',
  `t01_cta_def` char(1) DEFAULT NULL COMMENT 'La cuenta es por defecto ?',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t01_id_inst`,`t01_id_cta`),
  KEY `FK_t01_inst_ctas` (`t00_cod_bco`) USING BTREE,
  KEY `FK_t01_inst_tipoctas` (`t00_cod_cta`) USING BTREE,
  KEY `FK_t01_inst_ctas_moneda` (`t00_cod_mon`) USING BTREE,
  CONSTRAINT `t01_inst_ctas_ibfk_1` FOREIGN KEY (`t00_cod_bco`) REFERENCES `t00_bancos` (`t00_cod_bco`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `t01_inst_ctas_ibfk_2` FOREIGN KEY (`t01_id_inst`) REFERENCES `t01_dir_inst` (`t01_id_inst`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `t01_inst_ctas_ibfk_3` FOREIGN KEY (`t00_cod_mon`) REFERENCES `t00_tipo_moneda` (`t00_cod_mon`) ON DELETE NO ACTION ON UPDATE NO ACTION,
  CONSTRAINT `t01_inst_ctas_ibfk_4` FOREIGN KEY (`t00_cod_cta`) REFERENCES `t00_tipo_cuenta` (`t00_cod_cta`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t01_inst_cto`
--

DROP TABLE IF EXISTS `t01_inst_cto`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t01_inst_cto` (
  `t01_id_inst` int(10) NOT NULL DEFAULT '0',
  `t01_id_cto` int(10) NOT NULL DEFAULT '0',
  `t01_dni_cto` varchar(10) DEFAULT NULL,
  `t01_ape_pat` varchar(50) DEFAULT NULL,
  `t01_ape_mat` varchar(50) DEFAULT NULL,
  `t01_nom_cto` varchar(50) DEFAULT NULL,
  `t01_fono_ofi` varchar(50) DEFAULT NULL,
  `t01_mail_cto` varchar(50) DEFAULT NULL,
  `t01_mail_cto2` varchar(50) DEFAULT NULL,
  `t01_cel_cto` varchar(50) DEFAULT NULL,
  `t01_cgo_cto` varchar(50) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` timestamp NULL DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` timestamp NULL DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t01_tel2_cto` varchar(50) DEFAULT NULL,
  `t01_rpm_cto` varchar(50) DEFAULT NULL,
  `t01_fax_cto` varchar(50) DEFAULT NULL,
  `t01_rpc_cto` varchar(50) DEFAULT NULL,
  `t01_nex_cto` varchar(50) DEFAULT NULL,
  `t01_sexo` varchar(50) DEFAULT NULL,
  `t01_rep_flg` char(1) DEFAULT NULL,
  PRIMARY KEY (`t01_id_inst`,`t01_id_cto`),
  KEY `fk_t01_inst_cto_t01_dir_inst1` (`t01_id_inst`) USING BTREE,
  CONSTRAINT `t01_inst_cto_ibfk_1` FOREIGN KEY (`t01_id_inst`) REFERENCES `t01_dir_inst` (`t01_id_inst`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t01_rep_inst`
--

DROP TABLE IF EXISTS `t01_rep_inst`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t01_rep_inst` (
  `t01_cod_rep` int(11) NOT NULL AUTO_INCREMENT COMMENT 'CODIGO',
  `t01_id_inst` int(11) NOT NULL COMMENT 'Id de Institucion',
  `t01_carg_rep` int(11) DEFAULT NULL COMMENT 'Codigo del Cargo del Responsable',
  `t01_nom_rep` varchar(30) DEFAULT NULL COMMENT 'Nombre del Responsable',
  `t01_ape_rep` varchar(30) NOT NULL COMMENT 'Apellidos del Responsable',
  `t01_dni_rep` varchar(10) NOT NULL COMMENT 'DNI del Responsable',
  `usr_crea` varchar(20) DEFAULT NULL COMMENT 'Usuario que crea el registro',
  `fch_crea` datetime DEFAULT NULL COMMENT 'Fecha de creacion del registro',
  `usr_actu` varchar(20) DEFAULT NULL COMMENT 'Usuario que actualiza el registro',
  `fch_actu` datetime DEFAULT NULL COMMENT 'Fecha de actualizacion',
  PRIMARY KEY (`t01_cod_rep`,`t01_id_inst`),
  KEY `FK_t01_rep_inst` (`t01_id_inst`) USING BTREE,
  CONSTRAINT `t01_rep_inst_ibfk_1` FOREIGN KEY (`t01_id_inst`) REFERENCES `t01_dir_inst` (`t01_id_inst`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_aprob_proy`
--

DROP TABLE IF EXISTS `t02_aprob_proy`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_aprob_proy` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Codigo del Proyecto',
  `t02_vb_proy` tinyint(1) DEFAULT NULL COMMENT 'Lo da el Monitor',
  `t02_aprob_proy` tinyint(1) DEFAULT NULL COMMENT 'Lo da el CMT',
  `t02_fch_vb_proy` datetime DEFAULT NULL,
  `t02_fch_aprob_proy` datetime DEFAULT NULL,
  `t02_obs_vb_proy` text,
  `t02_obs_aprob_proy` text,
  `t02_aprob_ml` tinyint(1) DEFAULT NULL COMMENT 'Aprueba Marco Logico',
  `t02_aprob_cro` tinyint(1) DEFAULT NULL COMMENT 'Aprueba Cronograma de Actividades',
  `t02_aprob_pre` tinyint(1) DEFAULT NULL COMMENT 'Aprueba Presupuesto',
  `t02_fch_ml` datetime DEFAULT NULL,
  `t02_fch_cro` datetime DEFAULT NULL,
  `t02_fch_pre` datetime DEFAULT NULL,
  `t02_aprob_ml_mon` tinyint(1) DEFAULT NULL,
  `t02_aprob_cro_mon` tinyint(1) DEFAULT NULL,
  `t02_aprob_pre_mon` tinyint(1) DEFAULT NULL,
  `t02_obs_ml` text COMMENT 'Observaciones con respecto a la Aprobación del Marco Logico',
  `t02_obs_cro` text COMMENT 'Observaciones con respecto a la Aprobación del Cronograma',
  `t02_obs_pre` text COMMENT 'Observaciones con respecto a la Aprobación del Presupuesto',
  `t02_fch_ml_mon` tinyint(1) DEFAULT NULL,
  `t02_fch_cro_mon` tinyint(1) DEFAULT NULL,
  `t02_fch_pre_mon` tinyint(1) DEFAULT NULL,
  `usu_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `t02_env_ml` tinyint(1) DEFAULT NULL,
  `t02_env_pre` tinyint(1) DEFAULT NULL,
  `t02_fch_env_ml` datetime DEFAULT NULL,
  `t02_fch_env_pre` datetime DEFAULT NULL,
  `t02_fch_env_cro` datetime DEFAULT NULL,
  `t02_env_cro` tinyint(1) DEFAULT NULL,
  `t02_aprob_croprod` tinyint(4) DEFAULT NULL COMMENT 'Aprueba Cronograma de Productos',
  `t02_fch_croprod` datetime DEFAULT NULL,
  `t02_aprob_croprod_mon` tinyint(4) DEFAULT NULL,
  `t02_obs_croprod` text COMMENT 'Observaciones con respecto a la Aprobación del Cronograma de Productos',
  `t02_fch_croprod_mon` datetime DEFAULT NULL,
  `t02_fch_env_croprod` datetime DEFAULT NULL,
  `t02_env_croprod` tinyint(4) DEFAULT NULL,
  `usu_aprob_proy` tinyint(4) DEFAULT NULL COMMENT 'Usuario que aprueba el proyecto',
  PRIMARY KEY (`t02_cod_proy`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_carta_fianza`
--

DROP TABLE IF EXISTS `t02_carta_fianza`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_carta_fianza` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Codigo del Proyecto',
  `t02_id_cf` int(11) NOT NULL COMMENT 'Codigo Interno de la Carta Fianza',
  `t02_id_bco` int(11) DEFAULT NULL COMMENT 'Codigo de la Entidad Financiera',
  `t02_des_cf` varchar(50) DEFAULT NULL COMMENT 'Breve descripcion de la Carta Fianza',
  `t02_mto_cf` double DEFAULT NULL COMMENT 'Monto de la Carta fianza',
  `t02_num_cf` varchar(20) DEFAULT NULL COMMENT 'Numero de carta Fianza',
  `t02_ser_cf` varchar(20) DEFAULT NULL COMMENT 'Numero de Serie ',
  `t02_frec_cf` datetime DEFAULT NULL COMMENT 'Fecha de Recepción ',
  `t02_fgir_cf` datetime DEFAULT NULL COMMENT 'Fecha de Giro',
  `t02_fven_cf` datetime DEFAULT NULL COMMENT 'Fecha de Vencimiento',
  `t02_est_cf` int(11) DEFAULT NULL COMMENT 'Estado de la CF',
  `t02_vb_adm` int(11) DEFAULT NULL COMMENT 'Visto Bueno de Administracion',
  `t02_obs_adm` text COMMENT 'Observaciones de VB',
  `t02_file_cf` varchar(150) DEFAULT NULL COMMENT 'URL del Archivo Fisico de la CF',
  `usu_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usu_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_id_cf`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_dg_proy`
--

DROP TABLE IF EXISTS `t02_dg_proy`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_dg_proy` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t02_nro_exp` varchar(20) DEFAULT NULL,
  `t00_cod_linea` int(11) NOT NULL,
  `t01_id_inst` int(11) NOT NULL,
  `t02_nom_proy` varchar(250) DEFAULT NULL,
  `t02_fch_apro` date DEFAULT NULL,
  `t02_fch_ini` date DEFAULT NULL,
  `t02_fch_ter` date DEFAULT NULL,
  `t02_fin` varchar(500) DEFAULT NULL,
  `t02_pro` varchar(500) DEFAULT NULL,
  `t02_ben_obj` varchar(5000) DEFAULT NULL,
  `t02_amb_geo` varchar(5000) DEFAULT NULL,
  `t02_pres_fe` double DEFAULT NULL,
  `t02_pres_eje` double NOT NULL DEFAULT '0' COMMENT 'Presupuesto de la Intitucion ejecutora',
  `t02_pres_otro` double DEFAULT NULL,
  `t02_pres_tot` double DEFAULT NULL,
  `t02_moni_tema` int(11) DEFAULT NULL COMMENT 'Tomar el dato de t04_equi_proy para monitor temático',
  `t02_moni_fina` int(11) DEFAULT NULL COMMENT 'Tomar el dato de t04_equi_proy para monitor financiero',
  `t02_moni_ext` varchar(10) DEFAULT NULL COMMENT 'Tomar el dato de t01_inst_cto para monitor externo',
  `t02_sup_inst` int(11) DEFAULT NULL COMMENT 'Supervisor Institucional. Tomar el dato de la tabla t01_ejec_cto para supervisor',
  `t02_dire_proy` varchar(200) DEFAULT NULL,
  `t02_ciud_proy` varchar(50) DEFAULT NULL,
  `t02_tele_proy` varchar(30) DEFAULT NULL,
  `t02_fax_proy` varchar(30) DEFAULT NULL,
  `t02_mail_proy` varchar(50) DEFAULT NULL,
  `t02_estado` int(11) DEFAULT NULL,
  `t02_mto_line_base` double DEFAULT NULL COMMENT 'Almacena Monto Calculado de la Linea de Base 4%',
  `t02_mto_imprevisto` double DEFAULT NULL COMMENT 'Almacena Monto Calculo de Imprevistos 2%',
  `t02_mto_supervision` double DEFAULT NULL,
  `t02_est_imp` int(11) DEFAULT NULL,
  `t02_sect_main` int(11) DEFAULT NULL COMMENT 'Sector - Clasificacion general',
  `t02_sect_prod` int(11) DEFAULT NULL COMMENT 'Sector Productivo',
  `t02_subsect_prod` int(11) DEFAULT NULL COMMENT 'SubSector Productivo',
  `t02_prod_promovido` varchar(150) DEFAULT NULL COMMENT 'Productos  Promovidos',
  `t02_cre_fe` char(1) DEFAULT NULL,
  `t02_fch_isc` date DEFAULT NULL COMMENT 'Fecha de Inicio segun convenio',
  `t02_fch_ire` date DEFAULT NULL COMMENT 'Fecha de Inicio Real',
  `t02_fch_tre` date DEFAULT NULL COMMENT 'Fecha de Termino Real',
  `t02_fch_tam` date DEFAULT NULL COMMENT 'Fecha de termino con ampliacion',
  `t02_num_mes` int(3) DEFAULT NULL COMMENT 'Numero de meses',
  `t02_num_mes_amp` int(11) DEFAULT NULL,
  `t02_inst_asoc` text COMMENT 'Instituciones asociadas o colaboradoras',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `env_rev` tinyint(4) DEFAULT '0',
  PRIMARY KEY (`t02_cod_proy`,`t02_version`),
  KEY `fk_t02_dg_proy_t01_dir_inst1` (`t01_id_inst`) USING BTREE,
  KEY `fk_t02_dg_proy_t00_cod_linea` (`t00_cod_linea`),
  CONSTRAINT `t02_dg_proy_ibfk_1` FOREIGN KEY (`t01_id_inst`) REFERENCES `t01_dir_inst` (`t01_id_inst`) ON DELETE NO ACTION ON UPDATE CASCADE,
  CONSTRAINT `t02_dg_proy_ibfk_2` FOREIGN KEY (`t00_cod_linea`) REFERENCES `t00_linea` (`t00_cod_linea`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_ins_proy` AFTER INSERT ON `t02_dg_proy`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                Puede acceder al proyecto haciendo 
		<a href='http://localhost/sgp/sme/proyectos/datos/lista.php?txtCodProy={proyecto}'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200); 
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
	
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
		SELECT _administrador  INTO _destino ; 
				  
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha ingresado el Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				el proyecto {proyecto} - {inst} , ha sido creado y se encuentra habilitado para el ingreso de documentos correspondientes. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_sistem, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_upd_proy` AFTER UPDATE ON `t02_dg_proy`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                Puede acceder al proyecto haciendo 
		<a href='http://localhost/sgp/sme/proyectos/datos/lista.php?txtCodProy={proyecto}'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
      DECLARE _asunto2  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg2  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                Puede acceder al proyecto haciendo 
		<a href='http://localhost/sgp/sme/proyectos/datos/lista.php?txtCodProy={proyecto}'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
	DECLARE _evasis VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200); 
   DECLARE _destino2 VARCHAR(200); 
	DECLARE _est_rev 	INT DEFAULT 46;
    DECLARE _est_corr 	INT DEFAULT 248;
    DECLARE _est_aprob 	INT DEFAULT 249;
   
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
	
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT GROUP_CONCAT(u.mail SEPARATOR ',')
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	
   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _evasis
		FROM
		adm_usuarios
		WHERE tipo_user=11
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
    IF NEW.t02_moni_tema!=0 AND NEW.t02_moni_fina!=0 AND NEW.t02_moni_ext!=0  AND  NEW.t02_cre_fe IS NOT NULL  AND  NEW.t02_amb_geo='' THEN 
			SELECT _evasis  INTO _destino ; 		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se han cargado los datos del proyecto {proyecto} - {inst}, para que el ejecutor continúe con el proceso ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				el  proyecto {proyecto} - {inst} cuenta con la información registrada por los coordinadores de monitoreo, proveer el usuario y contraseña al ejecutor para que culmine el registro de datos.");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);	
		
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
         
		SELECT _inst  INTO _destino2 ; 		
		SET _asunto2 = REPLACE(_asunto2,"{asunto}","El proyecto {proyecto} - {inst} se encuentra habilitado en el sistema ");
		SET _asunto2 = REPLACE(_asunto2,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto2 = REPLACE(_asunto2,"{inst}",_institucion);
		SET _msg2 = REPLACE(_msg2,"{cab}","Señores Ejecutores,
				el  proyecto {proyecto} - {inst}, se encuentra habilitado en el sistema. Se debe ingresar la información en los campos permitidos y al culminar enviar a revisión para que el documento sea aprobado y continuar con el proceso de ingreso del marco lógico.");	
		SET _msg2 = REPLACE(_msg2,"{inst}",_institucion);		
		SET _msg2 = REPLACE(_msg2,"{proyecto}",NEW.t02_cod_proy);	
		
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto2, 
		_msg2, 
		_evasis, 
		_destino2, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t02_duracion`
--

DROP TABLE IF EXISTS `t02_duracion`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_duracion` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t02_anio` int(11) NOT NULL,
  `est_audi` char(1) DEFAULT NULL COMMENT 'Estado',
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t02_anio`),
  CONSTRAINT `t02_duracion_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Duracion del Proyecto en Años';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_entregable`
--

DROP TABLE IF EXISTS `t02_entregable`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_entregable` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t02_anio` tinyint(4) NOT NULL DEFAULT '0',
  `t02_mes` tinyint(4) NOT NULL DEFAULT '0',
  `monto_desemb` double(10,2) NOT NULL DEFAULT '0.00',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t02_anio`,`t02_mes`),
  KEY `FK_t02_entregable` (`t02_cod_proy`,`t02_version`) USING BTREE,
  CONSTRAINT `t02_entregable_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_entregable_act_ind`
--

DROP TABLE IF EXISTS `t02_entregable_act_ind`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_entregable_act_ind` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t02_anio` tinyint(4) NOT NULL,
  `t02_mes` tinyint(4) NOT NULL,
  `t09_cod_act_ind_val` double NOT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t02_anio`,`t02_mes`),
  KEY `FK_t02_entregable_act_ind` (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`) USING BTREE,
  CONSTRAINT `t02_entregable_act_ind_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`) REFERENCES `t09_act_ind` (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_entregable_act_ind_car`
--

DROP TABLE IF EXISTS `t02_entregable_act_ind_car`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_entregable_act_ind_car` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t09_cod_act_ind_car` int(11) NOT NULL,
  `t02_anio` tinyint(4) NOT NULL,
  `t02_mes` tinyint(4) NOT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t09_cod_act_ind_car`,`t02_anio`,`t02_mes`),
  KEY `FK_t02_entregable_act_ind_car` (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t09_cod_act_ind_car`) USING BTREE,
  CONSTRAINT `t02_entregable_act_ind_car_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`, `t09_cod_act_ind_car`) REFERENCES `t09_act_ind_car` (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`, `t09_cod_act_ind_car`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_fuente_finan`
--

DROP TABLE IF EXISTS `t02_fuente_finan`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_fuente_finan` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t01_id_inst` int(11) NOT NULL,
  `t02_porc_def` double DEFAULT NULL,
  `t02_obs_fte` text,
  `t02_mto_financ` double DEFAULT NULL COMMENT 'Monto Total Financiado',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t01_id_inst`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_noobjecion_compra`
--

DROP TABLE IF EXISTS `t02_noobjecion_compra`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_noobjecion_compra` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Codigo del Proyecto',
  `t02_id_noc` int(11) NOT NULL COMMENT 'Codigo Interno de la No Objecion de Compra',
  `t02_sco_noc` varchar(30) DEFAULT NULL COMMENT 'Solicitud de Compra Nº',
  `t02_com_noc` int(11) DEFAULT NULL COMMENT 'Componente',
  `t02_act_noc` int(11) DEFAULT NULL COMMENT 'Actividad',
  `t02_sub_noc` int(11) DEFAULT NULL COMMENT 'Subactividad',
  `t02_par_noc` int(11) DEFAULT NULL COMMENT 'Partida a Afectar',
  `t02_spa_noc` double DEFAULT NULL COMMENT 'Saldo en la Partida a Afectar',
  `t02_imp_noc` double DEFAULT NULL COMMENT 'Importe solicitado',
  `t02_ccp_noc` char(1) DEFAULT NULL COMMENT 'Cuadro comparativo de Proveedores',
  `t02_cop_noc` char(1) DEFAULT NULL COMMENT 'Cotizaciones de Proveedores 03 ó más',
  `t02_amt_noc` char(1) DEFAULT NULL COMMENT 'Aprobación de monitor Técnico',
  `t02_amf_noc` char(1) DEFAULT NULL COMMENT 'Aprobación de Monitor Financiero',
  `t02_cmf_noc` char(1) DEFAULT NULL COMMENT 'Cotizaciones de Responsable de Monitoreo Financiero',
  `t02_cmt_noc` char(1) DEFAULT NULL COMMENT 'Coordinador de Monitoreo Tecnico',
  `t02_pro_noc` char(1) DEFAULT NULL COMMENT 'Respuesta a ejecutor si procede',
  `t02_obs_noc` text COMMENT 'Observaciones si no procede',
  `usu_crea` varchar(20) DEFAULT NULL COMMENT 'Usuario que crea',
  `fch_crea` datetime DEFAULT NULL COMMENT 'Fecha de creación',
  `usu_actu` varchar(20) DEFAULT NULL COMMENT 'Usuario que actualiza',
  `fch_actu` datetime DEFAULT NULL COMMENT 'Fecha de actualización',
  `est_audi` char(1) DEFAULT NULL COMMENT 'Estado',
  `t02_fch_ped` date DEFAULT NULL,
  `t02_fch_apr` date DEFAULT NULL,
  `t02_env_rev` char(1) DEFAULT NULL,
  `t02_env_cor` char(1) DEFAULT NULL,
  `t02_estado` int(11) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_id_noc`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_upd_noobj` AFTER UPDATE ON `t02_noobjecion_compra`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                Puede acceder al informe haciendo 
		<a href='http://localhost/sgp/sme/proyectos/anexos/objecion_compras.php?txtCodProy={proyecto}'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200);  
   
   
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT group_concat(u.mail separator ',') 
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	
    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
 
    IF NEW.t02_amf_noc='N' AND NEW.t02_estado=270 THEN 
	
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _mailejec ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","La Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} ha sido rechazada");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _asunto = REPLACE(_asunto,"{num}",NEW.t02_sco_noc);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				la Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} ha sido rechazada. Puede presentar una nueva solicitud. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		SET _msg = REPLACE(_msg,"{num}",NEW.t02_sco_noc);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usu_actu
	);
	
	END IF; 
	 
    IF NEW.t02_amf_noc='S' AND NEW.t02_estado=266 THEN 
	
	
		
			
			  
        SELECT _mon_tec INTO _destino; 				  
		SET _asunto = REPLACE(_asunto,"{asunto}","La Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} ha sido aprobada por el Monitor Financiero");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _asunto = REPLACE(_asunto,"{num}",NEW.t02_sco_noc);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				la Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} tiene el VoBo. del monitor financiero. Se solicita su revisión y VoBo. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		SET _msg = REPLACE(_msg,"{num}",NEW.t02_sco_noc);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usu_actu
	);
	
	END IF; 
	
 IF NEW.t02_estado=267 THEN 
	
	SET _destino =  CONCAT( 
				IFNULL(_cmt,''),  
				IFNULL(CONCAT(', ', _cmf ),'') 
			     ) ;
        				  
		SET _asunto = REPLACE(_asunto,"{asunto}","La Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} está lista para su revisión");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _asunto = REPLACE(_asunto,"{num}",NEW.t02_sco_noc);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				la Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} cuenta con la revisión del monitor financiero y técnico, favor de proceder con la revisión y aprobación correspondiente. ");
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		SET _msg = REPLACE(_msg,"{num}",NEW.t02_sco_noc);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usu_actu
	);
	
	END IF;
	if ((NEW.t02_cmt_noc = 'S' or NEW.t02_cmt_noc = 'N') and (NEW.t02_cmf_noc = 'S' OR NEW.t02_cmf_noc = 'N')) then
		SET _destino =  CONCAT( 
				IFNULL(_mon_tec,''),  
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _amt ),''), 
				IFNULL(CONCAT(', ', _mailproy ),''), 
				IFNULL(CONCAT(', ', _mailejec ),'') 
				 ) ;
		if (NEW.t02_cmt_noc = 'S' and NEW.t02_cmf_noc = 'S') then
			SET _asunto = REPLACE(_asunto,"{asunto}","La Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} ha sido aprobada");
			SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
					la Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst}, SI PROCEDE.");	
		else
			SET _asunto = REPLACE(_asunto,"{asunto}","La Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst} ha sido rechazada");
			SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
					la Solicitud de No Objeción de Compras N°-{num} del Proyecto {proyecto} - {inst}, NO PROCEDE.");	
		end if;
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _asunto = REPLACE(_asunto,"{num}",NEW.t02_sco_noc);
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		SET _msg = REPLACE(_msg,"{num}",NEW.t02_sco_noc);
		SELECT IFNULL(MAX(id_men),0)+1 INTO _id FROM adm_mensajes ;
		INSERT INTO adm_mensajes (id_men, asu_men, tex_men, ori_men, dest_men, fec_men, usu_men )
			VALUES (_id, _asunto, _msg, _inst, _destino, NOW(), NEW.usu_actu);
	end if;
	
 END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t02_noobjecion_compra_anx`
--

DROP TABLE IF EXISTS `t02_noobjecion_compra_anx`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_noobjecion_compra_anx` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_id_noc` int(11) NOT NULL,
  `t02_cod_anx` int(11) NOT NULL,
  `t02_nom_file` varchar(50) NOT NULL COMMENT 'Nombre del archivo anexado',
  `t02_url_file` varchar(100) NOT NULL,
  `t02_desc_file` varchar(250) NOT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_id_noc`,`t02_cod_anx`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_poa`
--

DROP TABLE IF EXISTS `t02_poa`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_poa` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL,
  `t02_periodo` varchar(50) DEFAULT NULL COMMENT 'Periodo de Referencia',
  `t02_punto_aten` text NOT NULL COMMENT 'Puntos de Atencion',
  `t02_politica` text COMMENT 'Politica Nacional y/o Sectorial',
  `t02_benefic` text COMMENT 'Beneficiarios Principales',
  `t02_otras_interv` text COMMENT 'Otras Intervenciones',
  `t02_estado` int(11) DEFAULT NULL COMMENT 'Estado, proveniente de Tablas Auxiliares',
  `t02_estado_mf` int(11) DEFAULT NULL,
  `t02_fch_aprob` date DEFAULT NULL,
  `t02_aprob_cmt` int(11) DEFAULT NULL COMMENT 'Aprobacion de CMT',
  `t02_aprob_cmf` int(11) DEFAULT NULL COMMENT 'Aprobacion de CMF',
  `t02_obs_cmt` text COMMENT 'Observaciones de los Monitores',
  `t02_obs_cmf` text,
  `t02_unsuspend_flg` char(1) DEFAULT '0',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t02_tipo_poa` char(1) DEFAULT NULL,
  `vb_se_tec` tinyint(1) NOT NULL DEFAULT '0',
  `vb_se_fin` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`t02_cod_proy`,`t02_anio`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_poa_anexos`
--

DROP TABLE IF EXISTS `t02_poa_anexos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_poa_anexos` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL COMMENT 'Version del Proyecto',
  `t02_cod_anx` int(11) NOT NULL,
  `t02_nom_file` varchar(50) DEFAULT NULL COMMENT 'Nombre del Archivo Adjunto',
  `t02_url_file` varchar(100) DEFAULT NULL,
  `t02_desc_file` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_anio`,`t02_cod_anx`),
  CONSTRAINT `t02_poa_anexos_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_anio`) REFERENCES `t02_poa` (`t02_cod_proy`, `t02_anio`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_proy_anx`
--

DROP TABLE IF EXISTS `t02_proy_anx`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_proy_anx` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t02_cod_anx` int(11) NOT NULL,
  `t02_nom_file` varchar(50) NOT NULL COMMENT 'Nombre del archivo anexado',
  `t02_url_file` varchar(100) NOT NULL,
  `t02_desc_file` varchar(250) NOT NULL,
  `t02_anx_tip_cod` int(11) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t02_cod_anx`),
  KEY `FK_t02_proy_anx_tip` (`t02_anx_tip_cod`) USING BTREE,
  CONSTRAINT `t02_proy_anx_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE,
  CONSTRAINT `t02_proy_anx_ibfk_2` FOREIGN KEY (`t02_anx_tip_cod`) REFERENCES `t02_proy_anx_tip` (`t02_anx_tip_cod`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Documentos Anexados al Proyecto';
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_ins_doc` AFTER INSERT ON `t02_proy_anx`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                Puede acceder al proyecto haciendo 
		<a href='http://localhost/sgp/sme/proyectos/datos/lista.php?txtCodProy={proyecto}'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
	DECLARE _evasis VARCHAR(50); 
    DECLARE _destino VARCHAR(200); 
    DECLARE _tipo INT; 
	DECLARE _documento VARCHAR(200); 
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT GROUP_CONCAT(u.mail SEPARATOR ',')
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _evasis
		FROM
		adm_usuarios
		WHERE tipo_user=11
		and estado=1
	and mail!=''; 
	
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
	
	SELECT NEW.t02_cod_anx  INTO _tipo ;
IF _tipo=1 THEN SET _documento = "Documento del Convenio";
ELSEIF _tipo=2 THEN SET _documento = "Documento del Proyecto";
END IF;
	
		SET _destino =  CONCAT( 
				IFNULL(_cmt,''),  
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _evasis ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El proyecto {proyecto} - {inst} ha adjuntado su {doc} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _asunto = REPLACE(_asunto,"{doc}",_documento);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				el proyecto  {proyecto} - {inst} ha adjuntado el documento {doc}. Proceder al ingreso de la informacion correspondiente a su cargo.");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		SET _msg = REPLACE(_msg,"{doc",_documento);
		
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
                 INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t02_proy_anx_tip`
--

DROP TABLE IF EXISTS `t02_proy_anx_tip`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_proy_anx_tip` (
  `t02_anx_tip_cod` int(11) NOT NULL AUTO_INCREMENT,
  `t02_anx_tip_desc` varchar(150) DEFAULT NULL,
  `t02_anx_tip_abrev` varchar(45) DEFAULT NULL,
  `usr_crea` varchar(60) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(60) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_anx_tip_cod`)
) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_proy_ctas`
--

DROP TABLE IF EXISTS `t02_proy_ctas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_proy_ctas` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t01_id_inst` int(11) NOT NULL,
  `t01_id_cta` int(11) NOT NULL,
  `t02_nom_benef` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t01_id_inst`,`t01_id_cta`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_proy_version`
--

DROP TABLE IF EXISTS `t02_proy_version`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_proy_version` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_tipo` char(3) NOT NULL COMMENT 'POA o ADE',
  `t02_anio` int(11) NOT NULL COMMENT 'Año del POA o Version de la Adenda',
  `t02_version` int(11) NOT NULL,
  `t02_ver` int(11) DEFAULT NULL COMMENT 'Version que se muestra, si es Adenda',
  `t02_gen` int(11) DEFAULT '0' COMMENT '0=Pendiente; 1=Version generada;',
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `fch_gen` date DEFAULT NULL COMMENT 'Fecha de Generacion de la Version',
  `usr_gen` varchar(20) DEFAULT NULL COMMENT 'Usuario que genero la Nueva Version',
  `gen_log` text COMMENT 'Opcional, Guardar el LOG generado por la Nueva Version',
  PRIMARY KEY (`t02_cod_proy`,`t02_tipo`,`t02_anio`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_sector_prod`
--

DROP TABLE IF EXISTS `t02_sector_prod`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_sector_prod` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_sector_main` int(11) NOT NULL COMMENT 'Codigo del  Sector Principal',
  `t02_sector` int(11) NOT NULL COMMENT 'Codigo del Sector - adm_Tablas_aux',
  `t02_subsec` int(11) NOT NULL COMMENT 'Codigo del SubSector - adm_Tablas_aux2',
  `t02_obs` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_sector_main`,`t02_sector`,`t02_subsec`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla con el Cronograma de Visitas de ME';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_suspenciones`
--

DROP TABLE IF EXISTS `t02_suspenciones`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_suspenciones` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t02_nro_susp` tinyint(4) NOT NULL,
  `t02_fch_susp` date NOT NULL,
  `t02_fch_unsusp` date DEFAULT NULL,
  `t02_fch_reinic` date DEFAULT NULL,
  `t02_obs_susp` text,
  `t02_obs_unsusp` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t02_tasas_proy`
--

DROP TABLE IF EXISTS `t02_tasas_proy`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t02_tasas_proy` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t02_gratificacion` varchar(10) DEFAULT NULL,
  `t02_porc_cts` varchar(10) DEFAULT NULL,
  `t02_porc_ess` varchar(10) DEFAULT NULL,
  `t02_porc_gast_func` varchar(10) DEFAULT NULL,
  `t02_porc_linea_base` varchar(10) DEFAULT NULL,
  `t02_porc_imprev` varchar(10) DEFAULT NULL,
  `t02_proc_gast_superv` varchar(10) DEFAULT NULL,
  `usr_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` varchar(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_dist_proy`
--

DROP TABLE IF EXISTS `t03_dist_proy`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_dist_proy` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_dpto` char(2) NOT NULL DEFAULT '',
  `t03_prov` char(2) NOT NULL DEFAULT '',
  `t03_dist` char(2) NOT NULL DEFAULT '',
  `t03_obs` varchar(500) DEFAULT NULL COMMENT 'Observaciones',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t03_dpto`,`t03_prov`,`t03_dist`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t03_dist_proy_t02_dg_proy1` (`t02_cod_proy`,`t02_version`) USING BTREE,
  CONSTRAINT `t03_dist_proy_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_equi`
--

DROP TABLE IF EXISTS `t03_mp_equi`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_equi` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_equi` int(11) NOT NULL,
  `t03_nom_equi` varchar(100) DEFAULT NULL,
  `t03_um` varchar(30) DEFAULT NULL,
  `t03_cu` double DEFAULT NULL COMMENT 'Costo Unitario',
  `t03_cant` double DEFAULT NULL COMMENT 'Cantidad',
  `t03_costo` double DEFAULT NULL COMMENT 'Costo Parcial',
  `t03_costo_tot` double DEFAULT NULL COMMENT 'Costo Total',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t03_mta_proy` int(11) DEFAULT NULL,
  `t03_mta_repro` int(11) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_equi`),
  CONSTRAINT `t03_mp_equi_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_equi_ftes`
--

DROP TABLE IF EXISTS `t03_mp_equi_ftes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_equi_ftes` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_equi` int(11) NOT NULL,
  `t03_id_inst` int(11) NOT NULL,
  `t03_monto` double DEFAULT NULL,
  `t03_porc` double DEFAULT NULL COMMENT 'Porcentaje de Aporte',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_equi`,`t03_id_inst`),
  CONSTRAINT `t03_mp_equi_ftes_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t03_id_equi`) REFERENCES `t03_mp_equi` (`t02_cod_proy`, `t02_version`, `t03_id_equi`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_equi_metas`
--

DROP TABLE IF EXISTS `t03_mp_equi_metas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_equi_metas` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_equi` int(11) NOT NULL,
  `t03_anio` int(11) NOT NULL,
  `t03_mes` int(11) NOT NULL,
  `t03_mta` int(11) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_equi`,`t03_anio`,`t03_mes`),
  CONSTRAINT `t03_mp_equi_metas_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t03_id_equi`) REFERENCES `t03_mp_equi` (`t02_cod_proy`, `t02_version`, `t03_id_equi`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_gas_adm`
--

DROP TABLE IF EXISTS `t03_mp_gas_adm`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_gas_adm` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_inst` int(11) NOT NULL,
  `t03_monto` double DEFAULT NULL,
  `t03_porc` decimal(10,0) DEFAULT NULL COMMENT 'Porcentaje de Aporte',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_inst`),
  CONSTRAINT `t03_mp_gas_adm_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_gas_fun_cost`
--

DROP TABLE IF EXISTS `t03_mp_gas_fun_cost`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_gas_fun_cost` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_partida` int(11) NOT NULL,
  `t03_id_gasto` int(11) NOT NULL,
  `t03_descrip` varchar(50) DEFAULT NULL,
  `t03_um` varchar(30) DEFAULT NULL,
  `t03_cu` double DEFAULT NULL,
  `t03_cant` double DEFAULT NULL,
  `t03_cat_gast` int(11) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_partida`,`t03_id_gasto`),
  CONSTRAINT `t03_mp_gas_fun_cost_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t03_partida`) REFERENCES `t03_mp_gas_fun_part` (`t02_cod_proy`, `t02_version`, `t03_partida`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_gas_fun_ftes`
--

DROP TABLE IF EXISTS `t03_mp_gas_fun_ftes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_gas_fun_ftes` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_partida` int(11) NOT NULL,
  `t03_id_gasto` int(11) NOT NULL,
  `t03_id_inst` int(11) NOT NULL,
  `t03_monto` double DEFAULT NULL,
  `t03_porc` double DEFAULT NULL COMMENT 'Porcentaje de Aporte',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_partida`,`t03_id_gasto`,`t03_id_inst`),
  CONSTRAINT `t03_mp_gas_fun_ftes_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t03_partida`, `t03_id_gasto`) REFERENCES `t03_mp_gas_fun_cost` (`t02_cod_proy`, `t02_version`, `t03_partida`, `t03_id_gasto`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_gas_fun_metas`
--

DROP TABLE IF EXISTS `t03_mp_gas_fun_metas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_gas_fun_metas` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_partida` int(11) NOT NULL,
  `t03_anio` int(11) NOT NULL,
  `t03_mes` int(11) NOT NULL,
  `t03_mta` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_partida`,`t03_anio`,`t03_mes`),
  CONSTRAINT `t03_mp_gas_fun_metas_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t03_partida`) REFERENCES `t03_mp_gas_fun_part` (`t02_cod_proy`, `t02_version`, `t03_partida`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_gas_fun_part`
--

DROP TABLE IF EXISTS `t03_mp_gas_fun_part`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_gas_fun_part` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_partida` int(11) NOT NULL,
  `t03_um` varchar(30) DEFAULT NULL,
  `t03_meta` double DEFAULT NULL COMMENT 'Suma de Todas las metas',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t03_mta_proy` int(11) DEFAULT NULL,
  `t03_mta_repro` int(11) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_partida`),
  CONSTRAINT `t03_mp_gas_fun_part_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_gas_supervision`
--

DROP TABLE IF EXISTS `t03_mp_gas_supervision`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_gas_supervision` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_inst` int(11) NOT NULL,
  `t03_monto` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_inst`),
  CONSTRAINT `t03_mp_gas_supervision_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_imprevistos`
--

DROP TABLE IF EXISTS `t03_mp_imprevistos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_imprevistos` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_inst` int(11) NOT NULL,
  `t03_monto` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_inst`),
  CONSTRAINT `t03_mp_imprevistos_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_linea_base`
--

DROP TABLE IF EXISTS `t03_mp_linea_base`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_linea_base` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_inst` int(11) NOT NULL,
  `t03_monto` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_inst`),
  CONSTRAINT `t03_mp_linea_base_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_per`
--

DROP TABLE IF EXISTS `t03_mp_per`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_per` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_per` int(11) NOT NULL,
  `t03_nom_per` varchar(100) DEFAULT NULL,
  `t03_tdr` varchar(2000) DEFAULT NULL,
  `t03_tdr_file` varchar(100) DEFAULT NULL,
  `t03_um` int(11) DEFAULT NULL,
  `t03_dedica` double DEFAULT NULL,
  `t03_remu` double DEFAULT NULL,
  `t03_perma` double DEFAULT NULL,
  `t03_remu_prom` double DEFAULT NULL COMMENT 'Remuneracion promedio mensual',
  `t03_gasto_tot` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t03_mta_proy` int(11) DEFAULT NULL,
  `t03_mta_repro` int(11) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_per`),
  CONSTRAINT `t03_mp_per_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_per_ftes`
--

DROP TABLE IF EXISTS `t03_mp_per_ftes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_per_ftes` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_per` int(11) NOT NULL,
  `t03_id_inst` int(11) NOT NULL,
  `t03_monto` double DEFAULT NULL,
  `t03_porc` double DEFAULT NULL COMMENT 'Porcentaje de aporte ',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_per`,`t03_id_inst`),
  CONSTRAINT `t03_mp_per_ftes_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t03_id_per`) REFERENCES `t03_mp_per` (`t02_cod_proy`, `t02_version`, `t03_id_per`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t03_mp_per_metas`
--

DROP TABLE IF EXISTS `t03_mp_per_metas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t03_mp_per_metas` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t03_id_per` int(11) NOT NULL,
  `t03_anio` int(11) NOT NULL,
  `t03_mes` int(11) NOT NULL,
  `t03_mta` int(11) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t03_id_per`,`t03_anio`,`t03_mes`),
  CONSTRAINT `t03_mp_per_metas_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t03_id_per`) REFERENCES `t03_mp_per` (`t02_cod_proy`, `t02_version`, `t03_id_per`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t04_equi_proy`
--

DROP TABLE IF EXISTS `t04_equi_proy`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t04_equi_proy` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t04_id_equi` int(15) NOT NULL,
  `t04_dni_equi` varchar(20) DEFAULT NULL,
  `t04_ape_pat` varchar(50) DEFAULT NULL,
  `t04_ape_mat` varchar(50) DEFAULT NULL,
  `t04_nom_equi` varchar(50) DEFAULT NULL,
  `t04_sexo_equi` int(11) DEFAULT NULL,
  `t04_edad_equi` int(11) DEFAULT NULL,
  `t04_cali_equi` int(11) DEFAULT NULL COMMENT 'Calificación del Integrante del equipo. En ad_tablas: Calificacion y en adm_tablas_aux: Egresado, Bachiller, Master, Phd',
  `t04_mail_equi` varchar(50) DEFAULT NULL,
  `t04_telf_equi` varchar(50) DEFAULT NULL,
  `t04_cel_equi` varchar(20) DEFAULT NULL,
  `t04_carg_equi` int(11) DEFAULT NULL COMMENT 'Cargo que desempeña\nEn ad_tablas: Cargo Proy y en adm_tablas_aux: Jefe de Proyecto, Tecnico, Asist. Adm, Contador.',
  `t04_esp_equi` int(11) DEFAULT NULL,
  `t04_fec_ini` date DEFAULT NULL COMMENT 'feha de inicio',
  `t04_fec_ter` date DEFAULT NULL COMMENT 'fecha de termino de labores',
  `t04_func_equi` text,
  `t04_exp_lab` text,
  `t04_estado` int(11) DEFAULT NULL COMMENT 'Activo, Inactivo',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t04_esp_otro` varchar(30) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t04_id_equi`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t04_sol_cambio_per`
--

DROP TABLE IF EXISTS `t04_sol_cambio_per`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t04_sol_cambio_per` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t04_num_soli` int(11) NOT NULL,
  `t04_dni_equi` varchar(20) NOT NULL,
  `t04_ape_pat` varchar(50) DEFAULT NULL,
  `t04_ape_mat` varchar(50) DEFAULT NULL,
  `t04_nom_equi` varchar(50) DEFAULT NULL,
  `t04_sexo_equi` int(11) DEFAULT NULL,
  `t04_edad_equi` int(11) DEFAULT NULL,
  `t04_cali_equi` int(11) DEFAULT NULL COMMENT 'Calificación del Integrante del equipo. En ad_tablas: Calificacion y en adm_tablas_aux: Egresado, Bachiller, Master, Phd',
  `t04_mail_equi` varchar(50) DEFAULT NULL,
  `t04_telf_equi` varchar(50) DEFAULT NULL,
  `t04_cel_equi` varchar(20) DEFAULT NULL,
  `t04_carg_equi` int(11) DEFAULT NULL COMMENT 'Cargo que desempeña\nEn ad_tablas: Cargo Proy y en adm_tablas_aux: Jefe de Proyecto, Tecnico, Asist. Adm, Contador.',
  `t04_esp_equi` int(11) DEFAULT NULL,
  `t04_fec_ini` date DEFAULT NULL COMMENT 'feha de inicio',
  `t04_fec_ter` date DEFAULT NULL COMMENT 'fecha de termino de labores',
  `t04_func_equi` text,
  `t04_exp_lab` text,
  `t04_adj_cv` varchar(250) DEFAULT NULL,
  `t04_adj_sol` varchar(250) DEFAULT NULL,
  `t04_id_equi_cambio` int(11) DEFAULT NULL COMMENT 'Codigo de la Persona a quin Reemplzara',
  `t04_saldo_part` double DEFAULT NULL COMMENT 'Saldo en la Partida a Afectar',
  `t04_obs_ejec` text COMMENT 'Observaciones del Ejecutor',
  `t04_aprob_mt` char(1) DEFAULT NULL COMMENT 'Aprobacion Monitor Tecnico',
  `t04_aprob_mf` char(1) DEFAULT NULL COMMENT 'Aprobacion Monitor Financiero',
  `t04_aprob_cmt` char(1) DEFAULT '0' COMMENT 'Aprobacion Coordinador Monitoreo Tecnico',
  `t04_aprob_cmf` char(1) DEFAULT '0' COMMENT 'Aprobacion Coordinador Monitoreo Financiero',
  `t04_resp_ejec` char(1) DEFAULT NULL COMMENT 'Procede / No Procede',
  `t04_resp_ejec_obs` text COMMENT 'Observaciones',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `id_msj` int(11) DEFAULT NULL,
  PRIMARY KEY (`t04_num_soli`,`t02_cod_proy`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_ins_sol` AFTER INSERT ON `t04_sol_cambio_per`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} {proyecto}.
                Favor de Verficarlo.
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200); 
	DECLARE _est_rev 	INT DEFAULT 247;
    DECLARE _est_corr 	INT DEFAULT 248;
    DECLARE _est_aprob 	INT DEFAULT 249;
   
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
		
	 SELECT GROUP_CONCAT(u.mail SEPARATOR ',')
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
	
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Proyecto {proyecto} - {inst} solicita Aprobación de la Solicitud de Cambio de Personal");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Ejecutor solicita la Aprobación de la Solicitud de Cambio de personal N°{num} del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t04_num_soli);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_upd_sol` AFTER UPDATE ON `t04_sol_cambio_per`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} {proyecto}.
                Favor de Verficarlo.
                           
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT;  
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200); 
   
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT group_concat(u.mail SEPARATOR ',')
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
	
 	
	IF NEW.t04_aprob_mf='1'  AND NEW.t04_aprob_mt IS null AND NEW.t04_aprob_cmt='0' AND NEW.t04_aprob_cmf='0' THEN 
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _mon_tec ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Monitor Financiero ha dado su conformidad a la Solicitud de Cambio de Personal del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Monitor Financiero ha dado su conformidad a la Solicitud de Cambio de Personal N°{num} del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t04_num_soli);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	END IF;
	
	
	IF NEW.t04_aprob_mt ='1' AND NEW.t04_aprob_cmt='0' AND NEW.t04_aprob_cmf='0' THEN 
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _cmf ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Monitor Técnico ha dado su conformidad a la Solicitud de Cambio de Personal del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				los Monitores Técnico y Financiero han dado su conformidad, proceder a la aprobación correspondiente de la Solicitud de Cambio de Personal N°{num} del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t04_num_soli);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	END IF;
	
	
	IF  NEW.t04_aprob_cmt='1' AND NEW.t04_aprob_cmf='0' THEN 
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _amt ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin),''), 
				IFNULL(CONCAT(', ', _mailejec),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Técnico ha dado su conformidad a la Solicitud de Cambio de Personal del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Técnico ha dado su conformidad a la Solicitud de Cambio de Personal N°{num} del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t04_num_soli);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	END IF;
	
	
	IF  NEW.t04_aprob_cmf='1' AND NEW.t04_aprob_cmt='0' THEN 
		SET _destino =  CONCAT( 
				IFNULL(CONCAT(', ', _amt ),''), 
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Financiero ha dado su conformidad a la Solicitud de Cambio de Personal del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Financiero ha dado su conformidad a la Solicitud de Cambio de Personal N°{num} del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t04_num_soli);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	END IF;
	
	
	IF  NEW.t04_aprob_cmf='1' AND NEW.t04_aprob_cmt='1' THEN 
		SET _destino =  CONCAT( 
			IFNULL(_mailproy,''),  
			IFNULL(CONCAT(', ', _amt ),''), 
			IFNULL(CONCAT(', ', _mon_tec ),''), 
			IFNULL(CONCAT(', ', _mon_fin),''), 
			IFNULL(CONCAT(', ', _mailejec),'') 
			  ) ;	
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha aprobado la Solicitud de Cambio de Personal del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				se ha aprobado la Solicitud de Cambio de Personal N°{num} del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t04_num_soli);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	END IF;
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t06_fin_ind`
--

DROP TABLE IF EXISTS `t06_fin_ind`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t06_fin_ind` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t06_cod_fin_ind` int(11) NOT NULL DEFAULT '0',
  `t06_ind` varchar(250) DEFAULT NULL,
  `t06_um` varchar(30) DEFAULT NULL,
  `t06_mta` double DEFAULT NULL,
  `t06_fv` varchar(250) DEFAULT NULL,
  `t06_obs` varchar(500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t06_cod_fin_ind`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t06_fin_ind_t02_dg_proy1` (`t02_cod_proy`,`t02_version`) USING BTREE,
  CONSTRAINT `t06_fin_ind_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t06_fin_sup`
--

DROP TABLE IF EXISTS `t06_fin_sup`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t06_fin_sup` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t06_cod_fin_sup` int(11) NOT NULL DEFAULT '0',
  `t06_sup` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t06_cod_fin_sup`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t06_fin_sup_t02_dg_proy1` (`t02_cod_proy`,`t02_version`) USING BTREE,
  CONSTRAINT `t06_fin_sup_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t07_prop_ind`
--

DROP TABLE IF EXISTS `t07_prop_ind`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t07_prop_ind` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t07_cod_prop_ind` int(11) NOT NULL DEFAULT '0',
  `t07_ind` varchar(250) DEFAULT NULL,
  `t07_um` varchar(30) DEFAULT NULL,
  `t07_mta` double DEFAULT NULL,
  `t07_fv` varchar(250) DEFAULT NULL,
  `t07_obs` varchar(500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t07_cod_prop_ind`),
  KEY `t02_cod_proy` (`t02_cod_proy`,`t02_version`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t07_prop_ind_inf`
--

DROP TABLE IF EXISTS `t07_prop_ind_inf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t07_prop_ind_inf` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t07_cod_prop_ind` int(11) NOT NULL DEFAULT '0',
  `t07_ind_anio` int(11) NOT NULL,
  `t07_ind_entregable` int(11) NOT NULL,
  `t07_ind_avanc` double DEFAULT NULL,
  `t07_descrip` text,
  `t07_dificul` text,
  `t07_logros` text,
  `t07_observaciones` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t07_cod_prop_ind`,`t07_ind_anio`,`t07_ind_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Avance trimestral de indicadores de proposito';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t07_prop_sup`
--

DROP TABLE IF EXISTS `t07_prop_sup`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t07_prop_sup` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t07_cod_prop_sup` int(11) NOT NULL DEFAULT '0',
  `t07_sup` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t07_cod_prop_sup`,`t02_cod_proy`,`t02_version`),
  KEY `fk_t07_prop_sup_t02_dg_proy1` (`t02_cod_proy`,`t02_version`) USING BTREE,
  CONSTRAINT `t07_prop_sup_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t08_comp`
--

DROP TABLE IF EXISTS `t08_comp`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t08_comp` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL DEFAULT '0',
  `t08_comp_desc` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t08_comp_t02_dg_proy1` (`t02_cod_proy`,`t02_version`) USING BTREE,
  CONSTRAINT `t08_comp_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`) REFERENCES `t02_dg_proy` (`t02_cod_proy`, `t02_version`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t08_comp_ind`
--

DROP TABLE IF EXISTS `t08_comp_ind`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t08_comp_ind` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t08_cod_comp_ind` int(11) NOT NULL DEFAULT '0',
  `t08_ind` varchar(250) DEFAULT NULL,
  `t08_um` varchar(30) DEFAULT NULL,
  `t08_mta` double DEFAULT NULL,
  `t08_fv` varchar(250) DEFAULT NULL,
  `t08_obs` varchar(500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t08_cod_comp_ind`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t08_comp_ind_t08_comp1` (`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t08_comp_ind_ibfk_1` FOREIGN KEY (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t08_comp` (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t08_comp_ind_inf`
--

DROP TABLE IF EXISTS `t08_comp_ind_inf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t08_comp_ind_inf` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t08_cod_comp_ind` int(11) NOT NULL,
  `t08_ind_anio` int(11) NOT NULL,
  `t08_ind_entregable` int(11) NOT NULL,
  `t08_ind_avanc` double DEFAULT NULL,
  `t08_descrip` text,
  `t08_dificul` text,
  `t08_logros` text,
  `t08_obs` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t08_cod_comp_ind`,`t08_cod_comp`,`t02_cod_proy`,`t08_ind_anio`,`t08_ind_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t08_comp_ind_inf_mi`
--

DROP TABLE IF EXISTS `t08_comp_ind_inf_mi`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t08_comp_ind_inf_mi` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t08_cod_comp_ind` int(11) NOT NULL,
  `t45_id` int(11) NOT NULL COMMENT 'Id del informe del monitor Interno',
  `t45_ind_avanc` double DEFAULT NULL,
  `t45_descrip` text,
  `t45_dificul` text,
  `t45_logros` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t08_cod_comp_ind`,`t45_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t08_comp_ind_inf_se`
--

DROP TABLE IF EXISTS `t08_comp_ind_inf_se`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t08_comp_ind_inf_se` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t08_cod_comp_ind` int(11) NOT NULL,
  `t08_obs` text,
  `t08_avance` double DEFAULT NULL COMMENT 'Avance Verificado por el Supervisor',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t08_cod_comp_ind`,`t08_cod_comp`,`t02_cod_proy`,`t02_anio`,`t02_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Avance de indicadores de componentes según Supervisor Extern';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t08_comp_ind_inf_si`
--

DROP TABLE IF EXISTS `t08_comp_ind_inf_si`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t08_comp_ind_inf_si` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t08_cod_comp_ind` int(11) NOT NULL,
  `t08_obs` text,
  `t08_avance` double DEFAULT NULL COMMENT 'Avance Verificado por el Supervisor',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t08_cod_comp_ind`,`t08_cod_comp`,`t02_cod_proy`,`t02_anio`,`t02_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Avance de indicadores de componentes según Supervisor Intern';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t08_comp_sup`
--

DROP TABLE IF EXISTS `t08_comp_sup`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t08_comp_sup` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t08_cod_comp_sup` int(11) NOT NULL DEFAULT '0',
  `t08_sup` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t08_cod_comp_sup`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t08_comp_sup_t08_comp1` (`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t08_comp_sup_ibfk_1` FOREIGN KEY (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t08_comp` (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act`
--

DROP TABLE IF EXISTS `t09_act`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL DEFAULT '0',
  `t09_act` varchar(250) DEFAULT NULL,
  `t09_obs` varchar(500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t09_act_t08_comp1` (`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t09_act_ibfk_1` FOREIGN KEY (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t08_comp` (`t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE NO ACTION ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_ind`
--

DROP TABLE IF EXISTS `t09_act_ind`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_ind` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t09_ind` varchar(250) DEFAULT NULL,
  `t09_um` varchar(30) DEFAULT NULL,
  `t09_mta` double DEFAULT NULL,
  `t09_fv` varchar(250) DEFAULT NULL,
  `t09_obs` varchar(500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`),
  KEY `FK_t09_act_ind` (`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t09_act_ind_ibfk_1` FOREIGN KEY (`t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t09_act` (`t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_ind_car`
--

DROP TABLE IF EXISTS `t09_act_ind_car`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_ind_car` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t09_cod_act_ind_car` int(11) NOT NULL,
  `t09_ind` varchar(250) DEFAULT NULL,
  `t09_mta` double DEFAULT NULL,
  `t09_fv` varchar(250) DEFAULT NULL,
  `t09_obs` varchar(500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t09_cod_act_ind_car`),
  KEY `FK_t09_act_ind_car` (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`) USING BTREE,
  CONSTRAINT `t09_act_ind_car_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`) REFERENCES `t09_act_ind` (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_ind_car_ctrl`
--

DROP TABLE IF EXISTS `t09_act_ind_car_ctrl`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_ind_car_ctrl` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t09_cod_act_ind_car` int(11) NOT NULL,
  `t09_car_anio` tinyint(4) NOT NULL,
  `t09_car_mes` tinyint(4) NOT NULL,
  `t09_car_ctrl` tinyint(4) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t09_cod_act_ind_car`,`t09_car_anio`,`t09_car_mes`),
  KEY `FK_t09_act_ind_car_ctrl` (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t09_cod_act_ind_car`) USING BTREE,
  CONSTRAINT `t09_act_ind_car_ctrl_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`, `t09_cod_act_ind_car`) REFERENCES `t09_act_ind_car` (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`, `t09_cod_act_ind_car`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_ind_inf_mi`
--

DROP TABLE IF EXISTS `t09_act_ind_inf_mi`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_ind_inf_mi` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) DEFAULT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t45_id` int(11) NOT NULL COMMENT 'Id del informe del monitor Interno',
  `t45_avanc` double NOT NULL,
  `t45_descrip` varchar(5000) DEFAULT NULL,
  `t45_logros` varchar(2500) DEFAULT NULL,
  `t45_dificul` varchar(2500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t45_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_ind_mtas`
--

DROP TABLE IF EXISTS `t09_act_ind_mtas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_ind_mtas` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t09_ind_anio` int(11) NOT NULL,
  `t09_ind_mes` int(11) NOT NULL,
  `t09_ind_mta` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t09_ind_anio`,`t09_ind_mes`),
  CONSTRAINT `t09_act_ind_mtas_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`) REFERENCES `t09_act_ind` (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_act_ind`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_ind_mtas_inf`
--

DROP TABLE IF EXISTS `t09_act_ind_mtas_inf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_ind_mtas_inf` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) DEFAULT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_act_ind` int(11) NOT NULL,
  `t09_ind_anio` int(11) NOT NULL,
  `t09_ind_mes` int(11) NOT NULL,
  `t09_ind_avanc` double DEFAULT NULL,
  `t09_descrip` varchar(5000) DEFAULT NULL,
  `t09_logros` varchar(2500) DEFAULT NULL,
  `t09_dificul` varchar(2500) DEFAULT NULL,
  `t09_obs` varchar(2500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`,`t09_ind_anio`,`t09_ind_mes`),
  KEY `fk_t09_act_ind_mtas` (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_act_ind`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_inf_se`
--

DROP TABLE IF EXISTS `t09_act_inf_se`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_inf_se` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_prod` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_obs` varchar(5000) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_act`,`t02_anio`,`t02_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_inf_si`
--

DROP TABLE IF EXISTS `t09_act_inf_si`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_inf_si` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_prod` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_obs` varchar(5000) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_act`,`t02_anio`,`t02_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_sub_mtas_inf`
--

DROP TABLE IF EXISTS `t09_act_sub_mtas_inf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_sub_mtas_inf` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) DEFAULT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t09_sub_anio` int(11) NOT NULL,
  `t09_sub_mes` int(11) NOT NULL,
  `t09_sub_avanc` double DEFAULT NULL,
  `t09_descrip` varchar(6000) DEFAULT NULL,
  `t09_logros` varchar(3000) DEFAULT NULL,
  `t09_dificul` varchar(3000) DEFAULT NULL,
  `t09_omt` varchar(3000) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t09_cod_sub`,`t09_cod_act`,`t08_cod_comp`,`t02_cod_proy`,`t09_sub_anio`,`t09_sub_mes`),
  KEY `fk_t09_act_sub_mtas_inf_t09_subact1` (`t09_cod_sub`,`t09_cod_act`,`t08_cod_comp`,`t02_cod_proy`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_act_sub_mtas_inf_mi`
--

DROP TABLE IF EXISTS `t09_act_sub_mtas_inf_mi`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_act_sub_mtas_inf_mi` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t45_id` int(11) NOT NULL,
  `t45_avanc` double DEFAULT NULL,
  `t45_descrip` varchar(5000) DEFAULT NULL,
  `t45_logros` varchar(2500) DEFAULT NULL,
  `t45_dificul` varchar(2500) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t45_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_entregable_ind_inf`
--

DROP TABLE IF EXISTS `t09_entregable_ind_inf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_entregable_ind_inf` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) DEFAULT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_prod` int(11) NOT NULL,
  `t09_cod_prod_ind` int(11) NOT NULL,
  `t09_ind_anio` int(11) NOT NULL,
  `t09_ind_entregable` int(11) NOT NULL,
  `t09_ind_avanc` double DEFAULT NULL,
  `t09_descrip` text,
  `t09_logros` text,
  `t09_dificul` text,
  `t09_obs` text,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`,`t09_ind_anio`,`t09_ind_entregable`),
  KEY `fk_t09_entregable_ind` (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_prod_ind_car_inf_se`
--

DROP TABLE IF EXISTS `t09_prod_ind_car_inf_se`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_prod_ind_car_inf_se` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_prod` int(11) NOT NULL,
  `t09_cod_prod_ind` int(11) NOT NULL,
  `t09_cod_prod_ind_car` int(11) NOT NULL,
  `t09_obs` text,
  `t09_avance` double DEFAULT NULL COMMENT 'Avance Verificado por el Supervisor',
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`,`t09_cod_prod_ind_car`,`t02_anio`,`t02_entregable`),
  KEY `fk_t09_prod_ind_car` (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`,`t09_cod_prod_ind_car`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Avance de características de indicadores de productos según ';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_prod_ind_car_inf_si`
--

DROP TABLE IF EXISTS `t09_prod_ind_car_inf_si`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_prod_ind_car_inf_si` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_prod` int(11) NOT NULL,
  `t09_cod_prod_ind` int(11) NOT NULL,
  `t09_cod_prod_ind_car` int(11) NOT NULL,
  `t09_obs` text,
  `t09_avance` double DEFAULT NULL COMMENT 'Avance Verificado por el Supervisor',
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`,`t09_cod_prod_ind_car`,`t02_anio`,`t02_entregable`),
  KEY `fk_t09_prod_ind_car` (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`,`t09_cod_prod_ind_car`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Avance de características de indicadores de productos según ';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_prod_ind_inf_se`
--

DROP TABLE IF EXISTS `t09_prod_ind_inf_se`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_prod_ind_inf_se` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_prod` int(11) NOT NULL,
  `t09_cod_prod_ind` int(11) NOT NULL,
  `t09_obs` text,
  `t09_avance` double DEFAULT NULL COMMENT 'Avance Verificado por el Supervisor',
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`,`t02_anio`,`t02_entregable`),
  KEY `fk_t09_prod_ind_mtas` (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Avance de indicadores de productos según Supervisor Externo';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_prod_ind_inf_si`
--

DROP TABLE IF EXISTS `t09_prod_ind_inf_si`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_prod_ind_inf_si` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_prod` int(11) NOT NULL,
  `t09_cod_prod_ind` int(11) NOT NULL,
  `t09_obs` text,
  `t09_avance` double DEFAULT NULL COMMENT 'Avance Verificado por el Supervisor',
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`,`t02_anio`,`t02_entregable`),
  KEY `fk_t09_prod_ind_mtas` (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_prod`,`t09_cod_prod_ind`) USING BTREE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Avance de indicadores de productos según Supervisor Interno';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_sub_act_mtas`
--

DROP TABLE IF EXISTS `t09_sub_act_mtas`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_sub_act_mtas` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t09_cod_mta` int(11) NOT NULL DEFAULT '0',
  `t09_anio` int(11) NOT NULL DEFAULT '0',
  `t09_mes` int(11) NOT NULL DEFAULT '0',
  `t09_mta` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t09_anio`,`t09_mes`),
  KEY `fk_t09_sub_act_mtas_t09_subact1` (`t09_cod_sub`,`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t09_sub_act_mtas_ibfk_1` FOREIGN KEY (`t09_cod_sub`, `t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t09_subact` (`t09_cod_sub`, `t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_sub_act_plan`
--

DROP TABLE IF EXISTS `t09_sub_act_plan`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_sub_act_plan` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t09_desc_bene` varchar(250) DEFAULT NULL,
  `t09_contenido` text,
  `t09_lugar` varchar(150) DEFAULT NULL,
  `t09_frecuencia` varchar(150) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`),
  KEY `fk_t09_sub_act_plan_t09_subact1` (`t09_cod_sub`,`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t09_sub_act_plan_ibfk_1` FOREIGN KEY (`t09_cod_sub`, `t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t09_subact` (`t09_cod_sub`, `t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t09_subact`
--

DROP TABLE IF EXISTS `t09_subact`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t09_subact` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL DEFAULT '0',
  `t09_sub` varchar(250) DEFAULT NULL,
  `t09_um` varchar(50) DEFAULT NULL,
  `t09_mta` double DEFAULT NULL,
  `t09_fv` varchar(250) DEFAULT NULL,
  `t09_tipo_sub` int(11) DEFAULT NULL COMMENT 'Tipo de Sub Actividad (Capacitación, Asistencia Técnica, Otros Servicios)\nTomar esta data de la tabla de opciones',
  `t09_act_crit` int(11) DEFAULT NULL,
  `t09_obs` varchar(500) DEFAULT NULL,
  `t09_mta_proy` double DEFAULT NULL COMMENT 'Meta Proyectada para los Años Restantes. POA',
  `t09_mta_repro` double DEFAULT NULL COMMENT 'Meta Reprogramada POA',
  `t09_resumen` text,
  `t09_obs_mt` text,
  `t09_obs_mf` text,
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t09_cod_sub`,`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t09_subact_t09_act1` (`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t09_subact_ibfk_1` FOREIGN KEY (`t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t09_act` (`t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_ins_mta_repro` BEFORE INSERT ON `t09_subact`
 FOR EACH ROW BEGIN
       
	IF NEW.t02_version = 1  THEN
	      set NEW.t09_mta_repro = NEW.t09_mta ;   
	END IF ;
	
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_upd_mta_repro` BEFORE UPDATE ON `t09_subact`
 FOR EACH ROW BEGIN
       IF NEW.t02_version = 1 AND NEW.t09_mta <> OLD.t09_mta THEN
	      SET NEW.t09_mta_repro = NEW.t09_mta ;   
	END IF ;
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t10_cost_fte`
--

DROP TABLE IF EXISTS `t10_cost_fte`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t10_cost_fte` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t10_cod_cost` int(11) NOT NULL,
  `t10_cod_fte` int(11) NOT NULL DEFAULT '0',
  `t01_id_inst` int(11) DEFAULT NULL,
  `t10_mont_dona` double DEFAULT NULL COMMENT 'Aporte en Donación',
  `t10_mont_cred` double DEFAULT NULL COMMENT 'Aporte en Créditos',
  `t10_mont` double DEFAULT NULL,
  `t10_porc` double DEFAULT '0' COMMENT 'Porcentaje Aportado',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t10_cod_fte`,`t10_cod_cost`,`t09_cod_sub`,`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`),
  KEY `fk_t10_cost_fte_t10_cost_sub1` (`t10_cod_cost`,`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`) USING BTREE,
  CONSTRAINT `t10_cost_fte_ibfk_1` FOREIGN KEY (`t10_cod_cost`, `t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_sub`) REFERENCES `t10_cost_sub` (`t10_cod_cost`, `t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_sub`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t10_cost_sub`
--

DROP TABLE IF EXISTS `t10_cost_sub`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t10_cost_sub` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t10_cod_cost` int(11) NOT NULL DEFAULT '0',
  `t10_cost` varchar(250) DEFAULT NULL,
  `t10_cate_cost` int(11) DEFAULT NULL COMMENT 'Categoría de Gasto o Costoes tomada de ',
  `t10_um` varchar(50) DEFAULT NULL,
  `t10_cant` double DEFAULT NULL,
  `t10_cu` double DEFAULT NULL,
  `t10_cost_parc` double DEFAULT NULL,
  `t10_cost_tot` double DEFAULT NULL COMMENT 'Es el t10_cost_parc multiplicado por la meta de la sub actividad registrada en t09_subact',
  `t10_obs_mf` text COMMENT 'Observaciones del Monitor Financiero',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t10_cod_cost`,`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`),
  KEY `fk_t10_cost_sub_t09_subact1` (`t09_cod_sub`,`t09_cod_act`,`t08_cod_comp`,`t02_version`,`t02_cod_proy`) USING BTREE,
  CONSTRAINT `t10_cost_sub_ibfk_1` FOREIGN KEY (`t09_cod_sub`, `t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) REFERENCES `t09_subact` (`t09_cod_sub`, `t09_cod_act`, `t08_cod_comp`, `t02_version`, `t02_cod_proy`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t11_bco_bene`
--

DROP TABLE IF EXISTS `t11_bco_bene`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t11_bco_bene` (
  `t11_cod_bene` int(11) NOT NULL DEFAULT '0',
  `t02_cod_proy` varchar(10) DEFAULT NULL,
  `t11_dni` varchar(20) DEFAULT NULL,
  `t11_ape_pat` varchar(50) DEFAULT NULL,
  `t11_ape_mat` varchar(50) DEFAULT NULL,
  `t11_nom` varchar(50) DEFAULT NULL,
  `t11_sexo` int(11) DEFAULT NULL,
  `t11_edad` int(11) DEFAULT NULL,
  `t11_nivel_educ` int(11) DEFAULT NULL COMMENT 'Nivel educativo, tomar de la tabla auxiliar',
  `t11_especialidad` int(11) DEFAULT NULL COMMENT 'Especialidad del Beneficiario',
  `t11_fec_ini` date DEFAULT NULL COMMENT 'Fecha de inicio de actividades',
  `t11_fec_ter` date DEFAULT NULL COMMENT 'Fecha de cese de actividades',
  `t11_sec_prod_main` int(11) DEFAULT NULL COMMENT 'Sector Principal',
  `t11_sec_prod` int(11) DEFAULT NULL,
  `t11_subsector` int(11) DEFAULT NULL COMMENT 'Subsector',
  `t11_unid_prod_1` int(11) DEFAULT NULL COMMENT 'Nro de Unidad de Produccion',
  `t11_nro_up_b` double DEFAULT NULL COMMENT 'Nro de Unidad de Produccion con el proyecto',
  `t11_sec_prod_main_2` int(11) DEFAULT NULL COMMENT 'Sector Principal 2',
  `t11_sec_prod_2` int(11) DEFAULT NULL COMMENT 'Segundo sector productivo',
  `t11_subsec_prod_2` int(11) DEFAULT NULL COMMENT 'Segundo subsector productivo',
  `t11_tot_unid_prod` int(11) DEFAULT NULL,
  `t11_tot_unid_prod_2` int(11) DEFAULT NULL,
  `t11_unid_prod_2` int(1) DEFAULT NULL COMMENT 'Segunda unidad de produccion',
  `t11_nro_up_b_2` double DEFAULT NULL COMMENT 'Segundo Nro de Unidad de Produccion con el Proyecto',
  `t11_nom_prod` varchar(100) DEFAULT NULL,
  `t11_direccion` varchar(200) DEFAULT NULL,
  `t11_dpto` varchar(2) DEFAULT NULL,
  `t11_prov` varchar(2) DEFAULT NULL,
  `t11_dist` varchar(2) DEFAULT NULL,
  `t11_ciudad` varchar(50) DEFAULT NULL,
  `t11_case` varchar(4) DEFAULT NULL COMMENT 'Codigo de caserios',
  `t11_act_princ` varchar(50) DEFAULT NULL,
  `t11_telefono` varchar(50) DEFAULT NULL,
  `t11_celular` varchar(50) DEFAULT NULL,
  `t11_mail` varchar(50) DEFAULT NULL,
  `t11_estado` int(11) DEFAULT NULL COMMENT 'Activo, Inactivo',
  `t11_obs` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t11_sec_prod_main_3` int(11) DEFAULT NULL COMMENT 'Sector Principal 3',
  `t11_sec_prod_3` int(11) DEFAULT NULL,
  `t11_subsec_prod_3` int(11) DEFAULT NULL,
  `t11_unid_prod_3` int(11) DEFAULT NULL,
  `t11_tot_unid_prod_3` int(11) DEFAULT NULL,
  `t11_nro_up_b_3` double DEFAULT NULL,
  `t11_esp_otro` varchar(30) DEFAULT NULL,
  PRIMARY KEY (`t11_cod_bene`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8 COMMENT='Padron de Beneficiarios';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t12_plan_at`
--

DROP TABLE IF EXISTS `t12_plan_at`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t12_plan_at` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t12_nro_tema` int(11) DEFAULT NULL COMMENT 'Numero de Temas por Beneficiario',
  `t12_hor_cap` int(11) DEFAULT NULL COMMENT 'Numero de Horas de Capacitación',
  `t12_nro_ben` int(11) DEFAULT NULL COMMENT 'Numero de Beneficiarios',
  `t12_conten` text COLLATE utf8_unicode_ci COMMENT 'Contenidos de la Planificacion',
  `t12_modulo` int(11) DEFAULT NULL COMMENT 'Modulo',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t12_plan_capac`
--

DROP TABLE IF EXISTS `t12_plan_capac`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t12_plan_capac` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL DEFAULT '0',
  `t12_nro_tema` int(11) DEFAULT NULL COMMENT 'Numero de Temas por Beneficiario',
  `t12_hor_cap` int(11) DEFAULT NULL COMMENT 'Numero de Horas de Capacitación',
  `t12_nro_ben` int(11) DEFAULT NULL COMMENT 'Numero de Beneficiarios',
  `t12_conten` text COLLATE utf8_unicode_ci COMMENT 'Contenidos de la Planificacion',
  `t12_modulo` int(11) DEFAULT NULL COMMENT 'Modulo',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t12_plan_capac_tema`
--

DROP TABLE IF EXISTS `t12_plan_capac_tema`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t12_plan_capac_tema` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL DEFAULT '0',
  `t12_cod_tema` int(11) NOT NULL COMMENT 'Codigo del Tema Especifico de Capacitación',
  `t12_tem_espe` text CHARACTER SET utf8 COMMENT 'Temas Especificos',
  `t12_nro_hora` double DEFAULT NULL,
  `t12_nro_bene` int(11) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t12_cod_tema`),
  CONSTRAINT `t12_plan_capac_tema_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_sub`) REFERENCES `t12_plan_capac` (`t02_cod_proy`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_sub`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t12_plan_cred`
--

DROP TABLE IF EXISTS `t12_plan_cred`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t12_plan_cred` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t12_nro_ben` int(11) DEFAULT NULL COMMENT 'Numero de Beneficiarios',
  `t12_mto_ben` double DEFAULT NULL COMMENT 'Monto maximo por beneficiario',
  `t12_nro_cuo` int(11) DEFAULT NULL COMMENT 'Numero maximo de cuotas',
  `t12_tasa_int` decimal(10,0) DEFAULT NULL COMMENT 'Tasa de Interes',
  `t12_obs` text COLLATE utf8_unicode_ci,
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t12_plan_cred_benef`
--

DROP TABLE IF EXISTS `t12_plan_cred_benef`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t12_plan_cred_benef` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t11_cod_benef` int(11) NOT NULL,
  `t12_mto_ben` double DEFAULT NULL COMMENT 'Monto maximo por beneficiario',
  `t12_nro_cuo` int(11) DEFAULT NULL COMMENT 'Numero maximo de cuotas',
  `t12_tasa_int` decimal(10,0) DEFAULT NULL COMMENT 'Tasa de Interes',
  `t12_obs` text COLLATE utf8_unicode_ci,
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t11_cod_benef`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t12_plan_otros`
--

DROP TABLE IF EXISTS `t12_plan_otros`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t12_plan_otros` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t12_producto` varchar(30) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT 'Producto o Servicio',
  `t12_nro_ent` double DEFAULT NULL COMMENT 'Numero de productos por Beneficiario',
  `t12_nro_ben` double DEFAULT NULL COMMENT 'Numero de Beneficiarios',
  `t12_tot_ent` double DEFAULT NULL COMMENT 'Total entregado',
  `t12_conten` text COLLATE utf8_unicode_ci COMMENT 'Contenidos de la Planificacion',
  `t12_tipo` int(11) DEFAULT NULL COMMENT 'Tipo de Servicio',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t20_inf_mes`
--

DROP TABLE IF EXISTS `t20_inf_mes`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t20_inf_mes` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t20_anio` int(11) NOT NULL,
  `t20_mes` int(11) NOT NULL,
  `t20_ver_inf` int(11) NOT NULL COMMENT 'Version del Informe',
  `t20_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Prswentacion del Informe',
  `t20_periodo` varchar(50) DEFAULT NULL,
  `t20_avance` text,
  `t20_apro_mt` bit(1) DEFAULT NULL,
  `t20_apro_fch` datetime DEFAULT NULL COMMENT 'Fecha de Aprobacion',
  `t20_obs` text,
  `t20_dificul` text,
  `t20_program` text,
  `t20_estado` int(11) DEFAULT NULL COMMENT 'Activo, Inactivo',
  `t02_version` int(11) DEFAULT NULL COMMENT 'Version del Proyecto',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `vb_se` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`t02_cod_proy`,`t20_anio`,`t20_mes`,`t20_ver_inf`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Informes Mensuales - Cabecera';
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`soporte`@`%`*/ /*!50003 TRIGGER `trg_ins_men` AFTER UPDATE ON t20_inf_mes FOR EACH ROW

BEGIN
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} del proyecto {proyecto} correspondiente al Año {anio} - Mes ({ref} ).
                Favor de Verficarlo.
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT;
    DECLARE _inst	VARCHAR(200); 
	DECLARE _mailproy	VARCHAR(200); 
	DECLARE _mailejec	VARCHAR(200); 	
    DECLARE _mon_tec	VARCHAR(200);
    DECLARE _mon_fin	VARCHAR(200);
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino	 VARCHAR(200); 
    DECLARE _est_rev 	INT DEFAULT 46;
    DECLARE _est_corr 	INT DEFAULT 47;
	DECLARE _est_vbmonitor 	INT DEFAULT 135;
	
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT u.mail 
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy)  LIMIT 0,1; 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);     
	
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
   IF NEW.t20_estado=_est_rev THEN 
		SELECT _mon_tec  INTO _destino ; 		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Proyecto {proyecto} - {inst} , ha enviado a revisión su  informe técnico. ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
			--	La Institucion Ejecutora {inst} ha elaborado y enviado a revisión el informe técnico ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
   END IF; 
	
	
    
    IF NEW.t20_estado=_est_corr THEN 	
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _mailejec ),'') 
			      ) ;
		SET _asunto = REPLACE(_asunto,"{asunto}","El informe técnico del Proyecto {proyecto} - {inst} , ha sido enviado a corrección ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		set _msg = "Señores Ejecutores - {inst},
				El Informe Técnico del Año {anio}, mes {ref} del proyecto {proyecto}, ha sido observado, levantar las observaciones y solicitar nuevamente su revisión.
                - Sistema de Evaluacion y Monitoreo.";
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
    END IF; 
	
	
    IF NEW.t20_estado=_est_vbmonitor  THEN 	
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _mailejec ),'') 
			      ) ;
		SET _asunto = REPLACE(_asunto,"{asunto}","El informe técnico del Proyecto {proyecto} - {inst} , tiene el vb del monitor técnico ");
		SET _asunto = REPLACE(_asunto,"{proyecto}", NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","Ejecutores - {inst},
				Se ha dado el visto bueno al informe técnico ");
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
    END IF; 
	
	SET _msg = REPLACE(_msg,"{anio}",NEW.t20_anio);
	SET _msg = REPLACE(_msg,"{ref}",NEW.t20_mes);
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     
	SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t20_inf_mes_anx`
--

DROP TABLE IF EXISTS `t20_inf_mes_anx`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t20_inf_mes_anx` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t20_anio` int(11) NOT NULL,
  `t20_mes` int(11) NOT NULL,
  `t20_ver_inf` int(11) NOT NULL COMMENT 'Version del Informe',
  `t20_cod_anx` int(11) NOT NULL,
  `t20_nom_file` varchar(50) DEFAULT NULL COMMENT 'Fecha de Prswentacion del Informe',
  `t20_url_file` varchar(100) DEFAULT NULL,
  `t20_desc_file` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t20_anio`,`t20_mes`,`t20_ver_inf`,`t20_cod_anx`),
  KEY `fk_t20_inf_mes_anx` (`t02_cod_proy`,`t20_anio`,`t20_mes`,`t20_ver_inf`) USING BTREE,
  CONSTRAINT `t20_inf_mes_anx_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t20_anio`, `t20_mes`, `t20_ver_inf`) REFERENCES `t20_inf_mes` (`t02_cod_proy`, `t20_anio`, `t20_mes`, `t20_ver_inf`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Documentos Anexados al Informe Mensual';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t20_inf_mes_prob`
--

DROP TABLE IF EXISTS `t20_inf_mes_prob`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t20_inf_mes_prob` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t20_anio` int(11) NOT NULL,
  `t20_mes` int(11) NOT NULL,
  `t20_ver_inf` int(11) NOT NULL COMMENT 'Version del Informe',
  `t20_cod_prob` int(11) NOT NULL,
  `t20_problemas` varchar(6000) DEFAULT NULL COMMENT 'Fecha de Prswentacion del Informe',
  `t20_soluciones` varchar(6000) DEFAULT NULL,
  `t20_resultados` varchar(6000) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t20_anio`,`t02_cod_proy`,`t20_mes`,`t20_ver_inf`,`t20_cod_prob`),
  KEY `FK_t20_inf_mes_prob2` (`t02_cod_proy`,`t20_anio`,`t20_mes`,`t20_ver_inf`) USING BTREE,
  CONSTRAINT `t20_inf_mes_prob_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t20_anio`, `t20_mes`, `t20_ver_inf`) REFERENCES `t20_inf_mes` (`t02_cod_proy`, `t20_anio`, `t20_mes`, `t20_ver_inf`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Problemas y Soluciones del Informe Mensual';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_entregable`
--

DROP TABLE IF EXISTS `t25_inf_entregable`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_entregable` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL DEFAULT '0' COMMENT 'Versión del Proyecto',
  `t25_anio` int(11) NOT NULL,
  `t25_entregable` int(11) NOT NULL,
  `t25_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Presentación del Informe',
  `t25_periodo` varchar(50) DEFAULT NULL,
  `t25_estado` int(11) DEFAULT NULL COMMENT 'Proceso\nCerrado',
  `t25_resulta` text COMMENT 'Análisis de resultado',
  `t25_conclu` text COMMENT 'Conclusiones',
  `t25_limita` text COMMENT 'Limitaciones\n',
  `t25_fac_pos` text COMMENT 'Factores Positivos',
  `t25_perspec` text COMMENT 'Perspectivas',
  `t25_vb` char(1) DEFAULT NULL COMMENT 'VB del GP',
  `t25_vb_fch` datetime DEFAULT NULL COMMENT 'Fecha de VB',
  `t25_vb_txt` text COMMENT 'Observaciones del VB',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `obs_gp` text,
  `intro_gp` text,
  `vb_se` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t25_anio`,`t25_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Informes de Entregable - Cabecera';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_entregable_anx`
--

DROP TABLE IF EXISTS `t25_inf_entregable_anx`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_entregable_anx` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_version` int(11) NOT NULL DEFAULT '0' COMMENT 'Versión del Proyecto',
  `t25_anio` int(11) NOT NULL,
  `t25_entregable` int(11) NOT NULL,
  `t25_cod_anx` int(11) NOT NULL,
  `t25_nom_file` varchar(100) DEFAULT NULL COMMENT 'nombre del achivo',
  `t25_url_file` varchar(100) DEFAULT NULL COMMENT 'url del archivo',
  `t25_desc_file` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t25_anio`,`t25_entregable`,`t25_cod_anx`),
  KEY `fk_t25_inf_entregable_anx` (`t02_cod_proy`,`t02_version`,`t25_anio`,`t25_entregable`) USING BTREE,
  CONSTRAINT `t25_inf_entregable_anx_ibfk` FOREIGN KEY (`t02_cod_proy`, `t02_version`, `t25_anio`, `t25_entregable`) REFERENCES `t25_inf_entregable` (`t02_cod_proy`, `t02_version`, `t25_anio`, `t25_entregable`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Documentos Anexados al Informe de Entregable';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_entregable_at`
--

DROP TABLE IF EXISTS `t25_inf_entregable_at`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_entregable_at` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL DEFAULT '0' COMMENT 'Versión del Proyecto',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_entregable` int(11) NOT NULL COMMENT 'Entregable',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Código del Beneficiario',
  `t15_avance` char(1) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT 'P:En Proceso, C: Capacitado, R: Retirado',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t25_anio`,`t25_entregable`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_entregable_capac`
--

DROP TABLE IF EXISTS `t25_inf_entregable_capac`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_entregable_capac` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL DEFAULT '0' COMMENT 'Versión del Proyecto',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL DEFAULT '0',
  `t12_cod_tema` int(11) NOT NULL COMMENT 'Código del Tema Específico de Capacitación',
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_entregable` int(11) NOT NULL COMMENT 'Entregable',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Código del Beneficiario',
  `t15_avance` char(1) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT 'P:En Proceso, C: Capacitado, R: Retirado',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t25_anio`,`t25_entregable`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t12_cod_tema`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_entregable_cred`
--

DROP TABLE IF EXISTS `t25_inf_entregable_cred`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_entregable_cred` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL DEFAULT '0' COMMENT 'Versión del Proyecto',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_entregable` int(11) NOT NULL COMMENT 'Entregable',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Código del Beneficiario',
  `t15_avance` double DEFAULT NULL COMMENT 'Monto de Crédito',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t25_anio`,`t25_entregable`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_entregable_otros`
--

DROP TABLE IF EXISTS `t25_inf_entregable_otros`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_entregable_otros` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t02_version` int(11) NOT NULL DEFAULT '0' COMMENT 'Versión del Proyecto',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_entregable` int(11) NOT NULL COMMENT 'Entregable',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Código del Beneficiario',
  `t15_avance` char(1) COLLATE utf8_unicode_ci DEFAULT NULL,
  `t15_valor` varchar(30) COLLATE utf8_unicode_ci DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_version`,`t25_anio`,`t25_entregable`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_trim`
--

DROP TABLE IF EXISTS `t25_inf_trim`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_trim` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t25_anio` int(11) NOT NULL,
  `t25_trim` int(11) NOT NULL,
  `t25_ver_inf` int(11) NOT NULL COMMENT 'Version del Informe',
  `t25_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Presentacion del Informe',
  `t25_periodo` varchar(50) DEFAULT NULL,
  `t25_estado` int(11) DEFAULT NULL COMMENT 'Proceso\nCerrado',
  `t25_resulta` text COMMENT 'Analisis de resultado',
  `t25_conclu` text COMMENT 'Conclusiones',
  `t25_limita` text COMMENT 'Limitaciones\n',
  `t25_fac_pos` text COMMENT 'Factores Positivos',
  `t25_perspec` text COMMENT 'Perspectivas',
  `t02_version` int(11) DEFAULT NULL COMMENT 'Version del Proyecto',
  `t25_apro_mt` char(1) DEFAULT NULL COMMENT 'Aprobado (VB)',
  `t25_apro_fch` datetime DEFAULT NULL COMMENT 'Fecha de Aprobacion',
  `t25_apro_txt` text COMMENT 'observaciones de la aprobacion',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `obs_mt` text,
  PRIMARY KEY (`t02_cod_proy`,`t25_anio`,`t25_trim`,`t25_ver_inf`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Informes Trimestral - Cabecera';
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_upd_inf_trim` AFTER UPDATE ON `t25_inf_trim`
 FOR EACH ROW BEGIN
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto} Informe Trimestral.";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} Informe Trimestral correspondiente al Año {anio}  - Trim {trim}  ({ref} ) del proyecto {proyecto}
                Favor de Verficar el Informe.
                Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT;
    DECLARE _inst	VARCHAR(200);  
	DECLARE _mailproy	VARCHAR(200); 
	DECLARE _mailejec	VARCHAR(200); 	
    DECLARE _mon_te VARCHAR(200);
    DECLARE _mon_fi VARCHAR(200);
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino	 VARCHAR(200); 
    DECLARE _est_rev 	INT DEFAULT 46;
    DECLARE _est_corr 	INT DEFAULT 47;
    DECLARE _est_aprob 	INT DEFAULT 135;
     
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
    
    
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

	 SELECT u.mail 
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	
    
    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_te
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);     
    
	    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fi
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);   
	
    
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
     
	 
 
    IF NEW.t25_estado=_est_rev THEN 
		SELECT _mon_te INTO _destino ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Proyecto {proyecto} - {inst} , ha enviado a revisión su  ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				La Institucion Ejecutora {inst} ha elaborado y enviado a revisión el ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
    END IF; 
	 
	
	IF NEW.t25_estado=_est_corr THEN 	
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _mailejec ),'') 
			      ) ;
		SET _asunto = REPLACE(_asunto,"{asunto}","El monitor técnico del Proyecto {proyecto} - {inst} , ha enviado a corrección el ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		set _msg = "Señores Ejecutores - {inst},
				El Informe Trimestral Técnico correspondiente al Año {anio} - Trim {trim} del proyecto {proyecto}, ha sido observado, levantar las observaciones y solicitar nuevamente su revisión.
                Sistema de Evaluacion y Monitoreo.";	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		
    END IF; 
  
	
    IF NEW.t25_estado=_est_aprob  THEN 	
	SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _mailejec ),'') 
			      ) ;
		SET _asunto = REPLACE(_asunto,"{asunto}","El Monitor Técnico del Proyecto {proyecto} - {inst} , ha aprobado el ");
		SET _asunto = REPLACE(_asunto,"{proyecto}", NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","Ejecutores - {inst}, 
					Se ha dado el visto bueno al");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
	
    END IF; 	 
	
	SET _msg = REPLACE(_msg,"{anio}",NEW.t25_anio);
	SET _msg = REPLACE(_msg,"{trim}",NEW.t25_trim);
	SET _msg = REPLACE(_msg,"{ref}",NEW.t25_periodo);
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
	SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	
	
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t25_inf_trim_anx`
--

DROP TABLE IF EXISTS `t25_inf_trim_anx`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_trim_anx` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t25_anio` int(11) NOT NULL,
  `t25_trim` int(11) NOT NULL,
  `t25_ver_inf` int(11) NOT NULL COMMENT 'Version del Informe',
  `t25_cod_anx` int(11) NOT NULL,
  `t25_nom_file` varchar(100) DEFAULT NULL COMMENT 'nombre del achivo',
  `t25_url_file` varchar(100) DEFAULT NULL COMMENT 'url del archivo',
  `t25_desc_file` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t25_anio`,`t25_trim`,`t25_ver_inf`,`t25_cod_anx`),
  KEY `fk_t20_inf_trim_anx` (`t02_cod_proy`,`t25_anio`,`t25_trim`,`t25_ver_inf`) USING BTREE,
  CONSTRAINT `t25_inf_trim_anx_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t25_anio`, `t25_trim`, `t25_ver_inf`) REFERENCES `t25_inf_trim` (`t02_cod_proy`, `t25_anio`, `t25_trim`, `t25_ver_inf`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Documentos Anexados al Informe Trimestral';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_trim_at`
--

DROP TABLE IF EXISTS `t25_inf_trim_at`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_trim_at` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_trim` int(11) NOT NULL COMMENT 'Triemestre',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Codigo del Beneficiario',
  `t15_avance` char(1) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT 'P:En Proceso, C: Capacitado, R: Retirado',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t25_anio`,`t25_trim`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_trim_capac`
--

DROP TABLE IF EXISTS `t25_inf_trim_capac`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_trim_capac` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL DEFAULT '0',
  `t12_cod_tema` int(11) NOT NULL COMMENT 'Codigo del Tema Especifico de Capacitación',
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_trim` int(11) NOT NULL COMMENT 'Triemestre',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Codigo del Beneficiario',
  `t15_avance` char(1) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT 'P:En Proceso, C: Capacitado, R: Retirado',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t12_cod_tema`,`t25_anio`,`t25_trim`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_trim_cred`
--

DROP TABLE IF EXISTS `t25_inf_trim_cred`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_trim_cred` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_trim` int(11) NOT NULL COMMENT 'Triemestre',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Codigo del Beneficiario',
  `t15_avance` double DEFAULT NULL COMMENT 'Monto de Credito',
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t25_anio`,`t25_trim`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t25_inf_trim_otros`
--

DROP TABLE IF EXISTS `t25_inf_trim_otros`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t25_inf_trim_otros` (
  `t02_cod_proy` varchar(10) CHARACTER SET utf8 NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t25_anio` int(11) NOT NULL COMMENT 'Año',
  `t25_trim` int(11) NOT NULL COMMENT 'Triemestre',
  `t11_cod_bene` int(11) NOT NULL COMMENT 'Codigo del Beneficiario',
  `t15_avance` char(1) COLLATE utf8_unicode_ci DEFAULT NULL,
  `t15_valor` varchar(30) COLLATE utf8_unicode_ci DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_crea` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `usr_actu` char(20) CHARACTER SET utf8 DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) CHARACTER SET utf8 DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t25_anio`,`t25_trim`,`t11_cod_bene`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t30_inf_se`
--

DROP TABLE IF EXISTS `t30_inf_se`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t30_inf_se` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t30_periodo` varchar(50) DEFAULT NULL,
  `t30_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Presentacion del Informe',
  `t30_estado` int(11) DEFAULT NULL COMMENT 'Proceso Cerrado',
  `t30_intro` text COMMENT 'Introduccion',
  `t30_fuentes` text COMMENT 'Metodos y fuentes',
  `t30_crit_eva1` int(11) DEFAULT NULL COMMENT 'Limitaciones',
  `t30_crit_eva2` int(11) DEFAULT NULL COMMENT 'Factores Positivos',
  `t30_crit_eva3` int(11) DEFAULT NULL COMMENT 'Perspectivas',
  `t30_crit_eva4` int(11) DEFAULT NULL,
  `t30_crit_eva5` int(11) DEFAULT NULL,
  `t30_crit_eva6` int(11) DEFAULT NULL,
  `t30_crit_eva7` int(11) DEFAULT NULL,
  `t30_apro` bit(1) DEFAULT NULL,
  `t30_apro_fch` datetime DEFAULT NULL COMMENT 'Fecha de Aprobacion',
  `t30_avance` text,
  `t30_logros` text,
  `t30_dificul` text,
  `t30_reco_proy` text,
  `t30_reco_fe` text,
  `t30_califica` text,
  `t30_fec_ini_vis` datetime DEFAULT NULL COMMENT 'Fecha de Inicio de la Visita',
  `t30_fec_ter_vis` datetime DEFAULT NULL COMMENT 'Fecha de Termino de la Visita',
  `t30_obs` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_anio`,`t02_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Informes de Supervisor Externo - Cabecera';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t30_inf_se_anexos`
--

DROP TABLE IF EXISTS `t30_inf_se_anexos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t30_inf_se_anexos` (
  `t30_cod_anx` int(11) NOT NULL,
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t30_nom_file` varchar(50) DEFAULT NULL COMMENT 'Fecha de Presentación del Informe',
  `t30_url_file` varchar(100) DEFAULT NULL,
  `t30_desc_file` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_anio`,`t02_entregable`,`t30_cod_anx`),
  CONSTRAINT `t30_inf_se_anexos_ibfk` FOREIGN KEY (`t02_cod_proy`, `t02_anio`, `t02_entregable`) REFERENCES `t30_inf_se` (`t02_cod_proy`, `t02_anio`, `t02_entregable`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Documentos Anexados al Informe de Supervisión Exter';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t31_plan_me`
--

DROP TABLE IF EXISTS `t31_plan_me`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t31_plan_me` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t31_id` int(11) NOT NULL,
  `t31_anio` int(11) DEFAULT NULL,
  `t31_mes` int(11) DEFAULT NULL,
  `t31_mto_v1` double DEFAULT NULL COMMENT 'Monto de Adelanto de la Visita',
  `t31_mto_v2` double DEFAULT NULL COMMENT 'Monto al Cuncluir la Visita',
  `t31_mto_tot` double DEFAULT NULL COMMENT 'Monto Total de la Visita',
  `t31_fec_vis` datetime DEFAULT NULL COMMENT 'Fecha de la Visita',
  `t31_fec_ter` datetime DEFAULT NULL,
  `t31_vb_v1` char(1) DEFAULT NULL COMMENT 'Aprobacion de la Fecha de la Visita',
  `t31_vb_v2` char(1) DEFAULT NULL COMMENT 'Aprobacion para Segundo Pago',
  `t31_des_v1` double DEFAULT NULL COMMENT 'Monto desembolsado Visita 1',
  `t31_des_v2` double DEFAULT NULL COMMENT 'Monto desembolsado Visita 2',
  `t31_des_tot` double DEFAULT NULL COMMENT 'Monto Total Desembolsado',
  `t31_obs` text COMMENT 'Observaciones o Comentarios sobre la futura visita',
  `t31_id_ejecutar` int(11) DEFAULT NULL COMMENT 'Numero de Visita que correponde ejecutar',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t31_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla con el Cronograma de Visitas de ME';
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_ins_visita` AFTER INSERT ON `t31_plan_me`
 FOR EACH ROW BEGIN
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    DECLARE _msg  TEXT DEFAULT "Señores de Fondoempleo,
				El Monitor Externo de la Institucion Ejecutora {inst} ha enviado la solicitud de visita N° {num} del proyecto {proyecto} correspondiente al Año {anio} - Mes {ref}.
                Se solicita el VoBo..
                - Sistema de Evaluacion y Monitoreo.";
	DECLARE _id	INT;
	DECLARE _inst	VARCHAR(200); 	
	DECLARE _mon_tec	VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
	DECLARE _institucion VARCHAR(50);  
	DECLARE _destino	 VARCHAR(200); 
	
    
	SELECT (SELECT i.t01_mail_inst 
				FROM t01_dir_inst i
				WHERE i.t01_id_inst=p.t01_id_inst )			
	INTO		_inst    
	FROM		t02_dg_proy p
	WHERE		t02_cod_proy=NEW.t02_cod_proy
		AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	SELECT	(SELECT e.t90_mail_equi 
				FROM t90_equi_fe e
				WHERE e.t90_id_equi = proy.t02_moni_tema ) 
	INTO		_mon_tec
	FROM		t02_dg_proy proy
	WHERE		proy.t02_cod_proy = NEW.t02_cod_proy
		AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
	SELECT	GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
	INTO	_cmt
	FROM	adm_usuarios
	WHERE	tipo_user = 4 AND estado = 1 AND mail != ''; 
	
	SELECT MAX(i.t01_sig_inst)
	INTO _institucion
	FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
	SET _destino =  CONCAT( 
			IFNULL(_mon_tec,''),  
			IFNULL(CONCAT(', ', _cmt ),'') 
				) ;			
	SET _asunto = REPLACE(_asunto,"{asunto}","El Monitor Externo del Proyecto {proyecto} - {inst} , está solicitando el v.b. de su  Cronograma de Visitas ");
	SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
	SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
	SET _msg = REPLACE(_msg,"{anio}",NEW.t31_anio);
	SET _msg = REPLACE(_msg,"{ref}",NEW.t31_mes);
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
	SET _msg = REPLACE(_msg,"{num}",NEW.t31_id);     
	SET _msg = REPLACE(_msg,"{inst}",_institucion);	
	SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes (id_men, asu_men, tex_men, ori_men, dest_men, fec_men, usu_men)
		VALUES (	_id, _asunto, _msg, _inst, _destino, NOW(), NEW.usr_actu );
	
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_apr_visita` AFTER UPDATE ON `t31_plan_me`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Se comunica que la Solicitud de Visita N°{num} del proyecto {proyecto} correspondiente al Año {anio} - Mes {ref}, cuenta con el VoBo.
                Favor de Verficarlo.
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst	VARCHAR(200); 
	DECLARE _mailproy	VARCHAR(200); 
	DECLARE _mailejec	VARCHAR(200); 	
    DECLARE _mon_tec	VARCHAR(200);
    DECLARE _mon_fin	VARCHAR(200);
	DECLARE _mon_ext	VARCHAR(200);
	DECLARE _cmt	VARCHAR(200);
    DECLARE _cmf	VARCHAR(200);
	DECLARE _amt	VARCHAR(200);
	DECLARE _administrador	VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino	 VARCHAR(200); 
   
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{anio}",NEW.t31_anio);
	SET _msg = REPLACE(_msg,"{ref}",NEW.t31_mes);
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
	SET _msg = REPLACE(_msg,"{num}",NEW.t31_id);  
     
    
    SELECT mail_admin
	INTO _sistem
	FROM adm_parametros
	WHERE  idparam = 1;
   
	
	SELECT p.t02_mail_proy 
	INTO _mailproy    
	FROM 	t02_dg_proy  p
	WHERE p.t02_cod_proy=NEW.t02_cod_proy
	AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT	(SELECT i.t01_mail_inst 
			FROM t01_dir_inst i
			WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	SELECT u.mail 
	INTO _mailejec    
	FROM 	adm_usuarios u
	INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
	INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy=NEW.t02_cod_proy
	AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
    SELECT	(SELECT e.t90_mail_equi 
			FROM t90_equi_fe e
			WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT	(SELECT f.t90_mail_equi 
			FROM t90_equi_fe f
			WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);     
	
	SELECT cto.t01_mail_cto 
	INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
	into _cmt
	FROM adm_usuarios
	WHERE tipo_user=4
	and estado=1
	and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
	into _cmf
	FROM adm_usuarios
	WHERE tipo_user=9
	and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
	into _administrador
	FROM adm_usuarios
	WHERE tipo_user=10
	and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
	into _amt
	FROM adm_usuarios
	WHERE tipo_user=5
	and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
    IF NEW.t31_vb_v1=1 THEN 
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _administrador ),''),  
				IFNULL(CONCAT(', ', _amt ),''), 
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _mon_ext ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha dado el v.b. a la Solicitud de Visita del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		
		SELECT	IFNULL(MAX(id_men),0)+1
		INTO	_id
		FROM	adm_mensajes ;
		INSERT INTO adm_mensajes 
		(	id_men, 
			asu_men, 
			tex_men, 
			ori_men, 
			dest_men, 
			fec_men, 
			usu_men
		)
		VALUES
		(	_id, 
			_asunto, 
			_msg, 
			_inst, 
			_destino, 
			NOW(), 
			NEW.usr_actu
		);
		
    END IF; 
	
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t31_plan_me_aprob`
--

DROP TABLE IF EXISTS `t31_plan_me_aprob`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t31_plan_me_aprob` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t31_id` int(11) NOT NULL,
  `t31_id_aprob` int(11) NOT NULL COMMENT 'Primera o Segunda Visita',
  `t31_mto_aprob` double DEFAULT NULL COMMENT 'Monto aprobado',
  `t31_fec_aprob` datetime DEFAULT NULL COMMENT 'Fecha de aprobacion',
  `t31_vb` char(1) DEFAULT NULL COMMENT 'Aprobacion',
  `t31_obs_aprob` text,
  `t31_tot_desemb` char(1) DEFAULT '0' COMMENT 'Totalmente desembolsado',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t31_id`,`t31_id_aprob`),
  CONSTRAINT `t31_plan_me_aprob_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t31_id`) REFERENCES `t31_plan_me` (`t02_cod_proy`, `t31_id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_ins_pago` AFTER INSERT ON `t31_plan_me_aprob`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                Puede acceder al control de Pago a Monitores Externos haciendo 
		<a href='http://localhost/sgp/sme/monitoreofe/adm/ctrl_pag_me.php'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
	DECLARE _evasis VARCHAR(50); 
    DECLARE _destino VARCHAR(200); 
   	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
 
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT GROUP_CONCAT(u.mail SEPARATOR ',')
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
         IF NEW.t31_id_aprob=1 THEN 
		SET _destino =  CONCAT( 
				IFNULL(_administrador,''),  
				IFNULL(CONCAT(', ', _mailejec ),''), 
				IFNULL(CONCAT(', ', _mailproy ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _mon_ext ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha autorizado el desembolso del Primer pago a Monitores Externos del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				se ha autorizado el desembolso del Primer Pago a Monitores Externos del Proyecto {proyecto} - {inst}, N° de Visita {num}. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);	
		SET _msg = REPLACE(_msg,"{num}",NEW.t31_id);		
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
END IF;
    
         IF NEW.t31_id_aprob=2 THEN 
		SET _destino =  CONCAT( 
				IFNULL(_administrador,''),  
				IFNULL(CONCAT(', ', _mailejec ),''), 
				IFNULL(CONCAT(', ', _mailproy ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _mon_ext ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha autorizado el desembolso del Segundo pago a Monitores Externos del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				se ha autorizado el desembolso del Segundo Pago a Monitores Externos del Proyecto {proyecto} - {inst}, N° de Visita {num}. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);	
		SET _msg = REPLACE(_msg,"{num}",NEW.t31_id);		
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
END IF;
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t32_plan_act`
--

DROP TABLE IF EXISTS `t32_plan_act`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t32_plan_act` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t32_id_vta` int(11) NOT NULL,
  `t32_id_act` int(11) NOT NULL COMMENT 'Fecha de la Visita',
  `t32_cod_act` int(11) DEFAULT NULL COMMENT 'Codigo del Tipo de Actividad corresponde al codi de ADM_TABLAS_AUX',
  `t32_fch_ini` date DEFAULT NULL COMMENT 'Personas a Entrevistar',
  `t32_fch_ter` date DEFAULT NULL COMMENT 'Recursos Necesarios',
  `t32_esp_act` text COMMENT 'Especificaciones de la actividad\n',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t32_id_vta`,`t32_id_act`),
  KEY `fk_t32_plan_act` (`t02_cod_proy`,`t32_id_vta`) USING BTREE,
  CONSTRAINT `t32_plan_act_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t32_id_vta`) REFERENCES `t32_plan_vta` (`t02_cod_proy`, `t32_id_vta`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla con el Plan de Visita Especifico';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t32_plan_vta`
--

DROP TABLE IF EXISTS `t32_plan_vta`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t32_plan_vta` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t32_id_vta` int(11) NOT NULL,
  `t32_fch_vta` date DEFAULT NULL COMMENT 'Fecha de la Visita',
  `t32_fch_ter` date DEFAULT NULL COMMENT 'Fecha de Termino de la Visita',
  `t32_obj_vta` text COMMENT 'Objetivo de la Visita',
  `t32_per_ent` text COMMENT 'Personas a Entrevistar',
  `t32_rec_nec` text COMMENT 'Recursos Necesarios',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t32_id_vta`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla con el Plan de Visita Especifico';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t40_inf_financ`
--

DROP TABLE IF EXISTS `t40_inf_financ`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t40_inf_financ` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t40_anio` int(11) NOT NULL,
  `t40_mes` int(11) NOT NULL,
  `t40_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Prswentacion del Informe',
  `t40_periodo` int(11) DEFAULT NULL COMMENT 'Numero de Mes calendario',
  `t40_est_eje` int(11) DEFAULT NULL COMMENT 'Estado del Informe por el ejecutor',
  `t40_est_mon` int(11) DEFAULT NULL COMMENT 'Estado del Informe por el Monitor',
  `t40_apro_fch` datetime DEFAULT NULL COMMENT 'Fecha de Aprobacion por el Monitor',
  `t40_obs` text,
  `t40_obs_moni` text,
  `t40_otro_ing` double DEFAULT NULL COMMENT 'Otros Ingresos',
  `t40_abo_bco` double DEFAULT NULL COMMENT 'Abonos del Banco',
  `t40_otro_ing_obs` text COMMENT 'Observacion del Monitor otros Ingresos',
  `t40_abo_bco_obs` text COMMENT 'Observacion del Monitor Abonos del banco',
  `t40_cor_ctb` datetime DEFAULT NULL COMMENT 'Fecha de Corte Contable AL',
  `t40_caja` double DEFAULT NULL COMMENT 'Caja Chica',
  `t40_bco_mn` double DEFAULT NULL COMMENT 'Banco moneda nacional',
  `t40_ent_rend` double DEFAULT NULL COMMENT 'Entregas a Rendir',
  `t40_cxc` double DEFAULT NULL COMMENT 'Cuentas x Cobrar',
  `t40_cxp` double DEFAULT NULL COMMENT 'Cuentas x Pagar',
  `t40_exc` double DEFAULT NULL COMMENT 'Excedentes por ejecutar',
  `t40_caja_obs` text,
  `t40_bco_mn_obs` text,
  `t40_ent_rend_obs` text,
  `t40_cxc_obs` text,
  `t40_cxp_obs` text,
  `t40_obs_exc` text COMMENT 'Observaciones del Monitor al Excende a ejecutar',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `inf_fi_ter` tinyint(4) DEFAULT NULL,
  `vb_se` tinyint(1) NOT NULL DEFAULT '0',
  PRIMARY KEY (`t02_cod_proy`,`t40_anio`,`t40_mes`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Informes Financiero - Cabecera';
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_upd_inf_financ` AFTER UPDATE ON `t40_inf_financ`
 FOR EACH ROW BEGIN
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} del proyecto {proyecto} correspondiente al Año {anio} - Mes ({ref} ).
                Favor de Verficarlo.
                           
                Puede acceder al informe financiero haciendo  
		<a href='http://localhost/sgp/sme/proyectos/informes/inf_financ_list.php?txtCodProy={proyecto}'>click Aqui</a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT;
    DECLARE _inst	VARCHAR(200); 
	DECLARE _mailproy	VARCHAR(200); 
	DECLARE _mailejec	VARCHAR(200); 	
    DECLARE _mon_tec	VARCHAR(200);
    DECLARE _mon_fin	VARCHAR(200);
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino	 VARCHAR(200); 
    DECLARE _est_rev 	INT DEFAULT 46;
    DECLARE _est_corr 	INT DEFAULT 47;
	DECLARE _est_vbmonitor 	INT DEFAULT 135;
	
	SET _msg = REPLACE(_msg,"{anio}",NEW.t40_anio);
	SET _msg = REPLACE(_msg,"{ref}",NEW.t40_mes);
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT GROUP_CONCAT((SELECT i.t01_mail_inst 
						FROM t01_dir_inst i 
						WHERE i.t01_id_inst=p.t01_id_inst) SEPARATOR ',')
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	SELECT GROUP_CONCAT(u.mail SEPARATOR ',')
    INTO _mailejec    
    FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	
    SELECT GROUP_CONCAT((SELECT e.t90_mail_equi 
						FROM t90_equi_fe e
						WHERE e.t90_id_equi=proy.t02_moni_tema) SEPARATOR ',')
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT GROUP_CONCAT((SELECT f.t90_mail_equi 
						FROM t90_equi_fe f
						WHERE f.t90_id_equi=proy.t02_moni_fina) SEPARATOR ',')
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);     
	
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
   IF NEW.t40_est_eje=_est_rev THEN 
SELECT _mon_fin  INTO _destino ; 		
		 SET _asunto = REPLACE(_asunto,"{asunto}","El Proyecto {proyecto} - {inst} , ha enviado a revisión su  informe financiero. ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		 SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
			--	La Institucion Ejecutora {inst} ha elaborado y enviado a revisión el informe financiero ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
   END IF; 
	
	
    
    IF NEW.t40_est_eje=_est_corr THEN 	
	SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _inst ),''),  
				IFNULL(CONCAT(', ', _mailejec ),'') 
			      ) ;
		SET _asunto = REPLACE(_asunto,"{asunto}","El informe financiero del Proyecto {proyecto} - {inst} , ha sido enviado a corrección ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","Ejecutores - {inst},
				Fondoempleo ha enviado a corrección el informe financiero ");
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
    END IF; 
	
	
    IF NEW.t40_est_eje=_est_vbmonitor  THEN 	
	SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _inst ),''),  
				IFNULL(CONCAT(', ', _mailejec ),'') 
			      ) ;
		SET _asunto = REPLACE(_asunto,"{asunto}","El informe financiero del Proyecto {proyecto} - {inst} , tiene el vb del monitor financiero ");
		SET _asunto = REPLACE(_asunto,"{proyecto}", NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo - {inst},
				El monitor financiero ha dado el visto bueno al informe financiero ");
		SET _msg = REPLACE(_msg,"{inst}",_institucion);	
    END IF; 
	
	
	SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t40_inf_financ_anx`
--

DROP TABLE IF EXISTS `t40_inf_financ_anx`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t40_inf_financ_anx` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t40_anio` int(11) NOT NULL,
  `t40_mes` int(11) NOT NULL,
  `t40_cod_anx` int(11) NOT NULL,
  `t40_nom_file` varchar(50) DEFAULT NULL COMMENT 'Nombre del archivo anexado',
  `t40_url_file` varchar(100) DEFAULT NULL,
  `t40_desc_file` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t40_anio`,`t40_mes`,`t40_cod_anx`),
  CONSTRAINT `t40_inf_financ_anx_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t40_anio`, `t40_mes`) REFERENCES `t40_inf_financ` (`t02_cod_proy`, `t40_anio`, `t40_mes`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Documentos Anexados al Informe Financiero';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t41_inf_financ_gasto`
--

DROP TABLE IF EXISTS `t41_inf_financ_gasto`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t41_inf_financ_gasto` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t40_anio` int(11) NOT NULL,
  `t40_mes` int(11) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t41_cate_gasto` int(11) NOT NULL DEFAULT '0' COMMENT 'Categoría de Gasto o Costo es tomada de Tabla Auxiliar',
  `t41_fte_finan` int(11) NOT NULL COMMENT 'Fuente de Financiamiento',
  `t41_gasto` double DEFAULT NULL COMMENT 'Gasto reportado',
  `t41_estado` int(11) DEFAULT '1' COMMENT 'registra si el gasto ha sido observado 1,2',
  `t41_obs` varchar(250) DEFAULT NULL COMMENT 'Observado por el Monitor',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t40_anio`,`t40_mes`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t41_cate_gasto`,`t41_fte_finan`),
  KEY `fk_t41_inf_financ_gasto` (`t02_cod_proy`,`t40_anio`,`t40_mes`) USING BTREE,
  CONSTRAINT `t41_inf_financ_gasto_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t40_anio`, `t40_mes`) REFERENCES `t40_inf_financ` (`t02_cod_proy`, `t40_anio`, `t40_mes`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t42_inf_financ_gasto_det`
--

DROP TABLE IF EXISTS `t42_inf_financ_gasto_det`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t42_inf_financ_gasto_det` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t40_anio` int(11) NOT NULL,
  `t40_mes` int(11) NOT NULL,
  `t02_version` int(11) NOT NULL,
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t41_cate_gasto` int(11) NOT NULL DEFAULT '0' COMMENT 'Categoría de Gasto o Costo es tomada de Tabla Auxiliar',
  `t41_fte_finan` int(11) NOT NULL COMMENT 'Fuente de Financiamiento',
  `t42_cod_gasto` int(11) NOT NULL,
  `t42_gasto` double DEFAULT NULL COMMENT 'Gasto reportado',
  `t42_obs` varchar(250) DEFAULT NULL COMMENT 'Observado por el Monitor',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t40_anio`,`t40_mes`,`t02_version`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t41_cate_gasto`,`t41_fte_finan`,`t42_cod_gasto`),
  KEY `fk_t41_inf_financ_gasto` (`t02_cod_proy`,`t40_anio`,`t40_mes`) USING BTREE,
  CONSTRAINT `t42_inf_financ_gasto_det_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t40_anio`, `t40_mes`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_sub`, `t41_cate_gasto`, `t41_fte_finan`) REFERENCES `t41_inf_financ_gasto` (`t02_cod_proy`, `t40_anio`, `t40_mes`, `t02_version`, `t08_cod_comp`, `t09_cod_act`, `t09_cod_sub`, `t41_cate_gasto`, `t41_fte_finan`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t45_inf_si`
--

DROP TABLE IF EXISTS `t45_inf_si`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t45_inf_si` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t45_periodo` varchar(50) DEFAULT NULL,
  `t45_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Presentacion del Informe',
  `t45_estado` int(11) DEFAULT NULL COMMENT 'Proceso Cerrado',
  `t45_intro` text COMMENT 'Introduccion',
  `t45_fuentes` text COMMENT 'Metodos y fuentes',
  `t45_crit_eva1` int(11) DEFAULT NULL COMMENT 'Limitaciones',
  `t45_crit_eva2` int(11) DEFAULT NULL COMMENT 'Factores Positivos',
  `t45_crit_eva3` int(11) DEFAULT NULL COMMENT 'Perspectivas',
  `t45_crit_eva4` int(11) DEFAULT NULL,
  `t45_crit_eva5` int(11) DEFAULT NULL,
  `t45_crit_eva6` int(11) DEFAULT NULL,
  `t45_crit_eva7` int(11) DEFAULT NULL,
  `t45_apro` bit(1) DEFAULT NULL,
  `t45_apro_fch` datetime DEFAULT NULL COMMENT 'Fecha de Aprobacion',
  `t45_avance` text,
  `t45_logros` text,
  `t45_dificul` text,
  `t45_reco_proy` text,
  `t45_reco_fe` text,
  `t45_califica` text,
  `t45_fec_ini_vis` datetime DEFAULT NULL COMMENT 'Fecha de Inicio de la Visita',
  `t45_fec_ter_vis` datetime DEFAULT NULL COMMENT 'Fecha de Termino de la Visita',
  `t45_obs` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_anio`,`t02_entregable`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Informes de Supervisor Interno - Cabecera';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t45_inf_si_anexos`
--

DROP TABLE IF EXISTS `t45_inf_si_anexos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t45_inf_si_anexos` (
  `t45_cod_anx` int(11) NOT NULL,
  `t02_cod_proy` varchar(10) NOT NULL,
  `t02_anio` int(11) NOT NULL DEFAULT '0' COMMENT 'Año de Ejecución',
  `t02_entregable` int(11) NOT NULL COMMENT 'Entregable asociado',
  `t45_nom_file` varchar(50) DEFAULT NULL COMMENT 'Fecha de Presentación del Informe',
  `t45_url_file` varchar(100) DEFAULT NULL,
  `t45_desc_file` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t02_anio`,`t02_entregable`,`t45_cod_anx`),
  CONSTRAINT `t45_inf_si_anexos_ibfk` FOREIGN KEY (`t02_cod_proy`, `t02_anio`, `t02_entregable`) REFERENCES `t45_inf_si` (`t02_cod_proy`, `t02_anio`, `t02_entregable`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Documentos Anexados al Informe de Supervisión Inter';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t46_cron_visita_mi`
--

DROP TABLE IF EXISTS `t46_cron_visita_mi`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t46_cron_visita_mi` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t46_id` int(11) NOT NULL,
  `t46_anio` int(11) NOT NULL COMMENT 'Año',
  `t46_mes` int(11) DEFAULT NULL COMMENT 'Mes',
  `t46_obs` text COMMENT 'Comentarios sobre la visita',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t46_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t50_equiv_codis`
--

DROP TABLE IF EXISTS `t50_equiv_codis`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t50_equiv_codis` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t50_cod_sis` varchar(18) NOT NULL COMMENT 'Codigo del gasto en el sistema',
  `t50_cod_ext` varchar(18) NOT NULL COMMENT 'Codigo del gasto para el ejecutor',
  `t50_des_ext` varchar(180) NOT NULL COMMENT 'Descripcion del Gasto para el ejecutro',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t50_cod_sis`,`t50_cod_ext`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t50_plan_moni_ext`
--

DROP TABLE IF EXISTS `t50_plan_moni_ext`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t50_plan_moni_ext` (
  `t50_id_plan` int(11) NOT NULL,
  `t02_cod_proy` varchar(10) DEFAULT NULL,
  `t50_ini` date DEFAULT NULL,
  `t50_ter` date DEFAULT NULL,
  `t50_obj` varchar(250) DEFAULT NULL,
  `t50_plan` text,
  `t50_per_ent` varchar(45) DEFAULT NULL,
  `t50_recur_sos` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t50_id_plan`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t51_inf_mf`
--

DROP TABLE IF EXISTS `t51_inf_mf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t51_inf_mf` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t51_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t51_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Prsentacion del Informe',
  `t51_per_ini` int(11) DEFAULT NULL,
  `t51_per_fin` int(11) DEFAULT NULL,
  `t51_periodo` varchar(50) DEFAULT NULL COMMENT 'Periodo de Referencia',
  `t51_estado` int(11) DEFAULT NULL COMMENT 'Estado del Informe',
  `t51_obs` text COMMENT 'Observaciones en el Periodo',
  `t51_conclu` text COMMENT 'Conclusiones',
  `t51_califica` int(11) DEFAULT NULL COMMENT 'Calificacion',
  `t51_cor_ctb` datetime DEFAULT NULL COMMENT 'Fecha de Corte Contable AL',
  `t51_caja` double DEFAULT NULL COMMENT 'Caja Chica',
  `t51_bco_mn` double DEFAULT NULL COMMENT 'Banco moneda nacional',
  `t51_ent_rend` double DEFAULT NULL COMMENT 'Entregas a Rendir',
  `t51_cxc` double DEFAULT NULL COMMENT 'Cuentas x Cobrar',
  `t51_cxp` double DEFAULT NULL COMMENT 'Cuentas x Pagar',
  `t51_exc` double DEFAULT NULL COMMENT 'Excedentes por ejecutar',
  `t51_caja_obs` text,
  `t51_bco_mn_obs` text,
  `t51_ent_rend_obs` text,
  `t51_cxc_obs` text,
  `t51_cxp_obs` text,
  `t51_obs_exc` text COMMENT 'Observaciones del Monitor al Excende a ejecutar',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t51_obs_cmt` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t51_num`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_upd_inf_mf` AFTER UPDATE ON `t51_inf_mf`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} del proyecto {proyecto} correspondiente al  Periodo de Referencia ({ref}).
                Favor de Verficarlo.
                           
                Puede acceder al informe haciendo 
		<a href='http://localhost/sgp/sme/monitoreofe/informes/inf_financ_list.php?txtCodProy={proyecto}'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200); 
	DECLARE _est_rev 	INT DEFAULT 247;
    DECLARE _est_corr 	INT DEFAULT 248;
    DECLARE _est_aprob 	INT DEFAULT 249;
   
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{ref}",NEW.t51_periodo);
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT GROUP_CONCAT(u.mail SEPARATOR ',')
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
    IF NEW.t51_estado=_est_rev THEN 
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Monitor financiero ha enviado a revisión el Informe de Evaluación Financiera de Fondoempleo del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Monitor Financiero ha enviado a revisión el Informe de Evaluación Financiera de Fondoempleo N° {num} ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t51_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 

    IF NEW.t51_estado=_est_corr THEN 
		SELECT _mon_fin INTO _destino ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Financiero ha enviado a corrección el Informe de Evaluación Financiera de Fondoempleo del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Financiero ha enviado a corrección el Informe de Evaluación Financiera de Fondoempleo N° {num} ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t51_num);
    
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 
	
    IF NEW.t51_estado=_est_aprob THEN 
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Financiero ha aprobado el Informe de Evaluación Financiera de Fondoempleo del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Financiero ha aprobado el Informe de Visita de Monitoreo de Evaluación Financiera de Fondoempleo N° {num}  ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{num}",NEW.t51_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t51_inf_mf_anexos`
--

DROP TABLE IF EXISTS `t51_inf_mf_anexos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t51_inf_mf_anexos` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Codigo del Proyecto',
  `t51_id` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t51_cod_anx` int(11) NOT NULL COMMENT 'Codigo del Anexo',
  `t51_nom_file` varchar(50) DEFAULT NULL COMMENT 'Nombre del Archivo',
  `t51_url_file` varchar(100) DEFAULT NULL COMMENT 'Url del Anexo',
  `t51_desc_file` varchar(250) DEFAULT NULL COMMENT 'Breve descripcion acerca del contenido del Anexo',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t51_id`,`t51_cod_anx`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t51_inf_mf_avance_meta`
--

DROP TABLE IF EXISTS `t51_inf_mf_avance_meta`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t51_inf_mf_avance_meta` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t51_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t51_obs` varchar(250) DEFAULT '' COMMENT 'Observado por el Monitor',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t51_num`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`),
  CONSTRAINT `t51_inf_mf_avance_meta_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t51_num`) REFERENCES `t51_inf_mf` (`t02_cod_proy`, `t51_num`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t51_inf_mf_avance_monto`
--

DROP TABLE IF EXISTS `t51_inf_mf_avance_monto`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t51_inf_mf_avance_monto` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t51_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t51_fuente` int(11) NOT NULL,
  `t51_obs` varchar(250) DEFAULT '' COMMENT 'Observado por el Monitor',
  `t51_no_gasto` double DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t51_num`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t51_fuente`),
  CONSTRAINT `t51_inf_mf_avance_monto_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t51_num`) REFERENCES `t51_inf_mf` (`t02_cod_proy`, `t51_num`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t51_inf_mf_docs`
--

DROP TABLE IF EXISTS `t51_inf_mf_docs`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t51_inf_mf_docs` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t51_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t51_tipdoc` int(11) NOT NULL COMMENT 'Tipo de Documento Presentado',
  `t51_estdoc` int(11) NOT NULL COMMENT 'Estado presentacion de Documento',
  `t51_estobs` text COMMENT 'Observaciones en el Periodo',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t51_num`,`t51_tipdoc`),
  CONSTRAINT `t51_inf_mf_docs_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t51_num`) REFERENCES `t51_inf_mf` (`t02_cod_proy`, `t51_num`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t51_inf_mf_gastos_no_aceptados`
--

DROP TABLE IF EXISTS `t51_inf_mf_gastos_no_aceptados`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t51_inf_mf_gastos_no_aceptados` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t51_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t08_cod_comp` int(11) NOT NULL,
  `t09_cod_act` int(11) NOT NULL,
  `t09_cod_sub` int(11) NOT NULL,
  `t09_anio` int(11) NOT NULL,
  `t09_mes` int(11) NOT NULL,
  `t51_fuente` int(11) NOT NULL,
  `t09_mto_no_acept` double DEFAULT NULL COMMENT 'Gasto No Aceptado por el Monitor Financiero',
  `t51_obs` varchar(250) DEFAULT '' COMMENT 'Observado por el Monitor',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t09_cod_sub_cat` int(11) NOT NULL DEFAULT '0',
  PRIMARY KEY (`t02_cod_proy`,`t51_num`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t09_anio`,`t09_mes`,`t51_fuente`,`t09_cod_sub_cat`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t51_inf_mf_observa`
--

DROP TABLE IF EXISTS `t51_inf_mf_observa`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t51_inf_mf_observa` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t51_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t51_obs_id` int(11) NOT NULL,
  `t51_fecha` datetime NOT NULL,
  `t51_obs_moni` text,
  `t51_obs_eje` text COMMENT 'Observaciones en el Periodo',
  `t51_ok_moni` char(1) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t51_num`,`t51_obs_id`),
  CONSTRAINT `t51_inf_mf_observa_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t51_num`) REFERENCES `t51_inf_mf` (`t02_cod_proy`, `t51_num`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t52_inf_visita_mf`
--

DROP TABLE IF EXISTS `t52_inf_visita_mf`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t52_inf_visita_mf` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t52_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t52_tipo_vis` int(11) DEFAULT NULL COMMENT 'Tipo de Visita',
  `t52_per_ini` int(11) DEFAULT NULL COMMENT 'Periodo Inicial',
  `t52_per_fin` int(11) DEFAULT NULL COMMENT 'Periodo Final',
  `t52_nom_per_ent` varchar(50) DEFAULT NULL COMMENT 'Nombre de la persona entrevistada',
  `t52_car_per_ent` varchar(30) DEFAULT NULL COMMENT 'Cargo de la Persona entrevistada',
  `t52_quest_01` char(1) DEFAULT NULL,
  `t52_obs_01` text,
  `t52_quest_02` char(1) DEFAULT NULL,
  `t52_obs_02` text,
  `t52_quest_03` char(1) DEFAULT NULL,
  `t52_obs_03` text,
  `t52_quest_04` char(1) DEFAULT NULL,
  `t52_obs_04` text,
  `t52_quest_05` char(1) DEFAULT NULL,
  `t52_obs_05` text,
  `t52_quest_06` char(1) DEFAULT NULL,
  `t52_obs_06` text,
  `t52_quest_07` char(1) DEFAULT NULL,
  `t52_obs_07` text,
  `t52_quest_08` char(1) DEFAULT NULL,
  `t52_obs_08` text,
  `t52_quest_09` char(1) DEFAULT NULL,
  `t52_obs_09` text,
  `t52_quest_10` char(1) DEFAULT NULL,
  `t52_obs_10` text,
  `t52_quest_11` char(1) DEFAULT NULL,
  `t52_obs_11` text,
  `t52_quest_12` char(1) DEFAULT NULL,
  `t52_obs_12` text,
  `t52_quest_13` char(1) DEFAULT NULL,
  `t52_obs_13` text,
  `t52_quest_14` char(1) DEFAULT NULL,
  `t52_obs_14` text,
  `t52_quest_15` char(1) DEFAULT NULL,
  `t52_obs_15` text,
  `t52_quest_16` char(1) DEFAULT NULL,
  `t52_obs_16` text,
  `t52_quest_17` char(1) DEFAULT NULL,
  `t52_obs_17` text,
  `t52_quest_18` char(1) DEFAULT NULL,
  `t52_obs_18` text,
  `t52_quest_19` char(1) DEFAULT NULL,
  `t52_obs_19` text,
  `t52_quest_20` char(1) DEFAULT NULL,
  `t52_obs_20` text,
  `t52_quest_21` char(1) DEFAULT NULL,
  `t52_obs_21` text,
  `t52_quest_22` char(1) DEFAULT NULL,
  `t52_obs_22` text,
  `t52_quest_23` char(1) DEFAULT NULL,
  `t52_obs_23` text,
  `t52_periodo` varchar(50) DEFAULT NULL,
  `t52_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Presentacion del Informe',
  `t52_estado` int(11) DEFAULT NULL COMMENT 'Estado del Informe',
  `t52_obs` text COMMENT 'Observaciones en el Periodo',
  `t52_conclu` text COMMENT 'Conclusiones',
  `t52_califica` int(11) DEFAULT NULL COMMENT 'Calificacion',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  `t52_obs_cmt` varchar(200) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t52_num`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_upd_visita_mf` AFTER UPDATE ON `t52_inf_visita_mf`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} {proyecto}.
                Favor de Verficarlo.
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200); 
	DECLARE _est_rev 	INT DEFAULT 247;
    DECLARE _est_corr 	INT DEFAULT 248;
    DECLARE _est_aprob 	INT DEFAULT 249;
   
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT u.mail 
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
    IF NEW.t52_estado=_est_rev AND NEW.t52_tipo_vis=1 THEN 
		SET _destino =  CONCAT( 
				IFNULL(_cmt,''),  
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Monitor financiero ha enviado a revisión el Informe de Visita de Supervisión Previa al Inicio del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Monitor Financiero ha enviado a revisión el Informe de Visita Nro. {nro_vis} de Supervisión Previa al Inicio del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{nro_vis}",NEW.t52_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 

    IF NEW.t52_estado=_est_corr  AND NEW.t52_tipo_vis=1 THEN 
		SELECT _mon_fin INTO _destino ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Financiero ha enviado a corrección el Informe de Visita de Supervisión Previa al Inicio del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Financiero ha enviado a observado el Informe de Visita Nro. {nro_vis} de Supervisión Previa al Inicio del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{nro_vis}",NEW.t52_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 
	
    IF NEW.t52_estado=_est_aprob  AND NEW.t52_tipo_vis=1 THEN 
		SET _destino =  CONCAT( 
				IFNULL(_mailproy,''),  
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Financiero ha aprobado el Informe de Visita de Supervisión Previa al Inicio del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Financiero ha aprobado el Informe de Visita Nro. {nro_vis} de Supervisión Previa al Inicio del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{nro_vis}",NEW.t52_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 
	
	
	
	   
    IF NEW.t52_estado=_est_rev AND NEW.t52_tipo_vis=2 THEN 
		SET _destino =  CONCAT( 
				IFNULL(_cmt,''),  
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Monitor financiero ha enviado a revisión el Informe de Visita de Supervisión durante la Ejecución del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Monitor Financiero ha enviado a revisión el Informe de Visita Nro. {nro_vis} de Supervisión durante la ejecución del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{nro_vis}",NEW.t52_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 

    IF NEW.t52_estado=_est_corr  AND NEW.t52_tipo_vis=2 THEN 
		SELECT _mon_fin INTO _destino ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Financiero ha enviado a corrección el Informe de Visita de Supervisión durante la ejecución del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Financiero ha enviado a observado el Informe de Visita Nro. {nro_vis} de Supervisión durante la ejecución del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{nro_vis}",NEW.t52_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 
	
    IF NEW.t52_estado=_est_aprob  AND NEW.t52_tipo_vis=2 THEN 
		SET _destino =  CONCAT( 
				IFNULL(_cmt,''),  
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","El Coordinador de Monitoreo Financiero ha aprobado el Informe de Visita de Supervisión durante la ejecución del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);			
		SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
				el Coordinador de Monitoreo Financiero ha aprobado el Informe de Visita Nro. {nro_vis} de Supervisión durante la ejecución del Proyecto ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{nro_vis}",NEW.t52_num);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
	END IF; 
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t52_inf_visita_mf_anexos`
--

DROP TABLE IF EXISTS `t52_inf_visita_mf_anexos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t52_inf_visita_mf_anexos` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Codigo del Proyecto',
  `t52_id` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t52_cod_anx` int(11) NOT NULL COMMENT 'Codigo del Anexo',
  `t52_nom_file` varchar(50) DEFAULT NULL COMMENT 'Nombre del Archivo',
  `t52_url_file` varchar(100) DEFAULT NULL COMMENT 'Url del Anexo',
  `t52_desc_file` varchar(250) DEFAULT NULL COMMENT 'Breve descripcion acerca del contenido del Anexo',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t52_id`,`t52_cod_anx`),
  CONSTRAINT `t52_inf_visita_mf_anexos_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t52_id`) REFERENCES `t52_inf_visita_mf` (`t02_cod_proy`, `t52_num`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t55_inf_unico_anual`
--

DROP TABLE IF EXISTS `t55_inf_unico_anual`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t55_inf_unico_anual` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Código del Proyecto',
  `t55_id` int(11) NOT NULL COMMENT 'Código de informe',
  `t55_anio` int(11) NOT NULL COMMENT 'Añio del Informe',
  `t55_ver_inf` int(11) DEFAULT NULL COMMENT 'Version del Informe',
  `t55_per_ini` int(11) DEFAULT NULL COMMENT 'Mes de inicio 1',
  `t55_per_fin` int(11) DEFAULT NULL COMMENT 'Mes de termino 12',
  `t55_fch_pre` datetime DEFAULT NULL COMMENT 'Fecha de Presentacion del Informe',
  `t55_periodo` varchar(50) DEFAULT NULL COMMENT 'Mes de Referencia',
  `t55_estado` int(11) DEFAULT NULL COMMENT 'Estado del Informe',
  `t55_avan_comp` text COMMENT 'Analisis de Avance en relacion a componentes',
  `t55_avan_cap` text COMMENT 'Analisis de Avances en Capacitación, Asistecia Técnica y otros a beneficiarios',
  `t55_avan_fin` text COMMENT 'Análisis de Avance Financiero',
  `t55_eva1` int(11) DEFAULT NULL COMMENT 'Calificación 1',
  `t55_eva2` int(11) DEFAULT NULL COMMENT 'Calificación 2',
  `t55_eva3` int(11) DEFAULT NULL COMMENT 'Calificación 3',
  `t55_eva4` int(11) DEFAULT NULL COMMENT 'Calificación 4',
  `t55_eva5` int(11) DEFAULT NULL COMMENT 'Calificación 5',
  `t55_eva6` int(11) DEFAULT NULL COMMENT 'Calificación 6',
  `t55_eva7` int(11) DEFAULT NULL COMMENT 'Calificación 7',
  `t55_eva1_obs` text COMMENT 'Obsercación 1',
  `t55_eva2_obs` text COMMENT 'Obsercación 2',
  `t55_eva3_obs` text COMMENT 'Obsercación 3',
  `t55_eva4_obs` text COMMENT 'Obsercación 4',
  `t55_eva5_obs` text COMMENT 'Obsercación 5',
  `t55_eva6_obs` text COMMENT 'Obsercación 6',
  `t55_eva7_obs` text COMMENT 'Obsercación 7',
  `t55_logros` text COMMENT 'logros',
  `t55_dificultades` text COMMENT 'Dificultades',
  `t55_reco_proy` text COMMENT 'Recomendacion al proyecto',
  `t55_reco_fe` text COMMENT 'Recomendacion a fondoempleo',
  `t55_recomendaciones` text COMMENT 'Recomendaciones',
  `usr_crea` char(20) DEFAULT NULL COMMENT 'Usuario que crea el registro',
  `fch_crea` datetime DEFAULT NULL COMMENT 'Fecha de creación del registro',
  `usr_actu` char(20) DEFAULT NULL COMMENT 'Usuario que actualiza el registro',
  `fch_actu` datetime DEFAULT NULL COMMENT 'Fecha de actualización del registro',
  `est_audi` char(1) DEFAULT NULL COMMENT 'Estado del registro',
  `t55_mt` char(1) DEFAULT '0',
  `t55_mf` char(1) DEFAULT '0',
  `t55_cmt` int(1) DEFAULT NULL,
  `t55_cmf` int(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t55_id`,`t55_anio`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla de Informe Único Anual - Cabecera';
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_upd_inf_unico` AFTER UPDATE ON `t55_inf_unico_anual`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "Señores {cab} {proyecto}, Año {anio}.
                Favor de Verficarlo.
                           
                Puede acceder al informe haciendo 
		<a href='http://localhost/sgp/sme/monitoreofe/informes/inf_unico_anual_list.php?txtCodProy={proyecto}'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
    DECLARE _destino VARCHAR(200); 
	DECLARE _est_rev 	INT DEFAULT 46;
    DECLARE _est_corr 	INT DEFAULT 248;
    DECLARE _est_aprob 	INT DEFAULT 249;
	DECLARE _puntaje  INT; 
	DECLARE _result  VARCHAR(200) DEFAULT '';    
	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ;
   
	IF (NEW.t55_estado != OLD.t55_estado) THEN
		SELECT p.t02_moni_ext
		INTO _inst_me
		FROM  t02_dg_proy p 
		WHERE p.t02_cod_proy = NEW.t02_cod_proy
		AND p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
		SELECT  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
		SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
		SET _msg = REPLACE(_msg,"{anio}",NEW.t55_anio);
		
		
		SELECT mail_admin
		INTO _sistem
		FROM adm_parametros
		WHERE  idparam = 1;
	   
		
		SELECT	p.t02_mail_proy 
		INTO	_mailproy    
		FROM 	t02_dg_proy  p
		WHERE	p.t02_cod_proy=NEW.t02_cod_proy
			AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	   
		
		SELECT (SELECT i.t01_mail_inst 
		FROM t01_dir_inst i
		WHERE i.t01_id_inst=p.t01_id_inst )			
		INTO _inst    
		FROM t02_dg_proy p
		WHERE t02_cod_proy=NEW.t02_cod_proy
		AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
		
	
		SELECT u.mail 
		INTO _mailejec    
		FROM 	adm_usuarios u
		INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
		WHERE p.t02_cod_proy=NEW.t02_cod_proy
		AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
		
	
		SELECT(SELECT e.t90_mail_equi 
		FROM t90_equi_fe e
		WHERE e.t90_id_equi=proy.t02_moni_tema ) 
		INTO _mon_tec
		FROM t02_dg_proy proy
		WHERE proy.t02_cod_proy=NEW.t02_cod_proy
		AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
		
		
		SELECT(SELECT f.t90_mail_equi 
		FROM t90_equi_fe f
		WHERE f.t90_id_equi=proy.t02_moni_fina )  
		INTO _mon_fin
		FROM t02_dg_proy proy
		WHERE proy.t02_cod_proy=NEW.t02_cod_proy
		AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
		
	
		SELECT cto.t01_mail_cto 
		INTO _mon_ext
		FROM t01_inst_cto cto
		WHERE cto.t01_id_inst= _code_me
		AND cto.t01_id_cto=_code_inst; 
		
	   
		SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
			INTO _cmt
			FROM
			adm_usuarios
			WHERE tipo_user=4
			AND estado=1
			AND mail!=''; 
		
		SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
			INTO _cmf
			FROM
			adm_usuarios
			WHERE tipo_user=9
			AND estado=1
		AND mail!=''; 
		  
		SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
			INTO _administrador
			FROM
			adm_usuarios
			WHERE tipo_user=10
			AND estado=1
		AND mail!=''; 
		
		
		SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
			INTO _amt
			FROM
			adm_usuarios
			WHERE tipo_user=5
			AND estado=1
		AND mail!=''; 
		
		SELECT MAX(i.t01_sig_inst) INTO _institucion
		FROM t01_dir_inst i
		INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
		WHERE p.t02_cod_proy= NEW.t02_cod_proy;
	 
		
		
		IF (NEW.t55_mt = 1 AND NEW.t55_mf = 1 AND (OLD.t55_mt != 1 OR OLD.t55_mf != 1)) THEN
			SET _destino =  CONCAT( IFNULL(_cmt,''),  IFNULL(CONCAT(', ', _cmf ),''), IFNULL(CONCAT(', ', _amt ),'') );		
			SET _asunto = REPLACE(_asunto,"{asunto}","El Informe Único Anual del Proyecto {proyecto} - {inst} esta listo para Revisión");
			SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
					el Monitor Técnico y el Monitor Financiero han concluido el Informe Único Anual, del Proyecto ");	
			
		END IF;
		
		IF (NEW.t55_cmt = 1 AND NEW.t55_cmf = 1 AND (OLD.t55_cmt != 1 OR OLD.t55_cmf != 1)) THEN 
			SET _puntaje = fn_puntaje_califica_inf_unico_anual(NEW.t02_cod_proy, NEW.t55_id);
			IF _puntaje < 6 THEN SET _result="Desaprobado"; END IF;
			IF _puntaje >= 6 THEN SET _result="Aprobado con reservas"; END IF;
			IF _puntaje > 10 THEN SET _result="Aprobado"; END IF; 
		
			SET _destino =  CONCAT(IFNULL(_mon_tec,''), IFNULL(CONCAT(', ', _mon_fin ),''), IFNULL(CONCAT(', ', _amt ),''));
			SET _asunto = REPLACE(_asunto,"{asunto}","Se ha  {puntaje} el Informe Único Anual del Proyecto {proyecto} - {inst} ");
			SET _msg = REPLACE(_msg,"{cab}","de Fondoempleo,
					el Coordinador de Monitoreo Técnico y el Coordinador de Monitoreo Financiero han {puntaje} el Informe Único Anual, del Proyecto ");	
		END IF; 
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _asunto = REPLACE(_asunto,"{puntaje}",_result);
		SET _msg = REPLACE(_msg,"{inst}",_result);	
		SET _msg = REPLACE(_msg,"{puntaje}",_puntaje);	
		SELECT	IFNULL(MAX(id_men),0)+1 INTO _id FROM adm_mensajes ;
		INSERT INTO adm_mensajes ( id_men, asu_men, tex_men, ori_men, dest_men, fec_men, usu_men )
			VALUES (_id, _asunto, _msg, _inst, _destino, NOW(), NEW.usr_actu);
	END IF;
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t55_inf_unico_anual_avance_meta`
--

DROP TABLE IF EXISTS `t55_inf_unico_anual_avance_meta`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t55_inf_unico_anual_avance_meta` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Código del proyecto',
  `t55_num` int(11) NOT NULL COMMENT 'Número del Informe',
  `t08_cod_comp` int(11) NOT NULL COMMENT 'Código de componente',
  `t09_cod_act` int(11) NOT NULL COMMENT 'Código de actividad',
  `t09_cod_sub` int(11) NOT NULL COMMENT 'Código de subactividad',
  `t55_obs` varchar(250) DEFAULT '' COMMENT 'Observado por el Monitor',
  `usr_crea` char(20) DEFAULT NULL COMMENT 'Usuario que crea el registro',
  `fch_crea` datetime DEFAULT NULL COMMENT 'Fecha de creacion del registro',
  `usr_actu` char(20) DEFAULT NULL COMMENT 'Usuario que actualiza el registro',
  `fch_actu` datetime DEFAULT NULL COMMENT 'Fecha que actualiza el registro',
  `est_audi` char(1) DEFAULT NULL COMMENT 'Estado del registro',
  PRIMARY KEY (`t02_cod_proy`,`t55_num`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`),
  CONSTRAINT `t55_inf_unico_anual_avance_meta_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t55_num`) REFERENCES `t55_inf_unico_anual` (`t02_cod_proy`, `t55_id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t55_inf_unico_anual_avance_presup`
--

DROP TABLE IF EXISTS `t55_inf_unico_anual_avance_presup`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t55_inf_unico_anual_avance_presup` (
  `t02_cod_proy` varchar(10) NOT NULL COMMENT 'Código del proyecto',
  `t55_num` int(11) NOT NULL COMMENT 'Numero del Informe',
  `t08_cod_comp` int(11) NOT NULL COMMENT 'Código de componente',
  `t09_cod_act` int(11) NOT NULL COMMENT 'Código de actividad',
  `t09_cod_sub` int(11) NOT NULL COMMENT 'Código de subactividad',
  `t55_fuente` int(11) NOT NULL COMMENT 'Código de fuente de financiamiento',
  `t55_obs` varchar(250) DEFAULT '' COMMENT 'Observado por el Monitor',
  `usr_crea` char(20) DEFAULT NULL COMMENT 'Usuario que crea el registro',
  `fch_crea` datetime DEFAULT NULL COMMENT 'Fecha de creación del registro',
  `usr_actu` char(20) DEFAULT NULL COMMENT 'Usuario que actualiza el registro',
  `fch_actu` datetime DEFAULT NULL COMMENT 'Fecha de actualización del registro',
  `est_audi` char(1) DEFAULT NULL COMMENT 'Estado del registro',
  PRIMARY KEY (`t02_cod_proy`,`t55_num`,`t08_cod_comp`,`t09_cod_act`,`t09_cod_sub`,`t55_fuente`),
  CONSTRAINT `t55_inf_unico_anual_avance_presup_ibfk_1` FOREIGN KEY (`t02_cod_proy`, `t55_num`) REFERENCES `t55_inf_unico_anual` (`t02_cod_proy`, `t55_id`) ON DELETE CASCADE ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t59_aprob_primer_desemb`
--

DROP TABLE IF EXISTS `t59_aprob_primer_desemb`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t59_aprob_primer_desemb` (
  `t59_id_aprob` bigint(20) NOT NULL,
  `t02_cod_proy` varchar(10) DEFAULT NULL,
  `t59_car_fianza` char(1) NOT NULL COMMENT 'Tiene Carta Fianza',
  `t59_cons_aper_cta` char(1) DEFAULT NULL COMMENT 'Tiene Aperturada al Cuenta Bancaria',
  `t59_conv_firma` char(1) DEFAULT NULL COMMENT 'Tienes Convenio firmado',
  `t59_otros_docum` char(1) DEFAULT NULL COMMENT 'Tienes Otros Documentos',
  `t59_aprueba_mf` char(1) DEFAULT NULL,
  `t59_obs_aprob` text,
  `t59_mto_aprob` double DEFAULT NULL COMMENT 'Importe Aprobado',
  `t59_fch_aprob` date DEFAULT NULL COMMENT 'Fecha de Aprobacion',
  `t59_is_desemb` char(1) DEFAULT NULL,
  `t60_mto_desemb` double DEFAULT NULL COMMENT 'Monto Desembolsado',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t59_id_aprob`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `trg_ins_prim` AFTER INSERT ON `t59_aprob_primer_desemb`
 FOR EACH ROW BEGIN 
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
	DECLARE _evasis VARCHAR(50); 
    DECLARE _destino VARCHAR(200); 

	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT GROUP_CONCAT(u.mail SEPARATOR ',')
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
		SET _destino =  CONCAT( 
				IFNULL(_administrador,''),  
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha programado el Primer Desembolso del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				se ha programado el Primer Desembolso del Proyecto {proyecto}-{inst}. El monto programado a desembolsar es {monto}. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);			
		SET _msg = REPLACE(_msg,"{monto}",NEW.t59_mto_aprob);		
	
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t60_aprob_desemb_parcial`
--

DROP TABLE IF EXISTS `t60_aprob_desemb_parcial`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t60_aprob_desemb_parcial` (
  `t60_id_aprob` bigint(20) NOT NULL,
  `t60_nro_aprob` tinyint(4) NOT NULL,
  `t60_mto_par_aprob` double DEFAULT NULL,
  `t60_fch_aprob` date DEFAULT NULL,
  `t60_mto_par_desemb` double DEFAULT NULL,
  `t60_flg_desemb` char(1) DEFAULT '0',
  `t60_apro_mt` char(1) DEFAULT '0',
  `t60_obs_mt` varchar(256) DEFAULT NULL,
  `t60_fch_apro_mt` date DEFAULT NULL,
  `t60_apro_mf` char(1) DEFAULT '0',
  `t60_obs_mf` varchar(256) DEFAULT NULL,
  `t60_fch_apro_mf` date DEFAULT NULL,
  `t60_apro_cmt` char(1) DEFAULT '0',
  `t60_obs_cmt` varchar(256) DEFAULT NULL,
  `t60_fch_apro_cmt` date DEFAULT NULL,
  `t60_apro_cmf` char(1) DEFAULT '0',
  `t60_obs_cmf` varchar(256) DEFAULT NULL,
  `t60_fch_apro_cmf` date DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t60_id_aprob`,`t60_nro_aprob`),
  CONSTRAINT `fk_t60_aprobacion_desemb` FOREIGN KEY (`t60_id_aprob`) REFERENCES `t60_aprobacion_desemb` (`t60_id_aprob`) ON DELETE NO ACTION ON UPDATE NO ACTION
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t60_aprobacion_desemb`
--

DROP TABLE IF EXISTS `t60_aprobacion_desemb`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t60_aprobacion_desemb` (
  `t60_id_aprob` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'Codigo de la Aprobacion del Desembolso',
  `t02_cod_proy` varchar(10) DEFAULT NULL,
  `t60_anio` int(11) DEFAULT NULL COMMENT 'Año ',
  `t60_trim` int(11) DEFAULT NULL COMMENT 'Trimestre por Desembolsar',
  `t60_mto_plan` double DEFAULT NULL COMMENT 'Monto Planeado en Cronograma de Desembolsos',
  `t60_mto_aprob` double DEFAULT NULL COMMENT 'Monto a Desembolsar segun acuerdos',
  `t60_fch_aprob` date DEFAULT NULL,
  `t60_is_desemb` char(1) DEFAULT NULL COMMENT 'Si esta Totalmente Desembolsado',
  `t60_mto_desemb` double DEFAULT NULL COMMENT 'Monto Real Desembolsado',
  `t60_apro_mt` char(1) DEFAULT NULL,
  `t60_obs_mt` text COMMENT 'Observaciones del Monitor Tecnico',
  `t60_apro_mf` char(1) DEFAULT NULL,
  `t60_obs_mf` text COMMENT 'Observaciones del Monitor Financiero',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t60_id_aprob`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t60_desembolsos`
--

DROP TABLE IF EXISTS `t60_desembolsos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t60_desembolsos` (
  `t60_id_des` int(11) NOT NULL,
  `t02_cod_proy` varchar(10) DEFAULT NULL,
  `t60_fch_des` date DEFAULT NULL,
  `t60_mto_des` double DEFAULT NULL,
  `t60_obs` varchar(250) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t60_id_des`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t60_ejecucion_desemb`
--

DROP TABLE IF EXISTS `t60_ejecucion_desemb`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t60_ejecucion_desemb` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t60_id_trim` int(20) NOT NULL COMMENT 'Codigo de la aprobacion de Desembolso',
  `t60_id_desemb` bigint(20) NOT NULL COMMENT 'Id del Desembolso',
  `t60_tip_pago` int(11) DEFAULT NULL COMMENT 'Modalidad de Pago (Transferencia, Cheque, etc)',
  `t60_inst_ori` int(11) DEFAULT NULL,
  `t60_cta_ori` int(11) DEFAULT NULL COMMENT 'Cuenta Origen de la Institucion FE',
  `t01_id_inst` int(11) DEFAULT NULL COMMENT 'Codigo de la Institucion a Girar',
  `t01_id_cta` int(11) DEFAULT NULL COMMENT 'Codigo de la Cuenta de la Institucion',
  `t60_nom_benef` varchar(150) DEFAULT NULL COMMENT 'Nombre del Beneficiario a Girar',
  `t60_fch_giro` date DEFAULT NULL COMMENT 'Fecha de Giro',
  `t60_fch_depo` date DEFAULT NULL COMMENT 'Fecha de Deposito',
  `t60_mto_des` double DEFAULT NULL,
  `t60_nro_cheque` varchar(100) DEFAULT NULL,
  `t60_obs_tippago` text,
  `t60_id_aprob` bigint(20) DEFAULT NULL,
  `t60_nro_aprob` tinyint(4) DEFAULT NULL,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t60_id_trim`,`t60_id_desemb`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_insert_total_desembolso` AFTER INSERT ON `t60_ejecucion_desemb`
 FOR EACH ROW BEGIN
	DECLARE _total_desemb DOUBLE ;  
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                - Sistema de Evaluacion y Monitoreo.";
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
	DECLARE _evasis VARCHAR(50); 
    DECLARE _destino VARCHAR(200);
    DECLARE aAcumDesem DOUBLE;
   
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ;
	
	SELECT	p.t02_moni_ext
	INTO	_inst_me
	FROM 	t02_dg_proy p 
	WHERE	p.t02_cod_proy = NEW.t02_cod_proy
		AND p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
	
	SELECT  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
    SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;
	SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);
     

        
	SELECT	SUM(d.t60_mto_des)
	INTO	_total_desemb
	FROM	t60_ejecucion_desemb d
	WHERE	d.t02_cod_proy = NEW.t02_cod_proy
		AND d.t60_id_trim  = NEW.t60_id_trim ;
	IF NEW.t60_id_trim = 1 THEN
		UPDATE	t59_aprob_primer_desemb
		SET 	t60_mto_desemb = _total_desemb,
				t59_is_desemb = (CASE WHEN _total_desemb >= t59_mto_aprob THEN '1' ELSE '0' END)
		WHERE	t02_cod_proy = NEW.t02_cod_proy ;
	ELSE
		SELECT	IFNULL(t60_mto_par_desemb, 0)
		INTO	aAcumDesem
		FROM	t60_aprob_desemb_parcial
		WHERE	t60_id_aprob = NEW.t60_id_aprob
			AND	t60_nro_aprob = NEW.t60_nro_aprob;
			
		SET aAcumDesem = aAcumDesem + NEW.t60_mto_des;
		UPDATE	t60_aprob_desemb_parcial
		SET		t60_mto_par_desemb = aAcumDesem,
				t60_flg_desemb = (CASE WHEN aAcumDesem >= t60_mto_par_aprob THEN '1' ELSE '0' END)
		WHERE	t60_id_aprob	=	NEW.t60_id_aprob
			AND	t60_nro_aprob	=	NEW.t60_nro_aprob;
		
		UPDATE	t60_aprobacion_desemb
		SET		t60_mto_desemb = _total_desemb,
				t60_is_desemb = (CASE WHEN _total_desemb >= t60_mto_aprob THEN '1' ELSE '0' END)
		WHERE	t02_cod_proy = NEW.t02_cod_proy AND fn_numero_trim(t60_anio,t60_trim)=NEW.t60_id_trim;
	END IF ;
    
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT u.mail 
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		INTO _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		AND estado=1
		AND mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		INTO _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		AND estado=1
	AND mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		INTO _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		AND estado=1
	AND mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		INTO _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		AND estado=1
	AND mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
		SET _destino =  CONCAT( 
				IFNULL(_mailejec,''),  
				IFNULL(CONCAT(', ', _cmt ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha realizado el Desembolso del Proyecto {proyecto} - {inst} para el trimestre N°-{trim}");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
                                     SET _asunto = REPLACE(_asunto,"{trim}",NEW.t60_id_trim);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				se ha realizado el Desembolso N°-{num} del Proyecto {proyecto}-{inst} para el trimestre N°-{trim}. El monto desembolsado es {monto}. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);			
		SET _msg = REPLACE(_msg,"{monto}",NEW.t60_mto_des);		
	    SET _msg = REPLACE(_msg,"{trim}",NEW.t60_id_trim);
        SET _msg = REPLACE(_msg,"{num}",NEW.t60_id_desemb);
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
	
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_update_total_desembolso` AFTER UPDATE ON `t60_ejecucion_desemb`
 FOR EACH ROW BEGIN
	DECLARE _total_desemb DOUBLE ;
	DECLARE aAcumDesem DOUBLE;
       
	SELECT	SUM(d.t60_mto_des)
	INTO	_total_desemb
	FROM	t60_ejecucion_desemb d
	WHERE	d.t02_cod_proy = NEW.t02_cod_proy
		AND d.t60_id_trim  = NEW.t60_id_trim ;
	
	IF NEW.t60_id_trim = 1 THEN
	    UPDATE t59_aprob_primer_desemb
		SET t60_mto_desemb = _total_desemb,
		    t59_is_desemb = (CASE WHEN _total_desemb >=t59_mto_aprob THEN '1' ELSE '0' END)
	    WHERE t02_cod_proy = NEW.t02_cod_proy ;
	ELSE
		SELECT	t60_mto_par_desemb
		INTO	aAcumDesem
		FROM	t60_aprob_desemb_parcial
		WHERE	t60_id_aprob	=	NEW.t60_id_aprob
			AND	t60_nro_aprob	=	NEW.t60_nro_aprob;
			
		SET aAcumDesem = aAcumDesem - OLD.t60_mto_des + NEW.t60_mto_des;
		
		UPDATE	t60_aprob_desemb_parcial
		SET		t60_mto_par_desemb = aAcumDesem,
				t60_flg_desemb = (CASE WHEN aAcumDesem >= t60_mto_par_aprob THEN '1' ELSE '0' END)
		WHERE	t60_id_aprob	=	NEW.t60_id_aprob
			AND	t60_nro_aprob	=	NEW.t60_nro_aprob;
	    UPDATE	t60_aprobacion_desemb
		SET		t60_mto_desemb = _total_desemb,
				t60_is_desemb = (CASE WHEN _total_desemb >= t60_mto_aprob THEN '1' ELSE '0' END)
	    WHERE	t02_cod_proy = NEW.t02_cod_proy 
			AND fn_numero_trim(t60_anio,t60_trim) = NEW.t60_id_trim;
	END IF ;
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_delete_total_desembolso` BEFORE DELETE ON `t60_ejecucion_desemb`
 FOR EACH ROW BEGIN
	DECLARE _total_desemb DOUBLE ;
        
	SELECT	SUM(d.t60_mto_des)
	INTO	_total_desemb
	FROM	t60_ejecucion_desemb d
	WHERE	d.t02_cod_proy = OLD.t02_cod_proy
		AND d.t60_id_trim  = OLD.t60_id_trim ;
	
	IF OLD.t60_id_trim = 1 THEN
	    UPDATE t59_aprob_primer_desemb
		SET t60_mto_desemb = _total_desemb,
		    t59_is_desemb = (CASE WHEN _total_desemb >=t59_mto_aprob THEN '1' ELSE '0' END)
	      WHERE t02_cod_proy = OLD.t02_cod_proy ;
	ELSE
		UPDATE	t60_aprob_desemb_parcial
		SET		t60_mto_par_desemb = t60_mto_par_desemb - OLD.t60_mto_des,
				t60_flg_desemb = (CASE WHEN (t60_mto_par_desemb - OLD.t60_mto_des) > t60_mto_par_aprob THEN '1' ELSE '0' END)
		WHERE	t60_id_aprob	=	OLD.t60_id_aprob
			AND	t60_nro_aprob	=	OLD.t60_nro_aprob;
		
		
		SET _total_desemb = _total_desemb - OLD.t60_mto_des;
	    UPDATE	t60_aprobacion_desemb
		SET		t60_mto_desemb = _total_desemb,
				t60_is_desemb = (CASE WHEN _total_desemb >=t60_mto_aprob THEN '1' ELSE '0' END)
	    WHERE	t02_cod_proy = OLD.t02_cod_proy 
			AND fn_numero_trim(t60_anio,t60_trim) = OLD.t60_id_trim;
	END IF ;
	
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t60_ejecucion_desemb_me`
--

DROP TABLE IF EXISTS `t60_ejecucion_desemb_me`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t60_ejecucion_desemb_me` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t60_id_visita` int(20) NOT NULL COMMENT 'Codigo de la aprobacion de Desembolso',
  `t60_id_nropago` int(11) NOT NULL,
  `t60_id_desemb` bigint(20) NOT NULL COMMENT 'Id del Desembolso',
  `t60_tip_pago` int(11) DEFAULT NULL COMMENT 'Modalidad de Pago (Transferencia, Cheque, etc)',
  `t60_inst_ori` int(11) DEFAULT NULL,
  `t60_cta_ori` int(11) DEFAULT NULL COMMENT 'Cuenta Origen de la Institucion FE',
  `t01_id_inst` int(11) DEFAULT NULL COMMENT 'Codigo de la Institucion a Girar',
  `t01_id_cta` int(11) DEFAULT NULL COMMENT 'Codigo de la Cuenta de la Institucion',
  `t60_nom_benef` varchar(150) DEFAULT NULL COMMENT 'Nombre del Beneficiario a Girar',
  `t60_fch_giro` date DEFAULT NULL COMMENT 'Fecha de Giro',
  `t60_fch_depo` date DEFAULT NULL COMMENT 'Fecha de Deposito',
  `t60_mto_des` double DEFAULT NULL,
  `t60_nro_cheque` varchar(100) DEFAULT NULL,
  `t60_obs_tippago` text,
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t60_id_visita`,`t60_id_nropago`,`t60_id_desemb`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_insert_total_desembolso_me` AFTER INSERT ON `t60_ejecucion_desemb_me`
 FOR EACH ROW BEGIN
        DECLARE _total_desemb DOUBLE ;
        
      
    DECLARE _asunto  VARCHAR(200) DEFAULT "{asunto}";
    
    DECLARE _msg  TEXT DEFAULT "{cab}
                Favor de Verficarlo.
                           
                Puede acceder a la autorización de Giro de Cheques haciendo 
		<a href='http://localhost/sgp/sme/monitoreofe/adm/auto_giro_chk_me.php'>click Aqui </a>
                - Sistema de Evaluacion y Monitoreo.";
  
    DECLARE _id	INT; 
    DECLARE _inst VARCHAR(200); 
	DECLARE _mailproy VARCHAR(200); 
	DECLARE _mailejec VARCHAR(200); 	
	DECLARE _cmt VARCHAR(200);
    DECLARE _cmf VARCHAR(200);
    DECLARE _mon_tec VARCHAR(200);
    DECLARE _mon_fin VARCHAR(200);
	DECLARE _mon_ext VARCHAR(200);
	DECLARE _amt VARCHAR(200);
	DECLARE _administrador VARCHAR(200); 
    DECLARE _sistem	VARCHAR(200);    
    DECLARE _institucion VARCHAR(50);  
	DECLARE _evasis VARCHAR(50); 
    DECLARE _destino VARCHAR(200); 
   	
	DECLARE _inst_me VARCHAR(200) ;
	DECLARE _code_me INT ;
	DECLARE _code_inst INT ; 
	select p.t02_moni_ext
	into _inst_me
	FROM  t02_dg_proy p 
	WHERE p.t02_cod_proy = NEW.t02_cod_proy
	and p.t02_version=fn_ult_version_proy(NEW.t02_cod_proy);
                 select  SUBSTRING_INDEX( _inst_me , '.', 1 ) INTO _code_me;
                 SELECT  SUBSTRING_INDEX(SUBSTRING_INDEX( _inst_me , '.', 2 ),'.',-1) INTO _code_inst;

	SELECT SUM(d.t60_mto_des)
	  INTO _total_desemb
	  FROM t60_ejecucion_desemb_me d
	 WHERE d.t02_cod_proy = NEW.t02_cod_proy
	   AND d.t60_id_visita  = NEW.t60_id_visita
	   AND d.t60_id_nropago = NEW.t60_id_nropago ;
	
     UPDATE t31_plan_me_aprob
	SET t31_tot_desemb = (CASE WHEN _total_desemb >=t31_mto_aprob THEN '1' ELSE '0' END)
      WHERE t02_cod_proy = NEW.t02_cod_proy 
        AND t31_id       = NEW.t60_id_visita
        AND t31_id_aprob = NEW.t60_id_nropago ;
   
    SELECT mail_admin
	INTO _sistem
	FROM 
	adm_parametros
	WHERE  idparam = 1;
   
	
   SELECT p.t02_mail_proy 
   INTO _mailproy    
    FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
   
    
    SELECT(SELECT i.t01_mail_inst 
	FROM t01_dir_inst i
	WHERE i.t01_id_inst=p.t01_id_inst )			
    INTO _inst    
    FROM t02_dg_proy p
    WHERE t02_cod_proy=NEW.t02_cod_proy
    AND t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	
	 SELECT group_concat(u.mail separator ',') 
     INTO _mailejec    
     FROM 	adm_usuarios u
    INNER JOIN  t01_dir_inst i ON(u.t01_id_uni=i.t01_id_inst AND u.t02_cod_proy = NEW.t02_cod_proy)
		 INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=NEW.t02_cod_proy
    AND p.t02_version =fn_ult_version_proy(NEW.t02_cod_proy); 
	

    SELECT(SELECT e.t90_mail_equi 
	FROM t90_equi_fe e
	WHERE e.t90_id_equi=proy.t02_moni_tema ) 
    INTO _mon_tec
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy); 
	
    
	SELECT(SELECT f.t90_mail_equi 
	FROM t90_equi_fe f
	WHERE f.t90_id_equi=proy.t02_moni_fina )  
    INTO _mon_fin
    FROM t02_dg_proy proy
    WHERE proy.t02_cod_proy=NEW.t02_cod_proy
    AND proy.t02_version = fn_ult_version_proy(NEW.t02_cod_proy);    
	

   SELECT cto.t01_mail_cto 
 INTO _mon_ext
	FROM t01_inst_cto cto
	WHERE cto.t01_id_inst= _code_me
	AND cto.t01_id_cto=_code_inst; 
	
   
	
   
   
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmt
		FROM
		adm_usuarios
		WHERE tipo_user=4
		and estado=1
		and mail!=''; 
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _cmf
		FROM
		adm_usuarios
		WHERE tipo_user=9
		and estado=1
	and mail!=''; 
	  
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _administrador
		FROM
		adm_usuarios
		WHERE tipo_user=10
		and estado=1
	and mail!=''; 
	
    
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _amt
		FROM
		adm_usuarios
		WHERE tipo_user=5
		and estado=1
	and mail!=''; 
	
    SELECT MAX(i.t01_sig_inst) INTO _institucion
    FROM t01_dir_inst i
	INNER JOIN t02_dg_proy p ON ( p.t01_id_inst=i.t01_id_inst)
	WHERE p.t02_cod_proy= NEW.t02_cod_proy;
 
    
                                    IF NEW.t60_id_nropago=1 THEN
		SET _destino =  CONCAT( 
				IFNULL(_mailejec,''),  
				IFNULL(CONCAT(', ', _mailproy ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _mon_ext ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha realizado el desembolso del Primer Pago a Monitores Externos del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				se ha realizado el desembolso N°-{des} del Primer Pago a Monitores Externos del Proyecto {proyecto} - {inst}, N° de Visita {num}. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);	
		SET _msg = REPLACE(_msg,"{num}",NEW.t60_id_visita);		
		SET _msg = REPLACE(_msg,"{des}",NEW.t60_id_desemb);	
                          	
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
            END IF;
                                    IF NEW.t60_id_nropago=2 THEN
		SET _destino =  CONCAT( 
				IFNULL(_mailejec,''),  
				IFNULL(CONCAT(', ', _mailproy ),''), 
				IFNULL(CONCAT(', ', _cmf ),''), 
				IFNULL(CONCAT(', ', _mon_tec ),''), 
				IFNULL(CONCAT(', ', _mon_fin ),''), 
				IFNULL(CONCAT(', ', _mon_ext ),''), 
				IFNULL(CONCAT(', ', _amt ),'') 
			      ) ;		
		SET _asunto = REPLACE(_asunto,"{asunto}","Se ha realizado el desembolso del Segundo Pago a Monitores Externos del Proyecto {proyecto} - {inst} ");
		SET _asunto = REPLACE(_asunto,"{proyecto}",NEW.t02_cod_proy);
		SET _asunto = REPLACE(_asunto,"{inst}",_institucion);
		SET _msg = REPLACE(_msg,"{cab}","Señores de Fondoempleo,
				se ha realizado el desembolso N°-{des} del Segundo Pago a Monitores Externos del Proyecto {proyecto} - {inst}, N° de Visita {num}. ");	
		SET _msg = REPLACE(_msg,"{inst}",_institucion);		
		SET _msg = REPLACE(_msg,"{proyecto}",NEW.t02_cod_proy);	
		SET _msg = REPLACE(_msg,"{num}",NEW.t60_id_visita);		
		SET _msg = REPLACE(_msg,"{des}",NEW.t60_id_desemb);	
                          	
		SELECT IFNULL(MAX(id_men),0)+1
	INTO   _id
	FROM adm_mensajes ;
	INSERT INTO adm_mensajes 
	(	id_men, 
		asu_men, 
		tex_men, 
		ori_men, 
		dest_men, 
		fec_men, 
		usu_men
	)
	VALUES
	(	_id, 
		_asunto, 
		_msg, 
		_inst, 
		_destino, 
		NOW(), 
		NEW.usr_actu
	);
            END IF;
END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_update_total_desembolso_me` AFTER UPDATE ON `t60_ejecucion_desemb_me`
 FOR EACH ROW BEGIN
        DECLARE _total_desemb DOUBLE ;
        
	select sum(d.t60_mto_des)
	  into _total_desemb
	  from t60_ejecucion_desemb_me d
	 where d.t02_cod_proy = NEW.t02_cod_proy
	   and d.t60_id_visita  = NEW.t60_id_visita
	   and d.t60_id_nropago = NEW.t60_id_nropago ;
	
     update t31_plan_me_aprob
	set t31_tot_desemb = (case when _total_desemb >=t31_mto_aprob then '1' else '0' end)
      where t02_cod_proy = NEW.t02_cod_proy 
        and t31_id       = NEW.t60_id_visita
        and t31_id_aprob = NEW.t60_id_nropago ;
	
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
/*!50003 CREATE*/ /*!50017 DEFINER=`root`@`localhost`*/ /*!50003 TRIGGER `tr_delete_total_desembolso_me` BEFORE DELETE ON `t60_ejecucion_desemb_me`
 FOR EACH ROW BEGIN
         DECLARE _total_desemb DOUBLE ;
        
	SELECT SUM(d.t60_mto_des)
	  INTO _total_desemb
	  FROM t60_ejecucion_desemb_me d
	 WHERE d.t02_cod_proy = OLD.t02_cod_proy
	   AND d.t60_id_visita  = OLD.t60_id_visita
	   AND d.t60_id_nropago = OLD.t60_id_nropago ;
	
     UPDATE t31_plan_me_aprob
	SET t31_tot_desemb = (CASE WHEN _total_desemb >=t31_mto_aprob THEN '1' ELSE '0' END)
      WHERE t02_cod_proy = OLD.t02_cod_proy 
        AND t31_id       = OLD.t60_id_visita
        AND t31_id_aprob = OLD.t60_id_nropago ;
        
    END */;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Table structure for table `t70_apo_bib`
--

DROP TABLE IF EXISTS `t70_apo_bib`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t70_apo_bib` (
  `codigo` int(11) NOT NULL AUTO_INCREMENT COMMENT 'Codigo de Libro',
  `titulo` varchar(200) NOT NULL COMMENT 'titulo de Libro',
  `autor` varchar(200) DEFAULT NULL COMMENT 'Autor del Libro',
  `resena` varchar(70) DEFAULT NULL COMMENT 'reseña del Libro',
  `resumen` varchar(2000) DEFAULT NULL COMMENT 'resumen del Libro',
  `edicion` varchar(100) DEFAULT NULL COMMENT 'Edición del Libro',
  `sector` varchar(5) DEFAULT NULL COMMENT 'Sector que pertenece',
  `clave` varchar(200) DEFAULT NULL COMMENT 'Palabras Clave',
  `t70_nom_file` varchar(100) DEFAULT NULL COMMENT 'Tipo de Archivo',
  `t70_url_file` varchar(100) DEFAULT NULL COMMENT 'Direccion del Archivo',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` date DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` date DEFAULT NULL,
  PRIMARY KEY (`codigo`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t70_apo_enl`
--

DROP TABLE IF EXISTS `t70_apo_enl`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t70_apo_enl` (
  `codigo` int(11) NOT NULL AUTO_INCREMENT,
  `url` varchar(200) DEFAULT NULL,
  `titulo` varchar(200) DEFAULT NULL,
  `resumen` varchar(2000) DEFAULT NULL,
  `email` varchar(70) DEFAULT NULL,
  PRIMARY KEY (`codigo`)
) ENGINE=InnoDB AUTO_INCREMENT=2 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t70_apo_enl_tema`
--

DROP TABLE IF EXISTS `t70_apo_enl_tema`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t70_apo_enl_tema` (
  `codi` int(11) NOT NULL,
  `tema` varchar(200) DEFAULT NULL,
  `orden` int(11) DEFAULT NULL,
  PRIMARY KEY (`codi`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `t90_equi_fe`
--

DROP TABLE IF EXISTS `t90_equi_fe`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `t90_equi_fe` (
  `t90_id_equi` int(15) NOT NULL,
  `t90_dni_equi` varchar(20) DEFAULT NULL,
  `t90_ape_pat` varchar(50) DEFAULT NULL,
  `t90_ape_mat` varchar(50) DEFAULT NULL,
  `t90_nom_equi` varchar(50) DEFAULT NULL,
  `t90_sexo_equi` int(11) DEFAULT NULL,
  `t90_edad_equi` int(11) DEFAULT NULL,
  `t90_cali_equi` int(11) DEFAULT NULL COMMENT 'Calificación del Integrante del equipo. En ad_tablas: Calificacion y en adm_tablas_aux: Egresado, Bachiller, Master, Phd',
  `t90_mail_equi` varchar(50) DEFAULT NULL,
  `t90_telf_equi` varchar(50) DEFAULT NULL,
  `t90_unid_fe` int(11) DEFAULT NULL COMMENT 'Unidad a la que pertenece el individuo. En ad_tablas: Unidad FE y en adm_tablas_aux: Secretaría Ejecutiva, Monitoreo Tecnico, Monitoreo Financiero, Administración',
  `t90_carg_equi` int(11) DEFAULT NULL COMMENT 'Cargo que desempeña\nEn ad_tablas: Cargos FE y en adm_tablas_aux: Secretario Ejecutivo, Coordinador, Monitor Temático, Monitor Financiero, Otro ',
  `t90_func_equi` varchar(200) DEFAULT NULL,
  `t90_direccion` varchar(200) DEFAULT NULL,
  `t90_estado` int(11) DEFAULT NULL COMMENT 'Activo, Inactivo',
  `usr_crea` char(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `usr_actu` char(20) DEFAULT NULL,
  `fch_actu` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`t90_id_equi`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='Tabla: Equipo de FONDOEMPLEO';
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `tmp_imp_inf_financ_gastos`
--

DROP TABLE IF EXISTS `tmp_imp_inf_financ_gastos`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tmp_imp_inf_financ_gastos` (
  `t02_cod_proy` varchar(10) NOT NULL,
  `t41_anio` int(11) NOT NULL,
  `t41_mes` int(11) NOT NULL,
  `t41_cod_ext` varchar(18) NOT NULL,
  `t41_descrip` varchar(180) DEFAULT NULL,
  `t41_cod_inst` int(11) NOT NULL,
  `t41_monto` double DEFAULT NULL,
  `cod_user` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  PRIMARY KEY (`t02_cod_proy`,`t41_anio`,`t41_mes`,`t41_cod_ext`,`t41_cod_inst`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Table structure for table `tmp_pago_prov_bcp`
--

DROP TABLE IF EXISTS `tmp_pago_prov_bcp`;
/*!40101 SET @saved_cs_client     = @@character_set_client */;
/*!40101 SET character_set_client = utf8 */;
CREATE TABLE `tmp_pago_prov_bcp` (
  `idcarga` int(11) NOT NULL AUTO_INCREMENT,
  `concurso` varchar(10) DEFAULT NULL,
  `codproy` varchar(10) NOT NULL COMMENT 'Codigo del Proyecto',
  `region` varchar(50) NOT NULL,
  `inicio` datetime DEFAULT NULL,
  `termino` datetime DEFAULT NULL,
  `encargado` varchar(100) DEFAULT NULL,
  `ejecutor` varchar(150) NOT NULL,
  `ruc` varchar(11) DEFAULT NULL,
  `modogiro` varchar(150) DEFAULT NULL,
  `banco` varchar(100) DEFAULT NULL,
  `tipocuenta` char(1) DEFAULT NULL,
  `nrocuenta` varchar(30) DEFAULT NULL,
  `moncuenta` char(1) DEFAULT NULL,
  `textoref` varchar(200) DEFAULT NULL,
  `montotransf` double DEFAULT NULL,
  `montranf` char(1) DEFAULT NULL,
  `usu_crea` varchar(20) DEFAULT NULL,
  `fch_crea` datetime DEFAULT NULL,
  `est_audi` char(1) DEFAULT NULL,
  PRIMARY KEY (`idcarga`)
) ENGINE=MyISAM AUTO_INCREMENT=3 DEFAULT CHARSET=utf8;
/*!40101 SET character_set_client = @saved_cs_client */;

--
-- Temporary table structure for view `v_actividades`
--

DROP TABLE IF EXISTS `v_actividades`;
/*!50001 DROP VIEW IF EXISTS `v_actividades`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_actividades` (
  `t02_cod_proy` tinyint NOT NULL,
  `t02_version` tinyint NOT NULL,
  `codigo` tinyint NOT NULL,
  `descripcion` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_aportes_proyectos`
--

DROP TABLE IF EXISTS `v_aportes_proyectos`;
/*!50001 DROP VIEW IF EXISTS `v_aportes_proyectos`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_aportes_proyectos` (
  `codigo` tinyint NOT NULL,
  `institucion` tinyint NOT NULL,
  `tipoinst` tinyint NOT NULL,
  `aportefe` tinyint NOT NULL,
  `aporteotros` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_componentes`
--

DROP TABLE IF EXISTS `v_componentes`;
/*!50001 DROP VIEW IF EXISTS `v_componentes`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_componentes` (
  `t02_cod_proy` tinyint NOT NULL,
  `t02_version` tinyint NOT NULL,
  `codigo` tinyint NOT NULL,
  `descripcion` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_cuentas_proy`
--

DROP TABLE IF EXISTS `v_cuentas_proy`;
/*!50001 DROP VIEW IF EXISTS `v_cuentas_proy`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_cuentas_proy` (
  `t02_cod_proy` tinyint NOT NULL,
  `t01_id_inst` tinyint NOT NULL,
  `t01_id_cta` tinyint NOT NULL,
  `banco` tinyint NOT NULL,
  `banco2` tinyint NOT NULL,
  `tcuenta` tinyint NOT NULL,
  `moneda` tinyint NOT NULL,
  `is_default` tinyint NOT NULL,
  `est_audi` tinyint NOT NULL,
  `nrocuenta` tinyint NOT NULL,
  `t02_nom_benef` tinyint NOT NULL,
  `descripcion` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_inf_mes_prob_soluc`
--

DROP TABLE IF EXISTS `v_inf_mes_prob_soluc`;
/*!50001 DROP VIEW IF EXISTS `v_inf_mes_prob_soluc`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_inf_mes_prob_soluc` (
  `t20_cod_prob` tinyint NOT NULL,
  `t20_problemas` tinyint NOT NULL,
  `t20_soluciones` tinyint NOT NULL,
  `t20_resultados` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_manejo_proyecto`
--

DROP TABLE IF EXISTS `v_manejo_proyecto`;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_manejo_proyecto` (
  `proyecto` tinyint NOT NULL,
  `vs` tinyint NOT NULL,
  `componente` tinyint NOT NULL,
  `actividad` tinyint NOT NULL,
  `nom_actividad` tinyint NOT NULL,
  `codsub` tinyint NOT NULL,
  `subactividad` tinyint NOT NULL,
  `cate_gasto` tinyint NOT NULL,
  `nom_cate_gasto` tinyint NOT NULL,
  `codigo` tinyint NOT NULL,
  `nombre` tinyint NOT NULL,
  `um` tinyint NOT NULL,
  `gasto` tinyint NOT NULL,
  `total` tinyint NOT NULL,
  `meta` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_manejo_proyecto_completo`
--

DROP TABLE IF EXISTS `v_manejo_proyecto_completo`;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_completo`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_manejo_proyecto_completo` (
  `proyecto` tinyint NOT NULL,
  `vs` tinyint NOT NULL,
  `componente` tinyint NOT NULL,
  `actividad` tinyint NOT NULL,
  `nom_actividad` tinyint NOT NULL,
  `codsub` tinyint NOT NULL,
  `subactividad` tinyint NOT NULL,
  `cate_gasto` tinyint NOT NULL,
  `nom_cate_gasto` tinyint NOT NULL,
  `codigo` tinyint NOT NULL,
  `nombre` tinyint NOT NULL,
  `um` tinyint NOT NULL,
  `gasto` tinyint NOT NULL,
  `total` tinyint NOT NULL,
  `meta` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_manejo_proyecto_fuentes`
--

DROP TABLE IF EXISTS `v_manejo_proyecto_fuentes`;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_fuentes`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_manejo_proyecto_fuentes` (
  `proyecto` tinyint NOT NULL,
  `vs` tinyint NOT NULL,
  `componente` tinyint NOT NULL,
  `actividad` tinyint NOT NULL,
  `codsub` tinyint NOT NULL,
  `rubro` tinyint NOT NULL,
  `nomactividad` tinyint NOT NULL,
  `idinst` tinyint NOT NULL,
  `siglas` tinyint NOT NULL,
  `aporte_fuente` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_manejo_proyecto_metas`
--

DROP TABLE IF EXISTS `v_manejo_proyecto_metas`;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_metas`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_manejo_proyecto_metas` (
  `t02_cod_proy` tinyint NOT NULL,
  `t02_version` tinyint NOT NULL,
  `cod_comp` tinyint NOT NULL,
  `cod_activ` tinyint NOT NULL,
  `cod_sub` tinyint NOT NULL,
  `anio` tinyint NOT NULL,
  `mes` tinyint NOT NULL,
  `meta` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_manejo_proyecto_reprog`
--

DROP TABLE IF EXISTS `v_manejo_proyecto_reprog`;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_reprog`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_manejo_proyecto_reprog` (
  `proyecto` tinyint NOT NULL,
  `vs` tinyint NOT NULL,
  `componente` tinyint NOT NULL,
  `actividad` tinyint NOT NULL,
  `nom_actividad` tinyint NOT NULL,
  `codsub` tinyint NOT NULL,
  `subactividad` tinyint NOT NULL,
  `cate_gasto` tinyint NOT NULL,
  `nom_cate_gasto` tinyint NOT NULL,
  `codigo` tinyint NOT NULL,
  `nombre` tinyint NOT NULL,
  `um` tinyint NOT NULL,
  `gasto` tinyint NOT NULL,
  `total` tinyint NOT NULL,
  `meta` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_matriz_proyectos`
--

DROP TABLE IF EXISTS `v_matriz_proyectos`;
/*!50001 DROP VIEW IF EXISTS `v_matriz_proyectos`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_matriz_proyectos` (
  `codigo` tinyint NOT NULL,
  `version` tinyint NOT NULL,
  `expediente` tinyint NOT NULL,
  `codinst` tinyint NOT NULL,
  `titulo` tinyint NOT NULL,
  `inicio` tinyint NOT NULL,
  `termino` tinyint NOT NULL,
  `inic_real` tinyint NOT NULL,
  `finalidad` tinyint NOT NULL,
  `proposito` tinyint NOT NULL,
  `siglas` tinyint NOT NULL,
  `nominst` tinyint NOT NULL,
  `ambito` tinyint NOT NULL,
  `beneficiarios` tinyint NOT NULL,
  `supervisor_inst` tinyint NOT NULL,
  `estado` tinyint NOT NULL,
  `direccion` tinyint NOT NULL,
  `ciudad` tinyint NOT NULL,
  `telefono` tinyint NOT NULL,
  `mail` tinyint NOT NULL,
  `presupuesto` tinyint NOT NULL,
  `cod_me` tinyint NOT NULL,
  `moni_tema` tinyint NOT NULL,
  `moni_fina` tinyint NOT NULL,
  `supe_inst` tinyint NOT NULL,
  `moni_exte` tinyint NOT NULL,
  `inf_planeados` tinyint NOT NULL,
  `tot_planeados_fecha` tinyint NOT NULL,
  `sector` tinyint NOT NULL,
  `subsector` tinyint NOT NULL,
  `codestado` tinyint NOT NULL,
  `codtipoinst` tinyint NOT NULL,
  `tipoinst` tinyint NOT NULL,
  `codsector` tinyint NOT NULL,
  `concurso` tinyint NOT NULL,
  `est` tinyint NOT NULL,
  `durameses` tinyint NOT NULL,
  `t02_fch_ini` tinyint NOT NULL,
  `t02_fch_ter` tinyint NOT NULL,
  `t01_dpto` tinyint NOT NULL,
  `t02_fch_tre` tinyint NOT NULL,
  `t02_fch_tam` tinyint NOT NULL,
  `t02_num_mes_amp` tinyint NOT NULL,
  `fecha_inicio` tinyint NOT NULL,
  `fecha_termino` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_meses_anio`
--

DROP TABLE IF EXISTS `v_meses_anio`;
/*!50001 DROP VIEW IF EXISTS `v_meses_anio`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_meses_anio` (
  `idmes` tinyint NOT NULL,
  `nommes` tinyint NOT NULL,
  `abreviado` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_metas_proyecto_inicial`
--

DROP TABLE IF EXISTS `v_metas_proyecto_inicial`;
/*!50001 DROP VIEW IF EXISTS `v_metas_proyecto_inicial`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_metas_proyecto_inicial` (
  `proyecto` tinyint NOT NULL,
  `inicio` tinyint NOT NULL,
  `anio` tinyint NOT NULL,
  `mes` tinyint NOT NULL,
  `ini_mes` tinyint NOT NULL,
  `residuo` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_periodos_proyecto`
--

DROP TABLE IF EXISTS `v_periodos_proyecto`;
/*!50001 DROP VIEW IF EXISTS `v_periodos_proyecto`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_periodos_proyecto` (
  `proyecto` tinyint NOT NULL,
  `inicio` tinyint NOT NULL,
  `anio` tinyint NOT NULL,
  `mes` tinyint NOT NULL,
  `ini_mes` tinyint NOT NULL,
  `num_mes` tinyint NOT NULL,
  `nom_mes` tinyint NOT NULL,
  `nom_abrev` tinyint NOT NULL,
  `num_anio` tinyint NOT NULL,
  `trimestre` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Temporary table structure for view `v_subactividades`
--

DROP TABLE IF EXISTS `v_subactividades`;
/*!50001 DROP VIEW IF EXISTS `v_subactividades`*/;
SET @saved_cs_client     = @@character_set_client;
SET character_set_client = utf8;
/*!50001 CREATE TABLE `v_subactividades` (
  `t02_cod_proy` tinyint NOT NULL,
  `t02_version` tinyint NOT NULL,
  `codigo` tinyint NOT NULL,
  `descripcion` tinyint NOT NULL,
  `um` tinyint NOT NULL,
  `meta` tinyint NOT NULL
) ENGINE=MyISAM */;
SET character_set_client = @saved_cs_client;

--
-- Dumping routines for database 'pg_test'
--
/*!50003 DROP FUNCTION IF EXISTS `fn_anio_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_anio_proy`( pAnioCalendario INT, pProy VARCHAR(10)) RETURNS int(11)
BEGIN
	DECLARE aAnioProy INT DEFAULT 0;
	
	SELECT	MAX(t02_anio)
	INTO	aAnioProy
	FROM	t02_poa
	WHERE	t02_cod_proy = pProy
		AND	t02_fch_aprob IS NOT NULL
		AND	YEAR(t02_fch_aprob) <= pAnioCalendario;
	
	RETURN aAnioProy;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_anio_x_version_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_anio_x_version_proy`(_proy VARCHAR(10), _ver INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
	DECLARE _anio INT;
	SELECT MAX(t02_anio) INTO _anio
	FROM t02_proy_version 
	WHERE t02_cod_proy = _proy
	  AND t02_tipo = 'POA'
	  AND t02_version = _ver;
	
	RETURN IFNULL(_anio, -1) ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_aprob_poa_fin` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_aprob_poa_fin`(_proy VARCHAR(10), _anio INT) RETURNS int(11)
BEGIN
    DECLARE _existe int ;
    SELECT  ifnull(t02_estado_mf,0)
        into _existe
    FROM  t02_poa
    where t02_cod_proy = _proy
      and t02_anio = _anio;
    if _existe = 262 then
       return true;
    else
       return false;
    end if;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_aprob_poa_tec` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_aprob_poa_tec`(_proy VARCHAR(10), _anio INT) RETURNS tinyint(1)
BEGIN
	DECLARE _existe int ;
	SELECT 	ifnull(t02_estado,0)
		into _existe
	FROM  t02_poa
	where t02_cod_proy = _proy
	  and t02_anio = _anio;
	  
	if _existe = 257 then
	   return true;
	else
	   return false;
	end if;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_aprob_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_aprob_proy`(_proy VARCHAR(10), _user VARCHAR(20)) RETURNS int(11)
BEGIN
	DECLARE var_res INT DEFAULT 0;
	DECLARE var_aprob_ml INT;
	DECLARE var_aprob_croprod INT;
	DECLARE var_aprob_cro INT;
	DECLARE var_aprob_pre INT;
	DECLARE var_aprob_proy INT;

    SELECT t02_aprob_ml, t02_aprob_croprod, t02_aprob_cro, t02_aprob_pre, t02_aprob_proy
    INTO var_aprob_ml, var_aprob_croprod, var_aprob_cro, var_aprob_pre, var_aprob_proy
    FROM t02_aprob_proy
    WHERE t02_cod_proy = _proy;
    
    IF var_aprob_ml IS NULL THEN
        SET var_res = 1; 
    ELSE
        IF var_aprob_croprod IS NULL THEN
            SET var_res = 2; 
        ELSE
            IF var_aprob_cro IS NULL THEN
	            SET var_res = 3; 
	        ELSE
	            IF var_aprob_pre IS NULL THEN
	                SET var_res = 4; 
	            ELSE
	                IF var_aprob_proy IS NULL THEN
	                    SET var_res = 5; 
	                    UPDATE t02_aprob_proy 
				        SET t02_aprob_proy = 1, 
				            usu_aprob_proy = _user, 
				            t02_fch_aprob_proy = NOW() 
				        WHERE t02_cod_proy = _proy 
				        AND t02_aprob_ml  = 1 
				        AND t02_aprob_croprod = 1 
				        AND t02_aprob_cro  = 1 
				        AND t02_aprob_pre = 1 
				        AND t02_aprob_proy IS NULL;
	                ELSE
	                    SET var_res = 6;  
	                END IF;
	            END IF;
	        END IF;            
        END IF;
    END IF;

    RETURN var_res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_avance_acum_subactividad` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_avance_acum_subactividad`(pProy VARCHAR(16), 
																			pAnio INT,
																			pMes INT) RETURNS double
BEGIN
	
	DECLARE aPromedioAcum  DOUBLE DEFAULT 0.0;
	
	SELECT AVG(if(t1.porcentaje > 100, 100, t1.porcentaje))
	INTO aPromedioAcum
	FROM (
		SELECT	malf.t02_cod_proy, 
				malf.t08_cod_comp, 
				malf.t09_cod_act, 
				malf.t09_cod_sub, 
				malf.t09_sub, 
				malf.meaa, 
				malf.meta_poa, 
				aalf.avance, 
				ifnull(aalf.avance / (malf.meaa + malf.meta_poa) * 100, 0) AS porcentaje
		FROM (
				SELECT sub.t02_cod_proy, sub.t08_cod_comp, sub.t09_cod_act, 
						sub.t09_cod_sub, sub.t09_sub,
						IFNULL((SELECT SUM(inf.t09_sub_avanc) 
								FROM	t09_act_sub_mtas_inf inf
								WHERE	inf.t02_cod_proy = sub.t02_cod_proy
									AND inf.t09_sub_anio <= (pAnio-1)
									AND inf.t08_cod_comp = sub.t08_cod_comp
									AND inf.t09_cod_act  = sub.t09_cod_act
									AND inf.t09_cod_sub  = sub.t09_cod_sub
						),0) AS meaa, 
						IFNULL((SELECT SUM(mta.t09_mta)
								FROM 	t09_sub_act_mtas mta
								WHERE	mta.t02_cod_proy = sub.t02_cod_proy 
									AND mta.t02_version  = sub.t02_version
									AND (mta.t09_anio = pAnio AND mta.t09_mes <= pMes)
									AND mta.t08_cod_comp = sub.t08_cod_comp 
									AND mta.t09_cod_act  = sub.t09_cod_act 
									AND mta.t09_cod_sub  = sub.t09_cod_sub 
						), 0) AS meta_poa 
				FROM	t09_subact sub 
				WHERE	sub.t02_cod_proy = pProy 
					AND sub.t02_version  = fn_ult_version_proy(pProy)
				) AS malf
		LEFT JOIN (
				SELECT	inf.t02_cod_proy, inf.t08_cod_comp, inf.t09_cod_act, inf.t09_cod_sub, 
						SUM(inf.t09_sub_avanc) AS avance
				FROM	t09_act_sub_mtas_inf inf
				WHERE	inf.t02_cod_proy = pProy
					AND inf.t09_sub_anio < pAnio 
					OR (inf.t09_sub_anio = pAnio AND inf.t09_sub_mes <= pMes)
				GROUP BY inf.t02_cod_proy, inf.t08_cod_comp, inf.t09_cod_act, inf.t09_cod_sub
				) AS aalf ON (aalf.t02_cod_proy = malf.t02_cod_proy 
							AND aalf.t08_cod_comp = malf.t08_cod_comp 
							AND aalf.t09_cod_act = malf.t09_cod_act 
							AND aalf.t09_cod_sub = malf.t09_cod_sub)
		HAVING (malf.meaa + malf.meta_poa) > 0
		) AS t1;
		
		RETURN aPromedioAcum;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_avance_logrado_componente` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_avance_logrado_componente`(pProy VARCHAR(10)) RETURNS double
BEGIN
	DECLARE aPromedio DOUBLE DEFAULT 0.00;
	SELECT SUM(((sum_avance / meta) * 100)) / COUNT(*) AS promedio
	INTO aPromedio
	FROM (
		SELECT	t1.t02_cod_proy, t1.t02_version, t1.t08_cod_comp, t1.t08_cod_comp_ind,
				t1.t08_mta AS meta, IFNULL(t2.t08_ind_avanc, 0) AS sum_avance
		FROM		t08_comp_ind t1
		LEFT JOIN	(SELECT t02_cod_proy, t02_version, t08_cod_comp, t08_cod_comp_ind, 
							SUM(t08_ind_avanc) AS t08_ind_avanc
					FROM	t08_comp_ind_inf
					GROUP BY t02_cod_proy, t02_version, t08_cod_comp_ind) t2
										ON (	t1.t02_cod_proy = t2.t02_cod_proy
											AND	t1.t02_version = t2.t02_version
											AND	t1.t08_cod_comp = t2.t08_cod_comp
											AND	t1.t08_cod_comp_ind = t2.t08_cod_comp_ind)
		WHERE t1.t02_cod_proy = pProy AND t1.t02_version = fn_ult_version_proy(pProy)
	) t3;
	RETURN aPromedio;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_avance_logrado_proposito` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_avance_logrado_proposito`(pProy VARCHAR(10)) RETURNS double
BEGIN
	DECLARE aPromedio DOUBLE DEFAULT 0.00;
	SELECT SUM(((sum_avance / meta) * 100)) / COUNT(*) AS promedio
	INTO aPromedio
	FROM (
		SELECT	t1.t02_cod_proy, t1.t02_version, t1.t07_cod_prop_ind, 
				t1.t07_mta AS meta, IFNULL(t2.t07_ind_avanc, 0) AS sum_avance
		FROM		t07_prop_ind t1
		LEFT JOIN	(SELECT t02_cod_proy, t02_version, t07_cod_prop_ind, 
							SUM(t07_ind_avanc) AS t07_ind_avanc
					FROM	t07_prop_ind_inf
					GROUP BY t02_cod_proy, t02_version, t07_cod_prop_ind) t2
										ON (	t1.t02_cod_proy = t2.t02_cod_proy
											AND	t1.t02_version = t2.t02_version
											AND	t1.t07_cod_prop_ind = t2.t07_cod_prop_ind)
		WHERE t1.t02_cod_proy = pProy AND t1.t02_version = fn_ult_version_proy(pProy)
	) t3;
	RETURN aPromedio;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_avance_total_subactividad` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_avance_total_subactividad`(pProy VARCHAR(16), 
																			pAnio INT,
																			pMes INT) RETURNS double
BEGIN
	DECLARE aPromedioAvance  DOUBLE DEFAULT 0.0;
SELECT AVG(if(prom_total_subact.porcentaje_avance_sub > 100, 100, prom_total_subact.porcentaje_avance_sub))
INTO aPromedioAvance
FROM (
	SELECT	t.t08_cod_comp, t.t09_cod_act, t.t09_cod_sub, t.t09_sub,
			t.meaa + t.meta_poa + t.mpar AS meta_reprogramada,
			IFNULL(avance.avance, 0) AS avance,
			IFNULL((avance / (t.meaa + t.meta_poa + t.mpar) * 100), 0) AS porcentaje_avance_sub
	FROM	(SELECT sub.t02_cod_proy, sub.t08_cod_comp, sub.t09_cod_act, 
					sub.t09_cod_sub, sub.t09_sub,
					IFNULL((SELECT SUM(inf.t09_sub_avanc) 
							FROM	t09_act_sub_mtas_inf inf
							WHERE	inf.t02_cod_proy = sub.t02_cod_proy
								AND inf.t09_sub_anio <= (pAnio-1)
								AND inf.t08_cod_comp = sub.t08_cod_comp
								AND inf.t09_cod_act  = sub.t09_cod_act
								AND inf.t09_cod_sub  = sub.t09_cod_sub
					),0) AS meaa, 
					IFNULL((SELECT SUM(mta.t09_mta)
							FROM 	t09_sub_act_mtas mta
							WHERE	mta.t02_cod_proy = sub.t02_cod_proy 
								AND mta.t02_version  = sub.t02_version
								AND mta.t09_anio = pAnio
								AND mta.t08_cod_comp = sub.t08_cod_comp 
								AND mta.t09_cod_act  = sub.t09_cod_act 
								AND mta.t09_cod_sub  = sub.t09_cod_sub 
					), 0) AS meta_poa, 
					IFNULL(sub.t09_mta_proy, 0) AS mpar  
			FROM	t09_subact sub 
			WHERE	sub.t02_cod_proy = pProy 
				AND sub.t02_version  = fn_ult_version_proy(pProy)) AS t
	LEFT JOIN (
				SELECT	inf.t02_cod_proy, inf.t08_cod_comp, inf.t09_cod_act, inf.t09_cod_sub, 
						SUM(inf.t09_sub_avanc) AS avance
				FROM	t09_act_sub_mtas_inf inf
				WHERE	inf.t02_cod_proy = pProy
					AND inf.t09_sub_anio < pAnio 
					OR (inf.t09_sub_anio = pAnio AND inf.t09_sub_mes <= pMes)
				GROUP BY inf.t02_cod_proy, inf.t08_cod_comp, inf.t09_cod_act, inf.t09_cod_sub
			) AS avance ON (avance.t02_cod_proy = t.t02_cod_proy 
						AND avance.t08_cod_comp = t.t08_cod_comp 
						AND avance.t09_cod_act = t.t09_cod_act 
						AND avance.t09_cod_sub = t.t09_cod_sub)
	) AS prom_total_subact;
	RETURN aPromedioAvance;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_adm` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_adm`(_proy VARCHAR(10),  _vs INT) RETURNS double
BEGIN
	declare _return double;
	
	SELECT  SUM(t03_monto)
	  into  _return
	FROM t03_mp_gas_adm
	WHERE t02_cod_proy = _proy
  AND t02_version  = _vs;
	
	RETURN ifnull(_return,0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_componentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_componentes`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	
	SELECT	SUM(cost.t10_cost_tot)
	INTO	_return
	FROM	t10_cost_sub cost
	WHERE	cost.t02_cod_proy=_proy AND cost.t02_version=_ver;
	RETURN ifnull(_return,0) ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_componentes_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_componentes_anio`(_proy CHAR(10),       _anno INT) RETURNS double
BEGIN
	DECLARE total_ejec double;
	SELECT SUM(g.t41_gasto) 
	INTO  total_ejec
	FROM t41_inf_financ_gasto g
	INNER JOIN t25_inf_trim t ON (g.t02_cod_proy = t.t02_cod_proy)
	WHERE g.t02_cod_proy = _proy
	AND t.t25_periodo LIKE CONCAT("%",_anno,"%")
	
  AND g.t08_cod_comp != 10; 
	
	
	RETURN ifnull(total_ejec,0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_componentes_pre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_componentes_pre`(_proy varchar(10), _anio int) RETURNS double
BEGIN
	declare _return double;
	
	SELECT  SUM((c.t10_cu * c.t10_cant)* s.t09_mta) AS costo_total
	  into  _return
	FROM  	   t10_cost_sub c
	INNER JOIN t09_subact   s ON(c.t02_cod_proy=s.t02_cod_proy AND c.t02_version=s.t02_version AND c.t08_cod_comp=s.t08_cod_comp AND c.t09_cod_act=s.t09_cod_act AND c.t09_cod_sub=s.t09_cod_sub)
	INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = c.t02_cod_proy)
	WHERE c.t02_cod_proy = _proy
	  AND t.t25_periodo LIKE CONCAT('%',_anio,'%');
	
	RETURN ifnull(_return,0) ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_directos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_directos`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	
	SELECT  fn_costos_componentes(_proy, _ver) + fn_manejo_proyecto(_proy, _ver)
	  into  _return ;
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_directos_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_directos_anio`(_proy varchar(10), _anio int) RETURNS double
BEGIN
	declare _return double;
	
	SELECT  fn_costos_componentes_pre(_proy, _anio) + fn_manejo_proyecto_pre(_proy, _anio)
	  into  _return ;
	
	RETURN _return ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_ejecutados_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_ejecutados_anio`(_proy CHAR(10),       _anno INT,  _act  INT) RETURNS double
BEGIN
	DECLARE total_ejec double;
	SELECT SUM(t41_gasto) 
	INTO  total_ejec
	FROM t41_inf_financ_gasto 
	WHERE t02_cod_proy = _proy
	AND t40_anio= _anno
  AND t08_cod_comp = 10 
  AND t09_cod_act = _act;
	
	RETURN ifnull(total_ejec,0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_ejecutados_anio_pre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_ejecutados_anio_pre`(_proy CHAR(10),       _anno INT) RETURNS double
BEGIN
	DECLARE total_ejec double;
	SELECT SUM(g.t41_gasto) 
	INTO  total_ejec
	FROM t41_inf_financ_gasto g
	INNER JOIN t25_inf_trim t ON (t.t02_cod_proy =  g.t02_cod_proy)
	WHERE g.t02_cod_proy = _proy
	AND t.t25_periodo LIKE CONCAT("%",_anno,"%")
	
  AND g.t08_cod_comp = 10; 
  
	
	RETURN ifnull(total_ejec,0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_indirectos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_indirectos`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
    DECLARE _gastos_adm DOUBLE;
    DECLARE _linea_base DOUBLE;
    DECLARE _imprevistos DOUBLE;
    DECLARE _gastos_sup DOUBLE;
    DECLARE _return DOUBLE;
    
    
    SELECT SUM(IFNULL(t03_monto,0)) 
      INTO _gastos_adm
      FROM t03_mp_gas_adm
     WHERE t02_cod_proy = _proy AND t02_version = _ver ;
     
    
    
     SELECT SUM(IFNULL(t03_monto,0)) 
      INTO _linea_base
      FROM t03_mp_linea_base
      WHERE t02_cod_proy = _proy AND t02_version = _ver ;
    
    
    
     SELECT SUM(IFNULL(t03_monto,0)) 
      INTO _imprevistos
      FROM t03_mp_imprevistos
     WHERE t02_cod_proy = _proy AND t02_version = _ver ;
     
     
     SELECT SUM(IFNULL(t03_monto,0)) 
      INTO _gastos_sup
      FROM t03_mp_gas_supervision
     WHERE t02_cod_proy = _proy AND t02_version = _ver ;
     
     RETURN (IFNULL(_gastos_adm,0) + IFNULL(_linea_base,0) + IFNULL(_imprevistos,0) + IFNULL(_gastos_sup,0)) ;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_indirectos_pre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_indirectos_pre`(_proy varchar(10), _anio int) RETURNS double
BEGIN
    DECLARE _gastos_adm DOUBLE;
    DECLARE _linea_base DOUBLE;
    DECLARE _imprevistos DOUBLE;
    DECLARE _gastos_sup DOUBLE;
    DECLARE _return DOUBLE;
    
    
    SELECT SUM(IFNULL(m.t03_monto,0)) 
      INTO _gastos_adm
      FROM t03_mp_gas_adm m
        INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = m.t02_cod_proy)
     WHERE m.t02_cod_proy = _proy
     AND t.t25_periodo LIKE CONCAT('%',_anio,'%');
    
    
     SELECT SUM(IFNULL(b.t03_monto,0)) 
      INTO _linea_base
      FROM t03_mp_linea_base b
        INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = b.t02_cod_proy)
      WHERE b.t02_cod_proy = _proy AND t.t25_periodo LIKE CONCAT('%',_anio,'%');
    
    
    
     SELECT SUM(IFNULL(ti.t03_monto,0)) 
      INTO _imprevistos
      FROM t03_mp_imprevistos ti
        INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = ti.t02_cod_proy)
     WHERE ti.t02_cod_proy = _proy AND t.t25_periodo LIKE CONCAT('%',_anio,'%');
     
     
     SELECT SUM(IFNULL(ti.t03_monto,0)) 
      INTO _gastos_sup
      FROM t03_mp_gas_supervision ti
        INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = ti.t02_cod_proy)
     WHERE ti.t02_cod_proy = _proy AND t.t25_periodo LIKE CONCAT('%',_anio,'%');
     
     RETURN (IFNULL(_gastos_adm,0) + IFNULL(_linea_base,0) + IFNULL(_imprevistos,0) + IFNULL(_gastos_sup,0)) ;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_parciales` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_parciales`(_proy VARCHAR(10), _ver INT,_comp INT, _act INT, _sub INT) RETURNS double
BEGIN
	DECLARE gastos_mens DOUBLE;
	SELECT IFNULL(SUM(t10_cost_parc),0) INTO gastos_mens
	FROM t10_cost_sub 
	WHERE t02_cod_proy = _proy
	AND t02_version = _ver
	AND t09_cod_act = _act
	AND t09_cod_sub = _sub
	AND t08_cod_comp = _comp;
	RETURN gastos_mens;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_parciales_mp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_parciales_mp`(_proy VARCHAR(10), _comp INT, _act INT, _sub INT, _cat INT, _mes INT, _cto_fte INT) RETURNS double
BEGIN
	DECLARE total_ejec DOUBLE;
	IF _cto_fte = 0 THEN
	  SELECT IFNULL(SUM(t41_gasto),0)
		INTO total_ejec 
	  FROM  t41_inf_financ_gasto
	  WHERE t02_cod_proy = _proy
		AND t08_cod_comp = _comp
		AND t09_cod_act = _act
		AND t09_cod_sub = _sub
		AND t41_cate_gasto = _cat
	  AND t40_mes = _mes;
	END IF;
	RETURN total_ejec;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costos_total_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costos_total_proyecto`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	
	RETURN (fn_costos_directos(_proy, _ver) + fn_costos_indirectos(_proy, _ver) ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_componentes_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_componentes_anio`(_proy CHAR(10),       _anno INT) RETURNS double
BEGIN
	DECLARE total_ejec double;
	SELECT SUM(t41_gasto) 
	INTO  total_ejec
	FROM t41_inf_financ_gasto 
	WHERE t02_cod_proy = _proy
	AND t40_anio= _anno
  AND t08_cod_comp != 10; 
	
	
	RETURN ifnull(total_ejec,0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_linea_base` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_linea_base`(_proy VARCHAR(10),  _inst INT) RETURNS double
BEGIN
	declare _return double;
	
	SELECT 	t02_mto_financ
	  into  _return
	FROM t02_fuente_finan
	WHERE t02_cod_proy = _proy
  AND t01_id_inst  = _inst;
	
	RETURN ifnull(_return,0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_presupuesto_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_presupuesto_fe`(pCodProy VARCHAR(10), pVersion INT ) RETURNS double
BEGIN
	DECLARE aMonto DOUBLE;
	
	SELECT	SUM(t1.t03_monto) AS t03_monto
	INTO 	aMonto
	FROM  (
			SELECT 		t01_id_inst AS t01_id_inst,
						IFNULL(SUM(t10_mont),0) AS t03_monto
			FROM		t10_cost_fte 
			WHERE		t02_cod_proy = pCodProy AND t02_version = pVersion AND t01_id_inst = 10
			GROUP BY	1
			
			UNION ALL
			SELECT		t1.t01_id_inst AS t01_id_inst, 
						IFNULL(SUM(t2.t03_monto), 0) AS t03_monto
			FROM		t02_fuente_finan t1
			LEFT JOIN	t03_mp_per_ftes t2 ON ( t2.t02_cod_proy = t1.t02_cod_proy AND 
												t2.t02_version = pVersion AND 
												t2.t03_id_inst = t1.t01_id_inst)
			WHERE		t1.t02_cod_proy = pCodProy AND t1.t01_id_inst = 10
			GROUP BY 	1
			
			UNION ALL 
			
			SELECT		t1.t01_id_inst AS t01_id_inst, 
						IFNULL(SUM(t2.t03_monto), 0) AS t03_monto
			FROM		t02_fuente_finan t1
			LEFT JOIN	t03_mp_equi_ftes t2 ON (t2.t02_cod_proy = t1.t02_cod_proy AND 
												t2.t02_version = pVersion AND 
												t2.t03_id_inst = t1.t01_id_inst)
			WHERE		t1.t02_cod_proy = pCodProy AND t1.t01_id_inst = 10
			GROUP BY 	1
			
			UNION ALL
			
			SELECT		t1.t01_id_inst AS t01_id_inst, 
						IFNULL(SUM(t2.t03_monto), 0) AS t03_monto
			FROM		t02_fuente_finan t1
			LEFT JOIN	t03_mp_gas_fun_ftes t2 ON ( t2.t02_cod_proy = t1.t02_cod_proy AND 
													t2.t02_version = pVersion AND 
													t2.t03_id_inst = t1.t01_id_inst)
			WHERE		t1.t02_cod_proy = pCodProy AND t1.t01_id_inst = 10
			GROUP BY 	1
	) AS t1;
	
	RETURN aMonto;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_presupuesto_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_presupuesto_otros`(pCodProy VARCHAR(10), pVersion INT) RETURNS double
BEGIN
	DECLARE aMonto DOUBLE;
	
	SELECT	SUM(t1.t03_monto) AS t03_monto
	INTO 	aMonto
	FROM  (
			SELECT 		t01_id_inst AS t01_id_inst,
						IFNULL(SUM(t10_mont),0) AS t03_monto
			FROM		t10_cost_fte 
			WHERE		t02_cod_proy = pCodProy AND t02_version = pVersion AND t01_id_inst != 10
			GROUP BY	1
			
			UNION ALL
			SELECT		t1.t01_id_inst AS t01_id_inst, 
						IFNULL(SUM(t2.t03_monto), 0) AS t03_monto
			FROM		t02_fuente_finan t1
			LEFT JOIN	t03_mp_per_ftes t2 ON ( t2.t02_cod_proy = t1.t02_cod_proy AND 
												t2.t02_version = pVersion AND 
												t2.t03_id_inst = t1.t01_id_inst)
			WHERE		t1.t02_cod_proy = pCodProy AND t1.t01_id_inst != 10
			GROUP BY 	1
			
			UNION ALL 
			
			SELECT		t1.t01_id_inst AS t01_id_inst, 
						IFNULL(SUM(t2.t03_monto), 0) AS t03_monto
			FROM		t02_fuente_finan t1
			LEFT JOIN	t03_mp_equi_ftes t2 ON (t2.t02_cod_proy = t1.t02_cod_proy AND 
												t2.t02_version = pVersion AND 
												t2.t03_id_inst = t1.t01_id_inst)
			WHERE		t1.t02_cod_proy = pCodProy AND t1.t01_id_inst != 10
			GROUP BY 	1
			
			UNION ALL
			
			SELECT		t1.t01_id_inst AS t01_id_inst, 
						IFNULL(SUM(t2.t03_monto), 0) AS t03_monto
			FROM		t02_fuente_finan t1
			LEFT JOIN	t03_mp_gas_fun_ftes t2 ON ( t2.t02_cod_proy = t1.t02_cod_proy AND 
													t2.t02_version = pVersion AND 
													t2.t03_id_inst = t1.t01_id_inst)
			WHERE		t1.t02_cod_proy = pCodProy AND t1.t01_id_inst != 10
			GROUP BY 	1
	) AS t1;
	
	RETURN aMonto;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_total_ejecutado_componentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_total_ejecutado_componentes`(_proy CHAR(10),       _anno INT) RETURNS double
BEGIN
	DECLARE total_ejec double;
	SELECT SUM(t41_gasto) 
	INTO  total_ejec
	FROM t41_inf_financ_gasto 
	WHERE t02_cod_proy = _proy
	AND t40_anio= _anno;
	
	
	
	RETURN ifnull(total_ejec,0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_total_gasto_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_total_gasto_anual`( _proy VARCHAR(10), 
					_ver  INT, 
					_comp int,
					_act  int, 
					_sub  int,
					_cost int, 
					_anio int ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta_anual double;
	declare _costototal double;
	declare _parcial    double ;
	
	select t10_cost_parc
	  into _parcial
	  from  t10_cost_sub
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t08_cod_comp = _comp
	  and t09_cod_act  = _act
	  and t09_cod_sub  = _sub
	  and t10_cod_cost = _cost ;
	
	SELECT sum(t09_mta)
	  INTO _meta_anual
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  and t09_anio     = _anio;
	
	select (_meta_anual * _parcial) into _costototal ;
	
	RETURN ifnull(_costototal,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_total_mp_equi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_total_mp_equi`(_proy CHAR(10),       _vs INT) RETURNS double
BEGIN
	DECLARE _costoTotal DOUBLE;
	SELECT SUM(t03_costo_tot)
	INTO _costoTotal
	FROM t03_mp_equi
	WHERE t02_cod_proy=_proy
  AND t02_version = _vs;
	RETURN ifnull(_costoTotal,0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_total_mp_func` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_total_mp_func`(_proy CHAR(10),       _vs INT) RETURNS double
BEGIN
	declare _return double;
	
	SELECT  SUM(cost.t03_cu * cost.t03_cant * parti.t03_meta) AS costo_total
	  into  _return
	FROM t03_mp_gas_fun_part parti
	LEFT JOIN t03_mp_gas_fun_cost cost  ON(parti.t02_cod_proy=cost.t02_cod_proy AND parti.t02_version=cost.t02_version AND parti.t03_partida=cost.t03_partida)
	WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version  = _vs;
	
	RETURN ifnull(_return,0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_total_proyecto_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_total_proyecto_periodo`(
										pProy varchar(10),
										pVer int,
										pMesIni int,
										pMesFin int) RETURNS double
BEGIN
	DECLARE aNumMesesProy INT;
	DECLARE aDiffMeses INT;
	DECLARE aCostoComponentes DOUBLE;
	DECLARE aManejoProyecto DOUBLE;
	DECLARE aCostosIndirectos DOUBLE;
	DECLARE aCostoTotal DOUBLE;
	SELECT fn_numero_meses_proy(pProy, pVer) INTO aNumMesesProy;
	SELECT IF((pMesFin - pMesIni > 0), pMesFin - pMesIni, 1) INTO aDiffMeses;
	
	
	
	SELECT	SUM(t1.t10_cost_parc * t1.nro_meses_presup) AS costo_total
	INTO	aCostoComponentes
	FROM (
		SELECT	IFNULL(t2.t10_cost_parc, 0) AS t10_cost_parc,
				(SELECT COUNT(*) FROM t09_sub_act_mtas
				 WHERE	t02_cod_proy = t1.t02_cod_proy
					AND t02_version = t1.t02_version
					AND t08_cod_comp = t1.t08_cod_comp
					AND t09_cod_act = t1.t09_cod_act
					AND t09_cod_sub = t1.t09_cod_sub
					AND fn_numero_mes(t09_anio, t09_mes) BETWEEN pMesIni AND pMesFin) AS nro_meses_presup
		FROM	t09_sub_act_mtas t1
		JOIN	t10_cost_sub t2	ON (t2.t02_cod_proy = t1.t02_cod_proy
								AND t2.t02_version = t1.t02_version
								AND t2.t08_cod_comp = t1.t08_cod_comp
								AND t2.t09_cod_act = t1.t09_cod_act
								AND t2.t09_cod_sub = t1.t09_cod_sub)
		WHERE	t1.t02_cod_proy = pProy AND t1.t02_version = pVer
			AND	fn_numero_mes(t1.t09_anio, t1.t09_mes) BETWEEN pMesIni AND pMesFin
		GROUP BY t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub
		) t1;
	
	
	SELECT	SUM(mproy.costo_total)
	INTO 	aManejoProyecto
	FROM (
		
		SELECT	SUM(t1.t03_gasto_tot / t1.nro_meses * t1.nro_meses_presup) AS costo_total
		FROM	(
				SELECT	IFNULL(t2.t03_gasto_tot, 0) AS t03_gasto_tot,
						(SELECT	COUNT(*) 
						 FROM	t03_mp_per_metas 
						 WHERE	t02_cod_proy = t1.t02_cod_proy 
							AND t02_version = t1.t02_version 
							AND t03_id_per = t1.t03_id_per) AS nro_meses,
						(SELECT	COUNT(*)
						 FROM	t03_mp_per_metas 
						 WHERE	t02_cod_proy = t1.t02_cod_proy 
							AND t02_version = t1.t02_version 
							AND t03_id_per = t1.t03_id_per
							AND	fn_numero_mes(t03_anio, t03_mes) BETWEEN pMesIni AND pMesFin) AS nro_meses_presup
				FROM	t03_mp_per_metas t1
				JOIN	t03_mp_per t2 ON (t2.t02_cod_proy = t1.t02_cod_proy
										AND	t2.t02_version = t1.t02_version
										AND	t2.t03_id_per = t1.t03_id_per)
				WHERE	t1.t02_cod_proy = pProy AND t1.t02_version = pVer
					AND	fn_numero_mes(t1.t03_anio, t1.t03_mes) BETWEEN pMesIni AND pMesFin
				GROUP BY t1.t02_cod_proy, t1.t02_version, t1.t03_id_per
				) t1
				
		UNION ALL 
		
		SELECT	SUM(t1.t03_costo_tot / t1.nro_meses * t1.nro_meses_presup) AS costo_total
		FROM	(
				SELECT	IFNULL(t2.t03_costo_tot, 0) AS t03_costo_tot,
						IFNULL(t1.t03_mta, 0) AS t03_mta,
						(SELECT	COUNT(*) 
						 FROM	t03_mp_equi_metas 
						 WHERE	t02_cod_proy = t1.t02_cod_proy 
							AND t02_version = t1.t02_version 
							AND t03_id_equi = t1.t03_id_equi) AS nro_meses,
						(SELECT	COUNT(*)
						 FROM	t03_mp_equi_metas 
						 WHERE	t02_cod_proy = t1.t02_cod_proy 
							AND t02_version = t1.t02_version 
							AND t03_id_equi = t1.t03_id_equi
							AND	fn_numero_mes(t03_anio, t03_mes) BETWEEN pMesIni AND pMesFin) AS nro_meses_presup
				FROM	t03_mp_equi_metas t1
				JOIN	t03_mp_equi t2 ON (t2.t02_cod_proy = t1.t02_cod_proy
										AND	t2.t02_version = t1.t02_version
										AND	t2.t03_id_equi = t1.t03_id_equi)
				WHERE	t1.t02_cod_proy = pProy AND t1.t02_version = pVer
					AND	fn_numero_mes(t1.t03_anio, t1.t03_mes) BETWEEN pMesIni AND pMesFin
				GROUP BY t1.t02_cod_proy, t1.t02_version, t1.t03_id_equi
				) t1
				
		UNION ALL
		
		SELECT	SUM(t1.t03_cu * t1.t03_cant * t1.t03_mta * t1.nro_meses_presup) AS costo_total
		FROM (
				SELECT	IFNULL(t3.t03_cu, 0) AS t03_cu, 
						IFNULL(t3.t03_cant, 0) AS t03_cant, 
						IFNULL(t1.t03_mta, 0) AS t03_mta, 
						(SELECT COUNT(*) FROM t03_mp_gas_fun_metas
						 WHERE t02_cod_proy = t1.t02_cod_proy
							AND t02_version = t1.t02_version
							AND t03_partida = t1.t03_partida
							AND fn_numero_mes(t03_anio, t03_mes) BETWEEN pMesIni AND pMesFin) AS nro_meses_presup
				FROM	t03_mp_gas_fun_metas	t1
				JOIN	t03_mp_gas_fun_part		t2	ON (t2.t02_cod_proy = t1.t02_cod_proy
													AND t2.t02_version = t1.t02_version
													AND	t2.t03_partida = t1.t03_partida)
				JOIN	t03_mp_gas_fun_cost		t3	ON (t3.t02_cod_proy = t2.t02_cod_proy
													AND t3.t02_version = t2.t02_version
													AND t3.t03_partida = t2.t03_partida)
				WHERE	t1.t02_cod_proy = pProy AND t1.t02_version = pVer
					AND	fn_numero_mes(t1.t03_anio, t1.t03_mes) BETWEEN pMesIni AND pMesFin
				GROUP BY t1.t02_cod_proy, t1.t02_version, t1.t03_partida
			) t1
	) AS mproy;
	
	
	SELECT	SUM(iProy.costo_total)
	INTO	aCostosIndirectos
	FROM	(
		
		SELECT (SUM(IFNULL(t03_monto,0))) /  aNumMesesProy * aDiffMeses AS costo_total
		FROM	t03_mp_gas_adm 
		WHERE	t02_cod_proy = pProy AND t02_version = pVer
	
		UNION ALL
		
		
		SELECT	(SUM(IFNULL(t03_monto,0))) / aNumMesesProy * aDiffMeses AS costo_total
		FROM	t03_mp_linea_base
		WHERE	t02_cod_proy = pProy AND t02_version = pVer
		
		UNION ALL
		
		
		SELECT	(SUM(IFNULL(t03_monto,0))) / aNumMesesProy * aDiffMeses AS costo_total
		FROM	t03_mp_imprevistos
		WHERE	t02_cod_proy = pProy AND t02_version = pVer
	) AS iProy;
	SET	aCostoTotal = aCostoComponentes + aManejoProyecto + aCostosIndirectos;
	
	return aCostoTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_total_proy_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_total_proy_anio`(_proy varchar(10), _anio int) RETURNS double
BEGIN
	RETURN (fn_costos_directos_anio(_proy, _anio) + fn_costos_indirectos_pre(_proy, _anio) ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_costo_visita_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_costo_visita_me`(_proy VARCHAR(10), _visita int) RETURNS double
    DETERMINISTIC
BEGIN
	DECLARE _ret double;
	
	if _visita <=0 then
	
	select sum(t31_mto_tot)
	  into _ret
	from    t31_plan_me 
	 where  t02_cod_proy = _proy ;
	 
	else
	
	SELECT SUM(t31_plan_me.t31_mto_tot)
	  INTO _ret
	FROM    t31_plan_me 
	 WHERE  t02_cod_proy = _proy 
	   and  t31_id = _visita ;
	
	end if ;
	
	RETURN IFNULL(_ret, 0) ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_benef_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_benef_at`(pProy VARCHAR(10),
																pBenef INT(11),
																pModulo INT(11)) RETURNS int(11)
BEGIN
	DECLARE aTotal INT;
	
	SELECT COUNT(*)
	INTO aTotal
	FROM (
		SELECT	t3.t11_cod_bene, t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub
		FROM	t12_plan_at t1
		JOIN	t25_inf_trim_at t3 ON (		t1.t02_cod_proy = t3.t02_cod_proy 
										AND t1.t08_cod_comp = t3.t08_cod_comp
										AND t1.t09_cod_act = t3.t09_cod_act
										AND t1.t09_cod_sub = t3.t09_cod_sub)
		WHERE 	t1.t02_cod_proy = pProy 
			AND t1.t02_version = fn_ult_version_proy(pProy)
			AND	t3.t11_cod_bene = pBenef
			AND t12_modulo = pModulo
			AND t3.t15_avance = '1' 
		GROUP BY t3.t11_cod_bene, t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub
		) t4;
	
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_benef_cap` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_benef_cap`(pProy VARCHAR(10),
																pBenef INT(11),
																pModulo INT(11)) RETURNS int(11)
BEGIN
	
	DECLARE aTotal INT;
	SELECT COUNT(*)
	INTO aTotal
	FROM (
		SELECT	t3.t11_cod_bene, t1.t02_cod_proy, 
				t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub, t2.t12_cod_tema
		FROM	t12_plan_capac t1
		JOIN	t12_plan_capac_tema t2 ON (t1.t02_cod_proy = t2.t02_cod_proy 
									AND t1.t02_version = t2.t02_version
									AND t1.t08_cod_comp = t2.t08_cod_comp
									AND t1.t09_cod_act = t2.t09_cod_act
									AND t1.t09_cod_sub = t2.t09_cod_sub)
		JOIN	(SELECT t02_cod_proy, t11_cod_bene, t08_cod_comp, 
						t09_cod_act, t09_cod_sub, t12_cod_tema 
				 FROM t25_inf_trim_capac 
				 WHERE t15_avance = '1'
				 GROUP BY t02_cod_proy, t11_cod_bene, t08_cod_comp, 
							t09_cod_act, t09_cod_sub, t12_cod_tema) t3 
									ON (t1.t02_cod_proy = t3.t02_cod_proy 
									AND t1.t08_cod_comp = t3.t08_cod_comp
									AND t1.t09_cod_act = t3.t09_cod_act
									AND t1.t09_cod_sub = t3.t09_cod_sub
									AND t2.t12_cod_tema = t3.t12_cod_tema)
		WHERE	t1.t12_modulo = pModulo
		GROUP BY t3.t11_cod_bene, t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub, t2.t12_cod_tema
		) t4
	WHERE t4.t11_cod_bene = pBenef
	AND t4.t02_cod_proy = pProy;
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_benef_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_benef_cred`(pProy VARCHAR(10),
																pBenef INT(11)) RETURNS int(11)
BEGIN
	DECLARE aTotal INT;
	SELECT COUNT(*)
	INTO aTotal
	FROM (
		SELECT	* 
		FROM	t12_plan_cred_benef 
		WHERE	t02_cod_proy = pProy 
			AND t11_cod_benef = pBenef 
		GROUP BY t02_cod_proy, t08_cod_comp, t09_cod_act, t09_cod_sub
	) AS t1;
	
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_benef_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_benef_otros`(pProy VARCHAR(10),
																pBenef INT(11),
																pTipo INT(11)) RETURNS int(11)
BEGIN
	DECLARE aTotal INT;
	
	SELECT COUNT(*)
	INTO aTotal
	FROM (
		SELECT	t1.t02_cod_proy, t1.t02_version, t3.t11_cod_bene, t1.t08_cod_comp, 
				t1.t09_cod_act, t1.t09_cod_sub 
		FROM	t12_plan_otros t1
		JOIN	(SELECT t02_cod_proy, t11_cod_bene, t08_cod_comp, t09_cod_act, t09_cod_sub 
				 FROM t25_inf_trim_otros 
				 WHERE t15_avance = '1'
				 GROUP BY t02_cod_proy, t11_cod_bene, t08_cod_comp, t09_cod_act, t09_cod_sub) t3 
							ON (t1.t02_cod_proy = t3.t02_cod_proy 
							AND t1.t08_cod_comp = t3.t08_cod_comp
							AND t1.t09_cod_act = t3.t09_cod_act
							AND t1.t09_cod_sub = t3.t09_cod_sub)
		WHERE	t1.t02_cod_proy = pProy 
			AND t1.t02_version = fn_ult_version_proy(pProy)
			AND t3.t11_cod_bene = pBenef
			AND	t1.t12_tipo = pTipo
		) t4;
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_pers_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_pers_at`(_proy VARCHAR(10), 
										  _modulo INT(11)) RETURNS int(11)
BEGIN
	DECLARE aTotal INT DEFAULT 0;
	
	SELECT COUNT(DISTINCT(t4.t11_cod_bene)) INTO aTotal
	FROM (
		SELECT	t3.t11_cod_bene, t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub
		FROM	t12_plan_at t1
		JOIN	t25_inf_trim_at t3 ON (		t1.t02_cod_proy = t3.t02_cod_proy 
										AND t1.t08_cod_comp = t3.t08_cod_comp
										AND t1.t09_cod_act = t3.t09_cod_act
										AND t1.t09_cod_sub = t3.t09_cod_sub)
		WHERE 	t1.t02_cod_proy = _proy AND t1.t02_version = fn_ult_version_proy(_proy)
			AND t3.t15_avance = '1' AND t12_modulo = _modulo
		GROUP BY t3.t11_cod_bene, t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub
	) AS t4;
	
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_pers_cap` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_pers_cap`(_proy VARCHAR(10), 
										  _modulo INT(11)) RETURNS int(11)
BEGIN
	DECLARE aTotal INT DEFAULT 0;
	
	SELECT COUNT(*) INTO aTotal
	FROM (
		SELECT *
		FROM (
			SELECT	t1.t02_cod_proy, t1.t02_version, t3.t11_cod_bene, t1.t08_cod_comp, 
					t1.t09_cod_act, t1.t09_cod_sub, t1.t12_nro_tema, t2.t12_cod_tema, t1.t12_nro_ben
			FROM	t12_plan_capac t1
			JOIN	t12_plan_capac_tema t2 ON (t1.t02_cod_proy = t2.t02_cod_proy 
										AND t1.t02_version = t2.t02_version
										AND t1.t08_cod_comp = t2.t08_cod_comp
										AND t1.t09_cod_act = t2.t09_cod_act
										AND t1.t09_cod_sub = t2.t09_cod_sub)
			JOIN	(SELECT t02_cod_proy, t11_cod_bene, t08_cod_comp, 
							t09_cod_act, t09_cod_sub, t12_cod_tema 
					 FROM t25_inf_trim_capac 
					 WHERE t15_avance = '1'
					 GROUP BY t02_cod_proy, t11_cod_bene, t08_cod_comp, 
								t09_cod_act, t09_cod_sub, t12_cod_tema) t3 
										ON (t1.t02_cod_proy = t3.t02_cod_proy 
										AND t1.t08_cod_comp = t3.t08_cod_comp
										AND t1.t09_cod_act = t3.t09_cod_act
										AND t1.t09_cod_sub = t3.t09_cod_sub
										AND t2.t12_cod_tema = t3.t12_cod_tema)
			WHERE t1.t12_modulo = _modulo
			) AS t4
		WHERE t4.t02_cod_proy = _proy AND t4.t02_version = fn_ult_version_proy(_proy)
		GROUP BY t4.t11_cod_bene
		HAVING t4.t12_nro_tema <= COUNT(t4.t11_cod_bene)
		) AS t5;
		
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_pers_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_pers_cred`(_proy VARCHAR(10)) RETURNS int(11)
BEGIN
	DECLARE aTotal INT DEFAULT 0;
	SELECT COUNT(DISTINCT(t4.t11_cod_bene)) INTO aTotal
	FROM (
		SELECT	t3.t11_cod_bene, t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub
		FROM	t12_plan_cred t1
		JOIN	t25_inf_trim_cred t3 ON (	t1.t02_cod_proy = t3.t02_cod_proy 
										AND t1.t08_cod_comp = t3.t08_cod_comp
										AND t1.t09_cod_act = t3.t09_cod_act
										AND t1.t09_cod_sub = t3.t09_cod_sub)
		WHERE 	t1.t02_cod_proy = _proy AND t1.t02_version = fn_ult_version_proy(_proy)
			AND t3.t15_avance IS NOT NULL 
		GROUP BY t3.t11_cod_bene, t1.t08_cod_comp, t1.t09_cod_act, t1.t09_cod_sub
	) AS t4;
	RETURN aTotal;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_count_pers_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_count_pers_otros`(_proy VARCHAR(10)) RETURNS int(11)
BEGIN
	DECLARE aTotal INT DEFAULT 0;
	
	SELECT COUNT(*)
	INTO aTotal
	FROM (
		SELECT	t1.t02_cod_proy, t1.t02_version, t3.t11_cod_bene, t1.t08_cod_comp, 
				t1.t09_cod_act, t1.t09_cod_sub, t1.t12_nro_ben 
		FROM	t12_plan_otros t1
		JOIN	(SELECT t02_cod_proy, t11_cod_bene, t08_cod_comp, t09_cod_act, t09_cod_sub 
				 FROM t25_inf_trim_otros 
				 WHERE t15_avance = '1'
				 GROUP BY t02_cod_proy, t11_cod_bene, t08_cod_comp, t09_cod_act, t09_cod_sub) t3 
							ON (t1.t02_cod_proy = t3.t02_cod_proy 
							AND t1.t08_cod_comp = t3.t08_cod_comp
							AND t1.t09_cod_act = t3.t09_cod_act
							AND t1.t09_cod_sub = t3.t09_cod_sub)
		WHERE	t1.t02_cod_proy = _proy AND t1.t02_version = fn_ult_version_proy(_proy)
		GROUP BY t3.t11_cod_bene
		HAVING COUNT(t3.t11_cod_bene) >= (SELECT COUNT(*) FROM t12_plan_otros 
											WHERE t02_cod_proy = _proy 
											AND t02_version = fn_ult_version_proy(_proy))
	) t5;
	
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_cuenta_default` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_cuenta_default`(_inst int) RETURNS int(11)
    DETERMINISTIC
BEGIN
	declare _return int;
	
	SELECT max(cta.t01_id_cta)
	  into _return
	FROM 	  t01_inst_ctas    cta
	WHERE  cta.t01_id_inst = _inst 
	  and  cta.t01_cta_def = '1' ;	
	
	RETURN _return ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_duracion_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_duracion_proy`(_codproy varchar(10), _version int) RETURNS int(11)
    DETERMINISTIC
BEGIN
	DECLARE _retAnios int;
	
	
	select (fn_numero_meses_proy(_codproy, _version)/12)
	into _retAnios ; 
	
	if (fn_numero_meses_proy(_codproy, _version)/12) > _retAnios then
		set _retAnios= _retAnios+1 ;
	end if;
	
	
	return _retAnios;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_inf_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_existe_inf_financ`(_proy VARCHAR(10), 
				 _anio INT, 
				 _mes INT  ) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
	DECLARE _existe INT ;
	SELECT 	IFNULL(COUNT(_mes),0)
		INTO _existe
	FROM t40_inf_financ 
	WHERE t02_cod_proy = _proy
	  AND t40_anio = _anio
	  AND t40_mes  = _mes ;
	  
	IF _existe > 0 THEN
	   RETURN TRUE;
	ELSE
	   RETURN FALSE;
	END IF;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_inf_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_existe_inf_mes`(_proy VARCHAR(10), 
				 _anio INT, 
				 _mes INT  ) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
	DECLARE _existe INT ;
	SELECT 	IFNULL(COUNT(t20_ver_inf),0)
		INTO _existe
	FROM t20_inf_mes 
	WHERE t02_cod_proy = _proy
	  AND t20_anio = _anio
	  AND t20_mes  = _mes ;
	  
	IF _existe > 0 THEN
	   RETURN TRUE;
	ELSE
	   RETURN FALSE;
	END IF;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_inf_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_existe_inf_se`(_proy VARCHAR(10), _anio INT, _entregable INT) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
    DECLARE _existe INT;
    SELECT  IFNULL(COUNT(t02_entregable), 0)
    INTO _existe
    FROM t30_inf_se 
    WHERE t02_cod_proy = _proy
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
      
    IF _existe > 0 then
       RETURN TRUE;
    ELSE
       RETURN FALSE;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_inf_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_existe_inf_si`(_proy VARCHAR(10), _anio INT, _entregable INT) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
    DECLARE _existe INT;
    SELECT  IFNULL(COUNT(t02_entregable), 0)
    INTO _existe
    FROM t45_inf_si 
    WHERE t02_cod_proy = _proy
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
      
    IF _existe > 0 then
       RETURN TRUE;
    ELSE
       RETURN FALSE;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_inf_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_existe_inf_trim`(	 _proy VARCHAR(10), 
				 _anio INT, 
				 _trim INT  ) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
	DECLARE _existe int ;
	SELECT 	ifnull(count(t25_ver_inf),0)
		into _existe
	FROM t25_inf_trim 
	where t02_cod_proy = _proy
	  and t25_anio = _anio
	  and t25_trim  = _trim ;
	  
	if _existe > 0 then
	   return true;
	else
	   return false;
	end if;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_inf_unico_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_existe_inf_unico_anual`(	 _proy VARCHAR(10), 
				 _anio INT) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
	DECLARE _existe INT ;
	SELECT 	COUNT(1)
		INTO _existe
	FROM t55_inf_unico_anual 
	WHERE t02_cod_proy = _proy
	  AND t55_anio = _anio;
	  
	IF _existe > 0 THEN
	   RETURN TRUE;
	ELSE
	   RETURN FALSE;
	END IF;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_inf_unico_anual_cod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_existe_inf_unico_anual_cod`( _proy VARCHAR(10),
				 _id INT) RETURNS tinyint(1)
    DETERMINISTIC
BEGIN
	DECLARE _existe INT ;
	SELECT 	COUNT(1)
		INTO _existe
	FROM t55_inf_unico_anual 
	WHERE t02_cod_proy = _proy
	  AND t55_id = _id;
	  
	IF _existe > 0 THEN
	   RETURN TRUE;
	ELSE
	   RETURN FALSE;
	END IF;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_existe_vb_inf_monext` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_existe_vb_inf_monext`(_proy VARCHAR(10)) RETURNS int(11)
BEGIN
	DECLARE _id INT;
	DECLARE _existe INT;
	DECLARE _estado INT;
	DECLARE est_elab INT DEFAULT 280;
	SELECT	(IFNULL(MAX(t30_id),0)+1) 
	INTO	_id
	FROM	t30_inf_me
	WHERE	t02_cod_proy = _proy;
	SELECT	t30_estado 
	INTO	_estado
	FROM	t30_inf_me
	WHERE	t02_cod_proy = _proy
		AND t30_id = _id - 1;
	IF _estado = est_elab THEN
		RETURN _estado;
	END IF;
	
	SELECT	IFNULL(COUNT(t02_cod_proy),0) 
	INTO	_existe
	FROM	t31_plan_me 
	WHERE	t02_cod_proy = _proy
		AND t31_id = (_id);
	
	IF _existe = 1 THEN
		SELECT	IFNULL(COUNT(t31_vb_v1),0)
		INTO	_existe
		FROM	t31_plan_me 
		WHERE	t02_cod_proy = _proy
			AND t31_id = _id
			AND t31_vb_v1 = "1";
		RETURN _existe; 
	ELSE
		RETURN 10; 
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_fecha_inicio_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_fecha_inicio_proy`(pProy varchar(10), pVer int) RETURNS date
BEGIN
	declare aFecha date;
	
	SELECT	CASE
				WHEN t02_fch_ire IS NOT NULL AND t02_fch_ire != '0000-00-00' THEN
					t02_fch_ire
				WHEN t02_fch_ini IS NOT NULL AND t02_fch_ini != '0000-00-00' THEN
					t02_fch_ini
				ELSE
					t02_fch_isc
			END AS fch_ini
	into	aFecha
	FROM	t02_dg_proy
	WHERE 	t02_cod_proy = pProy and t02_version = pVer;
	
	return aFecha;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_fecha_termino_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_fecha_termino_proy`(pProy VARCHAR(10), pVer INT) RETURNS date
BEGIN
	DECLARE aFecha DATE;
	
	SELECT	CASE
				WHEN t02_fch_tam IS NOT NULL AND t02_fch_tam != '0000-00-00' THEN
					t02_fch_tam
				WHEN t02_fch_tre IS NOT NULL AND t02_fch_tre != '0000-00-00' THEN
					t02_fch_tre
				ELSE
					t02_fch_ter
			END AS fch_ter
	into	aFecha
	FROM	t02_dg_proy
	WHERE 	t02_cod_proy = pProy AND t02_version = pVer;
	
	return aFecha;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_financ_mp_personal_ejecutado` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_financ_mp_personal_ejecutado`( _proy VARCHAR(10),  _anio INT) RETURNS double
BEGIN
	
			DECLARE ejecutado DOUBLE;
			SELECT SUM(gas.t41_gasto)
			INTO ejecutado
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy= _proy
	       AND gas.t40_anio= _anio;
	RETURN IFNULL(ejecutado,0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_gastos_administrativos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_gastos_administrativos`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	declare _idFE int;
	declare _totalFE double ;
	
	select 10 into _idFE ; 
	SELECT fn_total_aporte_fuentes_financ(_proy, _ver, _idFE) into _totalFE ;
	select (_totalFE * 8)/100 into _return;
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_gastos_adm_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_gastos_adm_anual`(_proy VARCHAR(10), _fte INT, _anio INT) RETURNS double
    DETERMINISTIC
BEGIN
 DECLARE _retMonto DOUBLE;
 DECLARE _numanios INT DEFAULT fn_duracion_proy(_proy, 1);
 DECLARE _nummeses INT DEFAULT fn_numero_meses_proy(_proy,1);
 DECLARE _aportemes DOUBLE;
	
  
 SELECT (IFNULL(adm.t03_monto,0) / _nummeses)
   INTO _aportemes
   FROM t03_mp_gas_adm adm
  WHERE adm.t02_cod_proy = _proy
    AND adm.t03_id_inst  = _fte
    AND adm.t02_version  = 1 ;
 
 IF _anio = _numanios THEN
	 IF _nummeses <  (_numanios * 12 ) THEN
		SET _retMonto = (_aportemes * ( _nummeses - ((_numanios-1) * 12 ) ) ) ;
	 ELSE
		SET _retMonto = (_aportemes * 12 ) ;
	 END IF ;
 ELSE
	SET _retMonto = (_aportemes * 12 ) ;
 END IF;
  RETURN _retMonto;
 END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_gastos_totales_anio_pre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_gastos_totales_anio_pre`(_proy varchar(10), _anio int) RETURNS double
BEGIN
	RETURN (fn_costos_componentes_anio(_proy, _anio) + fn_costos_ejecutados_anio_pre(_proy, _anio) ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_gasto_mensual_cto_fte` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_gasto_mensual_cto_fte`(_proy VARCHAR(10), _comp INT, _act INT, _sub INT, _meses INT, _cto_fte INT) RETURNS double
BEGIN
		DECLARE total_ejec DOUBLE;
	IF _cto_fte = 0 THEN
	  SELECT IFNULL(SUM(t41_gasto),0)
		INTO total_ejec 
	  FROM  t41_inf_financ_gasto
	  WHERE t02_cod_proy = _proy
		AND t08_cod_comp = _comp
		AND t09_cod_act = _act
		AND t09_cod_sub = _sub
	  AND fn_numero_mes(t40_anio, t40_mes) <= _meses;
	ELSE 
		SELECT IFNULL(SUM(t41_gasto),0)
		INTO total_ejec 
	  FROM  t41_inf_financ_gasto
	  WHERE t02_cod_proy = _proy
		AND t08_cod_comp = _comp
		AND t09_cod_act = _act
		AND t09_cod_sub = _sub
	  AND t40_mes = _meses; 
	END IF;
	RETURN total_ejec;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_gasto_total_mp_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_gasto_total_mp_personal`(_proy CHAR(10),       _vs INT) RETURNS double
BEGIN
	DECLARE _costoTotal DOUBLE;
	SELECT SUM(ROUND(t03_gasto_tot,2))
	INTO _costoTotal
	FROM t03_mp_per
	WHERE t02_cod_proy=_proy
  AND t02_version = _vs;
	RETURN ifnull(_costoTotal,0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_get_anio_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_get_anio_proy`(pFchIni DATE, 
																pFchIre DATE) RETURNS int(11)
BEGIN
	DECLARE aAnio INT;
	
	SELECT PERIOD_DIFF(
			EXTRACT(YEAR FROM CURDATE()), 
			EXTRACT(YEAR FROM IFNULL(pFchIre, pFchIni)))
	INTO aAnio;
	
	RETURN aAnio;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_get_comentarios_avances_inf_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_get_comentarios_avances_inf_mf`(_proy VARCHAR(10), _num INT, _tipavance int) RETURNS longtext CHARSET utf8
    DETERMINISTIC
BEGIN
DECLARE _comentarios longtext;
	
if _tipavance = 1 then 
   	SELECT GROUP_CONCAT(CONCAT('SubActividad: ',t08_cod_comp,'.', t09_cod_act, '.', t09_cod_sub, ' - Comentario:',  TRIM(t51_obs)) ORDER BY t08_cod_comp, t09_cod_act, t09_cod_sub  ASC SEPARATOR '\n') 
   	  into _comentarios
	  FROM t51_inf_mf_avance_monto
	 WHERE t02_cod_proy = _proy
	   and t51_num = _num ;
end if ;
IF _tipavance = 2 THEN 
	SELECT GROUP_CONCAT(CONCAT('SubActividad: ',t08_cod_comp,'.', t09_cod_act, '.', t09_cod_sub, ' - Comentario:',  TRIM(t51_obs)) ORDER BY t08_cod_comp, t09_cod_act, t09_cod_sub  ASC SEPARATOR '\n') 
   	  INTO _comentarios
	  FROM t51_inf_mf_avance_meta
	 WHERE t02_cod_proy = _proy
	   AND t51_num = _num ;
END IF ;
RETURN IFNULL(_comentarios, '') ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_get_fto_act_fte` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_get_fto_act_fte`(_proy VARCHAR(10), _ver INT, _comp INT, _act INT, _fte INT) RETURNS double
BEGIN
	DECLARE res DOUBLE DEFAULT 0.0;
	
    SELECT IFNULL(SUM(t10_mont),0) 
    INTO res 
    FROM t10_cost_fte 
    WHERE t02_cod_proy = _proy 
    AND t02_version  = _ver
    AND t08_cod_comp = _comp 
    AND t09_cod_act  = _act
    AND t01_id_inst = _fte;
    
    RETURN res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_get_fto_act_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_get_fto_act_otros`(_proy VARCHAR(10), _ver INT, _comp INT, _act INT, _fe INT, _eje INT) RETURNS double
BEGIN
    DECLARE res DOUBLE DEFAULT 0.0;
    
    SELECT IFNULL(SUM(t10_mont),0) 
    INTO res
    FROM t10_cost_fte
    WHERE t02_cod_proy = _proy 
    AND t02_version  = _ver
    AND t08_cod_comp = _comp 
    AND t09_cod_act  = _act
    AND t01_id_inst NOT IN (_fe, _eje);
    
    RETURN res;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_get_mes_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_get_mes_proy`(pFchIni DATE, 
																pFchIre DATE) RETURNS int(11)
BEGIN
	DECLARE aMes INT;
	
	SELECT PERIOD_DIFF(EXTRACT(YEAR_MONTH FROM CURDATE()), 
						EXTRACT(YEAR_MONTH FROM IFNULL(pFchIre, pFchIni))) MOD 12
	INTO aMes;
	
	RETURN aMes;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_imprevistos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_imprevistos`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	declare _idFE int;
	declare _totalFE double ;
	
	select 10 into _idFE ; 
	SELECT fn_total_aporte_fuentes_financ(_proy, _ver, _idFE) into _totalFE ;
	select (_totalFE * 2)/100 into _return;
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_imprevistos_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_imprevistos_anual`(_proy VARCHAR(10), _fte INT, _anio INT) RETURNS double
    DETERMINISTIC
BEGIN
 DECLARE _retMonto DOUBLE;
 DECLARE _numanios INT DEFAULT fn_duracion_proy(_proy, 1);
 DECLARE _nummeses INT DEFAULT fn_numero_meses_proy(_proy,1);
 DECLARE _aportemes DOUBLE;
	
  
 SELECT (IFNULL(imp.t03_monto,0) / _nummeses)
   INTO _aportemes
   FROM t03_mp_imprevistos imp
  WHERE imp.t02_cod_proy = _proy
    AND imp.t03_id_inst  = _fte
    AND imp.t02_version  = 1 ;
 
 IF _anio = _numanios THEN
	 IF _nummeses <  (_numanios * 12 ) THEN
		SET _retMonto = (_aportemes * ( _nummeses - ((_numanios-1) * 12 ) ) ) ;
	 ELSE
		SET _retMonto = (_aportemes * 12 ) ;
	 END IF ;
 ELSE
	SET _retMonto = (_aportemes * 12 ) ;
 END IF;
  RETURN _retMonto;
 END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_ind_comp_ejec_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_ind_comp_ejec_acum`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT  IFNULL( SUM(inf.t08_ind_avanc),'')
INTO    _avance 
FROM 	   t08_comp_ind_inf inf
WHERE inf.t02_cod_proy = _proy
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind
  AND inf.t08_ind_anio < _anio;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_ind_comp_ejec_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_ind_comp_ejec_anual`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT  IFNULL( SUM(inf.t08_ind_avanc),'')
INTO    _avance 
FROM 	   t08_comp_ind_inf inf
WHERE inf.t02_cod_proy = _proy
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind
  AND inf.t08_ind_anio = _anio;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_ind_comp_meta_acum_ext` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_ind_comp_meta_acum_ext`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
  IF _anio = 1 THEN
   
   SELECT 0   INTO _avance ;
   
  ELSE
	SELECT IFNULL(SUM(inf.t08_ind_avanc),0)
	  INTO    _avance 
	  FROM t08_comp_ind_inf_me inf  
	LEFT JOIN t30_inf_me me ON(inf.t02_cod_proy=me.t02_cod_proy AND inf.t30_id=me.t30_id)
	WHERE me.t02_cod_proy = _proy
		AND inf.t08_cod_comp = _comp
		AND inf.t08_cod_comp_ind = _ind
		AND me.t30_anio < _anio;   
	    
  END IF ;
	
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_ind_comp_meta_anual_ext` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_ind_comp_meta_anual_ext`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT IFNULL( SUM(inf.t08_ind_avanc),'')
INTO    _avance 
FROM  t08_comp_ind_inf_me inf 
LEFT JOIN t30_inf_me me ON (inf.t02_cod_proy=me.t02_cod_proy AND inf.t30_id=me.t30_id)
WHERE me.t02_cod_proy = _proy
	AND inf.t08_cod_comp = _comp
	AND inf.t08_cod_comp_ind = _ind
	AND me.t30_anio = _anio;
	
	
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_ind_comp_met_ejec_ext_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_ind_comp_met_ejec_ext_anual`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT  IFNULL( SUM(inf.t08_ind_avanc),'')
INTO    _avance 
FROM 	   t08_comp_ind_inf inf
WHERE inf.t02_cod_proy = _proy
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind
  AND inf.t08_ind_anio = _anio;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_sub_act_ext_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_sub_act_ext_acum`( _proy VARCHAR(10), 
					    _comp INT,
					    _act  INT,
					    _sub  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
  IF _anio = 1 THEN
   
   SELECT 0  INTO _avance ;
   
  ELSE
	SELECT SUM(inf.t09_sub_avanc)
	  INTO    _avance 
	  FROM t09_act_sub_mtas_inf_me inf 
	LEFT JOIN  t30_inf_me me ON(inf.t02_cod_proy=me.t02_cod_proy AND inf.t30_id=me.t30_id)
	WHERE me.t02_cod_proy = _proy
		AND inf.t08_cod_comp = _comp
		AND inf.t09_cod_act  = _act
		AND inf.t09_cod_sub  = _sub
		AND me.t30_anio      < _anio ;       
  END IF ;
	
  RETURN IFNULL(_avance,0) ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_sub_act_ext_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_sub_act_ext_anual`( _proy VARCHAR(10), 
					    _comp INT,
					    _act  INT,
					    _sub  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT IFNULL( SUM(inf.t09_sub_avanc),'')
  INTO    _avance 
  FROM t09_act_sub_mtas_inf_me inf 
LEFT JOIN  t30_inf_me me ON(inf.t02_cod_proy=me.t02_cod_proy AND inf.t30_id=me.t30_id)
WHERE me.t02_cod_proy = _proy
	AND inf.t08_cod_comp = _comp
	AND inf.t09_cod_act = _act
	AND inf.t09_cod_sub = _sub
	AND me.t30_anio = _anio;	
	
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_sub_act_met_ejec_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_sub_act_met_ejec_acum`( _proy VARCHAR(10), 
					    _comp INT,
					    _act  INT,
					    _sub  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
DECLARE _anio_inicio INT DEFAULT 1 ;
  IF _anio = 1 THEN
   
   SELECT 0
   INTO _avance ;
   
  ELSE
  
	 SELECT SUM(inf2.t09_sub_avanc) 
	 INTO    _avance 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=_proy 
	   AND inf2.t08_cod_comp=_comp  
	   AND inf2.t09_cod_act=_act
	   AND inf2.t09_cod_sub=_sub
	   AND inf2.t09_sub_anio < _anio ;   
	     
  END IF ; 
	
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_inf_unico_anual_sub_act_met_pla_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_inf_unico_anual_sub_act_met_pla_acum`( _proy VARCHAR(10), 
					    _comp INT,
					    _act  INT,
					    _sub  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
DECLARE _ver_anio INT DEFAULT fn_version_proy_poa(_proy, _anio-1) ;
DECLARE _ver_inicio INT DEFAULT 1 ;
  IF _anio = 1 THEN
   
   SELECT 0
   INTO _avance ;
   
  ELSE
	SELECT IFNULL( SUM(s.t09_mta),'')
	INTO    _avance 
	FROM t09_subact s
	   WHERE s.t02_cod_proy = _proy 	     
	     AND s.t08_cod_comp = _comp
	     AND s.t09_cod_act = _act
	     AND s.t09_cod_sub = _sub 
	     AND s.t02_version > _ver_inicio 
	     AND s.t02_version <= _ver_anio ;   
  END IF ; 
	
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_LimpiarTildes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_LimpiarTildes`(_text text) RETURNS text CHARSET utf8
    DETERMINISTIC
BEGIN
	declare _ret text ;
	SELECT replace(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(_text,'Ã³','ó'),'Ã¡','á'),'Ã©','é'),'Ã±','ñ'),'Ã­','í'),'Ãº','ú'),'Â¥','Ñ') 
	into _ret ;
	
	return _ret ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_linea_base` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_linea_base`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
    declare _return double;
    declare _idFE int;
    declare _totalFE double ;

    declare _tasaLineaBase double ;

    SELECT t00_nom_lar INTO _tasaLineaBase FROM t00_tasa WHERE t00_cod_tasa = 2;

    select 10 into _idFE ; 
    SELECT fn_total_aporte_fuentes_financ(_proy, _ver, _idFE) into _totalFE ;
    select (_totalFE * _tasaLineaBase)/100 into _return;
    
    RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_linea_base_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_linea_base_anual`(_proy VARCHAR(10), _fte INT, _anio INT) RETURNS double
    DETERMINISTIC
BEGIN
	DECLARE _retMonto DOUBLE;
	DECLARE _numanios INT DEFAULT fn_duracion_proy(_proy, 1);
 
    SELECT IFNULL(lb.t03_monto, 0)
    INTO _retMonto
    FROM t03_mp_linea_base lb
    WHERE lb.t02_cod_proy = _proy
    AND lb.t03_id_inst = _fte
    AND lb.t02_version = 1;
 
    IF _numanios > 1 THEN
        IF _anio = _numanios OR _anio = 1 THEN
            SET _retMonto = _retMonto / 2;
        ELSE
            SET _retMonto = 0;
        END IF;
    END IF;
  RETURN _retMonto;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_lista_representantes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_lista_representantes`( _inst INT) RETURNS text CHARSET utf8
    DETERMINISTIC
BEGIN
	DECLARE _ret TEXT;
	
	SELECT 	w.representante 
	INTO _ret
	FROM (
		SELECT	r.t01_id_inst,
				GROUP_CONCAT(t.abrev, ': ', r.t01_ape_pat, ' ', r.t01_ape_mat, ' ', r.t01_nom_cto
								ORDER BY t.abrev, r.t01_ape_pat, r.t01_ape_mat, r.t01_nom_cto
								SEPARATOR '\n' ) AS representante
		FROM t01_inst_cto  r
		LEFT JOIN adm_tablas_aux t ON (r.t01_cgo_cto = t.codi)
		WHERE r.t01_id_inst = _inst AND r.t01_rep_flg = '1'
		GROUP BY r.t01_id_inst
	) AS w ;
	
	RETURN _ret ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_mail_x_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_mail_x_proyecto`(_proy VARCHAR(10), _tipo INT) RETURNS varchar(150) CHARSET utf8
    DETERMINISTIC
BEGIN

DECLARE _mail VARCHAR(400) DEFAULT '';
IF _tipo = 0 THEN 
   SELECT p.t02_mail_proy 
     INTO _mail    
     FROM 	t02_dg_proy  p
    WHERE p.t02_cod_proy=_proy
    AND p.t02_version =fn_ult_version_proy(_proy); 
END IF ;
IF _tipo = 1 THEN 
   SELECT i.t01_mail_inst 
     INTO _mail    
     FROM 	t02_dg_proy  p
    INNER JOIN  t01_dir_inst i ON(p.t01_id_inst=i.t01_id_inst)
    WHERE p.t02_cod_proy=_proy
    AND p.t02_version =fn_ult_version_proy(_proy); 
END IF ;
IF _tipo = 2 THEN 
   SELECT e.t90_mail_equi 
     INTO _mail    
     FROM      t02_dg_proy  p 
   LEFT JOIN   t90_equi_fe  e ON(p.t02_moni_tema = e.t90_id_equi)
   WHERE p.t02_cod_proy=_proy
    AND p.t02_version =fn_ult_version_proy(_proy); 
END IF ;
IF _tipo = 3 THEN 
   SELECT e.t90_mail_equi 
     INTO _mail    
     FROM      t02_dg_proy  p 
   LEFT JOIN   t90_equi_fe  e ON(p.t02_moni_fina = e.t90_id_equi)
   WHERE p.t02_cod_proy=_proy
    AND p.t02_version =fn_ult_version_proy(_proy); 
END IF ;
IF _tipo = 4 THEN 
   SELECT CONCAT(m.t01_mail_cto, (CASE WHEN IFNULL(m.t01_mail_cto2,'')='' THEN CONCAT(',',m.t01_mail_cto2) ELSE '' END))
     INTO _mail    
     FROM      t02_dg_proy   p 
   LEFT JOIN   t01_inst_cto  m ON(p.t02_moni_ext = CONCAT(m.t01_id_inst,'.',m.t01_id_cto) )
   WHERE p.t02_cod_proy=_proy
    AND p.t02_version =fn_ult_version_proy(_proy); 
END IF ;
IF _tipo = 5 THEN 
   SELECT CONCAT(s.t01_mail_cto, (CASE WHEN IFNULL(s.t01_mail_cto2,'')='' THEN CONCAT(',',s.t01_mail_cto2) ELSE '' END))
     INTO _mail    
     FROM      t02_dg_proy   p 
   LEFT JOIN   t01_inst_cto  s ON(p.t01_id_inst=s.t01_id_inst AND p.t02_sup_inst = s.t01_id_cto )
   WHERE p.t02_cod_proy = _proy
    AND p.t02_version   = fn_ult_version_proy(_proy) ; 
END IF ;
IF _tipo = 6 THEN 
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _mail
		FROM
adm_usuarios
	WHERE tipo_user=4
	and estado=1
	and mail!=''; 
END IF ;
IF _tipo = 7 THEN 
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _mail
		FROM
adm_usuarios
	WHERE tipo_user=9
	and estado=1
and mail!=''; 
END IF ;
IF _tipo = 10 THEN 
	SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _mail
		FROM
adm_usuarios
	WHERE tipo_user=5
	and estado=1
and mail!=''; 
END IF ;
IF _tipo = 8 THEN 
	SELECT		GROUP_CONCAT(u.mail SEPARATOR ',')    
    INTO		_mail    
	FROM		adm_usuarios u
	INNER JOIN  t01_dir_inst i ON(u.t01_id_uni = i.t01_id_inst AND u.t02_cod_proy = _proy OR
								(u.t01_id_uni = i.t01_id_inst AND u.t02_cod_proy = '*'))
	INNER JOIN  t02_dg_proy  p ON(p.t01_id_inst = i.t01_id_inst)
	WHERE		p.t02_cod_proy = _proy
			AND p.t02_version = fn_ult_version_proy(_proy); 
END IF ;
IF _tipo = 9 THEN 
SELECT GROUP_CONCAT(mail ORDER BY mail SEPARATOR ',') 
		into _mail
		FROM
adm_usuarios
	WHERE tipo_user=10
	and estado=1
	and mail!=''; 
END IF ;
RETURN _mail ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_manejo_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_manejo_proyecto`(_proy VARCHAR(10), _ver INT) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	
	select SUM(mnproy.costo_total) 
	  INTO  _return
	  from (
		SELECT  'Personal' AS Tipo,
			SUM(t03_gasto_tot) AS costo_total
		FROM  t03_mp_per
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver
		UNION ALL
		SELECT  'Equipamiento' AS Tipo,
			SUM(t03_costo_tot) AS costo_total
		FROM  t03_mp_equi
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver
		UNION ALL
		SELECT  'Gastos Funcionamiento' AS Tipo,
			SUM((c.t03_cu * c.t03_cant)* p.t03_meta) AS costo_total
		FROM  	   t03_mp_gas_fun_cost c
		INNER JOIN t03_mp_gas_fun_part p ON(c.t02_cod_proy=p.t02_cod_proy AND c.t02_version=p.t02_version AND c.t03_partida=p.t03_partida)
		WHERE c.t02_cod_proy = _proy
		  AND c.t02_version  = _ver
		) as mnproy ;
	
	RETURN ifnull(_return,0) ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_manejo_proyecto_pre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_manejo_proyecto_pre`(_proy VARCHAR(10), _anio INT) RETURNS double
BEGIN
	declare _return double;
	
	select SUM(mnproy.costo_total) 
	  INTO  _return
	  from (
		SELECT  'Personal' AS Tipo,
			SUM(p.t03_gasto_tot) AS costo_total
		FROM  t03_mp_per p
		INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = p.t02_cod_proy)
		WHERE p.t02_cod_proy = _proy
		  AND t.t25_periodo LIKE CONCAT('%',_anio,'%')
		UNION ALL
		SELECT  'Equipamiento' AS Tipo,
			SUM(p.t03_costo_tot) AS costo_total
		FROM  t03_mp_equi p
		INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = p.t02_cod_proy)
		WHERE p.t02_cod_proy = _proy
		  AND t.t25_periodo LIKE CONCAT('%',_anio,'%')
		UNION ALL
		SELECT  'Gastos Funcionamiento' AS Tipo,
			SUM((c.t03_cu * c.t03_cant)* p.t03_meta) AS costo_total
		FROM  	   t03_mp_gas_fun_cost c
		INNER JOIN t03_mp_gas_fun_part p ON(c.t02_cod_proy=p.t02_cod_proy AND c.t02_version=p.t02_version AND c.t03_partida=p.t03_partida)
		INNER JOIN t25_inf_trim t ON (t.t02_cod_proy = c.t02_cod_proy)
		WHERE c.t02_cod_proy = _proy
		   AND t.t25_periodo LIKE CONCAT('%',_anio,'%')
		) as mnproy ;
	
	RETURN ifnull(_return,0) ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_mes_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_mes_proy`(pFecha DATE, pProy VARCHAR(10)) RETURNS int(11)
BEGIN
	DECLARE aMes INT DEFAULT 0;
	
	SELECT	ceiling(DATEDIFF(pFecha, t.t02_fch_aprob) / 30)
	INTO	aMes
	FROM 	(
			SELECT	MAX(t02_fch_aprob) AS t02_fch_aprob
			FROM	t02_poa
			WHERE	t02_cod_proy = pProy
				AND	t02_fch_aprob IS NOT NULL
				AND	t02_fch_aprob <= pFecha
			) t;
			
	RETURN if(aMes > 0, aMes, 1);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_meta_programada_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_meta_programada_periodo`(_proy VARCHAR(10), 
							_comp int,
							_act  int, 
							_sub  int,
							_ini  int,
							_fin  int ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _anio_ini  int;
DECLARE _anio_fin  int;
declare _ver_fin   int ;
declare _anio  int ;
DECLARE _meta  DOUBLE;
SET _anio_ini = fn_numero_mes_rev(_ini, 1) ;
SET _anio_fin = fn_numero_mes_rev(_fin, 1) ;
IF _anio_ini = _anio_fin THEN
	SET _ver_fin = ifnull(fn_version_proy_poa( _proy, _anio_fin ),1)  ; 
	
	SELECT SUM(m.t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas m
	WHERE m.t02_cod_proy = _proy
	  AND m.t02_version  = _ver_fin 
	  AND m.t08_cod_comp = _comp
	  AND m.t09_cod_act  = _act
	  AND m.t09_cod_sub  = _sub 
	  AND m.t09_anio = (CASE WHEN _ver_fin > 1 THEN _anio_fin ELSE m.t09_anio END )
	  AND (fn_numero_mes(m.t09_anio, m.t09_mes) BETWEEN _ini AND _fin ) ;
ELSE
	SET _ver_fin = IFNULL(fn_version_proy_poa( _proy, _anio_fin ),1)  ; 
	
	SELECT SUM(m.t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas m
	WHERE m.t02_cod_proy = _proy
	  AND m.t02_version  = _ver_fin 
	  AND m.t08_cod_comp = _comp
	  AND m.t09_cod_act  = _act
	  AND m.t09_cod_sub  = _sub 
	  AND m.t09_anio     = _anio_fin
	  AND (m.t09_mes BETWEEN 1 AND fn_numero_mes_rev(_fin, 2)  ) ;
	  
	SELECT ifnull(SUM(inf2.t09_sub_avanc),0) + ifnull(_meta, 0)
	  into _meta
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy = _proy
	   AND inf2.t08_cod_comp = _comp
	   AND inf2.t09_cod_act  = _act
	   AND inf2.t09_cod_sub  = _sub
	   AND (fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) 
		BETWEEN _ini 
		and fn_numero_mes(_anio_fin -1, 12)  
		) ;
	  
END IF ;
RETURN ifnull(_meta,0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_meta_total_planificado_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_meta_total_planificado_periodo`(    _proy VARCHAR(10), 
							_ver  INT, 
							_comp int,
							_act  int, 
							_sub  int,
							_ini  int,
							_fin  int ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	
	SELECT SUM(t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  and (fn_numero_mes(t09_anio, t09_mes) between _ini and _fin ) ;
     	
	RETURN ifnull(_meta,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_miembro_equipo_x_cargo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_miembro_equipo_x_cargo`(_proy varchar(10), _cargo int) RETURNS varchar(60) CHARSET utf8
    DETERMINISTIC
BEGIN
	declare _nombres VARCHAR(60);
	SELECT max(concat( equi.t04_ape_pat ,' ', equi.t04_ape_mat, ', ', equi.t04_nom_equi)) 
	into  _nombres
	from  t04_equi_proy equi
	where equi.t02_cod_proy = _proy
	  and equi.t04_carg_equi = _cargo;
	
	return _nombres;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_desembolsado_me_visita` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_desembolsado_me_visita`(  _proy VARCHAR(10), 
						    _visita  int,
						    _nropago int
					   ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _monto double;	
	
	SELECT SUM( ejec.t60_mto_des  ) 
	  into _monto
	  FROM t60_ejecucion_desemb_me ejec
	 WHERE ejec.t02_cod_proy   = _proy
	   and ejec.t60_id_visita  = _visita
	   AND ejec.t60_id_nropago = _nropago ;
	
	RETURN ifnull(_monto,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_desembolsado_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_desembolsado_periodo`(  _proy VARCHAR(10), 
						  _trim_ini  int,
						  _trim_fin int
						) RETURNS double
    DETERMINISTIC
BEGIN
	declare _monto double;	
	
	SELECT SUM( ejec.t60_mto_des  ) 
	  into _monto
	  FROM t60_ejecucion_desemb ejec
	 WHERE ejec.t02_cod_proy = _proy
	   AND ejec.t60_id_trim between  _trim_ini and _trim_fin ;
	
	RETURN ifnull(_monto,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_desembolso_trimestral` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_desembolso_trimestral`( _proy VARCHAR(10), 
						   _ver  INT, 
						   _fte  int,
						   _anio int, 
						   _trim int
						) RETURNS double
    DETERMINISTIC
BEGIN
	declare _monto double default 0;	
	declare _montomp double default 0 ;
	
	SELECT IFNULL(SUM(
		   fn_monto_planificado_fte_anio_mes
		    (
			fte.t02_cod_proy, 
			fte.t02_version, 
			fte.t08_cod_comp, 
			fte.t09_cod_act, 
			fte.t09_cod_sub, 
			fte.t10_cod_cost, 
			fte.t01_id_inst, 
			mtas.t09_anio , 
			mtas.t09_mes
		     )
		   ),0)
	  into _monto
	  FROM t10_cost_fte fte
	left join t09_sub_act_mtas mtas on(fte.t02_cod_proy = mtas.t02_cod_proy AND fte.t02_version  = mtas.t02_version AND fte.t08_cod_comp = mtas.t08_cod_comp AND fte.t09_cod_act  = mtas.t09_cod_act AND fte.t09_cod_sub  = mtas.t09_cod_sub)
	 WHERE fte.t02_cod_proy = _proy
	   AND fte.t02_version  = _ver
	   AND fte.t01_id_inst  = _fte 
	   AND mtas.t09_anio	= _anio 
	   and mtas.t09_mes BETWEEN ((_trim * 3)-2) and (_trim *3) ;
	
	
	SELECT _montomp + IFNULL(sum(fn_monto_planificado_mp_fte_anio_mes(mta.t02_cod_proy, mta.t02_version, 1, 0 , mta.t03_id_per, _fte, mta.t03_anio, mta.t03_mes )),0)
	into _montomp 
	from t03_mp_per_metas mta
	where mta.t02_cod_proy = _proy
	   AND mta.t02_version  = _ver
	   AND mta.t03_anio	= _anio 
	   AND mta.t03_mes BETWEEN ((_trim * 3)-2) AND (_trim *3) ;
	
	SELECT _montomp + IFNULL(SUM(fn_monto_planificado_mp_fte_anio_mes(mta.t02_cod_proy, mta.t02_version, 2, 0 , mta.t03_id_equi, _fte, mta.t03_anio, mta.t03_mes )),0)
	INTO _montomp 
	FROM t03_mp_equi_metas mta
	WHERE mta.t02_cod_proy = _proy
	   AND mta.t02_version  = _ver
	   AND mta.t03_anio	= _anio 
	   AND mta.t03_mes BETWEEN ((_trim * 3)-2) AND (_trim *3) ;
	
	SELECT _montomp + IFNULL(SUM(fn_monto_planificado_mp_fte_anio_mes(mta.t02_cod_proy, mta.t02_version, 3, mta.t03_partida , gas.t03_id_gasto, _fte, mta.t03_anio, mta.t03_mes )),0)
	INTO _montomp 
	FROM t03_mp_gas_fun_metas mta
	left JOIN t03_mp_gas_fun_cost gas on (mta.t02_cod_proy=gas.t02_cod_proy and mta.t02_version=gas.t02_version and mta.t03_partida=gas.t03_partida)
	WHERE mta.t02_cod_proy = _proy
	   AND mta.t02_version  = _ver
	   AND mta.t03_anio	= _anio 
	   AND mta.t03_mes BETWEEN ((_trim * 3)-2) AND (_trim *3) ;   
	
	
	SELECT _montomp + 
			  (  fn_monto_planificado_mp_fte_anio_mes(_proy,_ver, 4, NULL , NULL, _fte, _anio, (_trim *3) ) + 
			     fn_monto_planificado_mp_fte_anio_mes(_proy,_ver, 4, NULL , NULL, _fte, _anio, (_trim *3)-1 ) +
			     fn_monto_planificado_mp_fte_anio_mes(_proy,_ver, 4, NULL , NULL, _fte, _anio, (_trim *3)-2 )
			  ) 
	  into _montomp;
	
	
			  
	SELECT _montomp + 
			  (  fn_monto_planificado_mp_fte_anio_mes(_proy,_ver, 6, NULL , NULL, _fte, _anio, (_trim *3) ) + 
			     fn_monto_planificado_mp_fte_anio_mes(_proy,_ver, 6, NULL , NULL, _fte, _anio, (_trim *3)-1 ) +
			     fn_monto_planificado_mp_fte_anio_mes(_proy,_ver, 6, NULL , NULL, _fte, _anio, (_trim *3)-2 )
			  ) 
	  INTO _montomp;
			  
			  
	RETURN ifnull(_monto + _montomp, 0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_planificado_fte_anio_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_planificado_fte_anio_mes`(_proy VARCHAR(10), 
_ver  INT, 
	_comp int,
 _act  int, 
	_sub  int,
	_cost int, 
	_fte  int,
 _anio int,
 _mes  int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	
	SELECT SUM(t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  AND t09_anio     = _anio
	  and t09_mes	   = _mes ;
     	
	select t10_cost_parc
	  into _costo
	  from  t10_cost_sub
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t08_cod_comp = _comp
	  and t09_cod_act  = _act
	  and t09_cod_sub  = _sub
	  and t10_cod_cost = _cost ;
        
	SELECT 	t10_porc
	  into  _porc 
	FROM 	t10_cost_fte 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub
	  AND t10_cod_cost = _cost 
	  and t01_id_inst  = _fte ;
	
	select ((_meta * _costo)* (_porc/100)) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_planificado_fte_anio_mes_back` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_planificado_fte_anio_mes_back`(   _proy VARCHAR(10), 
							_ver  INT, 
							_comp int,
							_act  int, 
							_sub  int,
							_cost int, 
							_fte  int,
							_anio int,
							_mes  int ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	
	SELECT SUM(t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  AND t09_anio     = _anio
	  and t09_mes	   = _mes ;
     	
	select t10_cost_parc
	  into _costo
	  from  t10_cost_sub
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t08_cod_comp = _comp
	  and t09_cod_act  = _act
	  and t09_cod_sub  = _sub
	  and t10_cod_cost = _cost ;
        
	SELECT 	t10_porc
	  into  _porc 
	FROM 	t10_cost_fte 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub
	  AND t10_cod_cost = _cost 
	  and t01_id_inst  = _fte ;
	
	select ((_meta * _costo)* (_porc/100)) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_planificado_fte_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_planificado_fte_periodo`(_proy VARCHAR(10), 
 _ver  INT, 
	_comp int,
 _act  int, 
	_sub  int,
	_cost int, 
	_fte  int,
	_mes_ini int,
 _mes_fin  int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	
	
	if _ver = 1 then
	SELECT SUM(t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  AND (fn_numero_mes(t09_anio, t09_mes) between _mes_ini and _mes_fin ) ;
     	else
	  set _meta = fn_meta_programada_periodo(_proy, _comp, _act, _sub, _mes_ini,  _mes_fin);
     	end if;
     	
	select t10_cost_parc
	  into _costo
	  from  t10_cost_sub
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t08_cod_comp = _comp
	  and t09_cod_act  = _act
	  and t09_cod_sub  = _sub
	  and t10_cod_cost = _cost ;
        
	SELECT 	t10_porc
	  into  _porc 
	FROM 	t10_cost_fte 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub
	  AND t10_cod_cost = _cost 
	  and t01_id_inst  = _fte ;
	
	select ((_meta * _costo)* (_porc/100)) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_planificado_mp_fte_anio_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_planificado_mp_fte_anio_mes`( _proy VARCHAR(10), 
							_ver  INT, 
							_act  INT, 
							_sub  INT,
							_cost INT, 
							_fte  INT,
							_anio INT,
							_mes  INT ) RETURNS double
    DETERMINISTIC
BEGIN
	DECLARE _meta  DOUBLE;
	DECLARE _porc  DOUBLE;
	DECLARE _costo DOUBLE ;
	DECLARE _plan  DOUBLE ;
	
	if _act = 1 then 
	
		SELECT SUM(t03_mta)
		  INTO _meta
		  FROM  t03_mp_per_metas
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  and t03_id_per   = _cost
		  AND t03_anio     = _anio
		  AND t03_mes	   = _mes ;
		
		SELECT t03_remu_prom
		  INTO _costo
		  FROM  t03_mp_per
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_per   = _cost;
		
		SELECT 	t03_porc
		  INTO  _porc 
		FROM 	t03_mp_per_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_per   = _cost
		  AND t03_id_inst  = _fte ;
		
		SELECT ((_meta * _costo)* (_porc/100)) INTO _plan ;	
		
		RETURN IFNULL(_plan,0) ;	
		
	end if ;
	
	IF _act = 2 THEN 
	
		SELECT SUM(t03_mta)
		  INTO _meta
		  FROM  t03_mp_equi_metas
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_equi  = _cost
		  AND t03_anio     = _anio
		  AND t03_mes	   = _mes ;
		
		SELECT t03_costo
		  INTO _costo
		  FROM  t03_mp_equi
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_equi  = _cost;
		
		SELECT 	t03_porc
		  INTO  _porc 
		FROM 	t03_mp_equi_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_equi  = _cost
		  AND t03_id_inst  = _fte ;
		
		SELECT ((_meta * _costo)* (_porc/100)) INTO _plan ;	
		
		RETURN IFNULL(_plan,0) ;			
		
	END IF ;
	
	IF _act = 3 THEN 
		SELECT SUM(t03_mta)
		  INTO _meta
		  FROM  t03_mp_gas_fun_metas
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  and t03_partida  = _sub
		  AND t03_anio     = _anio
		  AND t03_mes	   = _mes ;
		
		SELECT (t03_cant * t03_cu)
		  INTO _costo
		  FROM  t03_mp_gas_fun_cost
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  and t03_partida  = _sub
		  AND t03_id_gasto = _cost;
		
		SELECT 	t03_porc
		  INTO  _porc 
		FROM 	t03_mp_gas_fun_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_partida  = _sub
		  and t03_id_gasto = _cost
		  AND t03_id_inst  = _fte ;
		
		SELECT ((_meta * _costo)* (_porc/100)) INTO _plan ;	
		
		RETURN IFNULL(_plan,0) ;
		
	END IF ;
	
	IF _act = 4 THEN 
	
		select fn_numero_meses_proy(_proy, _ver) into _meta ;
		if _ver > 1 then
			if _meta mod 12 = 0 then
				set _meta = _meta / fn_duracion_proy(_proy, 1) ;
			else
				SET _meta =  _meta mod 12 ;
			end if ;
		end if ;
		
		select (t03_monto / _meta )
		  into _plan
		from   t03_mp_gas_adm 
		where t02_cod_proy = _proy
		  and t02_version  = _ver
		  and t03_id_inst  = _fte ;
		  
		  RETURN IFNULL(_plan,0) ;
		
	END IF ;
	
	IF _act = 5 THEN 
	   
	   if  fn_numero_mes(_anio, _mes) = fn_numero_meses_proy(_proy, _ver) or fn_numero_mes(_anio, _mes)=3 then
		SELECT (sum(t03_monto)/2)
		  INTO _plan
		  FROM   t03_mp_linea_base 
		 WHERE t02_cod_proy = _proy
		   AND t02_version  = _ver
		   AND t03_id_inst  = _fte ;
	   else
		select 0 into _plan ;
	   end if ;
	   
	   
	   RETURN IFNULL(_plan,0) ;
	   
	END IF ;
	
	IF _act = 6 THEN 
		SELECT fn_numero_meses_proy(_proy, _ver) INTO _meta ;
		
		IF _ver > 1 THEN
			IF _meta MOD 12 = 0 THEN
				SET _meta = _meta / fn_duracion_proy(_proy, 1) ;
			ELSE
				SET _meta =  _meta MOD 12 ;
			END IF ;
		END IF ;
		
		SELECT (t03_monto / _meta )
		  INTO _plan
		FROM   t03_mp_imprevistos 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver
		  AND t03_id_inst  = _fte ;
		  
		  RETURN IFNULL(_plan,0) ;
	END IF ;	
	
	RETURN IFNULL(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_planificado_mp_fte_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_planificado_mp_fte_periodo`(_proy VARCHAR(10), _ver  INT,    _act  INT,  _sub  INT,     _cost INT,   _fte  INT,   _mes_ini INT,  _mes_fin INT) RETURNS double
BEGIN
	DECLARE _meta  DOUBLE;
	DECLARE _porc  DOUBLE;
	DECLARE _costo DOUBLE ;
	DECLARE _plan  DOUBLE ;
	
	if _act = 1 then 
	
		SELECT SUM(t03_mta)
		  INTO _meta
		  FROM  t03_mp_per_metas
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  and t03_id_per   = _cost
		  AND (fn_numero_mes(t03_anio, t03_mes) BETWEEN _mes_ini AND _mes_fin );
		
		SELECT t03_remu_prom
		  INTO _costo
		  FROM  t03_mp_per
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_per   = _cost;
		
		SELECT 	t03_porc
		  INTO  _porc 
		FROM 	t03_mp_per_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_per   = _cost
		  AND t03_id_inst  = _fte ;
		
		SELECT ((_meta * _costo)* (_porc/100)) INTO _plan ;	
		
		RETURN IFNULL(_plan,0) ;	
		
	end if ;
	
	IF _act = 2 THEN 
	
		SELECT SUM(t03_mta)
		  INTO _meta
		  FROM  t03_mp_equi_metas
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_equi  = _cost
		  AND (fn_numero_mes(t03_anio, t03_mes) BETWEEN _mes_ini AND _mes_fin );
		
		SELECT t03_costo
		  INTO _costo
		  FROM  t03_mp_equi
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_equi  = _cost;
		
		SELECT 	t03_porc
		  INTO  _porc 
		FROM 	t03_mp_equi_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_equi  = _cost
		  AND t03_id_inst  = _fte ;
		
		SELECT ((_meta * _costo)* (_porc/100)) INTO _plan ;	
		
		RETURN IFNULL(_plan,0) ;			
		
	END IF ;
	
	IF _act = 3 THEN 
		SELECT SUM(t03_mta)
		  INTO _meta
		  FROM  t03_mp_gas_fun_metas
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  and t03_partida  = _sub
		  AND (fn_numero_mes(t03_anio, t03_mes) BETWEEN _mes_ini AND _mes_fin );
		
		SELECT (t03_cant * t03_cu)
		  INTO _costo
		  FROM  t03_mp_gas_fun_cost
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  and t03_partida  = _sub
		  AND t03_id_gasto = _cost;
		
		SELECT 	t03_porc
		  INTO  _porc 
		FROM 	t03_mp_gas_fun_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_partida  = _sub
		  and t03_id_gasto = _cost
		  AND t03_id_inst  = _fte ;
		
		SELECT ((_meta * _costo)* (_porc/100)) INTO _plan ;	
		
		RETURN IFNULL(_plan,0) ;
		
	END IF ;
	
	IF _act = 4 THEN 
	
		select fn_numero_meses_proy(_proy, _ver) into _meta ;
		if _ver > 1 then
			if _meta mod 12 = 0 then
				set _meta = _meta / fn_duracion_proy(_proy, 1) ;
			else
				SET _meta =  _meta mod 12 ;
			end if ;
		end if ;
		
		select (t03_monto / _meta )*(_mes_fin - _mes_ini + 1)
		  into _plan
		from   t03_mp_gas_adm 
		where t02_cod_proy = _proy
		  and t02_version  = _ver
		  and t03_id_inst  = _fte;
		  
		  RETURN IFNULL(_plan,0) ;
		
	END IF ;
	
	IF _act = 5 THEN 
	   
	   if  fn_numero_mes(_anio, _mes) = fn_numero_meses_proy(_proy, _ver) or fn_numero_mes(_anio, _mes)=3 then
		SELECT (sum(t03_monto)/2)
		  INTO _plan
		  FROM   t03_mp_linea_base 
		 WHERE t02_cod_proy = _proy
		   AND t02_version  = _ver
		   AND t03_id_inst  = _fte ;
	   else
		select 0 into _plan ;
	   end if ;
	   
	   
	   RETURN IFNULL(_plan,0) ;
	   
	END IF ;
	
	IF _act = 6 THEN 
		SELECT fn_numero_meses_proy(_proy, _ver) INTO _meta ;
		
		IF _ver > 1 THEN
			IF _meta MOD 12 = 0 THEN
				SET _meta = _meta / fn_duracion_proy(_proy, 1) ;
			ELSE
				SET _meta =  _meta MOD 12 ;
			END IF ;
		END IF ;
		
		SELECT (t03_monto / _meta )*(_mes_fin - _mes_ini + 1)
		  INTO _plan
		FROM   t03_mp_imprevistos 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver
		  AND t03_id_inst  = _fte ;
		  
		  RETURN IFNULL(_plan,0) ;
	END IF ;	
	
	RETURN IFNULL(_plan,0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_total_desemb_plan_periodo_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_total_desemb_plan_periodo_mes`( 
							pProy VARCHAR(10), 
							pVer INT, 
							pFte  INT,
							pMesIni INT, 
							pMesFin INT
						) RETURNS double
    DETERMINISTIC
BEGIN
    DECLARE	aMontoPlanSubAct	DOUBLE DEFAULT 0;
    DECLARE aMontoPlanPersonal 	DOUBLE DEFAULT 0;
    DECLARE aMontoPlanEquipo	DOUBLE DEFAULT 0;
    DECLARE aMontoPlanGasFunc	DOUBLE DEFAULT 0;
    DECLARE aMontoPlanGasAdmin	DOUBLE DEFAULT 0;
    DECLARE aMontoPlanLineaBase	DOUBLE DEFAULT 0;
    DECLARE aMontoPlanImprev	DOUBLE DEFAULT 0;
    
	SELECT		SUM(costo_mes) AS costo_mes
	INTO		aMontoPlanSubAct
	FROM (
		SELECT 		CONCAT(cost.t08_cod_comp,'.', cost.t09_cod_act, '.', cost.t09_cod_sub, '.', cost.t10_cod_cost) AS actividad,
					SUM(cost.t10_cu * cost.t10_cant * mta.t09_mta * (fte.t10_porc / 100)) AS costo_mes
		FROM		t09_sub_act_mtas mta
		INNER JOIN	t09_subact		sub  ON(mta.t02_cod_proy = sub.t02_cod_proy 
										AND mta.t02_version = sub.t02_version 
										AND mta.t08_cod_comp = sub.t08_cod_comp 
										AND mta.t09_cod_act = sub.t09_cod_act 
										AND mta.t09_cod_sub = sub.t09_cod_sub)
		LEFT  JOIN	t10_cost_sub	cost ON(sub.t02_cod_proy = cost.t02_cod_proy 
										AND sub.t02_version = cost.t02_version 
										AND sub.t08_cod_comp = cost.t08_cod_comp 
										AND sub.t09_cod_act = cost.t09_cod_act 
										AND sub.t09_cod_sub = cost.t09_cod_sub)
		LEFT  JOIN	t10_cost_fte    fte  ON(cost.t02_cod_proy = fte.t02_cod_proy 
										AND cost.t02_version = fte.t02_version 
										AND cost.t08_cod_comp = fte.t08_cod_comp 
										AND cost.t09_cod_act = fte.t09_cod_act 
										AND cost.t09_cod_sub = fte.t09_cod_sub 
										AND cost.t10_cod_cost = fte.t10_cod_cost 
										AND fte.t01_id_inst = pFte)
		WHERE 		mta.t02_cod_proy = pProy
				AND mta.t02_version  = pVer 
				AND fn_numero_mes(mta.t09_anio, mta.t09_mes) BETWEEN pMesIni AND pMesFin 
				AND fte.t10_porc > 0
		GROUP BY   cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub, cost.t10_cod_cost
	) t;
	SELECT		SUM(costo_mes) AS costo_mes
	INTO		aMontoPlanPersonal
	FROM (
		SELECT		per.t03_id_per AS actividad,
					SUM(mta.t03_mta * per.t03_remu_prom * (fte.t03_porc / 100)) AS costo_mes
		FROM		t03_mp_per_metas mta
		INNER JOIN	t03_mp_per			per ON (mta.t02_cod_proy = per.t02_cod_proy 
											AND mta.t02_version = per.t02_version 
											AND mta.t03_id_per = per.t03_id_per)
		LEFT  JOIN	t03_mp_per_ftes		fte ON (per.t02_cod_proy = fte.t02_cod_proy 
											AND per.t02_version = fte.t02_version 
											AND per.t03_id_per = fte.t03_id_per 
											AND fte.t03_id_inst = pFte)
		WHERE 		mta.t02_cod_proy = pProy
				AND mta.t02_version  = pVer 
				AND fn_numero_mes(mta.t03_anio, mta.t03_mes) BETWEEN pMesIni AND pMesFin 
				AND fte.t03_porc  > 0
		GROUP BY per.t03_id_per
	) t;
		
		
	SELECT		SUM(costo_mes) AS costo_mes
	INTO		aMontoPlanEquipo
	FROM (
		SELECT		equ.t03_id_equi AS actividad,
					SUM(mta.t03_mta * t03_costo * (fte.t03_porc / 100)) AS costo_mes
		FROM		t03_mp_equi_metas 	mta
		INNER JOIN	t03_mp_equi			equ ON (mta.t02_cod_proy = equ.t02_cod_proy 
											AND mta.t02_version = equ.t02_version 
											AND mta.t03_id_equi = equ.t03_id_equi)
		LEFT  JOIN	t03_mp_equi_ftes	fte ON (equ.t02_cod_proy = fte.t02_cod_proy 
											AND equ.t02_version = fte.t02_version 
											AND equ.t03_id_equi = fte.t03_id_equi 
											AND fte.t03_id_inst = pFte)
		WHERE 		mta.t02_cod_proy = pProy
				AND mta.t02_version  = pVer 
				AND fn_numero_mes(mta.t03_anio, mta.t03_mes) BETWEEN pMesIni AND pMesFin 
				AND fte.t03_porc  > 0
		GROUP BY equ.t03_id_equi
	) t;
		
	SELECT		SUM(costo_mes) AS costo_mes
	INTO		aMontoPlanGasFunc
	FROM (
		SELECT		cost.t03_id_gasto AS actividad,
					SUM(cost.t03_cu	* 	cost.t03_cant * mta.t03_mta * (fte.t03_porc / 100)) AS costo_mes
		FROM		t03_mp_gas_fun_metas	mta
		JOIN		t03_mp_gas_fun_part		par 	ON (mta.t02_cod_proy = par.t02_cod_proy 
													AND mta.t02_version = par.t02_version 
													AND mta.t03_partida = par.t03_partida)
		LEFT JOIN	t03_mp_gas_fun_cost		cost	ON (cost.t02_cod_proy = par.t02_cod_proy 
													AND cost.t02_version = par.t02_version 
													AND cost.t03_partida = par.t03_partida)
		LEFT JOIN	t03_mp_gas_fun_ftes		fte 	ON (fte.t02_cod_proy = cost.t02_cod_proy 
													AND fte.t02_version = cost.t02_version 
													AND fte.t03_partida = cost.t03_partida 
													AND	fte.t03_id_gasto = cost.t03_id_gasto
													AND fte.t03_id_inst = pFte)
		WHERE 		mta.t02_cod_proy = pProy
				AND mta.t02_version  = pVer 
				AND fn_numero_mes(mta.t03_anio, mta.t03_mes) BETWEEN pMesIni AND pMesFin 
				AND fte.t03_porc  > 0
		GROUP BY cost.t03_id_gasto
	) t;
	SELECT		SUM(meta * monto) AS costo_mes
	INTO		aMontoPlanGasAdmin
	FROM (
		SELECT		4 AS actividad,
					((pMesFin -pMesIni) + 1) AS meta,
					( adm.t03_monto / fn_numero_meses_proy(adm.t02_cod_proy, adm.t02_version)) AS monto,
					100 AS porc
		FROM		t03_mp_gas_adm adm
		WHERE		adm.t02_cod_proy = pProy
				AND adm.t02_version  = pVer 
				AND adm.t03_id_inst  = pFte
				AND adm.t03_monto  > 0 
				AND fn_numero_meses_proy(adm.t02_cod_proy, adm.t02_version) >= pMesFin
	) t;

	SELECT		SUM(meta * monto) AS costo_mes
	INTO		aMontoPlanImprev
	FROM (
		SELECT		6 AS actividad,
					((pMesFin -pMesIni) + 1) AS meta,
					( imp.t03_monto / fn_numero_meses_proy(imp.t02_cod_proy, imp.t02_version)) AS monto,
					100 AS porc
		FROM		t03_mp_imprevistos imp
		WHERE		imp.t02_cod_proy = pProy
				AND imp.t02_version  = pVer 
				AND imp.t03_monto  > 0 
				AND fn_numero_meses_proy(imp.t02_cod_proy, imp.t02_version) >= pMesFin
	) t;
	RETURN	IFNULL(aMontoPlanSubAct, 0) + IFNULL(aMontoPlanPersonal, 0)  + IFNULL(aMontoPlanEquipo, 0) + 
			IFNULL(aMontoPlanGasFunc, 0) + IFNULL(aMontoPlanGasAdmin, 0) + IFNULL(aMontoPlanLineaBase, 0) + 
			IFNULL(aMontoPlanImprev, 0);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_total_desemb_plan_periodo_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_total_desemb_plan_periodo_trim`( _proy VARCHAR(10), 
							   _ver  INT, 
							   _fte  INT,
							   _trim_ini INT, 
							   _trim_fin INT
						) RETURNS double
    DETERMINISTIC
BEGIN
declare _mes_ini INT ;
declare _mes_fin INT ;
DECLARE _monto_plan DOUBLE DEFAULT 0;	
set _mes_ini = ((_trim_ini * 3)-2) ;
SET _mes_fin = ((_trim_fin * 3)) ;
if(_mes_fin <= 0) then
  return 0 ;
end if ;
set _monto_plan = fn_monto_total_desemb_plan_periodo_mes(_proy, _ver, _fte, _mes_ini, _mes_fin ) ;
RETURN IFNULL(_monto_plan, 0) ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_total_planificado_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_total_planificado_anio`(_proy VARCHAR(10),  _ver  INT, _comp int, _act  int,  _sub  int, _cost int, _fte  int, _anio int, _mes  int) RETURNS double
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	
	SELECT SUM(t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  AND t09_anio     = _anio
	  and t09_mes	   = _mes ;
     	
	select t10_cost_parc
	  into _costo
	  from  t10_cost_sub
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t08_cod_comp = _comp
	  and t09_cod_act  = _act
	  and t09_cod_sub  = _sub
	  and t10_cod_cost = _cost ;
        
	SELECT 	t10_porc
	  into  _porc 
	FROM 	t10_cost_fte 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub
	  AND t10_cod_cost = _cost 
	  and t01_id_inst  = _fte ;
	
	select ((_meta * _costo)* (_porc/100)) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_total_planificado_fte` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_total_planificado_fte`(_proy VARCHAR(10), 
						 _ver  INT, 
						 _comp int,
						 _act  int, 
						 _sub  int,
						 _cost int, 
						 _fte  int
						 ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _aporte_total double ;
     	        
	SELECT 	sum(t10_mont)
	  into  _aporte_total 
	FROM 	t10_cost_fte 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub
	  AND t10_cod_cost = _cost 
	  and t01_id_inst  = _fte ;
		
	RETURN ifnull(_aporte_total ,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_total_planificado_mp_fte` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_total_planificado_mp_fte`(_proy VARCHAR(10), 
						    _ver  INT, 
						    _act  INT, 
						    _sub  INT,
						    _cost INT, 
						    _fte  INT
						 ) RETURNS double
    DETERMINISTIC
BEGIN
	DECLARE _aporte_total DOUBLE ;
	IF _act = 1 THEN 
		SELECT 	sum(t03_monto)
		  INTO  _aporte_total 
		FROM 	t03_mp_per_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_per   = _cost
		  AND t03_id_inst  = _fte ;
		RETURN IFNULL(_aporte_total,0) ;	
		
	END IF ;
	
	IF _act = 2 THEN 
	
		SELECT 	SUM(t03_monto)
		  INTO  _aporte_total 
		FROM 	t03_mp_equi_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_id_equi  = _cost
		  AND t03_id_inst  = _fte ;
		
		RETURN IFNULL(_aporte_total,0) ;	
		
	END IF ;
	
	IF _act = 3 THEN 
		
		SELECT 	SUM(t03_monto)
		  INTO  _aporte_total 
		FROM 	t03_mp_gas_fun_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  AND t03_partida  = _sub
		  AND t03_id_gasto = _cost
		  AND t03_id_inst  = _fte ;
		
		RETURN IFNULL(_aporte_total,0) ;
		
	END IF ;
	
	IF _act = 4 THEN 
	
		SELECT (t03_monto)
		  INTO _aporte_total
		FROM   t03_mp_gas_adm 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver
		  AND t03_id_inst  = _fte ;
		  
		RETURN IFNULL(_aporte_total,0) ;
		
	END IF ;
	
	IF _act = 5 THEN 
	   
	   
	   SELECT sum(t03_monto)
	    INTO _aporte_total
	    FROM   t03_mp_linea_base 
	   WHERE t02_cod_proy = _proy
	     AND t02_version  = _ver
	     AND t03_id_inst  = _fte ;
	   
	   RETURN IFNULL(_aporte_total,0) ;
	   
	END IF ;
	
	IF _act = 6 THEN 
		
	  SELECT (t03_monto)
	    INTO _aporte_total
	    FROM   t03_mp_imprevistos 
	   WHERE t02_cod_proy = _proy
	     AND t02_version  = _ver
	     AND t03_id_inst  = _fte ;
	  
	     RETURN IFNULL(_aporte_total,0) ;
	     
	END IF ;	
		
	RETURN IFNULL(_aporte_total ,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_total_planificado_mp_fte_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_total_planificado_mp_fte_act`( _proy VARCHAR(10), 
						         _ver  INT, 
						         _act  INT, 
						         _fte  INT
						         ) RETURNS double
    DETERMINISTIC
BEGIN
	DECLARE _aporte_total DOUBLE default 0 ;
	
	IF _act = 1 or _act=0 THEN 
		SELECT 	_aporte_total + sum(t03_monto)
		  INTO  _aporte_total 
		FROM 	t03_mp_per_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  
		  AND t03_id_inst  = _fte ;
	END IF ;
	
	IF _act = 2 or _act=0 THEN 
		SELECT 	_aporte_total  + SUM(t03_monto)
		  INTO  _aporte_total 
		FROM 	t03_mp_equi_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  
		  AND t03_id_inst  = _fte ;
	END IF ;
	
	IF _act = 3 or _act=0 THEN 
		SELECT 	_aporte_total  + SUM(t03_monto)
		  INTO  _aporte_total 
		FROM 	t03_mp_gas_fun_ftes 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver 
		  
		  
		  AND t03_id_inst  = _fte ;
	END IF ;
	
	IF _act = 4 OR _act=0 THEN 
	
		SELECT _aporte_total + (t03_monto)
		  INTO _aporte_total
		FROM   t03_mp_gas_adm 
		WHERE t02_cod_proy = _proy
		  AND t02_version  = _ver
		  AND t03_id_inst  = _fte ;
	END IF ;
	
	IF _act = 5 or _act=0  THEN 
	   
	   SELECT _aporte_total + 0 INTO _aporte_total ;
	END IF ;
	
	IF _act = 6 or _act=0  THEN 
	  SELECT _aporte_total  + (t03_monto)
	    INTO _aporte_total
	    FROM   t03_mp_imprevistos 
	   WHERE t02_cod_proy = _proy
	     AND t02_version  = _ver
	     AND t03_id_inst  = _fte ;
	END IF ;	
		
	RETURN IFNULL(_aporte_total ,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_monto_total_planificado_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_monto_total_planificado_periodo`(   _proy VARCHAR(10), 
							_ver  INT, 
							_comp int,
							_act  int, 
							_sub  int,
							_cost int, 
							_ini  int,
							_fin  int ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	
	SELECT SUM(t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  and (fn_numero_mes(t09_anio, t09_mes) between _ini and _fin ) ;
     	
	select t10_cost_parc
	  into _costo
	  from  t10_cost_sub
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t08_cod_comp = _comp
	  and t09_cod_act  = _act
	  and t09_cod_sub  = _sub
	  and t10_cod_cost = _cost ;
	
	select (_meta * _costo) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_mp_gastos_administrativos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_mp_gastos_administrativos`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	declare _idFE int;
	declare _totalFE double ;
	
	select 10 into _idFE ; 
	SELECT fn_total_aporte_fuentes_financ(_proy, _ver, _idFE) into _totalFE ;
	select (_totalFE * 8)/100 into _return;
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_mp_imprevistos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_mp_imprevistos`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	declare _idFE int;
	declare _totalFE double ;
	
	select 10 into _idFE ; 
	SELECT fn_total_aporte_fuentes_financ(_proy, _ver, _idFE) into _totalFE ;
	select (_totalFE * 2)/100 into _return;
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_mp_linea_base` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_mp_linea_base`(_proy varchar(10), _ver int) RETURNS double
    DETERMINISTIC
BEGIN
	declare _return double;
	declare _idFE int;
	declare _totalFE double ;
	
	select 10 into _idFE ; 
	SELECT fn_total_aporte_fuentes_financ(_proy, _ver, _idFE) into _totalFE ;
	select (_totalFE * 4)/100 into _return;
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_mta_rprog_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_mta_rprog_acum`(_proy VARCHAR(10), _anio INT, _mes INT, _ver INT,
																_comp INT, _act INT, _sub INT) RETURNS double
BEGIN
	DECLARE _ver_last INT;
	DECLARE meaa DOUBLE;
	DECLARE mpoa DOUBLE;
	DECLARE mpar DOUBLE;
	DECLARE total DOUBLE;
	IF(_anio>1) THEN
		SELECT fn_version_proy_poa(_proy, _anio-1) INTO _ver_last;
	ELSE
		SELECT _ver INTO _ver_last;
	END IF;
	
	SELECT	IFNULL(SUM(inf.t09_sub_avanc),0) INTO meaa
	FROM	t09_act_sub_mtas_inf inf
	WHERE	inf.t02_cod_proy = _proy
		AND inf.t08_cod_comp = _comp
		AND inf.t09_cod_act  = _act
		AND inf.t09_cod_sub  = _sub
		AND inf.t09_sub_anio <= (_anio-1);
	
	SELECT	IFNULL(SUM(mta.t09_mta),0) INTO mpoa
	FROM	t09_sub_act_mtas mta
	WHERE	mta.t02_cod_proy = _proy
		AND mta.t02_version  = _ver
		AND mta.t08_cod_comp = _comp
		AND mta.t09_cod_act  = _act
		AND mta.t09_cod_sub  = _sub
		AND mta.t09_anio=_anio
		AND mta.t09_mes <= _mes;
	
	
	SELECT IFNULL(t09_mta_proy, 0) INTO mpar
	FROM t09_subact
	WHERE t02_cod_proy = _proy  
		AND t02_version = _ver
		AND t08_cod_comp = _comp 
		AND t09_cod_act  = _act 
		AND t09_cod_sub  = _sub ;
	SELECT SUM(meaa + mpoa + mpar) INTO total;
	RETURN ROUND(total, 2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_mta_rprog_poa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_mta_rprog_poa`(_proy VARCHAR(10), _anio INT, _ver INT,_comp INT, _act INT, _sub INT) RETURNS double
BEGIN
DECLARE _ver_last INT;
DECLARE _ver_cron INT;
DECLARE _porc DOUBLE ;
SELECT fn_pri_version_proy(_proy) INTO _ver_cron;
IF(_anio>1) THEN
	SELECT fn_version_proy_poa(_proy, _anio-1) INTO _ver_last;
ELSE
	SELECT _ver INTO _ver_last;
END IF;
SELECT SUM(IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) INTO
_porc
FROM
(
SELECT 	   sub.t02_cod_proy, 
	   sub.t02_version, 
	   CONCAT(sub.t08_cod_comp,'.', sub.t09_cod_act, '.', sub.t09_cod_sub) AS codigo,
	   sub.t08_cod_comp AS comp, 
	   sub.t09_cod_act AS act, 
	   sub.t09_cod_sub AS subact, 
	   sub.t09_sub AS descripcion, 
	   sub.t09_um AS um, 
	   sub.t09_mta AS meta_acum,
	   sub.t09_resumen as resumen,
	   sub.t09_obs_mt,
	   
	   IFNULL((
	     CASE WHEN _anio>1 THEN 
							    (
							       poa_ant.t09_mta_repro
							    ) 
						   ELSE 
								(
								SELECT SUM(mta.t09_mta)
								  FROM t09_sub_act_mtas mta
								 WHERE mta.t02_cod_proy = sub.t02_cod_proy 
								   AND mta.t02_version  = _ver_cron
								   AND mta.t08_cod_comp = sub.t08_cod_comp 
								   AND mta.t09_cod_act  = sub.t09_cod_act 
								   AND mta.t09_cod_sub  = sub.t09_cod_sub 
								
							    )
						   END
	   ),0) AS mfi,
	   
	 
	   
	   (CASE WHEN _anio>1 
		 THEN 
		    (
			SELECT SUM(mta.t09_mta)
			  FROM t09_sub_act_mtas mta
			 WHERE mta.t02_cod_proy = sub.t02_cod_proy 
			   AND mta.t02_version  = _ver_last
			   AND mta.t08_cod_comp = sub.t08_cod_comp 
			   AND mta.t09_cod_act  = sub.t09_cod_act 
			   AND mta.t09_cod_sub  = sub.t09_cod_sub 
			   AND mta.t09_anio=(_anio - 1)
		    )
		 ELSE 0 
	     END) AS mpaa, 
	   IFNULL((
	     SELECT SUM(inf.t09_sub_avanc) 
	       FROM t09_act_sub_mtas_inf inf
	      WHERE inf.t02_cod_proy = sub.t02_cod_proy
	        AND inf.t08_cod_comp = sub.t08_cod_comp
	        AND inf.t09_cod_act  = sub.t09_cod_act
	        AND inf.t09_cod_sub  = sub.t09_cod_sub
	        AND inf.t09_sub_anio <= (_anio-1)
	   ),0) AS meaa, 
	   (
	    SELECT SUM(mta.t09_mta)
	      FROM  t09_sub_act_mtas mta
	     WHERE mta.t02_cod_proy = sub.t02_cod_proy 
	       AND mta.t02_version  = sub.t02_version
	       AND mta.t08_cod_comp = sub.t08_cod_comp 
	       AND mta.t09_cod_act  = sub.t09_cod_act 
	       AND mta.t09_cod_sub  = sub.t09_cod_sub 
	       AND mta.t09_anio=_anio
	   ) AS meta_poa, 
	   sub.t09_mta_proy AS mpar 
FROM t09_subact sub 
LEFT JOIN t09_subact poa_ant ON(sub.t02_cod_proy = poa_ant.t02_cod_proy AND poa_ant.t02_version = _ver_last AND sub.t08_cod_comp = poa_ant.t08_cod_comp AND sub.t09_cod_act =poa_ant.t09_cod_act AND sub.t09_cod_sub = poa_ant.t09_cod_sub) 
WHERE sub.t02_cod_proy = _proy 
  AND sub.t02_version  = _ver 
  AND sub.t08_cod_comp = _comp 
  AND sub.t09_cod_act  = _act 
	AND sub.t09_cod_sub  = _sub
ORDER BY sub.t09_cod_sub
) AS temp;
  
 RETURN ROUND(_porc,2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nompropio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nompropio`(_texto text) RETURNS text CHARSET utf8
    DETERMINISTIC
BEGIN
    DECLARE _rettext text ;
    declare _acumula varchar(50) default '';
    declare _palabra varchar(50) default '';
    declare _numespacios int ;
    declare _contador int default 1 ;
	
    select (LENGTH(_texto) - LENGTH(REPLACE(_texto, ' ', '')))   into _numespacios ;
    
    while (_numespacios + 1) >= _contador do
    
	set _palabra = TRIM(REPLACE( SUBSTRING_INDEX(_texto ,' ',_contador), SUBSTRING_INDEX(_texto ,' ',_contador-1),'')) ;
	
	set _acumula = concat(_acumula, upper(substring(_palabra,1,1)), lower(substring(_palabra,2)),' '  ) ;
    
      set _contador = _contador +1 ;
    
    END WHILE;
    
    set _rettext = trim(_acumula) ;
    
   
    return _rettext;    
    
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nom_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nom_mes`(_mes int) RETURNS varchar(20) CHARSET utf8
    DETERMINISTIC
BEGIN
    DECLARE _retmes varchar(20);
    SELECT
	CASE WHEN _mes = 1 THEN 'Enero'
	WHEN _mes = 2 THEN 'Febrero'
	WHEN _mes = 3 THEN 'Marzo'
	WHEN _mes = 4 THEN 'Abril'
	WHEN _mes = 5 THEN 'Mayo'
	WHEN _mes = 6 THEN 'Junio'
	WHEN _mes = 7 THEN 'Julio'
	WHEN _mes = 8 THEN 'Agosto'
	WHEN _mes = 9 THEN 'Septiembre'
	WHEN _mes = 10 THEN 'Octubre'
	WHEN _mes = 11 THEN 'Noviembre'
	WHEN _mes = 12 THEN 'Diciembre'
	ELSE '' END 
    into _retmes ;
   
    return _retmes;    
    
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nom_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nom_periodo`(_proy VARCHAR(10) ,_anio INT ,_mes INT) RETURNS varchar(50) CHARSET utf8
    DETERMINISTIC
BEGIN
DECLARE _ver INT DEFAULT fn_ult_version_proy(_proy) ;
DECLARE _fecini DATETIME ;
DECLARE _return VARCHAR(50) ;
DECLARE _nummes INT DEFAULT 1;
SELECT fn_fecha_inicio_proy(_proy, _ver)
  INTO _fecini;
 
SELECT 	CONCAT (fn_nom_mes(MONTH(fechas.ini_mes))," ", YEAR(fechas.ini_mes) )
INTO _return
FROM (
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes-1) MONTH ) AS ini_mes,
			_anio AS anio,
			_nummes   AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes) MONTH ) AS ini_mes,
			_anio AS anio,
			_nummes + 1   AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+1) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 2)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+2) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 3)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+3) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 4)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+4) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 5)  AS mes	
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+5) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 6)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+6) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 7)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+7) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 8)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+8) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 9)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+9) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 10)  AS mes
		UNION ALL
		SELECT 	_fecini AS inicio,
			DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+10) MONTH ) AS ini_mes,
			_anio AS anio,
			(_nummes + 11)  AS mes
	) AS fechas
	WHERE fechas.anio=_anio AND fechas.mes=_mes ; 
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nom_periodo_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nom_periodo_anio`(_proy VARCHAR(10) ,_anio INT) RETURNS varchar(50) CHARSET utf8
    DETERMINISTIC
BEGIN
DECLARE _ver INT DEFAULT fn_ult_version_proy(_proy) ;
DECLARE _fecini DATETIME ;
DECLARE _newfin DATETIME ;
DECLARE _newini DATETIME ;
DECLARE _return VARCHAR(50) ;
DECLARE _numtrim INT DEFAULT 1;
SELECT t02_fch_ini
  INTO _fecini
  FROM t02_dg_proy
 WHERE t02_cod_proy = _proy AND t02_version = _ver ;
 
 
SELECT  DATE_ADD(_fecini,INTERVAL ( (_anio-1)) + 1 YEAR ),
	DATE_ADD(_fecini,INTERVAL ((_anio -1 )) YEAR )
  INTO _newfin, _newini ;
SELECT CONCAT (fn_nom_mes(MONTH(_newini)) ," ", YEAR(_newini), ' - ', fn_nom_mes(MONTH(_newfin)) ," ", YEAR(_newfin) )
  INTO _return ;
 
RETURN _return ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nom_periodo_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_nom_periodo_entregable`(_proy VARCHAR(10), _ver INT, _anio INT, _mes INT) RETURNS varchar(50) CHARSET utf8
    DETERMINISTIC
BEGIN
    DECLARE _fecini DATE;
    DECLARE _fec_per_ini DATE;
    DECLARE _fec_per_fin DATE;
    DECLARE _return VARCHAR(50);
    DECLARE _anio_ant INT DEFAULT 0;
    DECLARE _entregable_ant INT DEFAULT 0;
    
    SELECT IFNULL(t02_mes, 0), t02_anio
    INTO _entregable_ant, _anio_ant
    FROM t02_entregable
    WHERE t02_cod_proy = _proy 
    AND t02_version = _ver
    AND DATE_ADD(DATE_ADD(NOW(), INTERVAL t02_anio YEAR), INTERVAL t02_mes MONTH) < DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _mes MONTH)
    ORDER BY t02_anio DESC, t02_mes DESC
    LIMIT 1;
    
    IF _anio_ant > 1 THEN
        SET _anio_ant = _anio_ant - 1;
    ELSE
        SET _anio_ant = 0;
    END IF;
    
    SELECT fn_fecha_inicio_proy(_proy, _ver) INTO _fecini;
    
    SET _fec_per_ini = DATE_ADD(_fecini, INTERVAL _anio_ant YEAR);
    SET _fec_per_ini = DATE_ADD(_fec_per_ini, INTERVAL _entregable_ant MONTH);
    SET _fec_per_fin = DATE_ADD(_fecini, INTERVAL (_anio - 1) YEAR);
    SET _fec_per_fin = DATE_ADD(_fec_per_fin, INTERVAL (_mes - 1) MONTH);
    
    SET _return = CONCAT(fn_nom_mes(MONTH(_fec_per_ini)), ' ', YEAR(_fec_per_ini), ' - ', fn_nom_mes(MONTH(_fec_per_fin)), ' ', YEAR(_fec_per_fin));
 
    RETURN _return;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nom_periodo_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nom_periodo_trim`(_proy VARCHAR(10) ,_trim INT) RETURNS varchar(50) CHARSET utf8
    DETERMINISTIC
BEGIN
DECLARE _ver INT DEFAULT fn_ult_version_proy(_proy) ;
DECLARE _fecini DATETIME ;
declare _newfin datetime ;
DECLARE _newini DATETIME ;
DECLARE _return VARCHAR(50) ;
DECLARE _numtrim INT DEFAULT 1;
SELECT t02_fch_ini
  INTO _fecini
  FROM t02_dg_proy
 WHERE t02_cod_proy = _proy AND t02_version = _ver ;
 
 
SELECT  DATE_ADD(_fecini,INTERVAL ( (_trim-1) * 3) + 2 MONTH ),
	DATE_ADD(_fecini,INTERVAL ((_trim -1 ) * 3) MONTH )
  into _newfin, _newini ;
select CONCAT (fn_nom_mes(MONTH(_newini)) ," ", YEAR(_newini), ' - ', fn_nom_mes(MONTH(_newfin)) ," ", YEAR(_newfin) )
  into _return ;
 
RETURN _return ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nro_proy_en_ejecucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nro_proy_en_ejecucion`(_inst int) RETURNS int(11)
    DETERMINISTIC
BEGIN
DECLARE _ret INT;
SELECT COUNT(1) 
  into _ret
  FROM t02_dg_proy p 
left join adm_tablas_aux e on (p.t02_estado=e.codi)
 WHERE p.t01_id_inst = _inst
   AND p.t02_version = fn_ult_version_proy(p.t02_cod_proy) 
   AND e.cod_ext  in ('0','1')  ;
  
RETURN _ret ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nro_proy_en_monitoreo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nro_proy_en_monitoreo`(_inst INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
DECLARE _ret INT;
SELECT COUNT(DISTINCT p.t02_cod_proy)
  INTO _ret
  FROM t02_dg_proy p 
LEFT JOIN adm_tablas_aux e ON (p.t02_estado=e.codi)
 WHERE  SUBSTRING_INDEX(t02_moni_ext,'.',1) = _inst 
   AND e.cod_ext  IN ('0','1')  ;
RETURN _ret ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_nro_visita_me_por_ejecutar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_nro_visita_me_por_ejecutar`(_proy VARCHAR(10)) RETURNS int(11)
    DETERMINISTIC
BEGIN
   declare _ret int ;
	SELECT  min(me.t31_id)
	  INTO  _ret
	  FROM  t31_plan_me me
	 WHERE  me.t02_cod_proy = _proy 
	   AND  me.t31_vb_v1 = '1'
	   and  me.t31_id not in (SELECT a.t31_id 
				    from t31_plan_me_aprob a 
				    LEFT JOIN t31_plan_me_aprob a2 ON (a.t02_cod_proy=a2.t02_cod_proy AND a.t31_id=a2.t31_id AND a2.t31_id_aprob=2) 
				   where a.t02_cod_proy = _proy
				     AND a.t31_id_aprob = 1
				     
				     AND CONCAT(ifnull(a.t31_tot_desemb,'0'), ifnull(a2.t31_tot_desemb,'0'))='11') ;
	
	RETURN IFNULL(_ret, 0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_numero_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_numero_anio`(`anioinicial` int,`mesinicial` int,`mesingresado` int) RETURNS int(11)
BEGIN
	declare _aniosalida int;
	declare _resultado double;
	declare _faltantes int;
	
	select (12-mesinicial+1)
	into _faltantes;
	select (mesingresado-_faltantes)/12
	into _resultado;
	
if _resultado<=0 THEN
	return anioinicial;
ELSEIF _resultado >0 and _resultado <= 1 THEN
	return anioinicial+1;
ELSE
	return anioinicial+2;
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_numero_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_numero_entregable`(_proy VARCHAR(10), 
    _ver INT, _anio INT, _entregable INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
    DECLARE _num INT DEFAULT 0;
    
    SELECT sb.num
    INTO _num
    FROM (SELECT t02_cod_proy, t02_version, t02_mes AS mes, @curRow:=@curRow+1 AS num, t02_anio AS anio
            FROM t02_entregable 
            JOIN (SELECT @curRow := 0) r 
            WHERE t02_cod_proy = _proy 
            AND t02_version  = _ver) AS sb
    WHERE sb.t02_cod_proy = _proy 
    AND sb.t02_version = _ver
    AND sb.anio = _anio
    AND sb.mes = _entregable;
    
    RETURN _num;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_numero_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_numero_mes`(_anio int, _mes int) RETURNS int(11)
    DETERMINISTIC
BEGIN
	declare _numes int;
	select (12 *(_anio -1)) + _mes
	into _numes ;
	
	return _numes;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_numero_meses_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_numero_meses_proy`(_proy varchar(10), _ver int) RETURNS int(11)
    DETERMINISTIC
BEGIN
	DECLARE _numes INT;
	SELECT	IFNULL(t02_num_mes,0) + IFNULL(t02_num_mes_amp, 0) INTO _numes 
	FROM	t02_dg_proy 
	WHERE	t02_cod_proy = _proy
		AND t02_version  = _ver;
	
	RETURN _numes;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_numero_mes_rev` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_numero_mes_rev`(_nummes INT, _tip INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
	DECLARE _anio INT;
	DECLARE _mes INT;
	
	
	IF _nummes <=12 THEN
	    SET _anio = 1;
	    SET _mes = _nummes ;
	ELSE
	    SET _anio = TRUNCATE((_nummes / 12 ),0)  ;
	    SET _anio = IF( (_nummes MOD 12)=0, _anio-1, _anio );
	    SET _mes = _nummes - (_anio*12) ;
	    SET _anio = _anio +1;
	END IF ;
			
	IF _tip = 1 THEN
	   RETURN _anio;
	END IF;
	
	IF _tip = 2 THEN
	   RETURN _mes ;
	END IF;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_numero_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_numero_trim`(_anio INT, _trim INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
	DECLARE _numtrim INT;
	SELECT (4 *(_anio -1)) + _trim
	INTO _numtrim ;
	
	RETURN _numtrim;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_numero_trim_rev` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_numero_trim_rev`(_numtrim INT, _tip INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
	declare _anio INT;
	declare _trim INT;
	
	
	if _numtrim <=4 then
	    set _anio = 1;
	    set _trim = _numtrim ;
	else
	    SET _anio = TRUNCATE((_numtrim / 4 ),0)  ;
	    SET _anio = IF( (_numtrim MOD 4)=0, _anio-1, _anio );
	    set _trim = _numtrim - (_anio*4) ;
	    set _anio = _anio +1;
	end if ;
			
	if _tip = 1 then
	   RETURN _anio;
	end if;
	
	IF _tip = 2 THEN
	   RETURN _trim ;
	END IF;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_aporte_fte_financ_equi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_aporte_fte_financ_equi`(_proy VARCHAR(10), 
						_anio INT,
						_idEqui INT,
						_fte  INT  ) RETURNS double
    DETERMINISTIC
BEGIN
	DECLARE _meta  DOUBLE;
	DECLARE _porc  DOUBLE;
	DECLARE _costo DOUBLE ;
	DECLARE _plan  DOUBLE ;
	DECLARE _ver   INT ; 
	
	SELECT fn_version_proy_poa(_proy, _anio) INTO _ver  ;
	
	SELECT SUM(t03_mta)
	  INTO _meta
	  FROM  t03_mp_equi_metas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t03_id_equi   = _idEqui
	  AND t03_anio     = _anio ;
     	
	SELECT t03_costo
	  INTO _costo
	  FROM  t03_mp_equi
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t03_id_equi   = _idEqui ;
        
	SELECT 	t03_porc
	  INTO  _porc 
	FROM 	t03_mp_equi_ftes 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t03_id_equi   = _idEqui
	  AND t03_id_inst  = _fte ;
	
	SELECT ((_meta * _costo)* (_porc/100)) INTO _plan ;
	
	RETURN IFNULL(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_aporte_fte_financ_pers` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_aporte_fte_financ_pers`(_proy VARCHAR(10), 
						_anio INT,
						_idPer int,
						_fte  int  ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	declare _ver   INT ; 
	
	select fn_version_proy_poa(_proy, _anio) into _ver  ;
	
	SELECT SUM(t03_mta)
	  INTO _meta
	  FROM  t03_mp_per_metas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t03_id_per   = _idPer
	  AND t03_anio     = _anio ;
     	
	select t03_remu_prom
	  into _costo
	  from  t03_mp_per
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t03_id_per   = _idPer ;
        
	SELECT 	t03_porc
	  into  _porc 
	FROM 	t03_mp_per_ftes 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t03_id_per   = _idPer
	  and t03_id_inst  = _fte ;
	
	select ((_meta * _costo)* (_porc/100)) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_aporte_fte_financ_rubro` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_aporte_fte_financ_rubro`(_proy VARCHAR(10), 
						_anio INT,
						_comp int,
						_act  int, 
						_sub  int,
						_cost int, 
						_fte  int  ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	declare _ver   INT ; 
	
	select fn_version_proy_poa(_proy, _anio) into _ver  ;
	
	SELECT SUM(t09_mta)
	  INTO _meta
	  FROM  t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub 
	  AND t09_anio     = _anio ;
     	
	select t10_cost_parc
	  into _costo
	  from  t10_cost_sub
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  and t08_cod_comp = _comp
	  and t09_cod_act  = _act
	  and t09_cod_sub  = _sub
	  and t10_cod_cost = _cost ;
        
	SELECT 	t10_porc
	  into  _porc 
	FROM 	t10_cost_fte 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub
	  AND t10_cod_cost = _cost 
	  and t10_cod_fte  = _fte ;
	
	select ((_meta * _costo)* (_porc/100)) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_aporte_fte_gast_func` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_aporte_fte_gast_func`(  _proy VARCHAR(10), 
						_anio INT,
						_part int,
						_gast  int, 
						_fte  int  ) RETURNS double
    DETERMINISTIC
BEGIN
	declare _meta  double;
	declare _porc  double;
	declare _costo double ;
	declare _plan  double ;
	declare _ver   INT ; 
	
	select fn_version_proy_poa(_proy, _anio) into _ver  ;
	
	SELECT SUM(t03_mta)
	  INTO _meta
	  FROM  t03_mp_gas_fun_metas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t03_partida  = _part
	  AND t03_anio     = _anio ;
     	
	select (t03_cant * t03_cu)
	  into _costo
	  from  t03_mp_gas_fun_cost
	where t02_cod_proy = _proy
	  and t02_version  = _ver 
	  AND t03_partida  = _part
	  and t03_id_gasto = _gast ;
        
	SELECT 	t03_porc
	  into  _porc 
	FROM 	t03_mp_gas_fun_ftes 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver 
	  AND t03_partida  = _part
	  AND t03_id_gasto = _gast 
	  and t03_id_inst  = _fte ;
	
	select ((_meta * _costo)* (_porc/100)) into _plan ;
	
	RETURN ifnull(_plan,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_ind_act_meta` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_ind_act_meta`(_proy VARCHAR(10), 
																	_ver	INT, 
																	_comp	INT,
																	_act	INT,
																	_ind	INT) RETURNS double
BEGIN
	DECLARE _meta DOUBLE ;
	
	SELECT t09_mta 
	INTO _meta
	FROM t09_act_ind
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver
	  AND t08_cod_comp = _comp
	  AND t09_cod_act = _act
	  AND t09_cod_act_ind  = _ind ;
	
  RETURN _meta ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_ind_act_meta_eje` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_ind_act_meta_eje`(_proy varchar(10),  _comp int, _ind  int,_anio int) RETURNS double
BEGIN
	DECLARE _avance DOUBLE ;
SELECT  SUM(inf.t09_ind_avanc)
into    _avance 
FROM 	   t09_act_ind_mtas_inf inf
WHERE inf.t02_cod_proy = _proy
  
  AND inf.t08_cod_comp = _comp
  AND inf.t09_cod_act = _ind
  AND inf.t09_ind_anio = _anio ;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_ind_comp_meta` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_ind_comp_meta`( _proy varchar(10), 
					   _ver   int, 
					   _comp int,
					   _ind  int
				          ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _meta DOUBLE ;
select t08_mta 
into _meta
from t08_comp_ind
where t02_cod_proy = _proy
  AND t02_version  = _ver
  and t08_cod_comp = _comp
  and t08_cod_comp_ind  = _ind ;
	
  RETURN _meta ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_ind_comp_meta_acum_ver_ant` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_ind_comp_meta_acum_ver_ant`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
DECLARE _ver INT ;
DECLARE _ver_ini INT DEFAULT 1 ;
	
SELECT  IFNULL(t02_version,'')
INTO    _ver 
FROM  t02_proy_version 
WHERE t02_cod_proy = _proy
  AND t02_tipo = 'POA'
  AND t02_anio = _anio;
SELECT  IFNULL( SUM(inf.t08_mta),'')
INTO    _avance 
FROM 	   t08_comp_ind inf
WHERE inf.t02_cod_proy = _proy
  AND inf.t02_version  < _ver
  AND inf.t02_version  > _ver_ini  
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_ind_comp_meta_eje` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_ind_comp_meta_eje`( _proy varchar(10), 
					    _comp int,
					    _ind  int,
					    _anio int
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT  SUM(inf.t08_ind_avanc)
into    _avance 
FROM 	   t08_comp_ind_inf inf
WHERE inf.t02_cod_proy = _proy
  
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind
  AND inf.t08_ind_anio = _anio ;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_ind_comp_meta_eje_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_ind_comp_meta_eje_acum`( _proy varchar(10), 
						 _comp int,
						 _ind  int,
						 _anio int
					       ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT  SUM(inf.t08_ind_avanc)
into    _avance 
FROM 	   t08_comp_ind_inf inf
WHERE inf.t02_cod_proy = _proy
  
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind
  AND inf.t08_ind_anio <= _anio ;
  
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_poa_ind_comp_meta_ver_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_poa_ind_comp_meta_ver_anual`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
DECLARE _ver INT ;
DECLARE _ver_ini INT DEFAULT 1 ;
	
SELECT  IFNULL(t02_version,'')
INTO    _ver 
FROM  t02_proy_version 
WHERE t02_cod_proy = _proy
  AND t02_tipo = 'POA'
  AND t02_anio = _anio;
SELECT  IFNULL( SUM(inf.t08_mta),'')
INTO    _avance 
FROM 	   t08_comp_ind inf
WHERE inf.t02_cod_proy = _proy
  AND inf.t02_version  = _ver
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porcentaje_acum_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porcentaje_acum_financ`(_proy VARCHAR(10),  _anio INT,   _mes INT) RETURNS double
BEGIN
	DECLARE _nummes INT;
	DECLARE cumplimiento DOUBLE ;
	DECLARE contador INT ;
SELECT fn_numero_mes(_anio, _mes) INTO _nummes ;
SELECT 		COUNT(*),SUM( ((CASE
						WHEN 
							IFNULL((fn_gasto_mensual_cto_fte(_proy, mta.t08_cod_comp, mta.t09_cod_act, mta.t09_cod_sub,_nummes, 0)/fn_presupuesto_financ(_proy, mta.t08_cod_comp, mta.t09_cod_act, mta.t09_cod_sub, mta.t02_version, _nummes))*100,0) > 100 
						THEN 100
						ELSE 
							IFNULL((fn_gasto_mensual_cto_fte(_proy, mta.t08_cod_comp, mta.t09_cod_act, mta.t09_cod_sub,_nummes, 0)/fn_presupuesto_financ(_proy, mta.t08_cod_comp, mta.t09_cod_act, mta.t09_cod_sub, mta.t02_version, _nummes))*100,0) 
						END
						)) ) INTO contador, cumplimiento
				
	  FROM t09_act_sub_mtas_inf mta 
    WHERE mta.t02_cod_proy = _proy
		AND mta.t02_version <= (_anio+1)
		AND mta.t02_version > 1	
		AND fn_numero_mes(mta.t09_sub_anio, mta.t09_sub_mes) <= _nummes;
	 
		
		
  
  RETURN ROUND((cumplimiento),2);
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_aporte_fte_costos_operativos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_aporte_fte_costos_operativos`( _proy varchar(10), 
							_ver int ,
							_comp int, 
							_act  int,
							_sub  int,
							_gast int,
							_fte  int 
						      ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _porc DOUBLE ;
declare _costo_total  double;
declare _aporte_total double;
SELECT 	t10_mont
  INTO  _aporte_total 
FROM 	t10_cost_fte 
WHERE t02_cod_proy = _proy
  AND t02_version  = _ver 
  AND t08_cod_comp = _comp
  AND t09_cod_act  = _act
  and t09_cod_sub  = _sub
  and t10_cod_cost = _gast 
  AND t01_id_inst  = _fte ;
SELECT c.t10_cost_tot
  INTO _costo_total
  FROM     t10_cost_sub c 
INNER JOIN t09_subact   p ON (c.t02_cod_proy = p.t02_cod_proy AND c.t02_version  = p.t02_version AND c.t08_cod_comp  = p.t08_cod_comp AND c.t09_cod_act=p.t09_cod_act AND c.t09_cod_sub=p.t09_cod_sub)
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver
  AND c.t08_cod_comp = _comp
  AND c.t09_cod_act  = _act
  AND c.t09_cod_sub  = _sub 
  AND c.t10_cod_cost = _gast ;
select ((_aporte_total / _costo_total)*100) into _porc;
  
  RETURN ifnull(_porc,0);
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_aporte_fte_equipamiento` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_aporte_fte_equipamiento`( _proy varchar(10), 
						   _ver int ,
						   _idEqui int, 
						   _fte  int 
					         ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _porc DOUBLE ;
declare _costo_total double;
declare _aporte_total double ;
SELECT t03_costo_tot
  INTO _costo_total
  FROM t03_mp_equi
WHERE  t02_cod_proy = _proy
   AND t02_version  = _ver 
   AND t03_id_equi   = _idEqui ;
SELECT 	t03_monto
  INTO  _aporte_total 
FROM 	t03_mp_equi_ftes 
WHERE t02_cod_proy = _proy
  AND t02_version  = _ver 
  AND t03_id_equi = _idEqui
  AND t03_id_inst  = _fte ;
  
select ((_aporte_total / _costo_total)*100) into _porc;
  RETURN ifnull(_porc,0);
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_aporte_fte_gastos_funcionamiento` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_aporte_fte_gastos_funcionamiento`( 	_proy varchar(10), 
								_ver int ,
								_part int, 
								_gast int,
								_fte  int 
							      ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _porc DOUBLE ;
declare _meta double ;
declare _costo_total double;
declare _aporte_total double ;
SELECT 	t03_monto
  INTO  _aporte_total 
FROM 	t03_mp_gas_fun_ftes 
WHERE t02_cod_proy = _proy
  AND t02_version  = _ver 
  AND t03_partida  = _part
  AND t03_id_gasto = _gast
  AND t03_id_inst  = _fte ;
SELECT ((c.t03_cant * c.t03_cu) * p.t03_meta)
  INTO _costo_total
  FROM     t03_mp_gas_fun_cost c
inner join t03_mp_gas_fun_part p on (c.t02_cod_proy=p.t02_cod_proy and c.t02_version=p.t02_version and c.t03_partida=p.t03_partida)
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver 
  AND c.t03_partida  = _part
  AND c.t03_id_gasto = _gast ;
select ((_aporte_total / _costo_total)*100) into _porc;
  RETURN ifnull(_porc,0);
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_aporte_fte_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_aporte_fte_personal`(     _proy  varchar(10), 
						   _ver   int ,
						   _idPer int, 
						   _fte   int 
					         ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _porc DOUBLE ;
declare _costo_total double;
declare _aporte_total double ;
SELECT t03_gasto_tot
  INTO _costo_total
  FROM t03_mp_per
WHERE  t02_cod_proy = _proy
   AND t02_version  = _ver 
   AND t03_id_per   = _idPer ;
   
SELECT 	t03_monto
  INTO  _aporte_total 
FROM 	t03_mp_per_ftes 
WHERE t02_cod_proy = _proy
  AND t02_version  = _ver 
  AND t03_id_per   = _idPer
  AND t03_id_inst  = _fte ;
  
select ((_aporte_total / _costo_total)*100) into _porc;
  RETURN ifnull(_porc,0);
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_cump_inf_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_cump_inf_mes`( 
					_proy VARCHAR(10), 
					_anio INT, 
					_mes INT
				      ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _porc DOUBLE ;
SELECT 
	AVG(
	    CASE WHEN ((IFNULL(inf.t09_sub_avanc,0)/IFNULL(mta.t09_mta,0))*100) > 100
	    THEN 100
	    ELSE ((IFNULL(inf.t09_sub_avanc,0)/IFNULL(mta.t09_mta,0))*100)
	    END 
	   ) 
	INTO _porc
FROM  	   t09_subact  sub
INNER JOIN t09_sub_act_mtas mta ON(sub.t02_cod_proy=mta.t02_cod_proy AND sub.t02_version=mta.t02_version  AND sub.t08_cod_comp=mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub=mta.t09_cod_sub)
LEFT  JOIN t09_act_sub_mtas_inf inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_act AND sub.t09_cod_sub=inf.t09_cod_sub AND inf.t09_sub_anio=mta.t09_anio AND inf.t09_sub_mes=mta.t09_mes)
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version = fn_ult_version_proy(sub.t02_cod_proy)
  AND mta.t09_anio=_anio
  AND mta.t09_mes=_mes
 
  ;
  
  RETURN ROUND(_porc,2);
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_cump_inf_mes_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_cump_inf_mes_acum`(_proy VARCHAR(10), _anio INT, _mes INT) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _porc DOUBLE ;
DECLARE counts DOUBLE;
DECLARE _porct DOUBLE ;
DECLARE version int;

	  
  SELECT  SUM(IF(inf.t09_sub_avanc/fn_mta_rprog_acum(_proy, _anio+1, _mes, _anio, inf.t08_cod_comp ,inf.t09_cod_act, inf.t09_cod_sub) > 1, 1,inf.t09_sub_avanc/fn_mta_rprog_acum(_proy, _anio+1, _mes, _anio, inf.t08_cod_comp ,inf.t09_cod_act, inf.t09_cod_sub))) into _porc 
			   FROM t09_act_sub_mtas_inf inf  
			   WHERE inf.t02_cod_proy = _proy
			   AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= fn_numero_mes(_anio,_mes);
				 
				 
SELECT COUNT(*) INTO counts
FROM (
	SELECT  CONCAT(inf.t08_cod_comp, '.', inf.t09_cod_act, '.',inf.t09_cod_sub)
			   FROM t09_act_sub_mtas_inf inf  
			   WHERE inf.t02_cod_proy = _proy
			   AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= fn_numero_mes(_anio,_mes)
				 
				GROUP BY CONCAT(inf.t08_cod_comp, '.', inf.t09_cod_act, '.',inf.t09_cod_sub)
) as temp1;
SELECT AVG(_porc/counts) INTO _porct;
  RETURN ROUND(_porct*100,2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_cump_inf_mes_tot` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_cump_inf_mes_tot`(_proy VARCHAR(10), _anio INT, _mes INT) RETURNS double
BEGIN
DECLARE _porc DOUBLE ;
DECLARE counts DOUBLE;
DECLARE _porct DOUBLE ;
DECLARE version int;
select fn_ult_version_proy(_proy) into version;

 SELECT  SUM(IF(inf.t09_sub_avanc/fn_mta_rprog_poa(_proy, version-1, version, inf.t08_cod_comp ,inf.t09_cod_act, inf.t09_cod_sub) > 1, 1, inf.t09_sub_avanc/fn_mta_rprog_poa(_proy, version-1, version, inf.t08_cod_comp ,inf.t09_cod_act, inf.t09_cod_sub))) into _porc 
			   FROM t09_act_sub_mtas_inf inf  
			   WHERE inf.t02_cod_proy = _proy
			   AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= fn_numero_mes(_anio,_mes);
				 
				 
SELECT COUNT(*) INTO counts
FROM (
	SELECT  CONCAT(inf.t08_cod_comp, '.', inf.t09_cod_act, '.',inf.t09_cod_sub)
			   FROM t09_act_sub_mtas_inf inf  
			   WHERE inf.t02_cod_proy = _proy
			   AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= fn_numero_mes(_anio,_mes)
				 
				GROUP BY CONCAT(inf.t08_cod_comp, '.', inf.t09_cod_act, '.',inf.t09_cod_sub)
) as temp1;
				 

  
SELECT AVG(_porc/counts) INTO _porct;
RETURN ROUND(_porct*100,2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_cump_inf_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_cump_inf_trim`( 
					_proy VARCHAR(10), 
					_anio INT, 
					_trim INT
				      ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _porc DOUBLE ;
DECLARE _mes INT;
DECLARE _num_mes INT;
SELECT (_trim * 3) INTO _mes ;
SELECT fn_numero_mes(_anio, _mes) INTO _num_mes ;
SELECT 	IFNULL(AVG(
	 CASE 
	 WHEN ((ejecutado_trim / planeado_trim)*100) > 100
	 THEN 100
	 ELSE ((ejecutado_trim / planeado_trim)*100)
	 END  
	),0) 
INTO _porc
FROM 
  (SELECT TRIM(CONCAT(sub.t08_cod_comp, '.', sub.t09_cod_act, '.', sub.t09_cod_sub)) AS codigo,
	 sub.t09_sub AS subactividad,
	 SUM(mta.t09_mta) AS planeado_trim,
	 sub.t09_um AS unidad_medida,
	 IFNULL((
	  SELECT SUM(inf.t09_sub_avanc) 
	    FROM t09_act_sub_mtas_inf inf  
	   WHERE mta.t02_cod_proy = inf.t02_cod_proy 
	     AND mta.t08_cod_comp = inf.t08_cod_comp 
	     AND mta.t09_cod_act = inf.t09_cod_act 
	     AND mta.t09_cod_sub = inf.t09_cod_sub
	     AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) > (_num_mes - 3) AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= _num_mes
	 ),0) AS ejecutado_trim
	FROM t09_subact sub
	INNER JOIN t09_sub_act_mtas mta ON (sub.t02_cod_proy = mta.t02_cod_proy  AND sub.t02_version = mta.t02_version AND sub.t08_cod_comp = mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub = mta.t09_cod_sub)
	WHERE sub.t02_cod_proy = _proy
	  AND sub.t02_version = fn_ult_version_proy(sub.t02_cod_proy)
	  AND mta.t09_mta >0
	  AND fn_numero_mes(mta.t09_anio, mta.t09_mes) > (_num_mes - 3) AND fn_numero_mes(mta.t09_anio, mta.t09_mes) <= _num_mes
	  
	GROUP BY 1,2,4 ) AS cuadro1 ;
  
  RETURN ROUND(_porc,2);
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_porc_cump_mes_acum_esp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_porc_cump_mes_acum_esp`(_proy VARCHAR(10), _anio INT, _mes INT, _comp INT, _act INT, _sub INT) RETURNS double
BEGIN
DECLARE _porc DOUBLE ;
DECLARE counts DOUBLE;
DECLARE _porct DOUBLE ;
DECLARE version int;

	  
  SELECT  SUM(inf.t09_sub_avanc/fn_mta_rprog_acum(_proy, _anio+1, _mes, _anio,_comp ,_act, _sub)) into _porc 
			   FROM t09_act_sub_mtas_inf inf  
			   WHERE inf.t02_cod_proy = _proy
			   AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= fn_numero_mes(_anio,_mes)
				 AND inf.t09_sub_avanc < fn_mta_rprog_acum(_proy, _anio+1, _mes, _anio,_comp ,_act, _sub);
				 
SELECT COUNT(*) INTO counts
FROM (
	SELECT  CONCAT(inf.t08_cod_comp, '.', inf.t09_cod_act, '.',inf.t09_cod_sub)
			   FROM t09_act_sub_mtas_inf inf  
			   WHERE inf.t02_cod_proy = _proy
			   AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= fn_numero_mes(_anio,_mes)
				 AND inf.t09_sub_avanc < fn_mta_rprog_acum(_proy, _anio+1, _mes, _anio,_comp ,_act, _sub)
				GROUP BY CONCAT(inf.t08_cod_comp, '.', inf.t09_cod_act, '.',inf.t09_cod_sub)
) as temp1;
SELECT AVG(_porc/counts) INTO _porct;
  RETURN ROUND(_porct*100,2);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_presupuesto_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_presupuesto_financ`(_proy VARCHAR(10), _comp INT, _act INT, _sub INT, _ver INT,  _nummes INT) RETURNS double
BEGIN
	DECLARE meta DOUBLE;
	DECLARE costo DOUBLE;
	SELECT SUM(t09_sub_avanc) INTO meta
	FROM t09_act_sub_mtas_inf 
	WHERE t02_cod_proy = _proy
  AND  t08_cod_comp = _comp
  AND t09_cod_act = _act
  AND t09_cod_sub = _sub
  AND fn_numero_mes(t09_sub_anio, t09_sub_mes) <= _nummes;
	SELECT IFNULL(SUM(t10_cost_parc),0) INTO costo
	FROM t10_cost_sub 
	WHERE t02_cod_proy = _proy
	AND t02_version = _ver
	AND t09_cod_act = _act
	AND t09_cod_sub = _sub
	AND t08_cod_comp = _comp;
	
	RETURN IFNULL(meta*costo,0);
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_pri_version_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_pri_version_proy`(_proy VARCHAR(10)) RETURNS int(11)
    DETERMINISTIC
BEGIN
	DECLARE _ver INT;
	SELECT MIN(t02_version) INTO _ver 
	FROM t02_dg_proy WHERE t02_cod_proy = _proy;
	
	return _ver ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_proy_order_by_anio_ini` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_proy_order_by_anio_ini`() RETURNS int(11)
BEGIN
	DECLARE max INT;
		SELECT MIN(YEAR(proy.t02_fch_ini)) INTO max
		FROM t02_dg_proy proy
		WHERE proy.t02_fch_ini <> '0000-00-00'
		ORDER BY proy.t02_fch_ini ASC;
	return max;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_proy_order_by_anio_ter` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_proy_order_by_anio_ter`() RETURNS int(11)
BEGIN
	DECLARE max INT;
	SELECT MAX(YEAR(proy.t02_fch_ter)) INTO max
		FROM t02_dg_proy proy
		WHERE proy.t02_fch_ini <> '0000-00-00'
		ORDER BY proy.t02_fch_ter DESC;
	return max;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_puntaje_califica_inf_monint` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_puntaje_califica_inf_monint`(_proy varchar(10), _id int, _vs int) RETURNS int(11)
    DETERMINISTIC
BEGIN
    declare _result int ;
    select (
		ifnull(ev1.cod_ext,0) + 
		IFNULL(ev2.cod_ext,0) + 
		IFNULL(ev3.cod_ext,0) + 
		IFNULL(ev4.cod_ext,0) +
		IFNULL(ev5.cod_ext,0) +
		IFNULL(ev6.cod_ext,0) +
		IFNULL(ev7.cod_ext,0)
	   )
    into _result
    from  t45_inf_mi mi
    left join adm_tablas_aux ev1 on (mi.t45_eva1=ev1.codi) 
    LEFT JOIN adm_tablas_aux ev2 ON (mi.t45_eva2=ev2.codi) 
    LEFT JOIN adm_tablas_aux ev3 ON (mi.t45_eva3=ev3.codi) 
    LEFT JOIN adm_tablas_aux ev4 ON (mi.t45_eva4=ev4.codi) 
    LEFT JOIN adm_tablas_aux ev5 ON (mi.t45_eva5=ev5.codi) 
    LEFT JOIN adm_tablas_aux ev6 ON (mi.t45_eva6=ev6.codi) 
    LEFT JOIN adm_tablas_aux ev7 ON (mi.t45_eva7=ev7.codi) 
    where mi.t02_cod_proy = _proy
      and mi.t45_id = _id
      and mi.t45_ver_inf = _vs ;
    
   return _result;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_puntaje_califica_inf_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_puntaje_califica_inf_se`(_proy VARCHAR(10), _anio INT, _entregable INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
    DECLARE _result INT;
    SELECT (
        IFNULL(ev1.cod_ext,0) + 
        IFNULL(ev2.cod_ext,0) + 
        IFNULL(ev3.cod_ext,0) + 
        IFNULL(ev4.cod_ext,0) +
        IFNULL(ev5.cod_ext,0) +
        IFNULL(ev6.cod_ext,0) +
        IFNULL(ev7.cod_ext,0)
       )
    INTO _result
    FROM  t30_inf_se me
    LEFT JOIN adm_tablas_aux ev1 ON (me.t30_crit_eva1=ev1.codi) 
    LEFT JOIN adm_tablas_aux ev2 ON (me.t30_crit_eva2=ev2.codi) 
    LEFT JOIN adm_tablas_aux ev3 ON (me.t30_crit_eva3=ev3.codi) 
    LEFT JOIN adm_tablas_aux ev4 ON (me.t30_crit_eva4=ev4.codi) 
    LEFT JOIN adm_tablas_aux ev5 ON (me.t30_crit_eva5=ev5.codi) 
    LEFT JOIN adm_tablas_aux ev6 ON (me.t30_crit_eva6=ev6.codi) 
    LEFT JOIN adm_tablas_aux ev7 ON (me.t30_crit_eva7=ev7.codi) 
    WHERE me.t02_cod_proy = _proy
    AND me.t02_anio = _anio
    AND me.t02_entregable = _entregable;
    
   RETURN _result;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_puntaje_califica_inf_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_puntaje_califica_inf_si`(_proy VARCHAR(10), _anio INT, _entregable INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
    DECLARE _result INT;
    SELECT (
        IFNULL(ev1.cod_ext,0) + 
        IFNULL(ev2.cod_ext,0) + 
        IFNULL(ev3.cod_ext,0) + 
        IFNULL(ev4.cod_ext,0) +
        IFNULL(ev5.cod_ext,0) +
        IFNULL(ev6.cod_ext,0) +
        IFNULL(ev7.cod_ext,0)
       )
    INTO _result
    FROM  t45_inf_si si
    LEFT JOIN adm_tablas_aux ev1 ON (si.t45_crit_eva1=ev1.codi) 
    LEFT JOIN adm_tablas_aux ev2 ON (si.t45_crit_eva2=ev2.codi) 
    LEFT JOIN adm_tablas_aux ev3 ON (si.t45_crit_eva3=ev3.codi) 
    LEFT JOIN adm_tablas_aux ev4 ON (si.t45_crit_eva4=ev4.codi) 
    LEFT JOIN adm_tablas_aux ev5 ON (si.t45_crit_eva5=ev5.codi) 
    LEFT JOIN adm_tablas_aux ev6 ON (si.t45_crit_eva6=ev6.codi) 
    LEFT JOIN adm_tablas_aux ev7 ON (si.t45_crit_eva7=ev7.codi) 
    WHERE si.t02_cod_proy = _proy
    AND si.t02_anio = _anio
    AND si.t02_entregable = _entregable;
    
   RETURN _result;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_puntaje_califica_inf_unico_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_puntaje_califica_inf_unico_anual`(_proy VARCHAR(10), _id INT) RETURNS int(11)
    DETERMINISTIC
BEGIN
    DECLARE _result INT ;
    SELECT (
		IFNULL(ev1.cod_ext,0) + 
		IFNULL(ev2.cod_ext,0) + 
		IFNULL(ev3.cod_ext,0) + 
		IFNULL(ev4.cod_ext,0) +
		IFNULL(ev5.cod_ext,0) +
		IFNULL(ev6.cod_ext,0) +
		IFNULL(ev7.cod_ext,0)
	   )
    INTO _result
    FROM  t55_inf_unico_anual iua
    LEFT JOIN adm_tablas_aux ev1 ON (iua.t55_eva1=ev1.codi) 
    LEFT JOIN adm_tablas_aux ev2 ON (iua.t55_eva2=ev2.codi) 
    LEFT JOIN adm_tablas_aux ev3 ON (iua.t55_eva3=ev3.codi) 
    LEFT JOIN adm_tablas_aux ev4 ON (iua.t55_eva4=ev4.codi) 
    LEFT JOIN adm_tablas_aux ev5 ON (iua.t55_eva5=ev5.codi) 
    LEFT JOIN adm_tablas_aux ev6 ON (iua.t55_eva6=ev6.codi) 
    LEFT JOIN adm_tablas_aux ev7 ON (iua.t55_eva7=ev7.codi) 
    WHERE iua.t02_cod_proy = _proy
      AND iua.t55_id = _id;
    
   RETURN _result;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_pwdusuario` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_pwdusuario`(_usr varchar(20)) RETURNS varchar(30) CHARSET utf8
    DETERMINISTIC
BEGIN
DECLARE _pwd VARCHAR(50) ;
DECLARE _pwdmd5 VARCHAR(100);
SELECT clave_user
  INTO _pwdmd5
  FROM adm_usuarios usu 
 WHERE usu.coduser=_usr ;
SELECT codigo
  INTO _pwd
  FROM adm_md5_pwd 
 WHERE codigomd5 = _pwdmd5 ;
	
return IFNULL(_pwd,'') ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_remun_prom_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` FUNCTION `fn_remun_prom_mes`(_basico double, _dedica double, _um INT) RETURNS double
    DETERMINISTIC
BEGIN
	DECLARE _remu  double;
	DECLARE _grati double;
	DECLARE _cts   double;
	DECLARE _ess   DOUBLE;
	declare _tipo  varchar(5);
	declare _return double;

	DECLARE _tasagrati double;	
	DECLARE _tasacts   double;
	DECLARE _tasaess   DOUBLE;
	
	select trim(cod_ext)
	into  _tipo 
	from  adm_tablas_aux
	where codi = _um ;



	SELECT t00_nom_lar into _tasagrati FROM t00_parametro WHERE t00_cod_param = 1;
	SELECT t00_nom_lar into _tasacts FROM t00_parametro WHERE t00_cod_param = 2;
	SELECT t00_nom_lar into _tasaess FROM t00_parametro WHERE t00_cod_param = 3;


	
	select (_basico * (_dedica/100)) , 0, 0, 0
	into _remu ,   _grati,   _cts,    _ess  ;
	
	if _tipo='1' then
		select 	(_remu / _tasagrati),
			(((_grati + _remu) * _tasacts)/100),
			(((_grati + _remu) * _tasaess)/100)
		into    _grati,
			_cts ,
			_ess ;
	end if;
	
	select (_remu + _grati + _cts + _ess)
	  into _return ;
	
	RETURN _return ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_replace_str_0` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_replace_str_0`(_texto varchar(200)) RETURNS varchar(200) CHARSET utf8
    DETERMINISTIC
BEGIN
declare _char int ;
declare _contador int default 1 ;
declare _return varchar(200) default '';
while _contador <= LENGTH(_texto) do
	select SUBSTRING(_texto,_contador,1) into _char ;
	select concat(_return,_char) into _return;
   set _contador=_contador+1;
end WHILE ;
return _return;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_saldo_categ_gasto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_saldo_categ_gasto`( _proy VARCHAR(10), 
					_comp INT, 
					_activ INT, 
					_subactiv INT,
					_cod_cat INT) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _return DOUBLE;
DECLARE _cod_fte  	INT DEFAULT 10 ;
DECLARE _anio  		INT ;
DECLARE _mes 		INT ;
DECLARE _ver  		INT ;
DECLARE _verIni 	INT DEFAULT 1;
DECLARE _ver_anio  	INT ;
DECLARE _total_ejec  	DOUBLE ;
DECLARE _fte_fe  	DOUBLE ;
SELECT SUM(gas.t41_gasto)
INTO	_total_ejec
FROM t41_inf_financ_gasto gas
WHERE gas.t02_cod_proy = _proy
  AND gas.t08_cod_comp=_comp 
  AND gas.t09_cod_act=_activ 
  AND gas.t09_cod_sub=_subactiv
  AND gas.t41_cate_gasto=_cod_cat 
  AND gas.t41_fte_finan=_cod_fte  ;
IF _comp <> 10 THEN
SELECT SUM(fte.t10_mont) 
  INTO _fte_fe
  FROM	t10_cost_fte fte 
INNER JOIN  t10_cost_sub cost2 ON (fte.t02_cod_proy = cost2.t02_cod_proy AND fte.t02_version=cost2.t02_version AND fte.t08_cod_comp = cost2.t08_cod_comp AND fte.t09_cod_act=cost2.t09_cod_act AND fte.t09_cod_sub= cost2.t09_cod_sub AND fte.t10_cod_cost=cost2.t10_cod_cost)
LEFT  JOIN  adm_tablas_aux cat ON (cost2.t10_cate_cost = cat.codi)
WHERE fte.t02_cod_proy = _proy
  AND fte.t02_version  = _verIni
  AND fte.t08_cod_comp = _comp
  AND fte.t09_cod_act  =_activ 
  AND fte.t09_cod_sub  = _subactiv 
  AND cat.cod_ext      = _cod_cat
  AND fte.t01_id_inst  = _cod_fte;  
END IF ;
IF _comp = 10 THEN
SELECT SUM(fte.t03_monto) 
  INTO _fte_fe
  FROM	t03_mp_equi_ftes fte 
WHERE fte.t02_cod_proy = _proy
  AND fte.t02_version  = _verIni
  AND fte.t03_id_equi = _cod_cat
  AND fte.t03_id_inst  = _cod_fte;  
END IF ;
  
SET _return = (_fte_fe - IFNULL(_total_ejec,0)) ;
RETURN IFNULL(_return, 0) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_supervision_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_supervision_anual`(_proy VARCHAR(10), _fte INT, _anio INT) RETURNS double
    DETERMINISTIC
BEGIN
 DECLARE _retMonto DOUBLE;
 DECLARE _numanios INT DEFAULT fn_duracion_proy(_proy, 1);
 DECLARE _nummeses INT DEFAULT fn_numero_meses_proy(_proy,1);
 DECLARE _aportemes DOUBLE;
  
 SELECT (IFNULL(sup.t03_monto,0) / _nummeses)
   INTO _aportemes
   FROM t03_mp_gas_supervision sup
  WHERE sup.t02_cod_proy = _proy
    AND sup.t03_id_inst = _fte
    AND sup.t02_version = 1;
 
 IF _anio = _numanios THEN
     IF _nummeses <  (_numanios * 12 ) THEN
        SET _retMonto = (_aportemes * ( _nummeses - ((_numanios-1) * 12 ) ) ) ;
     ELSE
        SET _retMonto = (_aportemes * 12 ) ;
     END IF ;
 ELSE
    SET _retMonto = (_aportemes * 12 ) ;
 END IF;
  RETURN _retMonto;
 END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_tipo_inst_rel_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_tipo_inst_rel_fe`( _codtipint VARCHAR(100)) RETURNS varchar(250) CHARSET utf8
    DETERMINISTIC
BEGIN
	DECLARE _return VARCHAR(250);
	
	SELECT GROUP_CONCAT(DISTINCT descrip ORDER BY orden SEPARATOR ', ')
	  INTO _return
	FROM adm_tablas_aux 
	WHERE idTabla = 29
	  AND _codtipint LIKE CONCAT('%',codi,'%') ;
	RETURN IFNULL(_return,'') ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_total_aporte_fuentes_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_total_aporte_fuentes_financ`(_proy VARCHAR(10), _ver INT, _fte int) RETURNS double
    DETERMINISTIC
BEGIN
declare _return double;
	
	
SELECT SUM(v.total_aporte)
  INTO  _return
FROM (
	SELECT SUM(IFNULL(t10_mont,0)) AS total_aporte
	  FROM t10_cost_fte 
	 WHERE t02_cod_proy = _proy
	   AND t02_version  = _ver 
	   AND t01_id_inst  = (CASE WHEN _fte=0 THEN t01_id_inst ELSE _fte END) 
	   
	UNION ALL 
	
	SELECT SUM(IFNULL(aporte_fuente,0)) AS total_aporte
	  FROM v_manejo_proyecto_fuentes 
	 WHERE proyecto = _proy
	   AND vs  = _ver 
	   AND idinst  = (CASE WHEN _fte=0 THEN idinst ELSE _fte END) 
	   AND actividad not in (4,5,6) 
     ) AS v ;	
	
    RETURN ifnull(_return,0) ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_total_aporte_fuentes_financ2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_total_aporte_fuentes_financ2`(_proy VARCHAR(10), _ver INT, _fte INT) RETURNS double
    DETERMINISTIC
BEGIN

	DECLARE _return DOUBLE;
	
	SELECT SUM(v.total_aporte)
	  INTO  _return
	FROM (
		SELECT SUM(IFNULL(t10_mont,0)) AS total_aporte
		  FROM t10_cost_fte 
		 WHERE t02_cod_proy = _proy
		   AND t02_version  = _ver 
		   AND t01_id_inst  = (CASE WHEN _fte=0 THEN t01_id_inst ELSE _fte END) 
		   
		UNION ALL 
		
		SELECT SUM(IFNULL(aporte_fuente,0)) AS total_aporte
		  FROM v_manejo_proyecto_fuentes 
		 WHERE proyecto = _proy
		   AND vs  = _ver 
		   AND idinst  = (CASE WHEN _fte=0 THEN idinst ELSE _fte END) 
		   and actividad <> 5 
	     ) AS v ;
	
	RETURN IFNULL(_return,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_total_aporte_fuentes_financ3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_total_aporte_fuentes_financ3`(_proy VARCHAR(10), _ver INT, _fte INT) RETURNS double
    DETERMINISTIC
BEGIN

	DECLARE _return DOUBLE;
	
	SELECT SUM(v.total_aporte)
	  into  _return
	FROM (
		SELECT SUM(IFNULL(t10_mont,0)) AS total_aporte
		  FROM t10_cost_fte 
		 WHERE t02_cod_proy = _proy
		   AND t02_version  = _ver 
		   AND t01_id_inst  = (CASE WHEN _fte=0 THEN t01_id_inst ELSE _fte END) 
		UNION ALL 
		SELECT SUM(IFNULL(aporte_fuente,0)) AS total_aporte
		  FROM v_manejo_proyecto_fuentes 
		 WHERE proyecto = _proy
		   AND vs  = _ver 
		   AND idinst  = (CASE WHEN _fte=0 THEN idinst ELSE _fte END) 
	     ) AS v ;
	
	RETURN IFNULL(_return,0) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_ult_version_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_ult_version_proy`(_proy VARCHAR(10)) RETURNS int(11)
    DETERMINISTIC
BEGIN
	DECLARE _ver INT;
	SELECT MAX(t02_version) INTO _ver 
	FROM t02_dg_proy WHERE t02_cod_proy = _proy;
	
	return _ver ;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_unico_anual_ind_comp_acumulado_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_unico_anual_ind_comp_acumulado_anual`( _proy VARCHAR(10), 
					    _comp INT,
					    _ind  INT,
					    _anio INT
				           ) RETURNS double
    DETERMINISTIC
BEGIN
DECLARE _avance DOUBLE ;
SELECT  SUM(inf.t08_ind_avanc)
INTO    _avance 
FROM 	   t08_comp_ind_inf inf
WHERE inf.t02_cod_proy = _proy
  
  AND inf.t08_cod_comp = _comp
  AND inf.t08_cod_comp_ind = _ind
  AND inf.t08_ind_anio < _anio ;
  RETURN _avance ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_verificar_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_verificar_anio`(_proy varchar(10), _ver int) RETURNS int(11)
    DETERMINISTIC
BEGIN
	declare _anio int;
	
	SELECT MAX(t02_anio) 
	  into _anio
	  FROM t02_proy_version 
	 WHERE t02_cod_proy = _proy
	   AND t02_version = _ver;
	
	return ifnull(_anio, -1 ) ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_verifica_url` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_verifica_url`(_url varchar(200)) RETURNS varchar(200) CHARSET utf8
    DETERMINISTIC
BEGIN
declare _protocol varchar(10);
DECLARE _newurl VARCHAR(200);
if ifnull(_url,'') = '' then
 return '' ;
end if;
IF length(_url) <= 5 THEN
 RETURN '' ;
END IF;
SELECT lower(SUBSTRING(_url, 1,INSTR(_url,'://')-1)) 
  into _protocol ;
IF _protocol='http' or _protocol='https' or _protocol='ftp' then
    return _url ;
else
     SELECT CONCAT('http://', _url ) into _newurl ;
     return _newurl  ;
end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `fn_version_proy_poa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `fn_version_proy_poa`(_proy VARCHAR(10), _anio int) RETURNS int(11)
    DETERMINISTIC
BEGIN 
	DECLARE _ver INT;
	
	SELECT MAX(t02_version) INTO _ver 
	FROM t02_proy_version 
	WHERE t02_cod_proy = _proy
	  and t02_tipo = 'POA'
	  AND t02_anio = _anio;
	 return _ver ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `total_eject_anio_pre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `total_eject_anio_pre`(_proy VARCHAR(10), _anio INT) RETURNS double
BEGIN
	DECLARE total_ejec double;
	SELECT SUM(gas.t41_gasto)
	INTO  total_ejec	
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=_proy
	       AND gas.t40_anio= _anio;
	RETURN ifnull(total_ejec,0);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP FUNCTION IF EXISTS `total_eject_periodo_pre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` FUNCTION `total_eject_periodo_pre`(
							pProy VARCHAR(10),
							pMesIni INT,
							pMesFin INT) RETURNS double
BEGIN
	DECLARE	aTotal DOUBLE;
	SELECT	SUM(gas.t41_gasto)
	INTO	aTotal
	FROM 	t41_inf_financ_gasto gas 
	WHERE	gas.t02_cod_proy = pProy
		AND fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN pMesIni AND pMesFin;
		
	RETURN aTotal;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_actualiza_gastos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_actualiza_gastos`(in _proy varchar(10), in _ver int, in _comp int, in _act int)
BEGIN
DECLARE _sub1 int;
DECLARE _sub2 INT;
DECLARE _sub3 INT;
DECLARE _cost1 INT;
DECLARE _cost2 INT;
declare _contador int ;
declare _count int ;
DECLARE _contador2 INT ;
DECLARE _count2 INT ;
declare _newcosteo int ;
declare _descrip VARCHAR(200) ; 
declare _categ INT ;
declare _um VARCHAR(50);
declare _cant	DOUBLE ; 
declare _cu	DOUBLE ;
DECLARE _usr    varchar(20);
CREATE TEMPORARY TABLE tmp_sub_a_distribuir 
( id INT AUTO_INCREMENT,
  proy VARCHAR(10),
  comp INT,
  act  INT,
  sub  INT,
  nomsub VARCHAR(250),
  numgastos INT,
  PRIMARY KEY (`id`)
) ;
CREATE TEMPORARY TABLE tmp_costos_a_trasladar
( id INT AUTO_INCREMENT,
  proy VARCHAR(10),
  comp INT,
  act  INT,
  sub  INT,
  gasto INT,
  nomgasto varchar(200),
  PRIMARY KEY (`id`)
) ;

INSERT INTO tmp_sub_a_distribuir(proy, comp, act, sub, nomsub, numgastos)
SELECT 	cost.t02_cod_proy,
	cost.t08_cod_comp,
	cost.t09_cod_act, 
	cost.t09_cod_sub,
	sub.t09_sub,
	COUNT(cost.t10_cod_cost) AS num_gastos
FROM       t10_cost_sub cost
INNER JOIN t09_subact    sub ON (cost.t02_cod_proy = sub.t02_cod_proy AND cost.t02_version=sub.t02_version AND cost.t08_cod_comp=sub.t08_cod_comp AND cost.t09_cod_act=sub.t09_cod_act AND cost.t09_cod_sub=sub.t09_cod_sub)
WHERE cost.t02_cod_proy = _proy 
  and cost.t02_version  = _ver
  AND cost.t08_cod_comp = _comp 
  and cost.t09_cod_act  = _act
GROUP BY cost.t02_cod_proy, cost.t08_cod_comp,cost.t09_cod_act, cost.t09_cod_sub, sub.t09_sub
HAVING COUNT(cost.t10_cod_cost) > 1 ;
select count(1) into _count from  tmp_sub_a_distribuir ;
select 1 into _contador ;
WHILE _count >= _contador DO
	
    SELECT sub into _sub1 
    FROM tmp_sub_a_distribuir where id = _contador ;
 
    DELETE FROM  tmp_costos_a_trasladar ;
    alter  table tmp_costos_a_trasladar auto_increment=0 ;
    
    insert into tmp_costos_a_trasladar( proy, comp, act, sub, gasto, nomgasto) 
    SELECT  cost.t02_cod_proy,
	    cost.t08_cod_comp,
	    cost.t09_cod_act, 
	    cost.t09_cod_sub,
	    cost.t10_cod_cost,
	    cost.t10_cost
	FROM       t10_cost_sub cost
	INNER JOIN t09_subact    sub ON (cost.t02_cod_proy = sub.t02_cod_proy AND cost.t02_version=sub.t02_version AND cost.t08_cod_comp=sub.t08_cod_comp AND cost.t09_cod_act=sub.t09_cod_act AND cost.t09_cod_sub=sub.t09_cod_sub)
	WHERE cost.t02_cod_proy = _proy 
	  and cost.t02_version  = _ver
	  AND cost.t08_cod_comp = _comp 
	  and cost.t09_cod_act  = _act 
	  and cost.t09_cod_sub  = _sub1 
	AND sub.t09_sub NOT LIKE CONCAT('%',cost.t10_cost) ;
      
     
     SELECT COUNT(1) INTO _count2 FROM  tmp_costos_a_trasladar ;
     SELECT 1 INTO _contador2 ;
     WHILE _count2 >= _contador2 DO
	 select sub, gasto, nomgasto
	 into _sub2, _cost2, _descrip
	 from tmp_costos_a_trasladar 
	 where id=_contador2 ;
	 
	select 0 into _sub3 ;
		
	SELECT  sub.t09_cod_sub 
	  into _sub3
	FROM  t09_subact    sub 
	WHERE sub.t02_cod_proy = _proy 
	  AND sub.t02_version = _ver
	  AND sub.t08_cod_comp = _comp 
	  AND sub.t09_cod_act  = _act
	  AND sub.t09_sub LIKE CONCAT('%',_descrip) ;
	
	if _sub3 > 0 then
	SELECT 	t10_cost, 
		t10_cate_cost, 
		t10_um, 
		t10_cant, 
		t10_cu, 
		usr_crea
	  into  _descrip, _categ, _um, _cant, _cu, _usr
	FROM t10_cost_sub 
	where t02_cod_proy = _proy 
	  AND t02_version  = _ver
	  AND t08_cod_comp = _comp 
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub2
	  and t10_cod_cost = _cost2	;
	 call sp_ins_costeo(_proy, _ver, _comp, _act, _sub3, _descrip, _categ, _um, _cant, _cu, _usr );
	 
	 
	 SELECT max(t10_cod_cost)
	   into _newcosteo 
	FROM t10_cost_sub 
	WHERE t02_cod_proy = _proy 
	  AND t02_version  = _ver
	  AND t08_cod_comp = _comp 
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub3 ;
	
	INSERT INTO t10_cost_fte (	
					t02_cod_proy, 		t02_version, 
					t08_cod_comp, 		t09_cod_act, 
					t09_cod_sub, 		t10_cod_cost, 
					t10_cod_fte, 		t01_id_inst, 
					t10_mont, 		usr_crea, fch_crea) 
			select 		t02_cod_proy, 		t02_version, 
					t08_cod_comp, 		t09_cod_act, 
					_sub3	, 		_newcosteo, 
					t10_cod_fte, 		t01_id_inst, 
					t10_mont, 		usr_crea, fch_crea
			 from   t10_cost_fte 
			 WHERE t02_cod_proy = _proy 
			   AND t02_version = _ver
			   AND t08_cod_comp = _comp 
			   AND t09_cod_act  = _act
			   AND t09_cod_sub  = _sub2
			   AND t10_cod_cost = _cost2	;
	
	delete FROM t10_cost_sub 
	WHERE t02_cod_proy = _proy 
	  AND t08_cod_comp = _comp 
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub2
	  AND t10_cod_cost = _cost2	;
	 
	end if;
	 
	SET _contador2 = _contador2 + 1;
     END WHILE;
     
    SET _contador = _contador + 1;
END WHILE;

DROP TEMPORARY TABLE tmp_sub_a_distribuir ;
drop TEMPORARY table tmp_costos_a_trasladar ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_aprueba_inf_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_aprueba_inf_trim`(
			IN _proy varchar(10), 
			IN _anio INT, 
			IN _trim INT, 
			in _verInf int,
			IN _coment text, 
			IN _usr varchar(20))
BEGIN
  update t25_inf_trim 
  set 	t25_apro_mt = '1', 
	t25_apro_fch = now(),
	t25_apro_txt = _coment,
	usr_actu = _usr, 
	fch_actu = now()
  where t02_cod_proy=_proy 
    and t25_anio=_anio 
    and t25_trim=_trim 
    and t25_ver_inf = _verInf;
	
select ROW_COUNT() as numrows, _verInf as codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_at_x_inf_tri` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_at_x_inf_tri`(IN _proy VARCHAR(10), IN _anio INT, IN _trim INT)
BEGIN
	SELECT	COUNT(*) AS capacitados
	FROM(	SELECT	plan.t11_cod_bene, SUM(plan.t15_avance) AS total
			FROM	t25_inf_trim_at plan
			WHERE	plan.t02_cod_proy = _proy AND plan.t25_anio = _anio AND plan.t25_trim = _trim
			GROUP BY plan.t11_cod_bene) t
	WHERE t.total > 0;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_bene_ubigeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_bene_ubigeo`(IN _proy VARCHAR(10) ,
				    IN _dpto char(2),
				    IN _prov CHAR(2),
				    in _dist char(2))
BEGIN
if _dpto='' and _prov='' and _dist='' then
	SELECT 	DISTINCT
		ben.t11_dpto  as iddpto,
		dpto.nom_ubig as dpto
	  FROM 	    t11_bco_bene ben
	inner join  adm_ubigeo   dpto on (ben.t11_dpto = dpto.cod_dpto and dpto.cod_prov='00' and dpto.cod_dist='00')
	 WHERE ben.t02_cod_proy=_proy
	ORDER BY ben.t11_dpto ASC;
end if ;
IF _dpto <> '' AND _prov='' AND _dist='' THEN
	SELECT 	DISTINCT
		ben.t11_prov  AS idprov,
		prov.nom_ubig AS prov
	  FROM 	    t11_bco_bene ben
	INNER JOIN  adm_ubigeo   prov ON (ben.t11_dpto = prov.cod_dpto AND ben.t11_prov=prov.cod_prov AND prov.cod_dist='00')
	 WHERE ben.t02_cod_proy= _proy 
	   and ben.t11_dpto    = _dpto ;
END IF ;
IF _dpto <> '' AND _prov <> '' AND _dist='' THEN
	SELECT 	DISTINCT
		ben.t11_dist  AS iddist,
		dist.nom_ubig AS dist
	  FROM 	    t11_bco_bene ben
	INNER JOIN  adm_ubigeo   dist ON (ben.t11_dpto = dist.cod_dpto AND ben.t11_prov=dist.cod_prov AND ben.t11_dist=dist.cod_dist)
	 WHERE ben.t02_cod_proy=_proy 
	   and ben.t11_dpto    = _dpto 
	   and ben.t11_prov    = _prov 
	union all
	 select '00'  AS iddist,
		'' AS dist ;
END IF ;
IF _dpto <> '' AND _prov <> '' and _dist <> '' THEN
	SELECT 	DISTINCT
		ben.t11_case  AS idcase,
		caser.nom_case AS caserio
	  FROM 	    t11_bco_bene ben
	INNER JOIN  adm_caserios caser ON (ben.t11_dpto = caser.cod_dpto AND ben.t11_prov=caser.cod_prov AND ben.t11_dist=caser.cod_dist AND ben.t11_case=caser.cod_case)
	 WHERE ben.t02_cod_proy= _proy 
	   AND ben.t11_dpto    = _dpto
	   AND ben.t11_prov    = _prov
	   and ben.t11_dist    = _dist 
	 UNION ALL
	 SELECT '00'  AS idcase,
		'' AS caserio ;
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_calcula_anios_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_calcula_anios_proy`(
										  IN _proy VARCHAR(10), 
										  IN _vs   INT
										)
BEGIN
DECLARE _num_anios INT ;
declare _duration int;
declare _contador int ;
select fn_duracion_proy(_proy, _vs) into _duration ;
select count(t02_anio) into _num_anios  from t02_duracion where t02_cod_proy=_proy and t02_version=_vs;
if (_duration > 0) and (_duration <> _num_anios) then	
	
	select 1 into _contador ;
	
	delete from t02_duracion WHERE t02_cod_proy=_proy AND t02_version=_vs ; 
	while _contador <= _duration do
		insert into t02_duracion(t02_cod_proy, t02_version, t02_anio, est_audi)
		                  values(_proy       , _vs        , _contador, '1');
		                  
		set _contador = _contador +1;    
	  
	end while;
	
end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_cambio_codigo_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_cambio_codigo_proyecto`(IN _codanterior VARCHAR(10), IN _codnuevo VARCHAR(10))
BEGIN
declare _log text  default '' ;
IF NOT EXISTS(SELECT * FROM t02_dg_proy  WHERE t02_cod_proy = _codnuevo) THEN 
SET AUTOCOMMIT=0;
START TRANSACTION ;

UPDATE t02_dg_proy 
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
set _log = concat(_log, '\n' ,'Actualizado Proyectos, ', ROW_COUNT());

UPDATE t02_fuente_finan 
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
SET _log = CONCAT(_log, '\n' ,'Actualizado Fuentes de Financiamiento, ', ROW_COUNT());

UPDATE t02_poa
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
SET _log = CONCAT(_log, '\n' ,'Actualizado POA, ', ROW_COUNT());

UPDATE t02_poa_anexos
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
SET _log = CONCAT(_log, '\n' ,'Actualizado POA - Anexos , ', ROW_COUNT());

UPDATE t02_proy_version
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;

UPDATE t02_sector_prod
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;

UPDATE t09_act_ind_inf_me
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t09_act_ind_inf_mi
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t09_act_ind_mtas_inf
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t09_act_sub_mtas_inf
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t09_act_sub_mtas_inf_me
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t09_act_sub_mtas_inf_mi
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t09_sub_act_plan
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t20_inf_mes
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t25_inf_trim
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t30_inf_me
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t32_plan_act
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t32_plan_vta
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t40_inf_financ
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t45_inf_mi
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t45_inf_mi_anexos
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t46_cron_visita_mi
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t50_plan_moni_ext
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t51_inf_mf
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
UPDATE t60_desembolsos
SET t02_cod_proy = _codnuevo
WHERE t02_cod_proy = _codanterior ;
commit ;
else
   IF EXISTS(SELECT * FROM t02_dg_proy  WHERE t02_cod_proy = _codanterior) THEN 
     set _log = 'El Codigo del Proyecto que intenta actualizar, ya existe !!!' ; 
   else
     SET _log = 'El Proyecto origen, no existe !!!' ; 
   end if ;
 
END IF ;
select _log as 'Resumen' ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_cap_x_inf_tri` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_cap_x_inf_tri`(IN _proy VARCHAR(10), IN _anio INT, IN _trim INT)
BEGIN
	SELECT COUNT(*) AS capacitados
	FROM (	SELECT	plan.t11_cod_bene, SUM(plan.t15_avance) AS total
			FROM	t25_inf_trim_capac plan
			WHERE	plan.t02_cod_proy = _proy AND plan.t25_anio = _anio AND plan.t25_trim = _trim
			GROUP BY plan.t11_cod_bene) AS t
	WHERE total > 0;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `SP_COMBINACIONES` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `SP_COMBINACIONES`( IN _numero int )
BEGIN
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_contactos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_contactos`()
BEGIN
	SELECT CONCAT(t01_id_inst, '.', t01_id_cto) as id, CONCAT(t01_ape_pat,' ',t01_ape_pat, ',', t01_nom_cto) as nombre
	FROM t01_inst_cto
	WHERE t01_cgo_cto = 60;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_contact_item` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_contact_item`(IN _inst INT, IN _cto INT)
BEGIN
	SELECT *
	FROM t01_inst_cto
	WHERE t01_cgo_cto = 60
	AND t01_id_inst = _inst
	AND t01_id_cto = _cto;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_copiar_ml_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_copiar_ml_proyecto`( 
						IN _proy VARCHAR(10), 
						in _newProy VARCHAR(10),
						IN _usr VARCHAR(20) 
					)
trans1 : BEGIN
DECLARE _ver INT default 1;
DECLARE _saltolinea VARCHAR(2) default "\n";
DECLARE _log TEXT default " " ;
 
 SET AUTOCOMMIT=0;
 START TRANSACTION ;
 
  SELECT concat('Copiar ML del Proyecto ', _proy, ' al Proyecto ', _newProy ) INTO _log ;
 
    if not exists( SELECT t02_cod_proy FROM t02_dg_proy where t02_cod_proy=_newProy) then
	   
	   INSERT INTO t02_dg_proy(t02_cod_proy, 	t02_version, 	t02_nro_exp, 	t01_id_inst, 	t02_nom_proy, 	t02_fch_apro, 	t02_fch_ini, 	t02_fch_ter, 	t02_fin, 	t02_pro, 	t02_ben_obj, 	t02_amb_geo, t02_sect_prod, t02_subsect_prod,	t02_pres_fe, 	t02_pres_eje, 	t02_pres_otro, 	t02_pres_tot, 	t02_moni_tema, 	t02_moni_fina, 	t02_moni_ext, 	t02_sup_inst, 	t02_dire_proy, 	t02_ciud_proy, 	t02_tele_proy, 	t02_fax_proy, 	t02_mail_proy, 	t02_estado, 	t02_mto_line_base, 	t02_mto_imprevisto, 	t02_est_imp, t02_cre_fe, t02_fch_isc, t02_fch_ire, t02_fch_tre, t02_fch_tam, t02_num_mes, usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
			    SELECT _newProy, 	_ver	   , 	t02_nro_exp, 	t01_id_inst, 	t02_nom_proy, 	t02_fch_apro, 	t02_fch_ini, 	t02_fch_ter, 	t02_fin, 	t02_pro, 	t02_ben_obj, 	t02_amb_geo, t02_sect_prod, t02_subsect_prod,	t02_pres_fe, 	t02_pres_eje, 	t02_pres_otro, 	t02_pres_tot, 	t02_moni_tema, 	t02_moni_fina, 	t02_moni_ext, 	t02_sup_inst, 	t02_dire_proy, 	t02_ciud_proy, 	t02_tele_proy, 	t02_fax_proy, 	t02_mail_proy, 	t02_estado, 	t02_mto_line_base, 	t02_mto_imprevisto, 	t02_est_imp, t02_cre_fe, t02_fch_isc, t02_fch_ire, t02_fch_tre, t02_fch_tam, t02_num_mes, _usr    , 	NOW()   , 	NULL    , 	NOW()   , 	est_audi	
						FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
	   SELECT CONCAT(_log, _saltolinea, 'Copiado Proyectos "t02_dg_proy" - Registros:', ROW_COUNT()) INTO _log;
	   
	 
	    
	   INSERT INTO t02_duracion(t02_cod_proy, 	t02_version, 	t02_anio)
						SELECT _newProy, 	_ver    , 	t02_anio	
						FROM t02_duracion WHERE t02_cod_proy=_proy AND t02_version=_ver;
	   SELECT CONCAT(_log, _saltolinea, 'Copiado Años de Duracion "t02_duracion" - Registros:', ROW_COUNT()) INTO _log;
    END IF ;
    
   INSERT INTO t03_dist_proy(t02_cod_proy, 	t02_version, 	t03_dpto, t03_prov, 	t03_dist, 	t03_obs, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
		    SELECT _newProy, 	_ver	   , 	t03_dpto, t03_prov, 	t03_dist, 	t03_obs, 	_usr    , 	NOW()   , 	NULL    , 	NOW()   , 	est_audi	
					FROM t03_dist_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Distribucion Geografica del Proyecto "t03_dist_proy" - Registros:', ROW_COUNT()) INTO _log;
   INSERT INTO t02_proy_anx(t02_cod_proy,	t02_version,	t02_cod_anx, 	t02_nom_file, 	t02_url_file, 	t02_desc_file, 	t02_anx_tip_cod, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
		    SELECT _newProy, 	_ver	   , 	t02_cod_anx, 	t02_nom_file, 	t02_url_file, 	t02_desc_file, 	t02_anx_tip_cod,	_usr    , 	NOW()   , 	NULL    , 	NOW()   , 	est_audi	
					FROM t02_proy_anx WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Anexos del Proyecto "t02_proy_anx" - Registros:', ROW_COUNT()) INTO _log;
   

   
   INSERT INTO t06_fin_ind(t02_cod_proy, 	t02_version, 	t06_cod_fin_ind, 	t06_ind, 	t06_um, 	t06_mta, 	t06_fv, 	t06_obs, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				    SELECT _newProy, 	_ver    , 	t06_cod_fin_ind, 	t06_ind, 	t06_um, 	t06_mta, 	t06_fv, 	t06_obs, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				      FROM t06_fin_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Finalidad "t06_fin_ind" - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t06_fin_sup(t02_cod_proy, 	t02_version, 	t06_cod_fin_sup, 	t06_sup, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				    SELECT _newProy, 	_ver    , 	t06_cod_fin_sup, 	t06_sup, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				      FROM t06_fin_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Finalidad "t06_fin_sup" - Registros:', ROW_COUNT()) INTO _log;

   
   INSERT INTO t07_prop_ind(t02_cod_proy, 	t02_version, 	t07_cod_prop_ind, 	t07_ind, 	t07_um, 	t07_mta, 	t07_fv, 	t07_obs, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				     SELECT _newProy, 	_ver    , 	t07_cod_prop_ind, 	t07_ind, 	t07_um, 	t07_mta, 	t07_fv, 	t07_obs, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				       FROM t07_prop_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Proposito "t07_prop_ind" - Registros:', ROW_COUNT()) INTO _log;   
   
   INSERT INTO t07_prop_sup(t02_cod_proy, 	t02_version, 	t07_cod_prop_sup, 	t07_sup, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				     SELECT _newProy, 	_ver    , 	t07_cod_prop_sup, 	t07_sup, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				       FROM t07_prop_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Proposito "t07_prop_sup" - Registros:', ROW_COUNT()) INTO _log;
   

   INSERT INTO t08_comp(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t08_comp_desc, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
		   SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t08_comp_desc, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				   FROM t08_comp WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Componentes "t08_comp" - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t08_comp_ind(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t08_cod_comp_ind, 	t08_ind, 	t08_um, 	t08_mta, 	t08_fv, 	t08_obs, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, est_audi)
				     SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t08_cod_comp_ind, 	t08_ind, 	t08_um, 	t08_mta, 	t08_fv, 	t08_obs, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , est_audi
				       FROM t08_comp_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Componentes "t08_comp_ind" - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t08_comp_sup(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t08_cod_comp_sup, 	t08_sup, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, est_audi)
				     SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t08_cod_comp_sup, 	t08_sup, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , est_audi
				       FROM t08_comp_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Componentes "t08_comp_sup" - Registros:', ROW_COUNT()) INTO _log;

   INSERT INTO t09_act(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t09_cod_act, 	t09_act, 	t09_obs, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				 SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t09_cod_act, 	t09_act, 	t09_obs, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , est_audi
				   FROM t09_act WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Actividades "t09_act" - Registros:', ROW_COUNT()) INTO _log;
   
   
   INSERT INTO t09_act_ind(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t09_cod_act, 	t09_cod_act_ind, 	t09_ind, 	t09_um, 	t09_mta, 	t09_fv, 	t09_obs, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				 SELECT t02_cod_proy   , 	_ver   , 	t08_cod_comp, 	t09_cod_act, 	t09_cod_act_ind, 	t09_ind, 	t09_um, 	t09_mta, 	t09_fv, 	t09_obs, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , est_audi
				   FROM t09_act_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Actividad "t09_act_ind" - Registros:', ROW_COUNT()) INTO _log;
   
   
   INSERT INTO t09_act_ind_mtas(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t09_cod_act, 	t09_cod_act_ind, 	t09_ind_anio, 	t09_ind_mes, 	t09_ind_mta, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, est_audi)
			 SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t09_cod_act, 	t09_cod_act_ind, 	t09_ind_anio, 	t09_ind_mes, 	t09_ind_mta, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , est_audi
		           FROM t09_act_ind_mtas WHERE t02_cod_proy=_proy AND t02_version=_ver;
				           
   SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Indicadores de Actividad "t09_act_ind_mtas" - Registros:', ROW_COUNT()) INTO _log;   
   
   

   INSERT INTO t09_subact(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t09_sub, 	t09_um, 	t09_mta, 	t09_fv, 	t09_tipo_sub, 	t09_act_crit, 	t09_obs, 	fch_crea, 	usr_crea, 	usr_actu, 	fch_actu, 	est_audi)
				   SELECT _newProy, 	_ver   , 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t09_sub, 	t09_um, 	t09_mta, 	t09_fv, 	t09_tipo_sub, 	t09_act_crit, 	t09_obs, 	NOW()   , 	_usr    , 	NULL    , 	NULL    , 	est_audi
				   FROM t09_subact WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado SubActividades "t09_subact" - Registros:', ROW_COUNT()) INTO _log;
   

   INSERT INTO t09_sub_act_mtas(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t09_cod_mta, 	t09_anio, 	t09_mes, 	t09_mta, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				         SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t09_cod_mta, 	t09_anio, 	t09_mes, 	t09_mta, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				           FROM t09_sub_act_mtas 
				           WHERE t02_cod_proy=_proy AND t02_version=_ver ;			           
				        
   SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de SubActividades "t09_sub_act_mtas" - Registros:', ROW_COUNT()) INTO _log;

   INSERT INTO t10_cost_sub(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t10_cod_cost, 	t10_cost, 	t10_cate_cost, 	t10_um, 	t10_cant, 	t10_cu, 	t10_cost_parc, 	t10_cost_tot, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				     SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t10_cod_cost, 	t10_cost, 	t10_cate_cost, 	t10_um, 	t10_cant, 	t10_cu, 	t10_cost_parc, 	t10_cost_tot, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				       FROM t10_cost_sub WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Costeo de SubActividades "t10_cost_sub" - Registros:', ROW_COUNT()) INTO _log;
   

   INSERT INTO t10_cost_fte(t02_cod_proy, 	t02_version, 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t10_cod_cost, 	t10_cod_fte, 	t01_id_inst, 	t10_mont,   t10_porc, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
		     SELECT _newProy, 	_ver    , 	t08_cod_comp, 	t09_cod_act, 	t09_cod_sub, 	t10_cod_cost, 	t10_cod_fte, 	t01_id_inst, 	t10_mont,   t10_porc,	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				       FROM t10_cost_fte WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Aportes x Fuentes de Financiamiento "t10_cost_fte" - Registros:', ROW_COUNT()) INTO _log;

   INSERT INTO t03_mp_per  (t02_cod_proy, t02_version, t03_id_per, t03_nom_per, t03_tdr, t03_tdr_file, t03_um, t03_dedica, 
							t03_remu, t03_perma, t03_remu_prom, t03_gasto_tot, usr_crea, fch_crea, usr_actu, fch_actu, est_audi, 
							t03_mta_proy, t03_mta_repro)
			SELECT _newProy,      	_ver    , 	t03_id_per, 	t03_nom_per, 	t03_tdr, 	t03_tdr_file, t03_um, t03_dedica, 
					t03_remu, 	t03_perma, 	t03_remu_prom, 	t03_gasto_tot, 	_usr , 	NOW(), 	NULL    , 	NULL    , 	est_audi, 
					t03_mta_proy, t03_mta_repro
            FROM  t03_mp_per WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Personal "t03_mp_per" - Registros:', ROW_COUNT()) INTO _log;
                              
   INSERT INTO t03_mp_per_metas (t02_cod_proy, 	t02_version, 	t03_id_per, 	t03_anio, 	t03_mes, 	t03_mta, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				         SELECT _newProy,      	_ver    , 	t03_id_per, 	t03_anio, 	t03_mes, 	t03_mta, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
                           FROM  t03_mp_per_metas 
                           WHERE t02_cod_proy=_proy AND t02_version=_ver  ;
                           
   SELECT CONCAT(_log, _saltolinea, 'Copiado Metas del Personal "t03_mp_per_metas" - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t03_mp_per_ftes (t02_cod_proy, 	t02_version, 	t03_id_per, 	t03_id_inst, 	t03_monto  , t03_porc 	, usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
			SELECT _newProy,      	_ver    , 	t03_id_per, 	t03_id_inst, 	t03_monto  , t03_porc	, _usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
                          FROM  t03_mp_per_ftes WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes de Financiamiento del Personal "t03_mp_per_ftes" - Registros:', ROW_COUNT()) INTO _log;

   INSERT INTO t03_mp_equi 	(t02_cod_proy, t02_version, t03_id_equi, t03_nom_equi, t03_um, t03_cu, t03_cant, t03_costo, 
							t03_costo_tot, usr_crea, fch_crea, usr_actu, fch_actu, est_audi, t03_mta_proy, t03_mta_repro)
			SELECT _newProy,   _ver    , 	t03_id_equi, 	t03_nom_equi,    t03_um, t03_cu, t03_cant, 	t03_costo, 	
					t03_costo_tot, 	_usr, NOW(), NULL, NULL, est_audi, t03_mta_proy, t03_mta_repro
                       FROM t03_mp_equi  WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Equipamiento "t03_mp_equi" - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t03_mp_equi_metas (t02_cod_proy, 	t02_version, 	t03_id_equi, 	t03_anio, 	t03_mes, 	t03_mta, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				          SELECT _newProy,      	_ver   , 	t03_id_equi, 	t03_anio, 	t03_mes, 	t03_mta, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
                            FROM  t03_mp_equi_metas 
                           WHERE t02_cod_proy=_proy AND t02_version=_ver  ;
                           
   SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Equipamiento "t03_mp_equi_metas" - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t03_mp_equi_ftes (t02_cod_proy, 	t02_version, 	t03_id_equi, 	t03_id_inst, 	t03_monto,  t03_porc,	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
			SELECT _newProy,         _ver    , 	t03_id_equi, 	t03_id_inst, 	t03_monto,  t03_porc,	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
                          FROM  t03_mp_equi_ftes WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes de Financiamiento de Equipamiento "t03_mp_equi_ftes" - Registros:', ROW_COUNT()) INTO _log;

   
   INSERT INTO t03_mp_gas_fun_part(t02_cod_proy, t02_version, t03_partida, t03_um, t03_meta, usr_crea, fch_crea, 
									usr_actu, fch_actu, est_audi, t03_mta_proy, t03_mta_repro)
				 SELECT _newProy, 	_ver, 	t03_partida, 	t03_um, 	t03_meta, 	_usr, 	NOW(), 	
									NULL, 	NULL, 	est_audi, t03_mta_proy, t03_mta_repro
				      FROM t03_mp_gas_fun_part WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Partidas "t03_mp_gas_fun_part" - Registros:', ROW_COUNT()) INTO _log;
      
   INSERT INTO t03_mp_gas_fun_metas (t02_cod_proy, 	t02_version, 	t03_partida, 	t03_anio, 	t03_mes, 	t03_mta, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				              SELECT _newProy, 	_ver   , 	t03_partida, 	t03_anio, 	t03_mes, 	t03_mta, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				                FROM t03_mp_gas_fun_metas   
				               WHERE t02_cod_proy=_proy AND t02_version=_ver  ;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Partidas de Gastos "t03_mp_gas_fun_metas " - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t03_mp_gas_fun_cost (t02_cod_proy, 	t02_version, 	t03_partida, 	t03_id_gasto, 	t03_descrip, 	t03_um, 	t03_cu, 	t03_cant, 	t03_cat_gast, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
				              SELECT _newProy, 	_ver    , 	t03_partida, 	t03_id_gasto, 	t03_descrip, 	t03_um, 	t03_cu, 	t03_cant, 	t03_cat_gast, 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				                FROM t03_mp_gas_fun_cost  WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Costos de Funcionamiento "t03_mp_gas_fun_cost " - Registros:', ROW_COUNT()) INTO _log;
   
   INSERT INTO t03_mp_gas_fun_ftes (t02_cod_proy, 	t02_version, 	t03_partida, 	t03_id_gasto, 	t03_id_inst, 	t03_monto, t03_porc,	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
			     SELECT _newProy, 	_ver    , 	t03_partida, 	t03_id_gasto, 	t03_id_inst, 	t03_monto, t03_porc,	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
				                FROM t03_mp_gas_fun_ftes  WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes Financ - Costos de Funcionamiento "t03_mp_gas_fun_ftes " - Registros:', ROW_COUNT()) INTO _log;

   INSERT INTO t03_mp_gas_adm(t02_cod_proy, 	t02_version, 	t03_id_inst, 	t03_monto, 	usr_crea, 	fch_crea, 	usr_actu, 	fch_actu, 	est_audi)
		       SELECT _newProy, 	_ver    , 	t03_id_inst, 	0	 , 	_usr    , 	NOW()   , 	NULL    , 	NULL    , 	est_audi
		         FROM t03_mp_gas_adm WHERE t02_cod_proy=_proy AND t02_version=_ver;
   SELECT CONCAT(_log, _saltolinea, 'Copiado Costos Administrativos "t03_mp_gas_adm" - Registros:', ROW_COUNT()) INTO _log;

CALL sp_poa_actualiza_presupuesto(_newProy, _ver) ;
COMMIT ;
SELECT '' AS msg, _log AS 'Log Generado' ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_cred_x_inf_tri` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_cred_x_inf_tri`(IN _proy VARCHAR(10), IN _anio INT, IN _trim INT)
BEGIN
	SELECT	COUNT(*) AS capacitados
	FROM(	SELECT	plan.t11_cod_bene, SUM(plan.t15_avance) AS total
			FROM	t25_inf_trim_cred plan
			WHERE	plan.t02_cod_proy = _proy AND plan.t25_anio = _anio AND plan.t25_trim = _trim
			GROUP BY plan.t11_cod_bene) t
	WHERE t.total > 0;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_delete_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_delete_proy`(IN _proy VARCHAR(10), IN _vs INT)
BEGIN
declare numrows int;
DELETE from t09_act WHERE t09_act.t02_cod_proy = _proy;
DELETE from t08_comp WHERE t08_comp.t02_cod_proy = _proy;
DELETE from t02_dg_proy WHERE t02_dg_proy.t02_cod_proy = _proy;
DELETE from t02_tasas_proy WHERE t02_tasas_proy.t02_cod_proy = _proy;
DELETE from t02_fuente_finan WHERE t02_fuente_finan.t02_cod_proy = _proy;
DELETE from t02_aprob_proy WHERE t02_aprob_proy.t02_cod_proy = _proy;
DELETE from t02_sector_prod WHERE t02_sector_prod.t02_cod_proy = _proy;
DELETE from t02_carta_fianza WHERE t02_carta_fianza.t02_cod_proy = _proy;
DELETE from t02_duracion WHERE t02_duracion.t02_cod_proy = _proy;

DELETE from t02_entregable WHERE t02_cod_proy = _proy;
DELETE from t02_entregable_act_ind WHERE t02_cod_proy = _proy;
DELETE from t02_entregable_act_ind_car WHERE t02_cod_proy = _proy;
DELETE from t02_suspenciones WHERE t02_cod_proy = _proy;

DELETE from t02_noobjecion_compra WHERE t02_noobjecion_compra.t02_cod_proy = _proy;
DELETE from t02_noobjecion_compra_anx WHERE t02_noobjecion_compra_anx.t02_cod_proy = _proy;
DELETE from t02_poa WHERE t02_poa.t02_cod_proy = _proy;
DELETE from t02_poa_anexos WHERE t02_poa_anexos.t02_cod_proy = _proy;
DELETE from t02_proy_anx WHERE t02_proy_anx.t02_cod_proy = _proy;
DELETE from t02_proy_ctas WHERE t02_proy_ctas.t02_cod_proy = _proy;
DELETE from t02_proy_version WHERE t02_proy_version.t02_cod_proy = _proy;
DELETE from t03_dist_proy WHERE t03_dist_proy.t02_cod_proy = _proy;
DELETE from t03_mp_equi WHERE t03_mp_equi.t02_cod_proy = _proy;
DELETE from t03_mp_equi_ftes WHERE t03_mp_equi_ftes.t02_cod_proy = _proy;
DELETE from t03_mp_equi_metas WHERE t03_mp_equi_metas.t02_cod_proy = _proy;
DELETE from t03_mp_gas_adm WHERE t03_mp_gas_adm.t02_cod_proy = _proy;
DELETE from t03_mp_gas_fun_cost WHERE t03_mp_gas_fun_cost.t02_cod_proy = _proy;
DELETE from t03_mp_gas_fun_ftes WHERE t03_mp_gas_fun_ftes.t02_cod_proy = _proy;
DELETE from t03_mp_gas_fun_metas WHERE t03_mp_gas_fun_metas.t02_cod_proy = _proy;
DELETE from t03_mp_gas_fun_part WHERE t03_mp_gas_fun_part.t02_cod_proy = _proy;
DELETE from t03_mp_imprevistos WHERE t03_mp_imprevistos.t02_cod_proy = _proy;
DELETE from t03_mp_linea_base WHERE t03_mp_linea_base.t02_cod_proy = _proy;
DELETE from t03_mp_per WHERE t03_mp_per.t02_cod_proy = _proy;
DELETE from t03_mp_per_ftes WHERE t03_mp_per_ftes.t02_cod_proy = _proy;
DELETE from t03_mp_per_metas WHERE t03_mp_per_metas.t02_cod_proy = _proy;
DELETE from t04_equi_proy WHERE t04_equi_proy.t02_cod_proy = _proy;
DELETE from t04_sol_cambio_per WHERE t04_sol_cambio_per.t02_cod_proy = _proy;
DELETE from t06_fin_ind WHERE t06_fin_ind.t02_cod_proy = _proy;
DELETE from t06_fin_sup WHERE t06_fin_sup.t02_cod_proy = _proy;
DELETE from t07_prop_ind WHERE t07_prop_ind.t02_cod_proy = _proy;
DELETE from t07_prop_ind_inf WHERE t07_prop_ind_inf.t02_cod_proy = _proy;
DELETE from t07_prop_sup WHERE t07_prop_sup.t02_cod_proy = _proy;
DELETE from t08_comp_ind WHERE t08_comp_ind.t02_cod_proy = _proy;
DELETE from t08_comp_ind_inf WHERE t08_comp_ind_inf.t02_cod_proy = _proy;

DELETE from t08_comp_ind_inf_se WHERE t02_cod_proy = _proy;
DELETE from t08_comp_ind_inf_si WHERE t02_cod_proy = _proy;

DELETE from t08_comp_sup WHERE t08_comp_sup.t02_cod_proy = _proy;
DELETE from t09_act_ind WHERE t09_act_ind.t02_cod_proy = _proy;

DELETE from t09_act_ind_car WHERE t02_cod_proy = _proy;
DELETE from t09_act_ind_car_ctrl WHERE t02_cod_proy = _proy;
DELETE from t09_entregable_ind_inf WHERE t02_cod_proy = _proy;
DELETE from t09_prod_ind_inf_se WHERE t02_cod_proy = _proy;
DELETE from t09_prod_ind_inf_si WHERE t02_cod_proy = _proy;
DELETE from t09_prod_ind_car_inf_se WHERE t02_cod_proy = _proy;
DELETE from t09_prod_ind_car_inf_si WHERE t02_cod_proy = _proy;

DELETE from t09_act_inf_se WHERE t02_cod_proy = _proy;
DELETE from t09_act_inf_si WHERE t02_cod_proy = _proy;
DELETE from t09_act_ind_inf_mi WHERE t02_cod_proy = _proy;

DELETE from t09_act_ind_mtas WHERE t09_act_ind_mtas.t02_cod_proy = _proy;
DELETE from t09_act_ind_mtas_inf WHERE t09_act_ind_mtas_inf.t02_cod_proy = _proy;
DELETE from t09_act_sub_mtas_inf WHERE t09_act_sub_mtas_inf.t02_cod_proy = _proy;
DELETE from t09_act_sub_mtas_inf_mi WHERE t09_act_sub_mtas_inf_mi.t02_cod_proy = _proy;
DELETE from t09_sub_act_mtas WHERE t09_sub_act_mtas.t02_cod_proy = _proy;
DELETE from t09_sub_act_plan WHERE t09_sub_act_plan.t02_cod_proy = _proy;
DELETE from t09_subact WHERE t09_subact.t02_cod_proy = _proy;
DELETE from t10_cost_fte WHERE t10_cost_fte.t02_cod_proy = _proy;
DELETE from t10_cost_sub WHERE t10_cost_sub.t02_cod_proy = _proy;
DELETE from t11_bco_bene WHERE t11_bco_bene.t02_cod_proy = _proy;
DELETE from t12_plan_at WHERE t12_plan_at.t02_cod_proy = _proy;
DELETE from t12_plan_capac WHERE t12_plan_capac.t02_cod_proy = _proy;
DELETE from t12_plan_capac_tema WHERE t12_plan_capac_tema.t02_cod_proy = _proy;
DELETE from t12_plan_cred WHERE t12_plan_cred.t02_cod_proy = _proy;
DELETE from t12_plan_cred_benef WHERE t12_plan_cred_benef.t02_cod_proy = _proy;
DELETE from t12_plan_otros WHERE t12_plan_otros.t02_cod_proy = _proy;
DELETE from t20_inf_mes WHERE t20_inf_mes.t02_cod_proy = _proy;
DELETE from t20_inf_mes_anx WHERE t20_inf_mes_anx.t02_cod_proy = _proy;
DELETE from t20_inf_mes_prob WHERE t20_inf_mes_prob.t02_cod_proy = _proy;
DELETE from t25_inf_trim WHERE t25_inf_trim.t02_cod_proy = _proy;
DELETE from t25_inf_trim_anx WHERE t25_inf_trim_anx.t02_cod_proy = _proy;
DELETE from t25_inf_trim_at WHERE t25_inf_trim_at.t02_cod_proy = _proy;
DELETE from t25_inf_trim_capac WHERE t25_inf_trim_capac.t02_cod_proy = _proy;
DELETE from t25_inf_trim_cred WHERE t25_inf_trim_cred.t02_cod_proy = _proy;
DELETE from t25_inf_trim_otros WHERE t25_inf_trim_otros.t02_cod_proy = _proy;

DELETE from t25_inf_entregable WHERE t02_cod_proy = _proy;
DELETE from t25_inf_entregable_anx WHERE t02_cod_proy = _proy;
DELETE from t25_inf_entregable_at WHERE t02_cod_proy = _proy;
DELETE from t25_inf_entregable_capac WHERE t02_cod_proy = _proy;
DELETE from t25_inf_entregable_cred WHERE t02_cod_proy = _proy;
DELETE from t25_inf_entregable_otros WHERE t02_cod_proy = _proy;

DELETE from t30_inf_se WHERE t02_cod_proy = _proy;
DELETE from t30_inf_se_anexos WHERE t02_cod_proy = _proy;

DELETE from t31_plan_me WHERE t31_plan_me.t02_cod_proy = _proy;
DELETE from t31_plan_me_aprob WHERE t31_plan_me_aprob.t02_cod_proy = _proy;
DELETE from t32_plan_act WHERE t32_plan_act.t02_cod_proy = _proy;
DELETE from t32_plan_vta WHERE t32_plan_vta.t02_cod_proy = _proy;
DELETE from t40_inf_financ WHERE t40_inf_financ.t02_cod_proy = _proy;
DELETE from t40_inf_financ_anx WHERE t40_inf_financ_anx.t02_cod_proy = _proy;
DELETE from t41_inf_financ_gasto WHERE t41_inf_financ_gasto.t02_cod_proy = _proy;
DELETE from t42_inf_financ_gasto_det WHERE t42_inf_financ_gasto_det.t02_cod_proy = _proy;

DELETE from t45_inf_si WHERE t02_cod_proy = _proy;
DELETE from t45_inf_si_anexos WHERE t02_cod_proy = _proy;

DELETE from t46_cron_visita_mi WHERE t46_cron_visita_mi.t02_cod_proy = _proy;
DELETE from t50_equiv_codis WHERE t50_equiv_codis.t02_cod_proy = _proy;
DELETE from t50_plan_moni_ext WHERE t50_plan_moni_ext.t02_cod_proy = _proy;
DELETE from t51_inf_mf WHERE t51_inf_mf.t02_cod_proy = _proy;
DELETE from t51_inf_mf_anexos WHERE t51_inf_mf_anexos.t02_cod_proy = _proy;
DELETE from t51_inf_mf_avance_meta WHERE t51_inf_mf_avance_meta.t02_cod_proy = _proy;
DELETE from t51_inf_mf_avance_monto WHERE t51_inf_mf_avance_monto.t02_cod_proy = _proy;
DELETE from t51_inf_mf_docs WHERE t51_inf_mf_docs.t02_cod_proy = _proy;
DELETE from t51_inf_mf_gastos_no_aceptados WHERE t51_inf_mf_gastos_no_aceptados.t02_cod_proy = _proy;
DELETE from t51_inf_mf_observa WHERE t51_inf_mf_observa.t02_cod_proy = _proy;
DELETE from t52_inf_visita_mf WHERE t52_inf_visita_mf.t02_cod_proy = _proy;
DELETE from t52_inf_visita_mf_anexos WHERE t52_inf_visita_mf_anexos.t02_cod_proy = _proy;
DELETE from t55_inf_unico_anual WHERE t55_inf_unico_anual.t02_cod_proy = _proy;
DELETE from t55_inf_unico_anual_avance_meta WHERE t55_inf_unico_anual_avance_meta.t02_cod_proy = _proy;
DELETE from t55_inf_unico_anual_avance_presup WHERE t55_inf_unico_anual_avance_presup.t02_cod_proy = _proy;
DELETE from t59_aprob_primer_desemb WHERE t59_aprob_primer_desemb.t02_cod_proy = _proy;
DELETE from t60_aprobacion_desemb WHERE t60_aprobacion_desemb.t02_cod_proy = _proy;
DELETE from t60_desembolsos WHERE t60_desembolsos.t02_cod_proy = _proy;
DELETE from t60_ejecucion_desemb WHERE t60_ejecucion_desemb.t02_cod_proy = _proy;
DELETE from t60_ejecucion_desemb_me WHERE t60_ejecucion_desemb_me.t02_cod_proy = _proy;
DELETE from adm_usuarios WHERE adm_usuarios.t02_cod_proy = _proy;
set numrows = 1;
SELECT numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_ambito_geo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_ambito_geo`(   IN _proy VARCHAR(10), 
					IN _vs   INT ,
					IN _dpto CHAR(2), 
					IN _prov CHAR(2), 
					IN _dist CHAR(2) )
BEGIN
DELETE FROM t03_dist_proy 
WHERE t02_cod_proy  = _proy
    AND t02_version   = _vs
    AND t03_dpto    = _dpto
    AND t03_prov    = _prov
    AND t03_dist    = _dist ;
  
SELECT ROW_COUNT() AS numrows, _dist AS codigo ;   
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_anx_inf_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_anx_inf_entregable`(
            IN _proy varchar(10),
            IN _ver INT,
            IN _anio INT, 
            IN _entregable INT, 
            IN _codanx INT)
BEGIN
    DECLARE _url varchar(100);
  
    SELECT t25_url_file into _url
    FROM t25_inf_entregable_anx
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable 
    AND t02_version = _ver
    AND t25_cod_anx = _codanx ;
    
    DELETE FROM t25_inf_entregable_anx
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable 
    AND t02_version = _ver
    AND t25_cod_anx = _codanx;
    
    SELECT ROW_COUNT() AS numrows, _url AS url; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_cambio_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_cambio_personal`(
					IN _proy VARCHAR(10),
					IN _id INT)
BEGIN
DECLARE _url1 VARCHAR(100);
DECLARE _url2 VARCHAR(100);
 
SELECT t04_adj_cv, t04_adj_sol 
INTO _url1, _url2
FROM t04_sol_cambio_per
WHERE t02_cod_proy=_proy 
AND t04_num_soli = _id ;
  DELETE 
    FROM t04_sol_cambio_per 
   WHERE t02_cod_proy = _proy
	AND t04_num_soli = _id ;
   
	
SELECT ROW_COUNT() AS numrows, _url1 AS url1, _url2 AS url2, _id AS codigo;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_cartafianza` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_cartafianza`(
			IN _idcf INT,
			IN _proy  VARCHAR(10)
			)
BEGIN
  DECLARE _msg  VARCHAR(100);
  
	delete from t02_carta_fianza 
	 WHERE t02_cod_proy = _proy 
	   AND t02_id_cf = _idcf ;
  
    SELECT ROW_COUNT() AS numrows, _idcf AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_concepto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_concepto`(IN in_concepto VARCHAR(30), IN in_numero INT)
BEGIN
    CASE in_concepto
        WHEN 'linea' THEN 
            DELETE FROM t00_linea WHERE t00_cod_linea = in_numero;
        WHEN 'tasa' THEN 
            DELETE FROM t00_tasa WHERE t00_cod_tasa = in_numero;
    WHEN 'parametro' THEN 
            DELETE FROM t00_parametro WHERE t00_cod_param = in_numero;
        WHEN 'banco' THEN 
            DELETE FROM t00_bancos WHERE t00_cod_bco = in_numero;
        WHEN 'moneda' THEN 
            DELETE FROM t00_tipo_moneda WHERE t00_cod_mon = in_numero;
        WHEN 'tipo_anexo' THEN 
            DELETE FROM t02_proy_anx_tip WHERE t02_anx_tip_cod = in_numero;
        WHEN 'tipo_cuenta' THEN 
            DELETE FROM t00_tipo_cuenta WHERE t00_cod_cta = in_numero;
    END CASE;
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_concurso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_concurso`(IN _id int)
BEGIN
 DECLARE _msg    VARCHAR(100);
 DECLARE _existe INT ;
 declare _rowsaffect int ;
 
 select distinct count(1) 
 into _existe
 from t02_dg_proy p  
 where SUBSTRING(p.t02_cod_proy,3,2) = _id ;
 if _existe > 0 then
    SELECT CONCAT('No se puede eliminar el concurso, tiene [',_existe,']', ' Proyectos registrados')
    INTO _msg ;
 end if;
 IF _existe <= 0 THEN
    delete FROM  adm_concursos WHERE num_conc=_id ;
    SELECT ROW_COUNT() ,'' into _rowsaffect, _msg ;
        delete FROM  adm_concursos_tasas WHERE num_conc=_id ;
  end if ;
 
  
SELECT _rowsaffect AS numrows, _id as codigo, _msg as msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_costeo`(IN _proy VARCHAR(10), IN _ver INT, IN _comp INT, IN _activ INT, 
								IN _subact INT 		, IN _cod_cost INT )
BEGIN
 
 DELETE FROM t10_cost_sub 
 WHERE   t02_cod_proy	= _proy AND t02_version	= _ver		AND
		 t08_cod_comp	= _comp AND t09_cod_act	= _activ	AND
		 t09_cod_sub	= _subact AND t10_cod_cost=_cod_cost;	  
		  						
SELECT ROW_COUNT() AS numrows ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_cron_visita` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_cron_visita`(  IN _proy VARCHAR(10),
					IN _id INT)
BEGIN
DELETE FROM t46_cron_visita_mi 
WHERE  t02_cod_proy=_proy
  AND  t46_id = _id ;
  
SELECT ROW_COUNT() AS numrows, _id AS codigo ;   
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_desembolso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_desembolso`(
			IN  _proy VARCHAR(10), 
			IN  _trim INT,
			IN  _iddesemb INT )
BEGIN
  
   delete FROM t60_ejecucion_desemb 
    WHERE t02_cod_proy = _proy 
      AND t60_id_trim = _trim
      AND t60_id_desemb = _iddesemb ;
  
   SELECT ROW_COUNT() AS numrows, _iddesemb AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_desembolso_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_desembolso_me`(
			IN  _proy VARCHAR(10), 
			IN  _visita INT,
			IN  _aprob INT,
			IN  _iddesemb INT)
BEGIN
  
   delete FROM t60_ejecucion_desemb_me 
     WHERE t02_cod_proy  = _proy 
      AND t60_id_visita    = _visita
      AND t60_id_nropago = _aprob
      AND t60_id_desemb  = _iddesemb ;
  
   SELECT ROW_COUNT() AS numrows, _iddesemb AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_equi_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_equi_fe`( IN _id INT)
BEGIN
  DELETE 
    FROM t90_equi_fe 
   WHERE t90_id_equi = _id ;
   
	
SELECT ROW_COUNT() AS numrows, _id AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_anx_foto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_anx_foto`(
			IN _proy varchar(10), 
			IN _anio INT, 
			IN _mes INT, 
			in _verInf int ,
			in _codanx int)
BEGIN
  declare _url varchar(100);
  
  select t20_url_file into _url
  FROM t20_inf_mes_anx
  WHERE t02_cod_proy=_proy 
    AND t20_anio=_anio 
    AND t20_mes=_mes 
    AND t20_ver_inf = _verInf
    AND t20_cod_anx = _codanx ;
  delete from t20_inf_mes_anx
  where t02_cod_proy=_proy 
    and t20_anio=_anio 
    and t20_mes=_mes 
    and t20_ver_inf = _verInf
    and t20_cod_anx = _codanx ;
    
	
select ROW_COUNT() as numrows, _url as url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_entregable`(
            IN _proy VARCHAR(10),
            IN _ver INT,
            IN _anio INT, 
            IN _entregable INT)
BEGIN
    DECLARE _numrows INT;
    
    DELETE FROM t25_inf_entregable 
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable 
    AND t02_version = _ver;
  
    SELECT ROW_COUNT() INTO _numrows ;  
    
    DELETE FROM t25_inf_entregable_at 
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable
    AND t02_version = _ver;
    
    DELETE FROM t25_inf_entregable_capac
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable
    AND t02_version = _ver;
    
    DELETE FROM t25_inf_entregable_cred  
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable
    AND t02_version = _ver;
    
    DELETE FROM t25_inf_entregable_otros  
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable
    AND t02_version = _ver;
    
    DELETE FROM t07_prop_ind_inf  
    WHERE t02_cod_proy = _proy 
    AND t07_ind_anio = _anio 
    AND t07_ind_entregable = _entregable
    AND t02_version = _ver;
    
    DELETE FROM t08_comp_ind_inf  
    WHERE t02_cod_proy = _proy 
    AND t08_ind_anio = _anio 
    AND t08_ind_entregable = _entregable
    AND t02_version = _ver;
    
    DELETE FROM t09_entregable_ind_inf  
    WHERE t02_cod_proy = _proy 
    AND t09_ind_anio = _anio 
    AND t09_ind_entregable = _entregable
    AND t02_version = _ver;
	  
	SELECT _numrows AS numrows, _ver AS codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_financ`(
			IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _mes INT 	
			)
BEGIN
  DECLARE _msg   INT;
  DECLARE _existe INT ;
  
  
  delete 
    from t42_inf_financ_gasto_det
   where t02_cod_proy = _proy
     and t40_anio = _anio
     and t40_mes  = _mes ;
   
  DELETE 
    FROM t41_inf_financ_gasto
   WHERE t02_cod_proy = _proy
     AND t40_anio = _anio
     AND t40_mes  = _mes ;
     
  DELETE 
    FROM t40_inf_financ_anx
   WHERE t02_cod_proy = _proy
     AND t40_anio = _anio
     AND t40_mes  = _mes ;
  
  DELETE 
    FROM t40_inf_financ
   WHERE t02_cod_proy = _proy
     AND t40_anio = _anio
     AND t40_mes  = _mes ;
  
  
 SELECT ROW_COUNT() AS numrows, _mes AS codigo, '' AS msg ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_financ_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_financ_anexos`(
			IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _mes INT, 
			IN _codanx INT)
BEGIN
  DECLARE _url VARCHAR(100);
  
  SELECT t40_url_file INTO _url
  FROM t40_inf_financ_anx
  WHERE t02_cod_proy=_proy 
    AND t40_anio=_anio 
    AND t40_mes=_mes 
    AND t40_cod_anx = _codanx ;
    
  DELETE FROM t40_inf_financ_anx
  WHERE t02_cod_proy=_proy 
    AND t40_anio=_anio 
    AND t40_mes=_mes 
    AND t40_cod_anx = _codanx ;
	
SELECT ROW_COUNT() AS numrows, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_financ_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_financ_cab`(IN _proy VARCHAR(10), 
			IN _numero INT)
BEGIN
  
  DELETE 
    FROM t51_inf_mf
   WHERE t02_cod_proy = _proy
     AND t51_num  = _numero ;
  
  
 SELECT ROW_COUNT() AS numrows ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_mes_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_mes_cab`(
			IN _proy varchar(10), 
			IN _anio INT, 
			IN _mes INT, 
			in _verInf int )
BEGIN
  delete from t20_inf_mes 
  where t02_cod_proy=_proy 
    and t20_anio=_anio 
    and t20_mes=_mes 
    and t20_ver_inf = _verInf;
    
   
  
	
select ROW_COUNT() as numrows, _verInf as codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_mf_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_mf_anexos`(
			IN _proy varchar(10), 
			IN _num INT, 
			in _codanx int)
BEGIN
  declare _url varchar(100);
  
  select t51_url_file into _url
  FROM t51_inf_mf_anexos
  WHERE t02_cod_proy=_proy 
    AND t51_id=_num 
    AND t51_cod_anx = _codanx ;
    
  delete from t51_inf_mf_anexos
  where t02_cod_proy=_proy 
    and t51_id=_num 
    and t51_cod_anx = _codanx ;
    
	
select ROW_COUNT() as numrows, _url as url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_del_inf_se`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT)
BEGIN
    DELETE FROM t30_inf_se 
    WHERE t02_cod_proy=_proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable;
  
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_se_anexo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_del_inf_se_anexo`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _codanx INT)
BEGIN
  DECLARE _url VARCHAR(100);
  
  SELECT t30_url_file INTO _url
  FROM t30_inf_se_anexos
  WHERE t02_cod_proy=_proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable
    AND t30_cod_anx = _codanx;
    
  DELETE FROM t30_inf_se_anexos
  WHERE t02_cod_proy = _proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable
    AND t30_cod_anx = _codanx;
    
    SELECT ROW_COUNT() AS numrows, _url AS url; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_del_inf_si`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT)
BEGIN
    DELETE FROM t45_inf_si 
    WHERE t02_cod_proy=_proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable;
  
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_si_anexo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_del_inf_si_anexo`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _codanx INT)
BEGIN
  DECLARE _url VARCHAR(100);
  
  SELECT t45_url_file INTO _url
  FROM t45_inf_si_anexos
  WHERE t02_cod_proy=_proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable
    AND t45_cod_anx = _codanx;
    
  DELETE FROM t45_inf_si_anexos
  WHERE t02_cod_proy = _proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable
    AND t45_cod_anx = _codanx;
    
    SELECT ROW_COUNT() AS numrows, _url AS url; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_unico_anual_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_unico_anual_cab`(
			IN _proy VARCHAR(10), 
			IN _anio INT )
BEGIN
  DELETE FROM t55_inf_unico_anual 
  WHERE t02_cod_proy=_proy 
    AND t55_anio=_anio ;  
	
SELECT ROW_COUNT() AS numrows, _proy AS codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_visita_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_visita_mf`(
			IN _proy VARCHAR(10), 
			IN _num INT)
BEGIN
  DELETE FROM t52_inf_visita_mf 
  WHERE t02_cod_proy=_proy 
    AND t52_num = _num;
  

SELECT ROW_COUNT() AS numrows, _num AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_inf_visita_mf_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_inf_visita_mf_anexos`(
			IN _proy varchar(10), 
			IN _num INT, 
			in _codanx int)
BEGIN
  declare _url varchar(100);
  
  select t52_url_file into _url
  FROM t52_inf_visita_mf_anexos
  WHERE t02_cod_proy=_proy 
    AND t52_id=_num 
    AND t52_cod_anx = _codanx ;
    
  delete from t52_inf_visita_mf_anexos
  where t02_cod_proy=_proy 
    and t52_id=_num 
    and t52_cod_anx = _codanx ;
select ROW_COUNT() as numrows, _url as url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_institucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_institucion`( IN _t01_id_inst  INT  )
TRANX : BEGIN
  DECLARE _numrows  INT;
  declare _existe   int ;
  
  SELECT count(distinct t02_cod_proy) into _existe    
  FROM t02_dg_proy WHERE t01_id_inst=_t01_id_inst ;
  
  if _existe > 0 then
    SELECT 0 AS numrows, CONCAT('No se puede eliminar la Institución, es ejecutora de "',_existe,'" Proyectos.') as msg ;
    LEAVE TRANX;    
  end if ;  
  
  SELECT COUNT(DISTINCT t02_cod_proy) INTO _existe    
  FROM t02_fuente_finan WHERE t01_id_inst=_t01_id_inst ;
  
  IF _existe > 0 THEN
    SELECT 0 AS numrows, CONCAT('No se puede eliminar la Institución, es Co-Financiadora en "',_existe,'" Proyectos.') AS msg ;
    LEAVE TRANX;    
  END IF ;  
  
  SELECT COUNT(DISTINCT t02_cod_proy) INTO _existe    
  FROM t02_dg_proy WHERE  SUBSTRING_INDEX(t02_moni_ext,'.',1) = _t01_id_inst ;
  
  IF _existe > 0 THEN



    SELECT 0 AS numrows, CONCAT('No se puede eliminar la Institución, es Gestora en "',_existe,'" Proyectos.') AS msg ;

    LEAVE TRANX;    
  END IF ;   
  delete 
    FROM t01_dir_inst 
   WHERE t01_id_inst= _t01_id_inst ;
  
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    
    SELECT _numrows AS numrows, '' AS msg , _t01_id_inst AS codigo ;
       
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_menu` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_menu`(IN _id varchar(8) )
BEGIN
 DECLARE _msg    VARCHAR(100);
 DECLARE _existe INT ;
 declare _rowsaffect int ;
 
 select count(1) 
 into _existe
 from adm_menus_perfil  
 where mnu_cod = _id ;
 
 if _existe > 0 then
    SELECT CONCAT('No se puede eliminar el Menu, tiene [',_existe,']', ' Perfiles Asignados')
    INTO _msg ;
 else
    SELECT COUNT(1) 
    INTO _existe
    FROM adm_acceso_directo  
    WHERE mnu_cod = _id ;
    IF _existe > 0 THEN
       SELECT CONCAT('No se puede eliminar el Menu, tiene [',_existe,']', ' registros de Accesos Directo')
       INTO _msg ;
    end if;
 end if;
 
 IF _existe <= 0 THEN
	delete FROM  adm_menus
	WHERE mnu_cod=_id ;
	SELECT ROW_COUNT() ,''
	into _rowsaffect, _msg ;
  end if ;
  
	
SELECT _rowsaffect AS numrows, _id as codigo, _msg as msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_menu_pagina` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_menu_pagina`(IN _mnu varchar(8), in _id varchar(20) )
BEGIN
declare _rowsaffect int ;
CALL sp_strTempTable('tCodigos', _id, ',');
delete FROM  adm_menus_pagina
WHERE mnu_cod=_mnu and pag_cod in(select txt from tCodigos) ;
SELECT ROW_COUNT() 
into _rowsaffect ;
DROP TEMPORARY TABLE tCodigos;
	
SELECT _rowsaffect AS numrows, _id as codigo, '' as msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_mp_equipa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_mp_equipa`(
			IN _proy varchar(10), 
			in _ver  int,
			in _equi int)
BEGIN
  DELETE FROM t03_mp_equi 
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver
	  AND t03_id_equi  = _equi ;

select ROW_COUNT() as numrows, _equi as codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_mp_gasfunc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_mp_gasfunc`(IN _proy VARCHAR(10), 
				     IN _ver   INT,
				     IN _part  INT  )
BEGIN
DELETE FROM t03_mp_gas_fun_part
WHERE t02_cod_proy = _proy
  AND t02_version  = _ver
  AND t03_partida  = _part ;
SELECT ROW_COUNT() AS numrows, _part AS codigo, '' AS msg ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_mp_gasfunc_gasto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_mp_gasfunc_gasto`(IN _proy VARCHAR(10), 
				     IN _ver   INT,
				     IN _part  INT,  
				     IN _gasto INT)
BEGIN
DELETE FROM t03_mp_gas_fun_cost
WHERE t02_cod_proy = _proy
  AND t02_version  = _ver
  AND t03_partida  = _part 
  AND t03_id_gasto = _gasto ;
  	
SELECT ROW_COUNT() AS numrows, _gasto AS codigo, '' AS msg ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_mp_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_mp_personal`(
			IN _proy varchar(10), 
			IN _ver INT, 
			IN _per INT )
BEGIN
  delete from t03_mp_per 
  where t02_cod_proy=_proy 
    and t02_version =_ver 
    and t03_id_per  =_per ;
	
select ROW_COUNT() as numrows, _per as codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_noobjecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_noobjecioncompra`(  
					IN _proy VARCHAR(10),
					IN _cod INT)
BEGIN
  DELETE FROM t02_noobjecion_compra 
    WHERE t02_cod_proy = _proy 
    AND t02_id_noc = _cod ;
  
   SELECT ROW_COUNT() AS numrows, _cod AS codigo ;   
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_noobjecion_compras_anx` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_noobjecion_compras_anx`(
			IN _proy VARCHAR(10), 
			IN _codanx INT)
BEGIN
  DECLARE _url VARCHAR(100);
 
  SELECT t02_url_file INTO _url
  FROM t02_noobjecion_compra_anx
  WHERE t02_cod_proy=_proy 
    AND t02_cod_anx = _codanx ;
     
DELETE FROM t02_noobjecion_compra_anx 
	WHERE
	t02_cod_proy = _proy 
	AND t02_cod_anx = _codanx ;
	
SELECT ROW_COUNT() AS numrows, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_objecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_objecioncompra`(  
					IN _proy VARCHAR(10),
					IN _cod INT)
BEGIN
  DELETE FROM t02_objecion_compra 
    WHERE t02_cod_proy = _proy 
    AND t02_id_noc = _cod ;
  
   SELECT ROW_COUNT() AS numrows, _cod AS codigo ;   
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_perfil`(IN _id int )
BEGIN
 DECLARE _msg    VARCHAR(100);
 DECLARE _existe INT ;
 declare _rowsaffect int ;
 
 select count(1) 
 into _existe
 from adm_usuarios  
 where tipo_user = _id ;
 
 if _existe > 0 then
    SELECT CONCAT('No se puede eliminar el perfil, tiene [',_existe,']', ' Usuarios registrados')
    INTO _msg ;
 else
    SELECT COUNT(1) 
    INTO _existe
    FROM adm_menus_perfil  
    WHERE per_cod = _id ;
    IF _existe > 0 THEN
       SELECT CONCAT('No se puede eliminar el perfil, tiene [',_existe,']', ' Restricciones x Menu')
       INTO _msg ;
    end if;
 end if;
 
 IF _existe <= 0 THEN
	delete FROM  adm_perfiles
	WHERE per_cod=_id ;
	SELECT ROW_COUNT() ,''
	into _rowsaffect, _msg ;
  end if ;
  
	
SELECT _rowsaffect AS numrows, _id as codigo, _msg as msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_at`(
			IN _proy VARCHAR(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			IN _usr varchar(20)						
			)
trx1 : BEGIN
DECLARE _rowcount INT ;
DELETE FROM t12_plan_at
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub ;
   

SELECT ROW_COUNT() AS numrows, _sub AS codigo, '' AS msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_capac`(
			IN _proy VARCHAR(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			IN _usr varchar(20)						
			)
trx1 : BEGIN
DECLARE _rowcount INT ;
DELETE FROM t12_plan_capac 
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub ;
   

SELECT ROW_COUNT() AS numrows, _sub AS codigo, '' AS msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_capac_tema` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_capac_tema`(IN _proy VARCHAR(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			IN _idtema INT, IN _horas_total double, IN _benef_total double)
trx1 : BEGIN
DECLARE _rowcount INT ;
DECLARE _nrotemas DOUBLE ;
delete from t12_plan_capac_tema 
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub  
   AND  t12_cod_tema=_idtema;
   
   SELECT ROW_COUNT() INTO _rowcount ;
   
   SELECT COUNT(t12_cod_tema)
     INTO  _nrotemas
     FROM t12_plan_capac_tema   
    WHERE t02_cod_proy = _proy 
      AND t02_version = _ver 
      AND t08_cod_comp= _comp
      AND t09_cod_act = _act 
      AND t09_cod_sub = _sub ;
    UPDATE t12_plan_capac 
	SET t12_nro_tema = _nrotemas ,
			t12_hor_cap  = _horas_total , 
	    t12_nro_ben  = _benef_total , 
	    fch_actu     = NOW()
	 WHERE t02_cod_proy = _proy 
	   AND	t02_version = _ver 
	   AND	t08_cod_comp= _comp
	   AND	t09_cod_act = _act 
	   AND	t09_cod_sub = _sub  ;

SELECT _rowcount AS numrows, _sub AS codigo, '' as msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_cred`(
			IN _proy VARCHAR(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			IN _usr varchar(20)						
			)
trx1 : BEGIN
DECLARE _rowcount INT ;
DELETE FROM t12_plan_cred
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub ;
   

SELECT ROW_COUNT() AS numrows, _sub AS codigo, '' AS msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_cred_benef` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_cred_benef`(  
					    IN _proy VARCHAR(10), 
					    IN _ver   INT, 
					    IN _comp  INT,
					    IN _act   INT,
					    IN _sub   INT,
					    IN _benef int)
TRANX : BEGIN
	DECLARE _rowcount INT;
	
	IF (SELECT COUNT(1) FROM t25_inf_trim_cred WHERE t02_cod_proy=_proy AND t08_cod_comp=_comp AND t09_cod_act=_act AND t09_cod_sub=_sub and t11_cod_bene=_benef ) > 0  THEN
	   SELECT 0 AS numrows, 0 AS codigo, 'No se puede eliminar, el Beneficiaro tiene participacion en los informes trimestrales' AS msg ;
	   LEAVE TRANX ;
	END IF ;
      
        
	delete 
	  from  t12_plan_cred_benef 
	WHERE t02_cod_proy  = _proy
	  AND t02_version   = _ver
	  AND t08_cod_comp  = _comp
	  AND t09_cod_act   = _act
	  AND t09_cod_sub   = _sub
	  and t11_cod_benef = _benef ;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	COMMIT ;
	
	SELECT _rowcount AS numrows, _sub AS codigo, '' AS msg ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_otros`(
			IN _proy VARCHAR(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			IN _usr varchar(20)						
			)
trx1 : BEGIN
DECLARE _rowcount INT ;
DELETE FROM t12_plan_otros
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub ;
   

SELECT ROW_COUNT() AS numrows, _sub AS codigo, '' AS msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_visita` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_visita`( IN _proy VARCHAR(10),
					IN _id INT)
BEGIN
DELETE FROM t31_plan_me 
WHERE  t02_cod_proy=_proy
  AND  t31_id = _id ;
  
SELECT ROW_COUNT() AS numrows, _id AS codigo ;   
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_visita_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_visita_cab`(
			IN _proy VARCHAR(10), 
			IN _vta INT )
BEGIN
  DELETE FROM t32_plan_vta 
  WHERE t02_cod_proy=_proy 
    AND t32_id_vta=_vta ;

SELECT ROW_COUNT() AS numrows, _vta AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_plan_visita_det` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_plan_visita_det`(
			IN _proy VARCHAR(10), 
			IN _vta INT ,
			IN _idact INT)
BEGIN
  DELETE FROM t32_plan_act
  WHERE t02_cod_proy= _proy 
    AND t32_id_vta  = _vta 
    AND t32_id_act  = _idact ;

SELECT ROW_COUNT() AS numrows, _idact AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_poa_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_poa_anexos`(
			IN _proy   varchar(10), 
			IN _anio   INT, 
			in _codanx int )
BEGIN
  declare _url varchar(100);
  
  select t02_url_file into _url
  FROM t02_poa_anexos
  WHERE t02_cod_proy = _proy 
    AND t02_anio     = _anio 
    AND t02_cod_anx  = _codanx ;
    
  delete from t02_poa_anexos
  where t02_cod_proy =_proy 
    AND t02_anio     = _anio 
    and t02_cod_anx  = _codanx ;
    
select ROW_COUNT() as numrows, _url as url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_proy`(IN _proy VARCHAR(10), IN _vs INT)
BEGIN
declare numrows int;
DELETE from t09_act WHERE t09_act.t02_cod_proy = _proy;
DELETE from t08_comp WHERE t08_comp.t02_cod_proy = _proy;
DELETE from t02_dg_proy WHERE t02_dg_proy.t02_cod_proy = _proy AND t02_dg_proy.t02_version=_vs;
DELETE from t02_fuente_finan WHERE t02_fuente_finan.t02_cod_proy = _proy;
DELETE from t02_aprob_proy WHERE t02_aprob_proy.t02_cod_proy = _proy;
DELETE from t02_sector_prod WHERE t02_sector_prod.t02_cod_proy = _proy;





DELETE from t02_tasas_proy WHERE t02_tasas_proy.t02_cod_proy = _proy AND t02_tasas_proy.t02_version=_vs;


set numrows = 1;
SELECT numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_proy_anx` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_proy_anx`(
			IN _proy VARCHAR(10), 
			IN _verInf INT ,
			IN _codanx INT)
BEGIN
  DECLARE _url VARCHAR(100);
  
  SELECT t02_url_file INTO _url
  FROM t02_proy_anx
  WHERE t02_cod_proy=_proy 
    AND t02_version = _verInf
    AND t02_cod_anx = _codanx ;
  DELETE FROM t02_proy_anx
  WHERE t02_cod_proy=_proy 
    AND t02_version = _verInf
    AND t02_cod_anx = _codanx ;
    
	
SELECT ROW_COUNT() AS numrows, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_sector_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_sector_prod`(  IN _proy VARCHAR(10),
					IN _sec INT ,
					IN _sub INT)
BEGIN
DELETE FROM t02_sector_prod 
WHERE  t02_cod_proy=_proy
  AND  t02_sector = _sec 
  AND  t02_subsec = _sub;
  
SELECT ROW_COUNT() AS numrows, _sub AS codigo ;   
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_tablasaux` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_tablasaux`( IN _cod    INT)
BEGIN
    
    delete from  adm_tablas_aux 
	WHERE codi = _cod ;
    
    SELECT ROW_COUNT() AS numrows, _cod AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_tablasaux2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_tablasaux2`( IN _cod    INT)
BEGIN
    
    delete from  adm_tablas_aux2 
	WHERE codi = _cod ;
    
    SELECT ROW_COUNT() AS numrows, _cod AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_del_usuario` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_del_usuario`(IN _usr varchar(20) )
BEGIN
delete 
FROM  adm_usuarios
WHERE coduser=_usr ;
	
SELECT ROW_COUNT() AS numrows, _usr as codigo, '' as msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_desem_comprob` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_desem_comprob`(IN _id INT, IN _cod VARCHAR(10))
BEGIN
	DECLARE _ids INT;
	SELECT MAX(t60_id_aprob)
	INTO _ids
	FROM t60_aprobacion_desemb
	WHERE t60_id_aprob <> _id
	AND t02_cod_proy = _cod;
	SELECT  dsmb.t60_id_aprob, 
	dsmb.t02_cod_proy, 
	dsmb.t60_anio, 
	dsmb.t60_trim, 
	dsmb.t60_mto_plan, 
	IFNULL(dsmb.t60_mto_aprob, 0), 
	DATE_FORMAT( dsmb.t60_fch_aprob, '%d/%m/%Y') AS t60_fch_aprob, 
	IFNULL(dsmb.t60_mto_desemb, 0), 
	dsmb.t60_apro_mt, 
	dsmb.t60_obs_mt, 
	dsmb.t60_apro_mf, 
	dsmb.t60_obs_mf ,
	proy.t01_id_inst,
	ejec.t01_sig_inst,
	proy.t02_cod_proy,
	proy.t02_nom_proy,
	con.abr_conc AS nomconcurso,
	con.num_conc AS concurso,
	ejec.t01_ruc_inst,
	proy.t02_fch_isc,
	proy.t02_fch_ini,
	DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
	proy.t02_fch_ire,
	proy.t02_fch_tre,
	proy.t02_fch_tam,
	est.descrip AS estado,
	est.cod_ext AS codestado,
	fn_numero_trim(dsmb.t60_anio, dsmb.t60_trim) AS trim_desembolsar,
	fn_monto_desembolsado_periodo(proy.t02_cod_proy,1, TRUNCATE((proy.t02_num_mes / 3),0) ) AS total_desembolsado,
	cta.t01_id_cta
FROM       t60_aprobacion_desemb dsmb
LEFT  JOIN t02_dg_proy  proy  ON (dsmb.t02_cod_proy = proy.t02_cod_proy AND proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
LEFT  JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
LEFT  JOIN adm_concursos  con ON (SUBSTRING(proy.t02_cod_proy,3,2) = con.num_conc)
LEFT  JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
LEFT  JOIN t02_proy_ctas cta ON (proy.t02_cod_proy=cta.t02_cod_proy)
WHERE dsmb.t60_id_aprob = _ids;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ejec_anio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ejec_anio`(
									IN pAnio INT,
									IN pConcurso VARCHAR(10), 
									IN pSector VARCHAR(10), 
									IN pRegion INT)
BEGIN
	DECLARE aIniDate DATE;
	DECLARE aFinDate DATE;
	
	SELECT STR_TO_DATE(CONCAT('', pAnio, '/01/01'), '%Y/%m/%d') INTO aIniDate;
	SELECT STR_TO_DATE(CONCAT('', pAnio, '/12/31'), '%Y/%m/%d') INTO aFinDate;
	
		
	SELECT	pAnio,
			SUM(fn_costo_total_proyecto_periodo(proy.t02_cod_proy, proy.t02_version, proy.mes_ini, proy.mes_fin)) AS planeado,
			SUM(total_eject_periodo_pre(proy.t02_cod_proy, proy.mes_ini, proy.mes_fin)) AS ejecutado			 
	FROM (
			SELECT	proy2.t02_cod_proy, 
					proy2.t02_version, 
					proy2.t02_sect_prod,
					proy2.fch_ini,
					proy2.fch_ter,
					CASE 
						WHEN aIniDate > proy2.fch_ini THEN 
							CEILING(DATEDIFF(aIniDate, proy2.fch_ini) / 30) + 1
						ELSE 
							1 
					END AS mes_ini,
					CASE 
						WHEN  aFinDate < proy2.fch_ter THEN 
							FLOOR(DATEDIFF(aFinDate, proy2.fch_ini) / 30) 
						ELSE 
							FLOOR(DATEDIFF(proy2.fch_ter, proy2.fch_ini) / 30) 
					END AS mes_fin
			FROM (
					SELECT	t02_cod_proy, t02_version, t02_sect_prod,
							fn_fecha_inicio_proy(t02_cod_proy, t02_version) AS fch_ini,
							fn_fecha_termino_proy(t02_cod_proy, t02_version) AS fch_ter
					FROM	t02_dg_proy
					WHERE 	t02_version = fn_pri_version_proy(t02_cod_proy)
				) proy2
			WHERE	YEAR(proy2.fch_ini) = pAnio 
				OR ( YEAR(proy2.fch_ini) < pAnio AND YEAR(proy2.fch_ter) = pAnio )
				OR ( YEAR(proy2.fch_ini) < pAnio AND YEAR(proy2.fch_ter) > pAnio )
		) proy
		LEFT JOIN	(SELECT t02_cod_proy, IFNULL(t03_dpto, 0) AS t03_dpto
					FROM t03_dist_proy 
					WHERE t02_version = fn_pri_version_proy(t02_cod_proy)
					GROUP BY t02_cod_proy)	dist	ON (proy.t02_cod_proy = dist.t02_cod_proy)
		WHERE	SUBSTR(proy.t02_cod_proy,3,2) = (CASE WHEN pConcurso = '*' THEN SUBSTR(proy.t02_cod_proy,3,2) ELSE pConcurso END)
			AND proy.t02_sect_prod = (CASE WHEN pSector = "*" THEN proy.t02_sect_prod ELSE pSector END)
			AND	IFNULL(dist.t03_dpto, 0) = (CASE WHEN pRegion = '*' THEN IFNULL(dist.t03_dpto, 0) ELSE pRegion END);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_elimina_componente` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_elimina_componente`(
			IN _proy VARCHAR(10), 
			IN _ver  INT,
			IN _idcomp INT)
BEGIN

DELETE FROM t10_cost_fte WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;

DELETE FROM t09_act_sub_mtas_inf_mi WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
DELETE FROM t09_act_sub_mtas_inf_me WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
DELETE FROM t09_act_sub_mtas_inf WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
DELETE FROM t09_act_ind_mtas_inf WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
DELETE FROM t09_act_ind_inf_mi WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
DELETE FROM t09_act_ind_inf_me WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;

DELETE FROM t09_sub_act_mtas WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
DELETE FROM t09_act_ind_mtas WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;

DELETE FROM t10_cost_sub WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
  

DELETE FROM t09_subact WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;

DELETE FROM t09_act WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;

DELETE FROM t08_comp_ind WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
DELETE FROM t08_comp_sup WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;

DELETE FROM t08_comp WHERE t02_cod_proy=_proy  AND t02_version = _ver  AND t08_cod_comp = _idcomp ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_genera_txt_bcp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_genera_txt_bcp`(in _idcta int)
BEGIN

DECLARE _idFE INT DEFAULT 10 ; 
declare _salida varchar(200) default '' ;
declare _sumchecksum double ;
DECLARE _maxvalue int ;
DECLARE _minvalue INT ;

declare _tiporegistro int default 1 ; 
DECLARE _nroabonos    INT ;   
DECLARE _fechaproce   varchar(8) default DATE_FORMAT(NOW(),'%Y%m%d') ; 
declare _tipctacargo  char(1) ;  
DECLARE _monctacargo  CHAR(4) ;  
DECLARE _nroctacargo  varCHAR(20) ; 
declare _mtototabonos double ; 	    
DECLARE _refplanilla  VARCHAR(40) ; 
DECLARE _ExoneraITF   CHAR(1) default 'N' ; 
DECLARE _checksum     VARCHAR(15) default '' ; 
				    
DECLARE _tipctaabono  CHAR(1) ;  
DECLARE _monctaabono  CHAR(4) ;  
DECLARE _nroctaabono  VARCHAR(20) ; 
DECLARE _modpago      CHAR(1) default '1' ; 
DECLARE _tipodocprov  CHAR(1) DEFAULT '6' ; 
DECLARE _nrodocprov   varCHAR(12) ; 
DECLARE _correlprov   char(3) default '   ' ; 
DECLARE _nombreprov   VARCHAR(75) ; 
DECLARE _refereprov   VARCHAR(40) ; 
DECLARE _refereemp    VARCHAR(20) ; 
DECLARE _monabonar    CHAR(4) default '0001' ;  
DECLARE _mtoabonar    DOUBLE ; 	    
DECLARE _flgIDC       CHAR(1) DEFAULT 'N' ; 

CREATE TEMPORARY TABLE `tmpTXT`
( `id`     INT(11) NOT NULL AUTO_INCREMENT, 
  `salida` VARCHAR(200) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ;
  
select 	(case when cta.t00_cod_cta=1 then 'C' else (CASE WHEN cta.t00_cod_cta=2 THEN 'M' else '' END) end ),
	(CASE WHEN cta.t00_cod_mon=1 THEN '0001' ELSE '1001' END ),
	TRIM(REPLACE(cta.t01_nro_cta,'-','')),
	substring((case when ifnull(cta.t01_txt_ref,'')='' then 'DESEMBOLSO A PROYECTOS' else cta.t01_txt_ref end),1,40)
  into 	_tipctacargo,
	_monctacargo,
	_nroctacargo,
	_refplanilla
from t01_inst_ctas  cta
where  cta.t01_id_inst = _idFE 
  and  cta.t01_id_cta  = _idcta ;
SELECT  SUM(resumen.monto),
	COUNT(resumen.cuenta),
	sum(
		(
		 case when resumen.tipo='A' 
		 then 
		  trim(SUBSTRING(replace(resumen.cuenta,'-',''),3,8))
		 else 
			(CASE WHEN resumen.tipo='C' or resumen.tipo='M'
			THEN 
			  TRIM(SUBSTRING(REPLACE(resumen.cuenta,'-',''),3,7))
			ELSE 
			   trim(fn_replace_str_0(REPLACE(resumen.cuenta,'-','')))
			END )
		  end
		  )
	)
  into  _mtototabonos,
        _nroabonos,
        _sumchecksum
FROM (
	SELECT 	DISTINCT ruc, 
		nrocuenta   AS cuenta, 
		montotransf AS monto, 
		montranf    AS moneda,
		tipocuenta  as tipo
	FROM  tmp_pago_prov_bcp 
	WHERE (banco = 'BCP' OR LOWER(banco) = 'banco de credito')
	  AND IFNULL(ruc,'') <> ''
	  AND IFNULL(tipocuenta,'') <> ''
	  AND IFNULL(nrocuenta,'') <> '' 
     ) as resumen ;
select _sumchecksum + substring(_nroctacargo,3,7) into _checksum ;
SELECT CONCAT( 	_tiporegistro, 
		LPAD(_nroabonos,6,'0'),
		LPAD(_fechaproce,8,' '),
		_tipctacargo,
		_monctacargo,
		RPAD(_nroctacargo,20,' '),
		LPAD(ROUND(_mtototabonos,2),17,'0'),
		RPAD(REPLACE(REPLACE(_refplanilla,'\"',''),"\'",""),40,' '),
		_ExoneraITF,
		LPAD(_checksum,15,'0')
	      )
  INTO _salida ;
INSERT INTO tmpTXT (salida) VALUES( _salida) ;
SELECT 	min(idcarga),
	max(idcarga)
  into  _minvalue,
	_maxvalue
FROM  tmp_pago_prov_bcp 
WHERE (banco = 'BCP' OR LOWER(banco) = 'banco de credito')
  AND IFNULL(ruc,'') <> ''
  AND IFNULL(tipocuenta,'') <> ''
  AND IFNULL(nrocuenta,'') <> '' ;
WHILE _minvalue <= _maxvalue DO
	
	SELECT 	2 ,
		tmp.tipocuenta,
		TRIM(replace(REPLACE(tmp.nrocuenta,'-',''),'.','')),
		substring(trim(tmp.ejecutor),1,75),
		trim(tmp.ruc),
		SUBSTRING(trim(tmp.modogiro),1,40),
		(CASE WHEN tmp.montranf='S' THEN '0001' ELSE '1001' END ),
		tmp.montotransf,
		substring((CASE WHEN IFNULL(tmp.textoref,'')='' THEN concat('DESEMBOLSO: ', tmp.codproy) ELSE tmp.textoref END),1,20)
	  INTO 	_tiporegistro,
		_tipctaabono,
		_nroctaabono,
		_nombreprov,
		_nrodocprov,
		_refereprov,
		_monabonar,
		_mtoabonar,
		_refereemp
	FROM tmp_pago_prov_bcp  tmp
	WHERE tmp.idcarga = _minvalue ;
	
SELECT CONCAT( 	_tiporegistro, 
		_tipctaabono,
		RPAD(_nroctaabono,20,' '),
		_modpago,
		_tipodocprov,
		RPAD(_nrodocprov,12,' '),
		rpad(trim(_correlprov),3,' '),
		RPAD(REPLACE(REPLACE( _nombreprov ,'\"',''),"\'",""),75,' '),
		RPAD(REPLACE(REPLACE( _refereprov ,'\"',''),"\'",""),40,' '),
		RPAD(REPLACE(REPLACE( _refereemp ,'\"',''),"\'",""),20,' '),
		_monabonar,
		LPAD(ROUND(_mtoabonar,2),17,'0'),
		_flgIDC
	      )
  INTO _salida ;

INSERT INTO tmpTXT (salida) VALUES( _salida) ;
SELECT 	MIN(idcarga)
  INTO  _minvalue
FROM  tmp_pago_prov_bcp 
WHERE (banco = 'BCP' OR LOWER(banco) = 'banco de credito')
  AND IFNULL(ruc,'') <> ''
  AND IFNULL(tipocuenta,'') <> ''
  AND IFNULL(nrocuenta,'') <> '' 
  and idcarga > _minvalue ;
END WHILE ;
select * from tmpTXT ;
drop TEMPORARY table if EXISTS `tmpTXT` ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_aprueba_desemb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_aprueba_desemb`(IN _proy varchar(10),
					 in _anio int,
					 in _trim int
					)
BEGIN
SELECT  t60_id_aprob, 
	t02_cod_proy, 
	t60_anio, 
	t60_trim, 
	t60_mto_plan, 
	t60_mto_aprob, 
	DATE_FORMAT( t60_fch_aprob, '%d/%m/%Y') as t60_fch_aprob, 
	t60_mto_desemb, 
	t60_apro_mt, 
	t60_obs_mt, 
	t60_apro_mf, 
	t60_obs_mf, 
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu, 
	est_audi 
FROM t60_aprobacion_desemb
WHERE t02_cod_proy = _proy
  AND t60_anio     = _anio
  AND t60_trim     = _trim ;
      
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_aprueba_desemb2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_aprueba_desemb2`( IN _idaprob INT )
BEGIN
SELECT  dsmb.t60_id_aprob,
	dsmb.t60_nro_aprob,
	dsmb.t02_cod_proy, 
	dsmb.t60_anio, 
	dsmb.t60_trim, 
	dsmb.t60_mto_plan, 
	dsmb.t60_mto_aprob, 
	DATE_FORMAT( dsmb.t60_fch_aprob, '%d/%m/%Y') AS t60_fch_aprob, 
	dsmb.t60_mto_desemb, 
	dsmb.t60_apro_mt, 
	dsmb.t60_obs_mt, 
	dsmb.t60_apro_mf, 
	dsmb.t60_obs_mf ,
	proy.t01_id_inst,
	ejec.t01_sig_inst,
	proy.t02_cod_proy,
	proy.t02_nom_proy,
	con.abr_conc AS nomconcurso,
	con.num_conc AS concurso,
	ejec.t01_ruc_inst,
	proy.t02_fch_isc,
	proy.t02_fch_ini,
	DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
	proy.t02_fch_ire,
	proy.t02_fch_tre,
	proy.t02_fch_tam,
	est.descrip AS estado,
	est.cod_ext AS codestado,
	fn_numero_trim(dsmb.t60_anio, dsmb.t60_trim) AS trim_desembolsar,
	fn_monto_desembolsado_periodo(proy.t02_cod_proy,1, TRUNCATE((proy.t02_num_mes / 3),0) ) AS total_desembolsado,
	cta.t01_id_cta
FROM	(SELECT	t1.t60_id_aprob,
					t1.t02_cod_proy,
					t2.t60_nro_aprob,
					t1.t60_anio, 
					t1.t60_trim,
					t1.t60_mto_plan,
					IFNULL(t2.t60_mto_par_aprob, t1.t60_mto_aprob) AS t60_mto_aprob,
					IFNULL(t2.t60_fch_aprob, t1.t60_fch_aprob) AS t60_fch_aprob, 
					IFNULL(t2.t60_mto_par_desemb, t1.t60_mto_desemb) AS t60_mto_desemb, 
					IFNULL(t2.t60_apro_cmt, t1.t60_apro_mt) AS t60_apro_mt, 
					IFNULL(t2.t60_obs_cmt, t1.t60_obs_mt) AS t60_obs_mt, 
					IFNULL(t2.t60_apro_cmf, t1.t60_apro_mf) AS t60_apro_mf, 
					IFNULL(t2.t60_obs_cmf, t1.t60_obs_mf) AS t60_obs_mf
		FROM		t60_aprobacion_desemb t1
		LEFT JOIN	(SELECT t60_id_aprob, 
							t60_nro_aprob,
							t60_fch_aprob,
							t60_mto_par_desemb,
							t60_mto_par_aprob, 
							t60_apro_cmt,
							t60_obs_cmt,
							t60_apro_cmf,
							t60_obs_cmf,
							t60_flg_desemb
						FROM t60_aprob_desemb_parcial
						WHERE IFNULL(t60_flg_desemb, 0) = '0'
						GROUP BY t60_id_aprob) t2 
					ON (t1.t60_id_aprob = t2.t60_id_aprob)) dsmb
LEFT  JOIN t02_dg_proy  proy  ON (dsmb.t02_cod_proy = proy.t02_cod_proy AND proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
LEFT  JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
LEFT  JOIN adm_concursos  con ON (SUBSTRING(proy.t02_cod_proy,3,2) = con.num_conc)
LEFT  JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
LEFT  JOIN t02_proy_ctas cta ON (proy.t02_cod_proy=cta.t02_cod_proy)
WHERE dsmb.t60_id_aprob = _idaprob ;
      
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_aprueba_desemb_parciales` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_aprueba_desemb_parciales`(
						IN pProy VARCHAR(10),
						IN pAnio INT,
						IN pTrim INT)
BEGIN
	SELECT  t1.t60_id_aprob,
			t2.t60_nro_aprob,
			t1.t02_cod_proy, 
			t1.t60_anio, 
			t1.t60_trim, 
			t2.t60_mto_par_aprob, 
			DATE_FORMAT( t2.t60_fch_aprob, '%d/%m/%Y') AS t60_fch_aprob,
			t2.t60_flg_desemb,
			t1.t60_mto_desemb, 
			t2.t60_apro_mt,
			t2.t60_obs_mt,
			DATE_FORMAT(t60_fch_apro_mt, '%d/%m/%Y') AS t60_fch_apro_mt,
			t2.t60_apro_mf,
			t2.t60_obs_mf,
			DATE_FORMAT(t60_fch_apro_mf, '%d/%m/%Y') AS t60_fch_apro_mf,
			t2.t60_apro_cmt,
			t2.t60_obs_cmt,
			DATE_FORMAT(t60_fch_apro_cmt, '%d/%m/%Y') AS t60_fch_apro_cmt,
			t2.t60_apro_cmf,
			t2.t60_obs_cmf,
			DATE_FORMAT(t60_fch_apro_cmf, '%d/%m/%Y') AS t60_fch_apro_cmf,
			t2.usr_crea, 
			t2.fch_crea, 
			t2.usr_actu, 
			t2.fch_actu, 
			t2.est_audi 
	FROM t60_aprobacion_desemb t1
	LEFT JOIN t60_aprob_desemb_parcial t2 ON (t1.t60_id_aprob = t2.t60_id_aprob)
	WHERE t02_cod_proy = pProy
	  AND t60_anio     = pAnio
	  AND t60_trim     = pTrim ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_aprueba_primer_desemb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_aprueba_primer_desemb`( IN _idaprob INT )
BEGIN

SELECT 	dsmb.t59_id_aprob, 
	dsmb.t02_cod_proy, 
	dsmb.t59_car_fianza, 
	dsmb.t59_cons_aper_cta, 
	dsmb.t59_conv_firma, 
	dsmb.t59_otros_docum, 
	dsmb.t59_aprueba_mf,
	dsmb.t59_obs_aprob, 
	dsmb.t59_mto_aprob ,
	date_format(dsmb.t59_fch_aprob, '%d/%m/%Y') as t59_fch_aprob,
	dsmb.t59_is_desemb, 
	dsmb.t60_mto_desemb, 
	dsmb.usr_crea, 
	dsmb.fch_crea, 
	dsmb.usr_actu, 
	dsmb.fch_actu, 
	dsmb.est_audi,
	proy.t01_id_inst,
	ejec.t01_sig_inst,
	proy.t02_cod_proy,
	proy.t02_nom_proy,
	con.abr_conc AS nomconcurso,
	con.num_conc AS concurso,
	ejec.t01_ruc_inst,
	proy.t02_fch_isc,
	proy.t02_fch_ini,
	DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
	proy.t02_fch_ire,
	proy.t02_fch_tre,
	proy.t02_fch_tam,
	est.descrip AS estado,
	est.cod_ext AS codestado,
	1 AS trim_desembolsar,
	fn_monto_desembolsado_periodo(proy.t02_cod_proy,1,1 ) AS total_desembolsado,
	cta.t01_id_cta
FROM t59_aprob_primer_desemb dsmb
LEFT  JOIN t02_dg_proy  proy  ON (dsmb.t02_cod_proy = proy.t02_cod_proy AND proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
LEFT  JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
LEFT  JOIN adm_concursos  con ON (SUBSTRING(proy.t02_cod_proy,3,2) = con.num_conc)
LEFT  JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
LEFT  JOIN t02_proy_ctas cta ON (proy.t02_cod_proy=cta.t02_cod_proy)
where t59_id_aprob=_idaprob;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_banco` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_banco`(IN _numero int)
BEGIN
    SELECT 
        t00_nom_lar AS nombre, 
        t00_nom_abre AS abreviatura, 
        t00_cod_bco AS numero
    FROM t00_bancos
    WHERE t00_cod_bco = _numero;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_cambio_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_cambio_personal`(IN _proy VARCHAR(10), IN _idsol INT)
BEGIN
DECLARE  _saldopartida DOUBLE ;
DECLARE  _monto_ejecutado DOUBLE ;
DECLARE  _idper INT ;
SELECT ep.t04_carg_equi
  INTO _idper 
  FROM t04_sol_cambio_per    sc
LEFT JOIN t04_equi_proy      ep ON (sc.t02_cod_proy=ep.t02_cod_proy AND sc.t04_id_equi_cambio=ep.t04_id_equi)
 WHERE sc.t02_cod_proy = _proy
   AND sc.t04_num_soli = _idsol ;
   
SELECT SUM(t41_gasto)
  INTO _monto_ejecutado
  FROM t41_inf_financ_gasto 
 WHERE t02_cod_proy = _proy
   AND t08_cod_comp = 10 
   AND t09_cod_act  = 1  
   AND t09_cod_sub  = 12 
   AND t41_cate_gasto = _idper 
   AND t41_fte_finan  = 10 ; 
   
SET _saldopartida = ( fn_monto_total_planificado_mp_fte(_proy,1,1,NULL,_idper,10) - _monto_ejecutado) ;
SELECT 	      sc.t02_cod_proy
	    , sc.t04_num_soli
	    , sc.t04_dni_equi
	    , sc.t04_ape_pat
	    , sc.t04_ape_mat
	    , sc.t04_nom_equi
	    , sc.t04_sexo_equi
	    , sc.t04_edad_equi
	    , sc.t04_cali_equi
	    , sc.t04_mail_equi
	    , sc.t04_telf_equi
	    , sc.t04_cel_equi
	    , 	(	
		SELECT per.t03_nom_per
		FROM t03_mp_per per
		WHERE per.t02_cod_proy=_proy
		AND per.t02_version=1
		AND per.t03_id_per=sc.t04_carg_equi
		) AS cargo	    
	    , sc.t04_carg_equi
	    , sc.t04_esp_equi
			, DATE_FORMAT(sc.t04_fec_ini,'%d/%m/%Y') AS t04_fec_ini
			, DATE_FORMAT(sc.t04_fec_ter,'%d/%m/%Y') AS t04_fec_ter
	    , sc.t04_func_equi
	    , sc.t04_exp_lab
	    , sc.t04_adj_cv
	    , sc.t04_adj_sol
	    , sc.t04_id_equi_cambio
	    , sc.t04_saldo_part
	    , sc.t04_obs_ejec
	    , sc.t04_aprob_mt
	    , sc.t04_aprob_mf
	    , sc.t04_aprob_cmt
	    , sc.t04_aprob_cmf
	    , sc.t04_resp_ejec
	    , sc.t04_resp_ejec_obs
			, (SELECT aux.descrip FROM adm_tablas_aux aux where aux.codi = sc.t04_sexo_equi) As sexo
			, (SELECT aux.descrip FROM adm_tablas_aux aux where aux.codi = sc.t04_cali_equi) As instruccion
	    , DATE_FORMAT(sc.fch_crea,'%d/%m/%Y') AS fch_crea
	    , usr_actu
	    , _saldopartida AS 'saldo_partida'
FROM t04_sol_cambio_per sc
WHERE sc.t02_cod_proy = _proy
   AND sc.t04_num_soli = _idsol ;
			
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_cambio_personal_all` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_cambio_personal_all`()
BEGIN
  
SELECT 	sc.t02_cod_proy
	    , sc.t04_num_soli
	    , sc.t04_dni_equi
	    , sc.t04_ape_pat
	    , sc.t04_ape_mat
	    , sc.t04_nom_equi
	    , sc.t04_sexo_equi
	    , sc.t04_edad_equi
	    , sc.t04_cali_equi
	    , sc.t04_mail_equi
	    , sc.t04_telf_equi
	    , sc.t04_cel_equi
	    , 	(	
		SELECT per.t03_nom_per
		FROM t03_mp_per per
		WHERE per.t02_cod_proy=sc.t02_cod_proy
	  AND per.t02_version=1
		AND per.t03_id_per=sc.t04_carg_equi
		) AS cargo	    
	    , sc.t04_carg_equi
	    , sc.t04_esp_equi
			, DATE_FORMAT(sc.t04_fec_ini,'%d/%m/%Y') AS t04_fec_ini
			, DATE_FORMAT(sc.t04_fec_ter,'%d/%m/%Y') AS t04_fec_ter
	    , sc.t04_func_equi
	    , sc.t04_exp_lab
	    , sc.t04_adj_cv
	    , sc.t04_adj_sol
	    , sc.t04_id_equi_cambio
	    , sc.t04_saldo_part
	    , sc.t04_obs_ejec
	    , sc.t04_aprob_mt
	    , sc.t04_aprob_mf
	    , sc.t04_aprob_cmt
	    , sc.t04_aprob_cmf
	    , sc.t04_resp_ejec
	    , sc.t04_resp_ejec_obs
			, (SELECT aux.descrip FROM adm_tablas_aux aux where aux.codi = sc.t04_sexo_equi) As sexo
			, (SELECT aux.descrip FROM adm_tablas_aux aux where aux.codi = sc.t04_cali_equi) As instruccion
	    , DATE_FORMAT(sc.fch_crea,'%d/%m/%Y') AS fch_crea
	    , usr_actu
	    , (fn_monto_total_planificado_mp_fte(sc.t02_cod_proy,1,1,NULL,(SELECT ep.t04_carg_equi
  FROM t04_sol_cambio_per    scc
LEFT JOIN t04_equi_proy      ep ON (scc.t02_cod_proy=ep.t02_cod_proy AND scc.t04_id_equi_cambio=ep.t04_id_equi)
 WHERE scc.t02_cod_proy = sc.t02_cod_proy
   AND scc.t04_num_soli = sc.t04_num_soli),10) - (SELECT ifnull(SUM(t41_gasto),0)
  FROM t41_inf_financ_gasto 
 WHERE t02_cod_proy = sc.t02_cod_proy
   AND t08_cod_comp = 10 
   AND t09_cod_act  = 1  
   AND t09_cod_sub  = 12 
   AND t41_cate_gasto = (SELECT ep.t04_carg_equi
  FROM t04_sol_cambio_per    scc
LEFT JOIN t04_equi_proy      ep ON (scc.t02_cod_proy=ep.t02_cod_proy AND scc.t04_id_equi_cambio=ep.t04_id_equi)
 WHERE scc.t02_cod_proy = sc.t02_cod_proy
   AND scc.t04_num_soli = sc.t04_num_soli)
   AND t41_fte_finan  = 10)) AS 'saldo_partida'
FROM t04_sol_cambio_per sc;
			
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_cartafianza` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_cartafianza`( IN _proy VARCHAR(10), in _id int )
BEGIN
SELECT  cf.t02_cod_proy, 
	cf.t02_id_cf, 
	cf.t02_id_bco, 
	bco.t00_nom_lar AS 'banco',
	cf.t02_des_cf, 
	cf.t02_mto_cf, 
	cf.t02_num_cf, 
	cf.t02_ser_cf, 
	DATE_FORMAT(cf.t02_frec_cf,'%d/%m/%Y')  AS 't02_frec_cf', 
	DATE_FORMAT(cf.t02_fgir_cf,'%d/%m/%Y')  AS 't02_fgir_cf', 
	DATE_FORMAT(cf.t02_fven_cf,'%d/%m/%Y')  AS 't02_fven_cf', 
	cf.t02_est_cf, 
	est.descrip     AS 'estado' ,
	cf.t02_vb_adm, 
	cf.t02_obs_adm, 
	cf.t02_file_cf, 
	cf.usu_crea, 
	cf.fch_crea, 
	cf.usu_actu, 
	cf.fch_actu, 
	cf.est_audi
fROM 	t02_carta_fianza cf
LEFT JOIN t00_bancos       bco ON (cf.t02_id_bco = bco.t00_cod_bco)  
LEFT JOIN adm_tablas_aux   est ON (est.idTabla=24 AND cf.t02_est_cf = est.cod_ext)
WHERE cf.t02_cod_proy = _proy 
  and cf.t02_id_cf = _id  ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_concepto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_concepto`(IN in_concepto VARCHAR(30), IN in_numero INT)
BEGIN
    CASE in_concepto
        WHEN 'linea' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_linea AS numero
            FROM t00_linea
            WHERE t00_cod_linea = in_numero;
        WHEN 'tasa' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_tasa AS numero
            FROM t00_tasa
            WHERE t00_cod_tasa = in_numero;
        WHEN 'parametro' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_param AS numero
            FROM t00_parametro
            WHERE t00_cod_param = in_numero;
        WHEN 'banco' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_bco AS numero
            FROM t00_bancos
            WHERE t00_cod_bco = in_numero;
        WHEN 'moneda' THEN 
           SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_mon AS numero
            FROM t00_tipo_moneda 
            WHERE t00_cod_mon = in_numero;
        WHEN 'tipo_anexo' THEN 
            SELECT 
                t02_anx_tip_desc AS nombre, 
                t02_anx_tip_abrev AS abreviatura, 
                t02_anx_tip_cod AS numero
            FROM t02_proy_anx_tip
            WHERE t02_anx_tip_cod = in_numero;
        WHEN 'tipo_cuenta' THEN 
           SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_cta AS numero
            FROM t00_tipo_cuenta 
            WHERE t00_cod_cta = in_numero;
    END CASE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_concursos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_concursos`(IN _numero int)
BEGIN
SELECT num_conc ,
			 anio_conc,
			 nom_conc,
			 abr_conc,
			 coment_conc,
	 usr_crea,
	 fec_crea
    FROM adm_concursos
   where num_conc = _numero ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_contacto_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_contacto_inst`(IN _inst INT, IN _idcto INT)
BEGIN
SELECT 	t01_id_inst, 
	t01_id_cto, 
	t01_dni_cto, 
	t01_ape_pat, 
	t01_ape_mat, 
	t01_nom_cto, 
	t01_fono_ofi, 
	t01_mail_cto, 
	t01_mail_cto2, 
	t01_cel_cto, 
	t01_cgo_cto,
	t.descrip AS cargo,
	t01_tel2_cto, 
	t01_rpm_cto, 
	t01_fax_cto, 
	t01_rpc_cto, 
	t01_nex_cto,
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu, 
	est_audi,
t01_sexo
 FROM     t01_inst_cto
LEFT JOIN adm_tablas_aux t ON (t01_inst_cto.t01_cgo_cto=t.codi)
WHERE t01_id_inst = _inst 
  AND t01_id_cto=_idcto ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_costeo`(IN _proy varchar(10), IN _ver int, IN _comp int, IN _activ int, IN _subactiv int, IN _costeo int)
BEGIN
SELECT 	* 
FROM 	   t10_cost_sub  cost 
WHERE 	    cost.t02_cod_proy=_proy
    AND 	    cost.t02_version=_ver
    AND 	    cost.t08_cod_comp=_comp
    AND 	    cost.t09_cod_act=_activ
    AND 	    cost.t09_cod_sub = _subactiv
    AND 	    cost.t10_cod_cost=_costeo  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_costos_ejecutados` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_get_costos_ejecutados`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
    DECLARE aCont       INT;
    DECLARE aAnio       INT;
    DECLARE aTotEjec    DOUBLE;
    DECLARE aCostPers   DOUBLE;
    DECLARE aCostEquip  DOUBLE;
    DECLARE aCostFunc   DOUBLE;
    DECLARE aCostAdm    DOUBLE;
    DECLARE aCostImpr   DOUBLE;
    DECLARE aCostSup   DOUBLE;
    
    SELECT 1, 0, 0, 0, 0, 0, 0, 0
    INTO aCont, aTotEjec, aCostPers, aCostEquip, aCostFunc, aCostAdm, aCostImpr, aCostSup;
    
    WHILE aCont < _ver DO
        SELECT fn_anio_x_version_proy(_proy, aCont) INTO aAnio;
        SELECT fn_costo_componentes_anio(_proy, aAnio) + aTotEjec INTO aTotEjec;
        SELECT fn_costos_ejecutados_anio(_proy, aAnio, 1) + aCostPers INTO aCostPers;
        SELECT fn_costos_ejecutados_anio(_proy, aAnio, 2) + aCostEquip INTO aCostEquip;
        SELECT fn_costos_ejecutados_anio(_proy, aAnio, 3) + aCostFunc INTO aCostFunc;
        SELECT fn_costos_ejecutados_anio(_proy, aAnio, 4) + aCostAdm INTO aCostAdm;
        SELECT fn_costos_ejecutados_anio(_proy, aAnio, 6) + aCostImpr INTO aCostImpr;
        SELECT fn_costos_ejecutados_anio(_proy, aAnio, 7) + aCostSup INTO aCostSup;
        SET aCont = aCont + 1;
    END WHILE;
    
    SELECT  aCostPers   AS  'CostoPersonal',
            aCostEquip  AS  'CostoEquipamiento',
            aCostFunc   AS  'CostoFuncionamiento',
            aCostAdm    AS  'CostoAdministrativo',
            aCostImpr   AS  'CostoImprevisto',
            aCostSup    AS  'CostoSupervision',
            aTotEjec    AS  'TotalEjecutado';
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_cuenta` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_get_cuenta`(IN _inst INT, IN _idcta INT)
BEGIN
SELECT cta.t01_id_cta,
    bco.t00_nom_lar AS banco,
    bco.t00_nom_abre AS banco2,
    tcta.t00_nom_lar AS tipocuenta,
    mon.t00_nom_lar AS moneda,
    cta.t01_nro_cta AS nrocuenta,
    cta.t01_txt_ref AS textoref,
    bco.t00_cod_bco AS cod_bco,
    tcta.t00_cod_cta AS tip_cta,
    mon.t00_cod_mon AS cod_mon
FROM      t01_inst_ctas    cta
LEFT JOIN t00_bancos       bco ON(cta.t00_cod_bco = bco.t00_cod_bco)
LEFT JOIN t00_tipo_cuenta tcta ON(cta.t00_cod_cta = tcta.t00_cod_cta)
LEFT JOIN t00_tipo_moneda  mon ON(cta.t00_cod_mon = mon.t00_cod_mon)
WHERE  cta.t01_id_inst = _inst 
  AND  cta.t01_id_cta  = _idcta;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_cuenta_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_cuenta_proyecto`(IN _proy varchar(10))
BEGIN
SELECT 	cta.t01_id_cta,
	bco.t00_nom_lar,
	bco.t00_nom_abre,
	tcta.t00_nom_lar,
	mon.t00_nom_lar,
	cta.t01_nro_cta,
	cta.t01_txt_ref,
	cta.t01_cta_def,
	bco.t00_nom_lar AS banco,
	tcta.t00_nom_lar AS tipocuenta,
	CONCAT(cta.t01_nro_cta, ' - ', bco.t00_nom_abre ) AS descripcion,
	mon.t00_nom_abre AS moneda,
	cta.t00_cod_bco as cod_banco,
	cta.t00_cod_mon as cod_moneda ,
	cta.t00_cod_cta as cod_tipocuenta,
	pcta.t02_nom_benef as beneficiario
FROM 	  t02_proy_ctas    pcta
left join t01_inst_ctas    cta on(pcta.t01_id_inst = cta.t01_id_inst and pcta.t01_id_cta = cta.t01_id_cta )
LEFT JOIN t00_bancos       bco ON(cta.t00_cod_bco = bco.t00_cod_bco)
LEFT JOIN t00_tipo_cuenta tcta ON(cta.t00_cod_cta = tcta.t00_cod_cta)
LEFT JOIN t00_tipo_moneda  mon ON(cta.t00_cod_mon = mon.t00_cod_mon)
WHERE  pcta.t02_cod_proy = _proy 
  AND  pcta.est_audi='1';
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_desembolso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_desembolso`(
			IN  _proy VARCHAR(10), 
			IN  _trim INT,
			IN  _iddesemb INT )
BEGIN
  
select  t02_cod_proy,
	t60_id_trim,
	t60_id_desemb,
	t60_tip_pago , 
	t60_inst_ori , 
	t60_cta_ori  , 
	t01_id_inst  , 
	t01_id_cta   , 
	t60_nom_benef, 
	DATE_FORMAT(t60_fch_giro,'%d/%m/%Y') as t60_fch_giro, 
	DATE_FORMAT(t60_fch_depo ,'%d/%m/%Y') AS t60_fch_depo , 
	t60_mto_des  , 
	t60_nro_cheque  , 
	t60_obs_tippago , 
	usr_actu 
from t60_ejecucion_desemb 
    WHERE t02_cod_proy = _proy 
      AND t60_id_trim = _trim
      AND t60_id_desemb = _iddesemb ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_desembolso_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_desembolso_me`(
			IN  _proy VARCHAR(10), 
			IN  _visita INT,
			IN  _aprob INT,
			IN  _iddesemb INT)
BEGIN
  
select  t02_cod_proy,
	t60_id_visita,
	t60_id_nropago,
	t60_id_desemb,
	t60_tip_pago , 
	t60_inst_ori , 
	t60_cta_ori  , 
	t01_id_inst  , 
	t01_id_cta   , 
	t60_nom_benef, 
	DATE_FORMAT(t60_fch_giro,'%d/%m/%Y') as t60_fch_giro, 
	DATE_FORMAT(t60_fch_depo ,'%d/%m/%Y') AS t60_fch_depo , 
	t60_mto_des  , 
	t60_nro_cheque  , 
	t60_obs_tippago , 
	usr_actu 
from t60_ejecucion_desemb_me 
    WHERE t02_cod_proy = _proy 
      AND t60_id_visita = _visita
      and t60_id_nropago = _aprob
      AND t60_id_desemb = _iddesemb ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_equi_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_equi_fe`(IN _id INT )
BEGIN
SELECT  fe.t90_id_equi, 
	fe.t90_dni_equi, 
	fe.t90_ape_pat, 
	fe.t90_ape_mat, 
	fe.t90_nom_equi, 
	fe.t90_sexo_equi, 
	fe.t90_edad_equi, 
	fe.t90_cali_equi, 
	fe.t90_mail_equi, 
	fe.t90_telf_equi, 
	fe.t90_unid_fe, 
	fe.t90_carg_equi, 
	fe.t90_func_equi, 
	fe.t90_direccion,
	fe.t90_estado, 
	fe.usr_crea, 
	fe.fch_crea, 
	fe.usr_actu, 
	fe.fch_actu, 
	fe.est_audi 
FROM  t90_equi_fe fe 
WHERE fe.t90_id_equi = _id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_get_inf_financ`(IN _proy VARCHAR(10), 
                      IN _anio INT,
                      IN _mes  INT)
BEGIN
	SELECT  inf.t02_cod_proy, 
	    inf.t40_anio, 
	    inf.t40_mes, 
	    DATE_FORMAT(inf.t40_fch_pre,'%d/%m/%Y') AS t40_fch_pre, 
	    inf.t40_periodo , 
	    inf.t40_est_eje , 
	    inf.t40_est_mon ,
	    inf.t40_obs,
	    inf.t40_obs_moni,
	    DATE_FORMAT(inf.t40_apro_fch,'%d/%m/%Y') AS t40_apro_fch,
	    t40_otro_ing, 
	    t40_abo_bco, 
	    t40_otro_ing_obs, 
	    t40_abo_bco_obs, 
	    DATE_FORMAT(inf.t40_cor_ctb,'%d/%m/%Y') AS t40_cor_ctb,
	    t40_caja, 
	    t40_bco_mn, 
	    t40_ent_rend, 
	    t40_cxc, 
	    t40_cxp, 
	    t40_exc,
	    t40_caja_obs, 
	    t40_bco_mn_obs, 
	    t40_ent_rend_obs, 
	    t40_cxc_obs, 
	    t40_cxp_obs, 
	    t40_obs_exc,
	    inf_fi_ter,
	    vb_se
	FROM 
	    t40_inf_financ inf
	WHERE inf.t02_cod_proy = _proy
	  AND inf.t40_anio     = _anio
	  AND inf.t40_mes      = _mes ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_financ_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_financ_mf`(IN _proy VARCHAR(10), in _idinf int)
BEGIN
select 	inf.t51_num, 
	DATE_FORMAT(inf.t51_fch_pre,'%d/%m/%Y') AS fecpre , 
	inf.t51_per_ini, 
	inf.t51_per_fin, 
	inf.t51_periodo, 
	inf.t51_estado, 
	inf.t51_obs, 
	inf.t51_conclu, 
	inf.t51_califica, 
	DATE_FORMAT(inf.t51_cor_ctb,'%d/%m/%Y') AS t51_cor_ctb , 
	inf.t51_caja,
	inf.t51_bco_mn,
	inf.t51_ent_rend,
	inf.t51_cxc,
	inf.t51_cxp,
	inf.t51_exc,
	inf.t51_caja_obs,
	inf.t51_bco_mn_obs,
	inf.t51_ent_rend_obs,
	inf.t51_cxc_obs,
	inf.t51_cxp_obs,
	inf.t51_obs_exc,
	inf.usr_crea, 
	inf.fch_crea, 
	inf.usr_actu, 
	inf.fch_actu, 
	inf.est_audi,
	inf.t51_obs_cmt
FROM 	t51_inf_mf inf
WHERE  inf.t02_cod_proy= _proy 
  and  inf.t51_num     = _idinf ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_fin_mes_ult` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_fin_mes_ult`(IN _proy VARCHAR(10))
BEGIN
  
  DECLARE _existe 	INT;
  DECLARE _t40_anio INT DEFAULT 1;
  DECLARE _t40_mes INT DEFAULT 1;
  DECLARE _new_anio INT DEFAULT 1;
  DECLARE _nuevo_mes INT DEFAULT 1;
  DECLARE _new_mes INT DEFAULT 1;
  DECLARE _periodo VARCHAR(20);
  declare _fec_ini datetime ;
  
  
select  p.t02_fch_ini 
into _fec_ini
from  t02_dg_proy p 
where p.t02_cod_proy = _proy 
  AND p.t02_version=1 ;
  
SELECT  COUNT(1)  
INTO _existe
FROM t40_inf_financ
WHERE t02_cod_proy = _proy;
	
  IF _existe > 0 THEN
      
 SELECT w.t40_anio,
	w.t40_mes,
	w.nuevo_mes,
	fn_numero_mes_rev(w.nuevo_mes,1) AS new_anio,
	fn_numero_mes_rev(w.nuevo_mes,2) AS new_mes,
	fn_nom_periodo(_proy,fn_numero_mes_rev(w.nuevo_mes,1),fn_numero_mes_rev(w.nuevo_mes,2)) AS periodo,
	montH(date_add(_fec_ini, interval (w.nuevo_mes -1) month )) as t40_periodo,
	45 as t40_est_eje,
	DATE_FORMAT(now(),'%d/%m/%Y') as t40_fch_pre
	FROM (
	SELECT  t40_anio, 
		t40_mes, 
		fn_numero_mes(t40_anio, t40_mes)+1 AS sig_mes,
		fn_numero_mes(t40_anio, t40_mes)+1 AS nuevo_mes
	FROM t40_inf_financ
	WHERE t02_cod_proy = _proy
	ORDER BY t40_anio DESC, t40_mes DESC 
	LIMIT 1 ) AS w ;
	
  ELSE  
  
	SELECT _t40_anio AS t40_anio 
	, _t40_mes AS t40_mes 
	, _nuevo_mes AS nuevo_mes 
	, _new_anio AS new_anio 
	, _new_mes AS new_mes 
	, MONTH(_fec_ini) AS t40_periodo
	, 45 AS t40_est_eje
	, DATE_FORMAT(NOW(),'%d/%m/%Y') AS t40_fch_pre ;    
     
  END IF ;	
	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_get_inf_mes`(IN _proy VARCHAR(10), 
                           IN _anio INT,
                           IN _mes  INT,
                           IN _vs   INT)
BEGIN
	SELECT  inf.t02_cod_proy, 
	        inf.t20_anio, 
	        inf.t20_mes, 
	        inf.t20_ver_inf AS vsinf, 
	        DATE_FORMAT(inf.t20_fch_pre,'%d/%m/%Y') AS t20_fch_pre, 
	        inf.t20_periodo , 
	        inf.t20_avance  , 
	        inf.t20_apro_mt , 
	        inf.t20_apro_fch, 
	        inf.t20_obs , 
	        inf.t20_estado ,
	        inf.t20_ver_inf,
	        inf.t20_dificul,
	        inf.t20_program,
	        est.descrip as estado,
	        vb_se
	FROM 
	      t20_inf_mes inf 
	left join adm_tablas_aux est on(inf.t20_estado = est.codi)
	WHERE   inf.t02_cod_proy     = _proy
	    AND inf.t20_anio     = _anio
	    AND inf.t20_mes      = _mes;    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_mes_ult` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_mes_ult`(IN _proy VARCHAR(10))
BEGIN
  
	DECLARE _existe   INT;
	DECLARE _t20_anio INT DEFAULT 1;
	DECLARE _t20_mes INT DEFAULT 1;
	DECLARE _new_anio INT DEFAULT 1;
	DECLARE _nuevo_mes INT DEFAULT 1;
	DECLARE _new_mes INT DEFAULT 1;
	DECLARE _periodo VARCHAR(20);
  
	SELECT  COUNT(1)  
	INTO _existe
	FROM t20_inf_mes
	WHERE t02_cod_proy = _proy;
    
    IF _existe > 0 THEN
        SELECT  
            w.t20_anio,
		    w.t20_mes,
		    w.nuevo_mes,
		    fn_numero_mes_rev(w.nuevo_mes,1) AS new_anio,
		    fn_numero_mes_rev(w.nuevo_mes,2) AS new_mes,
		    fn_nom_periodo(_proy,fn_numero_mes_rev(w.nuevo_mes,1),fn_numero_mes_rev(w.nuevo_mes,2)) AS periodo 
        FROM (
			SELECT 
                t20_anio, 
			    t20_mes, 
			    fn_numero_mes(t20_anio, t20_mes)+1 AS sig_mes,
			    
			    fn_numero_mes(t20_anio, t20_mes)+1 AS nuevo_mes
			FROM t20_inf_mes
			WHERE t02_cod_proy = _proy
			ORDER BY t20_anio DESC, t20_mes DESC 
			LIMIT 1) AS w;
    ELSE  
		SELECT _t20_anio AS t20_anio 
		, _t20_mes AS t20_mes 
		, _nuevo_mes AS nuevo_mes 
		, _new_anio AS new_anio 
		, _new_mes AS new_mes 
		, fn_nom_periodo(_proy,1,1) AS periodo;    
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_monext_fecha` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_monext_fecha`(IN _proy VARCHAR(10), 
					   IN _fecha varchar(10))
BEGIN
	SELECT 	
		inf.*,
		fn_puntaje_califica_inf_me(inf.t02_cod_proy, inf.t30_id, inf.t30_ver_inf) AS puntaje
	FROM t30_inf_me inf 
	WHERE inf.t02_cod_proy = _proy
	  AND DATE_FORMAT(inf.t30_fch_pre,'%d/%m/%Y') = _fecha ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_monint_fecha` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_monint_fecha`(IN _proy VARCHAR(10), 
					   IN _fecha VARCHAR(10))
BEGIN
	SELECT 	
		inf.*,
		fn_puntaje_califica_inf_monint(inf.t02_cod_proy, inf.t45_id, inf.t45_ver_inf) AS puntaje
	FROM t45_inf_mi inf 
	WHERE inf.t02_cod_proy = _proy
	  AND DATE_FORMAT(inf.t45_fch_pre,'%d/%m/%Y') = _fecha ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_get_inf_se`(IN _proy VARCHAR(10), 
               IN _anio INT,
               IN _entregable INT)
BEGIN
    SELECT  
            t02_cod_proy,
            t02_anio,
            t02_entregable, 
            DATE_FORMAT(t30_fch_pre,'%d/%m/%Y') AS fch_pre, 
            t30_periodo AS periodo,
            t30_estado AS estado, 
            t30_intro, 
            t30_fuentes, 
            DATE_FORMAT(t30_fec_ini_vis,'%d/%m/%Y') AS iniVisita, 
            DATE_FORMAT(t30_fec_ter_vis,'%d/%m/%Y') AS terVisita, 
            t30_crit_eva1, 
            t30_crit_eva2, 
            t30_crit_eva3, 
            t30_crit_eva4, 
            t30_crit_eva5, 
            t30_crit_eva6,
            t30_crit_eva7,
            t30_apro, 
            t30_apro_fch, 
            t30_avance, 
            t30_logros, 
            t30_dificul, 
            t30_reco_proy, 
            t30_reco_fe, 
            t30_califica, 
            usr_crea, 
            fch_crea, 
            usr_actu, 
            fch_actu, 
            est_audi,
            fn_puntaje_califica_inf_se(t02_cod_proy, t02_anio, t02_entregable) AS puntaje,
            t30_obs AS obsGP
    FROM    t30_inf_se
    WHERE   t02_cod_proy = _proy
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_get_inf_si`(IN _proy VARCHAR(10), 
               IN _anio INT,
               IN _entregable INT)
BEGIN
    SELECT  
            t02_cod_proy,
            t02_anio,
            t02_entregable, 
            DATE_FORMAT(t45_fch_pre,'%d/%m/%Y') AS fch_pre, 
            t45_periodo AS periodo,
            t45_estado AS estado, 
            t45_intro, 
            t45_fuentes, 
            DATE_FORMAT(t45_fec_ini_vis,'%d/%m/%Y') AS iniVisita, 
            DATE_FORMAT(t45_fec_ter_vis,'%d/%m/%Y') AS terVisita, 
            t45_crit_eva1, 
            t45_crit_eva2, 
            t45_crit_eva3, 
            t45_crit_eva4, 
            t45_crit_eva5, 
            t45_crit_eva6,
            t45_crit_eva7,
            t45_apro, 
            t45_apro_fch, 
            t45_avance, 
            t45_logros, 
            t45_dificul, 
            t45_reco_proy, 
            t45_reco_fe, 
            t45_califica, 
            usr_crea, 
            fch_crea, 
            usr_actu, 
            fch_actu, 
            est_audi,
            fn_puntaje_califica_inf_si(t02_cod_proy, t02_anio, t02_entregable) AS puntaje,
            t45_obs AS obsGP
    FROM    t45_inf_si
    WHERE   t02_cod_proy = _proy
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_trim`(IN _proy VARCHAR(10), 
			   IN _anio INT,
			   in _trim  int,
			   in _vs   int)
BEGIN
	SELECT 	inf.t02_cod_proy, 
		inf.t25_anio, 
		inf.t25_trim, 
		inf.t25_ver_inf AS vsinf, 
		DATE_FORMAT(inf.t25_fch_pre,'%d/%m/%Y') AS t25_fch_pre, 
		inf.t25_periodo, 
		inf.t25_estado, 
		inf.t25_resulta, 
		inf.t25_conclu, 
		inf.t25_ver_inf,
		inf.obs_mt
	FROM  t25_inf_trim inf
	WHERE   inf.t02_cod_proy = _proy
	  AND   inf.t25_anio     = _anio
	  AND   inf.t25_trim     = _trim
	  AND   inf.t25_ver_inf  = _vs ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_trim_ult` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_trim_ult`(IN _proy VARCHAR(10))
BEGIN
  
  DECLARE _existe 	INT;
  DECLARE _anio INT DEFAULT 1;
  DECLARE _trim INT DEFAULT 1;
  DECLARE _new_anio INT DEFAULT 1;
  DECLARE _nuevo_trim INT DEFAULT 1;
  DECLARE _periodo VARCHAR(20);
SELECT  COUNT(1)  
  INTO _existe
  FROM t25_inf_trim
 WHERE t02_cod_proy = _proy;
  IF _existe > 0 THEN
      
      	SELECT  _proy AS 't02_cod_proy',
		fn_numero_trim_rev(w.nuevo_trim,1) AS 't25_anio',
		fn_numero_trim_rev(w.nuevo_trim,2) AS 't25_trim',
		1 AS vsinf,
		DATE_FORMAT(NOW(),'%d/%m/%Y') AS 't25_fch_pre',
		fn_nom_periodo_trim(_proy, w.nuevo_trim) AS 't25_periodo',
		45 as 't25_estado',
		1 as 't25_ver_inf'
	FROM (
		SELECT  t25_anio, 
			t25_trim, 
			fn_numero_trim(t25_anio, t25_trim)+1 AS nuevo_trim
		FROM t25_inf_trim
		WHERE t02_cod_proy = _proy
		ORDER BY nuevo_trim DESC 
		LIMIT 1 
	     ) AS w;
	
  ELSE  
  
	SELECT 	_proy AS 't02_cod_proy',
		_new_anio AS 't25_anio',
		_trim AS 't25_trim',
		1 AS vsinf,
		DATE_FORMAT(NOW(),'%d/%m/%Y') AS 't25_fch_pre',
		fn_nom_periodo_trim(_proy,1) AS 't25_periodo',
		45 AS 't25_estado',
		1 AS 't25_ver_inf';    
  END IF ;	
	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_unico_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_unico_anual`(IN _proy VARCHAR(10), 
			   IN _anio INT)
BEGIN
	SELECT 	inf.t02_cod_proy, 
		inf.t55_id, 
		inf.t55_anio, 
		DATE_FORMAT(inf.t55_fch_pre,'%d/%m/%Y') AS t55_fch_pre, 
		inf.t55_periodo, 
		inf.t55_estado, 
		inf.t55_logros, 
		inf.t55_dificultades, 
		inf.t55_recomendaciones,
		inf.t55_per_ini AS ini,
		inf.t55_per_fin AS fin,
		inf.t55_mt,
		inf.t55_mf,
		inf.t55_cmt,
		inf.t55_cmf
	FROM  t55_inf_unico_anual inf
	WHERE   inf.t02_cod_proy = _proy
	  AND   inf.t55_anio     = _anio;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_unico_anual_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_unico_anual_periodo`(IN _proy VARCHAR(10), IN _idinf INT)
BEGIN
SELECT 	inf.t55_id, 
	DATE_FORMAT(inf.t55_fch_pre,'%d/%m/%Y') AS fecpre , 
	inf.t55_per_ini, 
	inf.t55_per_fin, 
	inf.t55_periodo, 
	inf.t55_estado,
	inf.t55_avan_comp,
	inf.t55_avan_cap,
	inf.t55_avan_fin,
	t55_eva1, 
	t55_eva2, 
	t55_eva3, 
	t55_eva4, 
	t55_eva5, 
	t55_eva6, 
	t55_eva7, 
	t55_eva1_obs, 
	t55_eva2_obs, 
	t55_eva3_obs, 
	t55_eva4_obs, 
	t55_eva5_obs, 
	t55_eva6_obs, 
	t55_eva7_obs, 
	t55_logros, 
	t55_dificultades, 
	t55_reco_proy, 
	t55_reco_fe, 
	t55_recomendaciones, 
	t55_mt,
	t55_mf,
	t55_cmt,
	t55_cmf,
	inf.usr_crea, 
	inf.fch_crea, 
	inf.usr_actu, 
	inf.fch_actu, 
	inf.est_audi,
	fn_puntaje_califica_inf_unico_anual(inf.t02_cod_proy, inf.t55_id) AS puntaje
FROM 	t55_inf_unico_anual inf
WHERE  inf.t02_cod_proy= _proy 
  AND  inf.t55_id     = _idinf ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_unico_anual_ult` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_unico_anual_ult`(IN _proy VARCHAR(10))
BEGIN
  
  DECLARE _existe 	INT;
  DECLARE _t55_anio INT DEFAULT 1;
    
	SELECT  COUNT(1)  
	INTO _existe
	FROM t55_inf_unico_anual
	WHERE t02_cod_proy = _proy;
	
  IF _existe > 0 THEN
      
	SELECT  t55_anio, 
		t55_anio+1 sig_anio,
		fn_nom_periodo_anio(_proy,t55_anio) AS periodo,
		t55_per_ini AS ini,
		t55_per_fin AS fin
	FROM 	t55_inf_unico_anual
	WHERE 	t02_cod_proy = _proy
	ORDER BY t55_anio DESC
	LIMIT 1 ; 
	
  ELSE  
  
	SELECT _t55_anio AS t55_anio , fn_nom_periodo_anio(_proy,1) AS periodo, 1 AS ini, 12 as fin;    
     
  END IF ;	
	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_inf_visita_financ_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_inf_visita_financ_mf`(IN _proy VARCHAR(10), IN _idinf INT)
BEGIN
SELECT 	inf.t02_cod_proy, 
	inf.t52_num, 
	inf.t52_tipo_vis, 
	inf.t52_per_ini, 
	inf.t52_per_fin, 
	inf.t52_nom_per_ent, 
	inf.t52_car_per_ent, 
	inf.t52_quest_01, 
	inf.t52_obs_01, 
	inf.t52_quest_02, 
	inf.t52_obs_02, 
	inf.t52_quest_03, 
	inf.t52_obs_03, 
	inf.t52_quest_04, 
	inf.t52_obs_04, 
	inf.t52_quest_05, 
	inf.t52_obs_05, 
	inf.t52_quest_06, 
	inf.t52_obs_06, 
	inf.t52_quest_07, 
	inf.t52_obs_07, 
	inf.t52_quest_08, 
	inf.t52_obs_08, 
	inf.t52_quest_09, 
	inf.t52_obs_09, 
	inf.t52_quest_10, 
	inf.t52_obs_10, 
	inf.t52_quest_11, 
	inf.t52_obs_11, 
	inf.t52_quest_12, 
	inf.t52_obs_12, 
	inf.t52_quest_13, 
	inf.t52_obs_13, 
	inf.t52_quest_14, 
	inf.t52_obs_14, 
	inf.t52_quest_15, 
	inf.t52_obs_15, 
	inf.t52_quest_16, 
	inf.t52_obs_16, 
	inf.t52_quest_17, 
	inf.t52_obs_17, 
	inf.t52_quest_18, 
	inf.t52_obs_18, 
	inf.t52_quest_19, 
	inf.t52_obs_19, 
	inf.t52_quest_20, 
	inf.t52_obs_20, 
	inf.t52_quest_21, 
	inf.t52_obs_21, 
	inf.t52_quest_22, 
	inf.t52_obs_22, 
	inf.t52_quest_23, 
	inf.t52_obs_23, 
	DATE_FORMAT((CASE WHEN inf.t52_fch_pre=0 THEN NULL ELSE inf.t52_fch_pre END),'%d/%m/%Y') AS t52_fch_pre , 
	inf.t52_estado, 
	inf.t52_obs, 
	inf.t52_conclu, 
	inf.t52_califica, 
	inf.t52_periodo, 
	inf.usr_crea, 
	inf.fch_crea, 
	inf.usr_actu, 
	inf.fch_actu, 
	inf.est_audi,
inf.t52_obs_cmt
FROM   t52_inf_visita_mf inf
WHERE  inf.t02_cod_proy = _proy 
  AND  inf.t52_num      = _idinf ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_institucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_institucion`( IN _t01_id_inst  INT  )
BEGIN
select 	t01_id_inst, 
	t01_ruc_inst, 
	t01_sig_inst, 
	t01_nom_inst, 
	DATE_FORMAT(t01_fch_fund,'%d/%m/%Y') as t01_fch_fund, 
	t01_pres_anio, 
	t01_dpto, 
	t01_prov, 
	t01_dist, 
	t01_dire_inst, 
	t01_ciud_inst, 
	t01_fono_inst, 
	t01_fax_inst, 
	t01_mail_inst, 
	t01_web_inst, 
	t01_ape_rep, 
	t01_nom_rep, 
	t01_carg_rep, 
	t01_tipo_inst, 
	t01_fono2_inst, 
	t01_rpm_inst, 
	t01_next_inst, 
	t01_rpc_inst, 
	usr_crea, 
	fch_crea, 
	est_audi
	from t01_dir_inst 
	where t01_id_inst= _t01_id_inst ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_menu` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_menu`(IN _mnu varchar(20) )
BEGIN
SELECT 	mnu_cod as codigo, 
	mnu_nomb as titulo, 
	mnu_apli as aplicacion, 
	mnu_link as link, 
	mnu_target as target, 
	mnu_parent as parent, 
	mnu_activo as activo, 
	mnu_class  as clase, 
	mnu_sort   as orden, 
	mnu_img    as link_imagen, 
	mnu_admin  as es_admin
	FROM adm_menus 
   where mnu_cod = _mnu ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_mp_equipa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_mp_equipa`(IN _proy VARCHAR(10), 
				    IN _ver   INT,
				    IN _per  INT  )
BEGIN
select  equi.t02_cod_proy, 
	equi.t02_version, 
	equi.t03_id_equi, 
	equi.t03_nom_equi, 
	equi.t03_um, 
	equi.t03_cu,
	equi.t03_cant,
	equi.t03_costo, 
	equi.t03_costo_tot, 
	equi.usr_crea, 
	equi.fch_crea, 
	equi.est_audi,
	(select SUM(mta.t03_mta) 
	 from t03_mp_equi_metas mta 
	 where mta.t02_cod_proy= equi.t02_cod_proy  
	   and mta.t02_version = equi.t02_version
	   and mta.t03_id_equi = equi.t03_id_equi) as meta
from t03_mp_equi equi
WHERE equi.t02_cod_proy = _proy
  AND equi.t02_version  = _ver
  AND equi.t03_id_equi  = _per ;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_mp_gasfunc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_mp_gasfunc`(IN _proy VARCHAR(10), 
				     IN _ver   INT,
				     IN _part  INT  )
BEGIN
select  parti.t02_cod_proy, 
	parti.t02_version, 
	parti.t03_partida, 
	parti.t03_um, 
	parti.t03_meta as meta, 
	parti.usr_crea, 
	parti.fch_crea, 
	parti.usr_actu, 
	parti.fch_actu, 
	parti.est_audi
from t03_mp_gas_fun_part parti
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version  = _ver
  AND parti.t03_partida  = _part ;
  	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_mp_gasfunc_gasto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_mp_gasfunc_gasto`(IN _proy VARCHAR(10), 
				     IN _ver   INT,
				     IN _part  INT,  
				     in _gasto int)
BEGIN
select  cost.t02_cod_proy, 
	cost.t02_version, 
	cost.t03_partida, 
	cost.t03_id_gasto, 
	cost.t03_descrip, 
	cost.t03_um, 
	cost.t03_cu, 
	cost.t03_cant, 
	cost.t03_cat_gast, 
	cost.usr_crea, 
	cost.fch_crea, 
	cost.usr_actu, 
	cost.fch_actu, 
	cost.est_audi,
	parti.t03_meta
from t03_mp_gas_fun_cost cost
inner join t03_mp_gas_fun_part parti on (cost.t02_cod_proy=parti.t02_cod_proy and cost.t02_version=parti.t02_version and cost.t03_partida=parti.t03_partida)
WHERE cost.t02_cod_proy = _proy
  AND cost.t02_version  = _ver
  AND cost.t03_partida  = _part 
  and cost.t03_id_gasto = _gasto ;
  	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_mp_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_mp_personal`(IN _proy VARCHAR(10), 
				   IN _ver   INT,
				   IN _per  INT)
BEGIN
SELECT  per.t02_cod_proy, 
	per.t02_version, 
	per.t03_id_per, 
	per.t03_nom_per, 
	per.t03_tdr, 
	per.t03_tdr_file, 
	per.t03_um, 
	aux.descrip, 
	per.t03_dedica, 
	per.t03_remu,	 
	per.t03_perma, 
	per.t03_remu_prom, 
	per.t03_gasto_tot, 
	per.usr_crea, 
	per.fch_crea, 
	est_audi,
	(SELECT SUM(mta.t03_mta) 
	 FROM t03_mp_per_metas mta 
	 WHERE mta.t02_cod_proy=per.t02_cod_proy  
	   AND mta.t02_version =per.t02_version
	   AND mta.t03_id_per  = per.t03_id_per) AS meta
FROM t03_mp_per per
LEFT JOIN adm_tablas_aux aux ON(per.t03_um=aux.codi)
WHERE per.t02_cod_proy = _proy
  AND per.t02_version  = _ver
  AND per.t03_id_per   = _per ;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_noobjecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_noobjecioncompra`(IN _proy VARCHAR(10), IN _id INT)
BEGIN
SELECT 	noc.t02_cod_proy AS 'proyecto',
	noc.t02_id_noc AS 'codigo',  
	noc.t02_sco_noc, 
	noc.t02_com_noc,
	(	SELECT 	CONCAT(c.t08_cod_comp,'.- ', SUBSTRING(c.t08_comp_desc,1,120 )) 
		FROM t08_comp c
		WHERE  c.t02_cod_proy = _proy 
		AND  c.t02_version = '1' 
		AND c.t08_cod_comp=noc.t02_com_noc	
	) AS componente,
	noc.t02_act_noc,
	(
		SELECT 		CONCAT(t09.t08_cod_comp,'.',t09.t09_cod_act, '.- ', SUBSTRING(t09.t09_act,1,100)) AS descripcion 				
		FROM t09_act t09
		WHERE  t09.t02_cod_proy = _proy  
		  AND  t09.t02_version = '1'  
		  AND  t09.t08_cod_comp = noc.t02_com_noc
		  AND  t09.t09_cod_act = noc.t02_act_noc	
	) AS actividad,
	noc.t02_sub_noc, 
	(
		SELECT 	CONCAT(sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub, '.- ', SUBSTRING(sub.t09_sub,1,100)) AS descrip 
		FROM        t09_subact sub
		WHERE  sub.t02_cod_proy = _proy 
		AND  sub.t02_version = '1' 
		AND  sub.t08_cod_comp = noc.t02_com_noc
		AND  sub.t09_cod_act= noc.t02_act_noc	
		AND  sub.t09_cod_sub= noc.t02_sub_noc	
	) AS subactividad,
	noc.t02_par_noc, 
	(
		SELECT 		DISTINCT (CONCAT( subact.t08_cod_comp,'.', subact.t09_cod_act,'.', subact.t09_cod_sub,'.', cat.cod_ext ,'.- ', cat.descrip )) 
		FROM 	     t09_subact AS subact 
		INNER JOIN t10_cost_sub AS cost ON (subact.t02_cod_proy = cost.t02_cod_proy AND subact.t02_version = cost.t02_version AND subact.t08_cod_comp = cost.t08_cod_comp  AND subact.t09_cod_act = cost.t09_cod_act AND subact.t09_cod_sub = cost.t09_cod_sub ) 
		LEFT  JOIN adm_tablas_aux AS cat ON (cost.t10_cate_cost = cat.codi)
		WHERE       subact.t02_cod_proy=_proy
		AND 	    subact.t02_version=1
		AND 	    subact.t08_cod_comp=noc.t02_com_noc
		AND 	    subact.t09_cod_act=noc.t02_act_noc
		AND 	    subact.t09_cod_sub = noc.t02_sub_noc
		AND 	    cat.cod_ext=noc.t02_par_noc
	) AS categoria,
	ROUND(noc.t02_spa_noc,2)  AS 'saldo', 
	noc.t02_imp_noc  AS 'importe', 
	noc.t02_ccp_noc, 
	noc.t02_cop_noc, 
	noc.t02_amt_noc, 
	noc.t02_amf_noc, 
	noc.t02_cmf_noc, 
	noc.t02_cmt_noc, 
	noc.t02_pro_noc, 
	noc.t02_obs_noc,
  noc.t02_env_rev,
  noc.t02_env_cor,
  noc.t02_estado, 
	noc.usu_crea, 
	noc.fch_crea, 
	noc.usu_actu, 
	noc.fch_actu, 
	noc.est_audi,
	DATE_FORMAT(noc.t02_fch_ped,'%d/%m/%Y') AS t02_fch_ped
	FROM 
	t02_noobjecion_compra noc
	WHERE noc.t02_cod_proy = _proy
	AND noc.t02_id_noc = _id  
	ORDER BY noc.t02_sco_noc ;	
			
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_objecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_objecioncompra`( IN _proy VARCHAR(10), IN _id INT )
BEGIN
SELECT 	oc.t02_cod_proy AS 'proyecto', 
	oc.t02_id_noc AS 'codigo', 
	oc.t02_sco_co, 
	FORMAT(oc.t02_par_co,2)  AS 'partida', 
	FORMAT(oc.t02_spa_co,2)  AS 'saldo', 
	FORMAT(oc.t02_imp_co,2)  AS 'importe', 
	oc.t02_ccp_co,
	oc.t02_cop_co, 
	oc.t02_amt_co, 
	oc.t02_amf_co,
	oc.t02_rmf_co, 	
	oc.t02_rep_co, 	
	oc.t02_obs_co	 
	FROM 
	t02_objecion_compra oc
	WHERE oc.t02_cod_proy = _proy
	AND oc.t02_id_noc = _id  
	ORDER BY oc.t02_sco_co ;	
	
			
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_partida_cambio_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_partida_cambio_personal`( IN _proy VARCHAR(10), IN _idper INT )
BEGIN
DECLARE  _saldopartida DOUBLE ;
DECLARE  _monto_ejecutado DOUBLE ;
SELECT SUM(t41_gasto)
  INTO _monto_ejecutado
  FROM t41_inf_financ_gasto 
 WHERE t02_cod_proy = _proy
   AND t08_cod_comp = 10 
   AND t09_cod_act  = 1  
   AND t09_cod_sub  = 12 
   AND t41_cate_gasto = _idper 
   AND t41_fte_finan  = 10 ; 
SET _saldopartida = ( fn_monto_total_planificado_mp_fte(_proy,1,1,NULL,_idper,10) - _monto_ejecutado) ;
SELECT 	CONCAT(ep.t04_ape_pat, ' ', ep.t04_ape_mat, ', ', ep.t04_nom_equi) AS 'nom_equi',
	ep.t04_id_equi AS 'id_equi',
	IFNULL(mp.t03_remu,'') AS 'remuneracion',	   
	t03_tdr       AS 'tdr', 
	replace(FORMAT(IFNULL(_saldopartida,''),2),',','')  AS 'saldo_partida'
  
  FROM 	  t04_equi_proy  ep 
LEFT JOIN t03_mp_per     mp  ON (ep.t02_cod_proy=mp.t02_cod_proy AND ep.t04_carg_equi=mp.t03_id_per AND mp.t02_version=1)
 WHERE ep.t02_cod_proy  = _proy
   AND ep.t04_carg_equi = _idper
   AND ep.t04_estado = 113 ;
			
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_perfil`(IN _prf varchar(20) )
BEGIN
SELECT   per_cod ,
	 per_des ,
	 per_abrev ,
	 usr_crea,
	 fch_crea
    FROM adm_perfiles
   where per_cod = _prf ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_plan_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_plan_at`( IN _proy varchar(10), 
					IN _ver int, 
					IN _comp int, 
					IN _activ int, 
					IN _subact int )
BEGIN
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  CONCAT( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo,
	  sub.t08_cod_comp      AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS sub,  
	  sub.t09_sub		AS subact, 
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t09_cod_sub      as subplan,
	  plan.t12_nro_tema,
	  plan.t12_hor_cap,
	  plan.t12_nro_ben,
	  plan.t12_conten,
	  plan.t12_modulo,
	  modu.descrip AS modulo
	FROM      t09_subact     sub 
        LEFT JOIN t12_plan_at    plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
        LEFT JOIN adm_tablas_aux modu ON (plan.t12_modulo=modu.codi)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  sub.t08_cod_comp = _comp 
	  and  sub.t09_cod_act	= _activ 
	  and  sub.t09_cod_sub	= _subact ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_plan_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_plan_capac`( IN _proy varchar(10), 
					IN _ver int, 
					IN _comp int, 
					IN _activ int, 
					IN _subact int )
BEGIN
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  CONCAT( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo,
	  sub.t08_cod_comp      AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS sub,  
	  sub.t09_sub		AS subact, 
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t09_cod_sub      as subplan,
	  plan.t12_nro_tema,
	  plan.t12_hor_cap,
	  plan.t12_nro_ben,
	  plan.t12_conten,
	  plan.t12_modulo,
	  modu.descrip AS modulo
	FROM      t09_subact     sub 
        LEFT JOIN t12_plan_capac plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
        LEFT JOIN adm_tablas_aux modu ON (plan.t12_modulo=modu.codi)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  sub.t08_cod_comp = _comp 
	  and  sub.t09_cod_act	= _activ 
	  and  sub.t09_cod_sub	= _subact ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_plan_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_plan_cred`( IN _proy varchar(10), 
					IN _ver int, 
					IN _comp int, 
					IN _activ int, 
					IN _subact int )
BEGIN
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  CONCAT( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo,
	  sub.t08_cod_comp      AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS sub,  
	  sub.t09_sub		AS subact, 
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t09_cod_sub      as subplan,
	  plan.t12_nro_ben,
	  plan.t12_mto_ben,
	  plan.t12_nro_cuo,
	  plan.t12_tasa_int,
	  plan.t12_obs
	FROM      t09_subact     sub 
        LEFT JOIN t12_plan_cred    plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  sub.t08_cod_comp = _comp 
	  and  sub.t09_cod_act	= _activ 
	  and  sub.t09_cod_sub	= _subact ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_plan_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_plan_otros`( IN _proy varchar(10), 
					IN _ver int, 
					IN _comp int, 
					IN _activ int, 
					IN _subact int )
BEGIN
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  CONCAT( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo,
	  sub.t08_cod_comp  AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS sub,  
	  sub.t09_sub		AS subact, 
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t09_cod_sub      AS subplan,
	  plan.t12_producto,
	  plan.t12_nro_ent,
	  plan.t12_nro_ben,
	  plan.t12_tot_ent,
	  plan.t12_conten,
	  plan.t12_tipo,
	  tip.descrip AS tipo
	FROM        t09_subact   sub
        LEFT JOIN t12_plan_otros plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
        LEFT JOIN adm_tablas_aux tip ON (plan.t12_tipo=tip.codi)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  sub.t08_cod_comp = _comp 
	  AND  sub.t09_cod_act	= _activ 
	  AND  sub.t09_cod_sub	= _subact ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_plan_visita_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_plan_visita_cab`(IN _proy 
VARCHAR(10), 
					  IN _vta INT)
BEGIN
SELECT 	t02_cod_proy, 
	t32_id_vta, 
	DATE_FORMAT(t32_fch_vta, '%d/%m/%Y') AS t32_fch_vta, 
	DATE_FORMAT(t32_fch_ter, '%d/%m/%Y') AS t32_fch_ter, 
	t32_obj_vta, 
	t32_per_ent, 
	t32_rec_nec, 
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu, 
	est_audi
	FROM    t32_plan_vta 
	WHERE t02_cod_proy = _proy
	  
AND t32_id_vta   = _vta ;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_poa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_get_poa`(IN _proy VARCHAR(10), IN _anio INT)
BEGIN
	DECLARE _gen INT;
	DECLARE _verProy INT;
	
	SELECT t02_gen, t02_version
	INTO _gen, _verProy
	FROM t02_proy_version
	WHERE t02_cod_proy=_proy
	AND t02_tipo = 'POA'
	AND t02_anio = _anio;
	  
	SELECT poa.t02_cod_proy, 
	       poa.t02_anio, 
	       poa.t02_periodo, 
	       poa.t02_punto_aten, 
	       poa.t02_politica, 
	       poa.t02_benefic, 
	       poa.t02_otras_interv, 
	       poa.t02_estado, 
	       poa.t02_estado_mf, 
	       poa.t02_aprob_cmt , 
	       poa.t02_aprob_cmf , 
	       poa.t02_obs_cmt , 
	       poa.t02_obs_cmf ,
	       poa.usr_crea, 
	       poa.fch_crea,
	       _gen AS 'generado',
	       _verProy AS 'version',
	       poa.t02_unsuspend_flg,
	       vb_se_tec,
	       vb_se_fin
	FROM t02_poa poa
	WHERE poa.t02_cod_proy = _proy 
	AND poa.t02_anio = _anio;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_poa_ult` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_poa_ult`(IN _proy VARCHAR(10))
BEGIN
  
DECLARE _existe 	INT;
DECLARE _t02_anio 	INT DEFAULT 1;
    
SELECT  COUNT(1)  
INTO _existe
FROM t02_poa
WHERE t02_cod_proy = _proy;
	
IF _existe > 0 THEN
	SELECT  t02_anio+1 t02_anio,
		fn_nom_periodo_anio(_proy, t02_anio+1) AS t02_periodo,
		45 as t02_estado 
	FROM 	t02_poa
	WHERE 	t02_cod_proy = _proy
	ORDER BY t02_anio DESC
	LIMIT 1 ; 
ELSE  
	SELECT _t02_anio AS t02_anio , fn_nom_periodo_anio(_proy,1) AS t02_periodo, 45 AS t02_estado;  
END IF ;	
	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_pp_reasignar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_pp_reasignar`(IN _proy VARCHAR(10),  IN _ver INT)
BEGIN
	DECLARE _ver_last INT;
	DECLARE _ver_cron INT;
	SELECT fn_pri_version_proy(_proy) INTO _ver_cron;
SELECT
		temp.pers,
		temp.equipa,
		temp.func,
		temp.inicial,
		temp.act,
		(IFNULL(temp.inicial,0) - 
		 IFNULL(temp.act,0) - 
		 IFNULL(temp.pers,0) - 
		 IFNULL(temp.equipa,0) - 
		 IFNULL(temp.func,0)) AS mreas
FROM
(
	SELECT		proy.t02_cod_proy, 
				proy.t02_version, 
				
				(SELECT fn_costos_total_proyecto(_proy, _ver_cron)) AS inicial,
				
				
				CASE _ver
					WHEN 1 THEN  
						(SELECT  SUM(per.t03_gasto_tot)
						FROM	t03_mp_per per
						WHERE	per.t02_cod_proy = _proy AND per.t02_version = 1)
 					ELSE
						(SELECT	SUM(per.t03_remu_prom * per.t03_mta_repro)
						FROM	t03_mp_per per
						WHERE	per.t02_cod_proy = _proy AND per.t02_version = _ver)
				END AS pers,
				 
				
				CASE _ver
					WHEN 1 THEN
						(SELECT  SUM(equi.t03_costo_tot)
						FROM	t03_mp_equi equi
						WHERE	equi.t02_cod_proy = _proy AND equi.t02_version = 1)
					ELSE
						(SELECT SUM(equi.t03_costo * equi.t03_mta_repro)
						FROM t03_mp_equi equi
						WHERE equi.t02_cod_proy = _proy AND equi.t02_version = _ver)
				END AS equipa,
				 
				
				CASE _ver
					WHEN 1 THEN
						(SELECT	SUM(t1.t03_cu * t1.t03_cant * t2.t03_meta)
						FROM	t03_mp_gas_fun_cost t1
						LEFT JOIN t03_mp_gas_fun_part t2 ON (t1.t02_cod_proy = t2.t02_cod_proy AND 
															 t1.t02_version = t2.t02_version AND 
															 t1.t03_partida = t2.t03_partida)
						WHERE t1.t02_cod_proy = _proy AND t1.t02_version = 1)
					ELSE
						(SELECT SUM(cost.t03_cu * cost.t03_cant * parti.t03_mta_repro)
						FROM 	  t03_mp_gas_fun_part parti
						LEFT JOIN t03_mp_gas_fun_cost cost ON (parti.t02_cod_proy = cost.t02_cod_proy AND 
																parti.t02_version = cost.t02_version AND 
																parti.t03_partida = cost.t03_partida)
						WHERE parti.t02_cod_proy = _proy AND parti.t02_version = _ver)
				END AS func, 
				 
				
				(SELECT SUM(cost.t10_cost_tot) 
				 FROM	t10_cost_sub cost
				 WHERE	cost.t02_cod_proy = _proy AND cost.t02_version = 1) AS act
				 
	FROM  t02_dg_proy proy 
	WHERE proy.t02_cod_proy=_proy AND proy.t02_version=_ver
)AS temp; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_proyecto`(IN _proy VARCHAR(10), 
                   IN _vs   INT)
BEGIN
SELECT  p.t02_cod_proy, 
    p.t02_version, 
    p.t02_nro_exp, 
    
    p.t00_cod_linea, 
    p.t01_id_inst,    
    i.t01_sig_inst,
    p.t02_nom_proy, 
    DATE_FORMAT(p.t02_fch_apro,'%d/%m/%Y') AS apro, 
    DATE_FORMAT(p.t02_fch_ini,'%d/%m/%Y') AS ini, 
    DATE_FORMAT(p.t02_fch_ter,'%d/%m/%Y') AS fin , 
    p.t02_fin, 
    p.t02_pro, 
    p.t02_ben_obj, 
    p.t02_amb_geo, 
    p.t02_cre_fe,
    p.t02_pres_fe,
    p.t02_pres_eje,
    p.t02_pres_otro, 
    p.t02_pres_tot, 
    p.t02_moni_tema, 
    p.t02_moni_fina, 
    p.t02_moni_ext, 
    p.t02_sup_inst, 
    p.t02_dire_proy, 
    p.t02_ciud_proy, 
    p.t02_tele_proy, 
    p.t02_fax_proy, 
    p.t02_mail_proy,
    DATE_FORMAT((CASE WHEN p.t02_fch_isc =0 THEN NULL ELSE p.t02_fch_isc END),'%d/%m/%Y') AS isc,
    DATE_FORMAT(p.t02_fch_ire,'%d/%m/%Y') AS ire, 
    DATE_FORMAT(p.t02_fch_tre,'%d/%m/%Y') AS tre, 
    DATE_FORMAT((CASE WHEN p.t02_fch_tam =0 THEN NULL ELSE p.t02_fch_tam END),'%d/%m/%Y') AS tam,
    p.t02_num_mes AS mes,
    p.t02_num_mes_amp,

    p.t02_estado, 
    i.t01_web_inst,
    cta.t01_id_cta,
    cta.t02_nom_benef,
    p.usr_crea, 
    p.fch_crea, 
    p.usr_actu, 
    p.fch_actu, 
    p.est_audi,
    p.env_rev,
    p.t02_inst_asoc,

    apr.t02_vb_proy, 
    apr.t02_aprob_proy, 
    apr.t02_fch_vb_proy, 
    apr.t02_fch_aprob_proy, 
    apr.t02_obs_vb_proy, 
    apr.t02_obs_aprob_proy, 
    apr.t02_aprob_ml, 
    apr.t02_aprob_cro, 
    apr.t02_aprob_pre, 
    apr.t02_fch_ml, 
    apr.t02_fch_cro, 
    apr.t02_fch_pre, 
    apr.t02_aprob_ml_mon, 
    apr.t02_aprob_cro_mon, 
    apr.t02_aprob_pre_mon, 
    apr.t02_obs_ml, 
    apr.t02_obs_cro, 
    apr.t02_obs_pre, 
    apr.t02_fch_ml_mon, 
    apr.t02_fch_cro_mon, 
    apr.t02_fch_pre_mon,
    
    tp.t02_gratificacion,
    tp.t02_porc_cts,
    tp.t02_porc_ess,
    tp.t02_porc_gast_func,
    tp.t02_porc_linea_base,
    tp.t02_porc_imprev,
    tp.t02_proc_gast_superv
FROM       t02_dg_proy p
LEFT JOIN t01_dir_inst i ON (p.t01_id_inst=i.t01_id_inst)
LEFT JOIN t02_proy_ctas cta ON (p.t02_cod_proy=cta.t02_cod_proy AND cta.est_audi=1)
LEFT JOIN t02_aprob_proy apr ON(p.t02_cod_proy=apr.t02_cod_proy)
LEFT JOIN t02_tasas_proy tp ON(p.t02_cod_proy=tp.t02_cod_proy AND p.t02_version = tp.t02_version)
WHERE p.t02_cod_proy = _proy 
AND p.t02_version=_vs ;     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_reporte` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_reporte`(IN _id INT )
BEGIN
SELECT 	cod_rpt, 
	tit_rpt, 
	des_rpt, 
	url_rpt, 
	url_param, 
	cat_rpt, 
	fch_crea, 
	usr_crea, 
	fch_actu, 
	usr_actu, 
	estado
	FROM adm_reportes 
   WHERE cod_rpt = _id ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_subactividad` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_subactividad`(	IN _proy varchar(10), 
					IN _ver int, 
					IN _comp int, 
					IN _activ int, 
					IN _subactiv int)
BEGIN
   
SELECT  sub.t02_cod_proy, 
	sub.t02_version, 
	sub.t08_cod_comp,
	sub.t09_cod_act, 
	sub.t09_cod_sub, 
	sub.t09_sub,
	sub.t09_fv, 
	sub.t09_act_crit, 
	sub.t09_mta, 
	sub.t09_tipo_sub,
	sub.t09_um, 
	sub.t09_obs, 
	sub.t09_resumen,
	sub.t09_obs_mt,
	sub.t09_obs_mf,
	sub.t09_mta_proy,
	sub.t09_mta_repro,
	sub.usr_crea, 
	sub.est_audi
FROM   t09_subact sub
WHERE 	    sub.t02_cod_proy=_proy
    AND 	    sub.t02_version=_ver
    AND 	    sub.t08_cod_comp=_comp
    AND 	    sub.t09_cod_act=_activ
    AND 	    sub.t09_cod_sub = _subactiv ;  
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_tablaaux` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_tablaaux`(IN _idaux varchar(20) )
BEGIN
SELECT 	codi, 
	descrip, 
	abrev, 
	cod_ext, 
	flg_act, 
	idTabla, 
	orden, 
	usu_crea, 
	fec_crea, 
	usu_actu, 
	fec_actu
  FROM 	adm_tablas_aux 
 where codi = _idaux ;
 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_tablaaux2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_tablaaux2`(IN _idaux varchar(20) )
BEGIN
SELECT 	codi, 
	descrip, 
	abrev, 
	cod_ext, 
	flg_act, 
	idTabla,
	id_tabla_aux,
	orden, 
	usu_crea, 
	fec_crea, 
	usu_actu, 
	fec_actu
  FROM 	adm_tablas_aux2 
 where codi = _idaux ;
 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_usuario` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_usuario`(IN _usr varchar(20) )
BEGIN
SELECT  usu.coduser, 
	usu.tipo_user as idperfil, 
	usu.nom_user, 
	usu.mail, 
	usu.estado,
	per.per_des as perfil, 
	IFNULL(usu.t01_id_uni,'') AS t01_id_uni,
	ifnull(usu.t02_cod_proy,'*') as  t02_cod_proy,
	fn_ult_version_proy(usu.t02_cod_proy) as t02_version,
	usu.clave_user,
	inst.t01_sig_inst as nominst
FROM  adm_usuarios usu
left join adm_perfiles per on (usu.tipo_user=per.per_cod)
left join t01_dir_inst inst on (usu.t01_id_uni=inst.t01_id_inst)
WHERE usu.coduser=_usr ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_get_usuario_foro` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_get_usuario_foro`(IN _usr VARCHAR(20) )
BEGIN
declare _pwd varchar(50) ;
SELECT fn_pwdusuario(_usr) into _pwd ;
SELECT 	_pwd AS 'pwd',
	u.* 
  FROM phpbb.phpbb_users u
 where username = _usr ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_inf_financ_imp_gastos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_inf_financ_imp_gastos`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _mes  INT,
				in _fte  int,
				in _codigos text,
				in _rubros  text,
				in _valores text,
				in _usr varchar(20)
				)
BEGIN
declare _num_no_existe int;
declare _num_importar  int;
declare _fuente varchar(100);
CALL sp_strTempTable('tCodigos', _codigos, '|');
CALL sp_strTempTable('tRubros', _rubros, '|');
CALL sp_strTempTable('tMontos' , _valores, '|');
delete from tmp_imp_inf_financ_gastos
where t02_cod_proy = _proy
  and t41_anio = _anio
  and t41_mes  = _mes 
  and t41_cod_inst = _fte;
insert tmp_imp_inf_financ_gastos(t02_cod_proy, t41_anio, t41_mes, t41_cod_inst, 
				 t41_cod_ext, t41_descrip , t41_monto, cod_user, fch_crea)
select  _proy ,
	_anio ,
	_mes  ,
	_fte  ,
	
	c.txt as codigo,
	r.txt as rubro,
	m.txt as monto,
	_usr,
	now()
from 	   tCodigos c
INNER JOIN tRubros  r on (r.id=c.id)
INNER JOIN tMontos  m ON (m.id=c.id);

DROP TEMPORARY TABLE tCodigos;
DROP TEMPORARY TABLE tRubros;
DROP TEMPORARY TABLE tMontos;

SELECT  COUNT(1)
  into  _num_no_existe
FROM      tmp_imp_inf_financ_gastos t
LEFT JOIN t50_equiv_codis 	    e  ON (t.t02_cod_proy=e.t02_cod_proy AND t.t41_cod_ext=e.t50_cod_ext)
WHERE t.t02_cod_proy = _proy
  AND t.t41_anio = _anio
  AND t.t41_mes  = _mes 
  AND t.t41_cod_inst = _fte
  AND IFNULL(e.t50_cod_sis,'') = '' ;
SELECT  COUNT(1)
  INTO  _num_importar
FROM      tmp_imp_inf_financ_gastos t
LEFT JOIN t50_equiv_codis 	    e  ON (t.t02_cod_proy=e.t02_cod_proy AND t.t41_cod_ext=e.t50_cod_ext)
WHERE t.t02_cod_proy = _proy
  AND t.t41_anio = _anio
  AND t.t41_mes  = _mes 
  AND t.t41_cod_inst = _fte
  AND IFNULL(e.t50_cod_sis,'') <> '' ;
select t01_sig_inst
into _fuente
from t01_dir_inst where t01_id_inst = _fte;
if _num_no_existe > 0 then
     begin 
	select  false as importar, 
		_num_no_existe as existe,
		_num_importar as num_imp ,
		_fuente as fuente ;
     end ;
else
     begin 
	SELECT  true AS importar, 
		0 AS existe,
		_num_importar AS num_imp ,
		_fuente as fuente ;
     end ;
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_inf_financ_imp_gastos_err` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_inf_financ_imp_gastos_err`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _mes  INT,
				in _fte  int
				)
BEGIN
SELECT 	t.t41_cod_ext,
	t.t41_descrip,
	t.t41_monto
FROM tmp_imp_inf_financ_gastos t
WHERE t.t02_cod_proy= _proy
  and t.t41_anio   = _anio
  and t.t41_mes    = _mes
  and t.t41_cod_inst = _fte
  AND t.t41_cod_ext NOT IN( SELECT e.t50_cod_ext 
			      FROM t50_equiv_codis e 
			     WHERE e.t02_cod_proy=t.t02_cod_proy );
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_inf_financ_imp_gastos_guardar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_inf_financ_imp_gastos_guardar`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _mes  INT,
				IN _fte  INT,
				in _usr varchar(20)
				)
BEGIN
declare _ver int ;
declare _numrows long ;
select fn_ult_version_proy(_proy) into _ver ;
REPLACE INTO t41_inf_financ_gasto 
	(t02_cod_proy, 
	t40_anio, 
	t40_mes, 
	t41_fte_finan, 
	t02_version, 
	t08_cod_comp, 
	t09_cod_act, 
	t09_cod_sub, 
	t41_cate_gasto, 
	t41_gasto, 
	t41_estado, 
	t41_obs, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
SELECT 	
	t.t02_cod_proy, 
	t.t41_anio, 
	t.t41_mes, 
	t.t41_cod_inst,
	_ver, 
	(CASE WHEN LENGTH(TRIM(e.t50_cod_sis)) >= 1 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.t50_cod_sis,'.',1),'.',-1) ELSE '' END) ,
	(CASE WHEN LENGTH(TRIM(e.t50_cod_sis)) >= 3 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.t50_cod_sis,'.',2),'.',-1) ELSE '' END) ,
	(CASE WHEN LENGTH(TRIM(e.t50_cod_sis)) >= 5 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.t50_cod_sis,'.',3),'.',-1) ELSE '' END) ,
	(CASE WHEN LENGTH(TRIM(e.t50_cod_sis)) >= 7 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.t50_cod_sis,'.',4),'.',-1) ELSE '' END) ,
	MAX(t.t41_monto),
	null,
	'',
	_usr,
	now(),
	'1'
FROM tmp_imp_inf_financ_gastos t
INNER JOIN t50_equiv_codis e ON (e.t02_cod_proy=t.t02_cod_proy AND e.t50_cod_ext=t.t41_cod_ext)
WHERE t.t02_cod_proy= _proy
  AND t.t41_anio   = _anio
  AND t.t41_mes    = _mes
  AND t.t41_cod_inst = _fte 
  AND (CASE WHEN LENGTH(TRIM(e.t50_cod_sis)) >= 5 THEN SUBSTRING_INDEX(SUBSTRING_INDEX(e.t50_cod_sis,'.',4),'.',-1) ELSE '' END) <> '' 
  AND t.t41_monto > 0
GROUP BY 1,2,3,4,5,6,7,8,9 ;
select ROW_COUNT() into _numrows ;
delete FROM tmp_imp_inf_financ_gastos 
WHERE t02_cod_proy= _proy
  AND t41_anio    = _anio
  AND t41_mes     = _mes
  AND t41_cod_inst= _fte ;
SELECT _numrows AS numrows, _fte AS codigo; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_inf_unico_anual_calificacion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_inf_unico_anual_calificacion`(IN _proy VARCHAR(10),
						   IN _anio VARCHAR(10))
BEGIN
DECLARE _ver INT ;
DECLARE _fch_ini DATE ;
DECLARE _fch_fin DATE ;
SELECT fn_ult_version_proy(_proy) INTO _ver ;
SELECT DATE_ADD(p.t02_fch_ini ,INTERVAL _anio YEAR)
INTO    _fch_fin 
FROM t02_dg_proy p
WHERE p.t02_cod_proy = _proy
AND p.t02_version = _ver;
SELECT DATE_SUB(_fch_fin ,INTERVAL 1 YEAR)
INTO    _fch_ini;
SELECT 	cdr.proy,
	DATE_FORMAT(cdr.fecha,'%d/%m/%Y') AS fecha, 
	(CASE WHEN cdr.Informe='ME' THEN cdr.califica ELSE '' END  ) AS Califica_ME,
	(CASE WHEN cdr.Informe='MI' THEN cdr.califica ELSE '' END  ) AS Califica_MI,
	(CASE WHEN cdr.Informe='MF' THEN cdr.califica ELSE '' END  ) AS Califica_MF	
FROM (
SELECT  inf.t02_cod_proy AS proy,
	inf.t30_fch_pre AS fecha,
	fn_puntaje_califica_inf_me(inf.t02_cod_proy, inf.t30_id, inf.t30_ver_inf) AS califica,
	'ME' AS 'Informe'
FROM t30_inf_me inf
LEFT JOIN t02_dg_proy proy ON(inf.t02_cod_proy=proy.t02_cod_proy AND proy.t02_version = _ver)
WHERE inf.t02_cod_proy = _proy
AND inf.t30_ver_inf = (SELECT MAX(v.t30_ver_inf) FROM t30_inf_me v WHERE v.t02_cod_proy=inf.t02_cod_proy AND v.t30_id=inf.t30_id) 
UNION ALL
SELECT  inf.t02_cod_proy AS proy,
	inf.t45_fch_pre AS fecha,
	fn_puntaje_califica_inf_monint(inf.t02_cod_proy, inf.t45_id, inf.t45_ver_inf) AS califica,
	'MI' AS 'Informe'
FROM t45_inf_mi inf
LEFT JOIN t02_dg_proy proy ON(inf.t02_cod_proy=proy.t02_cod_proy AND proy.t02_version = _ver )
WHERE inf.t02_cod_proy = _proy
 AND inf.t45_ver_inf = (SELECT MAX(v.t45_ver_inf) FROM t45_inf_mi v WHERE v.t02_cod_proy=inf.t02_cod_proy AND v.t45_id=inf.t45_id)
UNION ALL
SELECT  inf.t02_cod_proy AS proy,
	inf.t51_fch_pre AS fecha,
	cal.cod_ext AS califica,
	'MF' AS 'Informe'
FROM t51_inf_mf inf
LEFT JOIN t02_dg_proy    proy ON(inf.t02_cod_proy=proy.t02_cod_proy AND proy.t02_version = _ver )
LEFT JOIN adm_tablas_aux cal  ON(inf.t51_califica=cal.codi)
WHERE inf.t02_cod_proy = _proy
) AS cdr
WHERE cdr.fecha >= _fch_ini AND cdr.fecha < _fch_fin
ORDER BY cdr.fecha ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_ambito_geo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_ambito_geo`(
			IN _proy VARCHAR(10), 
			IN _vs   INT ,
			IN _dpto CHAR(2), 
			IN _prov CHAR(2), 
			IN _dist CHAR(2), 
			IN _obs  TEXT, 
			IN _usr VARCHAR(20))
BEGIN
  DECLARE _existe  INT;
  DECLARE _error VARCHAR(100);
  
  SELECT COUNT(t03_dpto) 
  INTO   _existe
  FROM t03_dist_proy
  WHERE t02_cod_proy  = _proy
    AND t02_version   = _vs
    AND t03_dpto    = _dpto
    AND t03_prov    = _prov
    AND t03_dist    = _dist ;
  
  IF _existe =0 THEN
  SELECT '' INTO _error ;
  
  INSERT INTO t03_dist_proy 
	( t02_cod_proy, 
	  t02_version ,
	  t03_dpto, 
	  t03_prov, 
	  t03_dist,
	  t03_obs, 
	  usr_crea, 
	  fch_crea, 
	  est_audi
	)
	VALUES
	( _proy , 
	  _vs,
	  _dpto, 
	  _prov, 
	  _dist,
	  _obs, 
	  _usr, 
	  NOW(),
	'1'
	);
    
    SELECT ROW_COUNT() AS numrows, _dist AS codigo, _error AS 'error' ;
   ELSE
    SELECT 'Ya fue registrado el Ambito Geografico para este Proyecto' INTO _error;
    SELECT 0 AS numrows, _dist AS codigo, _error AS 'error' ;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_banco` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_banco`(IN _nom VARCHAR(50), IN _abre VARCHAR(15), IN _usr VARCHAR(20))
BEGIN
  DECLARE _id INT;
    SELECT IFNULL(max(t00_cod_bco),0) + 1 INTO _id FROM t00_bancos;
    INSERT INTO t00_bancos (t00_cod_bco, t00_nom_lar, t00_nom_abre, fch_crea, usr_crea)
    VALUES (_id, _nom, _abre, NOW(), _usr);
    SELECT ROW_COUNT() AS numrows, _id AS codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_cambio_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_cambio_personal`(IN _t02_cod_proy 	VARCHAR(10), 
					 IN _t04_dni_equi  	VARCHAR(20),
					 IN _t04_ape_pat  	VARCHAR(50),
					 IN _t04_ape_mat  	VARCHAR(50),
					 IN _t04_nom_equi	VARCHAR(50), 
					 IN _t04_sexo_equi  	INT,
					 IN _t04_edad_equi  	INT,
					 IN _t04_cali_equi  	INT,
					 IN _t04_telf_equi  	VARCHAR(50),
					 IN _t04_cel_equi  	VARCHAR(20),
					 IN _t04_mail_equi  	VARCHAR(20),
					 IN _t04_exp_lab  	TEXT,
					 IN _t04_func_equi  	TEXT,
					 IN _t04_especialidad  	INT,
					 IN _t04_adj_cv 	varchar(250),
					 IN _t04_adj_sol 	varchar(250),
					 IN _t04_id_equi_cambio int,
					 IN _t04_saldo_part     double,
					 IN _t04_obs_ejec	text,
					 IN _UserID  		CHAR(20),  IN _t04_fec_ini date)
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _numrows      int ;
  declare _idSol	INT; 
  declare _t04_carg_equi INT ;
	declare _idmen INT;

DECLARE _nomejec VARCHAR(30) ;
SELECT t01_sig_inst 
  INTO _nomejec 
  FROM t01_dir_inst 
 WHERE t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_t02_cod_proy AND p.t02_version=1);
  
  
if EXISTS(select t04_dni_equi from t04_equi_proy where t02_cod_proy=_t02_cod_proy AND t04_dni_equi=_t04_dni_equi) then 
	SELECT CONCAT('El personal  \"',_t04_ape_pat,' ',_t04_ape_mat, ', ', _t04_nom_equi ,'\" ya esta registrado en el Equipo Ejecutor del Proyecto')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;      
end if ;
IF EXISTS(SELECT t04_dni_equi FROM t04_sol_cambio_per WHERE t02_cod_proy=_t02_cod_proy AND t04_dni_equi=_t04_dni_equi) THEN 
	SELECT CONCAT('El personal  \"',_t04_ape_pat,' ',_t04_ape_mat, ', ', _t04_nom_equi ,'\" ya fue registrado en otra Solicitud de Cambio de Personal')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;      
END IF ;
  
SELECT IFNULL(MAX(t04_num_soli),0) + 1
INTO  _idSol 
FROM  t04_sol_cambio_per
WHERE t02_cod_proy = _t02_cod_proy ;
select t04_carg_equi 
  into _t04_carg_equi
  from t04_equi_proy
 where t02_cod_proy = _t02_cod_proy
   and t04_id_equi  = _t04_id_equi_cambio ;
CALL sp_ins_mensaje_proy_scp(	_t02_cod_proy, 
						'Solicitud Aprobación de Cambio de Personal',
						CONCAT('El proyecto ', _t02_cod_proy, ', ha solicitado la aprobación de la solicitud de cambio de personal y se están pasando los 15 días de plazo de aprobación de la solicitud \n\n' ),
						_nomejec,
						_UserID
					     ) ;
SELECT MAX(men.id_men) 
into _idmen
from adm_mensajes AS men;
INSERT INTO t04_sol_cambio_per 
	(
	t02_cod_proy, 
	t04_num_soli, 
	t04_dni_equi, 
	t04_ape_pat, 
	t04_ape_mat, 
	t04_nom_equi, 
	t04_sexo_equi, 
	t04_edad_equi, 
	t04_cali_equi, 
	t04_mail_equi, 
	t04_telf_equi, 
	t04_cel_equi, 
	t04_carg_equi, 
	t04_esp_equi,
	t04_func_equi, 
	t04_exp_lab, 
	t04_adj_cv,
	t04_adj_sol,
	t04_id_equi_cambio,
	t04_saldo_part,
	t04_obs_ejec,
	usr_crea, 
	t04_fec_ini, 
	est_audi,
	fch_crea,
	id_msj
	)
VALUES
	(
	_t02_cod_proy, 
	_idSol, 
	_t04_dni_equi , 
	_t04_ape_pat,
	_t04_ape_mat ,
	_t04_nom_equi, 
	_t04_sexo_equi,
	_t04_edad_equi,
	_t04_cali_equi,
	_t04_mail_equi,
	_t04_telf_equi,
	_t04_cel_equi, 
	_t04_carg_equi,
	_t04_especialidad,
	_t04_func_equi,
	_t04_exp_lab ,
	_t04_adj_cv,
	_t04_adj_sol,
	_t04_id_equi_cambio,
	_t04_saldo_part,
	_t04_obs_ejec,
	_UserID ,
	_t04_fec_ini, 
	'1',
_t04_fec_ini,
_idmen 
	);
SELECT ROW_COUNT() INTO _numrows;
COMMIT;
SELECT _numrows AS numrows, _idSol AS codigo, '' AS msg ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_cartafianza` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_cartafianza`(
			IN _proy  varchar(10),
			IN _bco   int ,
			IN _desc  text, 
			in _monto double,
			IN _num   varchar(20),
			in _serie varchar(20),
			in _fec_rec datetime,
			in _fec_gir datetime,
			in _fec_venc datetime,
			in _vb_adm  char(1),
			IN _obs_adm TEXT,
			in _fname varchar(150),
			IN _usr varchar(20)
			)
transX : BEGIN
  DECLARE _msg  varchar(100);
  DECLARE _id   int ;
  declare _estado INT;
  IF exists(select _num from t02_carta_fianza where  t02_cod_proy = _proy and t02_num_cf=_num)  THEN
    SELECT CONCAT('El Numero de Carta Fianza:', _num, ' ya fue registrado para el proyecto ','\"',_proy,'\"')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    LEAVE transX ;  
  end if ;
  
  
  select (case when _fec_venc > now() then 1 ELSE 0 END ) into _estado;
  
  SELECT IFNULL(MAX(t02_id_cf),0) + 1
    INTO _id 
    FROM  t02_carta_fianza 
    WHERE t02_cod_proy = _proy;
  
  INSERT INTO t02_carta_fianza 
		(
		t02_cod_proy, 
		t02_id_cf, 
		t02_id_bco, 
		t02_des_cf, 
		t02_mto_cf, 
		t02_num_cf, 
		t02_ser_cf, 
		t02_frec_cf, 
		t02_fgir_cf, 
		t02_fven_cf, 
		t02_est_cf, 
		t02_file_cf, 
		t02_vb_adm,
		t02_obs_adm,
		usu_crea, 
		fch_crea, 
		est_audi
		)
	VALUES
		(
		_proy, 
		_id, 
		_bco, 
		_desc, 
		_monto, 
		_num, 
		_serie, 
		_fec_rec, 
		_fec_gir, 
		_fec_venc, 
		_estado, 
		_fname, 
		_vb_adm,
		_obs_adm ,
		_usr, 
		NOW(), 
		'1'
		);  
  
    SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_caserio` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_caserio`( 
				 IN _dep 	CHAR(2),
				 IN _prov	CHAR(2), 
				 IN _dist  	CHAR(2),
				 IN _caserio  	VARCHAR(100),
				 IN _usuario  	VARCHAR(20)
				 )
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _existe 	INT;
  DECLARE _id 		CHAR(2);   
  DECLARE _numrows 	INT;
  
  
	SELECT COUNT(1)
	INTO _existe
	FROM adm_caserios
	WHERE cod_dpto=_dep AND cod_prov=_prov AND cod_dist=_dist AND nom_case=_caserio;
	
  IF _existe > 0 THEN
      
    SELECT CONCAT('El caserio esta registrado')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
     
  LEAVE TRANX;    
  ELSE 
  
  
   SELECT 
   IF 	( (CONVERT(IFNULL(MAX(cod_case),0),DECIMAL)/2)<4 , CONCAT('0' ,IFNULL(MAX(cod_case),0) + 1  )
	,IFNULL(MAX(cod_case),0) + 1)
    INTO _id 
    FROM  adm_caserios 
    WHERE cod_dpto=_dep AND cod_prov=_prov AND cod_dist=_dist;
    
  INSERT INTO adm_caserios 
	(cod_dpto, 
	cod_prov, 
	cod_dist, 
	cod_case, 
	nom_case, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(
	_dep, 
	_prov, 
	_dist, 
	_id, 
	_caserio, 
	_usuario, 
	NOW(), 
	'1'
	);
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    SELECT _numrows AS numrows, '' AS msg , _id AS codigo ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_concepto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_concepto`(IN in_concepto VARCHAR(30), IN in_nom VARCHAR(50), IN in_abre VARCHAR(15), IN in_usr VARCHAR(20))
BEGIN
    DECLARE var_id INT;
    
    CASE in_concepto
        WHEN 'linea' THEN 
            SELECT IFNULL(max(t00_cod_linea),0) + 1 INTO var_id FROM t00_linea;
            INSERT INTO t00_linea (t00_cod_linea, t00_nom_lar, t00_nom_abre, fch_crea, usr_crea)
            VALUES (var_id, in_nom, in_abre, NOW(), in_usr);
        WHEN 'tasa' THEN 
            SELECT IFNULL(max(t00_cod_tasa),0) + 1 INTO var_id FROM t00_tasa;
            INSERT INTO t00_tasa (t00_cod_tasa, t00_nom_lar, t00_nom_abre, fch_crea, usr_crea)
            VALUES (var_id, in_nom, in_abre, NOW(), in_usr);
    WHEN 'parametro' THEN 
            SELECT IFNULL(max(t00_cod_param),0) + 1 INTO var_id FROM t00_parametro;
            INSERT INTO t00_parametro (t00_cod_param, t00_nom_lar, t00_nom_abre, fch_crea, usr_crea)
            VALUES (var_id, in_nom, in_abre, NOW(), in_usr);
        WHEN 'banco' THEN 
            SELECT IFNULL(max(t00_cod_bco),0) + 1 INTO var_id FROM t00_bancos;
            INSERT INTO t00_bancos (t00_cod_bco, t00_nom_lar, t00_nom_abre, fch_crea, usr_crea)
            VALUES (var_id, in_nom, in_abre, NOW(), in_usr);
        WHEN 'moneda' THEN 
            SELECT IFNULL(max(t00_cod_mon),0) + 1 INTO var_id FROM t00_tipo_moneda;
            INSERT INTO t00_tipo_moneda (t00_cod_mon, t00_nom_lar, t00_nom_abre, fch_crea, usr_crea)
            VALUES (var_id, in_nom, in_abre, NOW(), in_usr);
        WHEN 'tipo_anexo' THEN 
            SELECT IFNULL(max(t02_anx_tip_cod),0) + 1 INTO var_id FROM t02_proy_anx_tip;
            INSERT INTO t02_proy_anx_tip (t02_anx_tip_cod, t02_anx_tip_desc, t02_anx_tip_abrev, fch_crea, usr_crea)
            VALUES (var_id, in_nom, in_abre, NOW(), in_usr);
        WHEN 'tipo_cuenta' THEN 
            SELECT IFNULL(max(t00_cod_cta),0) + 1 INTO var_id FROM t00_tipo_cuenta;
            INSERT INTO t00_tipo_cuenta (t00_cod_cta, t00_nom_lar, t00_nom_abre, fch_crea, usr_crea)
            VALUES (var_id, in_nom, in_abre, NOW(), in_usr);
    END CASE;
    SELECT ROW_COUNT() AS numrows, var_id AS codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_concurso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_concurso`(IN _anio int, IN _nom    varchar(50), 
IN _abre   VARCHAR(15),
	IN _coment VARCHAR(200),		IN _usr varchar(20))
BEGIN
  DECLARE _msg    varchar(100);
  declare _existe int ;
  DECLARE _id     int ;
  
  select COUNT(1)
  into _existe
  from adm_concursos
  where anio_conc = _anio ;
  
  if _existe > 0 then
    select concat('El concurso con año ', _anio, ' ya fue registrado...')
    into _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  else
   
    select IFNULL(max(num_conc),0) + 1
      into _id
      from adm_concursos ; 
    
    INSERT INTO adm_concursos 
	(num_conc,
	 anio_conc,
	 nom_conc,
	abr_conc,
   fec_crea,
	 usr_crea,
   coment_conc
	)
	VALUES
	(_id, 
	 _anio,
	 _nom,
	 _abre,
	 NOW(),
	 _usr, 
	 _coment
	);
     
    SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
     
  end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_ins_costeo`(IN _proy varchar(10), IN _ver INT, IN _comp INT, IN _activ INT, 
								IN _subact INT 		, IN _descrip varchar(200) , IN _categ INT,
								IN _um 	varchar(50) , IN _cant	double		   , IN _cu	double,
								IN _usr varchar(20))
BEGIN
  DECLARE _cod_cost INT;
  DECLARE _meta_sub double;
  
  SELECT IFNULL(MAX(t10_cod_cost),0)+1 INTO _cod_cost 
  FROM 	 t10_cost_sub 
  WHERE  t02_cod_proy	= _proy  AND t02_version	= _ver		AND
		 t08_cod_comp	= _comp  AND t09_cod_act	= _activ	AND
		 t09_cod_sub	= _subact ;
 
 SELECT IFNULL(t09_mta,0) INTO _meta_sub
  FROM 	 t09_subact 
  WHERE  t02_cod_proy	= _proy AND t02_version	= _ver		AND
		 t08_cod_comp	= _comp AND t09_cod_act	= _activ	AND
		 t09_cod_sub	= _subact ;
 
INSERT INTO  t10_cost_sub ( t02_cod_proy,  t02_version , t08_cod_comp , t09_cod_act, t09_cod_sub, 
							t10_cod_cost,  t10_cost	   , t10_cate_cost, t10_um	   , t10_cant, t10_cu,
							t10_cost_parc, t10_cost_tot, usr_crea	  , fch_crea   , est_audi)
	   VALUES 			  ( _proy		 , _ver		   , _comp		  , _activ	   , _subact,
	   						_cod_cost	 , _descrip	   , _categ		  , _um		   , _cant   , _cu ,
	   						(_cant * _cu) , (_meta_sub * (_cant * _cu)),_usr , NOW(), '1');
select ROW_COUNT() as numrows, _cod_cost as codigo, _cod_cost as newid ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_cron_visita_mi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_cron_visita_mi`(
			IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _mes INT, 
			IN _obs TEXT, 
			IN _usr VARCHAR(20))
BEGIN
  DECLARE _id   INT;
  DECLARE _existe  INT;
  DECLARE _error VARCHAR(100);
  
  SELECT IFNULL(MAX(t46_id),0)+1 INTO _id  
  FROM 	 t46_cron_visita_mi 
  WHERE  t02_cod_proy	= _proy  ;
  
  SELECT COUNT(t46_id) 
  INTO   _existe
  FROM t46_cron_visita_mi
  WHERE t02_cod_proy=_proy
    AND t46_anio = _anio
    AND t46_mes = _mes;
  
  IF _existe =0 THEN
  SELECT '' INTO _error ;
  
  INSERT INTO t46_cron_visita_mi 
	( t02_cod_proy, 
	  t46_id, 
	  t46_anio, 
	  t46_mes, 
	  t46_obs, 
	  usr_crea, 
	  fch_crea, 
	  est_audi
	)
	VALUES
	( _proy , 
	  _id   , 
	  _anio , 
	  _mes  , 
	  _obs  , 
	  _usr, 
	  NOW(),
	'1'
	);
    
    SELECT ROW_COUNT() AS numrows, _id AS codigo, _error AS 'error' ;
   ELSE
    SELECT 'Ya fue Planeado al menos una visita, para este periodo' INTO _error;
    SELECT 0 AS numrows, _id AS codigo, _error AS 'error' ;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_ctas_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_ctas_inst`(
			IN _t01_id_inst INT, 
			IN _t01_bco    	INT ,
			in _codcta      int ,
			IN _nrocta 	VARCHAR(20), 
			in _mon         int ,
			IN _usr_crea  		VARCHAR(20))
BEGIN
    declare _id int ;
    
    select IFNULL( max(t01_id_cta),0)+1 INTO _id  FROM t01_inst_ctas WHERE t01_id_inst = _t01_id_inst ; 
    
    INSERT INTO t01_inst_ctas 
	(t01_id_inst, 
	t01_id_cta, 
	t00_cod_bco, 
	t00_cod_cta, 
	t01_nro_cta, 
	t00_cod_mon, 
	t01_txt_ref, 
	t01_cta_def, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
    values
    ( _t01_id_inst,
      _id,
      _t01_bco,
      _codcta,
      _nrocta,
      _mon,
      '',
      '1',
      _usr_crea,
      now(),
      '1'
    );
    
    SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_desembolso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_desembolso`(
																IN  pCodProy VARCHAR(10), 
																IN  pTrim INT,
																IN  pTipoPago INT,
																IN  pInstOrig INT,
																IN  pCtaOrig  INT,
																IN  pInstDest INT,
																IN  pCtaDest  INT,
																IN  pNomBenef VARCHAR(150),
																IN  pFecGiro DATETIME,
																IN  pFecDepo DATETIME,
																IN  pMtoDesem  DOUBLE,
																IN  pNroCheq  VARCHAR(100),
																IN  pObs       TEXT,
																IN	pIdAprob BIGINT,
																IN	pNroAprob TINYINT,
																IN  pUser VARCHAR(20))
BEGIN
DECLARE _msg   TEXT;
DECLARE aNewId DOUBLE ;
   
SELECT	IFNULL(MAX(d.t60_id_desemb),0) +1
INTO	aNewId
FROM	t60_ejecucion_desemb d
WHERE	d.t02_cod_proy = pCodProy
	AND d.t60_id_trim  = pTrim ;  
INSERT INTO t60_ejecucion_desemb (
		t02_cod_proy,		t60_id_trim,		t60_id_desemb, 
		t60_tip_pago,		t60_inst_ori,		t60_cta_ori, 
		t01_id_inst,		t01_id_cta,			t60_nom_benef, 
		t60_fch_giro,		t60_fch_depo,		t60_mto_des, 
		t60_nro_cheque,		t60_obs_tippago,	t60_id_aprob,
		t60_nro_aprob,		usr_crea, 			fch_crea,
		est_audi )
	VALUES (
		pCodProy,			pTrim,				aNewId,
		pTipoPago,			pInstOrig,			pCtaOrig,
		pInstDest,			pCtaDest,			pNomBenef,
		pFecGiro,			pFecDepo,			pMtoDesem,
		pNroCheq,			pObs,				pIdAprob,
		pNroAprob,			pUser,				NOW(),
		'1' );
SELECT ROW_COUNT() AS numrows, aNewId AS codigo, '' AS msg ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_desembolso_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_desembolso_me`(
			IN  _proy VARCHAR(10), 
			in  _visita int,
			in  _idaprob int, 
			in  _tpaog int,
			in  _inst_ori int,
			in  _cta_ori  int,
			in  _inst_dest int,
			in  _cta_dest  int,
			in  _nom_benef varchar(150),
			in  _fec_giro datetime,
			in  _fec_depo datetime,
			in  _mto_desm  double,
			in  _nro_cheq  varchar(100),
			in  _obs       text,
			IN  _usr VARCHAR(20))
trx1:BEGIN
DECLARE _msg   text;
DECLARE _newid DOUBLE ;
   
SELECT ifnull(max(d.t60_id_desemb),0) +1
  INTO _newid
  FROM t60_ejecucion_desemb_me d
 WHERE d.t02_cod_proy   = _proy
   AND d.t60_id_visita  = _visita 
   and d.t60_id_nropago = _idaprob ;  
    
    
INSERT INTO t60_ejecucion_desemb_me 
	(t02_cod_proy, 
	t60_id_visita, 
	t60_id_nropago,
	t60_id_desemb, 
	t60_tip_pago, 
	t60_inst_ori, 
	t60_cta_ori, 
	t01_id_inst, 
	t01_id_cta, 
	t60_nom_benef, 
	t60_fch_giro, 
	t60_fch_depo, 
	t60_mto_des, 
	t60_nro_cheque, 
	t60_obs_tippago, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
       (
        _proy,
        _visita,
        _idaprob,
        _newid,
	_tpaog ,
	_inst_ori ,
	_cta_ori  ,
	_inst_dest,
	_cta_dest,
	_nom_benef,
	_fec_giro ,
	_fec_depo ,
	_mto_desm  ,
	_nro_cheq  ,
	_obs       ,
	_usr,
	now(),
	'1'
       );
  
    
  SELECT ROW_COUNT() AS numrows, _newid AS codigo, '' AS msg ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_doc_apoyo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_doc_apoyo`(
					IN _titulo VARCHAR(100), 
					IN _autor VARCHAR(100), 
					IN _resena VARCHAR(70), 
					IN _resumen VARCHAR(200), 
					IN _edicion VARCHAR(70), 
					IN _sector VARCHAR(70), 
					IN _clave VARCHAR(30), 
					IN _nomarch VARCHAR(100), 
					IN _url VARCHAR(100),
					IN _usuario VARCHAR(40),
					IN _ext VARCHAR(40)
					)
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(100);
  DECLARE _existe 	INT;
  DECLARE _numrows 	INT;
  DECLARE _id 		INT;
  DECLARE _nom 		VARCHAR(50);
  
 
	SELECT COUNT(1) INTO _existe FROM t70_apo_bib WHERE titulo= _titulo AND autor = _autor ;  
 	
  IF _existe > 0 THEN
      
    SELECT CONCAT('El Documento se encuentra registrado \"', _titulo, '\"')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  LEAVE TRANX;    
  ELSE 
  
	SELECT IFNULL(MAX(t70_apo_bib.codigo),0)+1
	INTO   _id
	FROM t70_apo_bib ;
    
    SELECT REPLACE(_nomarch,' ','_') INTO _nom;
     
  INSERT INTO t70_apo_bib 
	(codigo, 
	titulo, 
	autor, 
	resena, 
	resumen, 
	edicion, 
	sector, 
	clave, 
	t70_nom_file, 
	t70_url_file,
	usr_crea, 
	fch_crea
	)
	VALUES
	('', 
	_titulo, 
	_autor, 
	_resena, 
	_resumen, 
	_edicion, 
	_sector, 
	_clave, 
	_nomarch, 
	_nom,
	_usuario,
	NOW()
	);
	
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    SELECT _numrows AS numrows, '' AS msg, _nom AS url ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_enl_apoyo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_enl_apoyo`(		IN _url VARCHAR(100), 
						IN _titulo VARCHAR(100), 
						IN _resumen VARCHAR(70), 
						IN _email VARCHAR(200)						
						)
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(100);
  DECLARE _existe 	INT;
  DECLARE _numrows 	INT;
  DECLARE _id 		INT;
  DECLARE _nom 		VARCHAR(50);
  
 
	SELECT COUNT(1) INTO _existe FROM t70_apo_enl WHERE url= _url ;  
 	
  IF _existe > 0 THEN
      
    SELECT CONCAT('La pagina se encuentra registrada ',_url)
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  LEAVE TRANX;    
  ELSE 
  
 INSERT INTO t70_apo_enl 
	(	codigo, 
		url, 
		titulo, 
		resumen, 
		email
	)
	VALUES
	('', 
	_url, 
	_titulo, 
	_resumen, 
	_email
	);
	
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    SELECT _numrows AS numrows, '' AS msg, _nom AS url ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_equiv_codis` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_equiv_codis`(  IN _proy VARCHAR(10), 
					IN _sys VARCHAR(20),
					IN _eje VARCHAR(20),
					in _des varchar(200),
					IN _usr VARCHAR(20)
					)
BEGIN
INSERT INTO t50_equiv_codis 
	(t02_cod_proy, 
	t50_cod_sis, 
	t50_cod_ext, 
	t50_des_ext, 
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu, 
	est_audi
	)
	VALUES
	( _proy, 
	 _sys , 
	 _eje , 
	 _des , 
	 _usr , 
	 NOW(), 
	 NULL, 
	 null, 
	'1'
	);

SELECT ROW_COUNT() AS numrows, _eje AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_equi_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_equi_fe`(
			IN _dni VARCHAR(20),
			IN _ape_pat VARCHAR(50),
			IN _ape_mat VARCHAR(50),
			IN _nom VARCHAR(50),
			IN _sexo  INT,
			IN _edad  INT,
			IN _cali  INT,
			IN _mail  VARCHAR(50),
			IN _telf  VARCHAR(50),
			IN _unid INT,
			IN _carg  INT,
			IN _func VARCHAR(200),
			IN _dire VARCHAR(200),
			IN _usr CHAR(20))
BEGIN
  DECLARE _msg    VARCHAR(100);
  DECLARE _existe INT ;
  DECLARE _id     INT ;
  
  SELECT COUNT(1)
  INTO _existe
  FROM t90_equi_fe
  WHERE t90_dni_equi = _dni ;
  
  IF _existe > 0 THEN
    SELECT CONCAT('La Persona con DNI ', _dni, ' ya fue registrado...')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
  ELSE
  
   SELECT IFNULL(MAX(t90_id_equi),0)+1 INTO _id
   FROM t90_equi_fe ;
   INSERT INTO t90_equi_fe 
	(t90_id_equi, 
	t90_dni_equi, 
	t90_ape_pat, 
	t90_ape_mat, 
	t90_nom_equi, 
	t90_sexo_equi, 
	t90_edad_equi, 
	t90_cali_equi, 
	t90_mail_equi, 
	t90_telf_equi, 
	t90_unid_fe, 
	t90_carg_equi, 
	t90_func_equi, 
	t90_direccion, 
	t90_estado, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(_id, 
	_dni ,
	_ape_pat ,
	_ape_mat ,
	_nom ,
	_sexo ,
	_edad ,
	_cali ,
	_mail ,
	_telf ,
	_unid ,
	_carg ,
	_func ,
	_dire ,
	'1',
	_usr ,
	NOW(),
	'1'
	);
    
    SELECT ROW_COUNT()  AS numrows, _id AS codigo, '' AS msg ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_equi_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_equi_proy`(IN _t02_cod_proy 	VARCHAR(10), 
				 IN _t04_id_equi	INT, 
				 IN _t04_dni_equi  	VARCHAR(20),
				 IN _t04_ape_pat  	VARCHAR(50),
				 IN _t04_ape_mat  	VARCHAR(50),
				 IN _t04_nom_equi	VARCHAR(50), 
				 IN _t04_sexo_equi  	INT,
				 IN _t04_edad_equi  	INT,
				 IN _t04_cali_equi  	INT,
				 IN _t04_telf_equi  	VARCHAR(50),
				 IN _t04_cel_equi  	VARCHAR(20),
				 IN _t04_mail_equi  	VARCHAR(20),
				 IN _t04_exp_lab  	TEXT,
				 IN _t04_func_equi  	TEXT,
				 IN _t04_carg_equi  	INT,
				 IN _t04_especialidad  	INT,
				 IN _fec_ini   		DATETIME,
				 IN _fec_ter   		DATETIME,
				 IN _t04_estado  	INT,
				 IN _UserID  		CHAR(20),
				 IN _fecha 		DATETIME,
				 IN _est_audi   	CHAR(1), IN _t04_especialidad_otro varchar(30))
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _existe1 	INT;
  DECLARE _existe2 	INT;
  DECLARE _numrows 	INT;
  DECLARE _apellido   	VARCHAR(50);
  DECLARE _nombre	VARCHAR(50);
  DECLARE _funcion   	TEXT;
  DECLARE _estado   	INT DEFAULT 113;
  
 
  
SELECT COUNT(1),
	r.t04_ape_pat, 
	r.t04_nom_equi 
 INTO _existe1,_apellido,_nombre
 FROM t04_equi_proy r 
WHERE t02_cod_proy=_t02_cod_proy AND t04_dni_equi=_t04_dni_equi AND t04_estado=_estado;
 
IF _existe1 > 0 THEN
	SELECT CONCAT('El personal  \"',_apellido,' ',_nombre,'\" esta registrado')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;      
END IF; 
 
SELECT 	COUNT(1), 
r.t04_ape_pat, 
r.t04_nom_equi, 
r.t04_func_equi
INTO _existe2, _apellido, _nombre, _funcion
FROM t04_equi_proy r
WHERE r.t02_cod_proy = _t02_cod_proy 
  AND t04_estado=_estado 
  AND t04_carg_equi <> ''
  AND t04_carg_equi =_t04_carg_equi;
	
IF _existe2 > 0 THEN
	SELECT CONCAT('El cargo fue asignado a \"',_apellido,' ',_nombre,'\" ')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;    
END IF ;
SELECT (IFNULL(MAX(t04_id_equi),0)+1) 
  INTO _t04_id_equi
FROM t04_equi_proy
WHERE t02_cod_proy=_t02_cod_proy ;
INSERT INTO t04_equi_proy 
(
t02_cod_proy, 
t04_id_equi, 
t04_dni_equi, 
t04_ape_pat, 
t04_ape_mat, 
t04_nom_equi, 
t04_sexo_equi, 
t04_edad_equi, 
t04_cali_equi, 
t04_mail_equi, 
t04_telf_equi, 
t04_cel_equi, 
t04_carg_equi, 
t04_esp_equi,
t04_func_equi, 
t04_exp_lab, 
t04_fec_ini,
t04_fec_ter,
t04_estado, 
usr_crea, 
fch_crea, 
est_audi,
t04_esp_otro
)
VALUES
(
_t02_cod_proy, 
_t04_id_equi, 
_t04_dni_equi , 
_t04_ape_pat,
_t04_ape_mat ,
_t04_nom_equi, 
_t04_sexo_equi,
_t04_edad_equi,
_t04_cali_equi,
_t04_mail_equi,
_t04_telf_equi,
_t04_cel_equi, 
_t04_carg_equi,
_t04_especialidad,
_t04_func_equi,
_t04_exp_lab ,
_fec_ini   ,
_fec_ter  ,
_t04_estado ,
_UserID ,
NOW(), 
_est_audi,
_t04_especialidad_otro 
);
SELECT ROW_COUNT() INTO _numrows;
COMMIT;
SELECT _numrows AS numrows, _t04_id_equi AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_fte_fin` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_fte_fin`( 
				 IN _t02_cod_proy 	VARCHAR(10),
				 IN _t01_id_inst	INT(11), 
				 IN _t02_porc_def  	DOUBLE,
				 IN _t02_obs_fte  	TEXT,
				 IN _t02_mto_financ  	DOUBLE,
				 IN _usr_crea 		VARCHAR(20),
				 IN _fch_crea  	DATE				
				 )
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _existe 	INT;
  DECLARE _id 		CHAR(2);   
  DECLARE _numrows 	INT;
  
  
	SELECT COUNT(1)
	INTO _existe
	FROM t02_fuente_finan
	WHERE t02_cod_proy=_t02_cod_proy AND t01_id_inst=_t01_id_inst;
	
  IF _existe > 0 THEN
      
    SELECT CONCAT('La Fuente de Financiamiento esta registrada en el proyecto ')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
     
  LEAVE TRANX;    
  ELSE 
  
  
INSERT INTO t02_fuente_finan 
	(
	t02_cod_proy, 
	t01_id_inst, 
	t02_porc_def, 
	t02_obs_fte, 
	t02_mto_financ, 
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu
	)
	VALUES
	(
	_t02_cod_proy, 
	_t01_id_inst, 
	_t02_porc_def, 
	_t02_obs_fte, 
	_t02_mto_financ, 
	_usr_crea, 
	NOW(), 
	'', 
	''
	);
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    SELECT _numrows AS numrows, '' AS msg , _id AS codigo ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_importar_pprov` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_importar_pprov`(
					in _concurso     VARCHAR(10)   ,
					in _codproy      VARCHAR(10)   ,
					in _region       VARCHAR(50)   ,
					in _inicio       DATETIME      ,
					in _termino      DATETIME      ,
					in _encargado    VARCHAR(100)  ,
					in _ejecutor     VARCHAR(150)  ,
					in _ruc          VARCHAR(11)   ,
					in _modogiro     VARCHAR(150)  ,
					in _banco        VARCHAR(100)  ,
					in _tipocuenta   CHAR(1)       ,
					in _nrocuenta    VARCHAR(30)   ,
					in _moncuenta    CHAR(1)       ,
					in _textoref     VARCHAR(200)  ,
					in _montotransf  DOUBLE        ,
					in _montranf     CHAR(1)       ,
					in _usr     	VARCHAR(20)   
					)
BEGIN
INSERT INTO tmp_pago_prov_bcp 
	(
	concurso, 
	codproy, 
	region, 
	inicio, 
	termino, 
	encargado, 
	ejecutor, 
	ruc, 
	modogiro, 
	banco, 
	tipocuenta, 
	nrocuenta, 
	moncuenta, 
	textoref, 
	montotransf, 
	montranf, 
	usu_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(
	_concurso, 
	_codproy, 
	_region, 
	_inicio, 
	_termino, 
	_encargado, 
	_ejecutor, 
	_ruc, 
	_modogiro, 
	_banco, 
	_tipocuenta, 
	_nrocuenta, 
	_moncuenta, 
	_textoref, 
	_montotransf, 
	_montranf, 
	_usr, 
	now(), 
	'1'
	);
   
    SELECT row_count()  AS numrows, _codproy AS codigo, '' AS msg ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_anx_foto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_anx_foto`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _mes  INT,
				IN _ver INT,
				in _nom varchar(100),
				in _desc varchar(5000),
				in _ext varchar(5),
				in _usr varchar(20)
				)
BEGIN
declare _url varchar(50);
declare _id int;
select IFNULL(max(anx.t20_cod_anx),0)+1
into   _id
FROM t20_inf_mes_anx anx
WHERE    anx.t02_cod_proy=_proy 
    AND  anx.t20_anio    =_anio 
    AND  anx.t20_mes     =_mes 
    AND  anx.t20_ver_inf =_ver ;
select concat(_proy,'_',_anio,'_',_mes,'_',_ver,'_',_id,'.', _ext) into _url;
INSERT INTO t20_inf_mes_anx 
	(t02_cod_proy, 
	t20_anio, 
	t20_mes, 
	t20_ver_inf, 
	t20_cod_anx, 
	t20_nom_file, 
	t20_url_file, 
	t20_desc_file, 
	usr_crea, 
	fch_crea
	)
	VALUES
	( _proy, 
	  _anio, 
	  _mes, 
	  _ver, 
	  _id , 
	  _nom , 
	  _url , 
	  _desc, 
	  _usr, 
	  now()
	);
SELECT ROW_COUNT() AS numrows, _id AS codigo, _url as url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_anx_inf_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_anx_inf_entregable`(
                IN _proy VARCHAR(10), 
                IN _ver INT,
                IN _anio INT, 
                IN _entregable INT,
                IN _nom VARCHAR(100),
                IN _desc TEXT,
                IN _ext VARCHAR(5),
                IN _usr VARCHAR(20))
BEGIN
    DECLARE _url VARCHAR(50);
    DECLARE _id INT;
    
    SELECT IFNULL(max(t25_cod_anx),0)+1
    INTO _id
    FROM t25_inf_entregable_anx
    WHERE t02_cod_proy = _proy 
    AND  t25_anio =_anio 
    AND  t25_entregable = _entregable 
    AND  t02_version =_ver;
    
    SELECT CONCAT(_proy,'_',_anio,'_',_entregable,'_',_ver,'_',_id,'.', _ext) INTO _url;
    
    INSERT INTO t25_inf_entregable_anx 
    (t02_cod_proy,
    t02_version,
    t25_anio, 
    t25_entregable, 
    t25_cod_anx, 
    t25_nom_file, 
    t25_url_file, 
    t25_desc_file, 
    usr_crea, 
    fch_crea
    )
    VALUES
    ( _proy,
      _ver, 
      _anio, 
      _entregable, 
      _id, 
      _nom, 
      _url, 
      _desc, 
      _usr, 
      now()
    );
    
    SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_entregable_caratula` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_entregable_caratula`(IN _proy VARCHAR(10), 
            IN _ver INT,
            IN _anio INT, 
            IN _entregable INT, 
            IN _periodo VARCHAR(50), 
            IN _fchpres DATETIME, 
            IN _estado INT,
            IN _usr VARCHAR(20), 
            IN _obs_gp TEXT,
	    IN _intro_gp TEXT)
BEGIN
    DECLARE _msg VARCHAR(100);
    DECLARE _mesactual INT;
    DECLARE _mesanterior INT;
    DECLARE _anio_ant INT;
    DECLARE _mes_ant INT;
    DECLARE _aprobado INT DEFAULT 0;
    DECLARE _existe INT;
    DECLARE _num_informes_ant INT DEFAULT 0;
    
    
    SELECT IFNULL(COUNT(t02_version),0) 
    INTO _existe 
    FROM t25_inf_entregable 
    WHERE t02_cod_proy = _proy AND t25_anio = _anio
    AND t25_entregable = _entregable
    AND t02_version = _ver;
      
    IF _existe > 0 THEN
        SET _msg = CONCAT('Ya fue registrado el Informe de Entregable seleccionado');
        SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
    ELSE
        
        SELECT IFNULL(t02_estado,0) INTO _existe FROM t02_poa WHERE t02_cod_proy = _proy AND t02_anio = _anio;
		  
		IF _existe <> 257 THEN
            SET _msg = CONCAT('El POA de este año no está aprobado');
            SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
		ELSE
            SELECT COUNT(*) 
		    INTO _num_informes_ant
		    FROM t20_inf_mes
		    WHERE t02_cod_proy = _proy 
		    AND t02_version = _ver
		    AND t20_anio = _anio
		    AND t20_mes < _entregable
		    AND t20_estado <> 135;
		    
            IF (_num_informes_ant > 0) THEN
                SET _msg = CONCAT('Existe al menos un Informe Técnico que todavía no tiene el VB del Gestor de Proyecto.');
                SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
	        ELSE
                SELECT COUNT(*) 
				INTO _num_informes_ant
				FROM t40_inf_financ
				WHERE t02_cod_proy = _proy 
				AND t40_anio = _anio
				AND t40_mes < _entregable
				AND t40_est_eje <> 135;
	            
	            IF (_num_informes_ant > 0) THEN
	                SET _msg = CONCAT('Existe al menos un Informe Financiero que todavía no está terminado.');
	                SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
	            ELSE
                   INSERT INTO t25_inf_entregable
	                (t02_cod_proy, 
	                t25_anio, 
	                t25_entregable, 
	                t25_fch_pre, 
	                t25_periodo,
	                t25_estado,  
	                t25_resulta, 
	                t25_conclu,
	                t25_limita,
	                t25_fac_pos,
	                t25_perspec,
	                t02_version, 
	                t25_vb,
	                t25_vb_fch,
	                usr_crea, 
	                fch_crea, 
	                est_audi, 
	                obs_gp,
			intro_gp
	                )
	                VALUES
	                (_proy, 
	                _anio, 
	                _entregable, 
	                _fchpres, 
	                _periodo, 
	                _estado, 
	                NULL,
	                NULL, 
	                NULL,
	                NULL,
	                NULL,
	                _ver, 
	                0,
	                NULL,
	                _usr, 
	                NOW(), 
	                '1',
	                _obs_gp,
			_intro_gp
	                );
	            
	                SELECT ROW_COUNT() AS numrows, _ver AS codigo;
                END IF;
	        END IF;
		END IF;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_financ_anexo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_financ_anexo`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _mes  INT,
				IN _nom VARCHAR(100),
				IN _desc VARCHAR(5000),
				IN _ext VARCHAR(5),
				IN _usr VARCHAR(20)
				)
BEGIN
DECLARE _url VARCHAR(50);
DECLARE _id INT;
SELECT IFNULL(MAX(anx.t40_cod_anx),0)+1
INTO   _id
FROM t40_inf_financ_anx anx
WHERE    anx.t02_cod_proy=_proy 
    AND  anx.t40_anio    =_anio 
    AND  anx.t40_mes     =_mes ;
SELECT CONCAT(_proy,'_',_anio,'_',_mes,'_',_id,'.', _ext) INTO _url;
INSERT INTO t40_inf_financ_anx 
	(t02_cod_proy, 
	t40_anio, 
	t40_mes, 
	t40_cod_anx, 
	t40_nom_file, 
	t40_url_file, 
	t40_desc_file, 
	usr_crea, 
	fch_crea
	)
	VALUES
	( _proy, 
	  _anio, 
	  _mes, 
	  _id , 
	  _nom , 
	  _url , 
	  _desc, 
	  _usr, 
	  NOW()
	);
SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_financ_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_financ_cab`(IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _mes INT, 
			IN _fchpres DATETIME , 
			IN _periodo VARCHAR(50), 
			IN _obs  TEXT ,
			IN _estado INT,
			IN _usr VARCHAR(20),                          IN _inf_financ_ter INT)
BEGIN
  DECLARE _msg   VARCHAR(100);
  DECLARE _existe INT ;
	DECLARE _mesactual INT;
	DECLARE _mesanterior INT;
	DECLARE _anio_ant INT;
	DECLARE _mes_ant INT;
	DECLARE _aprobado INT DEFAULT 135;
	
  SELECT COUNT(1)
  INTO _existe
  FROM t40_inf_financ
  WHERE t02_cod_proy = _proy
    AND t40_anio     = _anio
    AND t40_mes      = _mes ; 
		SELECT fn_numero_mes(_anio, _mes) INTO _mesactual;
		SELECT fn_numero_mes(_anio, _mes)-1 INTO _mesanterior;
		SELECT fn_numero_mes_rev(_mesanterior, 1) INTO _anio_ant;
		SELECT fn_numero_mes_rev(_mesanterior, 2) INTO _mes_ant;
		 IF _mesactual !=1 THEN
			SELECT t40_est_eje INTO _aprobado
			FROM t40_inf_financ
			 WHERE t02_cod_proy = _proy
				AND t40_anio     = _anio_ant
				AND t40_mes      = _mes_ant ;
		END IF;
  
  IF _existe > 0 THEN
    SELECT CONCAT('El informe para el periodo Año ', _anio, ', Mes ', _mes, ' ya fue registrado')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
	
	ELSEIF _aprobado != 135 THEN
			SELECT CONCAT('El informe para el periodo Año ', _anio_ant, ', Mes ', _mes_ant, ' todavía no tiene el visto bueno del Gestor de Proyectos.')
			INTO _msg ;
			SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
	
  ELSE
  
    INSERT INTO t40_inf_financ 
	( t02_cod_proy, 
	  t40_anio, 
	  t40_mes, 
	  t40_fch_pre, 
	  t40_periodo, 
	  t40_est_eje, 
	  t40_obs, 
	  usr_crea, 
	  fch_crea, 
	  usr_actu, 
	  fch_actu, 
	  est_audi,
	  inf_fi_ter
	)
	VALUES
	( _proy , 
	  _anio, 
	  _mes, 
	  _fchpres, 
	  _periodo, 
	  _estado, 
	  _obs, 
	  _usr, 
	  NOW(), 
	  NULL, 
	  NULL , 
	  '1',
		_inf_financ_ter
	);
     
    SELECT ROW_COUNT() AS numrows, _mes AS codigo, '' AS msg;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_mes_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_mes_cab`(IN _proy varchar(10), 
            IN _anio INT, 
            IN _mes INT, 
            IN _periodo varchar(50), 
            IN _fchpres datetime , 
            IN _estado INT,
            IN _usr varchar(20))
BEGIN
  DECLARE _verInf   INT;
    DECLARE _msg   VARCHAR(100);
    DECLARE _mesactual INT;
    DECLARE _mesanterior INT;
    DECLARE _anio_ant INT;
    DECLARE _mes_ant INT;
    DECLARE _aprobado INT DEFAULT -1;
    declare suspYr INT;
    declare suspMt INT;
 
    SELECT fn_numero_mes(_anio, _mes) INTO _mesactual;
    SELECT fn_numero_mes(_anio, _mes)-1 INTO _mesanterior;
    SELECT fn_numero_mes_rev(_mesanterior, 1) INTO _anio_ant;
    SELECT fn_numero_mes_rev(_mesanterior, 2) INTO _mes_ant;
    IF _mesactual !=1 THEN
        SELECT t20_estado INTO _aprobado
        FROM t20_inf_mes
        WHERE t02_cod_proy = _proy
            AND t20_anio     = _anio_ant
            AND t20_mes      = _mes_ant ;
    END IF;
  
    if (_mesactual > 1) then
        SELECT t.t02_anio, IFNULL(t.diff, 12) AS duraction
        INTO suspYr, suspMt
        FROM (
            SELECT t2.t02_anio, t3.t02_fch_susp, t3.t02_fch_reinic,
                TIMESTAMPDIFF(MONTH, t3.t02_fch_susp, t3.t02_fch_reinic) + 1 AS diff
            FROM t02_dg_proy t1
            JOIN t02_poa t2 ON (t2.t02_cod_proy = t1.t02_cod_proy)
            LEFT JOIN t02_suspenciones t3 ON (t3.t02_cod_proy = t1.t02_cod_proy AND t3.t02_version = t2.t02_anio + 1)
            WHERE t1.t02_cod_proy = _proy AND t1.t02_version = 1) AS t
        WHERE t.t02_anio = _anio_ant
        ORDER BY t.t02_anio DESC
        LIMIT 1;
            
        IF (suspYr IS NOT NULL AND _mes_ant > suspMt) THEN
            SELECT 1 INTO _mesactual;
        END IF;
    end if;
    
    IF _mesactual != 1 and _aprobado != 135 THEN        
        SELECT CONCAT('El informe técnico para el periodo Año ', _anio_ant, ', Mes ', _mes_ant, ' todavía no tiene el visto bueno del Gestor de Proyectos.')
        INTO _msg ;
        SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
    ELSE   
        SELECT  IFNULL(MAX(t20_ver_inf),0)+1 INTO _verInf 
        FROM    t20_inf_mes 
        WHERE   t02_cod_proy    = _proy  
            and t20_anio = _anio
            and t20_mes  = _mes;
 
        INSERT INTO t20_inf_mes 
            (t02_cod_proy, 
            t20_anio, 
            t20_mes, 
            t20_ver_inf, 
            t20_fch_pre, 
            t20_periodo, 
            t20_obs, 
            t20_estado, 
            t02_version, 
            usr_crea, 
            fch_crea, 
            est_audi
            )
        VALUES
            (_proy, 
            _anio, 
            _mes, 
            _verInf,  
            _fchpres, 
            _periodo, 
            '', 
            _estado, 
            fn_ult_version_proy(_proy), 
            _usr, 
            NOW(), 
            '1'
            );
        select ROW_COUNT() as numrows, _verInf as codigo, '' AS msg;          
    END IF;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_mf_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_mf_anexos`(
				IN _proy VARCHAR(10), 
				IN _num INT, 
				IN _nom VARCHAR(100),
				IN _desc VARCHAR(5000),
				IN _ext VARCHAR(5),
				IN _usr VARCHAR(20)
				)
BEGIN
DECLARE _url VARCHAR(50);
DECLARE _id INT;
SELECT IFNULL(MAX(anx.t51_cod_anx),0)+1
INTO   _id
FROM t51_inf_mf_anexos anx
WHERE    anx.t02_cod_proy=_proy 
    AND  anx.t51_id      =_num ;
    
SELECT CONCAT(_proy,'_',_num,'_',_id,'.', _ext) INTO _url;
INSERT INTO t51_inf_mf_anexos 
	(t02_cod_proy, 
	t51_id, 
	t51_cod_anx, 
	t51_nom_file, 
	t51_url_file, 
	t51_desc_file, 
	usr_crea, 
	fch_crea
	)
	VALUES
	( _proy, 
	  _num, 
	  _id , 
	  _nom , 
	  _url , 
	  _desc, 
	  _usr, 
	  NOW()
	);
SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_mf_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_mf_cab`(IN  _proy VARCHAR(10), 
			IN  _fchpres DATETIME , 
			in  _per_ini int ,
			in  _per_fin int ,
			IN  _obs     TEXT ,
			in  _conclu  text,
			in  _calif   int,
			IN  _estado INT,
			IN  _usr VARCHAR(20), IN _obs_cmt VARCHAR(200))
BEGIN
  DECLARE _msg   text;
  DECLARE _existe INT ;
  declare _mumInf int ;
  declare _periodo varchar(50);
  
  SELECT COUNT(1)
  INTO _existe
  FROM t51_inf_mf
  WHERE t02_cod_proy = _proy
    AND t51_per_ini  = _per_ini
    AND t51_per_fin  = _per_fin ;
  
  IF _existe > 0 THEN
    SELECT 'Ya fue registrado un Informe con el periodo Especificado,  '
    INTO _msg ;
    
    SELECT 0 AS numrows, -1 AS codigo, _msg AS msg ;
    
  ELSE
  
    select ifnull(max(t51_num),0) + 1
    into   _mumInf    
    from   t51_inf_mf 
    where  t02_cod_proy = _proy ;
    
    SELECT concat(fn_nom_mes(t40_periodo), ' ' ,YEAR(t40_fch_pre))
      into _periodo
      FROM t40_inf_financ 
     WHERE t02_cod_proy = _proy
       AND fn_numero_mes(t40_anio, t40_mes) = _per_ini ;
  
    sELECT CONCAT(_periodo, ' - ' , fn_nom_mes(t40_periodo), ' ' , YEAR(t40_fch_pre))
      INTO _periodo
      FROM t40_inf_financ 
     WHERE t02_cod_proy = _proy
       AND fn_numero_mes(t40_anio, t40_mes) = _per_fin ;
    
    
  
    INSERT INTO t51_inf_mf ( 	
		t02_cod_proy, 
		t51_num, 
		t51_fch_pre, 
		t51_per_ini, 
		t51_per_fin, 
		t51_periodo, 
		t51_estado, 
		t51_obs, 
		t51_conclu, 
		t51_califica, 
		usr_crea, 
		fch_crea, 
		usr_actu, 
		fch_actu, 
		est_audi,
		t51_obs_cmt)
	VALUES	(	 
		  _proy , 
		  _mumInf, 
		  _fchpres, 
		  _per_ini,
		  _per_fin,
		  _periodo, 
		  _estado, 
		  _obs, 
		  _conclu,
		  _calif ,
		  _usr, 
		  NOW(), 
		  NULL, 
		  NULL , 
		  '1',
			_obs_cmt
	);
     
    SELECT ROW_COUNT() AS numrows, _mumInf AS codigo, '' AS msg ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_se_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_ins_inf_se_anexos`(
                IN _proy VARCHAR(10), 
                IN _anio INT, 
                IN _entregable INT,
                IN _nom VARCHAR(100),
                IN _desc TEXT,
                IN _ext VARCHAR(5),
                IN _usr VARCHAR(20)
                )
BEGIN
	DECLARE _url VARCHAR(50);
	DECLARE _id INT;
	
	SELECT IFNULL(MAX(t30_cod_anx),0)+1
	INTO _id
	FROM t30_inf_se_anexos
	WHERE t02_cod_proy = _proy 
	    AND t02_anio = _anio 
	    AND t02_entregable = _entregable;
	    
	SELECT CONCAT(_proy,'_',_anio,'_',_entregable,'_',_id,'.', _ext) INTO _url;
	
	INSERT INTO t30_inf_se_anexos 
	    (t02_cod_proy, 
	    t02_anio, 
	    t02_entregable, 
	    t30_cod_anx, 
	    t30_nom_file, 
	    t30_url_file, 
	    t30_desc_file, 
	    usr_crea, 
	    fch_crea
	    )
	    VALUES
	    ( _proy, 
	      _anio, 
	      _entregable, 
	      _id , 
	      _nom , 
	      _url , 
	      _desc, 
	      _usr, 
	      NOW()
	    );
	    
	SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_se_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_ins_inf_se_cab`(IN _proy VARCHAR(10), 
            IN _anio  INT,
            IN _entregable  INT,
            IN _periodo VARCHAR(50), 
            IN _fchpres DATETIME, 
            IN _estado INT,
            IN _fec_ini_vis DATETIME,
            IN _fec_ter_vis DATETIME,
            IN _usr VARCHAR(20))
BEGIN
    DECLARE _existe INT;
    DECLARE _cod INT;
    DECLARE _vb CHAR;
    DECLARE _count INT;
    
    SELECT IFNULL(COUNT(t02_entregable), 0)
    INTO _existe
    FROM t30_inf_se 
    WHERE t02_cod_proy = _proy
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
      
    IF _existe > 0 then
       SET _cod = 2;
    ELSE
        SELECT  IFNULL(COUNT(t30_estado), 0)
        INTO _count
        FROM t30_inf_se
        WHERE t02_cod_proy = _proy
        AND t02_anio <> _anio
        AND t02_entregable <> _entregable
        AND t30_estado <> 285;
        
        IF _count > 0 then
           SET _cod = 3; 
        ELSE
            
        
           SET _existe = 1; 
            
            IF _existe = 1 THEN
                 
                
                SET _vb = "1"; 
                    
                IF _vb = "1" THEN
                    INSERT INTO t30_inf_se (t02_cod_proy, 
                    t02_anio,
                    t02_entregable, 
                    t30_fch_pre, 
                    t30_periodo,    
                    t30_estado,
                    t30_fec_ini_vis,
                    t30_fec_ter_vis,
                    usr_crea, 
                    fch_crea, 
                    est_audi)
            VALUES( _proy, 
                    _anio,
                    _entregable, 
                    _fchpres, 
                    _periodo,
                    _estado, 
                    _fec_ini_vis,
                    _fec_ter_vis,
                    _usr, 
                    NOW(), 
                    '1');
                    SET _cod = 1;
                ELSE
                    SET _cod = 4; 
                END IF;
            ELSE
                SET _cod = 5; 
            END IF;
        END IF;
    END IF;
    
    SELECT ROW_COUNT() AS numrows, _cod AS codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_si_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_ins_inf_si_anexos`(
                IN _proy VARCHAR(10), 
                IN _anio INT, 
                IN _entregable INT,
                IN _nom VARCHAR(100),
                IN _desc TEXT,
                IN _ext VARCHAR(5),
                IN _usr VARCHAR(20)
                )
BEGIN
    DECLARE _url VARCHAR(50);
    DECLARE _id INT;
    
    SELECT IFNULL(MAX(t45_cod_anx),0)+1
    INTO _id
    FROM t45_inf_si_anexos
    WHERE t02_cod_proy = _proy 
        AND t02_anio = _anio 
        AND t02_entregable = _entregable;
        
    SELECT CONCAT(_proy,'_',_anio,'_',_entregable,'_',_id,'.', _ext) INTO _url;
    
    INSERT INTO t45_inf_si_anexos 
        (t02_cod_proy, 
        t02_anio, 
        t02_entregable, 
        t45_cod_anx, 
        t45_nom_file, 
        t45_url_file, 
        t45_desc_file, 
        usr_crea, 
        fch_crea
        )
        VALUES
        ( _proy, 
          _anio, 
          _entregable, 
          _id , 
          _nom , 
          _url , 
          _desc, 
          _usr, 
          NOW()
        );
        
    SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_si_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_ins_inf_si_cab`(IN _proy VARCHAR(10), 
            IN _anio  INT,
            IN _entregable  INT,
            IN _periodo VARCHAR(50), 
            IN _fchpres DATETIME, 
            IN _estado INT,
            IN _fec_ini_vis DATETIME,
            IN _fec_ter_vis DATETIME,
            IN _usr VARCHAR(20))
BEGIN
    DECLARE _existe INT;
    DECLARE _cod INT;
    DECLARE _vb CHAR;
    
    SELECT IFNULL(COUNT(t02_entregable), 0)
    INTO _existe
    FROM t45_inf_si 
    WHERE t02_cod_proy = _proy
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
      
    IF _existe > 0 then
       SET _cod = 2;
    ELSE
        SELECT t45_estado 
        INTO _cod
        FROM t45_inf_si
        WHERE t02_cod_proy = _proy
        AND t02_anio <> _anio
        AND t02_entregable <> _entregable;
        
        IF _cod <> 285 then
           SET _cod = 3; 
        ELSE
            
        
           SET _existe = 1; 
            
            IF _existe = 1 THEN
                 
                
                SET _vb = "1"; 
                    
                IF _vb = "1" THEN
                    INSERT INTO t45_inf_si (t02_cod_proy, 
                    t02_anio,
                    t02_entregable, 
                    t45_fch_pre, 
                    t45_periodo,    
                    t45_estado,
                    t45_fec_ini_vis,
                    t45_fec_ter_vis,
                    usr_crea, 
                    fch_crea, 
                    est_audi)
            VALUES( _proy, 
                    _anio,
                    _entregable, 
                    _fchpres, 
                    _periodo,
                    _estado, 
                    _fec_ini_vis,
                    _fec_ter_vis,
                    _usr, 
                    NOW(), 
                    '1');
                    SET _cod = 1;
                ELSE
                    SET _cod = 4; 
                END IF;
            ELSE
                SET _cod = 5; 
            END IF;
        END IF;
    END IF;
    
    SELECT ROW_COUNT() AS numrows, _cod AS codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_trim_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_trim_cab`(IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _trim INT, 
			IN _periodo VARCHAR(50), 
			IN _fchpres DATETIME , 
			IN _estado INT,
			IN _usr VARCHAR(20),   IN _obs_mt TEXT)
BEGIN
  DECLARE _verInf   INT;
	DECLARE _msg   VARCHAR(100);
	DECLARE _mesactual INT;
	DECLARE _mesanterior INT;
	DECLARE _anio_ant INT;
	DECLARE _mes_ant INT;
	DECLARE _aprobado INT DEFAULT 0;
		SELECT fn_numero_mes(_anio, (_trim*3))INTO _mesactual;
		SELECT fn_numero_mes(_anio, (_trim*3))-1 INTO _mesanterior;
		SELECT fn_numero_mes_rev(_mesanterior, 1) INTO _anio_ant;
		SELECT fn_numero_mes_rev(_mesanterior, 2) INTO _mes_ant;
		
		 IF _mesactual <> 1 THEN
			IF _mesanterior/3 = 0 THEN
				SELECT t25_estado INTO _aprobado
				FROM t25_inf_trim
			 WHERE t02_cod_proy = _proy
				AND t25_anio     = _anio_ant
				AND t25_trim      = _mes_ant/3 ;
			ELSE			
			SELECT t20_estado INTO _aprobado
			FROM t20_inf_mes
				WHERE t02_cod_proy = _proy
				AND t20_anio    = _anio_ant
				AND t20_mes     = _mes_ant 
				AND t20_ver_inf	= (SELECT	ifnull(MAX(t20_ver_inf),1)
									FROM	t20_inf_mes 
									WHERE	t02_cod_proy = _proy 
										AND t20_anio = _anio_ant 
										AND t20_mes = _mes_ant);
			
			END IF;
		ELSE
		SELECT 135 into _aprobado;
		END IF;
  
	
	IF _aprobado <> 135 THEN			
			SELECT CONCAT('El informe técnico para el periodo Año ', _anio_ant, ', Mes ', _mes_ant, ' todavía no tiene el visto bueno del Gestor de Proyectos.')
			INTO _msg ;
			SELECT 0 AS numrows, 0 AS codigo, _msg AS msg;
	ELSE
  SELECT IFNULL(MAX(t25_ver_inf),0)+1 INTO _verInf 
  FROM 	 t25_inf_trim 
  WHERE  t02_cod_proy	= _proy  
    AND  t25_anio = _anio
    AND  t25_trim  = _trim;
 
  INSERT INTO t25_inf_trim
	(t02_cod_proy, 
	t25_anio, 
	t25_trim, 
	t25_ver_inf, 
	t25_fch_pre, 
	t25_periodo,
	t25_estado,  
	t25_resulta, 
	t25_conclu,
	t25_limita,
	t25_fac_pos,
	t25_perspec,
	t02_version, 
	t25_apro_mt,
	t25_apro_fch,
	usr_crea, 
	fch_crea, 
	est_audi, 
	obs_mt
	)
	VALUES
	(_proy, 
	_anio, 
	_trim, 
	_verInf,  
	_fchpres, 
	_periodo, 
	_estado, 
	NULL,
	NULL, 
	NULL,
	NULL,
	NULL,
	fn_ult_version_proy(_proy), 
	0,
	NULL,
	_usr, 
	NOW(), 
	'1',
	_obs_mt
	);

 SELECT ROW_COUNT() AS numrows, _verInf AS codigo, _aprobado ; 
END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_unico_anual_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_unico_anual_cab`(IN _proy VARCHAR(10), 
			IN _anio INT, 
		IN _ini INT , IN _fin INT,	IN _periodo VARCHAR(50), 
			IN _fchpres DATETIME , 
			IN _estado INT,
			IN _usr VARCHAR(20))
BEGIN
  DECLARE _mumInf INT ;
  DECLARE _mes_1 INT DEFAULT 1;
  DECLARE _mes_12 INT DEFAULT 12;
  
  SELECT IFNULL(MAX(t55_id),0) + 1
    INTO   _mumInf    
    FROM   t55_inf_unico_anual 
    WHERE  t02_cod_proy = _proy ;
      
  INSERT INTO t55_inf_unico_anual 
	(
	t02_cod_proy, 
	t55_id,
	t55_anio, 
	t55_ver_inf,
	t55_per_ini, 
	t55_per_fin,  
	t55_fch_pre, 
	t55_periodo, 
	t55_estado, 
	t55_avan_comp, 
	t55_avan_cap, 
	t55_avan_fin, 
	t55_eva1, 
	t55_eva2, 
	t55_eva3, 
	t55_eva4, 
	t55_eva5, 
	t55_eva6, 
	t55_eva7, 
	t55_eva1_obs, 
	t55_eva2_obs, 
	t55_eva3_obs, 
	t55_eva4_obs, 
	t55_eva5_obs, 
	t55_eva6_obs, 
	t55_eva7_obs, 	
	t55_logros, 
	t55_dificultades, 
	t55_reco_proy, 
	t55_reco_fe, 
	t55_recomendaciones, 	
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(
	_proy, 
	_mumInf,
	_anio, 
	NULL, 
	_ini, 
	_fin,  
	_fchpres, 
	_periodo, 
	_estado, 
	NULL,
	NULL, 
	NULL,
	NULL,
	NULL, 
	NULL,
	NULL,
	NULL, 
	NULL,
	NULL,
	NULL, 
	NULL,
	NULL,
	NULL, 
	NULL,
	NULL,
	NULL, 
	NULL,
	NULL,
	NULL,
	NULL, 
	NULL,
	_usr, 
	NOW(),  
	'1'
	);  
  

SELECT ROW_COUNT() AS numrows, _anio AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_visita_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_visita_mf`(IN _t02_cod_proy VARCHAR(10),
					
					IN _t52_tipo_vis INT ,
					IN _t52_per_ini INT  ,
					IN _t52_per_fin INT  ,
					IN _t52_nom_per_ent VARCHAR(50),
					IN _t52_car_per_ent VARCHAR(30),
					IN _t52_quest_01 CHAR(1)  ,
					IN _t52_obs_01 TEXT,
					IN _t52_quest_02 CHAR(1)  ,
					IN _t52_obs_02 TEXT,
					IN _t52_quest_03 CHAR(1)  ,
					IN _t52_obs_03 TEXT,
					IN _t52_quest_04 CHAR(1)  ,
					IN _t52_obs_04 TEXT,
					IN _t52_quest_05 CHAR(1)  ,
					IN _t52_obs_05 TEXT,
					IN _t52_quest_06 CHAR(1)  ,
					IN _t52_obs_06 TEXT,
					IN _t52_quest_07 CHAR(1)  ,
					IN _t52_obs_07 TEXT,
					IN _t52_quest_08 CHAR(1)  ,
					IN _t52_obs_08 TEXT,
					IN _t52_quest_09 CHAR(1)  ,
					IN _t52_obs_09 TEXT,
					IN _t52_quest_10 CHAR(1)  ,
					IN _t52_obs_10 TEXT,
					IN _t52_quest_11 CHAR(1)  ,
					IN _t52_obs_11 TEXT,
					IN _t52_quest_12 CHAR(1)  ,
					IN _t52_obs_12 TEXT,
					IN _t52_quest_13 CHAR(1)  ,
					IN _t52_obs_13 TEXT,
					IN _t52_quest_14 CHAR(1)  ,
					IN _t52_obs_14 TEXT,
					IN _t52_quest_15 CHAR(1)  ,
					IN _t52_obs_15 TEXT,
					IN _t52_quest_16 CHAR(1)  ,
					IN _t52_obs_16 TEXT,
					IN _t52_quest_17 CHAR(1)  ,
					IN _t52_obs_17 TEXT,
					IN _t52_quest_18 CHAR(1)  ,
					IN _t52_obs_18 TEXT,
					IN _t52_quest_19 CHAR(1)  ,
					IN _t52_obs_19 TEXT,
					IN _t52_quest_20 CHAR(1)  ,
					IN _t52_obs_20 TEXT,
					IN _t52_quest_21 CHAR(1)  ,
					IN _t52_obs_21 TEXT,
					IN _t52_quest_22 CHAR(1)  ,
					IN _t52_obs_22 TEXT,
					IN _t52_quest_23 CHAR(1)  ,
					IN _t52_obs_23 TEXT,
					IN _t52_fch_pre DATETIME  ,
					IN _t52_estado INT  ,
					IN _t52_obs TEXT ,
					IN _t52_conclu TEXT ,
					IN _t52_califica INT  ,
					IN _usr CHAR(20), IN _obs_cmt VARCHAR(200))
BEGIN
declare _t52_num INT ;
DECLARE _periodo VARCHAR(50);
select ifnull(max(t52_num),0)+1
  into _t52_num
from t52_inf_visita_mf
where t02_cod_proy = _t02_cod_proy ;
SELECT CONCAT ( (
		    SELECT CONCAT(fn_nom_mes(t40_periodo), ' ' ,YEAR(t40_fch_pre))
		      FROM t40_inf_financ 
		     WHERE t02_cod_proy = _t02_cod_proy
		       AND fn_numero_mes(t40_anio, t40_mes) = _t52_per_ini
		 ),
		 ' - ' ,
		 (
		    SELECT CONCAT(fn_nom_mes(t40_periodo), ' ' ,YEAR(t40_fch_pre))
		      FROM t40_inf_financ 
		     WHERE t02_cod_proy = _t02_cod_proy
		       AND fn_numero_mes(t40_anio, t40_mes) = _t52_per_fin 
		 )
	       )
	into _periodo ;
 
INSERT INTO t52_inf_visita_mf 
	(t02_cod_proy, 
	t52_num, 
	t52_tipo_vis, 
	t52_per_ini, 
	t52_per_fin, 
	t52_nom_per_ent, 
	t52_car_per_ent, 
	t52_quest_01, 
	t52_obs_01, 
	t52_quest_02, 
	t52_obs_02, 
	t52_quest_03, 
	t52_obs_03, 
	t52_quest_04, 
	t52_obs_04, 
	t52_quest_05, 
	t52_obs_05, 
	t52_quest_06, 
	t52_obs_06, 
	t52_quest_07, 
	t52_obs_07, 
	t52_quest_08, 
	t52_obs_08, 
	t52_quest_09, 
	t52_obs_09, 
	t52_quest_10, 
	t52_obs_10, 
	t52_quest_11, 
	t52_obs_11, 
	t52_quest_12, 
	t52_obs_12, 
	t52_quest_13, 
	t52_obs_13, 
	t52_quest_14, 
	t52_obs_14, 
	t52_quest_15, 
	t52_obs_15, 
	t52_quest_16, 
	t52_obs_16, 
	t52_quest_17, 
	t52_obs_17, 
	t52_quest_18, 
	t52_obs_18, 
	t52_quest_19, 
	t52_obs_19, 
	t52_quest_20, 
	t52_obs_20, 
	t52_quest_21, 
	t52_obs_21, 
	t52_quest_22, 
	t52_obs_22, 
	t52_quest_23, 
	t52_obs_23, 
	t52_periodo,
	t52_fch_pre, 
	t52_estado, 
	t52_obs, 
	t52_conclu, 
	t52_califica, 
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu, 
	est_audi,
	t52_obs_cmt
	)
	VALUES
	(_t02_cod_proy,  
	_t52_num,  
	_t52_tipo_vis,  
	_t52_per_ini,  
	_t52_per_fin,  
	_t52_nom_per_ent,  
	_t52_car_per_ent,  
	_t52_quest_01,  
	_t52_obs_01,  
	_t52_quest_02,  
	_t52_obs_02,  
	_t52_quest_03,  
	_t52_obs_03,  
	_t52_quest_04,  
	_t52_obs_04,  
	_t52_quest_05,  
	_t52_obs_05,  
	_t52_quest_06,  
	_t52_obs_06,  
	_t52_quest_07,  
	_t52_obs_07,  
	_t52_quest_08,  
	_t52_obs_08,  
	_t52_quest_09,  
	_t52_obs_09,  
	_t52_quest_10,  
	_t52_obs_10,  
	_t52_quest_11,  
	_t52_obs_11,  
	_t52_quest_12,  
	_t52_obs_12,  
	_t52_quest_13,  
	_t52_obs_13,  
	_t52_quest_14,  
	_t52_obs_14,  
	_t52_quest_15,  
	_t52_obs_15,  
	_t52_quest_16,  
	_t52_obs_16,  
	_t52_quest_17,  
	_t52_obs_17,  
	_t52_quest_18,  
	_t52_obs_18,  
	_t52_quest_19,  
	_t52_obs_19,  
	_t52_quest_20,  
	_t52_obs_20,  
	_t52_quest_21,  
	_t52_obs_21,  
	_t52_quest_22,  
	_t52_obs_22,  
	_t52_quest_23,  
	_t52_obs_23,
	_periodo ,
	_t52_fch_pre,  
	_t52_estado,  
	_t52_obs,  
	_t52_conclu,  
	_t52_califica,  
	_usr,  
	now(),  
	null,  
	null,  
	'1',
_obs_cmt
	);
 
					
select ROW_COUNT() as numrows, _t52_num as codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_inf_visita_mf_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_inf_visita_mf_anexos`(
				IN _proy VARCHAR(10), 
				IN _num INT, 
				IN _nom VARCHAR(100),
				IN _desc VARCHAR(5000),
				IN _ext VARCHAR(5),
				IN _usr VARCHAR(20)
				)
BEGIN
DECLARE _url VARCHAR(50);
DECLARE _id INT;
SELECT IFNULL(MAX(anx.t52_cod_anx),0)+1
INTO   _id
FROM t52_inf_visita_mf_anexos anx
WHERE    anx.t02_cod_proy=_proy 
    AND  anx.t52_id      =_num ;
    
SELECT CONCAT(_proy,'_',_num,'_',_id,'.', _ext) INTO _url;
INSERT INTO t52_inf_visita_mf_anexos 
	(t02_cod_proy, 
	t52_id, 
	t52_cod_anx, 
	t52_nom_file, 
	t52_url_file, 
	t52_desc_file, 
	usr_crea, 
	fch_crea
	)
	VALUES
	( _proy, 
	  _num, 
	  _id , 
	  _nom , 
	  _url , 
	  _desc, 
	  _usr, 
	  NOW()
	);
SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_institucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_institucion`( 
					IN _t01_ruc_inst   VARCHAR(15) , 
					IN _t01_sig_inst   VARCHAR(50) , 
					IN _t01_nom_inst   VARCHAR(200),
					IN _t01_fch_fund   DATE        ,   
					IN _t01_pres_anio  DOUBLE      , 
					IN _t01_dpto       CHAR(2)     , 
					IN _t01_prov       CHAR(2)     ,
					IN _t01_dist       CHAR(2)     ,
					IN _t01_dire_inst  VARCHAR(200), 
					IN _t01_ciud_inst  VARCHAR(50) ,
					IN _t01_fono_inst  VARCHAR(50) , 
					IN _t01_fax_inst   VARCHAR(50) ,
					IN _t01_mail_inst  VARCHAR(50) ,
					IN _t01_web_inst   VARCHAR(50) ,
					IN _t01_ape_rep    VARCHAR(70) ,
					IN _t01_nom_rep    VARCHAR(50) ,
					IN _t01_carg_rep   VARCHAR(50) ,
					IN _t01_tipo_inst  INT(11)  ,
					IN _t01_fono2  VARCHAR(50) , 
					IN _t01_rpm  VARCHAR(15) , 
					IN _t01_rpc  VARCHAR(15) , 
					IN _t01_next  VARCHAR(15) ,
					IN _t01_relfe VARCHAR(100),
					IN _usu  	VARCHAR(20)
				    )
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _existe 	INT;
  DECLARE _t01_id_inst 	INT;
  DECLARE _numrows 	INT;
  
  
SELECT COUNT(1)
  INTO _existe
  FROM t01_dir_inst
 WHERE t01_ruc_inst=_t01_ruc_inst ;
	
  IF _existe > 0 THEN
      
    SELECT CONCAT('Ya existe una Institucion, con el RUC:',_t01_ruc_inst,'.')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
     
    LEAVE TRANX;    
  END IF ;
  
  IF EXISTS(SELECT t01_sig_inst FROM t01_dir_inst WHERE t01_sig_inst = _t01_sig_inst) THEN
      
    SELECT CONCAT('La Institucion, ',_t01_sig_inst,', ya fue registrada')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
     
    LEAVE TRANX;    
  END IF ;
  
   SELECT IFNULL(MAX(t01_id_inst),0) + 1
    INTO _t01_id_inst 
    FROM  t01_dir_inst ;
    
INSERT INTO t01_dir_inst 
	(t01_id_inst, 
	t01_ruc_inst, 
	t01_sig_inst, 
	t01_nom_inst, 
	t01_fch_fund, 
	t01_pres_anio, 
	t01_dpto, 
	t01_prov, 
	t01_dist, 
	t01_dire_inst, 
	t01_ciud_inst, 
	t01_fono_inst, 
	t01_fax_inst, 
	t01_mail_inst, 
	t01_web_inst, 
	t01_ape_rep, 
	t01_nom_rep, 
	t01_carg_rep, 
	t01_tipo_inst, 
	t01_fono2_inst, 
	t01_rpm_inst, 
	t01_next_inst, 
	t01_rpc_inst, 
	t01_rel_fe,
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(_t01_id_inst, 
	_t01_ruc_inst, 
	UPPER(_t01_sig_inst), 
	_t01_nom_inst, 
	_t01_fch_fund, 
	_t01_pres_anio, 
	_t01_dpto, 
	_t01_prov, 
	_t01_dist, 
	_t01_dire_inst, 
	_t01_ciud_inst, 
	_t01_fono_inst, 
	_t01_fax_inst, 
	_t01_mail_inst, 
	_t01_web_inst, 
	_t01_ape_rep, 
	_t01_nom_rep, 
	_t01_carg_rep, 
	_t01_tipo_inst, 
	_t01_fono2  , 
	_t01_rpm  , 
	_t01_next ,
	_t01_rpc  , 
	_t01_relfe,
	_usu, 
	NOW(), 
	'0'
	);
	
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    
    SELECT _numrows AS numrows, '' AS msg , _t01_id_inst AS codigo ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_a_admin` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_a_admin`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20))
BEGIN
DECLARE _mail_destino VARCHAR(200);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
IF _mail_origen = '' THEN
	SET _mail_origen = fn_mail_x_proyecto(_proy,1) ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
END IF; 
SET _mail_destino =  CONCAT(', ', fn_mail_x_proyecto(_proy,9) ) ;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo por parte de EVASIS ',_proy);
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_a_ejecutor` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_a_ejecutor`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20))
BEGIN
DECLARE _mail_destino VARCHAR(200);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,1),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,0) ),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,8) ),'') 
		
			      ) ;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo ',_proy);
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_a_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_a_fe`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20))
BEGIN
DECLARE _mail_destino VARCHAR(200);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
IF _mail_origen = '' THEN
	SET _mail_origen = fn_mail_x_proyecto(_proy,1) ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
END IF; 
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,2),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,1) ),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,3) ),''), 
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,5) ),'') 
		
			      ) ;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo por parte del ejecutor del proyecto ',_proy);
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_a_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_a_financ`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20), IN _tip char(4))
BEGIN
DECLARE _mail_destino VARCHAR(200);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
IF _mail_origen = '' THEN
	SET _mail_origen = fn_mail_x_proyecto(_proy,1) ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
END IF; 
IF _tip = 'reff' THEN
SET _mail_origen= fn_mail_x_proyecto(_proy,3) ;
SET _mail_destino = fn_mail_x_proyecto(_proy,7) ;
SET _mensaje = CONCAT('Mensaje enviado automaticamente de Fondoempleo por parte del Gestor del proyecto ',_proy);
END IF;
		
IF _tip = 'ceff' THEN
SET _mail_origen= fn_mail_x_proyecto(_proy,7) ;
SET _mail_destino = fn_mail_x_proyecto(_proy,3) ;
SET _mensaje = CONCAT('Mensaje enviado automaticamente de Fondoempleo por parte del Responsable de Area del proyecto ',_proy);
END IF;
IF _tip = 'aeff' THEN
SET _mail_origen= fn_mail_x_proyecto(_proy,7) ;
SET _mail_destino = CONCAT(
						 ifnull(fn_mail_x_proyecto(_proy,3), ''), 
						 IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,6) ),''), 
						 IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,2) ),''), 
						 IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,10) ),'') 
					);
	
SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo por parte del Responsable de Area del proyecto ',_proy);
END IF;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo');
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_a_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_a_mf`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20))
BEGIN
DECLARE _mail_destino VARCHAR(200);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
IF _mail_origen = '' THEN
	SET _mail_origen = fn_mail_x_proyecto(_proy,1) ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
END IF; 
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,3),'')  
				) ;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo por parte del ejecutor del proyecto ',_proy);
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_a_mt` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_a_mt`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20))
BEGIN
DECLARE _mail_destino VARCHAR(200);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
IF _mail_origen = '' THEN
	SET _mail_origen = fn_mail_x_proyecto(_proy,1) ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
END IF; 
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,2),'')  
			      ) ;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo por parte del ejecutor del proyecto ',_proy);
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_a_personalizado` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_a_personalizado`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20), IN _tipo INT)
BEGIN
DECLARE _mail_destino VARCHAR(200);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
IF _mail_origen = '' THEN
	SET _mail_origen = fn_mail_x_proyecto(_proy,1) ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
END IF; 
IF _tipo=1 THEN
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,2),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,3) ),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,6) ),''), 
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,7) ),'') 
		
			      ) ;
END IF;
IF _tipo=2 THEN
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,0),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,1) ),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,8) ),'') 
		
			      ) ;
END IF;
IF _tipo=3 THEN
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,6),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,8) ),'') 
		
			      ) ;
END IF;
IF _tipo=4 THEN
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,2),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,3) ),''), 
			IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,7) ),''), 
IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,8) ),''), 
IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,0) ),''), 
IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,1) ),''), 
IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,10) ),'') 
			      ) ;
END IF;
IF _tipo=5 THEN
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,2),''),  
				IFNULL(fn_mail_x_proyecto(_proy,3),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,10) ),'') 
			      ) ;
END IF;
IF _tipo=6 THEN
SET _mail_destino =  fn_mail_x_proyecto(_proy,2);
END IF;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo por parte del ejecutor del proyecto ',_proy);
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mensaje_proy_scp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mensaje_proy_scp`(IN _proy VARCHAR(10), 
			IN _asunto VARCHAR(200) CHARSET utf8,
			IN _mensaje TEXT , 
			IN _firma   VARCHAR(100),
			IN _usr VARCHAR(20))
BEGIN
DECLARE _mail_destino VARCHAR(900);
DECLARE _mail_origen  VARCHAR(30) DEFAULT fn_mail_x_proyecto(_proy,0) ;
DECLARE _mail_admin   VARCHAR(30);
DECLARE _idmsg  BIGINT ;
SELECT mail_admin INTO _mail_admin FROM adm_parametros WHERE idparam=1 ;
IF _mail_origen = '' THEN
	SET _mail_origen = fn_mail_x_proyecto(_proy,1) ;
	IF _mail_origen = '' THEN
		SET _mail_origen = _mail_admin ;
	END IF; 
END IF; 
SET _mail_destino =  CONCAT(
				IFNULL(fn_mail_x_proyecto(_proy,2),''),  
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,3) ),''), 
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,5) ),''), 
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,6) ),''), 
				IFNULL(CONCAT(', ', fn_mail_x_proyecto(_proy,7) ),'') 
			      ) ;
IF _asunto = '' THEN 
	SET _asunto = 'Sistema de Gestión de Proyectos de Fondoempleo' ;
END IF ;  
IF _firma = '' THEN
	SET _firma = 'Sistema de Gestión de Proyectos.';
END IF ;
IF _mensaje = '' THEN
	SET _mensaje = CONCAT('Mensaje enviado automaticamente a Fondoempleo por parte del ejecutor del proyecto ',_proy);
END IF;
SET _mensaje = CONCAT(_mensaje,'<br /><br />',_firma);
SELECT IFNULL(MAX(id_men),0)+1
INTO   _idmsg
FROM adm_mensajes ;
INSERT INTO adm_mensajes 
(	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men,
	est_men
)
VALUES
(	_idmsg, 
	_asunto, 
	_mensaje, 
	_mail_origen, 
	_mail_destino, 
	NOW(), 
	_usr,
	1
);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_menu` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_menu`(
            in _cod   varchar(8),
            in _nom   varchar(50) ,
            IN _link  varchar(250), 
            in _isparent char(1),
            in _parent varchar(10),
            IN _targ   VARCHAR(10),
            in _img    varchar(100),
            in _act    char(1),
            in _ord    int,
            in _mod    char(1))
BEGIN
  DECLARE _msg    varchar(100);
  declare _existe int ;
  declare _rowcount int ;
  declare _class varchar(20);
  
  
  
  select COUNT(1)
  into _existe
  from adm_menus
  where mnu_cod = _cod ;
  
  if _existe > 0 then
    select concat('El Menu ', _nom, ' ya fue registrado...')
    into _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  else
   
   
   select (case when _isparent='1' then 'MenuBarItemSubmenu' else '' end )
   into  _class;
   
    INSERT INTO adm_menus 
    (mnu_cod, 
     mnu_nomb, 
     mnu_apli, 
     mnu_link, 
     mnu_target, 
     mnu_parent, 
     mnu_activo, 
     mnu_class, 
     mnu_sort, 
     mnu_img, 
     mnu_admin
    )
    VALUES
    ( _cod, 
      _nom, 
      1, 
      _link, 
      _targ, 
      _parent, 
      _act, 
      _class, 
      _ord, 
      _img, 
      _mod
    );
    select ROW_COUNT() into _rowcount ;
    
    call sp_ins_menu_pagina(_cod, _nom, _link);
    
    SELECT _rowcount  AS numrows, _cod AS codigo, '' AS msg ;
     
  end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_menu_pagina` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_menu_pagina`(
			IN _mnu   VARCHAR(8),
			IN _nom   VARCHAR(50) ,
			IN _link  VARCHAR(100)
			)
BEGIN
  DECLARE _msg    VARCHAR(100);
  DECLARE _existe INT ;
  DECLARE _id     INT;
  
  SELECT COUNT(1)
  INTO _existe
  FROM adm_menus
  WHERE mnu_cod = _mnu ;
  
  IF _existe <= 0 THEN
    SELECT CONCAT('El Menu [', _mnu, '] No ha sido grabado')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  ELSE
  
  SELECT COUNT(1)
  INTO _existe
  FROM adm_menus_pagina
  WHERE mnu_cod = _mnu
    AND pag_link = _link ;
  
  IF _existe > 0 THEN
    SELECT CONCAT('La Pagina ', _nom, ' ya fue registrado para el menu [',_mnu,']')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  ELSE
   
    SELECT IFNULL(MAX(pag_cod),0) + 1
      INTO  _id
      FROM adm_menus_pagina 
     WHERE mnu_cod=_mnu ; 
   
    INSERT INTO adm_menus_pagina 
	(mnu_cod, 
	 pag_cod,
	 pag_nomb, 
	 pag_link, 
	 flg_act
	)
	VALUES
	( _mnu, 
	  _id,
	  _nom, 
	  _link,
	  '1'
	);
     
    SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
     
   END IF ;
  END IF;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mp_equipa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mp_equipa`(IN _proy varchar(10), 
			in _ver  int,
			in _nom   varchar(100),
			in _um    varchar(30),
			in _cu     double,
			in _cant   double,
			in _monto  DOUBLE,
			in _met    DOUBLE,
			IN _usr varchar(20))
BEGIN
  DECLARE _equi   INT;
    
  SELECT IFNULL(MAX(t03_id_equi),0)+1 INTO _equi 
  FROM 	 t03_mp_equi 
  WHERE  t02_cod_proy = _proy  
    and  t02_version  = _ver ;
 
  INSERT INTO t03_mp_equi 
	(t02_cod_proy, 
	 t02_version, 
	 t03_id_equi, 
	 t03_nom_equi, 
	 t03_um, 
	 t03_cu,
	 t03_cant,
	 t03_costo, 
	 t03_costo_tot, 
	 usr_crea, 
	 fch_crea, 
	 est_audi,
	 t03_mta_proy,
 	 t03_mta_repro
	)
	VALUES
	(_proy, 
	 _ver, 
	 _equi, 
	 _nom,  
	 _um,
	 _cu,
	 _cant,
	 _monto ,
	 (_monto * _met),
	 _usr, 
	 NOW(), 
	'1',
	_met,
	_met
	);

select ROW_COUNT() as numrows, _equi as codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mp_gasfunc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mp_gasfunc`(IN _proy varchar(10), 
			in _ver  int,
			in _part INT,
			in _um   varchar(30),
			in _met  DOUBLE,
			IN _usr varchar(20))
BEGIN
 
 declare _existe int;
 
 select count(1) 
   into _existe
 from t03_mp_gas_fun_part 
 where t02_cod_proy= _proy
   and t02_version = _ver
   and t03_partida = _part;
 
  
  if _existe > 0 then
	SELECT 0 AS numrows, 
	       _part AS codigo, 
	       'La Partida ya ha sido registrada, en este Proyecto' AS error;
  else
	INSERT INTO t03_mp_gas_fun_part 
	(t02_cod_proy, 
	 t02_version, 
	 t03_partida, 
	 t03_um, 
	 t03_meta, 
	 usr_crea, 
	 fch_crea, 
	 est_audi,
	 t03_mta_proy,
     t03_mta_repro
	)
	VALUES
	(_proy, 
	 _ver, 
	 _part, 
	 _um,
	 _met ,
	 _usr, 
	 NOW(), 
	'1',
	_met,
	 _met
	);
	
	select ROW_COUNT() as numrows, _part as codigo, '' as error;
  end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mp_gasfunc_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mp_gasfunc_costeo`(
			IN _proy varchar(10), 
			in _ver  int,
			in _part INT,
			in _gasto varchar(100),
			in _um   varchar(30),
			in _cant DOUBLE,
			in _pu   double,
			in _cate int,
			IN _usr varchar(20))
BEGIN
 
  declare _idgasto int;
  
  select ifnull(max(t03_id_gasto),0) +1
  into _idgasto
  from t03_mp_gas_fun_cost
  where t02_cod_proy=_proy
    and t02_version =_ver
    and t03_partida=_part;
  
  INSERT INTO t03_mp_gas_fun_cost 
	(t02_cod_proy, 
	t02_version, 
	t03_partida, 
	t03_id_gasto, 
	t03_descrip, 
	t03_um, 
	t03_cu, 
	t03_cant, 
	t03_cat_gast, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(
	 _proy, 
	 _ver, 
	 _part, 
	 _idgasto,
	 _gasto,
	 _um,
	 _pu,
	 _cant,
	 _cate ,
	 _usr, 
	 NOW(), 
	'1'
	);
	
	select ROW_COUNT() as numrows, _part as partida, _idgasto AS codigo, '' as error;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_mp_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_mp_personal`(IN _proy varchar(10), 
			in _ver  int,
			in _nom  varchar(100),
			in _tdr  text,
			in _um   int,
			in _dedica double,
			in _remu   DOUBLE,
			in _perma  double,
			in _met    int,
			IN _usr varchar(20))
BEGIN
  DECLARE _idper   INT;
    
  
  SELECT IFNULL(MAX(t03_id_per),0)+1 INTO _idper 
  FROM 	 t03_mp_per 
  WHERE  t02_cod_proy = _proy  
    and  t02_version  = _ver ;
 
  INSERT INTO t03_mp_per 
	(t02_cod_proy, 
	 t02_version, 
	 t03_id_per, 
	 t03_nom_per, 
	 t03_tdr, 
	 t03_um, 
	 t03_dedica, 
	 t03_remu, 
	 t03_perma, 
	 t03_remu_prom,
	 t03_gasto_tot, 
	 usr_crea, 
	 fch_crea, 
	 est_audi,
	 t03_mta_proy,
 	 t03_mta_repro
	)
	VALUES
	(_proy, 
	 _ver, 
	 _idper, 
	 _nom,  
	 _tdr,
	 _um,
	 _dedica,
	 _remu,
	 _perma,
	 fn_remun_prom_mes(_remu, _dedica, _um),
	 ( fn_remun_prom_mes(_remu, _dedica, _um) * _met),
	 _usr, 
	 NOW(), 
	'1',
	_met,
	_met
	);

select ROW_COUNT() as numrows, _idper as codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_noobjecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_noobjecioncompra`(IN _t02_cod_proy	VARCHAR(10) , 
			IN _t02_sco_noc		VARCHAR(10) , 
			IN _com			INT,
			IN _act			INT,
			IN _sub			INT,
			IN _t02_par_noc		INT,
			IN _t02_spa_noc		DOUBLE,  
			IN _t02_imp_noc		DOUBLE,  
			IN _t02_ccp_noc		CHAR(1), 
			IN _t02_cop_noc		CHAR(1), 
			IN _t02_amt_noc		CHAR(1), 
			IN _t02_amf_noc		CHAR(1), 			
			IN _t02_cmf_noc		CHAR(1),
			IN _t02_cmt_noc		CHAR(1), 
			IN _t02_pro_noc		CHAR(1), 
			IN _t02_obs_noc		TEXT,			
			IN _usr 		VARCHAR(20), IN _t02_fch_ped date)
transX : BEGIN
  DECLARE _msg  VARCHAR(100);
  DECLARE _id   INT ;
  DECLARE _estado INT;
   
  IF EXISTS(SELECT t02_cod_proy FROM t02_noobjecion_compra WHERE  t02_cod_proy = _t02_cod_proy AND t02_sco_noc = _t02_sco_noc)  THEN
    SELECT CONCAT('La No Objeción de Compra:', _t02_sco_noc, ' ya fue registrado para el proyecto ','\"',_t02_cod_proy,'\"')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    LEAVE transX ;  
  END IF ;
    
  SELECT IFNULL(MAX(t02_id_noc),0) + 1
    INTO _id 
    FROM  t02_noobjecion_compra 
    WHERE t02_cod_proy = _t02_cod_proy;
  
	 
  INSERT INTO t02_noobjecion_compra 
	(t02_cod_proy, 
	t02_id_noc, 
	t02_sco_noc, 
	t02_com_noc, 
	t02_act_noc, 
	t02_sub_noc, 
	t02_par_noc, 
	t02_spa_noc, 
	t02_imp_noc, 
	t02_ccp_noc, 
	t02_cop_noc, 
	t02_amt_noc, 
	t02_amf_noc, 
	t02_cmf_noc, 
	t02_cmt_noc, 
	t02_pro_noc, 
	t02_obs_noc, 
	usu_crea, 
	fch_crea, 
	est_audi,
	t02_fch_ped
	)
	VALUES
	(
	_t02_cod_proy, 
	_id,  
	 _t02_sco_noc, 
	_com, 
	_act, 
	_sub, 
	_t02_par_noc, 
	_t02_spa_noc, 
	_t02_imp_noc, 
	_t02_ccp_noc, 
	_t02_cop_noc, 
	_t02_amt_noc, 
	_t02_amf_noc, 
	_t02_cmf_noc, 
	_t02_cmt_noc, 
	_t02_pro_noc, 
	_t02_obs_noc, 
	_usr,
	NOW(), 
	'1',
	_t02_fch_ped
	);
 
  SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_noobjecion_compras_anx` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_noobjecion_compras_anx`(IN _proy VARCHAR(10), 
				IN _idnoc INT,
				IN _nom VARCHAR(100),
				IN _desc VARCHAR(5000),
				IN _ext VARCHAR(5),
				IN _usr VARCHAR(20))
BEGIN
DECLARE _url VARCHAR(50);
DECLARE _id INT;
SELECT IFNULL(MAX(anx.t02_cod_anx),0)+1
INTO  _id
FROM t02_noobjecion_compra_anx anx
WHERE    anx.t02_cod_proy=_proy;
      
SELECT CONCAT(_proy,'_',_id,'.', _ext) INTO _url;
INSERT INTO t02_noobjecion_compra_anx 
	(t02_cod_proy, 
	t02_id_noc, 
	t02_cod_anx, 
	t02_nom_file, 
	t02_url_file, 
	t02_desc_file, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(_proy, 
	_idnoc, 
	_id, 
	_nom, 
	_url, 
	_desc, 
	_usr, 
	NOW(), 
	'1'
	);
SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_objecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_objecioncompra`(
			IN _t02_cod_proy 	VARCHAR(10) , 
			IN _t02_sco_co	VARCHAR(10) , 
			IN _t02_par_co	DOUBLE, 
			IN _t02_spa_co	DOUBLE,  
			IN _t02_imp_co	DOUBLE,  
			IN _t02_ccp_co	CHAR(1), 
			IN _t02_cop_co	CHAR(1), 
			IN _t02_amt_co	CHAR(1), 
			IN _t02_amf_co	CHAR(1), 
			IN _t02_rmf_co	CHAR(1), 
			IN _t02_rep_co	CHAR(1), 
			IN _t02_obs_co	TEXT,
			IN _usr VARCHAR(20)
			)
transX : BEGIN
  DECLARE _msg  VARCHAR(100);
  DECLARE _id   INT ;
  DECLARE _estado INT;
  
  IF EXISTS(SELECT _t02_sco_co FROM t02_objecion_compra WHERE  t02_cod_proy = _t02_cod_proy AND t02_sco_co = _t02_sco_co)  THEN
    SELECT CONCAT('La Objeción de Compra:', _num, ' ya fue registrado para el proyecto ','\"',_t02_cod_proy,'\"')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    LEAVE transX ;  
  END IF ;
    
  SELECT IFNULL(MAX(t02_id_noc),0) + 1
    INTO _id 
    FROM  t02_objecion_compra 
    WHERE t02_cod_proy = _t02_cod_proy;
  
  INSERT INTO t02_objecion_compra 
	(t02_cod_proy, 
	t02_id_noc, 
	t02_sco_co, 
	t02_par_co, 
	t02_spa_co, 
	t02_imp_co, 
	t02_ccp_co, 
	t02_cop_co, 
	t02_amt_co, 
	t02_amf_co, 
	t02_rmf_co, 
	t02_rep_co, 
	t02_obs_co, 
	usu_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(_t02_cod_proy, 
	_id, 
	_t02_sco_co, 
	_t02_par_co, 
	_t02_spa_co, 
	_t02_imp_co, 
	_t02_ccp_co, 
	_t02_cop_co, 
	_t02_amt_co, 
	_t02_amf_co, 
	_t02_rmf_co, 
	_t02_rep_co, 
	_t02_obs_co, 
	_usr, 
	NOW(), 
	'1'
	);
 
  SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_perfil`(
			IN _nom    varchar(50), 
			IN _abre   VARCHAR(15),
			IN _usr varchar(20))
BEGIN
  DECLARE _msg    varchar(100);
  declare _existe int ;
  DECLARE _id     int ;
  
  select COUNT(1)
  into _existe
  from adm_perfiles
  where per_des = _nom ;
  
  if _existe > 0 then
    select concat('El Perfil ', _nom, ' ya fue registrado...')
    into _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  else
   
    select IFNULL(max(per_cod),0) + 1
      into _id
      from adm_perfiles ; 
    
    INSERT INTO adm_perfiles 
	(per_cod, 
	 per_des, 
	 per_abrev, 
	 usr_crea, 
	 fch_crea
	)
	VALUES
	(_id, 
	 _nom, 
	 _abre,
	 _usr, 
	 NOW()
	);
     
    SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
     
  end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_plan_capac_tema` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_plan_capac_tema`(IN _proy VARCHAR(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			IN _nomtema VARCHAR(250),
			IN _horas   DOUBLE,
			IN _benef   DOUBLE,			
			IN _usr VARCHAR(20), IN _horas_total double, IN _benef_total double)
trx1 : BEGIN
DECLARE _rowcount INT ;
declare _idtema INT;
DECLARE _nrotemas DOUBLE ;
DECLARE _nrohoras DOUBLE ;
DECLARE _nrobenef DOUBLE ;
select count(1) into _rowcount 
  from t12_plan_capac_tema
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub  
   AND  t12_tem_espe=_nomtema;
if _rowcount > 0 then
    SELECT 0 AS numrows, 0 AS codigo, 'Ya existe un registro con el mismo Nombre' as msg ;  
    leave trx1 ;
end if ;
SELECT ifnull(max(t12_cod_tema),0)+1 INTO _idtema
  FROM t12_plan_capac_tema
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub ;
   insert into t12_plan_capac_tema 
	(t02_cod_proy, 
	t02_version, 
	t08_cod_comp, 
	t09_cod_act, 
	t09_cod_sub, 
	t12_cod_tema, 
	t12_tem_espe, 
	t12_nro_hora, 
	t12_nro_bene, 
	fch_crea, 
	usr_crea, 
	est_audi
	)
	values
	( _proy ,
          _ver ,
	  _comp,
	  _act ,
	  _sub  ,
	  _idtema,
	  _nomtema, 
	  _horas, 
	  _benef, 
	  now(), 
	 _usr, 
	 '1'
	);
    
  SELECT ROW_COUNT() INTO _rowcount ;
   COMMIT ;
   
   SELECT COUNT(t12_cod_tema)
     INTO  _nrotemas
     FROM t12_plan_capac_tema   
    WHERE t02_cod_proy = _proy 
      AND t02_version = _ver 
      AND t08_cod_comp= _comp
      AND t09_cod_act = _act 
      AND t09_cod_sub = _sub ;
    UPDATE t12_plan_capac 
	SET t12_nro_tema = _nrotemas , 
	    t12_hor_cap  = _horas_total , 
	    t12_nro_ben  = _benef_total ,
	    usr_actu     = _usr , 
	    fch_actu     = NOW()
	 WHERE t02_cod_proy = _proy 
	   AND	t02_version = _ver 
	   AND	t08_cod_comp= _comp
	   AND	t09_cod_act = _act 
	   AND	t09_cod_sub = _sub  ;

SELECT _rowcount AS numrows, _idtema AS codigo, '' as msg ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_plan_visita_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_plan_visita_cab`(
			IN _proy VARCHAR(10), 
			IN _fch DATETIME , 
			IN _ter DATETIME , 
			IN _obj text, 
			IN _per text, 
			IN _rec text, 
			IN _usr VARCHAR(20))
BEGIN
  DECLARE _idvta   INT;
  
 
  SELECT IFNULL(MAX(t32_id_vta),0)+1 INTO _idvta 
  FROM 	 t32_plan_vta 
  WHERE  t02_cod_proy	= _proy  ;
 
  
INSERT INTO t32_plan_vta 
	(t02_cod_proy, 
	t32_id_vta, 
	t32_fch_vta, 
	t32_fch_ter,
	t32_obj_vta, 
	t32_per_ent, 
	t32_rec_nec, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	
VALUES
	(_proy, 
	 _idvta,
	 _fch, 
	 _ter,
	 _obj, 
	 _per,  
	 _rec, 
	 _usr, 
	 NOW(), 
	 '1'
	);

SELECT ROW_COUNT() AS numrows, _idvta AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_plan_visita_det` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_plan_visita_det`(
			IN _proy VARCHAR(10), 
			IN _vta INT,
			IN _act INT,
			IN _ini DATETIME , 
			IN _ter DATETIME , 
			IN _esp VARCHAR(1000), 
			IN _usr VARCHAR(20))
BEGIN
  DECLARE _idact   INT;
   
  SELECT IFNULL(MAX(t32_id_act),0)+1 INTO _idact 
  FROM 	 t32_plan_act 
  WHERE  t02_cod_proy	= _proy  
    AND  t32_id_vta = _vta;
  
 
  INSERT INTO t32_plan_act 
	(t02_cod_proy, 
	t32_id_vta,
	t32_id_act,
	t32_cod_act,
	t32_fch_ini,
	t32_fch_ter,
	t32_esp_act,
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(_proy, 
	 _vta,
	 _idact,
	 _act,
	 _ini,
	 _ter,
	 _esp,
	 _usr, 
	 NOW(), 
	 '1'
	);

SELECT ROW_COUNT() AS numrows, _idact AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_plan_visita_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_ins_plan_visita_me`(
			IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _mes INT, 
			IN _obs TEXT, 
			IN _mto1 DOUBLE,
			IN _mto2 DOUBLE,
			IN _fecvis DATETIME,
			IN _fecter DATETIME,
			IN _vb CHAR(1),			
			IN _usr VARCHAR(20))
BEGIN
  DECLARE _id   INT;
  DECLARE _existe  INT;
  DECLARE _error VARCHAR(100);
  
  SELECT IFNULL(MAX(t31_id),0)+1 INTO _id  
  FROM 	 t31_plan_me 
  WHERE  t02_cod_proy	= _proy  ;
  
  SELECT COUNT(t31_id) 
  INTO   _existe
  FROM t31_plan_me
  WHERE t02_cod_proy=_proy
    AND t31_anio = _anio
    AND t31_mes = _mes;
  
  IF _existe =0 THEN
  SELECT '' INTO _error ;
  
  INSERT INTO t31_plan_me 
	( t02_cod_proy, 
	  t31_id, 
	  t31_anio, 
	  t31_mes, 
	  t31_obs, 
	  t31_mto_v1,
	  t31_mto_v2 ,
	  t31_mto_tot ,
	  t31_fec_vis ,
	t31_fec_ter ,
	t31_vb_v1   ,	
	  usr_crea, 
	  fch_crea, 
	  est_audi
	)
	VALUES
	( _proy , 
	  _id   , 
	  _anio , 
	  _mes  , 
	  _obs  , 
	  _mto1,
	  _mto2,
	  (_mto1 + _mto2),
	  _fecvis,
	  _fecter,
	  _vb ,	  
	  _usr, 
	  NOW(),
	'1'
	);
    
    SELECT ROW_COUNT() AS numrows, _id AS codigo, _error AS 'error' ;
   ELSE
    SELECT 'Ya fue Planeado al menos una visita, para este periodo' INTO _error;
    SELECT 0 AS numrows, _id AS codigo, _error AS 'error' ;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_poa_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_poa_anexos`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _nom VARCHAR(100),
				IN _desc VARCHAR(5000),
				IN _ext VARCHAR(5),
				IN _usr VARCHAR(20)
				)
BEGIN
DECLARE _url VARCHAR(50);
DECLARE _id INT;
SELECT IFNULL(MAX(anx.t02_cod_anx),0)+1
INTO   _id
FROM   t02_poa_anexos anx
WHERE  anx.t02_cod_proy = _proy 
  AND  anx.t02_anio     = _anio ;
SELECT CONCAT(_proy,'_',_anio,'_',_id,'.', _ext) INTO _url;
INSERT INTO t02_poa_anexos 
	(t02_cod_proy, 
	t02_anio, 
	t02_cod_anx, 
	t02_nom_file, 
	t02_url_file, 
	t02_desc_file, 
	usr_crea, 
	fch_crea
	)
	VALUES
	( _proy, 
	  _anio, 
	  _id , 
	  _nom , 
	  _url , 
	  _desc, 
	  _usr, 
	  NOW()
	);
SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_proyecto`(IN _t02_nro_exp     VARCHAR(20) ,
                    IN _t00_cod_linea   INT,
                    IN _t01_id_inst     INT,            
                    IN _t02_cod_proy    VARCHAR(10),
                    IN _t02_nom_proy    VARCHAR(250),
                    IN _t02_fch_apro    DATE,
                    IN _t02_estado      INT ,
                    IN _t02_fin     TEXT,
                    IN _t02_pro     TEXT,
                    IN _t02_ben_obj     VARCHAR(5000),
                    IN _t02_amb_geo     VARCHAR(5000),
                    IN _t02_moni_tema   INT,
                    IN _t02_moni_fina   INT,
                    IN _t02_moni_ext    VARCHAR(10),                    
                    IN _t02_sup_inst    INT,
                    IN _t02_dire_proy   VARCHAR(200),
                    IN _t02_ciud_proy   VARCHAR(50),
                    IN _t02_tele_proy    VARCHAR(30),
                    IN _t02_fax_proy    VARCHAR(30),
                    IN _t02_mail_proy   VARCHAR(50),
                    IN _t02_fch_isc     DATE,
                    IN _t02_fch_ire     DATE,
                    IN _t02_fch_tre     DATE,
                    IN _t02_fch_tam     DATE,   
                    IN _t02_num_mes     INT,
                    IN _t02_num_mes_amp INT,
                    
                    IN _t02_cre_fe      CHAR(1),
                    IN _t02_gratificacion       VARCHAR(10),
                    IN _t02_porc_cts        VARCHAR(10),
                    IN _t02_porc_ess        VARCHAR(10),
                    IN _t02_porc_gast_func      VARCHAR(10),
                    IN _t02_porc_linea_base     VARCHAR(10),
                    IN _t02_porc_imprev     VARCHAR(10),
					IN _t02_proc_gast_superv     VARCHAR(10),           
					IN _t02_inst_asoc     TEXT,
                    IN _UserID      VARCHAR(20) )
trans1 : BEGIN                  
    DECLARE _msg        VARCHAR(100);
    DECLARE _existe     INT ;
    DECLARE _vs         INT DEFAULT 1;
    DECLARE _t02_fch_ini    DATE;
    DECLARE _fecha_ter  DATE;
    DECLARE _num_rows   INT ;
    DECLARE _numrows    INT ;
    DECLARE _fcredito   INT DEFAULT 200;
    SELECT COUNT(1)
    INTO _existe
    FROM t02_dg_proy
    WHERE t02_cod_proy=_t02_cod_proy AND t01_id_inst=_t01_id_inst;
    
  IF _existe > 0 THEN
      
    SELECT CONCAT('El proyecto esta registrado por el Supervidor de Proyectos ')
    INTO _msg; 
    SELECT 0 AS numrows,_t02_cod_proy AS codigo, _msg AS msg ;
    
   LEAVE trans1;
  END IF;
   
   
SET AUTOCOMMIT=0;
 START TRANSACTION ;
    
       
    SELECT _t02_fch_ire, (CASE WHEN IFNULL(DATEDIFF(_t02_fch_tre, _t02_fch_tam),0) <> 0 THEN _t02_fch_tam ELSE _t02_fch_tre END)
    INTO _t02_fch_ini, _fecha_ter;
   
   INSERT INTO t02_dg_proy 
    (
    t02_cod_proy, 
    t02_version, 
    t02_nro_exp,
    t00_cod_linea,
    t01_id_inst,    
    t02_nom_proy, 
    t02_fch_apro, 
    t02_fch_ini, 
    t02_fch_ter, 
    t02_fin, 
    t02_pro, 
    t02_ben_obj, 
    t02_amb_geo, 
    t02_moni_tema, 
    t02_moni_fina, 
    t02_moni_ext, 
    t02_sup_inst, 
    t02_dire_proy, 
    t02_ciud_proy, 
    t02_tele_proy, 
    t02_fax_proy, 
    t02_mail_proy, 
    t02_estado, 
    
    t02_cre_fe, 
    t02_fch_isc, 
    t02_fch_ire, 
    t02_fch_tre, 
    t02_fch_tam, 
    t02_num_mes, 
    t02_num_mes_amp,
	t02_inst_asoc,
    usr_crea, 
    fch_crea, 
    est_audi
    )
    VALUES
    (
    _t02_cod_proy, 
    _vs, 
    _t02_nro_exp,
    _t00_cod_linea,
    _t01_id_inst,
    _t02_nom_proy, 
    _t02_fch_apro, 
    _t02_fch_ini, 
    _fecha_ter, 
    _t02_fin, 
    _t02_pro, 
    _t02_ben_obj, 
    _t02_amb_geo, 
    _t02_moni_tema, 
    _t02_moni_fina, 
    _t02_moni_ext, 
    _t02_sup_inst, 
    _t02_dire_proy, 
    _t02_ciud_proy, 
    _t02_tele_proy, 
    _t02_fax_proy, 
    _t02_mail_proy, 
    _t02_estado, 
    
    _t02_cre_fe, 
    _t02_fch_isc, 
    _t02_fch_ire, 
    _t02_fch_tre, 
    _t02_fch_tam, 
    _t02_num_mes, 
    _t02_num_mes_amp,
    _t02_inst_asoc,
    _UserID, 
    NOW(), 
    '1'
    );
    INSERT INTO t02_aprob_proy(t02_cod_proy, usu_crea, fch_crea) VALUES (_t02_cod_proy,_UserID, NOW());
    
    INSERT INTO t02_tasas_proy (t02_cod_proy, t02_version, t02_gratificacion, t02_porc_cts, t02_porc_ess, 
            t02_porc_gast_func, t02_porc_linea_base, t02_porc_imprev, t02_proc_gast_superv ,usr_crea, fch_crea ) 
        VALUES ( _t02_cod_proy, _vs, _t02_gratificacion, _t02_porc_cts, _t02_porc_ess, 
            _t02_porc_gast_func, _t02_porc_linea_base, _t02_porc_imprev, _t02_proc_gast_superv, _UserID, now() );
    
    SELECT ROW_COUNT() INTO _num_rows;
    
    CALL sp_calcula_anios_proy(_t02_cod_proy, _vs);
    
   
    
    CALL sp_ins_fte_fin(_t02_cod_proy,'10','0','','0',_UserID,NOW());
    CALL sp_ins_fte_fin(_t02_cod_proy,'63','0','','0',_UserID,NOW());
    CALL sp_ins_fte_fin(_t02_cod_proy,_t01_id_inst,'0','','0',_UserID,NOW());
    
    IF _t02_cre_fe='S' THEN 
        CALL sp_ins_fte_fin(_t02_cod_proy,_fcredito,'0','','0',_UserID,NOW());
    END IF; 
    
    SELECT ROW_COUNT() INTO _numrows;
  COMMIT ;
    
    SELECT _numrows  AS numrows, _cod_proy AS codigo, _msg AS msg ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_proy_anx` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_proy_anx`(IN _proy VARCHAR(10), 
IN _ver INT,
IN _nom VARCHAR(100),
IN _desc VARCHAR(5000),
IN _ext VARCHAR(5),
IN _tanx VARCHAR(3),
IN _usr VARCHAR(20))
BEGIN
DECLARE _url VARCHAR(50);
DECLARE _id INT;
SELECT IFNULL(MAX(anx.t02_cod_anx),0)+1
INTO   _id
FROM t02_proy_anx anx
WHERE    anx.t02_cod_proy=_proy 
      AND  anx.t02_version =_ver ;
SELECT CONCAT(_proy,'_',_ver,'_',_id,'.', _ext) INTO _url;
INSERT INTO t02_proy_anx 
	(t02_cod_proy, 
	t02_version, 
	t02_cod_anx, 
	t02_nom_file, 
	t02_url_file, 
	t02_desc_file, 
	t02_anx_tip_cod, 
	usr_crea, 
	fch_crea
	)
	VALUES
	( _proy, 
	  _ver, 
	  _id , 
	  _nom , 
	  _url , 
	  _desc, 
	  _tanx,
	  _usr, 
	  NOW()
	);
SELECT ROW_COUNT() AS numrows, _id AS codigo, _url AS url ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_resp_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_resp_inst`(IN pIdInst INT, IN pIdCont INT, IN pIdUser VARCHAR(20))
BEGIN

	DECLARE _numrows INT;

	UPDATE t01_dir_inst SET est_audi = 1 WHERE t01_id_inst= pIdInst;

	UPDATE t01_inst_cto
	SET t01_rep_flg = '1', usr_actu = pIdUser, fch_actu = NOW() 
	WHERE t01_id_inst = pIdInst
	AND	t01_id_cto = pIdCont;

	SELECT ROW_COUNT() INTO _numrows;
	COMMIT;
	SELECT _numrows AS numrows, pIdUser AS codigo, '' AS msg ;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_sector_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_sector_prod`(
            IN _proy VARCHAR(10), 
            IN _sectmain INT, 
            IN _sect INT, 
            IN _subs INT, 
            IN _obs  TEXT, 
            IN _usr VARCHAR(20))
BEGIN
  DECLARE _existe  INT;
  DECLARE _error VARCHAR(100);
  
  SELECT COUNT(t02_sector) 
  INTO   _existe
  FROM t02_sector_prod
  WHERE t02_cod_proy  = _proy
    AND t02_sector_main    = _sectmain
    AND t02_sector    = _sect
    AND t02_subsec    = _subs;
  
  IF _existe =0 THEN
  SELECT '' INTO _error ;
  
  INSERT INTO t02_sector_prod 
    ( t02_cod_proy, 
      t02_sector_main, 
      t02_sector, 
      t02_subsec, 
      t02_obs, 
      usr_crea, 
      fch_crea, 
      est_audi
    )
    VALUES
    ( _proy , 
      _sectmain , 
      _sect   , 
      _subs  , 
      _obs  , 
      _usr, 
      NOW(),
    '1'
    );
    
    SELECT ROW_COUNT() AS numrows, _subs AS codigo, _error AS 'error' ;
   ELSE
    SELECT 'Ya fue registrado el Sector Productivo para este Proyecto' INTO _error;
    SELECT 0 AS numrows, _subs AS codigo, _error AS 'error' ;
   END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_tablasaux` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_tablasaux`(
			in _nom    varchar(100) ,
			IN _abrev  varchar(15), 
			in _ext    varchar(20),
			in _tabla  int,
			IN _ord    INT,
			in _act    char(1),
			in _usu    varchar(20))
BEGIN
  DECLARE _msg    varchar(100);
  declare _existe   int ;
  declare _rowcount int ;
  declare _cod      int;
  
  
  
  select COUNT(1)
  into _existe
  from adm_tablas_aux
  where descrip = _nom  
    and idTabla = _tabla;
  
  if _existe > 0 then
    select concat('El Tipo ', _nom, ' ya fue registrado para esta Tabla Auxiliar ')
    into _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  else
   
    select IFNULL(max(codi),0) + 1
      into _cod
      from adm_tablas_aux ; 
      
    INSERT INTO adm_tablas_aux 
	(codi, 
	 descrip, 
	 abrev, 
	 cod_ext, 
	 flg_act, 
	 idTabla, 
	 orden, 
	 usu_crea, 
	 fec_crea
	)
	VALUES
	(_cod, 
	 _nom, 
	_abrev, 
	_ext, 
	_act, 
	_tabla, 
	_ord, 
	_usu, 
	now()
	);
    select ROW_COUNT() into _rowcount ;
    SELECT _rowcount  AS numrows, _cod AS codigo, '' AS msg ;
     
  end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_tablasaux2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_tablasaux2`(
			in _nom    varchar(100) ,
			IN _abrev  varchar(15), 
			in _ext    varchar(20),
			in _tabla  int,
			IN _aux    INT,
			IN _ord    INT,
			in _act    char(1),
			in _usu    varchar(20))
BEGIN
  DECLARE _msg    varchar(100);
  declare _existe   int ;
  declare _rowcount int ;
  declare _cod      int;
  
  
  
  select COUNT(1)
  into _existe
  from adm_tablas_aux2
  where descrip = _nom  
    and id_tabla_aux = _aux ;
  
  if _existe > 0 then
    select concat('El SubTipo ', _nom, ' ya fue registrado para este Tipo ')
    into _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  else
   
    select IFNULL(max(codi),0) + 1
      into _cod
      from adm_tablas_aux2 ; 
      
    INSERT INTO adm_tablas_aux2 
	(codi, 
	 descrip, 
	 abrev, 
	 cod_ext, 
	 flg_act, 
	 idTabla, 
	 id_tabla_aux,
	 orden, 
	 usu_crea, 
	 fec_crea
	)
	VALUES
	(_cod, 
	 _nom, 
	_abrev, 
	_ext, 
	_act, 
	_tabla,
	_aux, 
	_ord, 
	_usu, 
	now()
	);
    select ROW_COUNT() into _rowcount ;
    SELECT _rowcount  AS numrows, _cod AS codigo, '' AS msg ;
     
  end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ins_usuarios` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ins_usuarios`(
			IN _usu    varchar(20), 
			IN _pwd    VARCHAR(20) ,
			IN _nomusu varchar(100), 
			in _mail   VARCHAR(100),
			IN _perfil INT, 
			in _inst   VARCHAR(10),
			in _proy   varchar(10),
			IN _estado INT,
			IN _usr varchar(20))
BEGIN
  DECLARE _msg   varchar(100);
  declare _existe int ;
  
  
  select COUNT(1)
  into _existe
  from adm_usuarios
  where coduser = _usu ;
  
  if _existe > 0 then
    select concat('El Usuario ', _usu, ' ya fue registrado...')
    into _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  else
   
    
    
    REPLACE INTO adm_md5_pwd(codigo, codigomd5) 
                      VALUES(_pwd  , MD5(_pwd));    
    
    INSERT INTO adm_usuarios 
	(coduser, 
	tipo_user, 
	nom_user, 
	clave_user, 
	mail, 
	t01_id_uni, 
	t02_cod_proy, 
	estado, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	(_usu, 
	 _perfil, 
	 _nomusu, 
	 md5(_pwd), 
	 _mail,
	 _inst, 
	 _proy, 
	 _estado, 
	 _usr, 
	 NOW(), 
	 '1'
	);
     
    SELECT ROW_COUNT() AS numrows, _usu AS codigo, '' AS msg ;
     
  end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_linea_base_recalcular` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_linea_base_recalcular`(  
                        IN _proy VARCHAR(10), 
                        IN _ver INT,
                        IN _inst INT,
                        IN _usr VARCHAR(20))
BEGIN
    IF _ver = 1 THEN
        UPDATE t03_mp_linea_base 
        SET t03_monto = fn_linea_base_anual(_proy, _inst, t02_version - 1), usr_actu = _usr, fch_actu = NOW() 
        WHERE t02_cod_proy = _proy AND t02_version <> 1;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_list_beneficiarios` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_list_beneficiarios`(IN _proy VARCHAR(10))
BEGIN
	SELECT t11_bco_bene.t11_cod_bene, t11_bco_bene.t02_cod_proy, t11_bco_bene.t11_dni, CONCAT(t11_bco_bene.t11_ape_pat, ' ', t11_bco_bene.t11_ape_mat, ', ', t11_bco_bene.t11_nom ) as nombres, 
		t11_bco_bene.t11_sexo, t11_bco_bene.t11_edad, t11_bco_bene.t11_nivel_educ, t11_bco_bene.t11_especialidad,
		DATE_FORMAT(t11_bco_bene.t11_fec_ini,'%d/%m/%Y') as t11_fec_ini, 
		DATE_FORMAT(t11_bco_bene.t11_fec_ter,'%d/%m/%Y') as t11_fec_ter, 
		t11_bco_bene.t11_sec_prod,t11_bco_bene.t11_subsector,t11_bco_bene.t11_unid_prod_1,t11_bco_bene.t11_nro_up_b,t11_bco_bene.t11_sec_prod_2,t11_bco_bene.t11_subsec_prod_2,t11_bco_bene.t11_tot_unid_prod,t11_bco_bene.t11_tot_unid_prod_2,t11_bco_bene.t11_unid_prod_2,t11_bco_bene.t11_nro_up_b_2,t11_bco_bene.t11_sec_prod_3, t11_bco_bene.t11_subsec_prod_3, t11_bco_bene.t11_unid_prod_3, t11_bco_bene.t11_tot_unid_prod_3, t11_bco_bene.t11_nro_up_b_3,t11_bco_bene.t11_nom_prod, 
		t11_bco_bene.t11_direccion, t11_bco_bene.t11_ciudad, t11_bco_bene.t11_telefono, t11_bco_bene.t11_celular, t11_bco_bene.t11_mail, t11_bco_bene.t11_estado, t11_bco_bene.usr_crea, t11_bco_bene.fch_crea, t11_bco_bene.usr_actu, t11_bco_bene.fch_actu, t11_bco_bene.est_audi , u.nom_ubig
		FROM t11_bco_bene 
		INNER JOIN adm_ubigeo u ON (u.cod_dpto = t11_bco_bene.t11_dpto  AND u.cod_prov = '00' AND u.cod_dist = '00')
		WHERE t02_cod_proy = _proy ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_list_institucion_all` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_list_institucion_all`()
BEGIN
	SELECT
  Inst.t01_id_inst, 
  Inst.t01_ruc_inst, 
  Inst.t01_sig_inst, 
  Inst.t01_nom_inst, 
  DATE_FORMAT(Inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
  FORMAT(Inst.t01_pres_anio,2) AS presup, 
  fn_verifica_url(Inst.t01_web_inst) AS t01_web_inst, 
  tipInst.descrip AS t01_tipo_inst
FROM      t01_dir_inst Inst
LEFT JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_anios_concurso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_anios_concurso`(in _concurso varchar(5))
BEGIN
SELECT DISTINCT t02_anio as codigo,
	concat('Año',' ',t02_anio) as descripcion
FROM t02_duracion
WHERE SUBSTRING(t02_cod_proy,3,2)=_concurso
ORDER BY t02_anio ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_aprueba_desembolso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_aprueba_desembolso`(IN _fte INT ,
				               IN _con VARCHAR(5),
				               IN _eje VARCHAR(5),
				               in _proy varchar(10))
BEGIN
DECLARE _est_aprobado_mt INT DEFAULT 135 ;
SELECT 	w.t01_id_inst,
	w.t01_sig_inst,
	w.t02_cod_proy,
	w.t02_nom_proy,
	w.nomconcurso,
	w.t01_ruc_inst,
	DATE_FORMAT(w.t02_fch_isc,'%d/%m/%Y') AS t02_fch_isc,
	DATE_FORMAT(w.t02_fch_ini,'%d/%m/%Y') AS t02_fch_ini,
	DATE_FORMAT(w.t02_fch_tsc,'%d/%m/%Y') AS t02_fch_tsc,
	DATE_FORMAT(w.t02_fch_ire,'%d/%m/%Y') AS t02_fch_ire,
	DATE_FORMAT(w.t02_fch_tre,'%d/%m/%Y') AS t02_fch_tre,
	DATE_FORMAT(w.t02_fch_tam,'%d/%m/%Y') AS t02_fch_tam,
	w.estado,
	w.duracion_trim,
	w.moni_tema ,
	w.moni_fina ,
	w.trim_ejecucion,
	w.trim_desembolsar,
	w.total_aporte_fe,
	w.total_desembolsado,
	w.monto_desembolsar ,
	(SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy= w.t02_cod_proy
	       and gas.t41_fte_finan = _fte
	      
	) as total_ejecutado,
	
	(
	  select t40_exc 
	    from t40_inf_financ 
	   where t02_cod_proy=w.t02_cod_proy 
	     and t40_est_eje = _est_aprobado_mt
	    order  by fn_numero_mes(t40_anio,t40_mes) desc
	    limit 1
	     
	) AS excedente_ejecutar,
	
	fn_monto_desembolso_trimestral(
					w.t02_cod_proy,
					1, 
					_fte, 
					fn_numero_trim_rev(w.trim_desembolsar,1), 
					fn_numero_trim_rev(w.trim_desembolsar,2) 
					) AS monto_plan_trim,
					
	fn_monto_desembolsado_periodo(w.t02_cod_proy, w.trim_desembolsar -1, w.trim_desembolsar-1 ) AS ultimo_desembolso,
	
	EXISTS(SELECT f.t40_fch_pre 
		 FROM t40_inf_financ f 
		WHERE f.t02_cod_proy=w.t02_cod_proy 
		  AND (fn_numero_mes(f.t40_anio, f.t40_mes)/3) = w.trim_desembolsar
			AND f.t40_est_eje = _est_aprobado_mt 
	       ) AS inf_financ,
      
	EXISTS(SELECT f.t20_fch_pre 
		 FROM t20_inf_mes f 
		WHERE f.t02_cod_proy=w.t02_cod_proy 
		 AND fn_numero_mes(f.t20_anio, f.t20_mes) BETWEEN (w.trim_desembolsar * 3 ) -2 AND (w.trim_desembolsar * 3 )-1
		  AND f.t20_estado = _est_aprobado_mt 
	       ) AS inf_mes,
	       
	EXISTS(SELECT f.t25_fch_pre 
		 FROM t25_inf_trim f 
		WHERE f.t02_cod_proy=w.t02_cod_proy 
		  
		  AND fn_numero_mes(f.t25_anio, (f.t25_trim*3)) = w.trim_desembolsar * 3
		  AND f.t25_estado = _est_aprobado_mt 
	       ) AS inf_trim,	
       
	EXISTS(SELECT cf.t02_id_cf
		 FROM t02_carta_fianza cf 
		WHERE cf.t02_cod_proy=w.t02_cod_proy 
		  AND cf.t02_est_cf = 1 
		  AND cf.t02_vb_adm = 1 
	       ) AS cartafianza
	
FROM (
	SELECT 	proy.t01_id_inst,
		ejec.t01_sig_inst,
		proy.t02_cod_proy,
		proy.t02_nom_proy,
		con.abr_conc AS nomconcurso,
		con.num_conc AS concurso,
		ejec.t01_ruc_inst,
		proy.t02_fch_isc,
		proy.t02_fch_ini,
		DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
		proy.t02_fch_ire,
		proy.t02_fch_tre,
		proy.t02_fch_tam,
		est.descrip AS estado,
		est.cod_ext AS codestado,
		TRUNCATE((proy.t02_num_mes / 3),0) AS duracion_trim,
		CONCAT( mt.t90_ape_pat ,' ', mt.t90_ape_mat ,', ', mt.t90_nom_equi ) AS  moni_tema ,
		CONCAT( mf.t90_ape_pat ,' ', mf.t90_ape_mat ,', ', mf.t90_nom_equi ) AS  moni_fina ,
		TRUNCATE( ((DATEDIFF(NOW(), proy.t02_fch_ini ) / 30)/3),0) AS trim_ejecucion,
		IFNULL(
			(SELECT MAX(desemb.t60_id_trim) 
			   FROM t60_ejecucion_desemb desemb 
			  WHERE desemb.t02_cod_proy = proy.t02_cod_proy)
			,0)+1 trim_desembolsar,
		fn_total_aporte_fuentes_financ3(proy.t02_cod_proy,1,_fte) AS total_aporte_fe,
		fn_monto_desembolsado_periodo(proy.t02_cod_proy,1, TRUNCATE((proy.t02_num_mes / 3),0) ) AS total_desembolsado,
		(0) AS monto_desembolsar
	FROM       t02_dg_proy  proy
	LEFT JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
	LEFT JOIN adm_concursos  con ON (SUBSTRING(proy.t02_cod_proy,3,2) = con.num_conc)
	LEFT JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
	LEFT  JOIN  t90_equi_fe  mt  ON( proy.t02_moni_tema  =  mt.t90_id_equi ) 
	LEFT  JOIN  t90_equi_fe  mf  ON( proy.t02_moni_fina  =  mf.t90_id_equi ) 
	WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy) 
	  and proy.t02_cod_proy = (case when _proy= '' then proy.t02_cod_proy else _proy end)
     ) AS w 
WHERE (trim_ejecucion - duracion_trim) <=1    
  AND total_aporte_fe > 0 
  AND w.concurso = (CASE WHEN _con = '*' THEN w.concurso ELSE _con END ) 
  AND w.t01_id_inst = (CASE WHEN _eje = '*' THEN w.t01_id_inst ELSE _eje END ) 
  and w.trim_desembolsar >=2 ;
  
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_aprueba_desembolso2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_aprueba_desembolso2`(IN _fte INT ,
				               IN _con VARCHAR(5),
				               IN _eje VARCHAR(5),
				               IN _proy VARCHAR(10))
BEGIN
	DECLARE _est_aprobado_mt INT DEFAULT 135 ;
	SELECT	w.t01_id_inst,
		w.t01_sig_inst,
		w.t02_cod_proy,
		w.t02_nom_proy,
		DATE_FORMAT(w.t02_fch_ini,'%d/%m/%Y') AS t02_fch_ini,
		DATE_FORMAT(w.t02_fch_tre,'%d/%m/%Y') AS t02_fch_tre,
		w.moni_fina ,
		w.trim_ejecucion,
		w.trim_desembolsar,
		w.total_aporte_fe,
		w.total_desembolsado,
		(SELECT SUM(gas.t41_gasto) 
			FROM  t41_inf_financ_gasto gas 
			WHERE gas.t02_cod_proy= w.t02_cod_proy
				AND gas.t41_fte_finan = _fte
		) AS total_ejecutado,
		(SELECT t40_exc 
			FROM t40_inf_financ 
			WHERE t02_cod_proy=w.t02_cod_proy 
				AND t40_est_eje = _est_aprobado_mt
			ORDER BY fn_numero_mes(t40_anio,t40_mes) DESC
			LIMIT 1
		) AS excedente_ejecutar,
		fn_monto_desembolso_trimestral(	w.t02_cod_proy,
										1, 
										_fte, 
										fn_numero_trim_rev(w.trim_desembolsar,1), 
										fn_numero_trim_rev(w.trim_desembolsar,2) 
										) AS monto_plan_trim,
										
		fn_monto_desembolsado_periodo(	w.t02_cod_proy, 
										w.trim_desembolsar -1, 
										w.trim_desembolsar-1 ) AS ultimo_desembolso,
										
		IFNULL((SELECT	SUM(t1.t60_mto_desemb)
		FROM	t60_aprobacion_desemb t1
		WHERE	t1.t02_cod_proy = w.t02_cod_proy
			AND	t1.t60_anio = fn_numero_trim_rev(w.trim_desembolsar, 1)
			AND t1.t60_trim = fn_numero_trim_rev(w.trim_desembolsar, 2)
		GROUP BY t1.t60_id_aprob), 0) AS mto_desembolsado,
						
		EXISTS(SELECT f.t40_fch_pre 
				FROM t40_inf_financ f 
				WHERE f.t02_cod_proy=w.t02_cod_proy 
					AND (fn_numero_mes(f.t40_anio, f.t40_mes)/3) = w.trim_desembolsar
					AND f.t40_est_eje = _est_aprobado_mt 
		) AS inf_financ,
		EXISTS(SELECT f.t20_fch_pre 
				FROM t20_inf_mes f 
				WHERE f.t02_cod_proy=w.t02_cod_proy 
					AND fn_numero_mes(f.t20_anio, f.t20_mes) BETWEEN (w.trim_desembolsar * 3 ) -2 AND (w.trim_desembolsar * 3 )-1
					AND f.t20_estado = _est_aprobado_mt 
		) AS inf_mes,
		EXISTS(SELECT f.t25_fch_pre 
				FROM t25_inf_trim f 
				WHERE f.t02_cod_proy=w.t02_cod_proy 
					AND fn_numero_mes(f.t25_anio, (f.t25_trim*3)) = w.trim_desembolsar * 3
					AND f.t25_estado = _est_aprobado_mt 
		) AS inf_trim,	
		EXISTS(SELECT cf.t02_id_cf
				FROM t02_carta_fianza cf 
				WHERE cf.t02_cod_proy=w.t02_cod_proy 
					AND cf.t02_est_cf = 1 
					AND cf.t02_vb_adm = 1 
		) AS cartafianza
	FROM (
		SELECT	proy.t01_id_inst,
					ejec.t01_sig_inst,
					proy.t02_cod_proy,
					proy.t02_nom_proy,
					proy.t02_fch_ini,
					proy.t02_fch_tre,
					TRUNCATE((proy.t02_num_mes / 3),0) AS duracion_trim,
					CONCAT( mf.t90_ape_pat ,' ', mf.t90_ape_mat ,', ', mf.t90_nom_equi ) AS  moni_fina ,
					TRUNCATE( ((DATEDIFF(NOW(), proy.t02_fch_ini ) / 30)/3),0) AS trim_ejecucion,
					CASE WHEN ejectrim.t60_mto_desemb >= ejectrim.t60_mto_plan THEN
						ejectrim.t60_id_trim + 1
					ELSE
						ejectrim.t60_id_trim
					END AS trim_desembolsar,
					fn_total_aporte_fuentes_financ3(proy.t02_cod_proy,1,_fte) AS total_aporte_fe,
					fn_monto_desembolsado_periodo(proy.t02_cod_proy,1, TRUNCATE((proy.t02_num_mes / 3),0) ) AS total_desembolsado
		FROM       t02_dg_proy  proy
		LEFT JOIN	(
		
					SELECT	t1.t02_cod_proy,
							t1.t60_id_trim,
							IFNULL(t2.t60_mto_plan, 0) AS t60_mto_plan,
							IFNULL(t2.t60_mto_desemb, 0) AS t60_mto_desemb
					FROM	(SELECT t02_cod_proy, MAX(t60_id_trim) AS t60_id_trim
							FROM t60_ejecucion_desemb
							GROUP BY  t02_cod_proy) t1 
					LEFT JOIN t60_aprobacion_desemb t2 
								ON (t1.t02_cod_proy = t2.t02_cod_proy AND
									fn_numero_trim(t2.t60_anio, t2.t60_trim) = t1.t60_id_trim)					
					
					) ejectrim ON (ejectrim.t02_cod_proy = proy.t02_cod_proy)
		LEFT JOIN	t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
		LEFT JOIN	t90_equi_fe  mf  ON( proy.t02_moni_fina  =  mf.t90_id_equi ) 
		WHERE 	proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy) 
			AND proy.t02_cod_proy = (CASE WHEN _proy= '' THEN proy.t02_cod_proy ELSE _proy END)
			AND SUBSTRING(proy.t02_cod_proy,3,2) = (CASE WHEN _con='*' THEN SUBSTRING(proy.t02_cod_proy,3,2) ELSE _con END)
		) AS w 
	WHERE (trim_ejecucion - duracion_trim) <= 1    
		AND total_aporte_fe > 0 
		AND w.t01_id_inst = (CASE WHEN _eje = '*' THEN w.t01_id_inst ELSE _eje END ) 
		AND w.trim_desembolsar >= 2 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_aprueba_primer_desembolso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_aprueba_primer_desembolso`(IN _con VARCHAR(5),
				                     IN _eje VARCHAR(5),
				                     in _proy varchar(10))
BEGIN
SELECT  w.*,
	fn_monto_desembolsado_periodo(w.t02_cod_proy,1, 1 ) AS total_desembolsado,
	EXISTS(SELECT cf.t02_id_cf
		 FROM t02_carta_fianza cf 
		WHERE cf.t02_cod_proy=w.t02_cod_proy 
		  AND cf.t02_est_cf = 1 
		  AND cf.t02_vb_adm = 1 
	       ) AS cartafianza,
	       
	EXISTS(SELECT cta.t01_id_cta
		 FROM t02_proy_ctas cta 
		WHERE cta.t02_cod_proy=w.t02_cod_proy 
	       ) AS ctabancaria,
	       
	( case when ifnull(w.t02_fch_apro,0)=0 then '0' else '1' end ) AS conv_firma       
	
FROM (
	SELECT 	proy.t01_id_inst,
		ejec.t01_sig_inst,
		proy.t02_cod_proy,
		proy.t02_nom_proy,
		con.abr_conc AS nomconcurso,
		con.num_conc AS concurso,
		ejec.t01_ruc_inst,
		proy.t02_fch_apro,
		DATE_FORMAT(proy.t02_fch_ini,'%d/%m/%Y') as t02_fch_ini,
		DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
		proy.t02_fch_ire,
		DATE_FORMAT(proy.t02_fch_tre,'%d/%m/%Y') AS t02_fch_tre,
		proy.t02_fch_tam,
		est.descrip AS estado,
		est.cod_ext AS codestado,
		TRUNCATE((proy.t02_num_mes / 3),0) AS duracion_trim,
		CONCAT( mt.t90_ape_pat ,' ', mt.t90_ape_mat ,', ', mt.t90_nom_equi ) AS  moni_tema ,
		CONCAT( mf.t90_ape_pat ,' ', mf.t90_ape_mat ,', ', mf.t90_nom_equi ) AS  moni_fina ,
		1 AS trim_desembolsar,
		fn_total_aporte_fuentes_financ3(proy.t02_cod_proy,1,10) AS total_aporte_fe,
		fn_monto_desembolso_trimestral(proy.t02_cod_proy, 1, 10, 1, 1 ) AS monto_plan_trim,
		apb.t59_conv_firma AS conv_firma,
		apb.t59_otros_docum as otros_docum,
		apb.t59_is_desemb,
		apb.t59_id_aprob
	FROM       t02_dg_proy  proy
	LEFT JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
	LEFT JOIN adm_concursos  con ON (SUBSTRING(proy.t02_cod_proy,3,2) = con.num_conc)
	LEFT JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
	LEFT  JOIN  t90_equi_fe  mt  ON( proy.t02_moni_tema  =  mt.t90_id_equi ) 
	LEFT  JOIN  t90_equi_fe  mf  ON( proy.t02_moni_fina  =  mf.t90_id_equi ) 
	left  join  t59_aprob_primer_desemb apb on (proy.t02_cod_proy=apb.t02_cod_proy)
	WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy) 
	  AND proy.t02_cod_proy = (CASE WHEN _proy= '' THEN proy.t02_cod_proy ELSE _proy END)
	  AND con.num_conc = (CASE WHEN _con = '*' THEN con.num_conc ELSE _con END ) 
          AND proy.t01_id_inst = (CASE WHEN _eje = '*' THEN proy.t01_id_inst ELSE _eje END )  
	) AS w
WHERE w.codestado IN (0,1,5)	
  AND w.total_aporte_fe > 0
  AND w.monto_plan_trim > 0 
  and IFNULL(w.t59_is_desemb,'0') = '0' 
ORDER BY w.t02_cod_proy ASC   ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_at`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
select 	COUNT(*) AS total
from  t12_plan_at 
where t02_cod_proy = _proy
  and t02_version  = _ver
order by t12_conten ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_autoriza_cheque_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_autoriza_cheque_me`(  IN _con VARCHAR(5),
				               IN _eje VARCHAR(5),
				               in _proy varchar(10)
				            )
BEGIN
DECLARE _est_aprobado_mt INT DEFAULT 135 ;
SELECT 	proy.codigo,
	proy.titulo,
	proy.codinst AS inst_eje,
	proy.siglas  AS inst_eje_sig,
	proy.cod_me,
	proy.moni_exte,
	proy.moni_tema,
	moni.t01_id_inst AS inst_moni,
	moni.t01_sig_inst AS inst_moni_sig,
	moni.t01_ruc_inst AS inst_moni_ruc,
	(select count(1) from t31_plan_me m where m.t02_cod_proy=proy.codigo) as nro_visitas,
	fn_costo_visita_me(proy.codigo,0) AS costo_tot_visita,
	
	ext.t31_id       AS nro_visita_ejec,
	
	
	apr1.t31_vb as visita01_vb,
	apr1.t31_mto_aprob as importe_visita01,
	fn_monto_desembolsado_me_visita(proy.codigo, ext.t31_id, 1) as desembolso_01,
	(select max(d.t60_fch_depo) from t60_ejecucion_desemb_me d where d.t02_cod_proy=proy.codigo and d.t60_id_visita=ext.t31_id and d.t60_id_nropago=apr1.t31_id_aprob) as fecha_desemb01,
	
	apr2.t31_vb AS visita02_vb,
	apr2.t31_mto_aprob AS importe_visita02,
	fn_monto_desembolsado_me_visita(proy.codigo, ext.t31_id, 2) AS desembolso_02,
	(SELECT MAX(d.t60_fch_depo) FROM t60_ejecucion_desemb_me d WHERE d.t02_cod_proy=proy.codigo AND d.t60_id_visita=ext.t31_id AND d.t60_id_nropago=apr2.t31_id_aprob) AS fecha_desemb02
	,apr2.*
  FROM v_matriz_proyectos proy 
LEFT JOIN t01_dir_inst    moni ON ( SUBSTRING_INDEX(proy.cod_me,'.',1)= moni.t01_id_inst )
LEFT JOIN t31_plan_me     ext  ON ( proy.codigo = ext.t02_cod_proy AND ext.t31_id=fn_nro_visita_me_por_ejecutar(proy.codigo) )
left join t31_plan_me_aprob apr1 on ( proy.codigo = apr1.t02_cod_proy AND ext.t31_id=apr1.t31_id and apr1.t31_id_aprob=1)
left join t31_plan_me_aprob apr2 ON ( proy.codigo = apr2.t02_cod_proy AND ext.t31_id=apr2.t31_id AND apr2.t31_id_aprob=2)
  WHERE 
	proy.concurso = (CASE WHEN _con = '*' THEN proy.concurso ELSE _con END ) 
    AND moni.t01_id_inst = (CASE WHEN _eje = '*' THEN moni.t01_id_inst ELSE _eje END ) 
    and proy.codigo = (CASE WHEN _proy = '*' THEN proy.codigo ELSE _proy END ) 
    
    and concat(apr1.t31_tot_desemb, ifnull( apr2.t31_tot_desemb,'0')) in('00','10');
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_bene_ubigeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_bene_ubigeo`(  IN _proy VARCHAR(10) ,
				        IN _dpto CHAR(2),
				        IN _prov CHAR(2),
				        IN _dist CHAR(2),
					in _case CHAR(2)
				 )
BEGIN
select  ben.t11_cod_bene, 
	ben.t11_dni, 
	concat(ben.t11_ape_pat, ' ' ,ben.t11_ape_mat, ', ', ben.t11_nom) as nombres, 
	sex.descrip as sexo, 
	ben.t11_edad, 
	niv.descrip as nivel, 
	sec.descrip as sector, 
	ben.t11_tot_unid_prod, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	ben.t11_act_princ, 
	est.descrip as estado, 
	ben.t11_obs
from 	  t11_bco_bene ben 
left join adm_tablas_aux sex on (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
where 
      ben.t02_cod_proy = _proy
  and ben.t11_dpto     = _dpto
  AND ben.t11_prov     = (CASE WHEN _prov='' THEN ben.t11_prov ELSE _prov END  )
  AND IFNULL(ben.t11_dist,'')      = (case when (_dist='' or _dist='00') then ben.t11_dist else _dist end  )
  AND ifnull(ben.t11_case,'')     = (CASE WHEN (_case ='' or _case='00') THEN ifnull(ben.t11_case,'') ELSE _case  END  )
oRDER BY nombres asc;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_carg_cto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_carg_cto`()
BEGIN
	(SELECT 	
		DISTINCT t.descrip AS cargo, 
		cto.t01_cgo_cto as idcargo
	FROM t01_inst_cto cto
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=cto.t01_id_inst)
	WHERE t.descrip <> ""
	ORDER BY nombres)
	UNION
	(SELECT DISTINCT
		t.descrip AS cargo, 
		p.t04_carg_equi as idcargo
	FROM t04_equi_proy p
	LEFT JOIN adm_tablas_aux t ON (p.t04_carg_equi=t.codi)
	WHERE t.descrip <> ""
	ORDER BY nombres)
UNION
(	SELECT DISTINCT
		t.descrip AS cargo, 
		f.t90_carg_equi as idcargo
	FROM t90_equi_fe f
	LEFT JOIN adm_tablas_aux t ON (f.t90_carg_equi=t.codi)
	WHERE t.descrip <> ""
	ORDER BY nombres
);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_control_pago_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_control_pago_me`(IN _con VARCHAR(5),
				            IN _eje VARCHAR(5),
				            in _proy varchar(10))
BEGIN
DECLARE _est_aprobado_mt INT DEFAULT 285 ;
SELECT 	proy.codigo,
		proy.codinst AS inst_eje,
		proy.siglas  AS inst_eje_sig,
		proy.cod_me,
		proy.moni_exte,
		proy.moni_tema,
		moni.t01_id_inst AS inst_moni,
		moni.t01_sig_inst AS inst_moni_sig,
		moni.t01_ruc_inst AS inst_moni_ruc,
		(SELECT COUNT(1) FROM t31_plan_me m WHERE m.t02_cod_proy=proy.codigo) AS nro_visitas,
		fn_costo_visita_me(proy.codigo,0) AS costo_tot_visita,
		ext.t31_id       AS nro_visita_ejec,
		ext.t31_mto_v1   AS importe_visita01,
		ext.t31_vb_v1    AS visita01_vb,
		(SELECT apr.t31_mto_aprob FROM t31_plan_me_aprob apr 
			WHERE	apr.t02_cod_proy=proy.codigo 
				AND apr.t31_id=ext.t31_id  
				AND apr.t31_id_aprob=1) AS aprob_visita01,
		ext.t31_mto_v2   AS importe_visita02,
		EXISTS(SELECT inf.t30_id FROM t30_inf_me inf 
				WHERE inf.t02_cod_proy = proy.codigo 
					AND inf.t30_id = ext.t31_id 
					AND inf.t30_estado = _est_aprobado_mt )  AS visita02_vb,
		(SELECT apr.t31_mto_aprob FROM t31_plan_me_aprob apr 
			WHERE	apr.t02_cod_proy=proy.codigo 
				AND apr.t31_id=ext.t31_id  
				AND apr.t31_id_aprob=2) AS aprob_visita02
FROM v_matriz_proyectos proy 
LEFT JOIN t01_dir_inst    moni ON ( SUBSTRING_INDEX(proy.cod_me,'.',1) = moni.t01_id_inst )
LEFT JOIN t31_plan_me     ext  ON ( proy.codigo = ext.t02_cod_proy 
								AND ext.t31_id=fn_nro_visita_me_por_ejecutar(proy.codigo) )
WHERE 
	proy.concurso = (CASE WHEN _con = '*' THEN proy.concurso ELSE _con END ) 
    AND moni.t01_id_inst = (CASE WHEN _eje = '*' THEN moni.t01_id_inst ELSE _eje END ) 
    AND proy.codigo = (CASE WHEN _proy = '*' THEN proy.codigo ELSE _proy END ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_cred`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
select 	COUNT(*) AS total
from  t12_plan_cred
where t02_cod_proy = _proy
AND t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_cuenta` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_cuenta`(IN _inst INT)
BEGIN
SELECT 	cta.t01_id_cta,
	bco.t00_nom_lar,
	bco.t00_nom_abre,
	tcta.t00_nom_lar,
	mon.t00_nom_lar,
	cta.t01_nro_cta,
	cta.t01_txt_ref,
	cta.t01_cta_def,
	bco.t00_nom_lar as banco,
	tcta.t00_nom_lar as tipocuenta,
	concat(cta.t01_nro_cta, ' - ', bco.t00_nom_abre ) as descripcion,
	mon.t00_nom_abre as moneda,
	(case when cta.t01_cta_def ='1' then 'OK' ELSE '' END ) as 'principal'
FROM 	  t01_inst_ctas    cta
LEFT JOIN t00_bancos       bco ON(cta.t00_cod_bco = bco.t00_cod_bco)
LEFT JOIN t00_tipo_cuenta tcta ON(cta.t00_cod_cta = tcta.t00_cod_cta)
LEFT JOIN t00_tipo_moneda  mon ON(cta.t00_cod_mon = mon.t00_cod_mon)
WHERE  cta.t01_id_inst = _inst ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_ejecuc_desembolso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_ejecuc_desembolso`(   IN _con VARCHAR(5),
				               IN _eje VARCHAR(5)
				            )
BEGIN
select 	wx.* ,
	des.nro_trans,
	des.desembolso,
	fec_ult_desemb,
	des.observaciones
from (
SELECT 	w.t60_id_aprob as idaprobacion,
	w.t01_id_inst,
	w.t01_sig_inst,
	w.t02_cod_proy,
	w.t02_nom_proy,
	w.nomconcurso,
	w.t01_ruc_inst,
	w.tcuenta,
	w.banco,
	w.moneda,
	w.nrocuenta,
	w.t02_nom_benef as bene_girar,
	DATE_FORMAT(w.t02_fch_isc,'%d/%m/%Y') AS t02_fch_isc,
	DATE_FORMAT(w.t02_fch_ini,'%d/%m/%Y') AS t02_fch_ini,
	DATE_FORMAT(w.t02_fch_tsc,'%d/%m/%Y') AS t02_fch_tsc,
	DATE_FORMAT(w.t02_fch_ire,'%d/%m/%Y') AS t02_fch_ire,
	DATE_FORMAT(w.t02_fch_tre,'%d/%m/%Y') AS t02_fch_tre,
	DATE_FORMAT(w.t02_fch_tam,'%d/%m/%Y') AS t02_fch_tam,
	w.estado,
	w.duracion_trim,
	w.moni_tema ,
	w.moni_fina ,
	w.trim_ejecucion,
	w.trim_desembolsar,
	
	w.total_desembolsado,
	w.monto_desembolsar,
	fecha_aprob_desemb,
	w.t60_apro_mt,
	w.t60_apro_mf,
	(
	    select DATE_FORMAT(i.t40_fch_pre, '%d/%m/%Y')
	      from t40_inf_financ i 
	     where i.t02_cod_proy = w.t02_cod_proy
	       and fn_numero_mes(i.t40_anio, i.t40_mes) = w.trim_desembolsar * 3
	) as fec_ult_informe
FROM (
	SELECT 	proy.t01_id_inst,
		ejec.t01_sig_inst,
		proy.t02_cod_proy,
		proy.t02_nom_proy,
		con.abr_conc AS nomconcurso,
		con.num_conc AS concurso,
		ejec.t01_ruc_inst,
		proy.t02_fch_isc,
		proy.t02_fch_ini,
		DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
		proy.t02_fch_ire,
		proy.t02_fch_tre,
		proy.t02_fch_tam,
		est.descrip AS estado,
		est.cod_ext AS codestado,
		cta.tcuenta,
		cta.banco,
		cta.moneda,
		cta.nrocuenta,
		cta.t02_nom_benef,
		TRUNCATE((proy.t02_num_mes / 3),0) AS duracion_trim,
		CONCAT( mt.t90_ape_pat ,' ', mt.t90_ape_mat ,', ', mt.t90_nom_equi ) AS  moni_tema ,
		CONCAT( mf.t90_ape_pat ,' ', mf.t90_ape_mat ,', ', mf.t90_nom_equi ) AS  moni_fina ,
		TRUNCATE( ((DATEDIFF(NOW(), proy.t02_fch_ini ) / 30)/3),0) AS trim_ejecucion,
		fn_numero_trim(dsmb.t60_anio, dsmb.t60_trim) as trim_desembolsar,
		
		fn_monto_desembolsado_periodo(proy.t02_cod_proy,1, TRUNCATE((proy.t02_num_mes / 3),0) ) AS total_desembolsado,
		(dsmb.t60_mto_desemb) AS monto_desembolsar,
		dsmb.t60_fch_aprob as fecha_aprob_desemb,
		dsmb.t60_apro_mt,
		dsmb.t60_apro_mf,
		dsmb.t60_id_aprob
	FROM      t60_aprobacion_desemb dsmb
	LEFT JOIN t02_dg_proy  proy  ON (dsmb.t02_cod_proy = proy.t02_cod_proy and proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
	LEFT JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
	LEFT JOIN adm_concursos  con ON (SUBSTRING(proy.t02_cod_proy,3,2) = con.num_conc)
	LEFT JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
	LEFT  JOIN  t90_equi_fe  mt  ON( proy.t02_moni_tema  =  mt.t90_id_equi ) 
	LEFT  JOIN  t90_equi_fe  mf  ON( proy.t02_moni_fina  =  mf.t90_id_equi ) 
	LEFT  JOIN  v_cuentas_proy cta ON (proy.t02_cod_proy = cta.t02_cod_proy AND cta.est_audi=1)
	WHERE ifnull(dsmb.t60_is_desemb,'0') = '0' 
     ) AS w 
WHERE  w.concurso = (CASE WHEN _con = '*' THEN w.concurso ELSE _con END ) 
  AND w.t01_id_inst = (CASE WHEN _eje = '*' THEN w.t01_id_inst ELSE _eje END )  
  and w.t60_apro_mt = '1' 
  and w.t60_apro_mf = '1' 
  
union all 
SELECT 	w.t59_id_aprob as idaprobacion,
	w.t01_id_inst,
	w.t01_sig_inst,
	w.t02_cod_proy,
	w.t02_nom_proy,
	w.nomconcurso,
	w.t01_ruc_inst,
	w.tcuenta,
	w.banco,
	w.moneda,
	w.nrocuenta,
	w.bene_girar,
	DATE_FORMAT(w.t02_fch_isc,'%d/%m/%Y') AS t02_fch_isc,
	DATE_FORMAT(w.t02_fch_ini,'%d/%m/%Y') AS t02_fch_ini,
	DATE_FORMAT(w.t02_fch_tsc,'%d/%m/%Y') AS t02_fch_tsc,
	DATE_FORMAT(w.t02_fch_ire,'%d/%m/%Y') AS t02_fch_ire,
	DATE_FORMAT(w.t02_fch_tre,'%d/%m/%Y') AS t02_fch_tre,
	DATE_FORMAT(w.t02_fch_tam,'%d/%m/%Y') AS t02_fch_tam,
	w.estado,
	w.duracion_trim,
	w.moni_tema ,
	w.moni_fina ,
	w.trim_ejecucion,
	w.trim_desembolsar,
	
	w.total_desembolsado,
	w.monto_desembolsar,
	fecha_aprob_desemb,
	w.t60_apro_mt,
	w.t59_aprueba_mf,
	(
	    SELECT DATE_FORMAT(i.t40_fch_pre, '%d/%m/%Y')
	      FROM t40_inf_financ i 
	     WHERE i.t02_cod_proy = w.t02_cod_proy
	       AND fn_numero_mes(i.t40_anio, i.t40_mes) = w.trim_desembolsar * 3
	) AS fec_ult_informe
	
FROM (
	SELECT 	proy.t01_id_inst,
		ejec.t01_sig_inst,
		proy.t02_cod_proy,
		proy.t02_nom_proy,
		con.abr_conc AS nomconcurso,
		con.num_conc AS concurso,
		ejec.t01_ruc_inst,
		proy.t02_fch_isc,
		proy.t02_fch_ini,
		DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
		proy.t02_fch_ire,
		proy.t02_fch_tre,
		proy.t02_fch_tam,
		est.descrip AS estado,
		est.cod_ext AS codestado,
		cta.tcuenta,
		cta.banco,
		cta.moneda,
		cta.nrocuenta,
		cta.t02_nom_benef AS bene_girar,
		TRUNCATE((proy.t02_num_mes / 3),0) AS duracion_trim,
		CONCAT( mt.t90_ape_pat ,' ', mt.t90_ape_mat ,', ', mt.t90_nom_equi ) AS  moni_tema ,
		CONCAT( mf.t90_ape_pat ,' ', mf.t90_ape_mat ,', ', mf.t90_nom_equi ) AS  moni_fina ,
		TRUNCATE( ((DATEDIFF(NOW(), proy.t02_fch_ini ) / 30)/3),0) AS trim_ejecucion,
		1 AS trim_desembolsar,
		
		fn_monto_desembolsado_periodo(proy.t02_cod_proy,1, TRUNCATE((proy.t02_num_mes / 3),0) ) AS total_desembolsado,
		(dsmb.t59_mto_aprob) AS monto_desembolsar,
		dsmb.t59_fch_aprob AS fecha_aprob_desemb,
		'' t60_apro_mt,
		dsmb.t59_aprueba_mf,
		dsmb.t59_id_aprob
	FROM      t59_aprob_primer_desemb dsmb
	LEFT JOIN t02_dg_proy  proy  ON (dsmb.t02_cod_proy = proy.t02_cod_proy AND proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
	LEFT JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
	LEFT JOIN adm_concursos  con ON (SUBSTRING(proy.t02_cod_proy,3,2) = con.num_conc)
	LEFT JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
	LEFT  JOIN  t90_equi_fe  mt  ON( proy.t02_moni_tema  =  mt.t90_id_equi ) 
	LEFT  JOIN  t90_equi_fe  mf  ON( proy.t02_moni_fina  =  mf.t90_id_equi ) 
	LEFT  JOIN  v_cuentas_proy cta ON (proy.t02_cod_proy = cta.t02_cod_proy and cta.est_audi=1)
	WHERE IFNULL(dsmb.t59_is_desemb,'0') = '0' 
	  and dsmb.t59_aprueba_mf = '1' 
     ) AS w 
 WHERE w.concurso    = (CASE WHEN _con = '*' THEN w.concurso ELSE _con END ) 
   AND w.t01_id_inst = (CASE WHEN _eje = '*' THEN w.t01_id_inst ELSE _eje END ) 
    
) as       wx
LEFT JOIN 
     ( 
	SELECT 	dd.t02_cod_proy,
		dd.t60_id_trim,
		COUNT(dd.t60_id_desemb) AS nro_trans,
		SUM(dd.t60_mto_des)     AS desembolso,
		GROUP_CONCAT(DISTINCT CONCAT('#',dd.t60_id_desemb,': ',dd.t60_obs_tippago) SEPARATOR '\n\n') AS observaciones,
		max(dd.t60_fch_depo) as fec_ult_desemb
	FROM t60_ejecucion_desemb dd
	GROUP BY dd.t02_cod_proy, dd.t60_id_trim
     ) AS des ON (wx.t02_cod_proy=des.t02_cod_proy and wx.trim_desembolsar = des.t60_id_trim)  
order by t02_cod_proy ASC ;  
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_ejecutores` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_ejecutores`()
BEGIN
SELECT 	i.t01_id_inst,
	i.t01_sig_inst,
	i.t01_nom_inst,
	COUNT(DISTINCT p.t02_cod_proy) AS nroproy
FROM       t02_dg_proy  p 
INNER JOIN t01_dir_inst i ON ( p.t01_id_inst=i.t01_id_inst )
GROUP BY i.t01_id_inst, i.t01_sig_inst, i.t01_nom_inst ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_importar_pprov` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_importar_pprov`()
BEGIN
	select *  
	from tmp_pago_prov_bcp  
	WHERE (banco = 'BCP' OR LOWER(banco) = 'banco de credito')
	  AND IFNULL(ruc,'') <> ''
	  AND IFNULL(tipocuenta,'') <> ''
	  AND IFNULL(nrocuenta,'') <> '' ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_entregable_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_lis_inf_entregable_at`(IN _proy VARCHAR(10), IN _ver INT,
 IN _anio INT,  IN _entregable INT,  IN _dpto CHAR(2),  IN _prov CHAR(2), 
 IN _dist CHAR(2),  IN _case CHAR(2))
BEGIN
DECLARE _sql       LONGTEXT;
DECLARE _tmpsql    TEXT DEFAULT ' 
SELECT  ben.t11_cod_bene, 
    ben.t11_dni, 
    CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
    sex.descrip AS sexo, 
    ben.t11_edad, 
    niv.descrip AS nivel, 
    sec.descrip AS sector, 
    ben.t11_unid_prod_1 as t11_nro_up_a, 
    ben.t11_nro_up_b, 
    ben.t11_nom_prod, 
    ben.t11_direccion, 
    ben.t11_ciudad, 
    ben.t11_telefono, 
    ben.t11_celular, 
    ben.t11_mail, 
    ben.t11_act_princ, 
    est.descrip AS estado
{subquerys}
FROM      t11_bco_bene ben
INNER JOIN t12_plan_at plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = \'{_proy}\'
  AND ben.t11_dpto     = (CASE WHEN \'{_dpto}\'=\'\' THEN ben.t11_dpto ELSE \'{_dpto}\' END )
  AND ben.t11_prov     = (CASE WHEN \'{_prov}\'=\'\' THEN ben.t11_prov ELSE \'{_prov}\' END )
  AND ben.t11_dist     = (CASE WHEN \'{_dist}\'=\'\' OR \'{_dist}\'=\'00\'  THEN ben.t11_dist ELSE \'{_dist}\' END )
  AND IFNULL(ben.t11_case,\'\')     = (CASE WHEN \'{_case}\'=\'\' OR \'{_case}\'=\'00\' THEN IFNULL(ben.t11_case,\'\') ELSE \'{_case}\' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; ' ;
DECLARE _tmpsubsql TEXT DEFAULT '
     (
      SELECT cap.t15_avance 
        FROM t25_inf_entregable_at cap
       WHERE cap.t02_cod_proy = \'{_proy}\'
         AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
         AND cap.t25_anio = {_anio}
         AND cap.t25_entregable = {_entregable}
         AND cap.t02_version = {_ver}
         AND cap.t11_cod_bene = ben.t11_cod_bene
      ) AS \'{_codsubtema}\'' ;
      
DECLARE _subsql TEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;
DECLARE _escape INT DEFAULT 0;
DECLARE _codsub CHAR(10);
DECLARE _codtema INT;
DECLARE _nomtema VARCHAR(150);
DECLARE _nrohora DOUBLE ;
DECLARE _curtemas CURSOR 
                 FOR 
            SELECT  CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS subact,
                sub.t09_cod_sub,
                sub.t09_sub,
                plan.t12_hor_cap
            FROM       t12_plan_at       plan
            INNER JOIN t09_subact       sub ON (sub.t02_cod_proy=plan.t02_cod_proy AND sub.t02_version=plan.t02_version AND sub.t08_cod_comp=plan.t08_cod_comp AND sub.t09_cod_act=plan.t09_cod_act AND sub.t09_cod_sub=plan.t09_cod_sub)
            WHERE plan.t02_cod_proy = _proy
              AND plan.t02_version  = _ver
              AND plan.t12_modulo > 0
            ORDER BY t12_modulo, subact  ;
              
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
SET _sql = '' ;
OPEN _curtemas;
REPEAT
FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nrohora ;
IF NOT _escape THEN
    SET _subsql = REPLACE(_tmpsubsql,'{_proy}',_proy);
    SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
    SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
    
    SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
    SET _subsql = REPLACE(_subsql,'{_entregable}',_entregable);
    SET _subsql = REPLACE(_subsql,'{_codsubtema}', _codsub );
    
    SELECT CONCAT(_sql, '   ,',_subsql,'\n') INTO _sql ;
    
END IF;
UNTIL _escape END REPEAT;
CLOSE _curtemas;
SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
SET _sql = REPLACE(_sql,'{_proy}', _proy);
SET _sql = REPLACE(_sql,'{_ver}' , _ver);
SET _sql = REPLACE(_sql,'{_dpto}', _dpto);
SET _sql = REPLACE(_sql,'{_prov}', _prov);
SET _sql = REPLACE(_sql,'{_dist}', _dist);
SET _sql = REPLACE(_sql,'{_case}', _case);
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_entregable_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_entregable_capac`(IN _proy VARCHAR(10), IN _ver INT, 
  IN _anio INT, 
  IN _entregable INT, 
  IN _dpto CHAR(2), 
  IN _prov CHAR(2), 
  IN _dist CHAR(2),
  IN _case CHAR(2))
BEGIN
DECLARE _sql       LONGTEXT;
DECLARE _tmpsql    TEXT DEFAULT ' 
SELECT  ben.t11_cod_bene, 
    ben.t11_dni, 
    CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
    sex.descrip AS sexo, 
    ben.t11_edad, 
    niv.descrip AS nivel,
    esp.descrip AS especialidad,
    (SELECT ubig.nom_ubig
        FROM adm_ubigeo ubig
        WHERE ubig.cod_dpto = ben.t11_dpto
        AND ubig.cod_prov = 0
        AND ubig.cod_dist = 0) AS departamento,
    (SELECT ubig.nom_ubig
        FROM adm_ubigeo ubig
        WHERE ubig.cod_dpto = ben.t11_dpto
        AND ubig.cod_prov = ben.t11_prov
        AND ubig.cod_dist = 0) AS provincia,
    (SELECT ubig.nom_ubig
        FROM adm_ubigeo ubig
        WHERE ubig.cod_dpto = ben.t11_dpto
        AND ubig.cod_prov = ben.t11_prov
        AND ubig.cod_dist = ben.t11_dist) AS distrito,
    (SELECT cas.nom_case
        FROM adm_caserios cas
        WHERE cas.cod_dpto = ben.t11_dpto
        AND cas.cod_prov = ben.t11_prov
        AND cas.cod_dist = ben.t11_dist
        AND cas.cod_case = ben.t11_case) AS caserio,
    ben.t11_direccion, 
    ben.t11_ciudad, 
    ben.t11_telefono, 
    ben.t11_celular, 
    ben.t11_mail, 
    sec1.descrip AS sec_prod_1, 
    sec2.descrip AS sec_prod_2, 
    sec3.descrip AS sec_prod_3,
    subsec1.descrip AS subsec_prod_1,
    subsec2.descrip AS subsec_prod_2,
    subsec3.descrip AS subsec_prod_3,
    
    ben.t11_unid_prod_1 as t11_nro_up_a, 
    ben.t11_nro_up_b, 
    ben.t11_nom_prod, 
    ben.t11_act_princ, 
    t11_unid_prod_1,
    t11_tot_unid_prod,
    t11_nro_up_b,
    t11_unid_prod_2,
    t11_tot_unid_prod_2,
    t11_nro_up_b_2,
    t11_unid_prod_3,
    t11_tot_unid_prod_3,
    t11_nro_up_b_3,
    est.descrip AS estado
{subquerys}
FROM      t11_bco_bene ben
INNER JOIN t12_plan_capac_tema plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux esp ON (ben.t11_especialidad = esp.codi and esp.idTabla =  26)
LEFT JOIN adm_tablas_aux sec1 ON (ben.t11_sec_prod = sec1.codi AND sec1.idTabla = 18) 
LEFT JOIN adm_tablas_aux sec2 ON (ben.t11_sec_prod_2 = sec2.codi AND sec1.idTabla = 18) 
LEFT JOIN adm_tablas_aux sec3 ON (ben.t11_sec_prod_3 = sec3.codi AND sec1.idTabla = 18) 
LEFT JOIN adm_tablas_aux2 subsec1 ON (ben.t11_subsector = subsec1.codi AND subsec1.idTabla = 18)
LEFT JOIN adm_tablas_aux2 subsec2 ON (ben.t11_subsec_prod_2 = subsec2.codi AND subsec1.idTabla = 18)
LEFT JOIN adm_tablas_aux2 subsec3 ON (ben.t11_subsec_prod_3 = subsec3.codi AND subsec1.idTabla = 18)
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = \'{_proy}\'
  AND ben.t11_dpto     = (CASE WHEN \'{_dpto}\'=\'\' THEN ben.t11_dpto ELSE \'{_dpto}\' END )
  AND ben.t11_prov     = (CASE WHEN \'{_prov}\'=\'\' THEN ben.t11_prov ELSE \'{_prov}\' END )
  AND ben.t11_dist     = (CASE WHEN \'{_dist}\'=\'\' OR \'{_dist}\'=\'00\'  THEN ben.t11_dist ELSE \'{_dist}\' END )
  AND IFNULL(ben.t11_case,\'\')     = (CASE WHEN \'{_case}\'=\'\' OR \'{_case}\'=\'00\' THEN IFNULL(ben.t11_case,\'\') ELSE \'{_case}\' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; ' ;
DECLARE _tmpsubsql TEXT DEFAULT '
     (
      SELECT cap.t15_avance 
        FROM t25_inf_entregable_capac cap
       WHERE cap.t02_cod_proy = \'{_proy}\'
         AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
         AND cap.t12_cod_tema = {_codtema}
         AND cap.t25_anio = {_anio}
         AND cap.t25_entregable = {_entregable}
         AND cap.t02_version = {_ver}
         AND cap.t11_cod_bene = ben.t11_cod_bene
      ) AS \'{_codsubtema}\'' ;
      
DECLARE _subsql TEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;
DECLARE _escape INT DEFAULT 0;
DECLARE _codsub CHAR(10);
DECLARE _codtema INT;
DECLARE _nomtema VARCHAR(150);
DECLARE _nrohora DOUBLE ;
DECLARE _curtemas CURSOR 
                 FOR 
                 SELECT     CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS subact,
                tema.t12_cod_tema,
                tema.t12_tem_espe,
                tema.t12_nro_hora
            FROM       t12_plan_capac_tema tema
            INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
            WHERE tema.t02_cod_proy = _proy
              AND plan.t02_version  = _ver 
            ORDER BY t12_modulo, subact , t12_cod_tema ;
              
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
SET _sql = '' ;
OPEN _curtemas;
REPEAT
FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nrohora ;
IF NOT _escape THEN
    SET _subsql = REPLACE(_tmpsubsql,'{_proy}',_proy);
    SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
    SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
    SET _subsql = REPLACE(_subsql,'{_codtema}',_codtema);
    SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
    SET _subsql = REPLACE(_subsql,'{_entregable}',_entregable);
    SET _subsql = REPLACE(_subsql,'{_codsubtema}', CONCAT(_codsub,'.',_codtema) );
    
    SELECT CONCAT(_sql, '   ,',_subsql,'\n') INTO _sql ;
    
END IF;
UNTIL _escape END REPEAT;
CLOSE _curtemas;
SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
SET _sql = REPLACE(_sql,'{_proy}', _proy);
SET _sql = REPLACE(_sql,'{_ver}' , _ver);
SET _sql = REPLACE(_sql,'{_dpto}', _dpto);
SET _sql = REPLACE(_sql,'{_prov}', _prov);
SET _sql = REPLACE(_sql,'{_dist}', _dist);
SET _sql = REPLACE(_sql,'{_case}', _case);
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_entregable_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_lis_inf_entregable_otros`(IN _proy VARCHAR(10), IN _ver INT, 
  IN _anio INT, IN _entregable INT, IN _dpto CHAR(2), IN _prov CHAR(2), 
  IN _dist CHAR(2), IN _case CHAR(2))
BEGIN
    DECLARE _sql       LONGTEXT;
    DECLARE _tmpsql    TEXT DEFAULT ' 
    SELECT  ben.t11_cod_bene, 
        ben.t11_dni, 
        CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
        sex.descrip AS sexo, 
        ben.t11_edad, 
        niv.descrip AS nivel, 
        sec.descrip AS sector, 
        ben.t11_unid_prod_1 as t11_nro_up_a, 
        ben.t11_nro_up_b, 
        ben.t11_nom_prod, 
        ben.t11_direccion, 
        ben.t11_ciudad, 
        ben.t11_telefono, 
        ben.t11_celular, 
        ben.t11_mail, 
        ben.t11_act_princ, 
        est.descrip AS estado
    {subquerys}
    FROM      t11_bco_bene ben
    INNER JOIN t12_plan_otros plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
    LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
    LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
    LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
    LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
    WHERE 
          ben.t02_cod_proy = \'{_proy}\'
      AND ben.t11_dpto     = (CASE WHEN \'{_dpto}\'=\'\' THEN ben.t11_dpto ELSE \'{_dpto}\' END )
      AND ben.t11_prov     = (CASE WHEN \'{_prov}\'=\'\' THEN ben.t11_prov ELSE \'{_prov}\' END )
      AND ben.t11_dist     = (CASE WHEN \'{_dist}\'=\'\' OR \'{_dist}\'=\'00\'  THEN ben.t11_dist ELSE \'{_dist}\' END )
      AND IFNULL(ben.t11_case,\'\')     = (CASE WHEN \'{_case}\'=\'\' OR \'{_case}\'=\'00\' THEN IFNULL(ben.t11_case,\'\') ELSE \'{_case}\' END )
      
    GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
    ORDER BY nombres ASC; ' ;
    DECLARE _tmpsubsql TEXT DEFAULT '
         (
          SELECT CONCAT(cap.t15_avance,\'|\', IFNULL(cap.t15_valor,\'\'))
            FROM t25_inf_entregable_otros cap
           WHERE cap.t02_cod_proy = \'{_proy}\'
             AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
             AND cap.t25_anio = {_anio}
             AND cap.t25_entregable = {_entregable}
             AND cap.t02_version = {_ver}
             AND cap.t11_cod_bene = ben.t11_cod_bene
          ) AS \'{_codsubtema}\'' ;
          
    DECLARE _subsql TEXT;
    DECLARE _contador  INT;
    DECLARE _codfte   INT;
    DECLARE _nomfte   VARCHAR(50);
    DECLARE _codFE    INT DEFAULT 10;
    DECLARE _escape INT DEFAULT 0;
    DECLARE _codsub CHAR(10);
    DECLARE _codtema INT;
    DECLARE _nomtema VARCHAR(150);
    DECLARE _nroentregado DOUBLE ;
    DECLARE _curtemas CURSOR 
                     FOR 
                SELECT  CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS subact,
                    sub.t09_cod_sub,
                    sub.t09_sub,
                    plan.t12_nro_ent
                FROM t12_plan_otros plan
                INNER JOIN t09_subact sub ON (sub.t02_cod_proy=plan.t02_cod_proy AND sub.t02_version=plan.t02_version AND sub.t08_cod_comp=plan.t08_cod_comp AND sub.t09_cod_act=plan.t09_cod_act AND sub.t09_cod_sub=plan.t09_cod_sub)
                WHERE plan.t02_cod_proy = _proy
                  AND plan.t02_version  = _ver
                  AND plan.t12_tipo > 0
                ORDER BY t12_tipo, subact;
                  
    DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
    SET _sql = '' ;
    OPEN _curtemas;
    REPEAT
    FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nroentregado ;
    IF NOT _escape THEN
        SET _subsql = REPLACE(_tmpsubsql,'{_proy}',_proy);
        SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
        SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
        
        SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
        SET _subsql = REPLACE(_subsql,'{_entregable}',_entregable);
        SET _subsql = REPLACE(_subsql,'{_codsubtema}', _codsub );
        
        SELECT CONCAT(_sql, '   ,',_subsql,'\n') INTO _sql ;
        
    END IF;
    UNTIL _escape END REPEAT;
    CLOSE _curtemas;
    SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
    SET _sql = REPLACE(_sql,'{_proy}', _proy);
    SET _sql = REPLACE(_sql,'{_ver}' , _ver);
    SET _sql = REPLACE(_sql,'{_dpto}', _dpto);
    SET _sql = REPLACE(_sql,'{_prov}', _prov);
    SET _sql = REPLACE(_sql,'{_dist}', _dist);
    SET _sql = REPLACE(_sql,'{_case}', _case);
    SELECT _sql INTO @txtsql;
    PREPARE stmt FROM @txtsql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_plan_otros_infor` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_plan_otros_infor`(IN _proy VARCHAR(10),    IN _ver INT)
BEGIN
	SELECT t12_producto, t02_cod_proy, CONCAT(t08_cod_comp,'.',t09_cod_act,'.',t09_cod_sub) AS codigo
	FROM t12_plan_otros
	WHERE t02_cod_proy = _proy
	AND t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_at`(IN _proy VARCHAR(10), 
 IN _anio INT,  IN _trim INT,  IN _dpto CHAR(2),  IN _prov CHAR(2), 
 IN _dist CHAR(2),  IN _case CHAR(2))
BEGIN
DECLARE _sql       LONGTEXT;
DECLARE _tmpsql    TEXT DEFAULT ' 
SELECT  ben.t11_cod_bene, 
	ben.t11_dni, 
	CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
	sex.descrip AS sexo, 
	ben.t11_edad, 
	niv.descrip AS nivel, 
	sec.descrip AS sector, 
	ben.t11_unid_prod_1 as t11_nro_up_a, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	ben.t11_act_princ, 
	est.descrip AS estado
{subquerys}
FROM 	  t11_bco_bene ben
INNER JOIN t12_plan_at plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = \'{_proy}\'
  AND ben.t11_dpto     = (CASE WHEN \'{_dpto}\'=\'\' THEN ben.t11_dpto ELSE \'{_dpto}\' END )
  AND ben.t11_prov     = (CASE WHEN \'{_prov}\'=\'\' THEN ben.t11_prov ELSE \'{_prov}\' END )
  AND ben.t11_dist     = (CASE WHEN \'{_dist}\'=\'\' OR \'{_dist}\'=\'00\'  THEN ben.t11_dist ELSE \'{_dist}\' END )
  AND IFNULL(ben.t11_case,\'\')     = (CASE WHEN \'{_case}\'=\'\' OR \'{_case}\'=\'00\' THEN IFNULL(ben.t11_case,\'\') ELSE \'{_case}\' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; ' ;
DECLARE _tmpsubsql TEXT DEFAULT '
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_at cap
	   WHERE cap.t02_cod_proy = \'{_proy}\'
	     AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
	     AND cap.t25_anio = {_anio}
	     AND cap.t25_trim = {_trim}
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS \'{_codsubtema}\'' ;
	  
DECLARE _subsql TEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _ver      INT DEFAULT fn_version_proy_poa(_proy, _anio);
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;
DECLARE _escape INT DEFAULT 0;
DECLARE _codsub CHAR(10);
DECLARE _codtema INT;
DECLARE _nomtema VARCHAR(150);
DECLARE _nrohora DOUBLE ;
DECLARE _curtemas CURSOR 
	             FOR 
			SELECT 	CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS subact,
				sub.t09_cod_sub,
				sub.t09_sub,
				plan.t12_hor_cap
			FROM 	   t12_plan_at       plan
			INNER JOIN t09_subact 		sub ON (sub.t02_cod_proy=plan.t02_cod_proy AND sub.t02_version=plan.t02_version AND sub.t08_cod_comp=plan.t08_cod_comp AND sub.t09_cod_act=plan.t09_cod_act AND sub.t09_cod_sub=plan.t09_cod_sub)
			WHERE plan.t02_cod_proy = _proy
			  AND plan.t02_version  = _ver
			  AND plan.t12_modulo > 0
			ORDER BY t12_modulo, subact  ;
			  
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
SET _sql = '' ;
OPEN _curtemas;
REPEAT
FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nrohora ;
IF NOT _escape THEN
	SET _subsql = REPLACE(_tmpsubsql,'{_proy}',_proy);
	SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
	SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
	
	SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
	SET _subsql = REPLACE(_subsql,'{_trim}',_trim);
	SET _subsql = REPLACE(_subsql,'{_codsubtema}', _codsub );
	
	SELECT CONCAT(_sql, '	,',_subsql,'\n') INTO _sql ;
	
END IF;
UNTIL _escape END REPEAT;
CLOSE _curtemas;
SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
SET _sql = REPLACE(_sql,'{_proy}', _proy);
SET _sql = REPLACE(_sql,'{_ver}' , _ver);
SET _sql = REPLACE(_sql,'{_dpto}', _dpto);
SET _sql = REPLACE(_sql,'{_prov}', _prov);
SET _sql = REPLACE(_sql,'{_dist}', _dist);
SET _sql = REPLACE(_sql,'{_case}', _case);
 SELECT _sql AS '_sql' ;
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_at_2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_at_2`(IN _proy VARCHAR(10),    IN _anio INT,  IN _trim INT, IN _ben INT)
BEGIN
	
 
SELECT  ben.t11_cod_bene, 
	ben.t11_dni, 
	CONCAT(ben.t11_ape_pat, ' ' ,ben.t11_ape_mat, ', ', ben.t11_nom) AS nombres,
	sex.descrip AS sexo, 
	ben.t11_edad, 
	niv.descrip AS nivel, 
	sec.descrip AS sector, 
	ben.t11_unid_prod_1 as t11_nro_up_a, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	ben.t11_act_princ, 
	est.descrip AS estado
	,
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_at cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '1.1.7'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '1.1.7'
	,
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_at cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '2.2.2'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '2.2.2'
	,
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_at cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '2.2.1'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '2.2.1'
	,
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_at cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '3.1.5'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '3.1.5'
	,
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_at cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '2.2.3'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _anio
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '2.2.3'
FROM 	  t11_bco_bene ben
INNER JOIN t12_plan_at plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version= (_anio+1)) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = _proy
	AND ben.t11_cod_bene = _ben
  AND ben.t11_dpto     = (CASE WHEN ''='' THEN ben.t11_dpto ELSE '' END )
  AND ben.t11_prov     = (CASE WHEN ''='' THEN ben.t11_prov ELSE '' END )
  AND ben.t11_dist     = (CASE WHEN ''='' OR ''='00'  THEN ben.t11_dist ELSE '' END )
  AND IFNULL(ben.t11_case,'')     = (CASE WHEN ''='' OR ''='00' THEN IFNULL(ben.t11_case,'') ELSE '' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_capac`(IN _proy VARCHAR(10), 
  IN _anio INT, 
  IN _trim INT, 
  IN _dpto CHAR(2), 
  IN _prov CHAR(2), 
  IN _dist CHAR(2),
  IN _case CHAR(2))
BEGIN
DECLARE _sql       LONGTEXT;
DECLARE _tmpsql    TEXT DEFAULT ' 
SELECT  ben.t11_cod_bene, 
	ben.t11_dni, 
	CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
	sex.descrip AS sexo, 
	ben.t11_edad, 
	niv.descrip AS nivel,
	esp.descrip AS especialidad,
	(SELECT ubig.nom_ubig
		FROM adm_ubigeo ubig
		WHERE ubig.cod_dpto = ben.t11_dpto
		AND ubig.cod_prov = 0
		AND ubig.cod_dist = 0) AS departamento,
	(SELECT ubig.nom_ubig
		FROM adm_ubigeo ubig
		WHERE ubig.cod_dpto = ben.t11_dpto
		AND ubig.cod_prov = ben.t11_prov
		AND ubig.cod_dist = 0) AS provincia,
	(SELECT ubig.nom_ubig
		FROM adm_ubigeo ubig
		WHERE ubig.cod_dpto = ben.t11_dpto
		AND ubig.cod_prov = ben.t11_prov
		AND ubig.cod_dist = ben.t11_dist) AS distrito,
	(SELECT cas.nom_case
		FROM adm_caserios cas
		WHERE cas.cod_dpto = ben.t11_dpto
		AND cas.cod_prov = ben.t11_prov
		AND cas.cod_dist = ben.t11_dist
		AND cas.cod_case = ben.t11_case) AS caserio,
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	sec1.descrip AS sec_prod_1, 
	sec2.descrip AS sec_prod_2, 
	sec3.descrip AS sec_prod_3,
	subsec1.descrip AS subsec_prod_1,
	subsec2.descrip AS subsec_prod_2,
	subsec3.descrip AS subsec_prod_3,
	
	ben.t11_unid_prod_1 as t11_nro_up_a, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_act_princ, 
	t11_unid_prod_1,
	t11_tot_unid_prod,
	t11_nro_up_b,
	t11_unid_prod_2,
	t11_tot_unid_prod_2,
	t11_nro_up_b_2,
	t11_unid_prod_3,
	t11_tot_unid_prod_3,
	t11_nro_up_b_3,
	est.descrip AS estado
{subquerys}
FROM 	  t11_bco_bene ben
INNER JOIN t12_plan_capac_tema plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux esp ON (ben.t11_especialidad = esp.codi and esp.idTabla =  26)
LEFT JOIN adm_tablas_aux sec1 ON (ben.t11_sec_prod = sec1.codi AND sec1.idTabla = 18) 
LEFT JOIN adm_tablas_aux sec2 ON (ben.t11_sec_prod_2 = sec2.codi AND sec1.idTabla = 18) 
LEFT JOIN adm_tablas_aux sec3 ON (ben.t11_sec_prod_3 = sec3.codi AND sec1.idTabla = 18) 
LEFT JOIN adm_tablas_aux2 subsec1 ON (ben.t11_subsector = subsec1.codi AND subsec1.idTabla = 18)
LEFT JOIN adm_tablas_aux2 subsec2 ON (ben.t11_subsec_prod_2 = subsec2.codi AND subsec1.idTabla = 18)
LEFT JOIN adm_tablas_aux2 subsec3 ON (ben.t11_subsec_prod_3 = subsec3.codi AND subsec1.idTabla = 18)
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = \'{_proy}\'
  AND ben.t11_dpto     = (CASE WHEN \'{_dpto}\'=\'\' THEN ben.t11_dpto ELSE \'{_dpto}\' END )
  AND ben.t11_prov     = (CASE WHEN \'{_prov}\'=\'\' THEN ben.t11_prov ELSE \'{_prov}\' END )
  AND ben.t11_dist     = (CASE WHEN \'{_dist}\'=\'\' OR \'{_dist}\'=\'00\'  THEN ben.t11_dist ELSE \'{_dist}\' END )
  AND IFNULL(ben.t11_case,\'\')     = (CASE WHEN \'{_case}\'=\'\' OR \'{_case}\'=\'00\' THEN IFNULL(ben.t11_case,\'\') ELSE \'{_case}\' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; ' ;
DECLARE _tmpsubsql TEXT DEFAULT '
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_capac cap
	   WHERE cap.t02_cod_proy = \'{_proy}\'
	     AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
	     AND cap.t12_cod_tema = {_codtema}
	     AND cap.t25_anio = {_anio}
	     AND cap.t25_trim = {_trim}
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS \'{_codsubtema}\'' ;
	  
DECLARE _subsql TEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _ver      INT DEFAULT fn_version_proy_poa(_proy, _anio);
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;
DECLARE _escape INT DEFAULT 0;
DECLARE _codsub CHAR(10);
DECLARE _codtema INT;
DECLARE _nomtema VARCHAR(150);
DECLARE _nrohora DOUBLE ;
DECLARE _curtemas CURSOR 
	             FOR 
	             SELECT 	CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS subact,
				tema.t12_cod_tema,
				tema.t12_tem_espe,
				tema.t12_nro_hora
			FROM 	   t12_plan_capac_tema tema
			INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
			WHERE tema.t02_cod_proy = _proy
			  AND tema.t02_version  = _ver 
			ORDER BY t12_modulo, subact , t12_cod_tema ;
			  
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
SET _sql = '' ;
OPEN _curtemas;
REPEAT
FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nrohora ;
IF NOT _escape THEN
	SET _subsql = REPLACE(_tmpsubsql,'{_proy}',_proy);
	SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
	SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
	SET _subsql = REPLACE(_subsql,'{_codtema}',_codtema);
	SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
	SET _subsql = REPLACE(_subsql,'{_trim}',_trim);
	SET _subsql = REPLACE(_subsql,'{_codsubtema}', CONCAT(_codsub,'.',_codtema) );
	
	SELECT CONCAT(_sql, '	,',_subsql,'\n') INTO _sql ;
	
END IF;
UNTIL _escape END REPEAT;
CLOSE _curtemas;
SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
SET _sql = REPLACE(_sql,'{_proy}', _proy);
SET _sql = REPLACE(_sql,'{_ver}' , _ver);
SET _sql = REPLACE(_sql,'{_dpto}', _dpto);
SET _sql = REPLACE(_sql,'{_prov}', _prov);
SET _sql = REPLACE(_sql,'{_dist}', _dist);
SET _sql = REPLACE(_sql,'{_case}', _case);
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_capac2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_capac2`(IN _proy VARCHAR(10), 
  in _anio int, 
  in _trim int, 
  in _dpto char(2), 
  IN _prov CHAR(2), 
  IN _dist CHAR(2),
  in _case char(2))
BEGIN
DECLARE _sql       LONGTEXT;
DECLARE _tmpsql    TEXT default ' 
SELECT  ben.t11_cod_bene, 
	ben.t11_dni, 
	CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
	sex.descrip AS sexo, 
	ben.t11_edad, 
	niv.descrip AS nivel, 
	sec.descrip AS sector, 
	ben.t11_unid_prod_1 as t11_nro_up_a, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	ben.t11_act_princ, 
	est.descrip AS estado
{subquerys}
FROM 	  t11_bco_bene ben
INNER JOIN t12_plan_capac_tema plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = \'{_proy}\'
  AND ben.t11_dpto     = (CASE WHEN \'{_dpto}\'=\'\' THEN ben.t11_dpto ELSE \'{_dpto}\' END )
  AND ben.t11_prov     = (CASE WHEN \'{_prov}\'=\'\' THEN ben.t11_prov ELSE \'{_prov}\' END )
  AND ben.t11_dist     = (CASE WHEN \'{_dist}\'=\'\' OR \'{_dist}\'=\'00\'  THEN ben.t11_dist ELSE \'{_dist}\' END )
  AND IFNULL(ben.t11_case,\'\')     = (CASE WHEN \'{_case}\'=\'\' OR \'{_case}\'=\'00\' THEN IFNULL(ben.t11_case,\'\') ELSE \'{_case}\' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; ' ;
declare _tmpsubsql text default '
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_capac cap
	   WHERE cap.t02_cod_proy = \'{_proy}\'
	     AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
	     AND cap.t12_cod_tema = {_codtema}
	     AND cap.t25_anio = {_anio}
	     AND cap.t25_trim = {_trim}
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS \'{_codsubtema}\'' ;
	  
DECLARE _subsql TEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
declare _ver      INT default fn_version_proy_poa(_proy, _anio);
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;
DECLARE _escape INT DEFAULT 0;
DECLARE _codsub CHAR(10);
DECLARE _codtema INT;
declare _nomtema varchar(150);
declare _nrohora double ;
DECLARE _curtemas CURSOR 
	             FOR 
	             SELECT 	CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS subact,
				tema.t12_cod_tema,
				tema.t12_tem_espe,
				tema.t12_nro_hora
			FROM 	   t12_plan_capac_tema tema
			INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
			WHERE tema.t02_cod_proy = _proy
			  AND tema.t02_version  = _ver 
			order by t12_modulo, subact , t12_cod_tema ;
			  
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
SET _sql = '' ;
OPEN _curtemas;
REPEAT
FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nrohora ;
IF NOT _escape THEN
	set _subsql = replace(_tmpsubsql,'{_proy}',_proy);
	SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
	SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
	SET _subsql = REPLACE(_subsql,'{_codtema}',_codtema);
	SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
	SET _subsql = REPLACE(_subsql,'{_trim}',_trim);
	SET _subsql = REPLACE(_subsql,'{_codsubtema}', concat(_codsub,'.',_codtema) );
	
	select concat(_sql, '	,',_subsql,'\n') into _sql ;
	
END IF;
UNTIL _escape END REPEAT;
CLOSE _curtemas;
SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
SET _sql = REPLACE(_sql,'{_proy}', _proy);
SET _sql = REPLACE(_sql,'{_ver}' , _ver);
SET _sql = REPLACE(_sql,'{_dpto}', _dpto);
SET _sql = REPLACE(_sql,'{_prov}', _prov);
SET _sql = REPLACE(_sql,'{_dist}', _dist);
SET _sql = REPLACE(_sql,'{_case}', _case);
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_cred`(IN _proy VARCHAR(10), 
					  IN _anio INT, 
					  IN _trim INT,
					  in _comp int, 
					  IN _act INT,
					  IN _sub INT)
BEGIN
declare _ver int default fn_version_proy_poa(_proy, _anio) ;
SELECT  p.t11_cod_benef AS codigo,
	b.t11_dni,
	CONCAT(b.t11_ape_pat,' ', b.t11_ape_mat, ', ', b.t11_nom) AS nombres,
	p.t12_mto_ben AS plan_monto,
	p.t12_nro_cuo AS plan_cuota,
	p.t12_tasa_int AS plan_tasa,
	(SELECT SUM(pa.t15_avance) 
	   FROM  t25_inf_trim_cred pa 
	   WHERE pa.t02_cod_proy = p.t02_cod_proy
	     AND pa.t08_cod_comp = p.t08_cod_comp
	     AND pa.t09_cod_act  = p.t09_cod_act
	     AND pa.t09_cod_sub  = p.t09_cod_sub
	     AND pa.t11_cod_bene = p.t11_cod_benef
	     AND pa.t25_anio = _anio
	     AND pa.t25_trim < _trim
	 ) AS pagado_antes,
	(SELECT SUM(pa.t15_avance) 
	   FROM  t25_inf_trim_cred pa 
	   WHERE pa.t02_cod_proy = p.t02_cod_proy
	     AND pa.t08_cod_comp = p.t08_cod_comp
	     AND pa.t09_cod_act  = p.t09_cod_act
	     AND pa.t09_cod_sub  = p.t09_cod_sub
	     AND pa.t11_cod_bene = p.t11_cod_benef
	     AND pa.t25_anio = _anio
	     AND pa.t25_trim = _trim
	  ) AS trim_pagado 
FROM      t12_plan_cred_benef p
LEFT JOIN t11_bco_bene        b ON (p.t02_cod_proy=b.t02_cod_proy AND p.t11_cod_benef = b.t11_cod_bene)
WHERE 	      p.t02_cod_proy = _proy
	  AND p.t02_version  = _ver
	  AND p.t08_cod_comp = _comp
	  AND p.t09_cod_act  = _act
	  AND p.t09_cod_sub  = _sub 
order by nombres asc ;
	  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_mod_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_mod_at`(IN _proy VARCHAR(10),  IN _version INT)
BEGIN
	 SELECT t12_conten, t02_cod_proy, t02_version,
	 CONCAT(t08_cod_comp,'.',t09_cod_act,'.',t09_cod_sub) as tema
	 FROM t12_plan_at 
	 WHERE t02_cod_proy = _proy
	 AND t02_version = _version;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_otros`(IN _proy VARCHAR(10), 
  IN _anio INT,   IN _trim INT, 
 IN _dpto CHAR(2), 
  IN _prov CHAR(2),   IN _dist CHAR(2),
   IN _case CHAR(2))
BEGIN
DECLARE _sql       LONGTEXT;
DECLARE _tmpsql    TEXT DEFAULT ' 
SELECT  ben.t11_cod_bene, 
	ben.t11_dni, 
	CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
	sex.descrip AS sexo, 
	ben.t11_edad, 
	niv.descrip AS nivel, 
	sec.descrip AS sector, 
	ben.t11_unid_prod_1 as t11_nro_up_a, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	ben.t11_act_princ, 
	est.descrip AS estado
{subquerys}
FROM 	  t11_bco_bene ben
INNER JOIN t12_plan_otros plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = \'{_proy}\'
  AND ben.t11_dpto     = (CASE WHEN \'{_dpto}\'=\'\' THEN ben.t11_dpto ELSE \'{_dpto}\' END )
  AND ben.t11_prov     = (CASE WHEN \'{_prov}\'=\'\' THEN ben.t11_prov ELSE \'{_prov}\' END )
  AND ben.t11_dist     = (CASE WHEN \'{_dist}\'=\'\' OR \'{_dist}\'=\'00\'  THEN ben.t11_dist ELSE \'{_dist}\' END )
  AND IFNULL(ben.t11_case,\'\')     = (CASE WHEN \'{_case}\'=\'\' OR \'{_case}\'=\'00\' THEN IFNULL(ben.t11_case,\'\') ELSE \'{_case}\' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; ' ;
DECLARE _tmpsubsql TEXT DEFAULT '
	 (
	  SELECT CONCAT(cap.t15_avance,\'|\', IFNULL(cap.t15_valor,\'\'))
	    FROM t25_inf_trim_otros cap
	   WHERE cap.t02_cod_proy = \'{_proy}\'
	     AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
	     AND cap.t25_anio = {_anio}
	     AND cap.t25_trim = {_trim}
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS \'{_codsubtema}\'' ;
	  
DECLARE _subsql TEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _ver      INT DEFAULT fn_version_proy_poa(_proy, _anio);
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;
DECLARE _escape INT DEFAULT 0;
DECLARE _codsub CHAR(10);
DECLARE _codtema INT;
DECLARE _nomtema VARCHAR(150);
DECLARE _nroentregado DOUBLE ;
DECLARE _curtemas CURSOR 
	             FOR 
			SELECT 	CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS subact,
				sub.t09_cod_sub,
				sub.t09_sub,
				plan.t12_nro_ent
			FROM 	   t12_plan_otros       plan
			INNER JOIN t09_subact 		sub ON (sub.t02_cod_proy=plan.t02_cod_proy AND sub.t02_version=plan.t02_version AND sub.t08_cod_comp=plan.t08_cod_comp AND sub.t09_cod_act=plan.t09_cod_act AND sub.t09_cod_sub=plan.t09_cod_sub)
			WHERE plan.t02_cod_proy = _proy
			  AND plan.t02_version  = _ver
			  AND plan.t12_tipo > 0
			ORDER BY t12_tipo, subact  ;
			  
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
SET _sql = '' ;
OPEN _curtemas;
REPEAT
FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nroentregado ;
IF NOT _escape THEN
	SET _subsql = REPLACE(_tmpsubsql,'{_proy}',_proy);
	SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
	SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
	
	SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
	SET _subsql = REPLACE(_subsql,'{_trim}',_trim);
	SET _subsql = REPLACE(_subsql,'{_codsubtema}', _codsub );
	
	SELECT CONCAT(_sql, '	,',_subsql,'\n') INTO _sql ;
	
END IF;
UNTIL _escape END REPEAT;
CLOSE _curtemas;
SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
SET _sql = REPLACE(_sql,'{_proy}', _proy);
SET _sql = REPLACE(_sql,'{_ver}' , _ver);
SET _sql = REPLACE(_sql,'{_dpto}', _dpto);
SET _sql = REPLACE(_sql,'{_prov}', _prov);
SET _sql = REPLACE(_sql,'{_dist}', _dist);
SET _sql = REPLACE(_sql,'{_case}', _case);
 SELECT _sql AS '_sql' ;
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inf_trim_otros2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inf_trim_otros2`(IN _proy VARCHAR(10),    IN _anio INT,  IN _trim INT, IN _ben INT)
BEGIN
	 
SELECT  ben.t11_cod_bene, 
	ben.t11_dni, 
	CONCAT(ben.t11_ape_pat, ' ' ,ben.t11_ape_mat, ', ', ben.t11_nom) AS nombres,
	sex.descrip AS sexo, 
	ben.t11_edad, 
	niv.descrip AS nivel, 
	sec.descrip AS sector, 
	ben.t11_unid_prod_1 as t11_nro_up_a, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	ben.t11_act_princ, 
	est.descrip AS estado
	,
	 (
	  SELECT CONCAT(cap.t15_avance,'|', IFNULL(cap.t15_valor,''))
	    FROM t25_inf_trim_otros cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '1.1.2'
	     AND cap.t25_anio = _anio 
	     AND cap.t25_trim = _trim 
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '1.1.2'
	,
	 (
	  SELECT CONCAT(cap.t15_avance,'|', IFNULL(cap.t15_valor,''))
	    FROM t25_inf_trim_otros cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '1.1.4'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '1.1.4'
	,
	 (
	  SELECT CONCAT(cap.t15_avance,'|', IFNULL(cap.t15_valor,''))
	    FROM t25_inf_trim_otros cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '1.1.3'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '1.1.3'
	,
	 (
	  SELECT CONCAT(cap.t15_avance,'|', IFNULL(cap.t15_valor,''))
	    FROM t25_inf_trim_otros cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '1.2.1'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '1.2.1'
	,
	 (
	  SELECT CONCAT(cap.t15_avance,'|', IFNULL(cap.t15_valor,''))
	    FROM t25_inf_trim_otros cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '1.1.1'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '1.1.1'
	,
	 (
	  SELECT CONCAT(cap.t15_avance,'|', IFNULL(cap.t15_valor,''))
	    FROM t25_inf_trim_otros cap
	   WHERE cap.t02_cod_proy = _proy
	     AND CONCAT(cap.t08_cod_comp,'.',cap.t09_cod_act,'.',cap.t09_cod_sub) = '1.1.5'
	     AND cap.t25_anio = _anio
	     AND cap.t25_trim = _trim
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS '1.1.5'
FROM 	  t11_bco_bene ben
INNER JOIN t12_plan_otros plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version=2) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = _proy
	AND	ben.t11_cod_bene = _ben
  AND ben.t11_dpto     = (CASE WHEN ''='' THEN ben.t11_dpto ELSE '' END )
  AND ben.t11_prov     = (CASE WHEN ''='' THEN ben.t11_prov ELSE '' END )
  AND ben.t11_dist     = (CASE WHEN ''='' OR ''='00'  THEN ben.t11_dist ELSE '' END )
  AND IFNULL(ben.t11_case,'')     = (CASE WHEN ''='' OR ''='00' THEN IFNULL(ben.t11_case,'') ELSE '' END )
  
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_institucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_institucion`( IN _user  VARCHAR(20)  )
BEGIN
DECLARE _tipouser INT ;
DECLARE _inst VARCHAR(5) DEFAULT '*';
SELECT tipo_user, IFNULL(t01_id_uni,'*')
INTO  _tipouser, _inst
FROM adm_usuarios
WHERE coduser = _user ;
IF _tipouser = 7 THEN 
SET _inst = SUBSTRING_INDEX(_inst,'.',1);
SELECT
  Inst.t01_id_inst, 
  Inst.t01_ruc_inst, 
  Inst.t01_sig_inst, 
  Inst.t01_nom_inst, 
  DATE_FORMAT(Inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
  FORMAT(Inst.t01_pres_anio,2) AS presup, 
  fn_verifica_url(Inst.t01_web_inst) AS t01_web_inst, 
  tipInst.descrip AS t01_tipo_inst
FROM      t01_dir_inst Inst
LEFT JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi)
WHERE Inst.t01_id_inst = (CASE WHEN _inst <> 0 THEN _inst ELSE Inst.t01_id_inst END )
ORDER BY Inst.t01_sig_inst ASC ;
END IF ;
IF _tipouser = 2 THEN 
SELECT
  Inst.t01_id_inst, 
  Inst.t01_ruc_inst, 
  Inst.t01_sig_inst, 
  Inst.t01_nom_inst, 
  DATE_FORMAT(Inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
  FORMAT(Inst.t01_pres_anio,2) AS presup, 
  fn_verifica_url(Inst.t01_web_inst) AS t01_web_inst, 
  tipInst.descrip AS t01_tipo_inst
FROM      t01_dir_inst Inst
LEFT JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi)
WHERE Inst.t01_id_inst = (CASE WHEN _inst <> 0 THEN _inst ELSE Inst.t01_id_inst END )
ORDER BY Inst.t01_sig_inst ASC ;
END IF ;
IF _tipouser <> 2 AND _tipouser <> 7 THEN 
SELECT
  Inst.t01_id_inst, 
  Inst.t01_ruc_inst, 
  Inst.t01_sig_inst, 
  Inst.t01_nom_inst, 
  DATE_FORMAT(Inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
  FORMAT(Inst.t01_pres_anio,2) AS presup, 
  fn_verifica_url(Inst.t01_web_inst) AS t01_web_inst, 
  tipInst.descrip AS t01_tipo_inst
FROM      t01_dir_inst Inst
LEFT JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi)
ORDER BY Inst.t01_sig_inst ASC ;
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_institucion_filter` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_institucion_filter`( IN _user  VARCHAR(20) , in _like varchar(50) )
BEGIN
DECLARE _tipouser INT ;
DECLARE _inst VARCHAR(10);
declare _idinst int ;
SELECT tipo_user, IFNULL(t01_id_uni,'*')
INTO  _tipouser, _inst
FROM adm_usuarios
WHERE coduser = _user ;
IF _tipouser = 7 THEN 
set _idinst = SUBSTRING_INDEX(_inst,'.',1);
SELECT
  Inst.t01_id_inst, 
  Inst.t01_ruc_inst, 
  Inst.t01_sig_inst, 
  Inst.t01_nom_inst, 
  DATE_FORMAT(Inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
  tipInst.descrip AS t01_tipo_inst
FROM      t01_dir_inst Inst
LEFT JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi)
WHERE (Inst.t01_sig_inst LIKE concat('%',_like,'%') OR Inst.t01_nom_inst LIKE CONCAT('%',_like,'%')) 
  and Inst.t01_id_inst = (CASE WHEN _idinst <> 0 THEN _idinst ELSE Inst.t01_id_inst END )

ORDER BY Inst.t01_sig_inst ASC ;
end if ;
IF _tipouser = 2 THEN 
   SET _idinst = _inst;
   
	SELECT
	  Inst.t01_id_inst, 
	  Inst.t01_ruc_inst, 
	  Inst.t01_sig_inst, 
	  Inst.t01_nom_inst, 
	  DATE_FORMAT(Inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
	  tipInst.descrip AS t01_tipo_inst
	FROM      t01_dir_inst Inst
	LEFT JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi)
	WHERE (Inst.t01_sig_inst LIKE CONCAT('%',_like,'%') OR Inst.t01_nom_inst LIKE CONCAT('%',_like,'%')) 
	  AND Inst.t01_id_inst = (CASE WHEN _idinst <> 0 THEN _idinst ELSE Inst.t01_id_inst END )

	ORDER BY Inst.t01_sig_inst ASC ;
end if;
IF _tipouser <> 2 and _tipouser <> 7 THEN 
SELECT
  Inst.t01_id_inst, 
  Inst.t01_ruc_inst, 
  Inst.t01_sig_inst, 
  Inst.t01_nom_inst, 
  DATE_FORMAT(Inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
  tipInst.descrip AS t01_tipo_inst
FROM      t01_dir_inst Inst
LEFT JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi)
WHERE (Inst.t01_sig_inst LIKE CONCAT('%',_like,'%') OR Inst.t01_nom_inst LIKE CONCAT('%',_like,'%')) 

ORDER BY Inst.t01_sig_inst ASC ;
end if ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_inst_monitoras` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_inst_monitoras`( IN _id_inst  INT  )
BEGIN
SELECT distinct
  Inst.t01_id_inst, 
  Inst.t01_ruc_inst, 
  Inst.t01_sig_inst, 
  Inst.t01_nom_inst, 
  fn_verifica_url(Inst.t01_web_inst) as t01_web_inst, 
  tipInst.descrip as t01_tipo_inst
FROM       t01_dir_inst  Inst
inner join t02_dg_proy   proy ON ( SUBSTRING_INDEX(proy.t02_moni_ext,'.',1)= Inst.t01_id_inst )
LEFT  JOIN adm_tablas_aux tipInst ON (Inst.t01_tipo_inst = tipInst.codi)
WHERE Inst.t01_id_inst = (CASE WHEN _id_inst <> 0 THEN _id_inst ELSE Inst.t01_id_inst END )
order by Inst.t01_sig_inst asc ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_mp_partidas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_mp_partidas`( IN _proy CHAR(10), IN _vs INT)
BEGIN
SELECT 	parti.t03_partida AS t03_partida,
	tab.cod_ext   AS codigo,
	concat(tab.cod_ext,'.-',tab.descrip)   AS partida,
	parti.t03_meta AS meta 
FROM t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux tab   ON(parti.t03_partida=tab.codi)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version  = _vs 
ORDER BY tab.cod_ext ASC;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_otros`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
select 	COUNT(*) AS total
from  t12_plan_otros 
where t02_cod_proy = _proy
AND t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_periodos_inf_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_periodos_inf_financ`(IN _proy CHAR(10))
BEGIN
declare _mi int;
select  inf.t40_periodo
into _mi
from t40_inf_financ AS inf
where inf.t02_cod_proy = _proy AND
inf.t40_mes=1 AND
inf.t40_anio=1;
SELECT  inf.t40_anio, 
	inf.t40_mes, 
	inf.t40_periodo,
	
	fn_numero_mes(inf.t40_anio, inf.t40_mes) as codigo,
	CONCAT('Mes ',fn_numero_mes(inf.t40_anio, inf.t40_mes),' (',mes.abreviado,' ',fn_numero_anio(year(p.t02_fch_ini),_mi,fn_numero_mes(inf.t40_anio, inf.t40_mes ) ) ,')') AS periodo
FROM 	  t40_inf_financ AS inf
LEFT JOIN v_meses_anio   AS mes ON(inf.t40_periodo=mes.idmes)
LEFT JOIN t02_dg_proy as p ON (inf.t02_cod_proy=p.t02_cod_proy)
where inf.t02_cod_proy = _proy 
AND p.t02_version=1
order by inf.t40_anio asc, 	inf.t40_mes asc;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_plan_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_plan_at`(IN _tipo INT,
                     IN _proy VARCHAR(10),
                     IN _ver INT,
                     IN _mod INT)
BEGIN
IF _tipo = 1 THEN  
  SELECT v.codmodulo,
     v.nommodulo,
     COUNT(v.codigo) AS numsub
    FROM ( 
    SELECT  CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS codigo,
        sub.t09_sub ,
        plan.t12_hor_cap,
        plan.t12_nro_ben,
        plan.t12_modulo AS codmodulo ,
        modu.descrip AS nommodulo
    FROM       t12_plan_at        plan 
    LEFT  JOIN t09_subact          sub  ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
    LEFT  JOIN adm_tablas_aux      modu ON(plan.t12_modulo=modu.codi)
    WHERE plan.t02_cod_proy = _proy
      AND plan.t02_version  = _ver
      and modu.descrip is not null
      ) v
    GROUP BY v.codmodulo, v.nommodulo ;
END IF ;
IF _tipo = 2 THEN  
  SELECT v.codigo,
     v.t09_sub,
     v.t12_hor_cap,
     COUNT(v.codigo) AS numtema
    FROM ( 
    SELECT  CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS codigo,
        sub.t09_sub ,
        plan.t12_hor_cap,
        plan.t12_nro_ben,
        plan.t12_modulo AS codmodulo ,
        modu.descrip AS nommodulo
    FROM       t12_plan_at        plan 
    LEFT  JOIN t09_subact          sub  ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
    LEFT  JOIN adm_tablas_aux      modu ON(plan.t12_modulo=modu.codi)
    WHERE plan.t02_cod_proy = _proy
      AND plan.t02_version  = _ver
      AND modu.descrip IS NOT NULL
      ) v
     WHERE v.codmodulo = _mod 
    GROUP BY  v.codigo, v.t09_sub, v.t12_hor_cap ;
END IF ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_plan_at_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_plan_at_trim`(  IN _tipo INT,
					 IN _proy VARCHAR(10) ,
				         IN _ver INT,
				         IN _mod INT
				         )
BEGIN
IF _tipo = 1 THEN  
  SELECT v.codmodulo,
	 v.nommodulo,
	 COUNT(v.codigo) AS numsub
    FROM ( 
	SELECT 	CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS codigo,
		sub.t09_sub ,
		plan.t12_hor_cap,
		plan.t12_nro_ben,
		plan.t12_modulo AS codmodulo ,
		modu.descrip AS nommodulo
	FROM 	   t12_plan_at        plan 
	LEFT  JOIN t09_subact          sub  ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
	LEFT  JOIN adm_tablas_aux      modu ON(plan.t12_modulo=modu.codi)
	WHERE plan.t02_cod_proy = _proy
	  AND plan.t02_version  = _ver
	  and modu.descrip is not null
	  ) v
    GROUP BY v.codmodulo, v.nommodulo ;
END IF ;
IF _tipo = 2 THEN  
  SELECT v.codigo,
	 v.t09_sub,
	 v.t12_hor_cap,
	 COUNT(v.codigo) AS numtema
    FROM ( 
	SELECT 	CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS codigo,
		sub.t09_sub ,
		plan.t12_hor_cap,
		plan.t12_nro_ben,
		plan.t12_modulo AS codmodulo ,
		modu.descrip AS nommodulo
	FROM 	   t12_plan_at        plan 
	LEFT  JOIN t09_subact          sub  ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
	LEFT  JOIN adm_tablas_aux      modu ON(plan.t12_modulo=modu.codi)
	WHERE plan.t02_cod_proy = _proy
	  AND plan.t02_version  = _ver
	  AND modu.descrip IS NOT NULL
	  ) v
     WHERE v.codmodulo = _mod 
    GROUP BY  v.codigo, v.t09_sub, v.t12_hor_cap ;
END IF ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_plan_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_plan_capac`(IN _tipo INT,
  IN _proy VARCHAR(10),  IN _ver INT, IN _mod INT,  IN _sub varchar(10))
BEGIN
IF _tipo = 1 THEN  
  SELECT v.codmodulo,
     v.nommodulo,
     count(v.codigo) as numsub
    from ( 
    SELECT  CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS codigo,
        sub.t09_sub ,
        tema.t12_cod_tema,
        tema.t12_tem_espe,
        tema.t12_nro_hora,
        tema.t12_nro_bene,
        plan.t12_modulo as codmodulo ,
        modu.descrip as nommodulo
    FROM       t12_plan_capac_tema tema
    INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
    LEFT  JOIN t09_subact          sub  ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
    LEFT  JOIN adm_tablas_aux      modu ON(plan.t12_modulo=modu.codi)
    WHERE tema.t02_cod_proy = _proy
      AND plan.t02_version  = _ver
      ) v
    group by v.codmodulo, v.nommodulo ;
end IF ;

IF _tipo = 2 THEN  
  SELECT v.codigo,
     v.t09_sub,
     COUNT(v.t12_cod_tema) as numtema
    FROM ( 
    SELECT  CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS codigo,
        sub.t09_sub ,
        tema.t12_cod_tema,
        tema.t12_tem_espe,
        tema.t12_nro_hora,
        tema.t12_nro_bene,
        plan.t12_modulo AS codmodulo ,
        modu.descrip AS nommodulo
    FROM       t12_plan_capac_tema tema
    INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
    LEFT  JOIN t09_subact          sub  ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
    LEFT  JOIN adm_tablas_aux      modu ON(plan.t12_modulo=modu.codi)
    WHERE tema.t02_cod_proy = _proy
      AND plan.t02_version  = _ver
      ) v
     where v.codmodulo = _mod 
    GROUP BY  v.codigo, v.t09_sub ;
END IF ;

IF _tipo = 3 THEN  
    SELECT  CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS codigo,
        sub.t09_sub ,
        tema.t12_cod_tema,
        tema.t12_tem_espe,
        tema.t12_nro_hora,
        tema.t12_nro_bene,
        plan.t12_modulo AS codmodulo ,
        modu.descrip AS nommodulo
    FROM       t12_plan_capac_tema tema
    INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
    LEFT  JOIN t09_subact          sub  ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
    LEFT  JOIN adm_tablas_aux      modu ON(plan.t12_modulo=modu.codi)
    WHERE tema.t02_cod_proy = _proy
      AND plan.t02_version  = _ver
      and plan.t12_modulo   = _mod
      and CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) = _sub ;
END IF ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_plan_cred_benef` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_plan_cred_benef`(IN _proy VARCHAR(10), IN _ver INT, IN _comp INT, 
in _act int,
 in _sub int)
BEGIN	
	select 	plan.t11_cod_benef, 
		CONCAT(ben.t11_ape_pat,' ', ben.t11_ape_mat, ', ', ben.t11_nom) AS nombres,
		ben.t11_dni AS dni,
		aux.descrip AS sexo,
		ben.t11_edad AS edad,
		ben.t11_direccion AS direccion,
		aux2.descrip AS nivel,
		plan.t12_mto_ben,
		plan.t12_nro_cuo,
		plan.t12_tasa_int
	from t12_plan_cred_benef plan
	left  join t11_bco_bene  ben on (plan.t02_cod_proy = ben.t02_cod_proy and plan.t11_cod_benef=ben.t11_cod_bene)
	LEFT JOIN adm_tablas_aux aux ON(ben.t11_sexo = aux.codi)
	LEFT JOIN adm_tablas_aux aux2 ON(ben.t11_nivel_educ = aux.codi)
	where plan.t02_cod_proy = _proy 
	  and plan.t02_version = _ver
	  and plan.t08_cod_comp = _comp 
	  and plan.t09_cod_act  = _act
	  and plan.t09_cod_sub  = _sub
	  order by nombres asc ;
	  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_plan_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_plan_otros`(IN _tipo INT, IN _proy VARCHAR(10), IN _ver INT, IN _mod INT)
BEGIN
	IF _tipo = 1 THEN  
	  SELECT v.codtipo,
	     v.nomtipo,
	     COUNT(v.codigo) AS numsub
	    FROM ( 
	    SELECT  CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS codigo,
	        sub.t09_sub ,
	        plan.t12_nro_ent,
	        plan.t12_nro_ben,
	        plan.t12_tipo AS codtipo,
	        tip.descrip AS nomtipo
	    FROM t12_plan_otros plan 
	    LEFT  JOIN t09_subact sub ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
	    LEFT  JOIN adm_tablas_aux tip ON(plan.t12_tipo=tip.codi)
	    WHERE plan.t02_cod_proy = _proy
	      AND plan.t02_version  = _ver
	      and tip.descrip is not null
	      ) v
	    GROUP BY v.codtipo, v.nomtipo ;
	END IF ;
	IF _tipo = 2 THEN  
	  SELECT v.codigo,
	     v.t09_sub,
	     COUNT(v.codigo) AS numtema
	    FROM ( 
	    SELECT  CONCAT(plan.t08_cod_comp,'.',plan.t09_cod_act,'.',plan.t09_cod_sub) AS codigo,
	        sub.t09_sub,
	        plan.t12_nro_ent,
	        plan.t12_nro_ben,
	        plan.t12_tipo AS codtipo,
	        tip.descrip AS nomtipo
	    FROM t12_plan_otros plan 
	    LEFT JOIN t09_subact sub ON(plan.t02_cod_proy=sub.t02_cod_proy AND plan.t02_version=sub.t02_version AND plan.t08_cod_comp=sub.t08_cod_comp AND plan.t09_cod_act=sub.t09_cod_act AND plan.t09_cod_sub=sub.t09_cod_sub)
	    LEFT JOIN adm_tablas_aux tip ON(plan.t12_tipo=tip.codi)
	    WHERE plan.t02_cod_proy = _proy
	      AND plan.t02_version  = _ver
	      AND tip.descrip IS NOT NULL
	      ) v
	     WHERE v.codtipo = _mod 
	    GROUP BY  v.codigo, v.t09_sub ;
	END IF ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_presup_ejec_men` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_presup_ejec_men`(IN _proy VARCHAR(10), IN _comp INT, IN _activ INT, IN _subactiv INT, IN _cat INT, IN _anio INT, IN _nivel INT, IN _cod_fte INT)
BEGIN
	
	IF _nivel = 0 THEN
		SELECT  t40_mes, IFNULL(SUM(t41_gasto),0) as total_ejec
		FROM t41_inf_financ_gasto
		WHERE t02_cod_proy = _proy
		AND t08_cod_comp = _comp
		AND t40_anio = _anio
		AND t41_fte_finan = _cod_fte
		GROUP BY t40_mes
		ORDER BY t40_mes ASC;	
	END IF;
	
	IF _nivel = 1 THEN
		SELECT  t40_mes, IFNULL(SUM(t41_gasto),0) as total_ejec
		FROM t41_inf_financ_gasto
		WHERE t02_cod_proy = _proy
		AND t08_cod_comp = _comp
		AND t09_cod_act = _activ
		AND t40_anio = _anio
		AND t41_fte_finan = _cod_fte
		GROUP BY t40_mes
		ORDER BY t40_mes ASC;	
	END IF;
	 IF _nivel = 2 THEN
		SELECT t40_mes, IFNULL(SUM(t41_gasto), 0) AS total_ejec
		FROM t41_inf_financ_gasto
		WHERE t02_cod_proy = _proy
		AND t08_cod_comp = _comp
		AND t09_cod_act = _activ
		AND t40_anio = _anio
		AND t09_cod_sub = _subactiv
		AND t41_fte_finan = _cod_fte
		GROUP BY t40_mes
		ORDER BY t40_mes ASC;
	END IF;
	 IF _nivel = 3 THEN
		SELECT t40_mes, IFNULL(SUM(t41_gasto), 0) AS total_ejec
		FROM t41_inf_financ_gasto
		WHERE t02_cod_proy = _proy
		AND t08_cod_comp = _comp
		AND t09_cod_act = _activ
		AND t40_anio = _anio
		AND t09_cod_sub = _subactiv
		AND t41_fte_finan = _cod_fte
		AND t41_cate_gasto = _cat
		GROUP BY t40_mes
		ORDER BY t40_mes ASC;
	END IF;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_presup_gastoAcum_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_presup_gastoAcum_mes`(IN _proy VARCHAR(10), IN _mes INT, IN _ver INT)
BEGIN
	 
	 
	 
   
	 
	
	
	
	
	
	
	
	
	
	  SELECT sub.t02_version, CONCAT(sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo, mta.t09_mes AS mes, mta.t09_mta AS meta,
					fn_costos_parciales(_proy, sub.t02_version, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub) AS costo_par,
					(mta.t09_mta*fn_costos_parciales(_proy, sub.t02_version, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub)) as presupuesto,
					fn_gasto_mensual_cto_fte(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub,mta.t09_mes, 1) AS gasto_men
					
					
	  FROM t10_cost_sub sub
	  INNER JOIN t09_sub_act_mtas mta ON (mta.t02_cod_proy = sub.t02_cod_proy AND mta.t08_cod_comp = sub.t08_cod_comp AND mta.t09_cod_act = sub.t09_cod_act AND mta.t09_cod_sub = sub.t09_cod_sub)
    WHERE sub.t02_cod_proy = _proy
		AND sub.t02_version = _ver
	  AND mta.t09_anio = sub.t02_version - 1
		AND mta.t09_mes = _mes
		
	  GROUP BY sub.t02_version, mes,2;

		
	
	
	
	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_proyectos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_proyectos`(IN _inst INT)
BEGIN
SELECT
  inst.t01_sig_inst AS ejecutor,
  proy.t02_cod_proy AS codigo,
  proy.t02_nro_exp AS 'exp', 
  proy.t02_version AS vs,
  proy.t02_nom_proy AS nombre,
	proy.env_rev,
  DATE_FORMAT((CASE WHEN proy.t02_fch_ini=0 THEN NULL ELSE proy.t02_fch_ini END),'%d/%m/%Y') AS inicio, 
  DATE_FORMAT((CASE WHEN proy.t02_fch_ter=0 THEN NULL ELSE proy.t02_fch_ter END),'%d/%m/%Y') AS termino,  
  FORMAT(fn_costos_total_proyecto(proy.t02_cod_proy,1),2) AS t02_pres_tot
FROM
  t02_dg_proy proy
LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy) 
  AND proy.t01_id_inst  = (CASE WHEN _inst='*' THEN proy.t01_id_inst ELSE _inst END ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_proyectos_ejec_desemb_entre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_proyectos_ejec_desemb_entre`(IN _inst INT)
BEGIN

SELECT

  inst.t01_sig_inst AS ejecutor,
  proy.t02_cod_proy AS codigo,    
  proy.t02_version AS vs,
  proy.t02_nom_proy AS nombre,
	proy.env_rev,
  DATE_FORMAT((CASE WHEN proy.t02_fch_ini=0 THEN NULL ELSE proy.t02_fch_ini END),'%d/%m/%Y') AS inicio, 
  DATE_FORMAT((CASE WHEN proy.t02_fch_ter=0 THEN NULL ELSE proy.t02_fch_ter END),'%d/%m/%Y') AS termino,  
  FORMAT(fn_costos_total_proyecto(proy.t02_cod_proy,1),2) AS t02_pres_tot, 
 COUNT(entre.t02_cod_proy) AS total_entre 
FROM
  t02_entregable entre, t02_dg_proy proy

LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy) 
  AND proy.t01_id_inst  = (CASE WHEN _inst='*' THEN proy.t01_id_inst ELSE _inst END ) 
  AND proy.t02_cod_proy = entre.t02_cod_proy  
GROUP BY proy.t02_cod_proy ;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_proyectos_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_proyectos_mf`(IN _id_uni_mt INT)
BEGIN
SELECT
  inst.t01_sig_inst AS ejecutor,
  proy.t02_cod_proy AS codigo,
  proy.t02_nro_exp AS 'exp', 
  proy.t02_version AS vs,
  proy.t02_nom_proy AS nombre,
	proy.env_rev,
  DATE_FORMAT((CASE WHEN proy.t02_fch_ini=0 THEN NULL ELSE proy.t02_fch_ini END),'%d/%m/%Y') AS inicio, 
  DATE_FORMAT((CASE WHEN proy.t02_fch_ter=0 THEN NULL ELSE proy.t02_fch_ter END),'%d/%m/%Y') AS termino,  
  FORMAT(fn_costos_total_proyecto(proy.t02_cod_proy,1),2) AS t02_pres_tot,
	aprobProy.t02_vb_proy AS vbProyecto,
	aprobProy.t02_aprob_proy As aprPoyecto
	
FROM
  t02_dg_proy proy
LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
LEFT JOIN t02_aprob_proy aprobProy ON (proy.t02_cod_proy=aprobProy.t02_cod_proy)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy) 
  AND proy.t02_moni_fina  = (CASE WHEN _id_uni_mt ='*' THEN proy.t01_id_inst ELSE _id_uni_mt END ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_proyectos_monit` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_proyectos_monit`()
BEGIN
	SELECT t02_cod_proy, t02_version
	FROM t02_dg_proy;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_proyectos_mt` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_proyectos_mt`(IN _id_uni_mt INT)
BEGIN
SELECT
  inst.t01_sig_inst AS ejecutor,
  proy.t02_cod_proy AS codigo,
  proy.t02_nro_exp AS 'exp', 
  proy.t02_version AS vs,
  proy.t02_nom_proy AS nombre,
	proy.env_rev,
  DATE_FORMAT((CASE WHEN proy.t02_fch_ini=0 THEN NULL ELSE proy.t02_fch_ini END),'%d/%m/%Y') AS inicio, 
  DATE_FORMAT((CASE WHEN proy.t02_fch_ter=0 THEN NULL ELSE proy.t02_fch_ter END),'%d/%m/%Y') AS termino,  
  FORMAT(fn_costos_total_proyecto(proy.t02_cod_proy,1),2) AS t02_pres_tot,
	aprobProy.t02_vb_proy  AS vbProyecto,
	aprobProy.t02_aprob_proy As aprPoyecto,
	proy.t02_moni_tema as mtecnico,
	proy.t02_moni_fina as mfinanciero
FROM
  t02_dg_proy proy
LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
LEFT JOIN t02_aprob_proy aprobProy ON (proy.t02_cod_proy=aprobProy.t02_cod_proy)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy) 
  AND proy.t01_id_inst  = proy.t01_id_inst ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_proy_alt` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_proy_alt`()
BEGIN
	
	SELECT *
	FROM t02_dg_proy
	GROUP BY t02_cod_proy;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_resumen_gastos_comp_fte` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_resumen_gastos_comp_fte`(_proy VARCHAR(10), _ver INT)
BEGIN
DECLARE _contador INT ;
DECLARE _rowcount INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _sql      TEXT;
DECLARE _subquery TEXT;
DECLARE _sqlMP      TEXT;
DECLARE _subqueryMP TEXT;
DROP TEMPORARY TABLE IF EXISTS tmpFuentes;
DROP TEMPORARY TABLE IF EXISTS tmpFuentesMP;
CREATE TEMPORARY TABLE tmpFuentes 
( id INT AUTO_INCREMENT,
  idfte INT,
  nomfte VARCHAR(250),
  PRIMARY KEY (id)
) ;
CREATE TEMPORARY TABLE tmpFuentesMP 
( id INT AUTO_INCREMENT,
  actividad VARCHAR(50) ,
  idfte INT,
  nomfte VARCHAR(250),
  total  DOUBLE,
  PRIMARY KEY (id)
) ;
INSERT INTO tmpFuentes(idfte, nomfte)
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
LEFT JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy ;
INSERT INTO tmpFuentesMP(actividad, idfte, nomfte, total)
SELECT 'Personal del Proyecto' AS Actividad,
	f.t01_id_inst,
	i.t01_sig_inst,
	IFNULL(SUM(fte.t03_monto),0) AS total_fuente
FROM       t02_fuente_finan f
LEFT  JOIN t01_dir_inst     i   ON(f.t01_id_inst = i.t01_id_inst)
LEFT  JOIN t03_mp_per_ftes  fte ON(f.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND f.t01_id_inst=fte.t03_id_inst)
WHERE f.t02_cod_proy=_proy
GROUP BY 1,2,3
UNION ALL
SELECT 'Equipamiento del Proyecto' AS Actividad,
	f.t01_id_inst,
	i.t01_sig_inst,
	IFNULL(SUM(fte.t03_monto),0) AS total_fuente
FROM       t02_fuente_finan f
LEFT  JOIN t01_dir_inst     i   ON(f.t01_id_inst = i.t01_id_inst)
LEFT  JOIN t03_mp_equi_ftes  fte ON(f.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND f.t01_id_inst=fte.t03_id_inst)
WHERE f.t02_cod_proy=_proy
GROUP BY 1,2,3
UNION ALL
SELECT 'Gastos de Funcionamiento' AS Actividad,
	f.t01_id_inst,
	i.t01_sig_inst,
	IFNULL(SUM(fte.t03_monto),0) AS total_fuente
FROM       t02_fuente_finan f
LEFT  JOIN t01_dir_inst     i   ON(f.t01_id_inst = i.t01_id_inst)
LEFT  JOIN t03_mp_gas_fun_ftes  fte ON(f.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND f.t01_id_inst=fte.t03_id_inst)
WHERE f.t02_cod_proy=_proy
GROUP BY 1,2,3 ;
SELECT '
SELECT  CONCAT(cmp.t08_cod_comp, ".-" ,cmp.t08_comp_desc) AS componente,
	SUM((c.t10_cu * c.t10_cant)* s.t09_mta) AS costo_total'
INTO _sql ;
SELECT ' UNION ALL 
	SELECT 	\'Manejo del Proyecto \',
		SUM(total) AS costo_total'
INTO _sqlMP;
SELECT 1 INTO _contador ;  
WHILE (SELECT COUNT(1) FROM  tmpFuentes) >= _contador DO
	SELECT idfte  ,  nomfte
	INTO   _codfte, _nomfte 
	FROM tmpFuentes 
	WHERE id = _contador;
	
	SELECT   CONCAT(', 
		 (SELECT SUM( (CASE WHEN fte.t01_id_inst=',_codfte,' THEN fte.t10_mont ELSE 0 END ))
		    FROM t10_cost_fte fte 
		   WHERE fte.t02_cod_proy=c.t02_cod_proy 
		     AND fte.t02_version =c.t02_version 
		     AND fte.t08_cod_comp=c.t08_cod_comp ) as \'', _nomfte, '\'') INTO _subquery ;
	SELECT CONCAT(_sql, _subquery) INTO _sql ;
	
	SELECT CONCAT(',
		       SUM(CASE WHEN idfte=',_codfte,' THEN total ELSE 0 END) AS \'', _nomfte, '\'' ) INTO _subqueryMP;
	SELECT CONCAT(_sqlMP, _subqueryMP) INTO _sqlMP ;
	
	SET _contador = _contador + 1;
END WHILE;
SELECT CONCAT( _sql , 
	      ' FROM  	   t10_cost_sub c
		INNER JOIN t09_subact   s   ON(c.t02_cod_proy=s.t02_cod_proy AND c.t02_version=s.t02_version AND c.t08_cod_comp=s.t08_cod_comp AND c.t09_cod_act=s.t09_cod_act AND c.t09_cod_sub=s.t09_cod_sub)
		INNER JOIN t08_comp     cmp ON(c.t02_cod_proy=cmp.t02_cod_proy AND c.t02_version=cmp.t02_version AND c.t08_cod_comp=cmp.t08_cod_comp) 
		WHERE c.t02_cod_proy = ', '\'', _proy , '\'' ,
		' AND c.t02_version  = ', _ver,
		' GROUP BY 1 \n') INTO _sql;
		
SELECT CONCAT( _sqlMP, ' \n FROM tmpFuentesMP') INTO _sqlMP ;
SELECT CONCAT(_sql, _sqlMP) INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt; 
DROP TEMPORARY TABLE tmpFuentes;
DROP TEMPORARY TABLE tmpFuentesMP;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_temas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_temas`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
select 	COUNT(*) AS total
from  t12_plan_capac_tema 
where t02_cod_proy = _proy
  and t02_version  = _ver
order by t12_tem_espe ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_lis_tipo_inst_rel_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_lis_tipo_inst_rel_fe`( IN _inst INT )
BEGIN
	DECLARE _codtipint VARCHAR(100);
	
	SELECT t01_rel_fe
	  INTO _codtipint
	  FROM t01_dir_inst 
	 WHERE t01_id_inst = _inst ;
	 
	 SET _codtipint = IFNULL(_codtipint,'-1') ;
	SELECT codi, descrip , '1' AS estado, orden
	FROM adm_tablas_aux 
	WHERE idTabla = 29
	  AND _codtipint LIKE CONCAT('%',codi,'%') 
	  AND flg_act = 1
	UNION 
	
	SELECT codi, descrip , '0' AS estado, orden
	FROM adm_tablas_aux 
	WHERE idTabla = 29
	  AND _codtipint NOT LIKE CONCAT('%',codi,'%') 	
	  AND flg_act = 1 
	  
	ORDER BY orden ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_login` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_login`(IN _usr varchar(20),
			    in _pwd varchar(20),
			    in _ip1 varchar(15),
			    in _ip2 varchar(15),
			    IN _idses VARCHAR(50)
			    )
BEGIN
declare _existe int ;
declare _numAcceso long ;
declare _session_anterior varchar(50);
SELECT  count(1)
  into  _existe
  FROM  adm_usuarios
WHERE coduser=_usr 
  AND clave_user=MD5(_pwd);
if _existe > 0 then

select ifnull(max(idacceso),0)+1
into _numAcceso
from adm_usuarios_accesos
where coduser=_usr ;
INSERT INTO adm_usuarios_accesos (
				   coduser, 
				   idacceso, 
				   fch_ini, 
				   fch_fin, 
				   pub_ip, 
				   pri_ip 
				 )
			  VALUES ( _usr,  
				   _numAcceso,
				   NOW(), 
				   NULL, 
				   _ip1,
				   _ip2
				 );
SELECT IFNULL(id_session,'')
INTO _session_anterior
FROM adm_usuarios_activos 
WHERE coduser = _usr ;

CALL sp_upd_usuarios_activos(_usr,_ip1, _idses );
end if;
SELECT  usu.coduser, 
	usu.tipo_user as idperfil, 
	usu.nom_user, 
	usu.mail, 
	usu.estado,
	per.per_des as perfil, 
	IFNULL(usu.t01_id_uni,-1) AS t01_id_uni,
	ifnull(usu.t02_cod_proy,'*') as  t02_cod_proy,
	fn_ult_version_proy(usu.t02_cod_proy) as t02_version,
	_numAcceso as idacceso,
	_session_anterior as 'sesion_anterior'
FROM  adm_usuarios usu
left join adm_perfiles per on (usu.tipo_user=per.per_cod)
WHERE usu.coduser=_usr 
  and usu.clave_user=MD5(_pwd);
  
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ml_equi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ml_equi`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
	SELECT e.t03_id_equi,  e.t03_nom_equi,  e.t03_um, mta.t03_anio, mta.t03_mes, mta.t03_mta
	 FROM t03_mp_equi_metas mta 
	 INNER JOIN t03_mp_equi e ON (e.t02_cod_proy = mta.t02_cod_proy AND e.t02_version = mta.t02_version AND e.t03_id_equi=mta.t03_id_equi)
	 WHERE mta.t02_cod_proy=_proy 
	   AND mta.t02_version= _ver
	GROUP BY e.t03_id_equi;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ml_partida` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_ml_partida`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
		SELECT p.cod_ext,p.descrip, mta.t03_um, mta.t03_partida,  mta.t03_meta,  mta2.t03_anio, mta2.t03_mes, mta2.t03_mta AS meta
	 FROM t03_mp_gas_fun_part mta 
LEFT JOIN adm_tablas_aux  p  ON(mta.t03_partida=p.codi)
LEFT  JOIN t03_mp_gas_fun_metas mta2 ON(mta2.t02_cod_proy=mta.t02_cod_proy AND mta2.t02_version=mta.t02_version AND mta2.t03_partida=mta.t03_partida)
	 WHERE mta.t02_cod_proy=_proy 
	   AND mta.t02_version= _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_ml_per` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_ml_per`(IN _proy VARCHAR(10),  IN _ver INT)
BEGIN

SELECT  anio.t02_cod_proy, 
	anio.t02_version , 	
	per.t03_nom_per,
	aux.abrev, 	
	anio.t02_anio,
	per.t03_id_per,
	COUNT(anio.t02_anio) AS totalMeta,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=1 THEN mta.t03_mta ELSE 0 END) AS t03_mes1,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=2 THEN mta.t03_mta ELSE 0 END) AS t03_mes2,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=3 THEN mta.t03_mta ELSE 0 END) AS t03_mes3,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=4 THEN mta.t03_mta ELSE 0 END) AS t03_mes4,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=5 THEN mta.t03_mta ELSE 0 END) AS t03_mes5,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=6 THEN mta.t03_mta ELSE 0 END) AS t03_mes6,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=7 THEN mta.t03_mta ELSE 0 END) AS t03_mes7,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=8 THEN mta.t03_mta ELSE 0 END) AS t03_mes8,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=9 THEN mta.t03_mta ELSE 0 END) AS t03_mes9,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=10 THEN mta.t03_mta ELSE 0 END) AS t03_mes10,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=11 THEN mta.t03_mta ELSE 0 END) AS t03_mes11,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=12 THEN mta.t03_mta ELSE 0 END) AS t03_mes12,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio THEN mta.t03_mta ELSE 0 END) AS t03_tot_anio
	
FROM       t02_duracion     anio
LEFT  JOIN t03_mp_per       per ON (anio.t02_cod_proy=per.t02_cod_proy AND anio.t02_version=per.t02_version )
LEFT  JOIN t03_mp_per_metas mta ON (per.t02_cod_proy=mta.t02_cod_proy AND per.t02_version=mta.t02_version AND per.t03_id_per=mta.t03_id_per)
LEFT JOIN adm_tablas_aux aux ON (per.t03_um=aux.codi)

 WHERE anio.t02_cod_proy= _proy
   AND anio.t02_version = _ver
GROUP BY 1,2,3,4,5 

order by per.t03_id_per, t02_anio ASC;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_otros_x_inf_tri` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_otros_x_inf_tri`(IN _proy VARCHAR(10), IN _anio INT, IN _trim INT)
BEGIN
	SELECT	COUNT(*) AS capacitados
	FROM(	SELECT	plan.t11_cod_bene, SUM(plan.t15_avance) AS total
			FROM	t25_inf_trim_otros plan
			WHERE	plan.t02_cod_proy = _proy AND plan.t25_anio = _anio AND plan.t25_trim = _trim
			GROUP BY plan.t11_cod_bene) t
	WHERE t.total > 0;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_plan_at_dup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_plan_at_dup`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
	INSERT INTO t12_plan_at
	SELECT
		c.t02_cod_proy,
		_ver+1,
		c.t08_cod_comp,
		c.t09_cod_act,
		c.t09_cod_sub,
		c.t12_nro_tema,
		c.t12_hor_cap,
		c.t12_nro_ben,
		c.t12_conten,
		c.t12_modulo,
		NOW(),
		c.usr_crea,
		c.usr_actu,
		c.fch_actu,
		c.est_audi
	FROM t12_plan_at	c
	WHERE c.t02_cod_proy = _proy
	AND c.t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_plan_cre_dup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_plan_cre_dup`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
	INSERT INTO t12_plan_cred
	SELECT
		c.t02_cod_proy,
		_ver+1,
		c.t08_cod_comp,
		c.t09_cod_act,
		c.t09_cod_sub,
		c.t12_nro_ben,
		c.t12_mto_ben,
		c.t12_nro_cuo,
		c.t12_tasa_int,
		c.t12_obs,
		NOW(),
		c.usr_crea,
		c.usr_actu,
		c.fch_actu,
		c.est_audi
	FROM t12_plan_cred	c
	WHERE c.t02_cod_proy = _proy
	AND c.t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_plan_otros_dup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_plan_otros_dup`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
	INSERT INTO t12_plan_otros
	SELECT
		c.t02_cod_proy,
		_ver+1,
		c.t08_cod_comp,
		c.t09_cod_act,
		c.t09_cod_sub,
		c.t12_producto,
		c.t12_nro_ent,
		c.t12_nro_ben,
		c.t12_tot_ent,
		c.t12_conten,
		c.t12_tipo,
		NOW(),
		c.usr_crea,
		c.usr_actu,
		c.fch_actu,
		c.est_audi
	FROM t12_plan_otros	c
	WHERE c.t02_cod_proy = _proy
	AND c.t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_actualiza_metas_reprogramadas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_actualiza_metas_reprogramadas`(IN _proy VARCHAR(10), IN _anio INT)
BEGIN
declare _total double ;
declare _ver int default fn_version_proy_poa(_proy, _anio) ;
declare _num_anios int default fn_duracion_proy(_proy,1);
if _anio = 1 then
    
    UPDATE t09_subact s
 LEFT JOIN t09_subact s1 ON( s1.t02_cod_proy = s.t02_cod_proy AND s1.t02_version  = 1 AND s1.t08_cod_comp = s.t08_cod_comp AND s1.t09_cod_act  = s.t09_cod_act AND s1.t09_cod_sub  = s.t09_cod_sub)
      SET  s.t09_mta_proy  = s1.t09_mta - IFNULL(s.t09_mta,0),
	   s.t09_mta_repro = s1.t09_mta
 WHERE s.t02_cod_proy = _proy 
   AND s.t02_version  = _ver   ;
    
  
  
  
    
     
  
  
  
  
end if ;
IF _anio > 1 and _anio < _num_anios THEN
   
     
    UPDATE t09_subact s
 LEFT JOIN t09_subact s1 ON( s1.t02_cod_proy = s.t02_cod_proy AND s1.t02_version  = s.t02_version -1 AND s1.t08_cod_comp = s.t08_cod_comp AND s1.t09_cod_act  = s.t09_cod_act AND s1.t09_cod_sub  = s.t09_cod_sub)
       SET s.t09_mta_proy  = (s1.t09_mta_repro - (  IFNULL(s.t09_mta,0) + 
						    IFNULL((SELECT SUM(i.t09_sub_avanc)  
						               FROM t09_act_sub_mtas_inf i 
						              WHERE i.t02_cod_proy=s.t02_cod_proy 
						                AND i.t08_cod_comp=s.t08_cod_comp
						                AND i.t09_cod_act=s.t09_cod_act 
						                AND i.t09_cod_sub=s.t09_cod_sub 
						                AND i.t09_sub_anio < _anio
						            ),0)
						   )
				),
	    s.t09_mta_repro  = ((s1.t09_mta_repro - (  IFNULL(s.t09_mta,0) + 
						    IFNULL((SELECT SUM(i.t09_sub_avanc)  
						               FROM t09_act_sub_mtas_inf i 
						              WHERE i.t02_cod_proy=s.t02_cod_proy 
						                AND i.t08_cod_comp=s.t08_cod_comp
						                AND i.t09_cod_act=s.t09_cod_act 
						                AND i.t09_cod_sub=s.t09_cod_sub 
						                AND i.t09_sub_anio < _anio
						            ),0)
						   )
				) + IFNULL(s.t09_mta,0))
 WHERE s.t02_cod_proy = _proy
   AND s.t02_version  = _ver   ;
   
   
 
END IF ;
IF _anio > 1 AND _anio = _num_anios THEN
   
     
    UPDATE t09_subact s
 LEFT JOIN t09_subact s1 ON( s1.t02_cod_proy = s.t02_cod_proy AND s1.t02_version  = s.t02_version -1 AND s1.t08_cod_comp = s.t08_cod_comp AND s1.t09_cod_act  = s.t09_cod_act AND s1.t09_cod_sub  = s.t09_cod_sub)
       SET  s.t09_mta_proy  = 0 ,
	    s.t09_mta_repro  = (IFNULL(s.t09_mta,0) + 
						    IFNULL((SELECT SUM(i.t09_sub_avanc)  
						               FROM t09_act_sub_mtas_inf i 
						              WHERE i.t02_cod_proy=s.t02_cod_proy 
						                AND i.t08_cod_comp=s.t08_cod_comp
						                AND i.t09_cod_act=s.t09_cod_act 
						                AND i.t09_cod_sub=s.t09_cod_sub 
						                AND i.t09_sub_anio < _anio
						            ),0)
				)
 WHERE s.t02_cod_proy = _proy
   AND s.t02_version  = _ver   ;
   
   
 
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_actualiza_presupuesto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_actualiza_presupuesto`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
DECLARE _anio INT;
DECLARE _total DOUBLE ;
SELECT fn_anio_x_version_proy(_proy, _ver) INTO _anio ;
IF _anio > 0 THEN
    
  UPDATE t09_subact s
    SET s.t09_mta = (SELECT SUM(m.t09_mta) 
               FROM t09_sub_act_mtas m
              WHERE m.t02_cod_proy = s.t02_cod_proy
                AND m.t02_version  = s.t02_version  
                AND m.t08_cod_comp = s.t08_cod_comp
                AND m.t09_cod_act  = s.t09_cod_act
                AND m.t09_cod_sub  = s.t09_cod_sub
                AND m.t09_anio = _anio
            )
 WHERE s.t02_cod_proy = _proy 
   AND s.t02_version  = _ver   ;
  
  UPDATE t10_cost_sub c
    SET c.t10_cost_tot = (c.t10_cost_parc * IFNULL((SELECT s.t09_mta 
               FROM t09_subact s
              WHERE s.t02_cod_proy = c.t02_cod_proy
                AND s.t02_version  = c.t02_version  
                AND s.t08_cod_comp = c.t08_cod_comp
                AND s.t09_cod_act  = c.t09_cod_act
                AND s.t09_cod_sub  = c.t09_cod_sub
            ),0))
 WHERE c.t02_cod_proy = _proy 
   AND c.t02_version  = _ver  ;
  
    
  
  UPDATE t03_mp_per p
     SET p.t03_gasto_tot = (IFNULL((SELECT SUM(m.t03_mta) 
                      FROM t03_mp_per_metas m 
                     WHERE m.t02_cod_proy = p.t02_cod_proy
                       AND m.t02_version  = p.t02_version
                       AND m.t03_id_per   = p.t03_id_per 
                       AND m.t03_anio = _anio),0) * p.t03_remu_prom)
  WHERE p.t02_cod_proy = _proy
    AND p.t02_version  = _ver   ;
  
  UPDATE t03_mp_equi e
     SET e.t03_costo_tot = (IFNULL((SELECT SUM(m.t03_mta) 
                      FROM t03_mp_equi_metas m 
                     WHERE m.t02_cod_proy = e.t02_cod_proy
                       AND m.t02_version  = e.t02_version
                       AND m.t03_id_equi   = e.t03_id_equi 
                       AND m.t03_anio = _anio),0) * e.t03_costo)
  WHERE e.t02_cod_proy = _proy
    AND e.t02_version  = _ver   ;
    
 
 UPDATE t03_mp_gas_fun_part p
   SET p.t03_meta = IFNULL((SELECT SUM(m.t03_mta) 
                  FROM t03_mp_gas_fun_metas m 
                 WHERE m.t02_cod_proy = p.t02_cod_proy
                   AND m.t02_version  = p.t02_version
                   AND m.t03_partida  = p.t03_partida 
                   AND m.t03_anio = _anio),0)
 WHERE p.t02_cod_proy = _proy 
   AND p.t02_version  = _ver  ;
  
     
  
  
  UPDATE t10_cost_fte
     SET t10_mont = fn_poa_aporte_fte_financ_rubro(t02_cod_proy, _anio, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cod_fte)
   WHERE t02_cod_proy = _proy
     AND t02_version = _ver ;
   
  
  UPDATE t03_mp_per_ftes
     SET t03_monto = fn_poa_aporte_fte_financ_pers(t02_cod_proy, _anio, t03_id_per, t03_id_inst)
   WHERE t02_cod_proy = _proy
     AND t02_version  = _ver;
     
  
  UPDATE t03_mp_equi_ftes
     SET t03_monto = fn_poa_aporte_fte_financ_equi(t02_cod_proy, _anio, t03_id_equi, t03_id_inst)
   WHERE t02_cod_proy = _proy
     AND t02_version  = _ver;
     
  
  UPDATE  t03_mp_gas_fun_ftes
     SET  t03_monto = fn_poa_aporte_fte_gast_func(t02_cod_proy, _anio, t03_partida, t03_id_gasto , t03_id_inst)
   WHERE  t02_cod_proy = _proy
     AND  t02_version  = _ver;
   
  UPDATE  t03_mp_gas_adm
     SET  t03_monto = fn_gastos_adm_anual(t02_cod_proy, t03_id_inst, _anio )
   WHERE  t02_cod_proy = _proy
     AND  t02_version  = _ver ;
  
   UPDATE t03_mp_linea_base 
      SET t03_monto = fn_linea_base_anual(t02_cod_proy, 10 , _anio ) 
    WHERE  t02_cod_proy = _proy  AND  t02_version  = _ver; 
   
   UPDATE t03_mp_imprevistos 
      SET t03_monto = fn_imprevistos_anual(t02_cod_proy, 10 , _anio) 
    WHERE  t02_cod_proy = _proy  AND  t02_version  = _ver;  
   
   UPDATE t03_mp_gas_supervision 
      SET t03_monto = fn_supervision_anual(t02_cod_proy, 10 , _anio)
    WHERE  t02_cod_proy = _proy  AND  t02_version  = _ver;
 
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_eliminar` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_eliminar`(
IN _proy VARCHAR(10), 
IN _anio  INT)
trans1 : BEGIN
    DECLARE _ver  INT DEFAULT  fn_version_proy_poa(_proy, _anio);
    DECLARE _existe INT;
    DECLARE _rowsaffect INT;
    SELECT COUNT(1) INTO _existe 
    FROM t02_poa 
     WHERE t02_cod_proy=_proy AND t02_anio=_anio AND t02_estado=135;
    IF _existe > 0 THEN
    SELECT 0 AS numrows, CONCAT('El POA, del Año: ',_anio,', tiene el VB del Gestor de Proyectos.') AS msg;
    LEAVE trans1;
    END IF;
     SET AUTOCOMMIT=0;
     START TRANSACTION;
    
    DELETE FROM t20_inf_mes WHERE t02_cod_proy=_proy AND t20_anio = _anio;
    DELETE FROM t09_act_ind_mtas_inf WHERE t02_cod_proy=_proy AND t09_ind_anio = _anio;
    DELETE FROM t09_act_sub_mtas_inf WHERE t02_cod_proy=_proy AND t09_sub_anio = _anio;
    DELETE FROM t25_inf_trim WHERE t02_cod_proy=_proy AND t25_anio = _anio;
    DELETE FROM t25_inf_trim_anx WHERE t02_cod_proy=_proy AND t25_anio = _anio;
    DELETE FROM t25_inf_trim_at WHERE t02_cod_proy=_proy AND t25_anio = _anio;
    DELETE FROM t25_inf_trim_capac WHERE t02_cod_proy=_proy AND t25_anio = _anio;
    DELETE FROM t25_inf_trim_cred WHERE t02_cod_proy=_proy AND t25_anio = _anio;
    DELETE FROM t25_inf_trim_otros WHERE t02_cod_proy=_proy AND t25_anio = _anio;
    DELETE FROM t08_comp_ind_inf WHERE t02_cod_proy=_proy AND t08_ind_anio = _anio;
    DELETE FROM t07_prop_ind_inf WHERE t02_cod_proy=_proy AND t07_ind_anio = _anio;
    DELETE FROM t40_inf_financ WHERE t02_cod_proy=_proy AND t40_anio = _anio;
    
    
    
    
    
    
    
    
    
    
    
    DELETE FROM t12_plan_at WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t12_plan_capac WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t12_plan_capac_tema WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t12_plan_cred WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t12_plan_cred_benef WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t12_plan_otros WHERE t02_cod_proy=_proy AND t02_version = _ver;
    
    
    DELETE FROM t09_sub_act_mtas WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t09_sub_act_plan WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t10_cost_fte WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t10_cost_sub WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t09_subact WHERE t02_cod_proy=_proy AND t02_version = _ver;
     
    DELETE FROM t03_mp_per_metas WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_per_ftes WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_per WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_equi_metas WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_equi_ftes WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_equi WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_gas_fun_metas WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_gas_fun_ftes WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_gas_fun_cost WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_gas_fun_part WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_imprevistos WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_linea_base WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t03_mp_gas_adm WHERE t02_cod_proy=_proy AND t02_version = _ver;
    
    
    
    
    DELETE FROM t09_act_ind_car WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    
    DELETE FROM t09_act_ind_car_ctrl WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    DELETE FROM t09_act_ind_mtas WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t09_act_ind WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t09_act WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t08_comp_sup WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t08_comp_ind WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t08_comp WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t06_fin_sup WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t06_fin_ind WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t07_prop_sup WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t07_prop_ind WHERE t02_cod_proy=_proy AND t02_version = _ver;
    
    DELETE FROM t03_dist_proy WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t02_proy_anx WHERE t02_cod_proy=_proy AND t02_version = _ver;
    
    DELETE FROM t02_duracion WHERE t02_cod_proy=_proy AND t02_version = _ver;
    DELETE FROM t02_proy_version WHERE t02_cod_proy=_proy AND t02_version = _ver;
    
    DELETE FROM t02_poa WHERE t02_cod_proy=_proy AND t02_anio = _anio;
    SELECT ROW_COUNT() INTO _rowsaffect;
    
    
    DELETE FROM t02_tasas_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    
    DELETE FROM t02_entregable WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    
    DELETE FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version = _ver;
    COMMIT;
    SELECT _rowsaffect AS numrows, _anio AS codigo, '' AS msg;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_equi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_equi`(IN _proy VARCHAR(10), IN _ver INT, IN _per INT, IN _anio INT)
BEGIN
DECLARE _ver_last INT;
DECLARE _ver_cron INT;
SELECT fn_pri_version_proy(_proy) INTO _ver_cron;
SELECT fn_version_proy_poa(_proy, _anio-1) INTO _ver_last;
SELECT  
	temp.t02_cod_proy,
	temp.t02_version, 
	temp.mfi,
	temp.mpaa,
	temp.meta_poa,
	temp.mpar,
	temp.meaa,
	(IFNULL(temp.mfi,0) - IFNULL(temp.meaa,0)) AS mtpe,
	 (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) AS mprog,
 	( (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) - temp.mfi ) AS mvar
FROM
(
SELECT 
		 equip.t02_cod_proy, 
	   equip.t02_version, 
	   equip.t03_id_equi,
	   IFNULL((
								SELECT SUM(mta.t03_mta)
								  FROM t03_mp_equi_metas mta
								 WHERE mta.t02_cod_proy = equip.t02_cod_proy 
								   AND mta.t02_version  = _ver_cron
								    AND mta.t03_id_equi =equip.t03_id_equi
								
	   ),0) AS mfi,
			 IFNULL((
						SELECT SUM(mta.t03_mta)
							FROM t03_mp_equi_metas mta
						 WHERE mta.t02_cod_proy = equip.t02_cod_proy 
								   AND mta.t02_version  = _ver_cron
								    AND mta.t03_id_equi =equip.t03_id_equi
							 and mta.t03_anio=(_anio-1)
			),0) AS mpaa, 
		IFNULL((
	     SELECT SUM(mta.t03_mta)
							FROM t03_mp_equi_metas mta
							WHERE mta.t02_cod_proy = equip.t02_cod_proy 
								   AND mta.t02_version  = _ver_cron
								    AND mta.t03_id_equi =equip.t03_id_equi
							 and mta.t03_anio<=(_anio-1)
	   ),0) AS meaa, 
		(
	    SELECT SUM(mta.t03_mta)
	      FROM t03_mp_equi_metas mta
	     WHERE mta.t02_cod_proy = equip.t02_cod_proy 
				AND mta.t02_version  = _ver_cron
				AND mta.t03_id_equi =equip.t03_id_equi
			AND mta.t03_anio = _anio
	       
	   ) AS meta_poa, 
	   equip.t03_mta_proy AS mpar  
FROM t03_mp_equi equip
WHERE equip.t02_cod_proy = _proy 
  AND equip.t02_version  = _ver
and equip.t03_id_equi=_per 
) AS temp;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_func` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_func`(IN _proy VARCHAR(10), IN _ver INT, IN _per INT, IN _anio INT)
BEGIN
DECLARE _ver_last INT;
DECLARE _ver_cron INT;
SELECT fn_pri_version_proy(_proy) INTO _ver_cron;
SELECT fn_version_proy_poa(_proy, _anio-1) INTO _ver_last;
SELECT  
	temp.t02_cod_proy,
	temp.t02_version, 
	temp.mfi,
	temp.mpaa,
	temp.meta_poa,
	temp.mpar,
	temp.meaa,
	(IFNULL(temp.mfi,0) - IFNULL(temp.meaa,0)) AS mtpe,
	 (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) AS mprog,
 	( (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) - temp.mfi ) AS mvar
FROM
(
SELECT 
		 func.t02_cod_proy, 
	   func.t02_version, 
	   func.t03_partida,
	   IFNULL((
								SELECT SUM(mta.t03_mta)
								  FROM t03_mp_gas_fun_metas mta
								 WHERE mta.t02_cod_proy = func.t02_cod_proy 
								   AND mta.t02_version  = _ver_cron
								    AND mta.t03_partida =func.t03_partida
								
	   ),0) AS mfi,
			 IFNULL((
						SELECT SUM(mta.t03_mta)
							FROM t03_mp_gas_fun_metas mta
						  WHERE mta.t02_cod_proy = func.t02_cod_proy 
								   AND mta.t02_version  = func.t02_version
								    AND mta.t03_partida =func.t03_partida
							 and mta.t03_anio=(_anio-1)
			),0) AS mpaa, 
		IFNULL((
	     SELECT SUM(mta.t03_mta)
							FROM t03_mp_gas_fun_metas mta
						 WHERE mta.t02_cod_proy = func.t02_cod_proy 
								   AND mta.t02_version  = func.t02_version
								    AND mta.t03_partida =func.t03_partida
							 and mta.t03_anio<=(_anio-1)
	   ),0) AS meaa, 
		(
	    SELECT SUM(mta.t03_mta)
	     FROM t03_mp_gas_fun_metas mta
	     WHERE mta.t02_cod_proy = func.t02_cod_proy 
								   AND mta.t02_version  = func.t02_version
								    AND mta.t03_partida =func.t03_partida
			AND mta.t03_anio = _anio
	       
	   ) AS meta_poa, 
	   func.t03_mta_proy AS mpar  
FROM t03_mp_gas_fun_part func
WHERE func.t02_cod_proy = _proy 
  AND func.t02_version  = _ver
and func.t03_partida=_per 
) AS temp;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_genera_version` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_poa_genera_version`(IN _proy VARCHAR(10), 
                                        IN _anio INT, 
                                        IN _usr VARCHAR(20))
trans1 : BEGIN
    DECLARE _ver INT;
    DECLARE _newVer INT;
    DECLARE _priVer INT;
    DECLARE _saltolinea VARCHAR(2);
    DECLARE _log TEXT;
     
    SELECT "\n", '' INTO _saltolinea, _log;
    SELECT fn_ult_version_proy(_proy) INTO _ver;
    SELECT fn_version_proy_poa(_proy, _anio) INTO _newVer;
    SELECT fn_pri_version_proy(_proy) INTO _priVer;
    
    IF IFNULL(_newVer,0) <= 0 THEN
    SELECT CONCAT('No existe el POA, del Año: ',_anio,', Para generar la Nueva Versión del Proyecto') AS msg;
    LEAVE trans1;
    END IF;
    
    SET AUTOCOMMIT=0;
    START TRANSACTION;
     
    SELECT 'Copiando desde : sp_poa_genera_version' INTO _log; 
     
    INSERT INTO t02_dg_proy(t02_cod_proy, t02_version, t02_nro_exp, t00_cod_linea, t01_id_inst, t02_nom_proy, t02_fch_apro, t02_fch_ini, t02_fch_ter, t02_fin, t02_pro, t02_ben_obj, t02_amb_geo, t02_sect_prod, t02_subsect_prod, t02_pres_fe, t02_pres_eje, t02_pres_otro, t02_pres_tot, t02_moni_tema, t02_moni_fina, t02_moni_ext, t02_sup_inst, t02_dire_proy, t02_ciud_proy, t02_tele_proy, t02_fax_proy, t02_mail_proy, t02_estado, t02_mto_line_base, t02_mto_imprevisto, t02_est_imp, t02_cre_fe, t02_fch_isc, t02_fch_ire, t02_fch_tre, t02_fch_tam, t02_num_mes, t02_num_mes_amp, usr_crea, fch_crea, usr_actu, fch_actu, est_audi, env_rev)
    SELECT t02_cod_proy, _newVer, t02_nro_exp, t00_cod_linea, t01_id_inst, t02_nom_proy, t02_fch_apro, t02_fch_ini, t02_fch_ter, t02_fin, t02_pro, t02_ben_obj, t02_amb_geo, t02_sect_prod, t02_subsect_prod, t02_pres_fe, t02_pres_eje, t02_pres_otro, t02_pres_tot, t02_moni_tema, t02_moni_fina, t02_moni_ext, t02_sup_inst, t02_dire_proy, t02_ciud_proy, t02_tele_proy, t02_fax_proy, t02_mail_proy, t02_estado, t02_mto_line_base, t02_mto_imprevisto, t02_est_imp, t02_cre_fe, t02_fch_isc, t02_fch_ire, t02_fch_tre, t02_fch_tam, t02_num_mes, t02_num_mes_amp, _usr, NOW(), NULL, NOW(), est_audi, env_rev  
    FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Proyectos "t02_dg_proy" - Registros:', ROW_COUNT()) INTO _log;
        
    INSERT INTO t02_duracion(t02_cod_proy, t02_version, t02_anio)
    SELECT t02_cod_proy, _newVer, t02_anio
    FROM t02_duracion WHERE t02_cod_proy = _proy AND t02_version = _ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Años de Duracion "t02_duracion" - Registros:', ROW_COUNT()) INTO _log;
    
    INSERT INTO t03_dist_proy(t02_cod_proy, t02_version, t03_dpto, t03_prov, t03_dist, t03_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_dpto, t03_prov, t03_dist, t03_obs, _usr, NOW(), NULL, NOW(), est_audi 
    FROM t03_dist_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado  Distribucion Geografica del Proyecto "t03_dist_proy" - Registros:', ROW_COUNT()) INTO _log;
    
    INSERT INTO t02_proy_anx(t02_cod_proy, t02_version, t02_cod_anx, t02_nom_file, t02_url_file, t02_desc_file, t02_anx_tip_cod, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t02_cod_anx, t02_nom_file, t02_url_file, t02_desc_file, t02_anx_tip_cod, _usr, NOW(), NULL, NOW(), est_audi 
    FROM t02_proy_anx WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Anexos del Proyecto "t02_proy_anx" - Registros:', ROW_COUNT()) INTO _log;
    
    
    
    
    INSERT INTO t06_fin_ind(t02_cod_proy, t02_version, t06_cod_fin_ind, t06_ind, t06_um, t06_mta, t06_fv, t06_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t06_cod_fin_ind, t06_ind, t06_um, t06_mta, t06_fv, t06_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t06_fin_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Finalidad "t06_fin_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t06_fin_sup (t02_cod_proy, t02_version, t06_cod_fin_sup, t06_sup, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t06_cod_fin_sup, t06_sup, _usr, NOW(), NULL, NULL, est_audi
    FROM t06_fin_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Finalidad "t06_fin_sup" - Registros:', ROW_COUNT()) INTO _log;
    
    
    
    
    INSERT INTO t07_prop_ind (t02_cod_proy, t02_version, t07_cod_prop_ind, t07_ind, t07_um, t07_mta, t07_fv, t07_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t07_cod_prop_ind, t07_ind, t07_um, t07_mta, t07_fv, t07_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t07_prop_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Proposito "t07_prop_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t07_prop_sup (t02_cod_proy, t02_version, t07_cod_prop_sup, t07_sup, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t07_cod_prop_sup, t07_sup, _usr, NOW(), NULL, NULL, est_audi
    FROM t07_prop_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Proposito "t07_prop_sup" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_tasas_proy (t02_cod_proy, t02_version, t02_gratificacion, t02_porc_cts, t02_porc_ess, t02_porc_gast_func, t02_porc_linea_base, t02_porc_imprev, t02_proc_gast_superv, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t02_gratificacion, t02_porc_cts, t02_porc_ess, t02_porc_gast_func, t02_porc_linea_base, t02_porc_imprev, t02_proc_gast_superv, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_tasas_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Tasas del Proyecto "t02_tasas_proy" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_entregable (t02_cod_proy, t02_version, t02_anio, t02_mes, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t02_anio, t02_mes, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_entregable WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Entregables "t02_entregable" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t08_comp (t02_cod_proy, t02_version, t08_cod_comp, t08_comp_desc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t08_comp_desc, _usr, NOW(), NULL, NULL, est_audi
    FROM t08_comp WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Componentes "t08_comp" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t08_comp_ind(t02_cod_proy, t02_version, t08_cod_comp, t08_cod_comp_ind, t08_ind, t08_um, t08_mta, t08_fv, t08_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t08_cod_comp_ind, t08_ind, t08_um, t08_mta, t08_fv, t08_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t08_comp_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Componentes "t08_comp_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t08_comp_sup(t02_cod_proy, t02_version, t08_cod_comp, t08_cod_comp_sup, t08_sup, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t08_cod_comp_sup, t08_sup, _usr, NOW(), NULL, NULL, est_audi
    FROM t08_comp_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Componentes "t08_comp_sup" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_act(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_act, t09_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_act, t09_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_act WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Productos "t09_act" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_act_ind(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind, t09_um, t09_mta, t09_fv, t09_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind, t09_um, t09_mta, t09_fv, t09_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_act_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Producto "t09_act_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_act_ind_mtas(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind_anio, t09_ind_mes, t09_ind_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind_anio, t09_ind_mes, t09_ind_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_act_ind_mtas WHERE t02_cod_proy=_proy AND t02_version=_ver; 
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Indicadores de Producto "t09_act_ind_mtas" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_act_ind_car (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_ind, t09_mta, t09_fv, t09_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_ind, t09_mta, t09_fv, t09_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_act_ind_car WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Características de los Indicadores de Producto "t09_act_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_act_ind_car_ctrl (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_car_anio, t09_car_mes, t09_car_ctrl, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_car_anio, t09_car_mes, t09_car_ctrl, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_act_ind_car_ctrl WHERE t02_cod_proy=_proy AND t02_version=_ver; 
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Control Características de los Indicadores de Producto "t09_act_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_subact (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_sub,
     t09_um,t09_mta, t09_fv,t09_tipo_sub, t09_act_crit, t09_obs, 
     t09_mta_proy, t09_mta_repro, t09_resumen, fch_crea, usr_crea, usr_actu,
     fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_sub, 
     t09_um,t09_mta, t09_fv,t09_tipo_sub, t09_act_crit, t09_obs, 
     0, 0, t09_resumen, NOW(), _usr, NULL,
     NULL, est_audi
    FROM t09_subact WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Actividades "t09_subact" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_sub_act_mtas (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_cod_mta, t09_anio, t09_mes, t09_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_cod_mta, t09_anio, t09_mes, t09_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_sub_act_mtas 
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t09_anio>=_anio;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Actividades "t09_sub_act_mtas" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_entregable_act_ind (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t02_anio, t02_mes, t09_cod_act_ind_val, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t02_anio, t02_mes, t09_cod_act_ind_val, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_entregable_act_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Entregables Indicador "t02_entregable_act_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_entregable_act_ind_car (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t02_anio, t02_mes, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t02_anio, t02_mes, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_entregable_act_ind_car WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Entregables Indicador Características "t02_entregable_act_ind_car" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t10_cost_sub (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cost, t10_cate_cost, t10_um, t10_cant, t10_cu, t10_cost_parc, t10_cost_tot, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cost, t10_cate_cost, t10_um, t10_cant, t10_cu, t10_cost_parc, t10_cost_tot, _usr, NOW(), NULL, NULL, est_audi
    FROM t10_cost_sub WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Costeo de Actividades "t10_cost_sub" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t10_cost_fte (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cod_fte, t01_id_inst, t10_mont, t10_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cod_fte, t01_id_inst, t10_mont, t10_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM t10_cost_fte WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aportes x Fuentes de Financiamiento "t10_cost_fte" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t12_plan_capac (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_capac
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Capacitacion Cabecera "t12_plan_capac" - Registros:', ROW_COUNT()) INTO _log;
    INSERT INTO t12_plan_capac_tema (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_cod_tema, t12_tem_espe, t12_nro_hora, t12_nro_bene, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_cod_tema, t12_tem_espe, t12_nro_hora, t12_nro_bene, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_capac_tema
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Capacitacion Detalle (Temas) "t12_plan_capac_tema" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t12_plan_at (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_at
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Asistencia Tecnica "t12_plan_at" - Registros:', ROW_COUNT()) INTO _log;
            
    
    INSERT INTO t12_plan_cred (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_ben, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_ben, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_cred
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Creditos Cabecera "t12_plan_cred" - Registros:', ROW_COUNT()) INTO _log;
    
    INSERT INTO t12_plan_cred_benef (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t11_cod_benef, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t11_cod_benef, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_cred_benef
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Creditos Detalle "t12_plan_cred_benef" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t12_plan_otros (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_producto, t12_nro_ent, t12_nro_ben, t12_tot_ent, t12_conten, t12_tipo, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_producto, t12_nro_ent, t12_nro_ben, t12_tot_ent, t12_conten, t12_tipo, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_otros
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes - Otros "t12_plan_otros" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t03_mp_per (t02_cod_proy, t02_version, t03_id_per, t03_nom_per, t03_tdr, t03_tdr_file, t03_um, 
     t03_dedica, t03_remu, t03_perma, t03_remu_prom, t03_gasto_tot, usr_crea, fch_crea, 
     usr_actu, fch_actu, est_audi, t03_mta_proy, t03_mta_repro)
    SELECT  t02_cod_proy, _newVer, t03_id_per, t03_nom_per, t03_tdr, t03_tdr_file, t03_um, 
     t03_dedica, t03_remu, t03_perma, t03_remu_prom, t03_gasto_tot, _usr, NOW(), 
     NULL, NULL, est_audi, 0, t03_mta_repro
    FROM  t03_mp_per WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Personal "t03_mp_per" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_per_metas (t02_cod_proy, t02_version, t03_id_per, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_per, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_per_metas 
    WHERE t02_cod_proy=_proy AND t02_version=_priVer AND t03_anio=_anio;
    
    INSERT INTO t03_mp_per_metas (t02_cod_proy, t02_version, t03_id_per, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_per, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_per_metas 
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t03_anio<_anio;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas del Personal "t03_mp_per_metas" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_per_ftes (t02_cod_proy, t02_version, t03_id_per, t03_id_inst, t03_monto  , t03_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_per, t03_id_inst, t03_monto  , t03_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_per_ftes WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes de Financiamiento del Personal "t03_mp_per_ftes" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_equi  (t02_cod_proy, t02_version, t03_id_equi, t03_nom_equi, t03_um, t03_cu, t03_cant, 
     t03_costo, t03_costo_tot, usr_crea, fch_crea, usr_actu, fch_actu, est_audi,
     t03_mta_proy, t03_mta_repro)
    SELECT  t02_cod_proy, _newVer, t03_id_equi, t03_nom_equi, t03_um, t03_cu, t03_cant, 
     t03_costo, t03_costo_tot, _usr, NOW(), NULL, NULL, est_audi,
     0, t03_mta_repro
    FROM t03_mp_equi  
    WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Equipamiento "t03_mp_equi" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_equi_metas (t02_cod_proy, t02_version, t03_id_equi, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_equi, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_equi_metas 
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t03_anio<=_anio;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Equipamiento "t03_mp_equi_metas" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_equi_ftes (t02_cod_proy, t02_version, t03_id_equi, t03_id_inst, t03_monto, t03_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_equi, t03_id_inst, t03_monto, t03_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_equi_ftes WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes de Financiamiento de Equipamiento "t03_mp_equi_ftes" - Registros:', ROW_COUNT()) INTO _log;
    
    
    
    
    INSERT INTO t03_mp_gas_fun_part(t02_cod_proy, t02_version, t03_partida, t03_um, t03_meta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi, t03_mta_proy, t03_mta_repro)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_um, t03_meta, _usr , NOW(), NULL, NULL, est_audi, 0, t03_mta_repro
    FROM t03_mp_gas_fun_part WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Partidas "t03_mp_gas_fun_part" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_fun_metas (t02_cod_proy, t02_version, t03_partida, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_fun_metas
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t03_anio<=_anio;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Partidas de Gastos "t03_mp_gas_fun_metas " - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_fun_cost (t02_cod_proy, t02_version, t03_partida, t03_id_gasto, t03_descrip, t03_um, t03_cu, t03_cant, t03_cat_gast, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_id_gasto, t03_descrip, t03_um, t03_cu, t03_cant, t03_cat_gast, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_fun_cost  WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Costos de Funcionamiento "t03_mp_gas_fun_cost " - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_fun_ftes (t02_cod_proy, t02_version, t03_partida, t03_id_gasto, t03_id_inst, t03_monto, t03_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_id_gasto, t03_id_inst, t03_monto, t03_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_fun_ftes  WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes Financ - Costos de Funcionamiento "t03_mp_gas_fun_ftes " - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_adm(t02_cod_proy, t02_version, t03_id_inst, t03_monto, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, 0, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_adm WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Costos Administrativos "t03_mp_gas_adm" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_linea_base(t02_cod_proy, t02_version, t03_id_inst, t03_monto, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, 0, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_linea_base WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Linea de Base y Evaluación de Impacto  "t03_mp_linea_base" - Registros:', ROW_COUNT()) INTO _log;
     
    
    INSERT INTO t03_mp_imprevistos(t02_cod_proy, t02_version, t03_id_inst, t03_monto, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, 0, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_imprevistos WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Imprevistos  "t03_mp_imprevistos" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_supervision(t02_cod_proy, t02_version, t03_id_inst, t03_monto, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, 0, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_supervision WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Gastos de Supervisión de Proyectos  "t03_mp_gas_supervision" - Registros:', ROW_COUNT()) INTO _log;
    
    
    CALL sp_poa_actualiza_presupuesto(_proy, _newVer);
    
    
    CALL sp_poa_actualiza_metas_reprogramadas(_proy, _anio);
    
     
    UPDATE t02_proy_version 
    SET t02_gen = 1,
     fch_gen = NOW(),
     usr_gen = _usr,
     gen_log = _log
    WHERE t02_cod_proy = _proy AND t02_tipo='POA' AND t02_anio= _anio;
    
    COMMIT;
    
    SELECT '' AS msg, _log AS 'Log Generado';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_genera_version_inicial` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_poa_genera_version_inicial`(IN _proy VARCHAR(10), 
                        IN _anio INT, 
                        IN _usr VARCHAR(20))
trans1 : BEGIN
    DECLARE _ver INT ;
    DECLARE _newVer INT ;
    DECLARE _priVer INT ;
    DECLARE _saltolinea VARCHAR(2);
    DECLARE _log TEXT;
     
    SELECT "\n", '' INTO _saltolinea, _log ;
    SELECT fn_ult_version_proy(_proy) INTO _ver ;
    SELECT fn_version_proy_poa(_proy, _anio) INTO _newVer ;
    SELECT fn_pri_version_proy(_proy) INTO _priVer ;
    IF IFNULL(_newVer,0) <= 0 THEN
    SELECT CONCAT('No se ha Guardado la caratula del POA, para el Año: ',_anio,', primero debe guardar la Caratula del POA y luego Generar la Versión') AS msg ;
       LEAVE trans1;
    END IF;

    SET AUTOCOMMIT=0;
    START TRANSACTION;
 
    SELECT 'Copiando desde : sp_poa_genera_version_inicial' INTO _log ;
     
    INSERT INTO t02_dg_proy(t02_cod_proy, t02_version, t02_nro_exp, t01_id_inst, t02_nom_proy, t02_fch_apro, t02_fch_ini, t02_fch_ter, t02_fin, t02_pro, t02_ben_obj, t02_amb_geo, t02_sect_prod, t02_subsect_prod, t02_pres_fe, t02_pres_eje, t02_pres_otro, t02_pres_tot, t02_moni_tema, t02_moni_fina, t02_moni_ext, t02_sup_inst, t02_dire_proy, t02_ciud_proy, t02_tele_proy, t02_fax_proy, t02_mail_proy, t02_estado, t02_mto_line_base, t02_mto_imprevisto, t02_est_imp, t02_cre_fe, t02_fch_isc, t02_fch_ire, t02_fch_tre, t02_fch_tam, t02_num_mes, t02_num_mes_amp, usr_crea, fch_crea, usr_actu, fch_actu, est_audi, env_rev)
    SELECT t02_cod_proy, _newVer, t02_nro_exp, t01_id_inst, t02_nom_proy, t02_fch_apro, t02_fch_ini, t02_fch_ter, t02_fin, t02_pro, t02_ben_obj, t02_amb_geo, t02_sect_prod, t02_subsect_prod, t02_pres_fe, t02_pres_eje, t02_pres_otro, t02_pres_tot, t02_moni_tema, t02_moni_fina, t02_moni_ext, t02_sup_inst, t02_dire_proy, t02_ciud_proy, t02_tele_proy, t02_fax_proy, t02_mail_proy, t02_estado, t02_mto_line_base, t02_mto_imprevisto, t02_est_imp, t02_cre_fe, t02_fch_isc, t02_fch_ire, t02_fch_tre, t02_fch_tam, t02_num_mes, t02_num_mes_amp, _usr, NOW(), NULL, NOW(), est_audi, env_rev  
    FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Proyectos "t02_dg_proy" - Registros:', ROW_COUNT()) INTO _log;
    
    INSERT INTO t02_duracion(t02_cod_proy, t02_version, t02_anio)
    SELECT t02_cod_proy, _newVer, t02_anio    
    FROM t02_duracion WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Años de Duracion "t02_duracion" - Registros:', ROW_COUNT()) INTO _log;
    
    INSERT INTO t03_dist_proy(t02_cod_proy, t02_version, t03_dpto, t03_prov, t03_dist, t03_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_dpto, t03_prov, t03_dist, t03_obs, _usr, NOW(), NULL, NOW(), est_audi    
    FROM t03_dist_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Distribucion Geografica del Proyecto "t03_dist_proy" - Registros:', ROW_COUNT()) INTO _log;
    
    
    
    
    INSERT INTO t06_fin_ind(t02_cod_proy, t02_version, t06_cod_fin_ind, t06_ind, t06_um, t06_mta, t06_fv, t06_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t06_cod_fin_ind, t06_ind, t06_um, t06_mta, t06_fv, t06_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t06_fin_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Finalidad "t06_fin_ind" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t06_fin_sup(t02_cod_proy, t02_version, t06_cod_fin_sup, t06_sup, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t06_cod_fin_sup, t06_sup, _usr, NOW(), NULL, NULL, est_audi
    FROM t06_fin_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Finalidad "t06_fin_sup" - Registros:', ROW_COUNT()) INTO _log;
    
    
       
    
    INSERT INTO t07_prop_ind(t02_cod_proy, t02_version, t07_cod_prop_ind, t07_ind, t07_um, t07_mta, t07_fv, t07_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t07_cod_prop_ind, t07_ind, t07_um, t07_mta, t07_fv, t07_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t07_prop_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Proposito "t07_prop_ind" - Registros:', ROW_COUNT()) INTO _log;   
       
    
    INSERT INTO t07_prop_sup(t02_cod_proy, t02_version, t07_cod_prop_sup, t07_sup, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t07_cod_prop_sup, t07_sup, _usr, NOW(), NULL, NULL, est_audi
    FROM t07_prop_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Proposito "t07_prop_sup" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_tasas_proy (t02_cod_proy, t02_version, t02_gratificacion, t02_porc_cts, t02_porc_ess, t02_porc_gast_func, t02_porc_linea_base, t02_porc_imprev, t02_proc_gast_superv, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t02_gratificacion, t02_porc_cts, t02_porc_ess, t02_porc_gast_func, t02_porc_linea_base, t02_porc_imprev, t02_proc_gast_superv, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_tasas_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Tasas del Proyecto "t02_tasas_proy" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_entregable (t02_cod_proy, t02_version, t02_anio, t02_mes, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t02_anio, t02_mes, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_entregable WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Entregables "t02_entregable" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t08_comp(t02_cod_proy, t02_version, t08_cod_comp, t08_comp_desc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t08_comp_desc, _usr, NOW(), NULL, NULL, est_audi
    FROM t08_comp WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Componentes "t08_comp" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t08_comp_ind(t02_cod_proy, t02_version, t08_cod_comp, t08_cod_comp_ind, t08_ind, t08_um, t08_mta, t08_fv, t08_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t08_cod_comp_ind, t08_ind, t08_um, t08_mta, t08_fv, t08_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t08_comp_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Componentes "t08_comp_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t08_comp_sup(t02_cod_proy, t02_version, t08_cod_comp, t08_cod_comp_sup, t08_sup, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t08_cod_comp_sup, t08_sup, _usr, NOW(), NULL, NULL, est_audi
    FROM t08_comp_sup WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Supuestos de Componentes "t08_comp_sup" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_act(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_act, t09_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_act, t09_obs, _usr, NOW(), NULL, NULL, est_audi
                    FROM t09_act WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Productos "t09_act" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t09_act_ind(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind, t09_um, t09_mta, t09_fv, t09_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind, t09_um, t09_mta, t09_fv, t09_obs, _usr, NOW(), NULL, NULL, est_audi
                    FROM t09_act_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Indicadores de Producto "t09_act_ind" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t09_act_ind_mtas(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind_anio, t09_ind_mes, t09_ind_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind_anio, t09_ind_mes, t09_ind_mta, _usr, NOW(), NULL, NULL, est_audi
                    FROM t09_act_ind_mtas WHERE t02_cod_proy=_proy AND t02_version=_ver AND t09_ind_anio>_anio;
                               
    INSERT INTO t09_act_ind_mtas(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind_anio, t09_ind_mes, t09_ind_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_ind_anio, t09_ind_mes, t09_ind_mta, _usr, NOW(), NULL, NULL, est_audi
                    FROM t09_act_ind_mtas WHERE t02_cod_proy=_proy AND t02_version=_priVer AND t09_ind_anio=_anio;
                               
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Indicadores de Producto "t09_act_ind_mtas" - Registros:', ROW_COUNT()) INTO _log;   
    
    
    INSERT INTO t09_act_ind_car (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_ind, t09_mta, t09_fv, t09_obs, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_ind, t09_mta, t09_fv, t09_obs, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_act_ind_car WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Características de los Indicadores de Producto "t09_act_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_act_ind_car_ctrl (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_car_anio, t09_car_mes, t09_car_ctrl, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t09_car_anio, t09_car_mes, t09_car_ctrl, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_act_ind_car_ctrl WHERE t02_cod_proy=_proy AND t02_version=_ver; 
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Control Características de los Indicadores de Producto "t09_act_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t09_subact(  t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_sub,
                                t09_um, t09_mta, t09_fv, t09_tipo_sub, t09_act_crit, t09_obs,
                                t09_mta_proy, t09_mta_repro, t09_resumen, fch_crea, usr_crea, usr_actu,
                                fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_sub,
            t09_um, t09_mta, t09_fv, t09_tipo_sub, t09_act_crit, t09_obs, 
            0,     t09_mta_repro, t09_resumen, NOW(), _usr,  NULL,
            NULL,  est_audi
    FROM t09_subact WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Actividades "t09_subact" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t09_sub_act_mtas(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_cod_mta, t09_anio, t09_mes, t09_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_cod_mta, t09_anio, t09_mes, t09_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_sub_act_mtas 
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t09_anio>_anio;
                               
    INSERT INTO t09_sub_act_mtas(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_cod_mta, t09_anio, t09_mes, t09_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t09_cod_mta, t09_anio, t09_mes, t09_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t09_sub_act_mtas 
    WHERE t02_cod_proy=_proy AND t02_version=_priVer AND t09_anio=_anio;                    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Actividades "t09_sub_act_mtas" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_entregable_act_ind (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t02_anio, t02_mes, t09_cod_act_ind_val, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t02_anio, t02_mes, t09_cod_act_ind_val, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_entregable_act_ind WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Entregables Indicador "t02_entregable_act_ind" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t02_entregable_act_ind_car (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t02_anio, t02_mes, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_act_ind, t09_cod_act_ind_car, t02_anio, t02_mes, _usr, NOW(), NULL, NULL, est_audi
    FROM t02_entregable_act_ind_car WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Entregables Indicador Características "t02_entregable_act_ind_car" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t10_cost_sub(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cost, t10_cate_cost, t10_um, t10_cant, t10_cu, t10_cost_parc, t10_cost_tot, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cost, t10_cate_cost, t10_um, t10_cant, t10_cu, t10_cost_parc, t10_cost_tot, _usr, NOW(), NULL, NULL, est_audi
    FROM t10_cost_sub WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Costeo de Actividades "t10_cost_sub" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t10_cost_fte(t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cod_fte, t01_id_inst, t10_mont, t10_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cod_fte, t01_id_inst, t10_mont, t10_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM t10_cost_fte WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aportes x Fuentes de Financiamiento "t10_cost_fte" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t12_plan_capac (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_capac
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Capacitacion Cabecera "t12_plan_capac" - Registros:', ROW_COUNT()) INTO _log;
    INSERT INTO t12_plan_capac_tema (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_cod_tema, t12_tem_espe, t12_nro_hora, t12_nro_bene, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_cod_tema, t12_tem_espe, t12_nro_hora, t12_nro_bene, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_capac_tema
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Capacitacion Detalle (Temas) "t12_plan_capac_tema" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t12_plan_at (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_tema, t12_hor_cap, t12_nro_ben, t12_conten, t12_modulo, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_at
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Asistencia Tecnica "t12_plan_at" - Registros:', ROW_COUNT()) INTO _log;
            
    
    INSERT INTO t12_plan_cred (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_ben, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_nro_ben, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_cred
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Creditos Cabecera "t12_plan_cred" - Registros:', ROW_COUNT()) INTO _log;
    
    INSERT INTO t12_plan_cred_benef (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t11_cod_benef, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t11_cod_benef, t12_mto_ben, t12_nro_cuo, t12_tasa_int, t12_obs, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_cred_benef
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes de Creditos Detalle "t12_plan_cred_benef" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t12_plan_otros (t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_producto, t12_nro_ent, t12_nro_ben, t12_tot_ent, t12_conten, t12_tipo, fch_crea, usr_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t08_cod_comp, t09_cod_act, t09_cod_sub, t12_producto, t12_nro_ent, t12_nro_ben, t12_tot_ent, t12_conten, t12_tipo, NOW(), _usr, NULL, NULL, est_audi
    FROM    t12_plan_otros
    WHERE   t02_cod_proy = _proy AND t02_version = _ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Planes - Otros "t12_plan_otros" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t03_mp_per (t02_cod_proy, t02_version, t03_id_per, t03_nom_per, t03_tdr, t03_tdr_file, t03_um, 
                            t03_dedica, t03_remu, t03_perma, t03_remu_prom, t03_gasto_tot, usr_crea, fch_crea, 
                            usr_actu, fch_actu, est_audi, t03_mta_proy, t03_mta_repro)
    SELECT t02_cod_proy, _newVer, t03_id_per, t03_nom_per, t03_tdr, t03_tdr_file, t03_um, 
                            t03_dedica, t03_remu, t03_perma, t03_remu_prom, t03_gasto_tot, _usr, NOW(), 
                            NULL, NULL, est_audi, 0, t03_mta_repro
    FROM t03_mp_per WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Personal "t03_mp_per" - Registros:', ROW_COUNT()) INTO _log;
     
    
    INSERT INTO t03_mp_per_metas (t02_cod_proy, t02_version, t03_id_per, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_per, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_per_metas 
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t03_anio<_anio ;
                               
    INSERT INTO t03_mp_per_metas (t02_cod_proy, t02_version, t03_id_per, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_per, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_per_metas 
    WHERE t02_cod_proy=_proy AND t02_version=_priVer AND t03_anio=_anio ;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas del Personal "t03_mp_per_metas" - Registros:', ROW_COUNT()) INTO _log;
       
    
    INSERT INTO t03_mp_per_ftes (t02_cod_proy, t02_version, t03_id_per, t03_id_inst, t03_monto  , t03_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_per, t03_id_inst, t03_monto  , t03_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_per_ftes WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes de Financiamiento del Personal "t03_mp_per_ftes" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_equi  (t02_cod_proy, t02_version, t03_id_equi, t03_nom_equi, t03_um, t03_cu, t03_cant, 
                                t03_costo, t03_costo_tot, usr_crea, fch_crea, usr_actu, fch_actu, est_audi,
                                t03_mta_proy, t03_mta_repro)
    SELECT  t02_cod_proy, _newVer, t03_id_equi, t03_nom_equi, t03_um, t03_cu, t03_cant, 
                        t03_costo, t03_costo_tot, _usr, NOW(), NULL , NULL, est_audi, 0, t03_mta_repro
    FROM t03_mp_equi 
    WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Equipamiento "t03_mp_equi" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_equi_metas (t02_cod_proy, t02_version, t03_id_equi, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_equi, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_equi_metas 
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t03_anio<_anio ;
                               
    INSERT INTO t03_mp_equi_metas (t02_cod_proy, t02_version, t03_id_equi, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT  t02_cod_proy, _newVer, t03_id_equi, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_equi_metas 
    WHERE t02_cod_proy=_proy AND t02_version=_priVer AND t03_anio=_anio ;
                               
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Equipamiento "t03_mp_equi_metas" - Registros:', ROW_COUNT()) INTO _log;
    
    INSERT INTO t03_mp_equi_ftes (t02_cod_proy, t02_version, t03_id_equi, t03_id_inst, t03_monto, t03_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT   t02_cod_proy, _newVer, t03_id_equi, t03_id_inst, t03_monto, t03_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM  t03_mp_equi_ftes WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes de Financiamiento de Equipamiento "t03_mp_equi_ftes" - Registros:', ROW_COUNT()) INTO _log;
    
    
    
    
    INSERT INTO t03_mp_gas_fun_part(t02_cod_proy, t02_version, t03_partida, t03_um, t03_meta, usr_crea, fch_crea, 
                                        usr_actu, fch_actu, est_audi, t03_mta_proy, t03_mta_repro)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_um, t03_meta, _usr, NOW(), 
                                        NULL, NULL, est_audi, 0, t03_mta_repro
    FROM t03_mp_gas_fun_part WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Partidas "t03_mp_gas_fun_part" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_fun_metas (t02_cod_proy, t02_version, t03_partida, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_fun_metas   
    WHERE t02_cod_proy=_proy AND t02_version=_ver AND t03_anio<_anio ;
       
    INSERT INTO t03_mp_gas_fun_metas (t02_cod_proy, t02_version, t03_partida, t03_anio, t03_mes, t03_mta, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_anio, t03_mes, t03_mta, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_fun_metas   
    WHERE t02_cod_proy=_proy AND t02_version=_priVer AND t03_anio=_anio ;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Metas de Partidas de Gastos "t03_mp_gas_fun_metas " - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_fun_cost (t02_cod_proy, t02_version, t03_partida, t03_id_gasto, t03_descrip, t03_um, t03_cu, t03_cant, t03_cat_gast, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_id_gasto, t03_descrip, t03_um, t03_cu, t03_cant, t03_cat_gast, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_fun_cost  WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Costos de Funcionamiento "t03_mp_gas_fun_cost " - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_fun_ftes (t02_cod_proy, t02_version, t03_partida, t03_id_gasto, t03_id_inst, t03_monto, t03_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_partida, t03_id_gasto, t03_id_inst, t03_monto, t03_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_fun_ftes  WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Aporte de Fuentes Financ - Costos de Funcionamiento "t03_mp_gas_fun_ftes " - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_adm(t02_cod_proy, t02_version, t03_id_inst, t03_monto, t03_porc, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, (t03_monto / fn_duracion_proy(t02_cod_proy,1) )  , t03_porc, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_adm WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Costos Administrativos "t03_mp_gas_adm" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_linea_base(t02_cod_proy, t02_version, t03_id_inst, t03_monto, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, 0, _usr, NOW(), NULL, NULL, est_audi
                  FROM t03_mp_linea_base WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT CONCAT(_log, _saltolinea, 'Copiado Linea de Base y Evaluación de Impacto  "t03_mp_linea_base" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_imprevistos(t02_cod_proy, t02_version, t03_id_inst, t03_monto, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, 0, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_imprevistos WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Imprevistos  "t03_mp_imprevistos" - Registros:', ROW_COUNT()) INTO _log;
    
    
    INSERT INTO t03_mp_gas_supervision(t02_cod_proy, t02_version, t03_id_inst, t03_monto, usr_crea, fch_crea, usr_actu, fch_actu, est_audi)
    SELECT t02_cod_proy, _newVer, t03_id_inst, 0, _usr, NOW(), NULL, NULL, est_audi
    FROM t03_mp_gas_supervision WHERE t02_cod_proy=_proy AND t02_version=_ver;
    
    SELECT CONCAT(_log, _saltolinea, 'Copiado Gastos de Supervisión de Proyectos  "t03_mp_gas_supervision" - Registros:', ROW_COUNT()) INTO _log;
    
    
    CALL sp_poa_actualiza_presupuesto(_proy, _newVer) ;
    
    
    CALL sp_poa_actualiza_metas_reprogramadas(_proy, _anio) ;
    
    
    UPDATE t02_proy_version 
    SET t02_gen = 1,
        fch_gen = NOW(),
        usr_gen = _usr,
        gen_log = _log
    WHERE t02_cod_proy = _proy AND t02_tipo='POA' AND t02_anio= _anio;
    COMMIT ;
    SELECT '' AS msg, _log AS 'Log Generado';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_ind_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_ind_act`(	IN _proy varchar(10), 
																in _ver int, 
																in _anio int)
BEGIN
SELECT  CONCAT(ind.t08_cod_comp,'.', ind.t09_cod_act, '.', ind.t09_cod_act_ind) AS codigo,
	ind.t09_ind AS indicador,
	ind.t09_um  AS um,
	ind.t09_mta AS meta,
	ind.t09_obs as descripcion,
	ifnull(fn_poa_ind_act_meta_eje(ind.t02_cod_proy, ind.t08_cod_comp, ind.t09_cod_act_ind, _anio -1),0) AS ejecutado_acum,
	fn_poa_ind_act_meta_eje(ind.t02_cod_proy, ind.t08_cod_comp, ind.t09_cod_act_ind, _anio) AS ejecutado_anio,
	fn_poa_ind_act_meta(ind.t02_cod_proy, 1, ind.t08_cod_comp, ind.t09_cod_act, ind.t09_cod_act_ind) AS metatotal,
	'indicador' AS tipo,
	ind.t08_cod_comp as idcomp,
	ind.t09_cod_act as act,
	ind.t09_cod_act_ind as idind
FROM 	t09_act_ind ind  
WHERE ind.t02_cod_proy = _proy
  AND ind.t02_version  = _ver  
UNION ALL
SELECT  CONCAT(com.t08_cod_comp,'.',com.t09_cod_act) AS codigo,
	com.t09_act AS indicador,
	'' AS um,
	0 AS meta,
	null AS descripcion,
	0 as ejecutado_acum,
	0 AS ejecutado_anio,
	0 AS metatotal,
	'componente' AS tipo,
	com.t08_cod_comp AS idcomp,
	com.t09_cod_act as act,
	0 AS idind
FROM t09_act com
WHERE com.t02_cod_proy = _proy
  AND com.t02_version  = _ver  
  
ORDER BY idcomp ASC, act ASC, idind asc;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_ind_comp`( IN _proy varchar(10), in _ver int, in _anio int )
BEGIN
SELECT  CONCAT(ind.t08_cod_comp,'.', ind.t08_cod_comp_ind) AS codigo,
	ind.t08_ind AS indicador,
	ind.t08_um  AS um,
	ind.t08_mta AS meta,
	ind.t08_obs as descripcion,
	ifnull(fn_poa_ind_comp_meta_eje(ind.t02_cod_proy, ind.t08_cod_comp, ind.t08_cod_comp_ind, _anio -1),0) AS ejecutado_acum,
	fn_poa_ind_comp_meta_eje(ind.t02_cod_proy, ind.t08_cod_comp, ind.t08_cod_comp_ind, _anio) AS ejecutado_anio,
	fn_poa_ind_comp_meta(ind.t02_cod_proy, 1, ind.t08_cod_comp, ind.t08_cod_comp_ind) AS metatotal,
	'indicador' AS tipo,
	ind.t08_cod_comp as idcomp,
	ind.t08_cod_comp_ind as idind
FROM 	   t08_comp_ind ind  
WHERE ind.t02_cod_proy = _proy
  AND ind.t02_version  = _ver  
UNION ALL
SELECT  com.t08_cod_comp AS codigo,
	com.t08_comp_desc AS indicador,
	'' AS um,
	0 AS meta,
	null AS descripcion,
	0 as ejecutado_acum,
	0 AS ejecutado_anio,
	0 AS metatotal,
	'componente' AS tipo,
	com.t08_cod_comp AS idcomp,
	0 AS idind
FROM t08_comp com
WHERE com.t02_cod_proy = _proy
  AND com.t02_version  = _ver  
  
ORDER BY idcomp ASC, idind asc;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_ins_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_ins_cab`(IN _proy varchar(10), 
			IN _anio INT, 
			IN _periodo varchar(50), 
			in _punto_aten text, 
			in _politica text, 
			in _benefic  text, 
			IN _otras_interv text, 
			IN _estado INT,
			IN _obscmt TEXT, 
			in _aprob int,
			IN _unsuspended CHAR(1),
			IN _usr varchar(20))
trans1 : BEGIN
DECLARE _verActual   INT;
DECLARE _verNueva    INT;
SELECT fn_ult_version_proy(_proy) INTO _verActual ;
SELECT IFNULL(_verActual ,0)+1    INTO _verNueva  ;
if (select count(1) from t02_poa where t02_cod_proy=_proy and t02_anio = _anio) > 0 then
   SELECT 0 AS numrows, -1 AS codigo, concat('Ya existe un POA, para el Año: ', _anio) AS msg ;
   leave trans1;
end if ;
IF (SELECT COUNT(1) FROM t02_proy_version WHERE t02_cod_proy = _proy AND t02_tipo='POA' AND t02_gen=0 AND t02_anio <> _anio) > 0 THEN
   SELECT CONCAT('No se puede crear el POA correspondiente al Año:',_anio,', tiene un POA pendiente por Generar') AS msg ;
   LEAVE trans1;
END IF;
INSERT INTO t02_proy_version
			(
			 t02_cod_proy, 	
			 t02_tipo,
			 t02_anio, 	
			 t02_version, 	 	
			 t02_ver, 	
			 usr_crea, 	
			 fch_crea
			 )
	 values ( 
			 _proy	 , 	
			 'POA'   , 	
			 _anio   , 	
			 _verNueva , 	
			 _anio   , 	
			 _usr    , 	
			 NOW() 
			 ) ;
if ROW_COUNT() > 0 then
	INSERT INTO t02_poa 
			   (
				t02_cod_proy, 
				t02_anio, 
				t02_periodo, 
				t02_punto_aten, 
				t02_politica, 
				t02_benefic, 
				t02_otras_interv, 
				t02_estado, 
				t02_estado_mf, 
				t02_aprob_cmt,
				t02_obs_cmt,
				t02_unsuspend_flg,
				usr_crea, 
				fch_crea, 
				usr_actu, 
				fch_actu, 
				est_audi
			   )
		VALUES
			   (
			    _proy	 , 	
				_anio   , 
				_periodo, 
				_punto_aten, 
				_politica, 
				_benefic, 
				_otras_interv, 
				_estado, 
				258, 
				_obscmt , 
				_aprob ,
				_unsuspended,
				_usr , 
				now(), 
				null, 
				null, 
				'1'
				);
	SELECT ROW_COUNT() AS numrows, _anio AS codigo, '' AS msg ;
else
	SELECT 0 AS numrows, -1 AS codigo, 'No se ha logrado Guardar el POA' as msg ;
end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_per` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_per`(IN _proy VARCHAR(10), IN _ver INT, IN _per INT, IN _anio INT)
BEGIN
DECLARE _ver_last INT;
DECLARE _ver_cron INT;
SELECT fn_pri_version_proy(_proy) INTO _ver_cron;
SELECT fn_version_proy_poa(_proy, _anio-1) INTO _ver_last;
SELECT  
	temp.t02_cod_proy,
	temp.t02_version, 
	temp.mfi,
	temp.mpaa,
	temp.meta_poa,
	temp.mpar,
	temp.meaa,
	(IFNULL(temp.mfi,0) - IFNULL(temp.meaa,0)) AS mtpe,
	 (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) AS mprog,
 	( (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) - temp.mfi ) AS mvar
FROM
(
SELECT 
		 pers.t02_cod_proy, 
	   pers.t02_version, 
	   pers.t03_id_per,
	   IFNULL((
								SELECT SUM(mta.t03_mta)
								  FROM t03_mp_per_metas mta
								 WHERE mta.t02_cod_proy = pers.t02_cod_proy 
								   AND mta.t02_version  = _ver_cron
								    AND mta.t03_id_per =pers.t03_id_per
								
	   ),0) AS mfi,
			 IFNULL((
						SELECT SUM(mta.t03_mta)
							FROM t03_mp_per_metas mta
						 WHERE mta.t02_cod_proy = pers.t02_cod_proy 
							 AND mta.t02_version  = pers.t02_version
							 AND mta.t03_id_per =pers.t03_id_per
							 and mta.t03_anio=(_anio-1)
			),0) AS mpaa, 
		IFNULL((
	     SELECT SUM(mta.t03_mta)
							FROM t03_mp_per_metas mta
						 WHERE mta.t02_cod_proy = pers.t02_cod_proy 
							 AND mta.t02_version  = pers.t02_version
							 AND mta.t03_id_per =pers.t03_id_per
							 and mta.t03_anio<=(_anio-1)
	   ),0) AS meaa, 
		(
	    SELECT SUM(mta.t03_mta)
	      FROM  t03_mp_per_metas mta
	     WHERE mta.t02_cod_proy = pers.t02_cod_proy 
	       AND mta.t02_version  = pers.t02_version
			AND mta.t03_id_per =pers.t03_id_per
			AND mta.t03_anio = _anio
	       
	   ) AS meta_poa, 
	   pers.t03_mta_proy AS mpar  
FROM t03_mp_per pers
WHERE pers.t02_cod_proy = _proy 
  AND pers.t02_version  = _ver
and pers.t03_id_per=_per 
) AS temp;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_poa_subact`(IN _proy VARCHAR(10), IN _ver  INT, IN _comp INT, IN _act  INT, IN _anio INT)
BEGIN
DECLARE _ver_last INT;
DECLARE _ver_cron INT;

SELECT fn_pri_version_proy(_proy) INTO _ver_cron;
IF(_anio>1) THEN
    SELECT fn_version_proy_poa(_proy, _anio-1) INTO _ver_last;
ELSE
    SELECT _ver INTO _ver_last;
END IF;

SELECT  temp.t02_cod_proy,
    temp.t02_version,
    temp.codigo,
    temp.comp,
    temp.subact, 
    temp.descripcion, 
    temp.um, 
    temp.meta_acum,
    
    temp.mfi,
    temp.mpaa,
    temp.meaa,
    temp.meta_poa,
    temp.mpar,
    temp.resumen,
    temp.t09_obs_mt,
    
    (IFNULL(temp.mfi,0) - IFNULL(temp.meaa,0)) AS mtpe,
    (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) AS mprog,
    ( (IFNULL(temp.meaa,0) + IFNULL(temp.meta_poa,0) +  IFNULL(temp.mpar,0)) - temp.mfi ) AS mvar,
    temp.act_add
FROM
(
SELECT     sub.t02_cod_proy, 
       sub.t02_version, 
       CONCAT(sub.t08_cod_comp,'.', sub.t09_cod_act, '.', sub.t09_cod_sub) AS codigo,
       sub.t08_cod_comp AS comp, 
       sub.t09_cod_act AS act, 
       sub.t09_cod_sub AS subact, 
       sub.t09_sub AS descripcion, 
       sub.t09_um AS um, 
       sub.t09_mta AS meta_acum,
       sub.t09_resumen as resumen,
       sub.t09_obs_mt,
     (
        SELECT SUM(mta.t09_mta)
          FROM t09_sub_act_mtas mta
         WHERE mta.t02_cod_proy = sub.t02_cod_proy 
           AND mta.t02_version  = _ver_cron
           AND mta.t08_cod_comp = sub.t08_cod_comp 
           AND mta.t09_cod_act  = sub.t09_cod_act 
           AND mta.t09_cod_sub  = sub.t09_cod_sub 
        ) AS mfi,
       
       (CASE WHEN _anio>1 
         THEN 
            (
            SELECT SUM(mta.t09_mta)
              FROM t09_sub_act_mtas mta
             WHERE mta.t02_cod_proy = sub.t02_cod_proy 
               AND mta.t02_version  = _ver_last
               AND mta.t08_cod_comp = sub.t08_cod_comp 
               AND mta.t09_cod_act  = sub.t09_cod_act 
               AND mta.t09_cod_sub  = sub.t09_cod_sub 
               AND mta.t09_anio=(_anio - 1)
            )
         ELSE 0 
         END) AS mpaa, 
       IFNULL((
         SELECT SUM(inf.t09_sub_avanc) 
           FROM t09_act_sub_mtas_inf inf
          WHERE inf.t02_cod_proy = sub.t02_cod_proy
            AND inf.t08_cod_comp = sub.t08_cod_comp
            AND inf.t09_cod_act  = sub.t09_cod_act
            AND inf.t09_cod_sub  = sub.t09_cod_sub
            AND inf.t09_sub_anio <= (_anio-1)
       ),0) AS meaa, 
       (
        SELECT SUM(mta.t09_mta)
          FROM  t09_sub_act_mtas mta
         WHERE mta.t02_cod_proy = sub.t02_cod_proy 
           AND mta.t02_version  = sub.t02_version
           AND mta.t08_cod_comp = sub.t08_cod_comp 
           AND mta.t09_cod_act  = sub.t09_cod_act 
           AND mta.t09_cod_sub  = sub.t09_cod_sub 
           AND mta.t09_anio=_anio
       ) AS meta_poa, 
       sub.t09_mta_proy AS mpar , 
       IF(sub.t02_version > 1,
             IF(sub.t09_cod_sub IN (
                    SELECT sub.t09_cod_sub  AS subact        
                    FROM t09_subact       sub
                    WHERE  sub.t02_cod_proy = _proy
                      AND  sub.t02_version  = 1
                      AND  sub.t08_cod_comp = _comp
                      AND  sub.t09_cod_act  = _act
                      GROUP BY 1
                      ORDER BY subact
                        ),'','1')         
       ,'') AS act_add        
FROM t09_subact sub 
LEFT JOIN t09_subact poa_ant ON(sub.t02_cod_proy = poa_ant.t02_cod_proy AND poa_ant.t02_version = _ver_last AND sub.t08_cod_comp = poa_ant.t08_cod_comp AND sub.t09_cod_act =poa_ant.t09_cod_act AND sub.t09_cod_sub = poa_ant.t09_cod_sub) 
WHERE sub.t02_cod_proy = _proy 
  AND sub.t02_version  = _ver 
  AND sub.t08_cod_comp = _comp 
  AND sub.t09_cod_act  = _act 
ORDER BY sub.t09_cod_sub
) AS temp;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_subact_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_poa_subact_metas`(IN _proy VARCHAR(10), IN _ver INT, in _comp int, in _act int, in _subact int, in _anio int)
BEGIN
SELECT  anio.t02_cod_proy, 
		anio.t02_version , 
		anio.t02_anio,
		CONCAT('Año ', anio.t02_anio ) AS 'anio',
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=1 THEN mta.t09_mta ELSE NULL END) AS mes1,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=2 THEN mta.t09_mta ELSE NULL END) AS mes2,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=3 THEN mta.t09_mta ELSE NULL END) AS mes3,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=4 THEN mta.t09_mta ELSE NULL END) AS mes4,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=5 THEN mta.t09_mta ELSE NULL END) AS mes5,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=6 THEN mta.t09_mta ELSE NULL END) AS mes6,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=7 THEN mta.t09_mta ELSE NULL END) AS mes7,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=8 THEN mta.t09_mta ELSE NULL END) AS mes8,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=9 THEN mta.t09_mta ELSE NULL END) AS mes9,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=10 THEN mta.t09_mta ELSE NULL END) AS mes10,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=11 THEN mta.t09_mta ELSE NULL END) AS mes11,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio AND mta.t09_mes=12 THEN mta.t09_mta ELSE NULL END) AS mes12,
		SUM(CASE WHEN mta.t09_anio=anio.t02_anio THEN mta.t09_mta ELSE 0 END) AS tot_anio
FROM       t02_duracion     anio
LEFT  JOIN t09_subact       sub ON(anio.t02_cod_proy= sub.t02_cod_proy AND anio.t02_version=sub.t02_version  AND sub.t08_cod_comp = _comp AND sub.t09_cod_act = _act AND sub.t09_cod_sub = _subact)
LEFT  JOIN t09_sub_act_mtas mta ON(sub.t02_cod_proy = mta.t02_cod_proy AND sub.t02_version = mta.t02_version AND sub.t08_cod_comp = mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub = mta.t09_cod_sub)
 WHERE anio.t02_cod_proy= _proy
   AND anio.t02_version = _ver
   and anio.t02_anio <= _anio 
GROUP BY 1,2,3,4 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_upd_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_poa_upd_cab`(IN _proy VARCHAR(10), 
                    IN _anio INT, 
                    IN _periodo VARCHAR(50), 
                    IN _punto_aten TEXT, 
                    IN _politica TEXT, 
                    IN _benefic  TEXT, 
                    IN _otras_interv TEXT, 
                    IN _estado INT,
                    IN _obscmt TEXT, 
                    IN _aprob INT,
                    IN _usr VARCHAR(20),
                    IN _vb_se INT)
BEGIN
    UPDATE  t02_poa 
    SET     t02_periodo         = _periodo,
            t02_punto_aten      = _punto_aten,
            t02_politica        = _politica, 
            t02_benefic         = _benefic, 
            t02_otras_interv    = _otras_interv, 
            t02_estado          = _estado, 
            t02_aprob_cmt       = _aprob,
            t02_obs_cmt         = _obscmt,
            usr_actu            = _usr, 
            fch_actu            = NOW(),
            t02_tipo_poa        = 1,
            t02_fch_aprob       = IF((_estado = 257 AND t02_estado_mf = 262), CURDATE(), t02_fch_aprob),
            vb_se_tec           = _vb_se
    WHERE   t02_cod_proy        = _proy 
        AND t02_anio            = _anio;
       
SELECT ROW_COUNT() AS numrows, _anio AS codigo, '' AS msg;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_poa_upd_cabII` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_poa_upd_cabII`(IN _proy VARCHAR(10), 
                    IN _anio INT, 
                    IN _obscmf TEXT, 
                    IN _estadomf INT,
                    IN _aprob INT,
                    IN _usr VARCHAR(20),
                    IN _vb_se INT)
BEGIN
    UPDATE  t02_poa 
    SET     t02_aprob_cmf   = _aprob  ,
            t02_obs_cmf     = _obscmf ,
            t02_estado_mf   = _estadomf,
            usr_actu        = _usr, 
            fch_actu        = NOW(),
            t02_tipo_poa    = 0,
            t02_fch_aprob   = IF((_estadomf = 262 AND t02_estado = 257), CURDATE(), t02_fch_aprob),
            vb_se_fin       = _vb_se
    WHERE   t02_cod_proy    = _proy 
        AND t02_anio        = _anio;
    SELECT ROW_COUNT() AS numrows, _anio AS codigo, '' AS msg ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_proy_order_by_anio_ini` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_proy_order_by_anio_ini`()
BEGIN
		DECLARE max INT;
		SELECT MIN(YEAR(proy.t02_fch_ini)) INTO max
		FROM t02_dg_proy proy
		WHERE proy.t02_fch_ini <> '0000-00-00'
		ORDER BY proy.t02_fch_ini ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_proy_order_by_anio_ter` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_proy_order_by_anio_ter`()
BEGIN
	SELECT proy.t02_fch_ter, proy.t02_cod_proy
		FROM t02_dg_proy proy
		WHERE proy.t02_fch_ini <> '0000-00-00'
		ORDER BY proy.t02_fch_ter DESC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rel_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rel_proy`(IN _TipoInst VARCHAR(10))
BEGIN
	SELECT 
		proy.t02_cod_proy AS codigo,
		inst.t01_nom_inst ,
		DATE_FORMAT(inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
		tipInst.descrip AS tipo_inst,
		proy.t02_nom_proy,
		proy.t02_fin,
		proy.t02_pro,
		proy.t02_amb_geo,
		reg.nom_ubig AS region,
		sec.descrip AS sector,
		sub.descrip AS subsector,
		DATE_FORMAT(proy.t02_fch_apro,'%d/%m/%Y') AS t02_fch_apro,
		DATE_FORMAT(proy.t02_fch_ini, '%d/%m/%Y') AS t02_fch_ini,
		DATE_FORMAT(proy.t02_fch_ter, '%d/%m/%Y') AS t02_fch_ter,
		DATE_FORMAT(proy.t02_fch_ire, '%d/%m/%Y') AS t02_fch_ter,
		DATE_FORMAT(proy.t02_fch_tre, '%d/%m/%Y') AS t02_fch_tre,
		proy.t02_num_mes,
		proy.t02_num_mes_amp,
		IF(proy.t02_estado = 41, FORMAT(DATEDIFF(proy.t02_fch_ter, CURDATE()) / 30 + IFNULL(proy.t02_num_mes_amp, 0), 1), '--') AS num_mes_ejec_rest,
		proy.t02_pres_tot AS pres_tot,
		proy.t02_pres_fe,
		proy.t02_pres_otro,
		desem.total_desem_fe,
		gasfe.gasto_fe,
		gasotr.gasto_otros,
		proy.t02_ben_obj,
		(SELECT COUNT(*) FROM t11_bco_bene WHERE t02_cod_proy = proy.t02_cod_proy) AS num_tot_benef,
		fn_count_pers_cap(proy.t02_cod_proy, 202) AS tot_ben_cap_prod,
		fn_count_pers_cap(proy.t02_cod_proy, 203) AS tot_ben_cap_gest,
		fn_count_pers_cap(proy.t02_cod_proy, 204) AS tot_ben_cap_comer,
		fn_count_pers_cap(proy.t02_cod_proy, 205) AS tot_ben_cap_autoest,
		fn_count_pers_at(proy.t02_cod_proy, 202) AS tot_ben_at_prod,
		fn_count_pers_at(proy.t02_cod_proy, 203) AS tot_ben_at_gest,
		fn_count_pers_at(proy.t02_cod_proy, 204) AS tot_ben_at_comer,
		fn_count_pers_cred(proy.t02_cod_proy) AS tot_ben_cred,
		fn_count_pers_otros(proy.t02_cod_proy) AS tot_ben_otros,
		fn_avance_logrado_proposito(proy.t02_cod_proy) AS avance_prop,
		fn_avance_logrado_componente(proy.t02_cod_proy) AS avance_comp,
		fn_avance_total_subactividad(proy.t02_cod_proy, 
									 fn_get_anio_proy(proy.t02_fch_ini, proy.t02_fch_ire), 
									 fn_get_mes_proy(proy.t02_fch_ini, proy.t02_fch_ire)) AS avance_total_sub,
		fn_avance_acum_subactividad(proy.t02_cod_proy, 
									fn_get_anio_proy(proy.t02_fch_ini, proy.t02_fch_ire), 
									fn_get_mes_proy(proy.t02_fch_ini, proy.t02_fch_ire)) AS avance_acum_sub,
		CONCAT(mt.t90_ape_pat,' ',mt.t90_ape_mat,', ',mt.t90_nom_equi) AS  moni_tema,
		CONCAT(mf.t90_ape_pat,' ',mf.t90_ape_mat,', ',mf.t90_nom_equi) AS  moni_fina,
		CONCAT(ext.t01_ape_pat,' ',ext.t01_ape_mat,', ',ext.t01_nom_cto) AS moni_exte,
		estado.descrip AS estado,
		
		statme.nro_visitas AS nro_visitas_me,
		DATE_FORMAT(statme.ult_visita, '%d/%m/%Y') AS fch_ultima_visita_me,
		fn_puntaje_califica_inf_me(proy.t02_cod_proy, statme.inf_id, statme.inf_ver) AS califica_me,
		
		statmi.nro_visitas AS nro_visitas_mfe,
		DATE_FORMAT(statmi.ult_visita,'%d/%m/%Y') AS fch_ultima_visita_mfe,
		fn_puntaje_califica_inf_monint(proy.t02_cod_proy, statmi.inf_id, statmi.inf_ver) AS califica_mfe,
		
		proy.t02_dire_proy,
		proy.t02_ciud_proy,
		proy.t02_tele_proy,
		proy.t02_fax_proy,
		proy.t02_mail_proy
	FROM	   t02_dg_proy 		proy
	LEFT JOIN  (SELECT t02_cod_proy, t03_dpto, MAX(t02_version) FROM t03_dist_proy GROUP BY t02_cod_proy, t03_dpto) dp
										ON (proy.t02_cod_proy = dp.t02_cod_proy)
	LEFT JOIN  t01_dir_inst		inst	ON (proy.t01_id_inst = inst.t01_id_inst)
	LEFT JOIN  t90_equi_fe		mt		ON (proy.t02_moni_tema  =  mt.t90_id_equi) 
	LEFT JOIN  t90_equi_fe		mf		ON (proy.t02_moni_fina  =  mf.t90_id_equi) 
	LEFT JOIN  t01_inst_cto		ext		ON (proy.t02_moni_ext = CONCAT(ext.t01_id_inst,'.',ext.t01_id_cto))
	LEFT JOIN  adm_tablas_aux	estado	ON (proy.t02_estado  =  estado.codi) 
	LEFT JOIN  adm_tablas_aux	sec		ON (proy.t02_sect_prod = sec.codi)
	LEFT JOIN  adm_tablas_aux2	sub		ON (proy.t02_subsect_prod = sub.codi)
	LEFT JOIN  adm_tablas_aux	tipInst ON (inst.t01_tipo_inst = tipInst.codi)
	LEFT JOIN  adm_ubigeo 		reg		ON (dp.t03_dpto = reg.cod_dpto AND reg.cod_prov='00' AND reg.cod_dist='00')
	LEFT JOIN  (SELECT	t02_cod_proy, SUM(t60_mto_des) AS total_desem_fe
				FROM	t60_ejecucion_desemb 
				GROUP BY t02_cod_proy) AS desem ON (desem.t02_cod_proy = proy.t02_cod_proy)
	LEFT JOIN  (SELECT	t02_cod_proy, t02_version, SUM(t41_gasto) AS gasto_fe
				FROM	t41_inf_financ_gasto 
				WHERE	t41_fte_finan = 10
				GROUP BY t02_cod_proy, t02_version) AS gasfe ON (gasfe.t02_cod_proy = proy.t02_cod_proy 
													AND gasfe.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
	LEFT JOIN  (SELECT	t02_cod_proy, t02_version, SUM(t41_gasto) AS gasto_otros
				FROM	t41_inf_financ_gasto 
				WHERE	t41_fte_finan != 10
				GROUP BY t02_cod_proy, t02_version) AS gasotr ON (gasotr.t02_cod_proy = proy.t02_cod_proy 
													AND gasotr.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
	LEFT JOIN  (SELECT	t02_cod_proy, 
						MAX(t30_id) AS inf_id, 
						MAX(t30_ver_inf) AS inf_ver, 
						COUNT(*) AS nro_visitas, 
						MAX(t30_fch_pre) AS ult_visita
				FROM  t30_inf_me
				GROUP BY t02_cod_proy) statme ON (statme.t02_cod_proy = proy.t02_cod_proy)
	LEFT JOIN  (SELECT	t02_cod_proy, 
						MAX(t45_id) AS inf_id, 
						MAX(t45_ver_inf) AS inf_ver, 
						COUNT(*) AS nro_visitas, 
						MAX(t45_fch_pre) AS ult_visita
				FROM  t45_inf_mi
				GROUP BY t02_cod_proy) statmi ON (statmi.t02_cod_proy = proy.t02_cod_proy)
	WHERE 	proy.t02_version  = fn_ult_version_proy(proy.t02_cod_proy)
		AND inst.t01_tipo_inst = 	(CASE WHEN _TipoInst='*' THEN inst.t01_tipo_inst ELSE _TipoInst END );
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rev_infanual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rev_infanual`(IN _proy VARCHAR(10),
	IN _cod INT, IN _usr VARCHAR(20))
BEGIN
DECLARE _nomejec VARCHAR(30) ;
SELECT t01_sig_inst 
  INTO _nomejec 
  FROM t01_dir_inst 
 WHERE t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_proy AND p.t02_version=1);
 UPDATE t55_inf_unico_anual
	SET t55_estado=46,
		
			fch_actu = NOW()
	WHERE t02_cod_proy = _proy 
    AND t55_anio = _cod ;
	SELECT ROW_COUNT() AS numrows, _cod AS codigo ;
		CALL sp_ins_mensaje_proy_a_personalizado(	_proy, 
						'Solicitud de Revisión del Informe Único Anual', 
						CONCAT('El proyecto ', _proy, ', ha solicitado la revisión de su Informe Único Anual. \n\nPuede revisar el informe haciendo <a href="http://localhost/sgp/sme/monitoreofe/informes/inf_unico_anual_list.php?txtCodProy=',_proy,'"> click Aquí </a>' ),
						_nomejec,
						_usr,
						4
					     ) ;
			
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rev_noobjecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rev_noobjecioncompra`( IN _proy VARCHAR(10), 
																		IN _cod INT,  
																		IN _num VARCHAR(10),
																		IN _usr VARCHAR(20))
BEGIN
	DECLARE _nomejec VARCHAR(30);
	DECLARE aNumRows INT;
	DECLARE aCodigo INT;
	SELECT	t01_sig_inst 
	INTO	_nomejec 
	FROM	t01_dir_inst
	WHERE	t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_proy AND p.t02_version=1);
	UPDATE	t02_noobjecion_compra 
	SET		t02_env_rev=1,
			t02_estado=264,
		
			fch_actu = NOW()
	WHERE	t02_cod_proy = _proy 
		AND t02_id_noc = _cod;
		
	SELECT ROW_COUNT(), _cod INTO aNumRows, aCodigo;
	
	CALL sp_ins_mensaje_proy_a_personalizado(	_proy, 
						'Solicitud de Aprobación de No Objeción de Compras',
						CONCAT('El proyecto ', _proy, ', ha solicitado la aprobación de la No Objeción de Compras N°', _num,'. \n' ),
						_nomejec,
						_usr,
						5
					     ) ;
	SELECT aNumRows AS numrows, aCodigo AS codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_avance_fisico_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_avance_fisico_act`(IN _proy VARCHAR(10), 
					     IN _comp INT,
					     in _mes_ini INT,
					     in _mes_fin INT)
BEGIN
DECLARE _ver     INT ;
DECLARE _verIni  INT ;
SELECT fn_pri_version_proy(_proy) INTO _verIni ;
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1)    ),1) ;
SELECT
  act.t09_cod_act,
  CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
  act.t09_act AS actividad,
  NULL AS total_meta,
  
  SUM(cost.t10_cost_parc * sub.t09_mta_repro)  AS total_presup 
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
INNER JOIN t09_act      act  ON(sub.t02_cod_proy = act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version = _ver
  AND sub.t08_cod_comp= _comp
GROUP BY 1, 2, 3
ORDER BY act.t08_cod_comp, act.t09_cod_act ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_avance_fisico_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_avance_fisico_subact`(IN _proy  VARCHAR(10), 
					       IN _comp  INT, 
					       IN _act INT,
					       IN _mes_ini INT,
					       IN _mes_fin INT)
BEGIN
DECLARE _ver  INT ;
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1)    ),1) ;
  
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  sub.t09_mta_repro as meta,
  
  SUM(cost.t10_cost_parc * sub.t09_mta_repro) AS total_presup,
  
  fn_meta_programada_periodo(cost.t02_cod_proy , cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub , _mes_ini, _mes_fin) AS programado,
  IFNULL(
   ( SELECT SUM(inf.t09_sub_avanc) 
     FROM  t09_act_sub_mtas_inf inf 
     WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       and inf.t09_cod_sub =sub.t09_cod_sub
       
       AND (fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
   
   (select MAX(inf.t51_obs) 
      from t51_inf_mf_avance_meta inf
      INNER JOIN t51_inf_mf cab ON (inf.t02_cod_proy=cab.t02_cod_proy AND inf.t51_num=cab.t51_num)
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND cab.t51_per_ini >= _mes_ini 
       AND cab.t51_per_fin <= _mes_fin 
    ) as observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_avance_presup_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_avance_presup_act`(IN _proy VARCHAR(10), 
					    IN _comp INT, 
					    IN _idFte INT,
					    IN _mes_ini INT,
					    IN _mes_fin INT )
BEGIN
DECLARE _ver     INT ;
DECLARE _verIni  INT ;
SELECT fn_pri_version_proy(_proy) INTO _verIni ;
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1)  ),1) ;
SELECT
  act.t09_cod_act,
  CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
  act.t09_act AS actividad,
  SUM(cost.t10_cost_parc * sub.t09_mta_repro)  AS total_presup,
   SUM(fn_monto_planificado_fte_periodo(cost.t02_cod_proy, cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , cost.t10_cod_cost,
				         _idFte, _mes_ini, _mes_fin)) AS programado,
				         
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy  = cost.t02_cod_proy
       AND gas.t08_cod_comp  = cost.t08_cod_comp
       AND gas.t09_cod_act   = cost.t09_cod_act
       AND gas.t41_fte_finan = _idFte
       AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado
FROM       t09_subact sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
INNER JOIN t09_act 	act  ON(sub.t02_cod_proy = act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version= _ver
  AND sub.t08_cod_comp= _comp
GROUP BY 1, 2, 3
ORDER BY act.t08_cod_comp, act.t09_cod_act ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_avance_presup_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_avance_presup_subact`(IN _proy  VARCHAR(10), 
					       IN _comp  INT, 
					       IN _act INT,
					       IN _idFte INT,
					       IN _mes_ini INT,
					       IN _mes_fin INT)
BEGIN
DECLARE _ver  INT ;
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1) ),1) ;
  
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  sub.t09_mta_repro AS meta,
  SUM(cost.t10_cost_parc * sub.t09_mta_repro)  AS total_presup,
  SUM(fn_monto_planificado_fte_periodo(cost.t02_cod_proy, cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , cost.t10_cod_cost,
				         _idFte, _mes_ini, _mes_fin)) AS programado,
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy=cost.t02_cod_proy
       AND gas.t08_cod_comp=cost.t08_cod_comp
       AND gas.t09_cod_act =cost.t09_cod_act
       AND gas.t09_cod_sub =cost.t09_cod_sub
       AND gas.t41_fte_finan=_idFte
      AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
    (SELECT SUM(inf.t51_no_gasto)
      FROM t51_inf_mf_avance_monto inf
      INNER JOIN t51_inf_mf cab ON (inf.t02_cod_proy=cab.t02_cod_proy AND inf.t51_num=cab.t51_num)
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND inf.t51_fuente  = _idFte
       AND cab.t51_per_ini >= _mes_ini 
       AND cab.t51_per_fin <= _mes_fin 
    ) AS gasto_no_aceptado   ,
    
    (SELECT MAX(inf.t51_obs)
      FROM t51_inf_mf_avance_monto inf
      INNER JOIN t51_inf_mf cab ON (inf.t02_cod_proy=cab.t02_cod_proy AND inf.t51_num=cab.t51_num)
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND inf.t51_fuente  = _idFte
       AND cab.t51_per_ini >= _mes_ini 
       AND cab.t51_per_fin <= _mes_fin 
    ) AS observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_avance_tec_finan` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_avance_tec_finan`(						
					    IN _proyecto VARCHAR(10)
					    )
BEGIN

	select 
        `proy`.`t02_cod_proy` AS `codigo`,
        `proy`.`t02_version` AS `version`,
        `proy`.`t02_nom_proy` AS `titulo`,
        
        date_format(`proy`.`t02_fch_ter`, '%d/%m/%Y') AS `termino`,
        date_format(`proy`.`t02_fch_ire`, '%d/%m/%Y') AS `inic_real`,
        `ins`.`t01_nom_inst` AS `nominst`,
        `proy`.`t02_ben_obj` AS `beneficiarios`,
        
        
        
        if(((`proy`.`t02_fch_ire` is not null)
                and (date_format(`proy`.`t02_fch_ire`, '%d/%m/%Y') <> '00/00/0000')),
            date_format(`proy`.`t02_fch_ire`, '%d/%m/%Y'),
			date_format(`proy`.`t02_fch_ini`, '%d/%m/%Y')
            ) AS `fecha_inicio`,
        (case
            when
                (`proy`.`t02_estado` = 41)
            then
                if((ifnull(`proy`.`t02_num_mes_amp`, 0) > 0),
					date_format(`proy`.`t02_fch_tam`, '%d/%m/%Y'),
					date_format(`proy`.`t02_fch_tre`, '%d/%m/%Y')
				)
            else date_format(`proy`.`t02_fch_tre`, '%d/%m/%Y')
        end) AS `fecha_termino`
    from
        		
			`t02_dg_proy` `proy`
			join `t01_dir_inst` `ins` ON `proy`.`t01_id_inst` = `ins`.`t01_id_inst`
		
			left join `adm_tablas_aux` `est` ON `proy`.`t02_estado` = `est`.`codi`
					
		
    where
        `proy`.`t02_version` = fn_ult_version_proy(`proy`.`t02_cod_proy`) AND 
		`proy`.`t02_cod_proy` = (CASE WHEN _proyecto ='' THEN `proy`.`t02_cod_proy` ELSE _proyecto END) 
    order by `proy`.`t02_cod_proy`;

END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_benchmark` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_benchmark`(IN _concurso VARCHAR(10), 
				    IN _region   INT,
				    IN _sector   INT,
				    IN _tipoinst INT,
				    IN _estado   INT)
BEGIN
IF _region <= 0 THEN
	SELECT 
		t.codigo, 
		t.version,
		t.expediente, 
		t.codinst, 
		t.titulo, 
		t.inicio, 
		t.termino, 
		t.siglas, 
		t.estado,
		fn_avance_total_subactividad(codigo, anioProy, mesProy) AS Avance ,
		fn_avance_acum_subactividad(codigo, anioProy, mesProy) AS AvanceTotal, 
		t.sectoresprod,
		t.anio,
		t.trimestre,
		t.presentacion,
		t.fecha_inicio AS finicio,
		t.ftermino,
		t.anioProy,
		t.mesProy
	FROM (
		SELECT 
			codigo, 
			v_matriz_proyectos.version,
			expediente, 
			codinst, 
			titulo, 
			inicio, 
			termino, 
			siglas, 
			estado,
			CONCAT(IFNULL(sector,''),' / ',IFNULL(subsector,'')) AS sectoresprod,
			(SELECT MAX(t25_anio)  FROM t25_inf_trim WHERE t02_cod_proy=codigo) AS anio,
			(SELECT MAX(t25_trim)  FROM t25_inf_trim WHERE t02_cod_proy=codigo) AS trimestre,
			(SELECT MAX(t25_fch_pre) FROM t25_inf_trim WHERE t02_cod_proy = codigo) AS presentacion,
			fecha_inicio,
			(SELECT t02_fch_ter FROM t02_dg_proy WHERE t02_cod_proy = codigo AND t02_version = fn_ult_version_proy(codigo)) AS ftermino,
			fn_anio_proy(YEAR(CURDATE()), codigo) AS anioProy,
			fn_mes_proy(CURDATE(), codigo) AS mesProy
			FROM v_matriz_proyectos 
			WHERE concurso = (CASE WHEN _concurso = '*' THEN  concurso ELSE _concurso END)
				AND IFNULL(codsector,0) = (CASE WHEN _sector <=0 THEN IFNULL(codsector,0) ELSE _sector END)
				AND IFNULL(codtipoinst,0) = (CASE WHEN _tipoinst <=0 THEN IFNULL(codtipoinst,0) ELSE _tipoinst END)
				AND IFNULL(est, 0) = (CASE WHEN _estado = '*' THEN IFNULL(est, 0) ELSE _estado END)
	) t
	ORDER BY 11 DESC;
ELSE
	SELECT 
		t.codigo, 
		t.version,
		t.expediente, 
		t.codinst, 
		t.titulo, 
		t.inicio, 
		t.termino, 
		t.siglas, 
		t.estado,
		fn_avance_total_subactividad(codigo, anioProy, mesProy) AS Avance ,
		fn_avance_acum_subactividad(codigo, anioProy, mesProy) AS AvanceTotal, 
		t.sectoresprod,
		t.anio,
		t.trimestre,
		t.presentacion,
		t.fecha_inicio AS finicio,
		t.ftermino,
		t.anioProy, 
		t.mesProy
	FROM (
		SELECT 
			m.codigo, 
			m.version,
			m.expediente, 
			m.codinst, 
			m.titulo, 
			m.inicio, 
			m.termino, 
			m.siglas, 
			m.estado,
			CONCAT(IFNULL(m.sector,''),' / ',IFNULL(m.subsector,'')) AS sectoresprod,
			(SELECT MAX(t25_anio)  FROM t25_inf_trim WHERE t02_cod_proy=codigo) AS anio,
			(SELECT MAX(t25_trim)  FROM t25_inf_trim WHERE t02_cod_proy=codigo) AS trimestre,
			(SELECT MAX(t25_fch_pre) FROM t25_inf_trim WHERE t02_cod_proy = codigo) AS presentacion,
			m.fecha_inicio,
			(SELECT t02_fch_ter FROM t02_dg_proy WHERE t02_cod_proy = codigo AND t02_version = fn_ult_version_proy(codigo)) AS ftermino,
			fn_anio_proy(YEAR(CURDATE()), m.codigo) AS anioProy,
			fn_mes_proy(CURDATE(), m.codigo) AS mesProy
		FROM v_matriz_proyectos m
		WHERE m.concurso = (CASE WHEN _concurso = '*' THEN  concurso ELSE _concurso END)
			AND IFNULL(m.codsector,0) = (CASE WHEN _sector <=0 THEN IFNULL(codsector,0) ELSE _sector END)
			AND IFNULL(m.codtipoinst,0) = (CASE WHEN _tipoinst <=0 THEN IFNULL(codtipoinst,0) ELSE _tipoinst END)
			AND m.codigo IN (SELECT DISTINCT t02_cod_proy FROM t03_dist_proy WHERE t03_dpto=_region)
			AND IFNULL(est, 0) = (CASE WHEN _estado = '*' THEN IFNULL(est, 0) ELSE _estado END)
	) t
	ORDER BY 11 DESC;
END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_beneficiarios` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_beneficiarios`(IN _proy VARCHAR(10))
BEGIN
	SELECT 	ben.t11_cod_bene AS codigo, 
		ben.t11_dni AS dni, 
		CONCAT(ben.t11_ape_pat,' ', ben.t11_ape_mat, ', ', ben.t11_nom) AS nombres,
		sex.descrip AS sexo,
		IF(ben.t11_edad=0,'',ben.t11_edad) AS edad,
		ben.t11_nivel_educ, 
		ben.t11_especialidad, 
		DATE_FORMAT(ben.t11_fec_ini,'%d/%m/%Y') AS fec_ini, 
		DATE_FORMAT(ben.t11_fec_ter,'%d/%m/%Y') AS fec_cese, 
		IF(ben.t11_nro_up_b=0,'',ben.t11_nro_up_b) AS t11_nro_up_b,	
		IF(ben.t11_tot_unid_prod=0,'',ben.t11_tot_unid_prod) AS t11_tot_unid_prod,
		IF(ben.t11_tot_unid_prod_2=0,'',ben.t11_tot_unid_prod_2) AS t11_tot_unid_prod_2, 	 	 
		IF(ben.t11_nro_up_b_2=0,'',ben.t11_nro_up_b_2) AS t11_nro_up_b_2,
		IF(ben.t11_tot_unid_prod_3=0,'',ben.t11_tot_unid_prod_3) AS t11_tot_unid_prod_3, 	 
		IF(ben.t11_nro_up_b_3=0,'',ben.t11_nro_up_b_3) AS t11_nro_up_b_3,	 
		ben.t11_nom_prod, 
		ben.t11_direccion,
		ben.t11_dpto,
		ben.t11_prov,
		ben.t11_dist,
		ben.t11_case, 	 	
		dep.nom_ubig AS dpto,
		pro.nom_ubig AS prov,
		dis.nom_ubig AS dist,
		cas.nom_case AS caserio,
		ben.t11_ciudad, 
		ben.t11_case, 
		ben.t11_act_princ, 
		ben.t11_telefono, 
		ben.t11_celular, 
		ben.t11_mail,
		ben.t02_cod_proy,
		ben.t11_obs AS observaciones,
		sec1.descrip AS sector1,
		sub1.descrip AS subsector1,
		uni1.descrip AS uni_prod1,	
		sec2.descrip AS sector2,
		sub2.descrip AS subsector2,
		uni2.descrip AS uni_prod2,	
		sec3.descrip AS sector3,
		sub3.descrip AS subsector3,
		uni3.descrip AS uni_prod3,	
		niv.descrip AS nivel_educ,
		esp.descrip AS especialidad,
		est.descrip AS estado	
	FROM 	t11_bco_bene ben
			
	LEFT JOIN adm_tablas_aux sex ON(ben.t11_sexo=sex.codi)
	LEFT JOIN adm_tablas_aux niv ON(ben.t11_nivel_educ=niv.codi)
	LEFT JOIN adm_tablas_aux esp ON(ben.t11_especialidad=esp.codi)
	LEFT JOIN adm_tablas_aux sec1 ON(ben.t11_sec_prod=sec1.codi)
	LEFT JOIN adm_tablas_aux2 sub1 ON(ben.t11_subsector=sub1.codi)
	LEFT JOIN adm_tablas_aux uni1 ON(ben.t11_unid_prod_1=uni1.codi)
	LEFT JOIN adm_tablas_aux sec2 ON(ben.t11_sec_prod_2=sec2.codi)
	LEFT JOIN adm_tablas_aux2 sub2 ON(ben.t11_subsec_prod_2=sub2.codi)
	LEFT JOIN adm_tablas_aux uni2 ON(ben.t11_unid_prod_2=uni2.codi)
	LEFT JOIN adm_tablas_aux sec3 ON(ben.t11_sec_prod_3=sec3.codi)
	LEFT JOIN adm_tablas_aux2 sub3 ON(ben.t11_subsec_prod_3=sub3.codi)
	LEFT JOIN adm_tablas_aux uni3 ON(ben.t11_unid_prod_3=uni3.codi)
	LEFT JOIN adm_tablas_aux est ON(ben.t11_estado=est.codi)
	LEFT JOIN adm_ubigeo dep ON (ben.t11_dpto=dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
	LEFT JOIN adm_ubigeo pro ON (ben.t11_dpto=pro.cod_dpto AND ben.t11_prov=pro.cod_prov AND pro.cod_dist='00')
	LEFT JOIN adm_ubigeo dis ON (ben.t11_dpto=dis.cod_dpto AND ben.t11_prov=dis.cod_prov AND ben.t11_dist=dis.cod_dist)
	LEFT JOIN adm_caserios cas ON (ben.t11_dpto=cas.cod_dpto AND ben.t11_prov=cas.cod_prov AND ben.t11_dist=cas.cod_dist AND ben.t11_case=cas.cod_case)
	WHERE t02_cod_proy = CASE WHEN _proy= '*' THEN t02_cod_proy ELSE _proy END 
	ORDER BY 3 ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_beneficiarios_tot` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_beneficiarios_tot`(pConcurso VARCHAR(10))
BEGIN
SELECT IFNULL(pConcurso, '*') INTO pConcurso;
SELECT 	ben.t11_cod_bene AS codigo,
	inst.t01_sig_inst AS inst_eject,
	ben.t11_dni AS dni, 
	CONCAT(ben.t11_ape_pat,' ', ben.t11_ape_mat, ', ', ben.t11_nom) AS nombres,
	ben.t02_cod_proy AS codigo_proyecto,
	sex.descrip AS sexo,
	IF(ben.t11_edad=0,'',ben.t11_edad) AS edad,
	ben.t11_nivel_educ, 
	ben.t11_especialidad, 
	DATE_FORMAT(ben.t11_fec_ini,'%d/%m/%Y') AS fec_ini, 
	DATE_FORMAT(ben.t11_fec_ter,'%d/%m/%Y') AS fec_cese, 
	IF(ben.t11_nro_up_b=0,'',ben.t11_nro_up_b) AS t11_nro_up_b,	
	IF(ben.t11_tot_unid_prod=0,'',ben.t11_tot_unid_prod) AS t11_tot_unid_prod,
	IF(ben.t11_tot_unid_prod_2=0,'',ben.t11_tot_unid_prod_2) AS t11_tot_unid_prod_2, 	 	 
	IF(ben.t11_nro_up_b_2=0,'',ben.t11_nro_up_b_2) AS t11_nro_up_b_2,
	IF(ben.t11_tot_unid_prod_3=0,'',ben.t11_tot_unid_prod_3) AS t11_tot_unid_prod_3, 	 
	IF(ben.t11_nro_up_b_3=0,'',ben.t11_nro_up_b_3) AS t11_nro_up_b_3,	 
	ben.t11_nom_prod, 
	ben.t11_direccion,
	ben.t11_dpto,
	ben.t11_prov,
	ben.t11_dist,
	ben.t11_case, 	 	
	dep.nom_ubig AS dpto,
	pro.nom_ubig AS prov,
	dis.nom_ubig AS dist,
	cas.nom_case AS caserio,
	ben.t11_ciudad, 
	ben.t11_case, 
	ben.t11_act_princ, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail,
	ben.t11_obs AS observaciones,
	sec1.descrip AS sector1,
	sub1.descrip AS subsector1,
	uni1.descrip AS uni_prod1,	
	sec2.descrip AS sector2,
	sub2.descrip AS subsector2,
	uni2.descrip AS uni_prod2,	
	sec3.descrip AS sector3,
	sub3.descrip AS subsector3,
	uni3.descrip AS uni_prod3,	
	niv.descrip AS nivel_educ,
	esp.descrip AS especialidad,
	est.descrip AS estado,
	fn_count_benef_cap(proy.t02_cod_proy, ben.t11_cod_bene, 202) AS cap_prod,
	fn_count_benef_cap(proy.t02_cod_proy, ben.t11_cod_bene, 203) AS cap_gest,
	fn_count_benef_cap(proy.t02_cod_proy, ben.t11_cod_bene, 204) AS cap_comer,
	fn_count_benef_cap(proy.t02_cod_proy, ben.t11_cod_bene, 205) AS cap_empre,
	fn_count_benef_at(proy.t02_cod_proy, ben.t11_cod_bene, 202) AS at_prod,
	fn_count_benef_at(proy.t02_cod_proy, ben.t11_cod_bene, 203) AS at_gest,
	fn_count_benef_at(proy.t02_cod_proy, ben.t11_cod_bene, 204) AS at_comer,
	fn_count_benef_at(proy.t02_cod_proy, ben.t11_cod_bene, 205) AS at_empre,
	fn_count_benef_cred(proy.t02_cod_proy, ben.t11_cod_bene) AS nro_cred,
	(SELECT		SUM(t12_mto_ben)
		FROM	t12_plan_cred_benef
		WHERE	t02_cod_proy = proy.t02_cod_proy 
			AND t02_version = (SELECT MAX(t02_version) 
									FROM t12_plan_cred_benef 
									WHERE t02_cod_proy = proy.t02_cod_proy)
			AND t11_cod_benef = ben.t11_cod_bene) AS mto_pres,
	(SELECT		SUM(t15_avance) 
		FROM	t25_inf_trim_cred
		WHERE	t02_cod_proy = proy.t02_cod_proy  
			AND t11_cod_bene = ben.t11_cod_bene) AS mto_pgdo,
	fn_count_benef_otros(proy.t02_cod_proy, ben.t11_cod_bene, 230) AS otr_prod,
	fn_count_benef_otros(proy.t02_cod_proy, ben.t11_cod_bene, 231) AS otr_gest,
	fn_count_benef_otros(proy.t02_cod_proy, ben.t11_cod_bene, 232) AS otr_comer,
	fn_count_benef_otros(proy.t02_cod_proy, ben.t11_cod_bene, 271) AS otr_empre	
FROM		t11_bco_bene	ben
JOIN		t02_dg_proy		proy ON (proy.t02_cod_proy = ben.t02_cod_proy 
									AND t02_version = fn_ult_version_proy(ben.t02_cod_proy))
JOIN		t01_dir_inst	inst ON (proy.t01_id_inst = inst.t01_id_inst)
LEFT JOIN adm_tablas_aux sex ON(ben.t11_sexo=sex.codi)
LEFT JOIN adm_tablas_aux niv ON(ben.t11_nivel_educ=niv.codi)
LEFT JOIN adm_tablas_aux esp ON(ben.t11_especialidad=esp.codi)
LEFT JOIN adm_tablas_aux sec1 ON(ben.t11_sec_prod=sec1.codi)
LEFT JOIN adm_tablas_aux2 sub1 ON(ben.t11_subsector=sub1.codi)
LEFT JOIN adm_tablas_aux uni1 ON(ben.t11_unid_prod_1=uni1.codi)
LEFT JOIN adm_tablas_aux sec2 ON(ben.t11_sec_prod_2=sec2.codi)
LEFT JOIN adm_tablas_aux2 sub2 ON(ben.t11_subsec_prod_2=sub2.codi)
LEFT JOIN adm_tablas_aux uni2 ON(ben.t11_unid_prod_2=uni2.codi)
LEFT JOIN adm_tablas_aux sec3 ON(ben.t11_sec_prod_3=sec3.codi)
LEFT JOIN adm_tablas_aux2 sub3 ON(ben.t11_subsec_prod_3=sub3.codi)
LEFT JOIN adm_tablas_aux uni3 ON(ben.t11_unid_prod_3=uni3.codi)
LEFT JOIN adm_tablas_aux est ON(ben.t11_estado=est.codi)
LEFT JOIN adm_ubigeo dep ON (ben.t11_dpto=dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
LEFT JOIN adm_ubigeo pro ON (ben.t11_dpto=pro.cod_dpto AND ben.t11_prov=pro.cod_prov AND pro.cod_dist='00')
LEFT JOIN adm_ubigeo dis ON (ben.t11_dpto=dis.cod_dpto AND ben.t11_prov=dis.cod_prov AND ben.t11_dist=dis.cod_dist)
LEFT JOIN adm_caserios cas ON (ben.t11_dpto=cas.cod_dpto AND ben.t11_prov=cas.cod_prov AND ben.t11_dist=cas.cod_dist AND ben.t11_case=cas.cod_case)
WHERE	SUBSTR(ben.t02_cod_proy, 3, 2) = CASE WHEN pConcurso = '*' THEN SUBSTR(ben.t02_cod_proy, 3, 2) ELSE pConcurso END
ORDER BY 4,3 ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_consolidado_benef` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_consolidado_benef`(  IN _proy VARCHAR(10), 
																		  IN _anio INT, 
																		  IN _trim INT)
BEGIN
	DECLARE _sql       LONGTEXT;
	DECLARE _tmpsql    TEXT DEFAULT ' 
	SELECT  ben.t11_cod_bene, 
		ben.t11_dni, 
		CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
		sex.descrip AS sexo, 
		ben.t11_edad, 
		niv.descrip AS nivel,
		esp.descrip AS especialidad,
		(SELECT ubig.nom_ubig
			FROM adm_ubigeo ubig
			WHERE ubig.cod_dpto = ben.t11_dpto
			AND ubig.cod_prov = 0
			AND ubig.cod_dist = 0) AS departamento,
		(SELECT ubig.nom_ubig
			FROM adm_ubigeo ubig
			WHERE ubig.cod_dpto = ben.t11_dpto
			AND ubig.cod_prov = ben.t11_prov
			AND ubig.cod_dist = 0) AS provincia,
		(SELECT ubig.nom_ubig
			FROM adm_ubigeo ubig
			WHERE ubig.cod_dpto = ben.t11_dpto
			AND ubig.cod_prov = ben.t11_prov
			AND ubig.cod_dist = ben.t11_dist) AS distrito,
		(SELECT cas.nom_case
			FROM adm_caserios cas
			WHERE cas.cod_dpto = ben.t11_dpto
			AND cas.cod_prov = ben.t11_prov
			AND cas.cod_dist = ben.t11_dist
			AND cas.cod_case = ben.t11_case) AS caserio,
		ben.t11_direccion, 
		ben.t11_ciudad, 
		ben.t11_telefono, 
		ben.t11_celular, 
		ben.t11_mail, 
		sec1.descrip AS sec_prod_1, 
		sec2.descrip AS sec_prod_2, 
		sec3.descrip AS sec_prod_3,
		subsec1.descrip AS subsec_prod_1,
		subsec2.descrip AS subsec_prod_2,
		subsec3.descrip AS subsec_prod_3,
		ben.t11_unid_prod_1, 
		ben.t11_unid_prod_2, 
		ben.t11_unid_prod_3,
		ben.t11_tot_unid_prod as t11_tot_unid_prod_1,
		ben.t11_tot_unid_prod_2,
		ben.t11_tot_unid_prod_3,
		ben.t11_nro_up_b as t11_nro_up_b_1,
		ben.t11_nro_up_b_2,
		ben.t11_nro_up_b_3,
		est.descrip AS estado,
		ben.t11_fec_ini,
		ben.t11_fec_ter
		
	{subquerys}
	FROM 	  t11_bco_bene ben
	INNER JOIN t12_plan_capac_tema plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
	LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
	LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
	LEFT JOIN adm_tablas_aux esp ON (ben.t11_especialidad = esp.codi and esp.idTabla =  26)
	LEFT JOIN adm_tablas_aux sec1 ON (ben.t11_sec_prod = sec1.codi AND sec1.idTabla = 18) 
	LEFT JOIN adm_tablas_aux sec2 ON (ben.t11_sec_prod_2 = sec2.codi AND sec1.idTabla = 18) 
	LEFT JOIN adm_tablas_aux sec3 ON (ben.t11_sec_prod_3 = sec3.codi AND sec1.idTabla = 18) 
	LEFT JOIN adm_tablas_aux2 subsec1 ON (ben.t11_subsector = subsec1.codi AND subsec1.idTabla = 18)
	LEFT JOIN adm_tablas_aux2 subsec2 ON (ben.t11_subsec_prod_2 = subsec2.codi AND subsec1.idTabla = 18)
	LEFT JOIN adm_tablas_aux2 subsec3 ON (ben.t11_subsec_prod_3 = subsec3.codi AND subsec1.idTabla = 18)
	LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
	WHERE 
		  ben.t02_cod_proy = \'{_proy}\'
	GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30
	ORDER BY nombres ASC; ' ;
	DECLARE _tmpsubsql TEXT DEFAULT '
		 (
		  SELECT cap.t15_avance 
			FROM t25_inf_trim_capac cap
		   WHERE cap.t02_cod_proy = \'{_proy}\'
			 AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
			 AND cap.t12_cod_tema = {_codtema}
			 AND cap.t25_anio = {_anio}
			 AND cap.t25_trim = {_trim}
			 AND cap.t11_cod_bene = ben.t11_cod_bene
		  ) AS \'{_codsubtema}\'' ;
		  
	DECLARE _subsql TEXT;
	DECLARE _contador  INT ;
	DECLARE _codfte   INT ;
	DECLARE _ver      INT DEFAULT fn_version_proy_poa(_proy, _anio);
	DECLARE _nomfte   VARCHAR(50) ;
	DECLARE _codFE    INT DEFAULT 10 ;
	DECLARE _escape INT DEFAULT 0;
	DECLARE _codsub CHAR(10);
	DECLARE _codtema INT;
	DECLARE _nomtema VARCHAR(150);
	DECLARE _nrohora DOUBLE ;
	DECLARE _curtemas CURSOR 
					 FOR 
					 SELECT 	CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS subact,
					tema.t12_cod_tema,
					tema.t12_tem_espe,
					tema.t12_nro_hora
				FROM 	   t12_plan_capac_tema tema
				INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
				WHERE tema.t02_cod_proy = _proy
				  AND tema.t02_version  = _ver 
				ORDER BY t12_modulo, subact , t12_cod_tema ;
				  
	DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
	SET _sql = '' ;
	OPEN _curtemas;
	REPEAT
	FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nrohora ;
	IF NOT _escape THEN
		SET _subsql = REPLACE(_tmpsubsql,'{_proy}',_proy);
		SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
		SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
		SET _subsql = REPLACE(_subsql,'{_codtema}',_codtema);
		SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
		SET _subsql = REPLACE(_subsql,'{_trim}',_trim);
		SET _subsql = REPLACE(_subsql,'{_codsubtema}', CONCAT(_codsub,'.',_codtema) );
		
		SELECT CONCAT(_sql, '	,',_subsql,'\n') INTO _sql ;
		
	END IF;
	UNTIL _escape END REPEAT;
	CLOSE _curtemas;
	SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
	SET _sql = REPLACE(_sql,'{_proy}', _proy);
	SET _sql = REPLACE(_sql,'{_ver}' , _ver);
	SELECT _sql INTO @txtsql;
	PREPARE stmt FROM @txtsql;
	EXECUTE stmt;
	DEALLOCATE PREPARE stmt;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_contactos_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_contactos_inst`()
BEGIN
	SELECT 	i.t01_sig_inst, 
		cto.t01_id_inst, 
		cto.t01_id_cto, 
		cto.t01_dni_cto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		cto.t01_cel_cto, 
		IFNULL(cto.t01_fono_ofi,'') AS t01_fono_ofi, 
		IFNULL(cto.t01_mail_cto,'') AS t01_mail_cto,
		IFNULL(cto.t01_mail_cto2,'') AS t01_mail_cto2,
		IFNULL(cto.t01_tel2_cto,'') AS t01_tel2_cto,
		IFNULL(cto.t01_rpm_cto,'') AS t01_rpm_cto,
		IFNULL(cto.t01_fax_cto,'') AS t01_fax_cto,
		IFNULL(cto.t01_rpc_cto,'') AS t01_rpc_cto,
		IFNULL(cto.t01_nex_cto,'') AS t01_nex_cto,
		t.descrip AS cargo, 
		cto.usr_crea
	FROM t01_inst_cto cto
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=cto.t01_id_inst)
	ORDER BY nombres, i.t01_sig_inst;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_contactos_inst_filtro` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_contactos_inst_filtro`(IN _filter VARCHAR(20))
BEGIN
	SELECT 	i.t01_sig_inst, 
		cto.t01_id_inst, 
		cto.t01_id_cto, 
		cto.t01_dni_cto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		cto.t01_cel_cto, 
		IFNULL(cto.t01_fono_ofi,'') AS t01_fono_ofi, 
		IFNULL(cto.t01_mail_cto,'') AS t01_mail_cto,
		IFNULL(cto.t01_mail_cto2,'') AS t01_mail_cto2,
		IFNULL(cto.t01_tel2_cto,'') AS t01_tel2_cto,
		IFNULL(cto.t01_rpm_cto,'') AS t01_rpm_cto,
		IFNULL(cto.t01_fax_cto,'') AS t01_fax_cto,
		IFNULL(cto.t01_rpc_cto,'') AS t01_rpc_cto,
		IFNULL(cto.t01_nex_cto,'') AS t01_nex_cto,
		t.descrip AS cargo, 
		cto.usr_crea
	FROM t01_inst_cto cto
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=cto.t01_id_inst)
	WHERE CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) LIKE CONCAt("%",_filter ,"%")
	OR t.descrip LIKE CONCAt("%",_filter ,"%")
	OR i.t01_sig_inst LIKE CONCAt("%",_filter ,"%")
	ORDER BY i.t01_sig_inst, nombres  ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_contactos_ins_alt` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_contactos_ins_alt`(IN _inst INT, IN _proy VARCHAR(10), IN _cargo INT, 
																IN _like VARCHAR(10), IN _dpto VARCHAR(10), IN _sector INT)
BEGIN
	(
SELECT 	
		cto.t01_dni_cto,
		TRIM(CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto )) AS nombres,
		cto.t01_cel_cto, 
		IFNULL(cto.t01_fono_ofi,'') AS t01_fono_ofi, 
		IFNULL(cto.t01_mail_cto,'') AS t01_mail_cto,
		IFNULL(cto.t01_tel2_cto,'') AS t01_tel2_cto,
		IFNULL(cto.t01_rpm_cto,'') AS t01_rpm_cto,
		IFNULL(cto.t01_fax_cto,'') AS t01_fax_cto,
		IFNULL(cto.t01_rpc_cto,'') AS t01_rpc_cto,
		IFNULL(cto.t01_nex_cto,'') AS t01_nex_cto,
		t.descrip AS cargo, 
		cto.usr_crea,
		'' AS sexo,
		i.t01_sig_inst AS institucion
	FROM t01_inst_cto cto
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=cto.t01_id_inst)
	LEFT JOIN t02_dg_proy proy ON (proy.t01_id_inst = cto.t01_id_inst)
	LEFT JOIN t03_dist_proy t_proy ON (t_proy.t02_cod_proy = proy.t02_cod_proy)
	WHERE ifnull(cto.t01_id_inst, 0) = (CASE WHEN _inst = '*' THEN IFNULL(cto.t01_id_inst, 0) ELSE _inst END)
	AND IFNULL(proy.t02_cod_proy, 0) = (CASE WHEN _proy = '*' OR _proy = '' THEN IFNULL(proy.t02_cod_proy, 0) ELSE _proy END)
	AND IFNULL(cto.t01_cgo_cto, 0) = (CASE WHEN _cargo = '*' THEN IFNULL(cto.t01_cgo_cto, 0) ELSE _cargo END)
	AND CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) LIKE CONCAT("%",_like,"%")
	AND IFNULL(t_proy.t03_dpto, 0) = (CASE WHEN _dpto = '*' THEN IFNULL(t_proy.t03_dpto, 0) ELSE _dpto END)
	AND IFNULL(proy.t02_sect_prod, 0) = (CASE WHEN _sector = '*' THEN IFNULL(proy.t02_sect_prod, 0) ELSE _sector END)
	ORDER BY nombres ASC
	
)
	UNION
	(SELECT 
		p.t04_dni_equi as t01_dni_cto,
		TRIM(CONCAT(p.t04_ape_pat,' ',p.t04_ape_mat, ', ', p.t04_nom_equi)) as nombres,
		p.t04_cel_equi as t01_cel_cto, 
		IFNULL(p.t04_telf_equi,'') AS t01_fono_ofi,
		IFNULL(p.t04_mail_equi ,'') AS t01_mail_cto,
		'' AS t01_tel2_cto,
		'' AS t01_rpm_cto,
		'' AS t01_fax_cto,
		'' AS t01_rpc_cto,
		'' AS t01_nex_cto,
		t.t03_nom_per AS cargo, 
		p.usr_crea,
		t2.descrip AS sexo,
		i.t01_sig_inst AS institucion
	FROM t04_equi_proy p
	INNER JOIN t02_dg_proy proy ON (proy.t02_cod_proy = p.t02_cod_proy)
	INNER JOIN t01_dir_inst i ON (i.t01_id_inst = proy.t01_id_inst)
	LEFT JOIN t03_mp_per t ON (p.t02_cod_proy = t.t02_cod_proy AND p.t04_carg_equi = t.t03_id_per)
	LEFT JOIN adm_tablas_aux t2 ON (p.t04_sexo_equi = t2.codi)
	LEFT JOIN t03_dist_proy t_proy ON (t_proy.t02_cod_proy = proy.t02_cod_proy)
	WHERE ifnull(i.t01_id_inst, 0) = (CASE WHEN _inst = '*' THEN IFNULL(i.t01_id_inst, 0) ELSE _inst END)
	AND IFNULL(proy.t02_cod_proy, 0) = (CASE WHEN _proy = '*' OR _proy = '' THEN IFNULL(proy.t02_cod_proy, 0) ELSE _proy END)
	AND IFNULL(p.t04_carg_equi, 0) = (CASE WHEN _cargo = '*' THEN IFNULL(p.t04_carg_equi, 0) ELSE _cargo END)
	AND CONCAT(p.t04_ape_pat,' ',p.t04_ape_mat, ', ', p.t04_nom_equi) LIKE CONCAT("%",_like,"%")
	AND IFNULL(t_proy.t03_dpto, 0) = (CASE WHEN _dpto = '*' THEN IFNULL(t_proy.t03_dpto, 0) ELSE _dpto END)
	AND IFNULL(proy.t02_sect_prod, 0) = (CASE WHEN _sector = '*' THEN IFNULL(proy.t02_sect_prod, 0) ELSE _sector END)
	ORDER BY nombres ASC
)
UNION
(	
	SELECT f.t90_dni_equi as t01_dni_cto,
		TRIM(CONCAT(f.t90_ape_pat,' ',f.t90_ape_mat, ', ', f.t90_nom_equi)) AS nombres,
		'' as t01_cel_cto, 
		IFNULL(f.t90_telf_equi,'') AS t01_fono_ofi,
		IFNULL(f.t90_mail_equi ,'') AS t01_mail_cto,
		'' AS t01_tel2_cto,
		'' AS t01_rpm_cto,
		'' AS t01_fax_cto,
		'' AS t01_rpc_cto,
		'' AS t01_nex_cto,
		t.descrip AS cargo, 
		f.usr_crea,
		t2.descrip AS sexo,
		'FONDOEMPLEO' AS institucion
	FROM t90_equi_fe f
	LEFT JOIN t02_dg_proy proy ON(proy.t02_moni_fina = f.t90_id_equi OR proy.t02_moni_tema = f.t90_id_equi)
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst = proy.t01_id_inst)
	LEFT JOIN adm_tablas_aux t ON (f.t90_carg_equi=t.codi)
	LEFT JOIN adm_tablas_aux t2 ON (f.t90_sexo_equi=t2.codi)
	LEFT JOIN t03_dist_proy t_proy ON (t_proy.t02_cod_proy = proy.t02_cod_proy)
	WHERE IFNULL(i.t01_id_inst,0) = (CASE WHEN _inst = '*' OR _inst = 10 THEN IFNULL(i.t01_id_inst,0) ELSE _inst END)
	AND IFNULL(proy.t02_cod_proy,0) = (CASE WHEN _proy = '*' OR _proy = '' THEN IFNULL(proy.t02_cod_proy,0) ELSE _proy END)
	AND IFNULL(f.t90_carg_equi,0) = (CASE WHEN _cargo = '*' THEN IFNULL(f.t90_carg_equi,0) ELSE _cargo END)
	AND	CONCAT(f.t90_ape_pat,' ',f.t90_ape_mat, ', ', f.t90_nom_equi) LIKE CONCAT("%",_like,"%")
	AND IFNULL(t_proy.t03_dpto,0) = (CASE WHEN _dpto = '*' THEN IFNULL(t_proy.t03_dpto,0) ELSE _dpto END)
	AND IFNULL(proy.t02_sect_prod,0) = (CASE WHEN _sector = '*' THEN IFNULL(proy.t02_sect_prod,0) ELSE _sector END)
	ORDER BY nombres ASC
)
ORDER BY institucion, nombres;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_cronograma_desembolsos_fte` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_cronograma_desembolsos_fte`( IN _proy VARCHAR(10), IN _ver INT, in _fte int )
BEGIN
DECLARE _sql      longTEXT;
declare _contador  int ;
DECLARE _anio   INT ;
DECLARE _mes   INT ;

DECLARE _temp_cat_ope  VARCHAR(900);
DECLARE _periodo_cat_ope  TEXT DEFAULT '';

DECLARE _temp_cat_mp  VARCHAR(900);
DECLARE _periodo_cat_mp  TEXT DEFAULT '';
DECLARE _temp_act_mp  VARCHAR(900);
DECLARE _periodo_act_mp  TEXT DEFAULT '';
DECLARE _temp_comp VARCHAR(600);
DECLARE _temp_act  VARCHAR(600);
DECLARE _temp_sub VARCHAR(600);
DECLARE _sql_comp TEXT DEFAULT '';
DECLARE _sql_act  TEXT DEFAULT '';
DECLARE _sql_sub  TEXT DEFAULT '';
DECLARE _temp_periodo_sum  varchar(50) DEFAULT 'SUM(`_periodo`) AS \'_periodo\' ';
DECLARE _periodo_sum  text DEFAULT '';
declare _field_sum    text default '';

DROP TEMPORARY TABLE IF EXISTS tmpPeriodos;
CREATE TEMPORARY TABLE tmpPeriodos 
( id INT AUTO_INCREMENT,
  anio INT,
  mes  int,
  PRIMARY KEY (id)
) ;
INSERT INTO tmpPeriodos(anio, mes)
SELECT DISTINCT w.anio, w.mes
FROM (
	SELECT DISTINCT t09_anio AS anio, t09_mes AS mes
	FROM t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver
	UNION ALL
	SELECT DISTINCT t03_anio AS anio, t03_mes AS mes
	FROM t03_mp_per_metas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver
       ) w
ORDER BY w.anio, w.mes ;

SET _temp_cat_ope = "  (SELECT SUM(fn_monto_planificado_fte_anio_mes(fte.t02_cod_proy, fte.t02_version, fte.t08_cod_comp, fte.t09_cod_act, fte.t09_cod_sub, fte.t10_cod_cost, fte.t01_id_inst, _idanio , _idmes))
			  FROM       t10_cost_fte fte
			 INNER JOIN t10_cost_sub cost ON ( fte.t02_cod_proy = cost.t02_cod_proy AND fte.t02_version  = cost.t02_version AND fte.t08_cod_comp = cost.t08_cod_comp AND fte.t09_cod_act  = cost.t09_cod_act AND fte.t09_cod_sub  = cost.t09_cod_sub AND fte.t10_cod_cost = cost.t10_cod_cost )
			WHERE fte.t02_cod_proy = p.t02_cod_proy 
			  AND fte.t02_version  = p.t02_version 
			  AND fte.t08_cod_comp = p.t08_cod_comp
			  AND fte.t09_cod_act  = p.t09_cod_act 
			  AND fte.t09_cod_sub  = p.t09_cod_sub 
			  AND cost.t10_cate_cost = p.t10_cate_cost 
			  AND fte.t01_id_inst  = _idfte 
		       ) AS '_periodo' " ;
		       

SET _temp_act_mp = "  (	  SELECT SUM( fn_monto_planificado_mp_fte_anio_mes(fte.proyecto, fte.vs, fte.actividad, fte.codsub, vmp.codigo, fte.idinst, _idanio, _idmes)				     )
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.idinst = _idfte
		       ) AS '_periodo' " ;

SET _temp_cat_mp = "  SUM(
			   CASE WHEN  vmp.subactividad IS NULL
			   THEN fn_monto_planificado_mp_fte_anio_mes(vmp.proyecto, vmp.vs, vmp.actividad, vmp.codsub, vmp.codigo,  _idfte , _idanio, _idmes)
			   ELSE fn_monto_planificado_mp_fte_anio_mes(vmp.proyecto, vmp.vs, vmp.actividad, SUBSTRING_INDEX(vmp.codigo,'.',1), SUBSTRING_INDEX(vmp.codigo,'.',-1),  _idfte , _idanio, _idmes)
			   END 
		         ) AS '_periodo' " ;
		       
SELECT 1 INTO _contador ;  
WHILE (SELECT COUNT(1) FROM  tmpPeriodos) >= _contador DO
	SELECT anio  ,  mes
	INTO   _anio, _mes
	FROM tmpPeriodos 
	WHERE id = _contador;
	
	SET _periodo_cat_ope  = CONCAT(_periodo_cat_ope, ',', '\n' , REPLACE( REPLACE(REPLACE(_temp_cat_ope,'_idanio', _anio),'_idmes', _mes),'_periodo', CONCAT( _anio, '.' , _mes )) ) ;
	
	SET _periodo_cat_mp  = CONCAT(_periodo_cat_mp, ',', '\n' , REPLACE( REPLACE(REPLACE(_temp_cat_mp,'_idanio', _anio),'_idmes', _mes),'_periodo', CONCAT( _anio, '.' , _mes )) ) ;
	SET _periodo_act_mp  = CONCAT(_periodo_act_mp, ',', '\n' , REPLACE( REPLACE(REPLACE(_temp_act_mp,'_idanio', _anio),'_idmes', _mes),'_periodo', CONCAT( _anio, '.' , _mes )) ) ;
	
	SET _periodo_sum  = CONCAT(_periodo_sum, ',', '\n' , REPLACE( _temp_periodo_sum,'_periodo', CONCAT( _anio, '.' , _mes ) ) );
	
	SET _field_sum  = CONCAT(_field_sum , ',', '\n' , CONCAT("`", _anio, "." , _mes, "`" )  );
	
	SET _contador = _contador + 1;
END WHILE;
DROP TEMPORARY TABLE tmpPeriodos; 
DROP TEMPORARY TABLE IF EXISTS tmpDesembolsos ;
set _sql = "
CREATE TEMPORARY TABLE IF NOT EXISTS tmpDesembolsos
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost 
	   WHERE cost.t02_cod_proy=p.t02_cod_proy 
	     AND cost.t02_version =p.t02_version 
	     AND cost.t08_cod_comp=p.t08_cod_comp
	     AND cost.t09_cod_act =p.t09_cod_act
	     AND cost.t09_cod_sub =p.t09_cod_sub
	     AND cost.t10_cate_cost=t.codi
	) * s.t09_mta) AS total,
	( SELECT SUM( fn_monto_total_planificado_fte(cost.t02_cod_proy, cost.t02_version, cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub, cost.t10_cod_cost, _idfte ) )
	    FROM       t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	     AND cost.t10_cate_cost = t.codi
	) AS total_aporte_fte,
		
	'rubro' AS tipo,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
	[_periodo_cat_ope]
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  = _ver
GROUP BY 1,2,3 
UNION ALL
 
SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo, 
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	
	SUM( 
	  CASE WHEN vmp.subactividad IS NULL
	  THEN fn_monto_total_planificado_mp_fte(vmp.proyecto, vmp.vs, vmp.actividad, vmp.codsub, vmp.codigo , _idfte )
	  ELSE fn_monto_total_planificado_mp_fte(vmp.proyecto, vmp.vs, vmp.actividad, SUBSTRING_INDEX(vmp.codigo,'.',1), SUBSTRING_INDEX(vmp.codigo,'.',-1) , _idfte )
	  END 
	) AS total_aporte_fte,	
	
	'rubro' AS tipo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codigo)
	 END 
	) AS codigo_real
	[_periodo_cat_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.cate_gasto is not null
  GROUP BY 1, 2, 3 
UNION ALL
 
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	SUM( 
	    fn_monto_total_planificado_mp_fte(vmp.proyecto, vmp.vs, vmp.actividad, vmp.codsub, vmp.codigo , _idfte )
	   ) AS total_aporte_fte,	
	'actividad' AS tipo,
	CONCAT(80 + vmp.componente,'.',vmp.actividad) AS codigo_real
	[_periodo_act_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  AND vmp.actividad > 3 
  GROUP BY 1, 2, 3 ,4, 5
  
ORDER BY codigo_real ; " ; 
  
 
 
set _sql = replace(_sql,' _proy', concat(" '",_proy,"'"));
SET _sql = REPLACE(_sql,' _ver', _ver);
SET _sql = REPLACE(_sql,'[_periodo_cat_ope]' , _periodo_cat_ope );
SET _sql = REPLACE(_sql,'[_periodo_act_mp]' , _periodo_act_mp );
SET _sql = REPLACE(_sql,'[_periodo_cat_mp]' , _periodo_cat_mp );
SET _sql = REPLACE(_sql,' _idfte', _fte);
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
drop TABLE IF EXISTS tmpReturn ;
sELECT concat("
CREATE TEMPORARY TABLE IF NOT EXISTS tmpReturn   
SELECT  codigo,
	descripcion, 
	um, 
	meta, 
	tipo,
	codigo_real,
	parcial, 
	total, 
	total_aporte_fte",
	_field_sum," 
	FROM tmpDesembolsos ; ") INTO @txtsql;
	
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
ALTER TABLE tmpReturn   CHANGE descripcion `descripcion` VARCHAR(250), 
			CHANGE um `um` VARCHAR(50),
			CHANGE tipo `tipo` VARCHAR(20);
set _sql_comp = concat("
	INSERT INTO tmpReturn
	SELECT  SUBSTRING_INDEX(t.codigo,'.',1) AS codigo,
		c.descripcion AS descripcion, 
		NULL AS 'um', 
		NULL AS 'meta', 
		'componente' AS 'tipo',
		SUBSTRING_INDEX(t.codigo_real,'.',1) AS codigo_real,
		NULL AS 'parcial', 
		SUM(t.total) AS total, 
		SUM(t.total_aporte_fte) AS total_aporte_fte",
		_periodo_sum," 
	FROM tmpDesembolsos t 
	LEFT JOIN v_componentes c ON( c.t02_cod_proy='",_proy,"' AND c.t02_version=",_ver," AND c.codigo=SUBSTRING_INDEX(t.codigo,'.',1))
	GROUP BY 1, 2, 3, 4, 5, 6 ; ") ;
SELECT _sql_comp INTO @txtsql2;
PREPARE stmt FROM @txtsql2;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
SET _sql_act = CONCAT("
	INSERT INTO tmpReturn
	SELECT  SUBSTRING_INDEX(t.codigo,'.',2) AS codigo,
	a.descripcion AS descripcion, 
	NULL AS 'um', 
	NULL AS 'meta', 
	'actividad' AS 'tipo',
	SUBSTRING_INDEX(t.codigo_real,'.',2) AS codigo_real,
	SUM(t.parcial) AS 'parcial', 
	SUM(t.total) AS total, 
	SUM(t.total_aporte_fte) AS total_aporte_fte",
	_periodo_sum," 
	FROM tmpDesembolsos t 
	LEFT JOIN v_actividades a ON( a.t02_cod_proy='",_proy,"' AND a.t02_version=",_ver," AND a.codigo=SUBSTRING_INDEX(t.codigo,'.',2))
	WHERE t.tipo = 'rubro'
	  AND a.codigo NOT IN ('10.4','10.5','10.6')
	GROUP BY 1, 2, 3, 4, 5, 6 ; ") ;
SELECT _sql_act INTO @txtsql3;
PREPARE stmt FROM @txtsql3;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
SET _sql_sub = CONCAT("
	INSERT INTO tmpReturn
	SELECT  SUBSTRING_INDEX(t.codigo,'.',3) AS codigo,
	s.descripcion AS descripcion, 
	s.um AS 'um', 
	s.meta AS 'meta', 
	'subactividad' AS 'tipo',
	SUBSTRING_INDEX(t.codigo_real,'.',3) AS codigo_real,
	SUM(t.parcial) AS 'parcial', 
	SUM(t.total) AS total, 
	SUM(t.total_aporte_fte) AS total_aporte_fte",
	_periodo_sum," 
	FROM tmpDesembolsos t 
	LEFT JOIN v_subactividades s ON( s.t02_cod_proy='",_proy,"' AND s.t02_version=",_ver," AND s.codigo=SUBSTRING_INDEX(t.codigo,'.',3))
	WHERE t.tipo = 'rubro'
	GROUP BY 1, 2, 3, 4, 5, 6 ; ") ;
SELECT _sql, _sql_comp, _sql_act,  _sql_sub ;
SELECT _sql_sub INTO @txtsql4;
PREPARE stmt FROM @txtsql4;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
DROP TEMPORARY TABLE IF EXISTS tmpDesembolsos;
select * from tmpReturn order by codigo_real asc ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_cronograma_desembolsos_fte_back` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_cronograma_desembolsos_fte_back`( IN _proy VARCHAR(10), IN _ver INT, in _fte int )
BEGIN
DECLARE _sql      longTEXT;
declare _contador  int ;
DECLARE _anio   INT ;
DECLARE _mes   INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
declare _codFE    int default 10 ;

DECLARE _temp_comp_ope VARCHAR(500);
DECLARE _temp_act_ope  VARCHAR(500);
DECLARE _temp_sub_ope  VARCHAR(500);
DECLARE _temp_cat_ope  VARCHAR(900);
declare _periodo_comp_ope text default '';
DECLARE _periodo_act_ope  TEXT DEFAULT '';
DECLARE _periodo_sub_ope  TEXT DEFAULT '';
DECLARE _periodo_cat_ope  TEXT DEFAULT '';

DECLARE _temp_comp_mp VARCHAR(600);
DECLARE _temp_act_mp  VARCHAR(600);
DECLARE _temp_sub_mp  VARCHAR(600);
DECLARE _temp_cat_mp  VARCHAR(900);
DECLARE _periodo_comp_mp TEXT DEFAULT '';
DECLARE _periodo_act_mp  TEXT DEFAULT '';
DECLARE _periodo_sub_mp  TEXT DEFAULT '';
DECLARE _periodo_cat_mp  TEXT DEFAULT '';

DROP TEMPORARY TABLE IF EXISTS tmpPeriodos;
CREATE TEMPORARY TABLE tmpPeriodos 
( id INT AUTO_INCREMENT,
  anio INT,
  mes  int,
  PRIMARY KEY (id)
) ;
INSERT INTO tmpPeriodos(anio, mes)
SELECT DISTINCT w.anio, w.mes
FROM (
	SELECT DISTINCT t09_anio AS anio, t09_mes AS mes
	FROM t09_sub_act_mtas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver
	UNION ALL
	SELECT DISTINCT t03_anio AS anio, t03_mes AS mes
	FROM t03_mp_per_metas
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver
       ) w
ORDER BY w.anio, w.mes ;

set _temp_comp_ope= "( SELECT SUM(fn_monto_planificado_fte_anio_mes(fte.t02_cod_proy, fte.t02_version, fte.t08_cod_comp, fte.t09_cod_act, fte.t09_cod_sub, fte.t10_cod_cost, fte.t01_id_inst, _idanio , _idmes))
			 FROM       t10_cost_fte fte
			WHERE fte.t02_cod_proy=c.t02_cod_proy 
			  AND fte.t02_version =c.t02_version 
			  AND fte.t08_cod_comp=c.t08_cod_comp
			  AND fte.t01_id_inst = _idfte
		     ) AS '_periodo' " ;
set _temp_act_ope = " ( SELECT SUM(fn_monto_planificado_fte_anio_mes(fte.t02_cod_proy, fte.t02_version, fte.t08_cod_comp, fte.t09_cod_act, fte.t09_cod_sub, fte.t10_cod_cost, fte.t01_id_inst, _idanio , _idmes))
			 FROM       t10_cost_fte fte
			WHERE fte.t02_cod_proy = a.t02_cod_proy 
			  AND fte.t02_version  = a.t02_version 
			  AND fte.t08_cod_comp = a.t08_cod_comp
			  AND fte.t09_cod_act  = a.t09_cod_act 
			  AND fte.t01_id_inst  = _idfte
		       ) AS '_periodo' " ;
			
SET _temp_sub_ope = " ( SELECT SUM(fn_monto_planificado_fte_anio_mes(fte.t02_cod_proy, fte.t02_version, fte.t08_cod_comp, fte.t09_cod_act, fte.t09_cod_sub, fte.t10_cod_cost, fte.t01_id_inst, _idanio , _idmes))
			 FROM       t10_cost_fte fte
			WHERE fte.t02_cod_proy = s.t02_cod_proy 
			  AND fte.t02_version  = s.t02_version 
			  AND fte.t08_cod_comp = s.t08_cod_comp
			  AND fte.t09_cod_act  = s.t09_cod_act 
			  AND fte.t09_cod_sub  = s.t09_cod_sub
			  AND fte.t01_id_inst  = _idfte
		       ) AS '_periodo' " ;
			 
SET _temp_cat_ope = "  (SELECT SUM(fn_monto_planificado_fte_anio_mes(fte.t02_cod_proy, fte.t02_version, fte.t08_cod_comp, fte.t09_cod_act, fte.t09_cod_sub, fte.t10_cod_cost, fte.t01_id_inst, _idanio , _idmes))
			  FROM       t10_cost_fte fte
			 INNER JOIN t10_cost_sub cost ON ( fte.t02_cod_proy = cost.t02_cod_proy AND fte.t02_version  = cost.t02_version AND fte.t08_cod_comp = cost.t08_cod_comp AND fte.t09_cod_act  = cost.t09_cod_act AND fte.t09_cod_sub  = cost.t09_cod_sub AND fte.t10_cod_cost = cost.t10_cod_cost )
			WHERE fte.t02_cod_proy = p.t02_cod_proy 
			  AND fte.t02_version  = p.t02_version 
			  AND fte.t08_cod_comp = p.t08_cod_comp
			  AND fte.t09_cod_act  = p.t09_cod_act 
			  AND fte.t09_cod_sub  = p.t09_cod_sub 
			  AND cost.t10_cate_cost = p.t10_cate_cost 
			  AND fte.t01_id_inst  = _idfte 
		       ) AS '_periodo' " ;
		       

SET _temp_comp_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_act_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
set _temp_sub_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
		       
SET _temp_cat_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.rubro      = (CASE WHEN vmp.subactividad IS NULL THEN vmp.codigo ELSE (vmp.cate_gasto - 80) END) 
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SELECT 1 INTO _contador ;  
WHILE (SELECT COUNT(1) FROM  tmpPeriodos) >= _contador DO
	SELECT anio  ,  mes
	INTO   _anio, _mes
	FROM tmpPeriodos 
	WHERE id = _contador;
	
	
	
	
	
	SET _periodo_cat_ope  = CONCAT(_periodo_cat_ope, ',', '\n' , REPLACE( REPLACE(REPLACE(_temp_cat_ope,'_idanio', _anio),'_idmes', _mes),'_periodo', CONCAT( _anio, '.' , _mes )) ) ;
	
	
	SET _contador = _contador + 1;
END WHILE;
DROP TEMPORARY TABLE tmpPeriodos; 
set _sql = "
SELECT 	c.t08_cod_comp AS codigo, 
	TRIM(c.t08_comp_desc) AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=c.t02_cod_proy 
	     AND cost.t02_version =c.t02_version 
	     AND cost.t08_cod_comp=c.t08_cod_comp
	) AS total,
	
	( SELECT SUM( fn_monto_total_planificado_fte(cost.t02_cod_proy, cost.t02_version, cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub, cost.t10_cod_cost, _idfte ) )
	    FROM       t10_cost_sub cost
	   WHERE cost.t02_cod_proy=c.t02_cod_proy 
	     AND cost.t02_version =c.t02_version 
	     AND cost.t08_cod_comp=c.t08_cod_comp
	) AS total_aporte_fte,
	
	'componente' AS tipo,
	c.t08_cod_comp AS codigo_real
	[_periodo_comp_ope]
FROM  t08_comp c
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo, 
	TRIM(a.t09_act) AS descripcion,
	NULL AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost 
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS total,
	
	( SELECT SUM( fn_monto_total_planificado_fte(cost.t02_cod_proy, cost.t02_version, cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub, cost.t10_cod_cost, _idfte ) )
	    FROM       t10_cost_sub cost
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS total_aporte_fte,
	
	'actividad' AS tipo,
	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo_real
	[_periodo_act_ope]
FROM  t09_act a
WHERE a.t02_cod_proy = _proy
  AND a.t02_version  = _ver
  
UNION ALL
SELECT 	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo, 
	TRIM(s.t09_sub) AS descripcion,
	s.t09_um AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) AS parcial,
	s.t09_mta AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) * s.t09_mta) AS total,
	( SELECT SUM( fn_monto_total_planificado_fte(cost.t02_cod_proy, cost.t02_version, cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub, cost.t10_cod_cost, _idfte ) )
	    FROM       t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) AS total_aporte_fte,
	
	'subactividad' AS tipo,
	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo_real
	[_periodo_sub_ope]
FROM  t09_subact s
WHERE s.t02_cod_proy = _proy 
  AND s.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost 
	   WHERE cost.t02_cod_proy=p.t02_cod_proy 
	     AND cost.t02_version =p.t02_version 
	     AND cost.t08_cod_comp=p.t08_cod_comp
	     AND cost.t09_cod_act =p.t09_cod_act
	     AND cost.t09_cod_sub =p.t09_cod_sub
	     AND cost.t10_cate_cost=t.codi
	) * s.t09_mta) AS total,
	( SELECT SUM( fn_monto_total_planificado_fte(cost.t02_cod_proy, cost.t02_version, cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub, cost.t10_cod_cost, _idfte ) )
	    FROM       t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	     AND cost.t10_cate_cost = t.codi
	) AS total_aporte_fte,
		
	'rubro' AS tipo,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
	[_periodo_cat_ope]
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  = _ver
GROUP BY 1,2,3 
UNION ALL
 
SELECT 	vmp.componente AS codigo, 
	'Manejo del Proyecto' AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	SUM( 
	  fn_monto_total_planificado_mp_fte(vmp.proyecto, vmp.vs, vmp.actividad, vmp.codsub, vmp.codigo , _idfte )
	) AS total_aporte_fte,	
	'componente' AS tipo,
	CONCAT(80 + vmp.componente) AS codigo_real
	[_periodo_comp_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver 
  GROUP BY 1,2,3,4,5
UNION ALL
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	NULL AS um,
	SUM(vmp.gasto) parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	SUM( 
	  fn_monto_total_planificado_mp_fte(vmp.proyecto, vmp.vs, vmp.actividad, vmp.codsub, vmp.codigo , _idfte )
	) AS total_aporte_fte,	
	'actividad' AS tipo,
	CONCAT(80 + componente,'.',actividad) AS codigo_real
	[_periodo_act_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
 GROUP BY 1,2,3
UNION ALL
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nom_cate_gasto
	 ELSE
	      vmp.subactividad
	 END 
	) AS descripcion,
	vmp.um AS um,
	SUM(vmp.gasto) parcial,
	vmp.meta AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	
	SUM( 
	  fn_monto_total_planificado_mp_fte(vmp.proyecto, vmp.vs, vmp.actividad, vmp.codsub, vmp.codigo , _idfte )
	) AS total_aporte_fte,	
	
	'subactividad' AS tipo,
	CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo_real
	[_periodo_sub_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.codsub is not null
 GROUP BY 1,2
UNION ALL
SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo, 
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	
	SUM( 
	  fn_monto_total_planificado_mp_fte(vmp.proyecto, vmp.vs, vmp.actividad, vmp.codsub, vmp.codigo , _idfte )
	) AS total_aporte_fte,	
	
	'rubro' AS tipo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
	[_periodo_cat_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.cate_gasto is not null
  GROUP BY 1, 2, 3 
  
ORDER BY codigo_real ; " ; 
  
 
 
set _sql = replace(_sql,' _proy', concat(" '",_proy,"'"));
SET _sql = REPLACE(_sql,' _ver', _ver);
SET _sql = REPLACE(_sql,'[_periodo_cat_ope]' , _periodo_cat_ope );
SET _sql = REPLACE(_sql,' _idfte', _fte);
select _sql as '_sql' ;

 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_cronograma_ejec_desembolsos_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_cronograma_ejec_desembolsos_trim`(	IN _consurso VARCHAR(5),
																						IN _ejecutor INT,
																						IN _proyecto VARCHAR(10), 
																						IN _anio INT, 
																						IN _sector INT, 
																						IN _region VARCHAR(10))
BEGIN
DECLARE _fteFE INT DEFAULT 10 ;
DECLARE _trim_ini_antes INT DEFAULT 0 ;
SELECT 	proy.codigo,
	proy.titulo,
	proy.siglas,
	proy.inicio,
	proy.termino,
	fn_monto_total_desemb_plan_periodo_trim(proy.codigo, 1, _fteFE, _trim_ini_antes, (CASE WHEN t.t25_anio=1 THEN 0 ELSE (fn_numero_trim(t.t25_anio,1) - 1) END )) AS plan_desemb_anterior,
	fn_monto_desembolsado_periodo(proy.codigo, _trim_ini_antes, (CASE WHEN t.t25_anio=1 THEN 0 ELSE (fn_numero_trim(t.t25_anio,1) - 1) END )) AS ejec_desemb_anterior,
	
	fn_monto_total_desemb_plan_periodo_trim(proy.codigo, 1,_fteFE, fn_numero_trim(t.t25_anio,1), fn_numero_trim(t.t25_anio,1)) AS mpt_1,
	fn_monto_desembolsado_periodo(proy.codigo, fn_numero_trim(t.t25_anio,1), fn_numero_trim(t.t25_anio,1)) AS mdt_1,
	
	fn_monto_total_desemb_plan_periodo_trim(proy.codigo, 1,_fteFE, fn_numero_trim(t.t25_anio,1)+1, fn_numero_trim(t.t25_anio,1)+1) AS mpt_2,
	fn_monto_desembolsado_periodo(proy.codigo, fn_numero_trim(t.t25_anio,1)+1, fn_numero_trim(t.t25_anio,1)+1) AS mdt_2,
	
	fn_monto_total_desemb_plan_periodo_trim(proy.codigo, 1,_fteFE, fn_numero_trim(t.t25_anio,1)+2, fn_numero_trim(t.t25_anio,1)+2) AS mpt_3,
	fn_monto_desembolsado_periodo(proy.codigo, fn_numero_trim(t.t25_anio,1)+2, fn_numero_trim(t.t25_anio,1)+2) AS mdt_3,
	
	fn_monto_total_desemb_plan_periodo_trim(proy.codigo, 1,_fteFE, fn_numero_trim(t.t25_anio,1)+3, fn_numero_trim(t.t25_anio,1)+3) AS mpt_4,
	fn_monto_desembolsado_periodo(proy.codigo, fn_numero_trim(t.t25_anio,1)+3, fn_numero_trim(t.t25_anio,1)+3) AS mdt_4
	
FROM	v_matriz_proyectos proy
JOIN	(SELECT t02_cod_proy, t25_anio 
			FROM t25_inf_trim 
			WHERE t25_periodo LIKE CONCAT('%',_anio,'%')
			GROUP BY t02_cod_proy) t ON (t.t02_cod_proy = proy.codigo)
WHERE		proy.concurso = (CASE WHEN _consurso = '*' THEN proy.concurso ELSE _consurso END)
		AND proy.codinst = (CASE WHEN _ejecutor=0 THEN proy.codinst ELSE _ejecutor END)
		AND proy.codigo  = (CASE WHEN _proyecto='*' OR _proyecto=''  THEN proy.codigo ELSE _proyecto END)
		AND proy.codsector  = (CASE WHEN _sector ='*' THEN proy.codsector ELSE _sector  END)
		AND proy.t01_dpto  = (CASE WHEN _region ='*' THEN proy.t01_dpto ELSE _region  END);
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_cron_desemb_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_cron_desemb_trim`( IN _proy VARCHAR(10) )
BEGIN
SELECT 	v.anio,
	v.trimestre,
	DATE_FORMAT(DATE_ADD(v.inicio, INTERVAL fn_numero_trim(v.anio, v.trimestre)-1 QUARTER),'%d/%m/%Y') AS inicio_trim,
	CONCAT(UPPER(SUBSTRING(fn_nom_mes(MONTH(MIN(v.ini_mes))),1,3)),' ', MIN(v.num_anio)) AS fec_ini_trim,
	CONCAT(UPPER(SUBSTRING( fn_nom_mes(month(MAX(v.ini_mes)))  ,1,3)),' ', MAX(v.num_anio)) AS fec_ter_trim,
	fn_monto_total_desemb_plan_periodo_trim(v.proyecto,1,10,fn_numero_trim(v.anio, v.trimestre),fn_numero_trim(v.anio, v.trimestre)) AS monto_planeado_trim,
	DATE_FORMAT( (Select max(e.t60_fch_depo) from t60_ejecucion_desemb e where e.t02_cod_proy=_proy and e.t60_id_trim=fn_numero_trim(v.anio, v.trimestre))  ,'%d/%m/%Y') AS fecha_desemb,
	fn_monto_desembolsado_periodo(_proy, fn_numero_trim(v.anio, v.trimestre), fn_numero_trim(v.anio, v.trimestre)) AS monto_desemb_trim
FROM v_periodos_proyecto v
WHERE v.proyecto = _proy
GROUP BY 1,2,3 ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_cump_inf_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_cump_inf_mes`( IN _proy VARCHAR(10), 
				        IN _anio INT ,
				        IN _mes INT )
BEGIN
 
SELECT 
	TRIM(CONCAT(sub.t08_cod_comp, '.', sub.t09_cod_act, '.', sub.t09_cod_sub)) AS codigo,
	sub.t09_sub AS subactividad,
	sub.t09_mta AS meta_total,
	sub.t09_um  AS unidad_medida,
	IFNULL(mta.t09_mta,0) AS planeado,
	IFNULL(inf.t09_sub_avanc,0) AS informado,
	ROUND((CASE 
	 WHEN ((IFNULL(inf.t09_sub_avanc,0)/IFNULL(mta.t09_mta,0))*100) > 100 
	 THEN 100 
	 ELSE 
	 ((IFNULL(inf.t09_sub_avanc,0)/IFNULL(mta.t09_mta,0))*100)
	 END ),2) AS cumplimiento
FROM  	   t09_subact  sub
INNER JOIN t09_sub_act_mtas mta ON(sub.t02_cod_proy=mta.t02_cod_proy AND sub.t02_version=mta.t02_version  AND sub.t08_cod_comp=mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub=mta.t09_cod_sub)
LEFT  JOIN t09_act_sub_mtas_inf inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_act AND sub.t09_cod_sub=inf.t09_cod_sub AND inf.t09_sub_anio=mta.t09_anio AND inf.t09_sub_mes=mta.t09_mes)
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version = fn_ult_version_proy(sub.t02_cod_proy)
  AND mta.t09_anio=_anio
  AND mta.t09_mes=_mes
ORDER BY 1,2,3,4 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_cump_inf_mes_acum` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_cump_inf_mes_acum`(IN pProy VARCHAR(10), 
				             IN pAnio INT ,
				             IN pMes INT)
BEGIN
	DECLARE aNumMes INT;
	DECLARE aVersion INT;
	SELECT fn_numero_mes(pAnio, pMes) INTO aNumMes ;
	SELECT fn_ult_version_proy(pProy) INTO aVersion;
	SELECT		t1.codigo,
				t1.subactividad,
				ifnull(t1.meaa, 0) + ifnull(t1.mpoa, 0) + ifnull(t1.mpar, 0) as meta_total,
				t1.unidad_medida,
				ifnull(t1.meaa, 0) + ifnull(t1.meaf, 0) as planeado,
				t1.informado
	FROM	(
			SELECT		TRIM(CONCAT(sub.t08_cod_comp, '.', sub.t09_cod_act, '.', sub.t09_cod_sub)) AS codigo,
						sub.t09_sub AS subactividad,
						
						(SELECT SUM(inf.t09_sub_avanc) 
						   FROM t09_act_sub_mtas_inf inf
						  WHERE inf.t02_cod_proy = sub.t02_cod_proy
							AND inf.t08_cod_comp = sub.t08_cod_comp
							AND inf.t09_cod_act  = sub.t09_cod_act
							AND inf.t09_cod_sub  = sub.t09_cod_sub
							AND inf.t09_sub_anio <= (pAnio-1)) as meaa,
							
						(SELECT SUM(mta.t09_mta)
						  FROM  t09_sub_act_mtas mta
						 WHERE mta.t02_cod_proy = sub.t02_cod_proy 
						   AND mta.t02_version  = sub.t02_version
						   AND mta.t08_cod_comp = sub.t08_cod_comp 
						   AND mta.t09_cod_act  = sub.t09_cod_act 
						   AND mta.t09_cod_sub  = sub.t09_cod_sub 
						   AND mta.t09_anio = pAnio) as mpoa,
						sub.t09_mta_proy as mpar,
						sub.t09_um  AS unidad_medida,
						
						
						(SELECT SUM(mta.t09_mta) 
							FROM t09_sub_act_mtas mta
							WHERE mta.t02_cod_proy = sub.t02_cod_proy 
								AND mta.t02_version = sub.t02_version 
								AND mta.t08_cod_comp = sub.t08_cod_comp
								AND mta.t09_cod_act  = sub.t09_cod_act
								AND mta.t09_cod_sub  = sub.t09_cod_sub
								AND mta.t09_anio = pAnio
								AND mta.t09_mes <= pMes) AS meaf,
						IFNULL( (
							SELECT	SUM(inff.t09_sub_avanc) 
							FROM	t09_act_sub_mtas_inf inff  
							WHERE	sub.t02_cod_proy = inff.t02_cod_proy 
								AND sub.t08_cod_comp = inff.t08_cod_comp 
								AND sub.t09_cod_act = inff.t09_cod_act 
								AND sub.t09_cod_sub = inff.t09_cod_sub
								AND fn_numero_mes(inff.t09_sub_anio, inff.t09_sub_mes) <= aNumMes
							) ,0) AS informado
			FROM 		t09_subact sub
			LEFT JOIN	t09_act_sub_mtas_inf inf	ON (sub.t02_cod_proy	= inf.t02_cod_proy	AND 
														sub.t02_version		= inf.t02_version	AND 
														sub.t08_cod_comp	= inf.t08_cod_comp	AND 
														sub.t09_cod_act		= inf.t09_cod_act	AND 
														sub.t09_cod_sub		= inf.t09_cod_sub	AND
														fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= aNumMes)
			WHERE		sub.t02_cod_proy = pProy AND sub.t02_version = aVersion
			GROUP BY CONCAT(sub.t08_cod_comp, '.', sub.t09_cod_act, '.',sub.t09_cod_sub)
			) AS t1;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_cump_inf_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_cump_inf_trim`( IN _proy VARCHAR(10), 
				        IN _anio INT ,
				        IN _trim INT )
BEGIN
DECLARE _porc DOUBLE ;
DECLARE _mes INT;
DECLARE _num_mes INT;
SELECT (_trim * 3) INTO _mes ;
SELECT fn_numero_mes(_anio, _mes) INTO _num_mes ;
SELECT TRIM(CONCAT(sub.t08_cod_comp, '.', sub.t09_cod_act, '.', sub.t09_cod_sub)) AS codigo,
	 sub.t09_sub AS subactividad,
	 sub.t09_mta AS meta_total,
	 sub.t09_um AS unidad_medida,
	 SUM(mta.t09_mta) AS planeado,
	 IFNULL((
	  SELECT SUM(inf.t09_sub_avanc) 
	    FROM t09_act_sub_mtas_inf inf  
	   WHERE mta.t02_cod_proy = inf.t02_cod_proy 
	     AND mta.t08_cod_comp = inf.t08_cod_comp 
	     AND mta.t09_cod_act = inf.t09_cod_act 
	     AND mta.t09_cod_sub = inf.t09_cod_sub
	     AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) > (_num_mes - 3) AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= _num_mes
	 ),0) AS informado,
	 
	 ROUND((
	 CASE 
	 WHEN ((  
		( SELECT SUM(inf.t09_sub_avanc) 
		    FROM t09_act_sub_mtas_inf inf  
		   WHERE mta.t02_cod_proy = inf.t02_cod_proy 
		     AND mta.t08_cod_comp = inf.t08_cod_comp 
		     AND mta.t09_cod_act = inf.t09_cod_act 
		     AND mta.t09_cod_sub = inf.t09_cod_sub
		     AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) > (_num_mes - 3) AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= _num_mes)   
		/ 
		(SUM(mta.t09_mta))
		)*100) > 100
	 THEN 100
	 ELSE IFNULL(((
		(SELECT SUM(inf.t09_sub_avanc) 
		    FROM t09_act_sub_mtas_inf inf  
		   WHERE mta.t02_cod_proy = inf.t02_cod_proy 
		     AND mta.t08_cod_comp = inf.t08_cod_comp 
		     AND mta.t09_cod_act = inf.t09_cod_act 
		     AND mta.t09_cod_sub = inf.t09_cod_sub
		     AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) > (_num_mes - 3) AND fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) <= _num_mes )
		/ 
		( SUM(mta.t09_mta))
		)*100),0)
	 END 
	 ),2) AS cumplimiento
	FROM t09_subact sub
	INNER JOIN t09_sub_act_mtas mta ON (sub.t02_cod_proy = mta.t02_cod_proy  AND sub.t02_version = mta.t02_version AND sub.t08_cod_comp = mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub = mta.t09_cod_sub)
	WHERE sub.t02_cod_proy = _proy
	  AND sub.t02_version = fn_ult_version_proy(sub.t02_cod_proy)
	  AND mta.t09_mta >0
	  AND fn_numero_mes(mta.t09_anio, mta.t09_mes) > (_num_mes - 3) AND fn_numero_mes(mta.t09_anio, mta.t09_mes) <= _num_mes
	  
	GROUP BY 1,2,4 ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_desembolsos_periodo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_desembolsos_periodo`(IN _concurso VARCHAR(5), in _idinst int, in _perini varchar(10), in _perfin varchar(10) )
BEGIN
	
Select  proy.concurso ,
	proy.codigo,
	proy.titulo,
	proy.siglas,
	proy.inicio,
	proy.termino,
	date_FORMAT(d.t60_fch_giro,'%Y%m') as periodo,
	d.t60_id_trim, 
	d.t60_id_desemb, 
	tp.t00_nom_lar AS tipopago, 
	DATE_FORMAT( d.t60_fch_giro,'%d/%m/%Y') AS t60_fch_giro,
	d.t60_mto_des,
	d.t60_nro_cheque, 
	DATE_FORMAT(d.t60_fch_depo,'%d/%m/%Y') AS t60_fch_depo,
	d.t60_obs_tippago
from  t60_ejecucion_desemb d 
left join v_matriz_proyectos proy on (d.t02_cod_proy=proy.codigo)
LEFT JOIN t00_tipo_pago  tp ON (d.t60_tip_pago=tp.t00_tip_pago)
WHERE proy.concurso = (case when _concurso='*' then proy.concurso else _concurso end ) 
  and proy.codinst = (CASE WHEN _idinst<=0  THEN proy.codinst ELSE _idinst END ) 
  and DATE_FORMAT( d.t60_fch_giro,'%Y%m') BETWEEN _perini and _perfin ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_desembolsos_periodo_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_desembolsos_periodo_me`(IN _concurso VARCHAR(5), in _idinst int, in _perini varchar(10), in _perfin varchar(10) )
BEGIN
	
Select  proy.concurso ,
	proy.codigo,
	proy.titulo,
	proy.siglas,
	moni.t01_sig_inst as siglas_moni,
	proy.inicio,
	proy.termino,
	date_FORMAT(d.t60_fch_giro,'%Y%m') as periodo,
	d.t60_id_visita, 
	d.t60_id_nropago,
	d.t60_id_desemb, 
	tp.t00_nom_lar AS tipopago, 
	DATE_FORMAT( d.t60_fch_giro,'%d/%m/%Y') AS t60_fch_giro,
	d.t60_mto_des,
	d.t60_nro_cheque, 
	DATE_FORMAT(d.t60_fch_depo,'%d/%m/%Y') AS t60_fch_depo,
	d.t60_obs_tippago
from  t60_ejecucion_desemb_me d 
left join v_matriz_proyectos proy on (d.t02_cod_proy=proy.codigo)
LEFT JOIN t00_tipo_pago  tp ON (d.t60_tip_pago=tp.t00_tip_pago)
LEFT JOIN t01_dir_inst    moni ON ( SUBSTRING_INDEX(proy.cod_me,'.',1)= moni.t01_id_inst )
WHERE proy.concurso = (case when _concurso='*' then proy.concurso else _concurso end ) 
  and proy.codinst = (CASE WHEN _idinst<=0  THEN proy.codinst ELSE _idinst END ) 
  and DATE_FORMAT( d.t60_fch_giro,'%Y%m') BETWEEN _perini and _perfin ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_desm_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_desm_fe`(
									IN pAnio INT, 
									IN pConcurso VARCHAR(10), 
									IN pSector VARCHAR(10), 
									IN pRegion INT)
BEGIN
	DECLARE aFteFE INT DEFAULT 10;
	DECLARE aIniDate DATE;
	DECLARE aFinDate DATE;
	
	SELECT STR_TO_DATE(CONCAT('', pAnio, '/01/01'), '%Y/%m/%d') INTO aIniDate;
	SELECT STR_TO_DATE(CONCAT('', pAnio, '/12/31'), '%Y/%m/%d') INTO aFinDate;
	
		
	SELECT	SUM(fn_monto_total_desemb_plan_periodo_mes(	proy.t02_cod_proy, 
														proy.t02_version, 
														aFteFE, 
														proy.mes_ini, 
														proy.mes_fin)) AS planeado,
			SUM((SELECT	SUM(IFNULL(ejec.t60_mto_des, 0))
				FROM	t60_ejecucion_desemb ejec
				WHERE	ejec.t02_cod_proy = proy.t02_cod_proy
					AND	YEAR(t60_fch_depo) = pAnio)) AS ejecutado
	FROM (
			SELECT	proy2.t02_cod_proy, 
					proy2.t02_version, 
					proy2.t02_sect_prod,
					CASE 
						WHEN aIniDate > proy2.fch_ini THEN 
							CEILING(DATEDIFF(aIniDate, proy2.fch_ini) / 30) + 1
						ELSE 
							1 
					END AS mes_ini,
					CASE 
						WHEN  aFinDate < proy2.fch_ter THEN 
							CEILING(DATEDIFF(aFinDate, proy2.fch_ini) / 30) 
						ELSE 
							CEILING(DATEDIFF(proy2.fch_ter, proy2.fch_ini) / 30) 
					END AS mes_fin
			FROM (
					SELECT	t02_cod_proy, t02_version, t02_sect_prod,
							CASE
								WHEN t02_fch_ire IS NOT NULL AND t02_fch_ire != '0000-00-00' THEN
									t02_fch_ire
								WHEN t02_fch_ini IS NOT NULL AND t02_fch_ini != '0000-00-00' THEN
									t02_fch_ini
								ELSE
									t02_fch_isc
							END AS fch_ini,
							CASE
								WHEN t02_fch_tam IS NOT NULL AND t02_fch_tam != '0000-00-00' THEN
									t02_fch_tam
								WHEN t02_fch_tre IS NOT NULL AND t02_fch_tre != '0000-00-00' THEN
									t02_fch_tre
								ELSE
									t02_fch_ter
							END AS fch_ter
					FROM	t02_dg_proy
					WHERE 	t02_version = fn_pri_version_proy(t02_cod_proy)
				) proy2
			WHERE	YEAR(proy2.fch_ini) = pAnio 
				OR ( YEAR(proy2.fch_ini) < pAnio AND YEAR(proy2.fch_ter) = pAnio )
				OR ( YEAR(proy2.fch_ini) < pAnio AND YEAR(proy2.fch_ter) > pAnio )
		) proy
		LEFT JOIN	(SELECT t02_cod_proy, IFNULL(t03_dpto, 0) AS t03_dpto
					FROM t03_dist_proy 
					WHERE t02_version = fn_pri_version_proy(t02_cod_proy)
					GROUP BY t02_cod_proy)	dist	ON (proy.t02_cod_proy = dist.t02_cod_proy)
		WHERE	SUBSTR(proy.t02_cod_proy,3,2) = (CASE WHEN pConcurso = '*' THEN SUBSTR(proy.t02_cod_proy,3,2) ELSE pConcurso END)
			AND proy.t02_sect_prod = (CASE WHEN pSector = "*" THEN proy.t02_sect_prod ELSE pSector END)
			AND	IFNULL(dist.t03_dpto, 0) = (CASE WHEN pRegion = '*' THEN IFNULL(dist.t03_dpto, 0) ELSE pRegion END);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_eval_informes_monitoreo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_eval_informes_monitoreo`(IN _proy VARCHAR(10))
BEGIN
DECLARE _ver INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver ;

SELECT 	informes.num ,
	DATE_FORMAT(infme.t30_fch_pre,'%d/%m/%Y') AS fecha_me,
	fn_puntaje_califica_inf_me(infme.t02_cod_proy, infme.t30_id, infme.t30_ver_inf) AS califica_me,
	DATE_FORMAT(infmi.t45_fch_pre,'%d/%m/%Y') AS fecha_mi,
	fn_puntaje_califica_inf_monint(infmi.t02_cod_proy, infmi.t45_id, infmi.t45_ver_inf) AS califica_mi,
	DATE_FORMAT(infmf.t51_fch_pre,'%d/%m/%Y') AS fecha_mf , 
	calmf.cod_ext AS califica_mf
  FROM (
	SELECT 	inf.t02_cod_proy,  inf.t30_id AS num  FROM  t30_inf_me  inf WHERE inf.t02_cod_proy = _proy
	UNION DISTINCT 
	SELECT 	inf.t02_cod_proy,  inf.t45_id AS num  FROM  t45_inf_mi  inf WHERE inf.t02_cod_proy = _proy
	UNION DISTINCT
	SELECT 	inf.t02_cod_proy, inf.t51_num AS num  FROM  t51_inf_mf inf WHERE  inf.t02_cod_proy = _proy
  ) AS informes 
LEFT JOIN t30_inf_me  infme ON (informes.t02_cod_proy = infme.t02_cod_proy AND informes.num = infme.t30_id AND infme.t30_ver_inf=   (SELECT MAX(v.t30_ver_inf) FROM t30_inf_me v WHERE v.t02_cod_proy=infme.t02_cod_proy AND v.t30_id=infme.t30_id)   )
LEFT JOIN t45_inf_mi  infmi ON (informes.t02_cod_proy = infmi.t02_cod_proy AND informes.num = infmi.t45_id AND infmi.t45_ver_inf=   (SELECT MAX(v.t45_ver_inf) FROM t45_inf_mi v WHERE v.t02_cod_proy=infmi.t02_cod_proy AND v.t45_id=infmi.t45_id)   )
LEFT JOIN t51_inf_mf  infmf ON (informes.t02_cod_proy = infmf.t02_cod_proy AND informes.num = infmf.t51_num )
LEFT JOIN adm_tablas_aux calmf  ON(infmf.t51_califica=calmf.codi)  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_ficha_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_ficha_proyecto`(IN _proy VARCHAR(10), 
 IN _ver   INT)
BEGIN
DECLARE _fe INT DEFAULT 10 ;
DECLARE _benef INT DEFAULT 63 ;
	SELECT	  inst.t01_sig_inst ,
		  proy.t02_cod_proy ,
		  proy.t02_nro_exp , 
		  proy.t02_version ,
		  proy.t02_nom_proy , 
		  proy.t01_id_inst, 
		  inst.t01_nom_inst ,
		  DATE_FORMAT(inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
		  proy.t02_fin,
		  proy.t02_pro,
			proy.t02_dire_proy as direccion,
			proy.t02_ciud_proy as ciudad,
		  fn_duracion_proy(proy.t02_cod_proy, proy.t02_version) AS duracion,
		  DATE_FORMAT(proy.t02_fch_ini,'%d/%m/%Y') AS t02_fch_ini,
		  DATE_FORMAT(proy.t02_fch_apro,'%d/%m/%Y') AS t02_fch_apro,
			DATE_FORMAT(proy.t02_fch_ire,'%d/%m/%Y') AS t02_fch_ire,
			DATE_FORMAT(proy.t02_fch_tre,'%d/%m/%Y') AS t02_fch_tre,
			DATE_FORMAT(proy.t02_fch_tam,'%d/%m/%Y') AS t02_fch_tam,
		  inst.t01_pres_anio AS presup_prom_anual,
		  NULL AS inst_colabora,
		  CONCAT(mt.t90_ape_pat,' ',mt.t90_ape_mat,', ',mt.t90_nom_equi) AS  moni_tema,
		  CONCAT(mf.t90_ape_pat,' ',mf.t90_ape_mat,', ',mf.t90_nom_equi) AS  moni_fina,
		  CONCAT(ext.t01_ape_pat,' ',ext.t01_ape_mat,', ',ext.t01_nom_cto) AS moni_exte,
		  proy.t02_ben_obj,
		  
		  fn_costos_total_proyecto(_proy, 1) AS t02_pres_tot,
		  
		  
		  fn_total_aporte_fuentes_financ3(_proy , 1, _fe ) AS t02_pres_fe,		 
		  
		  fn_total_aporte_fuentes_financ3(_proy , 1, proy.t01_id_inst ) AS t02_pres_eje,
		  
		  
		  ( fn_costos_total_proyecto(_proy, 1) - fn_total_aporte_fuentes_financ3(_proy , 1, _fe )   )AS aportes_contra,
		  
		  proy.t02_dire_proy,
		  proy.t02_ciud_proy,
		  proy.t02_tele_proy,
		  proy.t02_fax_proy,
		  proy.t02_mail_proy,
		  proy.t02_num_mes,
			proy.t02_num_mes_amp,
		  t.descrip,
		  sec.descrip AS sector,
		  sub.descrip AS subsector,
		  c.t02_nom_benef AS beneficiario,
		  ic.t01_nro_cta AS cuenta,		 
		  b.t00_nom_lar AS banco,
		  tp.t00_nom_lar AS tipocuenta,
		  m.t00_nom_lar AS moneda,
		  t.descrip as estado,
		  proy.usr_crea
	FROM	  t02_dg_proy proy
	LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
	LEFT  JOIN  t90_equi_fe   mt   ON(proy.t02_moni_tema  =  mt.t90_id_equi) 
	LEFT  JOIN  t90_equi_fe   mf   ON(proy.t02_moni_fina  =  mf.t90_id_equi) 
	LEFT  JOIN  t01_inst_cto  ext  ON(proy.t02_moni_ext = CONCAT(ext.t01_id_inst,'.',ext.t01_id_cto))
	
	LEFT  JOIN  t02_proy_ctas   c   ON(proy.t02_cod_proy  =  c.t02_cod_proy) 
	LEFT  JOIN  t01_inst_ctas   ic   ON(ic.t01_id_inst  =  c.t01_id_inst AND ic.t01_id_cta=c.t01_id_cta) 
	LEFT  JOIN  t00_bancos b ON(b.t00_cod_bco  =  ic.t00_cod_bco) 
	LEFT  JOIN  t00_tipo_cuenta tp ON(tp.t00_cod_cta  =  ic.t00_cod_cta) 
	LEFT  JOIN  t00_tipo_moneda m ON(m.t00_cod_mon  =  ic.t00_cod_mon) 
	LEFT  JOIN  adm_tablas_aux   t   ON(proy.t02_estado  =  t.codi) 
	LEFT  JOIN  adm_tablas_aux sec ON (proy.t02_sect_prod=sec.codi)
	LEFT  JOIN  adm_tablas_aux2 sub ON (proy.t02_subsect_prod=sub.codi)
	
	WHERE proy.t02_cod_proy = _proy 
	  AND proy.t02_version  = _ver  ;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_ficha_proyecto_all` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_rpt_ficha_proyecto_all`(IN _proy VARCHAR(10),  IN _ver   INT, IN _all TINYINT)
BEGIN
DECLARE _fe INT DEFAULT 10 ;
DECLARE _benef INT DEFAULT 63 ;
	SELECT	  inst.t01_sig_inst ,
		  proy.t02_cod_proy ,
		  proy.t02_nro_exp , 
		  proy.t02_version ,
		  proy.t02_nom_proy , 
		  proy.t01_id_inst, 
		  inst.t01_nom_inst ,
		  DATE_FORMAT(inst.t01_fch_fund,'%d/%m/%Y') AS t01_fch_fund,
		  proy.t02_fin,
		  proy.t02_pro,
			proy.t02_dire_proy as direccion,
			proy.t02_ciud_proy as ciudad,
		  fn_duracion_proy(proy.t02_cod_proy, proy.t02_version) AS duracion,
		  DATE_FORMAT(proy.t02_fch_ini,'%d/%m/%Y') AS t02_fch_ini,
		  DATE_FORMAT(proy.t02_fch_apro,'%d/%m/%Y') AS t02_fch_apro,
			DATE_FORMAT(proy.t02_fch_ire,'%d/%m/%Y') AS t02_fch_ire,
			DATE_FORMAT(proy.t02_fch_tre,'%d/%m/%Y') AS t02_fch_tre,
			DATE_FORMAT(proy.t02_fch_tam,'%d/%m/%Y') AS t02_fch_tam,
		  inst.t01_pres_anio AS presup_prom_anual,
		  NULL AS inst_colabora,
		  CONCAT(mt.t90_ape_pat,' ',mt.t90_ape_mat,', ',mt.t90_nom_equi) AS  moni_tema,
		  CONCAT(mf.t90_ape_pat,' ',mf.t90_ape_mat,', ',mf.t90_nom_equi) AS  moni_fina,
		  CONCAT(ext.t01_ape_pat,' ',ext.t01_ape_mat,', ',ext.t01_nom_cto) AS moni_exte,
		  proy.t02_ben_obj,
		  
		  fn_costos_total_proyecto(_proy, 1) AS t02_pres_tot,
		  
		  
		  fn_total_aporte_fuentes_financ3(_proy , 1, _fe ) AS t02_pres_fe,		 
		  
		  fn_total_aporte_fuentes_financ3(_proy , 1, proy.t01_id_inst ) AS t02_pres_eje,
		  
		  
		  ( fn_costos_total_proyecto(_proy, 1) - fn_total_aporte_fuentes_financ3(_proy , 1, _fe )   )AS aportes_contra,
		  
		  proy.t02_dire_proy,
		  proy.t02_ciud_proy,
		  proy.t02_tele_proy,
		  proy.t02_fax_proy,
		  proy.t02_mail_proy,
		  proy.t02_num_mes,
			proy.t02_num_mes_amp,
		  t.descrip,
          	  secmain.nom_tabla AS sector_main,
		  sec.descrip AS sector,
		  sub.descrip AS subsector,
		  sector_prod.t02_obs AS prod_promovido,


		  c.t02_nom_benef AS beneficiario,
		  ic.t01_nro_cta AS cuenta,		 
		  b.t00_nom_lar AS banco,
		  tp.t00_nom_lar AS tipocuenta,
		  m.t00_nom_lar AS moneda,
		  t.descrip as estado,
		  proy.usr_crea
		
	FROM	  t02_dg_proy proy
	LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
	LEFT  JOIN  t90_equi_fe   mt   ON(proy.t02_moni_tema  =  mt.t90_id_equi) 
	LEFT  JOIN  t90_equi_fe   mf   ON(proy.t02_moni_fina  =  mf.t90_id_equi) 
	LEFT  JOIN  t01_inst_cto  ext  ON(proy.t02_moni_ext = CONCAT(ext.t01_id_inst,'.',ext.t01_id_cto))
	
	LEFT  JOIN  t02_proy_ctas   c   ON(proy.t02_cod_proy  =  c.t02_cod_proy) 
	LEFT  JOIN  t01_inst_ctas   ic   ON(ic.t01_id_inst  =  c.t01_id_inst AND ic.t01_id_cta=c.t01_id_cta) 
	LEFT  JOIN  t00_bancos b ON(b.t00_cod_bco  =  ic.t00_cod_bco) 
	LEFT  JOIN  t00_tipo_cuenta tp ON(tp.t00_cod_cta  =  ic.t00_cod_cta) 
	LEFT  JOIN  t00_tipo_moneda m ON(m.t00_cod_mon  =  ic.t00_cod_mon) 
	LEFT  JOIN  adm_tablas_aux   t   ON(proy.t02_estado  =  t.codi) 

	LEFT  JOIN t02_sector_prod sector_prod ON (proy.t02_cod_proy = sector_prod.t02_cod_proy)  
	LEFT  JOIN  adm_tablas secmain ON (sector_prod.t02_sector_main=secmain.cod_tabla)
    	LEFT  JOIN  adm_tablas_aux sec ON (sector_prod.t02_sector=sec.codi)
	LEFT  JOIN  adm_tablas_aux2 sub ON (sector_prod.t02_subsec=sub.codi)
	
	WHERE proy.t02_cod_proy = (CASE WHEN _all = 1 THEN proy.t02_cod_proy ELSE _proy END)
	  AND proy.t02_version  = (CASE WHEN _all = 1 THEN fn_ult_version_proy(proy.t02_cod_proy) ELSE _ver END);	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_ficha_proyecto_fee` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_ficha_proyecto_fee`(IN _proy VARCHAR(10), IN _ver   INT, IN _id INT)
BEGIN
DECLARE _fe INT default 10 ;
SELECT 	i.t01_id_inst,
	i.t01_sig_inst,
	fn_total_aporte_fuentes_financ3(f.t02_cod_proy, _ver, f.t01_id_inst) AS monto
  FROM    t02_fuente_finan f
LEFT JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst) 
 WHERE f.t02_cod_proy = _proy 
 AND f.t01_id_inst = 10 
UNION
SELECT 	ii.t01_id_inst,
	ii.t01_sig_inst,
	fn_total_aporte_fuentes_financ3(ff.t02_cod_proy, _ver, ff.t01_id_inst) AS monto
  FROM    t02_fuente_finan ff
LEFT JOIN t01_dir_inst     ii ON (ff.t01_id_inst=ii.t01_id_inst) 
 WHERE ff.t02_cod_proy = _proy 
 AND ff.t01_id_inst = _id 
UNION
SELECT 	ii.t01_id_inst,
	ii.t01_sig_inst,
	fn_total_aporte_fuentes_financ3(ff.t02_cod_proy, _ver, ff.t01_id_inst) AS monto
  FROM    t02_fuente_finan ff
LEFT JOIN t01_dir_inst     ii ON (ff.t01_id_inst=ii.t01_id_inst) 
 WHERE ff.t02_cod_proy = _proy 
 AND ff.t01_id_inst <> 10
 AND ff.t01_id_inst <> _id;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_ficha_proyecto_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_ficha_proyecto_fuentes`(IN _proy VARCHAR(10), 
					         IN _ver   INT)
BEGIN
	SELECT 		i.t01_id_inst,
				i.t01_sig_inst,
				fn_total_aporte_fuentes_financ3(f.t02_cod_proy, _ver, f.t01_id_inst) AS monto
	FROM    	t02_fuente_finan f
	LEFT JOIN	t01_dir_inst     i ON (f.t01_id_inst = i.t01_id_inst) 
	WHERE		f.t02_cod_proy = _proy;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_fuente_financiamiento` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_fuente_financiamiento`(IN _proy VARCHAR(10))
BEGIN
	SELECT 	f.t02_cod_proy, 
		f.t01_id_inst, 
		i.t01_sig_inst, 
		i.t01_nom_inst, 
		(fn_total_aporte_fuentes_financ3(_proy,1,f.t01_id_inst)) as monto_aportado
	FROM t02_fuente_finan f
	LEFT JOIN t01_dir_inst i ON (f.t01_id_inst=i.t01_id_inst)
	WHERE f.t02_cod_proy = _proy;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inf_financ_anexo_01` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inf_financ_anexo_01`( 
						IN _proy VARCHAR(10) ,
						IN _anio INT ,
						IN _mes INT,
						IN _idfte INT
					      )
BEGIN
DECLARE _nummes INT DEFAULT fn_numero_mes(_anio, _mes);
DECLARE _totalproy DOUBLE ;
DECLARE _linebase DOUBLE ;
DECLARE _desembolsado DOUBLE ;
DECLARE _saldo_desemb DOUBLE ;
DECLARE _fteFE   INT DEFAULT 10 ;
IF _nummes = 0 THEN
  SELECT i.t40_anio, i.t40_mes, fn_numero_mes(i.t40_anio, i.t40_mes)
    INTO _anio, _mes, _nummes
    FROM t40_inf_financ i
   WHERE i.t02_cod_proy = _proy 
   ORDER BY  fn_numero_mes(i.t40_anio, i.t40_mes) DESC 
   LIMIT 1 ;
END IF ;


SET _totalproy = fn_total_aporte_fuentes_financ3(_proy,1, _idfte );
SET _linebase = (CASE WHEN _idfte = _fteFE THEN fn_mp_linea_base(_proy,1) ELSE 0 END) ;
IF _idfte = _fteFE THEN
	SELECT IFNULL(SUM(d.t60_mto_des),0)
	  INTO _desembolsado
	  FROM t60_ejecucion_desemb d 
	 WHERE d.t02_cod_proy = _proy
	   AND d.t60_id_trim <= TRUNCATE((_nummes / 3),0)  ;
ELSE
	SELECT 0 INTO _desembolsado; 
END IF;
SET _saldo_desemb = (( _totalproy - _linebase ) - _desembolsado) ;
DROP TEMPORARY TABLE IF EXISTS tmpInfMeses ;
DROP TEMPORARY TABLE IF EXISTS tmpInfMeses2 ;
CREATE TEMPORARY TABLE IF NOT EXISTS tmpInfMeses
SELECT 	'' AS concepto,
	i.anio,
	i.mes, 
	i.nummes,
	i.trimestre,
	
	
	(CASE WHEN _idfte = _fteFE 
		THEN 	(SELECT IFNULL(SUM(dd.t60_mto_des) ,0)
			   FROM t60_ejecucion_desemb dd 
			  WHERE dd.t02_cod_proy = _proy 
			    AND DATE_FORMAT(dd.t60_fch_giro,'%Y%m') BETWEEN i.peri_real AND i.peri_real ) 
		ELSE 0
		END) AS mto_tot_des,
	
	fn_monto_total_desemb_plan_periodo_mes(i.proyecto, 1, _idfte , i.nummes, i.nummes) AS tot_mto_pre,
	i.monto_ejec AS gasto_ejecutado_sc,
	0 AS gasto_ejecutado_cc, 
	i.otro_ing AS otros_ingresos,
	i.abon_bco AS abono_bancos
FROM 	( 
	SELECT  inf.t02_cod_proy AS proyecto,
		inf.t40_anio     AS anio, 
		inf.t40_mes      AS mes,
		fn_numero_mes(inf.t40_anio, inf.t40_mes) AS nummes,
		(CASE WHEN (fn_numero_mes(inf.t40_anio, inf.t40_mes) MOD 3)=0 THEN TRUNCATE(fn_numero_mes(inf.t40_anio, inf.t40_mes) / 3,0) ELSE TRUNCATE(fn_numero_mes(inf.t40_anio, inf.t40_mes) / 3,0) + 1 END) AS trimestre,
		(
		SELECT SUM(gas.t41_gasto) 
		     FROM  t41_inf_financ_gasto gas 
		     WHERE gas.t02_cod_proy= inf.t02_cod_proy
		       AND gas.t40_anio=inf.t40_anio
		       AND gas.t40_mes=inf.t40_mes
		       AND gas.t41_fte_finan = _idfte
		) AS monto_ejec,
		IFNULL(inf.t40_abo_bco,0) AS abon_bco,
		IFNULL(inf.t40_otro_ing,0) AS otro_ing,
		DATE_FORMAT(DATE_ADD(proy.t02_fch_ini, INTERVAL fn_numero_mes(inf.t40_anio, inf.t40_mes)-1 MONTH), '%Y%m') AS peri_real
	FROM 	  t40_inf_financ  inf
	LEFT JOIN t02_dg_proy     proy ON (inf.t02_cod_proy = proy.t02_cod_proy AND proy.t02_version=fn_ult_version_proy(proy.t02_cod_proy))
	WHERE 	inf.t02_cod_proy = _proy
	  AND fn_numero_mes(inf.t40_anio, inf.t40_mes) <= _nummes
	ORDER BY inf.t40_anio, inf.t40_mes, inf.t40_periodo
	) AS i ;
 
CREATE TEMPORARY TABLE IF NOT EXISTS tmpInfMeses2
SELECT  CONCAT('Mes de ', fn_nom_periodo(_proy, i.anio, i.mes) ) AS concepto,
	'mes' AS tipo,
	CONCAT(i.trimestre,'.', i.nummes ) AS orden,
	i.anio,
	i.mes, 
	i.nummes,
	i.trimestre,
	i.mto_tot_des,
	
	i.tot_mto_pre,
	i.gasto_ejecutado_sc,
	i.gasto_ejecutado_cc,
	i.otros_ingresos,
	i.abono_bancos
FROM tmpInfMeses i ;
INSERT INTO tmpInfMeses2
SELECT  CONCAT('Trimestre ', gi.trimestre, ' \n(',fn_nom_periodo(_proy, MAX(gi.anio), MAX(gi.mes)-2),' - ', fn_nom_periodo(_proy, MAX(gi.anio), MAX(gi.mes)),')') AS concepto,
	'trim' AS tipo,
	gi.trimestre AS orden,
	MAX(gi.anio),
	MAX(gi.mes), 
	MAX(gi.nummes),
	gi.trimestre,
	SUM(gi.mto_tot_des),
	SUM(gi.tot_mto_pre),
	SUM(gi.gasto_ejecutado_sc),
	SUM(gi.gasto_ejecutado_cc),
	SUM(gi.otros_ingresos),
	SUM(gi.abono_bancos)
FROM tmpInfMeses gi
GROUP BY gi.trimestre ;
INSERT INTO tmpInfMeses2(concepto, tipo, orden , mto_tot_des, tot_mto_pre , trimestre, nummes) VALUES 
('MONTO TOTAL DEL PROYECTO ', 'a', 0, 0,_totalproy, 0, 0),
('Linea de base Fondoempleo 4%', 'b', 0, 0, _linebase, 0, 0),
('Total a Transferir ', 'c', 0, 0, (_totalproy - _linebase), 0, 0),
('Monto desembolsado a la fecha ', 'd', 0, _desembolsado,0 , 0, 0),
('Saldo a desembolsar ', 'e', 0, _saldo_desemb ,0 , 0, 0);
SELECT  i.concepto, 
	i.tipo,
	i.anio,
	i.mes, 
	i.nummes,
	i.trimestre,
	i.mto_tot_des,
	i.tot_mto_pre,
	i.gasto_ejecutado_sc,
	i.gasto_ejecutado_cc,
	i.otros_ingresos,
	i.abono_bancos
  FROM tmpInfMeses2 i 
ORDER BY orden ASC, tipo ASC ; 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inf_financ_anexo_03` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inf_financ_anexo_03`( 
						IN _proy VARCHAR(10) ,
						in _anio int ,
						in _mes int,
						in _idFteFinanc int
					      )
BEGIN
declare _nummes int default fn_numero_mes(_anio, _mes);
declare _version int default 1 ;
drop TEMPORARY table if EXISTS tmpRubros ;
DROP TEMPORARY TABLE IF EXISTS tmpReturn ;
create temporary table tmpRubros 
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(SUM(p.t10_cant * p.t10_cu) * s.t09_mta) AS total,
	(SUM( 
		fn_monto_total_planificado_fte(
						p.t02_cod_proy, 
						p.t02_version, 
						p.t08_cod_comp, 
						p.t09_cod_act, 
						p.t09_cod_sub, 
						p.t10_cod_cost, 
						_idFteFinanc 
						) 
		)
	 ) AS aporte_fe,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  =_version
GROUP BY 1,2,3 
UNION ALL 

SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo, 
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	(
	 SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.rubro      = (CASE WHEN vmp.subactividad IS NULL THEN vmp.codigo ELSE (vmp.cate_gasto - 80) END) 
			     AND fte.idinst = _idFteFinanc
	) AS aporte_fe,
	
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
 FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _version
  AND vmp.cate_gasto IS NOT NULL
  GROUP BY 1, 2, 3 ;
 
insert into  tmpRubros 
SELECT 	
	CONCAT(vmp.componente,'.',vmp.actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	vmp.um AS um,
	vmp.gasto AS parcial,
	vmp.meta AS meta,
	vmp.gasto * vmp.meta  AS total,
	(
	 SELECT SUM(fte.aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     IS NULL
			     AND fte.rubro      IS NULL
			     AND fte.idinst 	= _idFteFinanc
	) AS aporte_fe,
	CONCAT(80 + vmp.componente,'.',vmp.actividad) AS codigo_real
 FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _version
  AND vmp.cate_gasto IS NULL AND vmp.codsub IS NULL ;
 
alter  table tmpRubros 
   ADD COLUMN gasto_acum DOUBLE NULL AFTER codigo_real, 
   add column m1 double NULL after gasto_acum, 
   add column m2 double NULL after m1, 
   add column m3 double NULL after m2,
   ADD COLUMN t1 DOUBLE NULL AFTER m3,
   ADD COLUMN m4 DOUBLE NULL AFTER t1,
   ADD COLUMN m5 DOUBLE NULL AFTER m4,
   ADD COLUMN m6 DOUBLE NULL AFTER m5,
   ADD COLUMN t2 DOUBLE NULL AFTER m6,
   ADD COLUMN m7 DOUBLE NULL AFTER t2,
   ADD COLUMN m8 DOUBLE NULL AFTER m7,
   ADD COLUMN m9 DOUBLE NULL AFTER m8,
   ADD COLUMN t3 DOUBLE NULL AFTER m9,
   ADD COLUMN m10 DOUBLE NULL AFTER t3,
   ADD COLUMN m11 DOUBLE NULL AFTER m10,
   ADD COLUMN m12 DOUBLE NULL AFTER m11,
   ADD COLUMN t4 DOUBLE NULL AFTER m12,
   ADD COLUMN tot_pre_ejec DOUBLE NULL AFTER t4,
   ADD COLUMN porc_ejec DOUBLE NULL AFTER tot_pre_ejec,
   ADD COLUMN pre_x_ejec DOUBLE NULL AFTER porc_ejec ;
update tmpRubros 
   set gasto_acum = ( SELECT ifnull(SUM(gas.t41_gasto),0) 
		        FROM  t41_inf_financ_gasto gas 
		       WHERE gas.t02_cod_proy = _proy
		         AND concat(gas.t08_cod_comp,'.', gas.t09_cod_act, '.', gas.t09_cod_sub, '.' ,gas.t41_cate_gasto) = tmpRubros.codigo
		         AND gas.t41_fte_finan = _idFteFinanc
		         AND gas.t40_anio < _anio
		     );
		     
UPDATE tmpRubros AS r
LEFT JOIN ( 	SELECT 	
			( CASE WHEN (gas.t09_cod_sub=0 AND gas.t41_cate_gasto=0 )
			    THEN CONCAT(gas.t08_cod_comp,'.', gas.t09_cod_act) 
			    ELSE CONCAT(gas.t08_cod_comp,'.', gas.t09_cod_act, '.', gas.t09_cod_sub, '.' ,gas.t41_cate_gasto) 
			  END ) AS codigo,
			SUM(CASE WHEN gas.t40_mes = 1 THEN gas.t41_gasto ELSE 0 END ) AS m1,
			SUM(CASE WHEN gas.t40_mes = 2 THEN gas.t41_gasto ELSE 0 END ) AS m2,
			SUM(CASE WHEN gas.t40_mes = 3 THEN gas.t41_gasto ELSE 0 END ) AS m3,
			SUM(CASE WHEN gas.t40_mes = 4 THEN gas.t41_gasto ELSE 0 END ) AS m4,
			SUM(CASE WHEN gas.t40_mes = 5 THEN gas.t41_gasto ELSE 0 END ) AS m5,
			SUM(CASE WHEN gas.t40_mes = 6 THEN gas.t41_gasto ELSE 0 END ) AS m6,
			SUM(CASE WHEN gas.t40_mes = 7 THEN gas.t41_gasto ELSE 0 END ) AS m7,
			SUM(CASE WHEN gas.t40_mes = 8 THEN gas.t41_gasto ELSE 0 END ) AS m8,
			SUM(CASE WHEN gas.t40_mes = 9 THEN gas.t41_gasto ELSE 0 END ) AS m9,
			SUM(CASE WHEN gas.t40_mes = 10 THEN gas.t41_gasto ELSE 0 END ) AS m10,
			SUM(CASE WHEN gas.t40_mes = 11 THEN gas.t41_gasto ELSE 0 END ) AS m11,
			SUM(CASE WHEN gas.t40_mes = 12 THEN gas.t41_gasto ELSE 0 END ) AS m12
		  FROM  t41_inf_financ_gasto gas 
		 WHERE gas.t02_cod_proy = _proy
		   AND gas.t41_fte_finan = _idFteFinanc
		   AND gas.t40_anio = _anio AND gas.t40_mes <= _mes
		GROUP BY codigo 
	    ) AS w ON (r.codigo = w.codigo) 
SET	r.m1 = w.m1,
	r.m2 = w.m2,
	r.m3 = w.m3,
	r.m4 = w.m4,
	r.m5 = w.m5,
	r.m6 = w.m6,
	r.m7 = w.m7,
	r.m8 = w.m8,
	r.m9 = w.m9,
	r.m10 = w.m10,
	r.m11 = w.m11,
	r.m12 = w.m12,
	r.t1 = (w.m1 + w.m2 + w.m3),
	r.t2 = (w.m4 + w.m5 + w.m6),
	r.t3 = (w.m7 + w.m8 + w.m9),
	r.t4 = (w.m10 + w.m11 + w.m12) 	;
	
UPDATE tmpRubros set tot_pre_ejec = gasto_acum + (t1 + t2 + t3 + t4) ;
UPDATE tmpRubros 
  SET porc_ejec = ( IFNULL(tot_pre_ejec,0) * 100 / aporte_fe),
      pre_x_ejec = ( aporte_fe - IFNULL(tot_pre_ejec,0)) ;
create temporary table tmpReturn 
SELECT 	sub.codigo	,
	sub.descripcion	,
	sub.um	,
	sum(s.parcial) as parcial	,
	sub.meta	,
	sum(s.total) as total	,
	sum(s.aporte_fe) as aporte_fe	,
	SUBSTRING_INDEX(s.codigo_real,'.',3) AS codigo_real	,
	'subactividad' AS tipo,
	SUM(s.gasto_acum) AS gasto_acum	,
	SUM(s.m1) AS m1	,
	SUM(s.m2) AS m2	,
	SUM(s.m3) AS m3	,
	SUM(s.t1) AS t1	,
	
	SUM(s.m4) AS m4	,
	SUM(s.m5) AS m5	,
	SUM(s.m6) AS m6	,
	SUM(s.t2) AS t2	,
	
	SUM(s.m7) AS m7	,
	SUM(s.m8) AS m8	,
	SUM(s.m9) AS m9	,
	SUM(s.t3) AS t3	,
	
	SUM(s.m10) AS m10	,
	SUM(s.m11) AS m11	,
	SUM(s.m12) AS m12	,
	SUM(s.t4) AS t4	,
	SUM(s.tot_pre_ejec) AS tot_pre_ejec	,
	SUM(s.porc_ejec) AS porc_ejec	,
	SUM(s.pre_x_ejec) AS pre_x_ejec	
FROM tmpRubros s 
inner JOIN v_subactividades sub ON (sub.t02_cod_proy=_proy and sub.t02_version=1 AND SUBSTRING_INDEX(s.codigo,'.',3)=sub.codigo )
GROUP BY 1,2,3,5,8,9 ;
INSERT INTO tmpReturn
SELECT 	act.codigo	,
	act.descripcion	,
	null as 'um'	,
	SUM(s.parcial) AS parcial	,
	null as 'meta'	,
	SUM(s.total) AS total	,
	SUM(s.aporte_fe) AS aporte_fe	,
	SUBSTRING_INDEX(s.codigo_real,'.',2) AS codigo_real	,
	'actividad' AS tipo,
	SUM(s.gasto_acum) AS gasto_acum	,
	SUM(s.m1) AS m1	,
	SUM(s.m2) AS m2	,
	SUM(s.m3) AS m3	,
	SUM(s.t1) AS t1	,
	SUM(s.m4) AS m4	,
	SUM(s.m5) AS m5	,
	SUM(s.m6) AS m6	,
	SUM(s.t2) AS t2	,
	SUM(s.m7) AS m7	,
	SUM(s.m8) AS m8	,
	SUM(s.m9) AS m9	,
	SUM(s.t3) AS t3	,
	SUM(s.m10) AS m10	,
	SUM(s.m11) AS m11	,
	SUM(s.m12) AS m12	,
	SUM(s.t4) AS t4	,
	SUM(s.tot_pre_ejec) AS tot_pre_ejec	,
	SUM(s.porc_ejec) AS porc_ejec	,
	SUM(s.pre_x_ejec) AS pre_x_ejec	
FROM tmpRubros s 
INNER JOIN v_actividades act ON (act.t02_cod_proy=_proy AND act.t02_version=1 AND SUBSTRING_INDEX(s.codigo,'.',2)=act.codigo )
GROUP BY 1,2,3,5,8,9 ;
INSERT INTO tmpReturn
SELECT 	comp.codigo	,
	comp.descripcion	,
	NULL AS 'um'	,
	SUM(c.parcial) AS parcial	,
	NULL AS 'meta'	,
	SUM(c.total) AS total	,
	SUM(c.aporte_fe) AS aporte_fe	,
	SUBSTRING_INDEX(c.codigo_real,'.',1) AS codigo_real	,
	'componente' AS tipo,
	SUM(c.gasto_acum) AS gasto_acum	,
	SUM(c.m1) AS m1	,
	SUM(c.m2) AS m2	,
	SUM(c.m3) AS m3	,
	SUM(c.t1) AS t1	,
	SUM(c.m4) AS m4	,
	SUM(c.m5) AS m5	,
	SUM(c.m6) AS m6	,
	SUM(c.t2) AS t2	,
	SUM(c.m7) AS m7	,
	SUM(c.m8) AS m8	,
	SUM(c.m9) AS m9	,
	SUM(c.t3) AS t3	,
	SUM(c.m10) AS m10	,
	SUM(c.m11) AS m11	,
	SUM(c.m12) AS m12	,
	SUM(c.t4) AS t4	,
	SUM(c.tot_pre_ejec) AS tot_pre_ejec	,
	SUM(c.porc_ejec) AS porc_ejec	,
	SUM(c.pre_x_ejec) AS pre_x_ejec	
FROM tmpRubros c
INNER JOIN v_componentes comp ON (comp.t02_cod_proy=_proy AND comp.t02_version=1 AND SUBSTRING_INDEX(c.codigo,'.',1)=comp.codigo )
GROUP BY 1,2,3,5,8,9 ;
insert into tmpReturn
SELECT 	r.codigo	,
	r.descripcion	,
	r.um	,
	r.parcial	,
	r.meta	,
	r.total	,
	r.aporte_fe	,
	r.codigo_real	,
	'rubro' as tipo,
	r.gasto_acum	,
	r.m1	,
	r.m2	,
	r.m3	,
	r.t1	,
	r.m4	,
	r.m5	,
	r.m6	,
	r.t2	,
	r.m7	,
	r.m8	,
	r.m9	,
	r.t3	,
	r.m10	,
	r.m11	,
	r.m12	,
	r.t4	,
	r.tot_pre_ejec	,
	r.porc_ejec	,
	r.pre_x_ejec	
from tmpRubros r 
WHERE r.codigo < 10.4 ;
UPDATE tmpReturn 
  SET porc_ejec = (IFNULL(tot_pre_ejec,0) * 100 / aporte_fe) ;
drop TEMPORARY table tmpRubros ;
select * from tmpReturn order by codigo_real asc ; 
DROP TEMPORARY TABLE tmpReturn ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inf_trim_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inf_trim_capac`( IN _proy VARCHAR(10), 
					  in _anio int, 
					  in _trim int )
BEGIN
DECLARE _sql       LONGTEXT;
DECLARE _tmpsql    TEXT default ' 
SELECT  ben.t11_cod_bene, 
	ben.t11_dni, 
	CONCAT(ben.t11_ape_pat, \' \' ,ben.t11_ape_mat, \', \', ben.t11_nom) AS nombres,
	sex.descrip AS sexo, 
	ben.t11_edad, 
	niv.descrip AS nivel, 
	sec.descrip AS sector, 
	ben.t11_nro_up_a, 
	ben.t11_nro_up_b, 
	ben.t11_nom_prod, 
	ben.t11_direccion, 
	ben.t11_ciudad, 
	ben.t11_telefono, 
	ben.t11_celular, 
	ben.t11_mail, 
	ben.t11_act_princ, 
	est.descrip AS estado
	{subquerys}
FROM 	  t11_bco_bene ben
INNER JOIN t12_plan_capac_tema plan ON (ben.t02_cod_proy = plan.t02_cod_proy AND plan.t02_version={_ver}) 
LEFT JOIN adm_tablas_aux sex ON (ben.t11_sexo = sex.codi) 
LEFT JOIN adm_tablas_aux niv ON (ben.t11_nivel_educ = niv.codi) 
LEFT JOIN adm_tablas_aux sec ON (ben.t11_sec_prod = sec.codi) 
LEFT JOIN adm_tablas_aux est ON (ben.t11_estado = est.codi) 
WHERE 
      ben.t02_cod_proy = \'{_proy}\' 
GROUP BY 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17
ORDER BY nombres ASC; ' ;
declare _tmpsubsql text default '
	 (
	  SELECT cap.t15_avance 
	    FROM t25_inf_trim_capac cap
	   WHERE cap.t02_cod_proy = \'{_proy}\'
	     AND CONCAT(cap.t08_cod_comp,\'.\',cap.t09_cod_act,\'.\',cap.t09_cod_sub) = \'{_codsub}\'
	     AND cap.t12_cod_tema = {_codtema}
	     AND cap.t25_anio = {_anio}
	     AND cap.t25_trim = {_trim}
	     AND cap.t11_cod_bene = ben.t11_cod_bene
	  ) AS \'{_codsubtema}\'' ;
	  
DECLARE _subsql TEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
declare _ver      INT default fn_version_proy_poa(_proy, _anio);
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;
DECLARE _escape INT DEFAULT 0;
DECLARE _codsub CHAR(10);
DECLARE _codtema INT;
declare _nomtema varchar(150);
declare _nrohora double ;
DECLARE _curtemas CURSOR 
	             FOR 
	             SELECT 	CONCAT(tema.t08_cod_comp,'.',tema.t09_cod_act,'.',tema.t09_cod_sub) AS subact,
				tema.t12_cod_tema,
				tema.t12_tem_espe,
				tema.t12_nro_hora
			FROM 	   t12_plan_capac_tema tema
			INNER JOIN t12_plan_capac      plan ON(tema.t02_cod_proy=plan.t02_cod_proy AND tema.t02_version=plan.t02_version AND tema.t08_cod_comp=plan.t08_cod_comp AND tema.t09_cod_act=plan.t09_cod_act AND tema.t09_cod_sub=plan.t09_cod_sub)
			WHERE tema.t02_cod_proy = _proy
			  AND tema.t02_version  = _ver 
			order by t12_modulo, subact , t12_cod_tema ;
			  
DECLARE CONTINUE HANDLER FOR SQLSTATE '02000' SET _escape = 1;
SET _sql = '' ;
OPEN _curtemas;
REPEAT
FETCH _curtemas INTO _codsub , _codtema , _nomtema , _nrohora ;
IF NOT _escape THEN
	set _subsql = replace(_tmpsubsql,'{_proy}',_proy);
	SET _subsql = REPLACE(_subsql,'{_ver}',_ver);
	SET _subsql = REPLACE(_subsql,'{_codsub}',_codsub);
	SET _subsql = REPLACE(_subsql,'{_codtema}',_codtema);
	SET _subsql = REPLACE(_subsql,'{_anio}',_anio);
	SET _subsql = REPLACE(_subsql,'{_trim}',_trim);
	SET _subsql = REPLACE(_subsql,'{_codsubtema}', concat(_codsub,'.',_codtema) );
	
	select concat(_sql, '	,',_subsql,'\n') into _sql ;
	
END IF;
UNTIL _escape END REPEAT;
CLOSE _curtemas;
SET _sql = REPLACE(_tmpsql,'{subquerys}', _sql );
SET _sql = REPLACE(_sql,'{_proy}', _proy);
SET _sql = REPLACE(_sql,'{_ver}' , _ver);
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_instituciones` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_instituciones`()
BEGIN
   SELECT 
	i.t01_id_inst , 
	i.t01_ruc_inst, 
	i.t01_sig_inst,
	t.descrip AS tipo_inst,
	i.t01_nom_inst,	
	IF (i.t01_fch_fund <> '0000-00-00',DATE_FORMAT(i.t01_fch_fund,'%d/%m/%Y'),'') AS fec_fun,
	IF (i.t01_pres_anio > 0,i.t01_pres_anio,'') AS pres_anio,
	fn_tipo_inst_rel_fe(i.t01_rel_fe) AS tipo_rel_fe,
	(SELECT descrip FROM adm_tablas_aux WHERE codi = dg.t02_sect_prod) AS t02_sect_prod,
	dep.nom_ubig AS dpto,
	pro.nom_ubig AS prov,
	dis.nom_ubig AS dist,
	i.t01_dire_inst, 
	i.t01_ciud_inst, 
	i.t01_fono_inst, 
	i.t01_fono2_inst,
	i.t01_rpm_inst,
	i.t01_next_inst,
	i.t01_rpc_inst,
	i.t01_fax_inst, 
	i.t01_mail_inst, 
	i.t01_web_inst, 
	fn_lista_representantes(i.t01_id_inst) AS represen,
	i.t01_carg_rep, 
	fn_nro_proy_en_ejecucion(i.t01_id_inst) AS nro_proy_eje,
	fn_nro_proy_en_monitoreo(i.t01_id_inst) AS nro_proy_mon,
	dg.nro_proy
	FROM t01_dir_inst i
	LEFT JOIN (SELECT COUNT(DISTINCT(t02_cod_proy)) nro_proy , t01_id_inst, t02_sect_prod FROM t02_dg_proy 
		WHERE t02_version = fn_ult_version_proy(t02_cod_proy) 
		GROUP BY t01_id_inst) AS dg ON (dg.t01_id_inst = i.t01_id_inst)
	LEFT JOIN adm_tablas_aux t ON (i.t01_tipo_inst = t.codi)
	LEFT JOIN adm_ubigeo dep ON (i.t01_dpto=dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
	LEFT JOIN adm_ubigeo pro ON (i.t01_dpto=pro.cod_dpto AND i.t01_prov=pro.cod_prov AND pro.cod_dist='00')
	LEFT JOIN adm_ubigeo dis ON (i.t01_dpto=dis.cod_dpto AND i.t01_prov=dis.cod_prov AND i.t01_dist=dis.cod_dist)
   
	ORDER BY t01_sig_inst ASC, nro_proy_mon ASC  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_instituciones_filter_per` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_instituciones_filter_per`(IN _inst VARCHAR(20), IN _rela VARCHAR(20), IN _reg VARCHAR(20), IN _sec VARCHAR(20))
BEGIN
   SELECT 
	i.t01_id_inst , 
	i.t01_ruc_inst, 
	i.t01_sig_inst, 
	i.t01_nom_inst,
	IF (i.t01_fch_fund <> '0000-00-00',DATE_FORMAT(i.t01_fch_fund,'%d/%m/%Y'),'') AS fec_fun,
	IF (i.t01_pres_anio > 0,i.t01_pres_anio,'') AS pres_anio,
	dep.nom_ubig AS dpto,
	pro.nom_ubig AS prov,
	dis.nom_ubig AS dist,	
	i.t01_dire_inst, 
	i.t01_ciud_inst, 
	i.t01_fono_inst, 
	i.t01_fono2_inst,
	i.t01_rpm_inst,
	i.t01_next_inst,
	i.t01_rpc_inst,
	i.t01_fax_inst, 
	i.t01_mail_inst, 
	i.t01_web_inst, 
	i.t01_rel_fe,
	fn_tipo_inst_rel_fe(i.t01_rel_fe) AS tipo_rel_fe,
	fn_lista_representantes(i.t01_id_inst) AS represen,
	i.t01_carg_rep, 
	i.t01_tipo_inst,
	t.descrip AS tipo_inst,
	fn_nro_proy_en_ejecucion(i.t01_id_inst) AS nro_proy_eje,
	fn_nro_proy_en_monitoreo(i.t01_id_inst) AS nro_proy_mon,
	i.usr_crea, 
	i.fch_crea, 
	i.usr_actu, 
	i.fch_actu, 
	i.est_audi,
	(SELECT a.descrip FROM adm_tablas_aux a WHERE a.codi = dg.t02_sect_prod) as t02_sect_prod
   FROM t01_dir_inst i
   LEFT JOIN adm_tablas_aux t ON (i.t01_tipo_inst=t.codi)
	 LEFT JOIN t02_dg_proy dg on (dg.t01_id_inst = i.t01_id_inst)
   LEFT JOIN adm_ubigeo dep ON (i.t01_dpto=dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
   LEFT JOIN adm_ubigeo pro ON (i.t01_dpto=pro.cod_dpto AND i.t01_prov=pro.cod_prov AND pro.cod_dist='00')
   LEFT JOIN adm_ubigeo dis ON (i.t01_dpto=dis.cod_dpto AND i.t01_prov=dis.cod_prov AND i.t01_dist=dis.cod_dist)
   WHERE i.t01_tipo_inst <=> (CASE WHEN _inst='*'  THEN i.t01_tipo_inst ELSE _inst END)
		AND i.t01_rel_fe <=> (CASE WHEN _rela='*'  THEN i.t01_rel_fe ELSE _rela END)
		AND i.t01_dpto <=> (CASE WHEN _reg='*'  THEN i.t01_dpto ELSE _reg END)
		AND dg.t02_sect_prod <=> (CASE WHEN _sec='*'  THEN dg.t02_sect_prod ELSE _sec END)
    ORDER BY t01_sig_inst ASC, nro_proy_mon ASC  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_instituciones_filtro` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_instituciones_filtro`(IN _filter VARCHAR(20))
BEGIN
   SELECT 
	i.t01_id_inst , 
	i.t01_ruc_inst, 
	i.t01_sig_inst, 
	i.t01_nom_inst,
	IF (i.t01_fch_fund <> '0000-00-00',DATE_FORMAT(i.t01_fch_fund,'%d/%m/%Y'),'') AS fec_fun,
	IF (i.t01_pres_anio > 0,i.t01_pres_anio,'') AS pres_anio,
	dep.nom_ubig AS dpto,
	pro.nom_ubig AS prov,
	dis.nom_ubig AS dist,	
	i.t01_dire_inst, 
	i.t01_ciud_inst, 
	i.t01_fono_inst, 
	i.t01_fono2_inst,
	i.t01_rpm_inst,
	i.t01_next_inst,
	i.t01_rpc_inst,
	i.t01_fax_inst, 
	i.t01_mail_inst, 
	i.t01_web_inst, 
	i.t01_rel_fe,
	fn_tipo_inst_rel_fe(i.t01_rel_fe) AS tipo_rel_fe,
	fn_lista_representantes(i.t01_id_inst) AS represen,
	i.t01_carg_rep, 
	i.t01_tipo_inst,
	t.descrip AS tipo_inst,
	fn_nro_proy_en_ejecucion(i.t01_id_inst) AS nro_proy_eje,
	fn_nro_proy_en_monitoreo(i.t01_id_inst) AS nro_proy_mon,
	i.usr_crea, 
	i.fch_crea, 
	i.usr_actu, 
	i.fch_actu, 
	i.est_audi,
	(SELECT a.descrip FROM adm_tablas_aux a WHERE a.codi = dg.t02_sect_prod) as t02_sect_prod
   FROM t01_dir_inst i
   LEFT JOIN adm_tablas_aux t ON (i.t01_tipo_inst=t.codi)
	 LEFT JOIN t02_dg_proy dg on (dg.t01_id_inst = i.t01_id_inst)
   LEFT JOIN adm_ubigeo dep ON (i.t01_dpto=dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
   LEFT JOIN adm_ubigeo pro ON (i.t01_dpto=pro.cod_dpto AND i.t01_prov=pro.cod_prov AND pro.cod_dist='00')
   LEFT JOIN adm_ubigeo dis ON (i.t01_dpto=dis.cod_dpto AND i.t01_prov=dis.cod_prov AND i.t01_dist=dis.cod_dist)
   WHERE i.t01_sig_inst LIKE CONCAT('%',_filter,'%') 
		OR i.t01_nom_inst LIKE CONCAT('%',_filter,'%') 
		OR t.descrip LIKE CONCAT('%',_filter,'%') 
    ORDER BY t01_sig_inst ASC, nro_proy_mon ASC  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inst_ejecutoras` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inst_ejecutoras`(IN _concurso VARCHAR(10) , IN _region VARCHAR(10), IN _sector VARCHAR(10))
BEGIN
	SELECT 	i.t01_sig_inst, 
		cto.t01_id_inst, 
		i.t01_sig_inst,
		i.t01_nom_inst,
		i.t01_ruc_inst,
		NULL AS pro_moni,
		i.t01_dire_inst,
		ins.abrev AS institucion,
		NULL AS presupuesto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		p.t02_cod_proy,
		p.t02_nom_proy,
		FORMAT(fn_costos_total_proyecto(p.t02_cod_proy,1),2) AS presupuesto,
		cto.usr_crea,
		cto.t01_id_inst,
		cto.t01_id_cto,
		p.t02_moni_ext
	FROM 	t02_dg_proy p
	LEFT JOIN adm_concursos c ON (c.num_conc=SUBSTRING(p.t02_cod_proy,3,2))
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=p.t01_id_inst)	
	LEFT JOIN t01_inst_cto cto ON (CONCAT(cto.t01_id_inst,'.',cto.t01_id_cto)=p.t02_moni_ext)	
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)	
	LEFT JOIN adm_tablas_aux ins ON (i.t01_tipo_inst = ins.codi )
	WHERE p.t02_version = fn_ult_version_proy(p.t02_cod_proy) 
  AND c.num_conc <=> (CASE WHEN  _concurso = '*' THEN c.num_conc ELSE _concurso END)
  AND i.t01_dpto <=> ( CASE WHEN _region = '*' THEN  i.t01_dpto ELSE _region END)
  AND p.t02_sect_prod <=> (CASE WHEN _sector = '*' THEN p.t02_sect_prod ELSE _sector END)
	AND cto.t01_ape_pat <> ""
	ORDER BY i.t01_sig_inst, nombres  ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inst_monitoras` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inst_monitoras`()
BEGIN
	SELECT 	i.t01_sig_inst, 
		cto.t01_id_inst, 
		i.t01_sig_inst,
		i.t01_nom_inst,
		i.t01_ruc_inst,
		NULL AS pro_moni,
		i.t01_dire_inst,
		ins.abrev AS institucion,
		NULL AS presupuesto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		p.t02_cod_proy,
		p.t02_nom_proy,
		FORMAT(fn_costos_total_proyecto(p.t02_cod_proy,1),2) AS presupuesto,
		cto.usr_crea,
		cto.t01_id_inst,
		cto.t01_id_cto,
		p.t02_moni_ext
	FROM 	t02_dg_proy p
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=p.t01_id_inst)	
	LEFT JOIN t01_inst_cto cto ON (CONCAT(cto.t01_id_inst,'.',cto.t01_id_cto)=p.t02_moni_ext)	
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)	
	LEFT JOIN adm_tablas_aux ins ON (i.t01_tipo_inst = ins.codi )
	WHERE p.t02_version = fn_ult_version_proy(p.t02_cod_proy) 
	
	ORDER BY i.t01_sig_inst, nombres  ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inst_monitoras_monitor` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inst_monitoras_monitor`(IN _monitor INT)
BEGIN
	SELECT  i.t01_sig_inst,
		i.t01_id_inst,
		cto.t01_id_inst, 
		i.t01_sig_inst,
		i.t01_nom_inst,
		i.t01_ruc_inst,
		NULL AS pro_moni,
		i.t01_dire_inst,
		ins.abrev AS institucion,
		NULL AS presupuesto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		p.t02_cod_proy,
		p.t02_nom_proy,
		FORMAT(fn_costos_total_proyecto(p.t02_cod_proy,1),2) AS presupuesto,
		cto.usr_crea,
		cto.t01_id_inst,
		cto.t01_id_cto,
		p.t02_moni_ext
	FROM 	t01_dir_inst i
  
	 LEFT JOIN t01_inst_cto cto ON (cto.t01_id_inst = i.t01_id_inst)
  LEFT JOIN t02_dg_proy p ON (CONCAT(cto.t01_id_inst,'.',cto.t01_id_cto)=p.t02_moni_ext)	
 	
  
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)	
	LEFT JOIN adm_tablas_aux ins ON (i.t01_tipo_inst = ins.codi )
  WHERE p.t02_version = fn_ult_version_proy(p.t02_cod_proy)
	 AND p.t02_moni_fina = (CASE WHEN _monitor = '*' THEN p.t02_moni_fina ELSE _monitor END) 
   OR p.t02_moni_tema = (CASE WHEN _monitor = '*' THEN p.t02_moni_fina ELSE _monitor END) 
	 
  GROUP BY p.t02_cod_proy
	ORDER BY i.t01_id_inst, i.t01_sig_inst, nombres  ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inst_monitoras_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inst_monitoras_proy`(IN _concurso VARCHAR(10), IN _region VARCHAR(10), IN _sector VARCHAR(10))
BEGIN
	SELECT 	i.t01_sig_inst, 
		cto.t01_id_inst, 
		i.t01_sig_inst,
		i.t01_nom_inst,
		i.t01_ruc_inst,
		NULL AS pro_moni,
		i.t01_dire_inst,
		ins.abrev AS institucion,
		NULL AS presupuesto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		cto.t01_dni_cto AS dni,
		cto.t01_mail_cto AS mail,
		cto.t01_cel_cto AS celular,
		p.t02_cod_proy,
		p.t02_nom_proy,
		FORMAT(fn_costos_total_proyecto(p.t02_cod_proy,1),2) AS presupuesto,
		cto.usr_crea,
		cto.t01_id_inst,
		cto.t01_id_cto,
		p.t02_moni_ext
	FROM 	t02_dg_proy p
	LEFT JOIN adm_concursos c ON (c.num_conc=SUBSTRING(p.t02_cod_proy,3,2))
	LEFT JOIN t01_inst_cto cto ON (CONCAT(cto.t01_id_inst,'.',cto.t01_id_cto) = p.t02_moni_ext)	
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst = cto.t01_id_inst)	
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)	
	LEFT JOIN adm_tablas_aux ins ON (i.t01_tipo_inst = ins.codi )
	WHERE p.t02_version = fn_ult_version_proy(p.t02_cod_proy) 
	AND c.num_conc <=> (CASE WHEN  _concurso = '*' THEN c.num_conc ELSE _concurso END)
	AND i.t01_dpto <=> (CASE WHEN _region = '*' THEN  i.t01_dpto ELSE _region END)
	AND p.t02_sect_prod <=> (CASE WHEN _sector = '*' THEN p.t02_sect_prod ELSE _sector END)
	AND cto.t01_ape_pat <> ""
	
  
	
	GROUP BY p.t02_cod_proy
	ORDER BY i.t01_sig_inst, nombres  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_inst_proy_ctas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_inst_proy_ctas`(   IN _concurso VARCHAR(5),
				            IN _idinst  int ,
				            in _tip int
				         )
BEGIN
if _tip = 1 then 
SELECT  proy.codinst,
	proy.siglas,
	proy.nominst,
	count(proy.codigo) as nroproy
	
FROM  v_matriz_proyectos proy 
LEFT  JOIN v_cuentas_proy     cta  ON (proy.codigo = cta.t02_cod_proy AND cta.est_audi=1) 
WHERE proy.concurso = (CASE WHEN _concurso='*' THEN proy.concurso ELSE _concurso END ) 
  AND proy.codinst = (CASE WHEN _idinst<=0  THEN proy.codinst ELSE _idinst END ) 
group by proy.codinst, 	proy.siglas, proy.nominst
order by proy.siglas asc;
end if ;
IF _tip = 2 THEN 
SELECT  proy.concurso ,
	proy.codigo,
	proy.titulo,
	proy.siglas,
	(case when proy.inicio=0 then null else proy.inicio end ) as inicio,
	(CASE WHEN proy.termino=0 THEN NULL ELSE proy.termino END ) AS termino,
	proy.codinst,
	cta.t01_id_cta,
	cta.banco2 AS banco,
	cta.tcuenta,
	cta.moneda,
	cta.nrocuenta,
	cta.t02_nom_benef
FROM  v_matriz_proyectos proy 
LEFT  JOIN v_cuentas_proy     cta  ON (proy.codigo = cta.t02_cod_proy AND cta.est_audi=1) 
WHERE proy.concurso = (CASE WHEN _concurso='*' THEN proy.concurso ELSE _concurso END ) 
  AND proy.codinst = _idinst 
order by proy.codigo asc ;
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_matriz_monitoreo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_matriz_monitoreo`(IN _concurso VARCHAR(10), 
					    IN _region   INT,
					    IN _sector    INT,
					    IN _tipoinst INT,					    
					    IN _estado INT,
					    IN _proyecto VARCHAR(10),
					    IN _moni_exte VARCHAR(10))
BEGIN
IF _region <= 0 THEN
   SELECT 
	codigo, 
	v_matriz_proyectos.version,
	expediente, 
	codinst, 
	titulo, 
	inicio, 
	termino, 
	finalidad, 
	proposito, 
	siglas, 
	nominst, 
	ambito, 
	supervisor_inst, 
	estado,
	moni_tema,
	moni_fina,
	moni_exte,
	supe_inst,
	fn_miembro_equipo_x_cargo(codigo, 101) AS jefeproyecto,
	(SELECT COUNT(1) FROM t11_bco_bene WHERE t02_cod_proy = codigo) AS num_benef,
	beneficiarios,
	inf_planeados,
	(tot_planeados_fecha - (tot_planeados_fecha *(1/3) ) ) AS inf_planeados_fecha,
	(SELECT COUNT(DISTINCT CONCAT(inf.t20_anio, '.', inf.t20_mes)) FROM t20_inf_mes inf WHERE inf.t02_cod_proy = codigo) AS inf_entregados,
	(SELECT COUNT(DISTINCT CONCAT(inft.t25_anio, '.', inft.t25_trim)) FROM t25_inf_trim inft WHERE inft.t02_cod_proy = codigo) AS inf_tri_entregados,
	
	durameses AS inf_planeados_financ ,
	FLOOR(DATEDIFF(IF(CURDATE() > fecha_termino, fecha_termino, CURDATE()) , t02_fch_ini) /30) AS inf_planeados_fecha_financ,
	(SELECT COUNT(DISTINCT CONCAT(inf.t40_anio, '.', inf.t40_mes)) FROM t40_inf_financ inf WHERE inf.t02_cod_proy = codigo) AS inf_entregados_financ,
	
	direccion,
	ciudad,
	telefono,
	mail,
	presupuesto,
	cod_me,
	CONCAT(sector,' / ',IFNULL(subsector,'')) AS sectoresprod,
	tipoinst,
	codtipoinst , 
	codsector,
	concurso,
	cod_me,
	est,
	t02_fch_ini,
	fecha_termino
   FROM v_matriz_proyectos 
   WHERE concurso = (CASE WHEN _concurso = '*' THEN  concurso ELSE _concurso END)
     AND IFNULL(codsector,0) = (CASE WHEN _sector <=0 THEN IFNULL(codsector,0) ELSE _sector END)
     AND IFNULL(codtipoinst,0) = (CASE WHEN _tipoinst <=0 THEN IFNULL(codtipoinst,0) ELSE _tipoinst END)
     AND IFNULL(cod_me,'*') = (CASE WHEN _moni_exte ='*' THEN IFNULL(cod_me,'*') ELSE _moni_exte END)
     AND IFNULL(est,0) = (CASE WHEN _estado <=0 THEN IFNULL(est,0) ELSE _estado END)
     AND codigo = (CASE WHEN _proyecto ='' THEN codigo ELSE _proyecto END);
ELSE
    SELECT 
	codigo, 
	v_matriz_proyectos.version,
	expediente, 
	codinst, 
	titulo, 
	inicio, 
	termino, 
	finalidad, 
	proposito, 
	siglas, 
	nominst, 
	ambito, 
	supervisor_inst, 
	estado,
	moni_tema,
	moni_fina,
	moni_exte,
	supe_inst,
	fn_miembro_equipo_x_cargo(codigo, 101) AS jefeproyecto,
	(SELECT COUNT(1) FROM t11_bco_bene WHERE t02_cod_proy = codigo) AS num_benef,
	beneficiarios,
	inf_planeados,
	
	DATEDIFF(t02_fch_ini, IFNULL(fecha_termino, NOW())) AS inf_planeados_fecha,
	(SELECT COUNT(DISTINCT CONCAT(t20_anio,'.',t20_mes) ) FROM t20_inf_mes inf	WHERE inf.t02_cod_proy = codigo) AS inf_entregados,
	direccion,
	ciudad,
	telefono,
	mail,
	presupuesto,
	cod_me,
	CONCAT(sector,' / ',IFNULL(subsector,'')) AS sectoresprod,
	tipoinst,
	codtipoinst , 
	codsector,
	concurso,
	cod_me,
	est,
	t02_fch_ini,
	fecha_termino
   FROM v_matriz_proyectos 
   WHERE concurso = (CASE WHEN _concurso = '*' THEN  concurso ELSE _concurso END)
     AND IFNULL(codsector,0) = (CASE WHEN _sector <=0 THEN IFNULL(codsector,0) ELSE _sector END)
     AND IFNULL(codtipoinst,0) = (CASE WHEN _tipoinst <=0 THEN IFNULL(codtipoinst,0) ELSE _tipoinst END)
     AND codigo IN (SELECT DISTINCT t02_cod_proy FROM t03_dist_proy WHERE t03_dpto=_region)     
     AND IFNULL(cod_me,'*') = (CASE WHEN _moni_exte ='*' THEN IFNULL(cod_me,'*') ELSE _moni_exte END)
     AND IFNULL(est,0) = (CASE WHEN _estado <=0 THEN IFNULL(est,0) ELSE _estado END)     
     AND codigo = (CASE WHEN _proyecto ='' THEN codigo ELSE _proyecto END);  
     
END IF;
   
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_matriz_monitoreo_backup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_matriz_monitoreo_backup`(
					    in _concurso varchar(10), 
					    in _region   int,
					    in _sector    int,
					    in _tipoinst int
					  )
BEGIN
if _region <= 0 then
   SELECT 
	codigo, 
	v_matriz_proyectos.version,
	expediente, 
	codinst, 
	titulo, 
	inicio, 
	termino, 
	finalidad, 
	proposito, 
	siglas, 
	nominst, 
	ambito, 
	supervisor_inst, 
	estado,
	moni_tema,
	moni_fina,
	moni_exte,
	supe_inst,
	fn_miembro_equipo_x_cargo(codigo, 101) AS jefeproyecto,
	(SELECT COUNT(1) FROM t11_bco_bene WHERE t02_cod_proy = codigo) AS num_benef,
	beneficiarios,
	inf_planeados,
	(SELECT COUNT(DISTINCT t20_mes) FROM t20_inf_mes inf	WHERE inf.t02_cod_proy = codigo) AS inf_entregados,
	direccion,
	ciudad,
	telefono,
	mail,
	presupuesto,
	cod_me,
	concat(sector,' / ',ifnull(subsector,'')) as sectoresprod,
	tipoinst,
	codtipoinst , 
	codsector,
	concurso
   FROM v_matriz_proyectos 
   where concurso = (case when _concurso = '*' then  concurso else _concurso end)
     and ifnull(codsector,0) = (CASE WHEN _sector <=0 THEN ifnull(codsector,0) ELSE _sector END)
     and IFNULL(codtipoinst,0) = (CASE WHEN _tipoinst <=0 THEN IFNULL(codtipoinst,0) ELSE _tipoinst END);
else
    SELECT 
	codigo, 
	v_matriz_proyectos.version,
	expediente, 
	codinst, 
	titulo, 
	inicio, 
	termino, 
	finalidad, 
	proposito, 
	siglas, 
	nominst, 
	ambito, 
	supervisor_inst, 
	estado,
	moni_tema,
	moni_fina,
	moni_exte,
	supe_inst,
	fn_miembro_equipo_x_cargo(codigo, 101) AS jefeproyecto,
	(SELECT COUNT(1) FROM t11_bco_bene WHERE t02_cod_proy = codigo) AS num_benef,
	beneficiarios,
	inf_planeados,
	(SELECT COUNT(DISTINCT t20_mes) FROM t20_inf_mes inf	WHERE inf.t02_cod_proy = codigo) AS inf_entregados,
	direccion,
	ciudad,
	telefono,
	mail,
	presupuesto,
	cod_me,
	CONCAT(sector,' / ',IFNULL(subsector,'')) AS sectoresprod,
	tipoinst,
	codtipoinst , 
	codsector,
	concurso
   FROM v_matriz_proyectos 
   WHERE concurso = (CASE WHEN _concurso = '*' THEN  concurso ELSE _concurso END)
     AND IFNULL(codsector,0) = (CASE WHEN _sector <=0 THEN IFNULL(codsector,0) ELSE _sector END)
     AND IFNULL(codtipoinst,0) = (CASE WHEN _tipoinst <=0 THEN IFNULL(codtipoinst,0) ELSE _tipoinst END)
     and codigo in (select distinct t02_cod_proy from t03_dist_proy where t03_dpto=_region);
     
end if;
   
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_mf_inf_anexo_01` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_mf_inf_anexo_01`( 
						IN _proy VARCHAR(10) ,
						in _idInf int 
					      )
BEGIN
declare _anio int ;
declare _mes  int ;
declare _mes_ini int;
declare _mes_fin  int;
DECLARE _idfteFE int default 10;
declare _nummes int ;
declare _totalproy DOUBLE ;
DECLARE _linebase DOUBLE ;
declare _desembolsado DOUBLE ;
declare _saldo_desemb DOUBLE ;
SELECT 	t51_per_ini,  t51_per_fin   
  INTO  _mes_ini   ,  _mes_fin 
  FROM t51_inf_mf inf
 WHERE t02_cod_proy = _proy
   AND t51_num = _idInf ;
SET _totalproy = fn_total_aporte_fuentes_financ3(_proy,1,_idfteFE);
SET _linebase = fn_mp_linea_base(_proy,1);
select sum(d.t60_mto_des)
  into _desembolsado
  from t60_ejecucion_desemb d 
 where d.t02_cod_proy = _proy
   and d.t60_id_trim <= truncate((_mes_fin / 3),0)  ;
   
set _saldo_desemb = (( _totalproy - _linebase ) - _desembolsado) ;
DROP TEMPORARY TABLE IF EXISTS tmpInfMeses ;
DROP TEMPORARY TABLE IF EXISTS tmpInfMeses2 ;
CREATE TEMPORARY TABLE IF NOT EXISTS tmpInfMeses
SELECT 	'' as concepto,
	i.anio,
	i.mes, 
	i.nummes,
	i.trimestre,
	
	(SELECT IFNULL(SUM(dd.t60_mto_des) ,0)
	   FROM t60_ejecucion_desemb dd 
	  WHERE dd.t02_cod_proy = _proy 
	    AND DATE_FORMAT(dd.t60_fch_giro,'%Y%m') BETWEEN i.peri_real AND i.peri_real ) AS mto_tot_des,
	    
	fn_monto_total_desemb_plan_periodo_mes(i.proyecto, 1, 10, i.nummes, i.nummes) AS tot_mto_pre,
	i.monto_ejec AS gasto_ejecutado_sc,
	0 AS gasto_ejecutado_cc, 
	i.gasto_no_aceptado,
	i.otro_ing AS otros_ingresos,
	i.abon_bco AS abono_bancos
FROM 	( 
	SELECT  inf.t02_cod_proy AS proyecto,
		inf.t40_anio     AS anio, 
		inf.t40_mes      AS mes,
		fn_numero_mes(inf.t40_anio, inf.t40_mes) AS nummes,
		(CASE WHEN (fn_numero_mes(inf.t40_anio, inf.t40_mes) MOD 3)=0 THEN TRUNCATE(fn_numero_mes(inf.t40_anio, inf.t40_mes) / 3,0) ELSE TRUNCATE(fn_numero_mes(inf.t40_anio, inf.t40_mes) / 3,0) + 1 END) AS trimestre,
		(
		SELECT SUM(gas.t41_gasto) 
		     FROM  t41_inf_financ_gasto gas 
		     WHERE gas.t02_cod_proy= inf.t02_cod_proy
		       AND gas.t40_anio=inf.t40_anio
		       AND gas.t40_mes=inf.t40_mes
		) AS monto_ejec,
		IFNULL(inf.t40_abo_bco,0) AS abon_bco,
		IFNULL(inf.t40_otro_ing,0) AS otro_ing,
		(
		  SELECT sum(gna.t09_mto_no_acept)
		    from t51_inf_mf_gastos_no_aceptados gna
		   where gna.t02_cod_proy = _proy
		     and gna.t51_num      = _idInf
		     and gna.t09_anio     = inf.t40_anio
		     and gna.t09_mes      = inf.t40_mes
		     and gna.t51_fuente   = _idfteFE
		) as gasto_no_aceptado,
		DATE_FORMAT(DATE_ADD(proy.t02_fch_ini, INTERVAL fn_numero_mes(inf.t40_anio, inf.t40_mes)-1 MONTH), '%Y%m') AS peri_real
	FROM 	  t40_inf_financ  inf
	LEFT JOIN t02_dg_proy     proy ON (inf.t02_cod_proy = proy.t02_cod_proy AND proy.t02_version=fn_ult_version_proy(proy.t02_cod_proy))
	WHERE 	inf.t02_cod_proy = _proy
	  AND fn_numero_mes(inf.t40_anio, inf.t40_mes) BETWEEN _mes_ini and _mes_fin
	ORDER BY inf.t40_anio, inf.t40_mes, inf.t40_periodo
	) AS i ;
 
CREATE TEMPORARY TABLE IF NOT EXISTS tmpInfMeses2
SELECT  CONCAT('Mes de ', fn_nom_periodo(_proy, i.anio, i.mes) ) AS concepto,
	'mes' AS tipo,
	CONCAT(i.trimestre,'.', i.nummes ) AS orden,
	i.anio,
	i.mes, 
	i.nummes,
	i.trimestre,
	i.mto_tot_des,
	i.tot_mto_pre,
	i.gasto_ejecutado_sc,
	i.gasto_ejecutado_cc,
	i.gasto_no_aceptado,
	i.otros_ingresos,
	i.abono_bancos
FROM tmpInfMeses i ;
insert into tmpInfMeses2
select  concat('Trimestre ', gi.trimestre, ' \n(',fn_nom_periodo(_proy, max(gi.anio), MAX(gi.mes)-2),' - ', fn_nom_periodo(_proy, MAX(gi.anio), MAX(gi.mes)),')') AS concepto,
	'trim' as tipo,
	gi.trimestre as orden,
	max(gi.anio),
	max(gi.mes), 
	max(gi.nummes),
	gi.trimestre,
	sum(gi.mto_tot_des),
	sum(gi.tot_mto_pre),
	sum(gi.gasto_ejecutado_sc),
	sum(gi.gasto_ejecutado_cc),
	sum(gi.gasto_no_aceptado),
	sum(gi.otros_ingresos),
	sum(gi.abono_bancos)
from tmpInfMeses gi
group by gi.trimestre ;
insert into tmpInfMeses2(concepto, tipo, orden , mto_tot_des, tot_mto_pre , trimestre, nummes) values 
('MONTO TOTAL DEL PROYECTO ', 'a', 0, 0,_totalproy, 0, 0),
('Evaluación de Impacto  y Línea de Base (4%)', 'b', 0, 0, _linebase, 0, 0),
('Total a Transferir ', 'c', 0, 0, (_totalproy - _linebase), 0, 0),
('Monto Transferido ', 'd', 0, _desembolsado,0 , 0, 0),
('Saldo por Transferir ', 'e', 0, _saldo_desemb ,0 , 0, 0);
SELECT  i.concepto, 
	i.tipo,
	i.anio,
	i.mes, 
	i.nummes,
	i.trimestre,
	i.mto_tot_des,
	i.tot_mto_pre,
	i.gasto_ejecutado_sc,
	i.gasto_ejecutado_cc,
	i.gasto_no_aceptado,
	i.otros_ingresos,
	i.abono_bancos
  FROM tmpInfMeses2 i 
order by orden asc, tipo asc ; 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_mf_inf_anexo_01_det` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_mf_inf_anexo_01_det`( 
						IN _proy VARCHAR(10) ,
						IN _idInf INT 
					      )
BEGIN
SELECT 	fn_nom_periodo(gna.t02_cod_proy, gna.t09_anio, gna.t09_mes) as periodo,
	gna.t51_obs,
	gna.t09_mto_no_acept,
	concat(gna.t09_anio,'.',gna.t09_mes,'.',1) as orden,
	'detalle' as tipo
FROM t51_inf_mf_gastos_no_aceptados gna
WHERE gna.t02_cod_proy = _proy
AND gna.t51_num      = _idInf 
union all 
SELECT 	fn_nom_periodo(gna.t02_cod_proy, gna.t09_anio, gna.t09_mes) AS periodo,
	'' as obs,
	sum(gna.t09_mto_no_acept),
	CONCAT(gna.t09_anio,'.',gna.t09_mes) AS orden,
	'resumen' AS tipo
FROM t51_inf_mf_gastos_no_aceptados gna
WHERE gna.t02_cod_proy = _proy
AND gna.t51_num      = _idInf  
group by periodo, obs
order by orden ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_mf_inf_anexo_03` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_mf_inf_anexo_03`( 
						IN _proy VARCHAR(10) ,
						in _ifInf int ,
						in _idFteFinanc int
					      )
BEGIN
declare _nummes int ;
declare _anio INT ;
DECLARE _mes INT ;
DECLARE _mes_ini INT;
DECLARE _mes_fin  INT;
declare _version int default 1 ;
SELECT 	t51_per_ini,  t51_per_fin   
  INTO  _mes_ini   ,  _mes_fin 
  FROM t51_inf_mf inf
 WHERE t02_cod_proy = _proy
   AND t51_num = _ifInf ;
set _nummes=_mes_fin ;
set _anio  = fn_numero_mes_rev(_mes_fin ,1);
SET _mes  = fn_numero_mes_rev(_mes_fin ,2);
drop TEMPORARY table if EXISTS tmpRubros ;
DROP TEMPORARY TABLE IF EXISTS tmpReturn ;
create temporary table tmpRubros 
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(SUM(p.t10_cant * p.t10_cu) * s.t09_mta) AS total,
	(SUM( 
		fn_monto_total_planificado_fte(
						p.t02_cod_proy, 
						p.t02_version, 
						p.t08_cod_comp, 
						p.t09_cod_act, 
						p.t09_cod_sub, 
						p.t10_cod_cost, 
						_idFteFinanc 
						) 
		)
	 ) AS aporte_fe,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  =_version
GROUP BY 1,2,3 
UNION ALL 

SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo, 
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	(
	 SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.rubro      = (CASE WHEN vmp.subactividad IS NULL THEN vmp.codigo ELSE (vmp.cate_gasto - 80) END) 
			     AND fte.idinst = _idFteFinanc
	) AS aporte_fe,
	
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
 FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _version
  AND vmp.cate_gasto IS NOT NULL
  GROUP BY 1, 2, 3 ;
 
insert into  tmpRubros 
SELECT 	
	CONCAT(vmp.componente,'.',vmp.actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	vmp.um AS um,
	vmp.gasto AS parcial,
	vmp.meta AS meta,
	vmp.gasto * vmp.meta  AS total,
	(
	 SELECT SUM(fte.aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     IS NULL
			     AND fte.rubro      IS NULL
			     AND fte.idinst 	= _idFteFinanc
	) AS aporte_fe,
	CONCAT(80 + vmp.componente,'.',vmp.actividad) AS codigo_real
 FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _version
  AND vmp.cate_gasto IS NULL AND vmp.codsub IS NULL ;
 
alter  table tmpRubros 
   ADD COLUMN gasto_acum DOUBLE NULL AFTER codigo_real, 
   add column m1 double NULL after gasto_acum, 
   add column m2 double NULL after m1, 
   add column m3 double NULL after m2,
   ADD COLUMN t1 DOUBLE NULL AFTER m3,
   ADD COLUMN m4 DOUBLE NULL AFTER t1,
   ADD COLUMN m5 DOUBLE NULL AFTER m4,
   ADD COLUMN m6 DOUBLE NULL AFTER m5,
   ADD COLUMN t2 DOUBLE NULL AFTER m6,
   ADD COLUMN m7 DOUBLE NULL AFTER t2,
   ADD COLUMN m8 DOUBLE NULL AFTER m7,
   ADD COLUMN m9 DOUBLE NULL AFTER m8,
   ADD COLUMN t3 DOUBLE NULL AFTER m9,
   ADD COLUMN m10 DOUBLE NULL AFTER t3,
   ADD COLUMN m11 DOUBLE NULL AFTER m10,
   ADD COLUMN m12 DOUBLE NULL AFTER m11,
   ADD COLUMN t4 DOUBLE NULL AFTER m12,
   ADD COLUMN tot_pre_ejec DOUBLE NULL AFTER t4,
   ADD COLUMN porc_ejec DOUBLE NULL AFTER tot_pre_ejec,
   ADD COLUMN pre_x_ejec DOUBLE NULL AFTER porc_ejec ;
update tmpRubros 
   set gasto_acum = ( SELECT ifnull(SUM(gas.t41_gasto),0) 
		        FROM  t41_inf_financ_gasto gas 
		       WHERE gas.t02_cod_proy = _proy
		         AND concat(gas.t08_cod_comp,'.', gas.t09_cod_act, '.', gas.t09_cod_sub, '.' ,gas.t41_cate_gasto) = tmpRubros.codigo
		         AND gas.t41_fte_finan = _idFteFinanc
		         AND fn_numero_mes( gas.t40_anio, gas.t40_anio) < _mes_ini
		     );
		     
UPDATE tmpRubros AS r
LEFT JOIN ( 	SELECT 	
			( CASE WHEN (gas.t09_cod_sub=0 AND gas.t41_cate_gasto=0 )
			    THEN CONCAT(gas.t08_cod_comp,'.', gas.t09_cod_act) 
			    ELSE CONCAT(gas.t08_cod_comp,'.', gas.t09_cod_act, '.', gas.t09_cod_sub, '.' ,gas.t41_cate_gasto) 
			  END ) AS codigo,
			SUM(CASE WHEN gas.t40_mes = 1 THEN gas.t41_gasto ELSE 0 END ) AS m1,
			SUM(CASE WHEN gas.t40_mes = 2 THEN gas.t41_gasto ELSE 0 END ) AS m2,
			SUM(CASE WHEN gas.t40_mes = 3 THEN gas.t41_gasto ELSE 0 END ) AS m3,
			SUM(CASE WHEN gas.t40_mes = 4 THEN gas.t41_gasto ELSE 0 END ) AS m4,
			SUM(CASE WHEN gas.t40_mes = 5 THEN gas.t41_gasto ELSE 0 END ) AS m5,
			SUM(CASE WHEN gas.t40_mes = 6 THEN gas.t41_gasto ELSE 0 END ) AS m6,
			SUM(CASE WHEN gas.t40_mes = 7 THEN gas.t41_gasto ELSE 0 END ) AS m7,
			SUM(CASE WHEN gas.t40_mes = 8 THEN gas.t41_gasto ELSE 0 END ) AS m8,
			SUM(CASE WHEN gas.t40_mes = 9 THEN gas.t41_gasto ELSE 0 END ) AS m9,
			SUM(CASE WHEN gas.t40_mes = 10 THEN gas.t41_gasto ELSE 0 END ) AS m10,
			SUM(CASE WHEN gas.t40_mes = 11 THEN gas.t41_gasto ELSE 0 END ) AS m11,
			SUM(CASE WHEN gas.t40_mes = 12 THEN gas.t41_gasto ELSE 0 END ) AS m12
		  FROM  t41_inf_financ_gasto gas 
		 WHERE gas.t02_cod_proy = _proy
		   AND gas.t41_fte_finan = _idFteFinanc
		   AND  fn_numero_mes( gas.t40_anio, gas.t40_anio) BETWEEN _mes_ini AND _mes_fin
		GROUP BY codigo 
	    ) AS w ON (r.codigo = w.codigo) 
SET	r.m1 = w.m1,
	r.m2 = w.m2,
	r.m3 = w.m3,
	r.m4 = w.m4,
	r.m5 = w.m5,
	r.m6 = w.m6,
	r.m7 = w.m7,
	r.m8 = w.m8,
	r.m9 = w.m9,
	r.m10 = w.m10,
	r.m11 = w.m11,
	r.m12 = w.m12,
	r.t1 = (w.m1 + w.m2 + w.m3),
	r.t2 = (w.m4 + w.m5 + w.m6),
	r.t3 = (w.m7 + w.m8 + w.m9),
	r.t4 = (w.m10 + w.m11 + w.m12) 	;
	
UPDATE tmpRubros set tot_pre_ejec = gasto_acum + (t1 + t2 + t3 + t4) ;
UPDATE tmpRubros 
  SET porc_ejec = ( IFNULL(tot_pre_ejec,0) * 100 / aporte_fe),
      pre_x_ejec = ( aporte_fe - IFNULL(tot_pre_ejec,0)) ;
create temporary table tmpReturn 
SELECT 	sub.codigo	,
	sub.descripcion	,
	sub.um	,
	sum(s.parcial) as parcial	,
	sub.meta	,
	sum(s.total) as total	,
	sum(s.aporte_fe) as aporte_fe	,
	SUBSTRING_INDEX(s.codigo_real,'.',3) AS codigo_real	,
	'subactividad' AS tipo,
	SUM(s.gasto_acum) AS gasto_acum	,
	SUM(s.m1) AS m1	,
	SUM(s.m2) AS m2	,
	SUM(s.m3) AS m3	,
	SUM(s.t1) AS t1	,
	
	SUM(s.m4) AS m4	,
	SUM(s.m5) AS m5	,
	SUM(s.m6) AS m6	,
	SUM(s.t2) AS t2	,
	
	SUM(s.m7) AS m7	,
	SUM(s.m8) AS m8	,
	SUM(s.m9) AS m9	,
	SUM(s.t3) AS t3	,
	
	SUM(s.m10) AS m10	,
	SUM(s.m11) AS m11	,
	SUM(s.m12) AS m12	,
	SUM(s.t4) AS t4	,
	SUM(s.tot_pre_ejec) AS tot_pre_ejec	,
	SUM(s.porc_ejec) AS porc_ejec	,
	SUM(s.pre_x_ejec) AS pre_x_ejec	
FROM tmpRubros s 
inner JOIN v_subactividades sub ON (sub.t02_cod_proy=_proy and sub.t02_version=1 AND SUBSTRING_INDEX(s.codigo,'.',3)=sub.codigo )
GROUP BY 1,2,3,5,8,9 ;
INSERT INTO tmpReturn
SELECT 	act.codigo	,
	act.descripcion	,
	null as 'um'	,
	SUM(s.parcial) AS parcial	,
	null as 'meta'	,
	SUM(s.total) AS total	,
	SUM(s.aporte_fe) AS aporte_fe	,
	SUBSTRING_INDEX(s.codigo_real,'.',2) AS codigo_real	,
	'actividad' AS tipo,
	SUM(s.gasto_acum) AS gasto_acum	,
	SUM(s.m1) AS m1	,
	SUM(s.m2) AS m2	,
	SUM(s.m3) AS m3	,
	SUM(s.t1) AS t1	,
	SUM(s.m4) AS m4	,
	SUM(s.m5) AS m5	,
	SUM(s.m6) AS m6	,
	SUM(s.t2) AS t2	,
	SUM(s.m7) AS m7	,
	SUM(s.m8) AS m8	,
	SUM(s.m9) AS m9	,
	SUM(s.t3) AS t3	,
	SUM(s.m10) AS m10	,
	SUM(s.m11) AS m11	,
	SUM(s.m12) AS m12	,
	SUM(s.t4) AS t4	,
	SUM(s.tot_pre_ejec) AS tot_pre_ejec	,
	SUM(s.porc_ejec) AS porc_ejec	,
	SUM(s.pre_x_ejec) AS pre_x_ejec	
FROM tmpRubros s 
INNER JOIN v_actividades act ON (act.t02_cod_proy=_proy AND act.t02_version=1 AND SUBSTRING_INDEX(s.codigo,'.',2)=act.codigo )
GROUP BY 1,2,3,5,8,9 ;
INSERT INTO tmpReturn
SELECT 	comp.codigo	,
	comp.descripcion	,
	NULL AS 'um'	,
	SUM(c.parcial) AS parcial	,
	NULL AS 'meta'	,
	SUM(c.total) AS total	,
	SUM(c.aporte_fe) AS aporte_fe	,
	SUBSTRING_INDEX(c.codigo_real,'.',1) AS codigo_real	,
	'componente' AS tipo,
	SUM(c.gasto_acum) AS gasto_acum	,
	SUM(c.m1) AS m1	,
	SUM(c.m2) AS m2	,
	SUM(c.m3) AS m3	,
	SUM(c.t1) AS t1	,
	SUM(c.m4) AS m4	,
	SUM(c.m5) AS m5	,
	SUM(c.m6) AS m6	,
	SUM(c.t2) AS t2	,
	SUM(c.m7) AS m7	,
	SUM(c.m8) AS m8	,
	SUM(c.m9) AS m9	,
	SUM(c.t3) AS t3	,
	SUM(c.m10) AS m10	,
	SUM(c.m11) AS m11	,
	SUM(c.m12) AS m12	,
	SUM(c.t4) AS t4	,
	SUM(c.tot_pre_ejec) AS tot_pre_ejec	,
	SUM(c.porc_ejec) AS porc_ejec	,
	SUM(c.pre_x_ejec) AS pre_x_ejec	
FROM tmpRubros c
INNER JOIN v_componentes comp ON (comp.t02_cod_proy=_proy AND comp.t02_version=1 AND SUBSTRING_INDEX(c.codigo,'.',1)=comp.codigo )
GROUP BY 1,2,3,5,8,9 ;
insert into tmpReturn
SELECT 	r.codigo	,
	r.descripcion	,
	r.um	,
	r.parcial	,
	r.meta	,
	r.total	,
	r.aporte_fe	,
	r.codigo_real	,
	'rubro' as tipo,
	r.gasto_acum	,
	r.m1	,
	r.m2	,
	r.m3	,
	r.t1	,
	r.m4	,
	r.m5	,
	r.m6	,
	r.t2	,
	r.m7	,
	r.m8	,
	r.m9	,
	r.t3	,
	r.m10	,
	r.m11	,
	r.m12	,
	r.t4	,
	r.tot_pre_ejec	,
	r.porc_ejec	,
	r.pre_x_ejec	
from tmpRubros r 
WHERE r.codigo < 10.4 ;
UPDATE tmpReturn 
  SET porc_ejec = (IFNULL(tot_pre_ejec,0) * 100 / aporte_fe) ;
drop TEMPORARY table tmpRubros ;
select * from tmpReturn order by codigo_real asc ; 
DROP TEMPORARY TABLE tmpReturn ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_nroproy_mont_estejec` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_nroproy_mont_estejec`()
BEGIN
	SELECT 	conc.num_conc AS concurso,
			dep.nom_ubig AS region, 
			est.descrip AS estado,
			SUM(fn_costos_total_proyecto(proy.t02_cod_proy, proy.t02_version)) AS presupuesto , 
			COUNT(proy.t02_estado) AS nro_proy
	FROM 		adm_concursos 	conc
	JOIN		t02_dg_proy		proy ON (conc.num_conc = SUBSTRING(proy.t02_cod_proy, 3, 2))
	LEFT JOIN 	(SELECT t02_cod_proy, t02_version, t03_dpto 
				 FROM t03_dist_proy 
				 GROUP BY t02_cod_proy, t02_version) dp ON (dp.t02_cod_proy = proy.t02_cod_proy AND dp.t02_version = proy.t02_version)
	LEFT JOIN	adm_ubigeo		dep  ON (dp.t03_dpto = dep.cod_dpto AND dep.cod_prov = '00' AND dep.cod_dist = '00')
	LEFT JOIN	adm_tablas_aux	est	 ON (proy.t02_estado = est.codi)
	WHERE	proy.t02_version = fn_pri_version_proy(proy.t02_cod_proy)
	GROUP BY conc.num_conc, dep.nom_ubig, proy.t02_estado
	ORDER BY concurso, -region DESC, region, estado;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_nroproy_region` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_nroproy_region`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN
	SELECT 	dep.nom_ubig AS region, 
			COUNT(DISTINCT p.t02_cod_proy) AS cantidad,
			SUM(fn_costo_presupuesto_fe(p.t02_cod_proy, p.t02_version)) AS FE, 
			SUM(fn_costo_presupuesto_otros(p.t02_cod_proy, p.t02_version)) AS OTROS
	FROM		t02_dg_proy 	p
	LEFT JOIN	(SELECT t02_cod_proy, t03_dpto 
				FROM t03_dist_proy 
				WHERE t02_version = fn_pri_version_proy(t02_cod_proy)
				GROUP BY t02_cod_proy)	dp	ON (p.t02_cod_proy = dp.t02_cod_proy)
	LEFT JOIN	adm_ubigeo 		dep ON (dp.t03_dpto = dep.cod_dpto AND dep.cod_prov = '00' AND dep.cod_dist = '00')
	WHERE		p.t02_version = fn_pri_version_proy(p.t02_cod_proy) 
		AND 	SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END )
		AND 	p.t02_estado = (CASE WHEN _estado='*' THEN p.t02_estado ELSE _estado END )   
	GROUP BY dep.nom_ubig
	ORDER BY -region DESC, region;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_nroproy_region_act_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_nroproy_region_act_inst`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN
	SELECT 	dep.nom_ubig AS region, 
			act.descrip AS actividad,
			IFNULL(tinst.abrev, '--') AS tipoinst,
			COUNT(DISTINCT proy.t02_cod_proy) AS cantidad,
			SUM(fn_costo_presupuesto_fe(proy.t02_cod_proy, proy.t02_version)) AS FE,
			SUM(fn_costo_presupuesto_otros(proy.t02_cod_proy, proy.t02_version)) AS otros,
			SUM(IFNULL((proy.t02_pres_fe + proy.t02_pres_otro), '0')) AS total,
			inst.t01_tipo_inst
	FROM		t01_dir_inst	inst
	JOIN		t02_dg_proy		proy	ON (inst.t01_id_inst = proy.t01_id_inst)
	LEFT JOIN	(SELECT t02_cod_proy, t03_dpto 
				FROM t03_dist_proy 
				WHERE t02_version = fn_pri_version_proy(t02_cod_proy)
				GROUP BY t02_cod_proy)	dp	ON (proy.t02_cod_proy = dp.t02_cod_proy)
	LEFT JOIN	adm_ubigeo		dep		ON (dp.t03_dpto = dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
	LEFT JOIN	adm_tablas_aux 	tinst	ON (tinst.codi = inst.t01_tipo_inst)
	LEFT JOIN	adm_tablas_aux	act		ON (act.codi = proy.t02_sect_prod)
	WHERE	proy.t02_version = fn_pri_version_proy(proy.t02_cod_proy) 
		AND SUBSTR(proy.t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(proy.t02_cod_proy,3,2) ELSE _concurso END )
		AND proy.t02_estado = (CASE WHEN _estado='*' THEN proy.t02_estado ELSE _estado END )
	GROUP BY dep.nom_ubig, proy.t02_sect_prod, tipoinst
	ORDER BY -region DESC, region, -actividad DESC, actividad, tipoinst ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_nroproy_region_alt` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_nroproy_region_alt`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN
	SELECT 	dep.nom_ubig AS region, 
			COUNT(DISTINCT proy.t02_cod_proy) AS cantidad,
			tinst.abrev AS tipoinst,
			SUM(fn_costo_presupuesto_fe(proy.t02_cod_proy, proy.t02_version)) AS FE,
			SUM(fn_costo_presupuesto_otros(proy.t02_cod_proy, proy.t02_version)) AS otros,
			SUM(fn_costos_total_proyecto(proy.t02_cod_proy, proy.t02_version)) AS total,
			inst.t01_tipo_inst
	FROM 			t01_dir_inst	inst
	JOIN		t02_dg_proy		proy	ON (inst.t01_id_inst = proy.t01_id_inst)
	LEFT JOIN	(SELECT t02_cod_proy, t03_dpto 
				FROM t03_dist_proy 
				WHERE t02_version = fn_pri_version_proy(t02_cod_proy)
				GROUP BY t02_cod_proy)	dp	ON (proy.t02_cod_proy = dp.t02_cod_proy)
	LEFT JOIN	adm_tablas_aux 	tinst	ON (tinst.codi = inst.t01_tipo_inst)
	LEFT JOIN	adm_ubigeo		dep		ON (dp.t03_dpto = dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
	WHERE	proy.t02_version = fn_pri_version_proy(proy.t02_cod_proy) 
		AND SUBSTR(proy.t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(proy.t02_cod_proy,3,2) ELSE _concurso END )
		AND proy.t02_estado = (CASE WHEN _estado='*' THEN proy.t02_estado ELSE _estado END ) 
	GROUP BY region, tipoinst
	ORDER BY -region DESC, region, -tipoinst DESC, tipoinst ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_nroproy_region_c` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_nroproy_region_c`(IN _concurso  VARCHAR(10), IN _codto INT)
BEGIN
	
SELECT 	nom_ubig AS region, 
	COUNT(DISTINCT t02_dg_proy.t02_cod_proy) AS cantidad
	FROM
	    t03_dist_proy 
	    INNER JOIN t02_dg_proy 
		ON (t02_dg_proy.t02_cod_proy = t03_dist_proy.t02_cod_proy)
	    INNER JOIN adm_ubigeo dep ON (dep.cod_dpto = _codto AND dep.cod_prov='00' AND dep.cod_dist='00')
	   
		WHERE  t02_dg_proy.t02_version=fn_ult_version_proy(t02_dg_proy.t02_cod_proy) 
		AND 	SUBSTR(t02_dg_proy.t02_cod_proy,3,2) = _concurso
		AND t03_dist_proy.t03_dpto = _codto 
	GROUP BY dep.nom_ubig
	ORDER BY 2 DESC ;
	
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_poa_presupuesto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_poa_presupuesto`( IN _proy VARCHAR(10), in _anio int )
BEGIN
	SELECT 	t41_fte_finan,
			SUM(t41_gasto) AS total	 
	FROM	t40_inf_financ a
	JOIN 	t41_inf_financ_gasto b ON (a.t02_cod_proy = b.t02_cod_proy AND a.t40_anio = b.t40_anio AND a.t40_mes = b.t40_mes) 
	WHERE	a.t02_cod_proy = _proy and a.t40_anio = _anio
	GROUP BY t41_fte_finan;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_poa_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_poa_subact`(IN _proy VARCHAR(10), IN _vs INT, IN _comp INT, IN _act INT)
BEGIN
  DECLARE _anios INT;
  DECLARE _sql TEXT ;
  DECLARE _meses VARCHAR(3000);
  DECLARE _a INT DEFAULT 1 ;
  DECLARE _from VARCHAR(800) ;
  
  SELECT fn_duracion_proy(_proy,_vs) INTO _anios;
  
  SELECT '
  SELECT
  sub.t02_cod_proy, 
  sub.t02_version , 
  sub.t08_cod_comp,  
  sub.t09_cod_act ,
  sub.t09_cod_sub ,  
  sub.t09_sub	  , 
  sub.t09_um	  , 
  sub.t09_mta	  ,  
  IF(sub.t02_version > 1,
			 IF(sub.t09_cod_sub IN (
					SELECT s.t09_cod_sub		 
					FROM t09_subact	s
					WHERE  s.t02_cod_proy = ''@proy''
					  AND  s.t02_version  = ''1''
					  AND  s.t08_cod_comp = ''@comp''
					  AND  s.t09_cod_act  = ''@act''
					),'''', ''1'')		  
	   ,'''') AS act_add		  
	   
  ' INTO _sql;
 
   
  SELECT ' 
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=1 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_1,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=2 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_2,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=3 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_3,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=4 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_4,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=5 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_5,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=6 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_6,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=7 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_7,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=8 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_8,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=9 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_9,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=10 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_10,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=11 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_11,
  SUM(CASE WHEN mta.t09_anio=@anio AND mta.t09_mes=12 THEN mta.t09_mta ELSE NULL END) AS mes_@anio_12,
  SUM(CASE WHEN mta.t09_anio=@anio THEN mta.t09_mta ELSE NULL END) AS mta_@anio
  '  INTO _meses;
  
  WHILE _a <= _anios DO
    SET _sql = CONCAT(_sql, ', ', REPLACE(_meses,'@anio', _a)) ;
    SET _a = _a + 1;
  END WHILE;
  
  SELECT ' FROM        t09_subact sub
	   LEFT JOIN   t09_sub_act_mtas mta ON (sub.t02_cod_proy = mta.t02_cod_proy AND sub.t02_version = mta.t02_version AND sub.t08_cod_comp = mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub = mta.t09_cod_sub)
	   WHERE  sub.t02_cod_proy = ''@proy'' 
	     AND  sub.t02_version = ''@vs'' 
	     AND  sub.t08_cod_comp = ''@comp''
	     AND  sub.t09_cod_act= ''@act''
	   GROUP BY 1,2,3,4,5,6,7,8 ;
	' INTO _from;
  
 
   SET _sql = REPLACE(_sql,'@proy', _proy);
   SET _sql = REPLACE(_sql,'@comp', _comp);
   SET _sql = REPLACE(_sql,'@act' , _act);
 
   
   SET _from = REPLACE(_from,'@proy', _proy);
   SET _from = REPLACE(_from,'@vs'  , _vs  );
   SET _from = REPLACE(_from,'@comp', _comp);
   SET _from = REPLACE(_from,'@act' , _act);
   SELECT CONCAT(_sql,_from) INTO @txtsql;
   PREPARE stmt FROM @txtsql;
   EXECUTE stmt;
   DEALLOCATE PREPARE stmt; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_presup_analitico` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_presup_analitico`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
DECLARE _sql      LONGTEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;

DECLARE _temp_comp_ope VARCHAR(500);
DECLARE _temp_act_ope  VARCHAR(500);
DECLARE _temp_sub_ope  VARCHAR(500);
DECLARE _temp_cat_ope  VARCHAR(700);
DECLARE _fte_comp_ope TEXT DEFAULT '';
DECLARE _fte_act_ope  TEXT DEFAULT '';
DECLARE _fte_sub_ope  TEXT DEFAULT '';
DECLARE _fte_cat_ope  TEXT DEFAULT '';

DECLARE _temp_comp_mp VARCHAR(500);
DECLARE _temp_act_mp  VARCHAR(500);
DECLARE _temp_sub_mp  VARCHAR(500);
DECLARE _temp_cat_mp  VARCHAR(700);
DECLARE _fte_comp_mp TEXT DEFAULT '';
DECLARE _fte_act_mp  TEXT DEFAULT '';
DECLARE _fte_sub_mp  TEXT DEFAULT '';
DECLARE _fte_cat_mp  TEXT DEFAULT '';

DROP TEMPORARY TABLE IF EXISTS tmpFuentes;
CREATE TEMPORARY TABLE tmpFuentes 
( id INT AUTO_INCREMENT,
  idfte INT,
  nomfte VARCHAR(250),
  PRIMARY KEY (id)
) ;
INSERT INTO tmpFuentes(idfte, nomfte)
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
inner JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  AND f.t01_id_inst = _codFE
UNION ALL
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
inner JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  AND f.t01_id_inst <> _codFE ;
  

SET _temp_comp_ope= "(SELECT 	SUM(fte.t10_mont)
		       FROM 	t10_cost_fte fte
		      WHERE fte.t02_cod_proy = c.t02_cod_proy
		        AND fte.t02_version  = c.t02_version
		        AND fte.t08_cod_comp = c.t08_cod_comp
		        AND fte.t01_id_inst  = _idfte
		     ) AS '_nomfte' " ;
SET _temp_act_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = a.t02_cod_proy
			    AND fte.t02_version  = a.t02_version
			    AND fte.t08_cod_comp = a.t08_cod_comp
			    AND fte.t09_cod_act  = a.t09_cod_act
			    AND fte.t01_id_inst  = _idfte
			)  AS '_nomfte' " ;
			
SET _temp_sub_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND fte.t01_id_inst  = _idfte
			 ) AS '_nomfte' " ;
			 
SET _temp_cat_ope = "  ( SELECT  SUM(fte.t10_mont)
			   FROM     t10_cost_fte fte
			 INNER JOIN t10_cost_sub cost ON ( fte.t02_cod_proy = cost.t02_cod_proy AND fte.t02_version  = cost.t02_version AND fte.t08_cod_comp = cost.t08_cod_comp AND fte.t09_cod_act  = cost.t09_cod_act AND fte.t09_cod_sub  = cost.t09_cod_sub AND fte.t10_cod_cost = cost.t10_cod_cost )
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND cost.t10_cate_cost = p.t10_cate_cost
			    AND fte.t01_id_inst  = _idfte
			 )  AS '_nomfte' " ;

SET _temp_comp_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_act_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_sub_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
		       
SET _temp_cat_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.rubro      = (CASE WHEN vmp.subactividad IS NULL THEN vmp.codigo ELSE (vmp.cate_gasto - 80) END) 
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SELECT 1 INTO _contador ;  
WHILE (SELECT COUNT(1) FROM  tmpFuentes) >= _contador DO
	SELECT idfte  ,  nomfte
	INTO   _codfte, _nomfte 
	FROM tmpFuentes 
	WHERE id = _contador;
	
	SET _fte_comp_ope = CONCAT(_fte_comp_ope, ',' , REPLACE(REPLACE(_temp_comp_ope,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_ope  = CONCAT(_fte_act_ope , ',' , REPLACE(REPLACE(_temp_act_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_ope  = CONCAT(_fte_sub_ope , ',' , REPLACE(REPLACE(_temp_sub_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_ope  = CONCAT(_fte_cat_ope , ',' , REPLACE(REPLACE(_temp_cat_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _fte_comp_mp = CONCAT(_fte_comp_mp, ',' , REPLACE(REPLACE(_temp_comp_mp,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_mp  = CONCAT(_fte_act_mp , ',' , REPLACE(REPLACE(_temp_act_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_mp  = CONCAT(_fte_sub_mp , ',' , REPLACE(REPLACE(_temp_sub_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_mp  = CONCAT(_fte_cat_mp , ',' , REPLACE(REPLACE(_temp_cat_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _contador = _contador + 1;
END WHILE;
DROP TEMPORARY TABLE tmpFuentes; 
SET _sql = "
SELECT 	c.t08_cod_comp AS codigo, 
	TRIM(c.t08_comp_desc) AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	( SELECT SUM( ROUND( ((cost.t10_cant * cost.t10_cu) * sub.t09_mta),2) )
	    FROM       t10_cost_sub cost
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=c.t02_cod_proy 
	     AND cost.t02_version =c.t02_version 
	     AND cost.t08_cod_comp=c.t08_cod_comp
	) AS total,
	'componente' AS tipo,
	' ' AS act_add,
	c.t08_cod_comp AS codigo_real
	[_fte_comp_ope]
FROM  t08_comp c
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo, 
	TRIM(a.t09_act) AS descripcion,
	NULL AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS parcial,
	NULL AS meta,
	( SELECT SUM(  ROUND( ((cost.t10_cant * cost.t10_cu) * sub.t09_mta),2)    )
	    FROM       t10_cost_sub cost 
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS total,
	'actividad' AS tipo,
	' ' AS act_add,
	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo_real
	[_fte_act_ope]
FROM  t09_act a
WHERE a.t02_cod_proy = _proy
  AND a.t02_version  = _ver
  
UNION ALL
SELECT 	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo, 
	TRIM(s.t09_sub) AS descripcion,
	s.t09_um AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) AS parcial,
	s.t09_mta AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) * s.t09_mta) AS total,
	'subactividad' AS tipo,
	IF(s.t02_version > 1,
			 IF(s.t09_cod_sub IN (
					SELECT suba.t09_cod_sub	AS subact		 
					FROM t09_subact suba
					WHERE  suba.t02_cod_proy = _proy
					  AND  suba.t08_cod_comp = s.t08_cod_comp 
					  AND  suba.t09_cod_act  = s.t09_cod_act
						AND  suba.t02_version  = 1
					  GROUP BY 1
					  ORDER BY subact
						),'','1')		  
	   ,'') AS act_add	,
	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo_real
	[_fte_sub_ope]
FROM  t09_subact s
WHERE s.t02_cod_proy = _proy 
  AND s.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost 
	   WHERE cost.t02_cod_proy=p.t02_cod_proy 
	     AND cost.t02_version =p.t02_version 
	     AND cost.t08_cod_comp=p.t08_cod_comp
	     AND cost.t09_cod_act =p.t09_cod_act
	     AND cost.t09_cod_sub =p.t09_cod_sub
	     AND cost.t10_cate_cost=t.codi
	) * s.t09_mta) AS total,
	'rubro' AS tipo,
	' ' AS act_add,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
	[_fte_cat_ope]
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  = _ver
GROUP BY 1,2,3 
UNION ALL
 
SELECT 	vmp.componente AS codigo, 
	'Manejo del Proyecto' AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	SUM(ROUND((vmp.gasto * vmp.meta),2)) AS total,
	'componente' AS tipo,
	' ' AS act_add,
	CONCAT(80 + vmp.componente) AS codigo_real
	[_fte_comp_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver 
  GROUP BY 1,2,3,4,5
UNION ALL
SELECT 	CONCAT(componente,'.',actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	NULL AS um,
	SUM(vmp.gasto) parcial,
	NULL AS meta,
	SUM(ROUND((vmp.gasto * vmp.meta),2)) AS total,
	'actividad' AS tipo,
	' ' AS act_add,
	CONCAT(80 + componente,'.',actividad) AS codigo_real
	[_fte_act_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
 GROUP BY 1,2,3
UNION ALL
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nom_cate_gasto
	 ELSE
	      vmp.subactividad
	 END 
	) AS descripcion,
	vmp.um AS um,
	SUM(vmp.gasto) parcial,
	vmp.meta AS meta,
	SUM(ROUND((vmp.gasto * vmp.meta),2)) AS total,
	'subactividad' AS tipo,
	'' AS act_add,
	
	CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo_real
	[_fte_sub_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.codsub is not null
 GROUP BY 1,2
UNION ALL
SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo,
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(ROUND((vmp.gasto * vmp.meta),2)) AS total,
	'rubro' AS tipo,
	' ' AS act_add,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
	[_fte_cat_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.cate_gasto is not null
  GROUP BY 1, 2, 3 
  
ORDER BY codigo_real ; " ; 
  
 
SET _sql = REPLACE(_sql,' _proy', CONCAT(" '",_proy,"'"));
SET _sql = REPLACE(_sql,' _ver', _ver);
SET _sql = REPLACE(_sql,'[_fte_comp_ope]', _fte_comp_ope);
SET _sql = REPLACE(_sql,'[_fte_act_ope]' , _fte_act_ope );
SET _sql = REPLACE(_sql,'[_fte_sub_ope]' , _fte_sub_ope );
SET _sql = REPLACE(_sql,'[_fte_cat_ope]' , _fte_cat_ope );
SET _sql = REPLACE(_sql,'[_fte_comp_mp]', _fte_comp_mp);
SET _sql = REPLACE(_sql,'[_fte_act_mp]' , _fte_act_mp );
SET _sql = REPLACE(_sql,'[_fte_sub_mp]' , _fte_sub_mp );
SET _sql = REPLACE(_sql,'[_fte_cat_mp]' , _fte_cat_mp );
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_presup_analitico_2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_presup_analitico_2`( IN _proy VARCHAR(10), IN _ver INT )
BEGIN
DECLARE _sql      longTEXT;
declare _contador  int ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
declare _codFE    int default 10 ;

DECLARE _temp_comp_ope VARCHAR(500);
DECLARE _temp_act_ope  VARCHAR(500);
DECLARE _temp_sub_ope  VARCHAR(500);
DECLARE _temp_cat_ope  VARCHAR(700);
declare _fte_comp_ope text default '';
DECLARE _fte_act_ope  TEXT DEFAULT '';
DECLARE _fte_sub_ope  TEXT DEFAULT '';
DECLARE _fte_cat_ope  TEXT DEFAULT '';

DECLARE _temp_comp_mp VARCHAR(500);
DECLARE _temp_act_mp  VARCHAR(500);
DECLARE _temp_sub_mp  VARCHAR(500);
DECLARE _temp_cat_mp  VARCHAR(700);
DECLARE _fte_comp_mp TEXT DEFAULT '';
DECLARE _fte_act_mp  TEXT DEFAULT '';
DECLARE _fte_sub_mp  TEXT DEFAULT '';
DECLARE _fte_cat_mp  TEXT DEFAULT '';

DROP TEMPORARY TABLE IF EXISTS tmpFuentes;
CREATE TEMPORARY TABLE tmpFuentes 
( id INT AUTO_INCREMENT,
  idfte INT,
  nomfte VARCHAR(250),
  PRIMARY KEY (id)
) ;
INSERT INTO tmpFuentes(idfte, nomfte)
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
LEFT JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  and f.t01_id_inst = _codFE
union all
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
LEFT JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  AND f.t01_id_inst <> _codFE ;
  

set _temp_comp_ope= "(SELECT 	SUM(fte.t10_mont)
		       FROM 	t10_cost_fte fte
		      WHERE fte.t02_cod_proy = c.t02_cod_proy
		        AND fte.t02_version  = c.t02_version
		        AND fte.t08_cod_comp = c.t08_cod_comp
		        AND fte.t01_id_inst  = _idfte
		     ) AS '_nomfte' " ;
set _temp_act_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = a.t02_cod_proy
			    AND fte.t02_version  = a.t02_version
			    AND fte.t08_cod_comp = a.t08_cod_comp
			    AND fte.t09_cod_act  = a.t09_cod_act
			    AND fte.t01_id_inst  = _idfte
			)  AS '_nomfte' " ;
			
SET _temp_sub_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND fte.t01_id_inst  = _idfte
			 ) AS '_nomfte' " ;
			 
SET _temp_cat_ope = "  ( SELECT  SUM(fte.t10_mont)
			   FROM     t10_cost_fte fte
			 INNER JOIN t10_cost_sub cost ON ( fte.t02_cod_proy = cost.t02_cod_proy AND fte.t02_version  = cost.t02_version AND fte.t08_cod_comp = cost.t08_cod_comp AND fte.t09_cod_act  = cost.t09_cod_act AND fte.t09_cod_sub  = cost.t09_cod_sub AND fte.t10_cod_cost = cost.t10_cod_cost )
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND cost.t10_cate_cost = p.t10_cate_cost
			    AND fte.t01_id_inst  = _idfte
			 )  AS '_nomfte' " ;

SET _temp_comp_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_act_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
set _temp_sub_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
		       
SET _temp_cat_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.rubro      = (CASE WHEN vmp.subactividad IS NULL THEN vmp.codigo ELSE (vmp.cate_gasto - 80) END) 
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SELECT 1 INTO _contador ;  
WHILE (SELECT COUNT(1) FROM  tmpFuentes) >= _contador DO
	SELECT idfte  ,  nomfte
	INTO   _codfte, _nomfte 
	FROM tmpFuentes 
	WHERE id = _contador;
	
	set _fte_comp_ope = concat(_fte_comp_ope, ',' , REPLACE(REPLACE(_temp_comp_ope,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_ope  = CONCAT(_fte_act_ope , ',' , REPLACE(REPLACE(_temp_act_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_ope  = CONCAT(_fte_sub_ope , ',' , REPLACE(REPLACE(_temp_sub_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_ope  = CONCAT(_fte_cat_ope , ',' , REPLACE(REPLACE(_temp_cat_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _fte_comp_mp = CONCAT(_fte_comp_mp, ',' , REPLACE(REPLACE(_temp_comp_mp,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_mp  = CONCAT(_fte_act_mp , ',' , REPLACE(REPLACE(_temp_act_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_mp  = CONCAT(_fte_sub_mp , ',' , REPLACE(REPLACE(_temp_sub_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_mp  = CONCAT(_fte_cat_mp , ',' , REPLACE(REPLACE(_temp_cat_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _contador = _contador + 1;
END WHILE;
DROP TEMPORARY TABLE tmpFuentes; 
set _sql = "
SELECT 	c.t08_cod_comp AS codigo, 
	TRIM(c.t08_comp_desc) AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=c.t02_cod_proy 
	     AND cost.t02_version =c.t02_version 
	     AND cost.t08_cod_comp=c.t08_cod_comp
	) AS total,
	'componente' AS tipo,
	c.t08_cod_comp AS codigo_real
	[_fte_comp_ope]
FROM  t08_comp c
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo, 
	TRIM(a.t09_act) AS descripcion,
	NULL AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost 
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS total,
	'actividad' AS tipo,
	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo_real
	[_fte_act_ope]
FROM  t09_act a
WHERE a.t02_cod_proy = _proy
  AND a.t02_version  = _ver
  
UNION ALL
SELECT 	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo, 
	TRIM(s.t09_sub) AS descripcion,
	s.t09_um AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) AS parcial,
	s.t09_mta AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) * s.t09_mta) AS total,
	'subactividad' AS tipo,
	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo_real
	[_fte_sub_ope]
FROM  t09_subact s
WHERE s.t02_cod_proy = _proy 
  AND s.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost 
	   WHERE cost.t02_cod_proy=p.t02_cod_proy 
	     AND cost.t02_version =p.t02_version 
	     AND cost.t08_cod_comp=p.t08_cod_comp
	     AND cost.t09_cod_act =p.t09_cod_act
	     AND cost.t09_cod_sub =p.t09_cod_sub
	     AND cost.t10_cate_cost=t.codi
	) * s.t09_mta) AS total,
	'rubro' AS tipo,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
	[_fte_cat_ope]
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  = _ver
GROUP BY 1,2,3 
UNION ALL
 
SELECT 	vmp.componente AS codigo, 
	'Manejo del Proyecto' AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'componente' AS tipo,
	CONCAT(80 + vmp.componente) AS codigo_real
	[_fte_comp_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver 
  GROUP BY 1,2,3,4,5
UNION ALL
SELECT 	CONCAT(componente,'.',actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	NULL AS um,
	SUM(vmp.gasto) parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'actividad' AS tipo,
	CONCAT(80 + componente,'.',actividad) AS codigo_real
	[_fte_act_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
 GROUP BY 1,2,3
UNION ALL
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nom_cate_gasto
	 ELSE
	      vmp.subactividad
	 END 
	) AS descripcion,
	vmp.um AS um,
	SUM(vmp.gasto) parcial,
	vmp.meta AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'subactividad' AS tipo,
	CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo_real
	[_fte_sub_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.codsub is not null
 GROUP BY 1,2
UNION ALL
SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo, 
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'rubro' AS tipo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
	[_fte_cat_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.cate_gasto is not null
  GROUP BY 1, 2, 3 
  
ORDER BY codigo_real ; " ; 
  
 
 
set _sql = replace(_sql,' _proy', concat(" '",_proy,"'"));
SET _sql = REPLACE(_sql,' _ver', _ver);
SET _sql = REPLACE(_sql,'[_fte_comp_ope]', _fte_comp_ope);
SET _sql = REPLACE(_sql,'[_fte_act_ope]' , _fte_act_ope );
SET _sql = REPLACE(_sql,'[_fte_sub_ope]' , _fte_sub_ope );
SET _sql = REPLACE(_sql,'[_fte_cat_ope]' , _fte_cat_ope );
SET _sql = REPLACE(_sql,'[_fte_comp_mp]', _fte_comp_mp);
SET _sql = REPLACE(_sql,'[_fte_act_mp]' , _fte_act_mp );
SET _sql = REPLACE(_sql,'[_fte_sub_mp]' , _fte_sub_mp );
SET _sql = REPLACE(_sql,'[_fte_cat_mp]' , _fte_cat_mp );
 select _sql as '_sql' ;
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_presup_analitico_back` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_presup_analitico_back`( IN _proy VARCHAR(10), IN _ver INT )
BEGIN
SELECT 	c.t08_cod_comp AS codigo, 
	TRIM(c.t08_comp_desc) AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=c.t02_cod_proy 
	     AND cost.t02_version =c.t02_version 
	     AND cost.t08_cod_comp=c.t08_cod_comp
	) AS total,
	'componente' AS tipo,
	c.t08_cod_comp AS codigo_real
FROM  t08_comp c
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo, 
	TRIM(a.t09_act) AS descripcion,
	NULL AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost 
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS total,
	'actividad' AS tipo,
	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo_real
FROM  t09_act a
WHERE a.t02_cod_proy = _proy
  AND a.t02_version  = _ver
  
UNION ALL
SELECT 	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo, 
	TRIM(s.t09_sub) AS descripcion,
	s.t09_um AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) AS parcial,
	s.t09_mta AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) * s.t09_mta) AS total,
	'subactividad' AS tipo,
	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo_real
FROM  t09_subact s
WHERE s.t02_cod_proy = _proy 
  AND s.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost 
	   WHERE cost.t02_cod_proy=p.t02_cod_proy 
	     AND cost.t02_version =p.t02_version 
	     AND cost.t08_cod_comp=p.t08_cod_comp
	     AND cost.t09_cod_act =p.t09_cod_act
	     AND cost.t09_cod_sub =p.t09_cod_sub
	     AND cost.t10_cate_cost=t.codi
	) * s.t09_mta) AS total,
	'rubro' AS tipo,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  = _ver
GROUP BY 1,2,3
UNION ALL
 
SELECT 	vmp.componente AS codigo, 
	'Manejo del Proyecto' AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'componente' AS tipo,
	CONCAT(vmp.componente) AS codigo_real
FROM  v_manejo_proyecto vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver 
  GROUP BY 1,2,3,4,5
UNION ALL
SELECT 	CONCAT(componente,'.',actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	NULL AS um,
	SUM(vmp.gasto) parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'actividad' AS tipo,
	CONCAT(componente,'.',actividad) AS codigo_real
FROM  v_manejo_proyecto vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
 GROUP BY 1,2,3
UNION ALL
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nom_cate_gasto
	 ELSE
	      vmp.subactividad
	 END 
	) AS descripcion,
	vmp.um AS um,
	SUM(vmp.gasto) parcial,
	vmp.meta AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'subactividad' AS tipo,
	CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo_real
FROM  v_manejo_proyecto vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.codsub is not null
 GROUP BY 1,2
UNION ALL
SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo, 
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'rubro' AS tipo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
FROM  v_manejo_proyecto vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.cate_gasto is not null
  GROUP BY 1, 2, 3
UNION ALL  
SELECT  CONCAT(90, '.', 4) AS codigo,
	'Gastos Administrativos para todo el proyecto' AS descripcion,
	'Mes' AS um,
	(SUM(cost.t03_monto) / 36) AS parcial,
	36 AS meta,
	SUM(cost.t03_monto) AS total,
	'componente' AS tipo,
	CONCAT(90, '.', 4) AS codigo_real
 FROM  t03_mp_gas_adm cost  
WHERE  cost.t02_cod_proy = _proy
  AND  cost.t02_version = _ver
  
UNION ALL  
 SELECT CONCAT(90, '.', 5) AS codigo,
	'Linea de Base y Evaluacion del Impacto' AS descripcion,
	'Estudio' AS um,
	(SUM(cost.t03_monto) / 2) AS parcial,
	2 AS meta,
	SUM(cost.t03_monto) AS total,
	'componente' AS tipo,
	CONCAT(90, '.', 5) AS codigo_real
 FROM  t03_mp_linea_base cost 
WHERE  cost.t02_cod_proy = _proy
  AND  cost.t02_version = _ver
UNION ALL  
 SELECT CONCAT(90, '.', 6) AS codigo,
	'Imprevistos' AS descripcion,
	'Prom. Mensual' AS um,
	(SUM(cost.t03_monto)/36) AS parcial,
	36 AS meta,
	SUM(cost.t03_monto) AS total,
	'componente' AS tipo,
	CONCAT(90, '.', 6) AS codigo_real
 FROM  t03_mp_imprevistos cost 
WHERE  cost.t02_cod_proy = _proy
  AND  cost.t02_version = _ver
 ORDER BY codigo_real ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_presup_eje_mensual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_presup_eje_mensual`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
DECLARE _sql      LONGTEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;

DECLARE _temp_comp_ope VARCHAR(500);
DECLARE _temp_act_ope  VARCHAR(500);
DECLARE _temp_sub_ope  VARCHAR(500);
DECLARE _temp_cat_ope  VARCHAR(700);
DECLARE _fte_comp_ope TEXT DEFAULT '';
DECLARE _fte_act_ope  TEXT DEFAULT '';
DECLARE _fte_sub_ope  TEXT DEFAULT '';
DECLARE _fte_cat_ope  TEXT DEFAULT '';

DECLARE _temp_comp_mp VARCHAR(500);
DECLARE _temp_act_mp  VARCHAR(500);
DECLARE _temp_sub_mp  VARCHAR(500);
DECLARE _temp_cat_mp  VARCHAR(700);
DECLARE _fte_comp_mp TEXT DEFAULT '';
DECLARE _fte_act_mp  TEXT DEFAULT '';
DECLARE _fte_sub_mp  TEXT DEFAULT '';
DECLARE _fte_cat_mp  TEXT DEFAULT '';

DROP TEMPORARY TABLE IF EXISTS tmpFuentes;
CREATE TEMPORARY TABLE tmpFuentes 
( id INT AUTO_INCREMENT,
  idfte INT,
  nomfte VARCHAR(250),
  PRIMARY KEY (id)
) ;
INSERT INTO tmpFuentes(idfte, nomfte)
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
inner JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  AND f.t01_id_inst = _codFE
UNION ALL
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
inner JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  AND f.t01_id_inst <> _codFE ;
  

SET _temp_comp_ope= "(SELECT 	SUM(fte.t10_mont)
		       FROM 	t10_cost_fte fte
		      WHERE fte.t02_cod_proy = c.t02_cod_proy
		        AND fte.t02_version  = c.t02_version
		        AND fte.t08_cod_comp = c.t08_cod_comp
		        AND fte.t01_id_inst  = _idfte
		     ) AS '_nomfte' " ;
SET _temp_act_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = a.t02_cod_proy
			    AND fte.t02_version  = a.t02_version
			    AND fte.t08_cod_comp = a.t08_cod_comp
			    AND fte.t09_cod_act  = a.t09_cod_act
			    AND fte.t01_id_inst  = _idfte
			)  AS '_nomfte' " ;
			
SET _temp_sub_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND fte.t01_id_inst  = _idfte
			 ) AS '_nomfte' " ;
			 
SET _temp_cat_ope = "  ( SELECT  SUM(fte.t10_mont)
			   FROM     t10_cost_fte fte
			 INNER JOIN t10_cost_sub cost ON ( fte.t02_cod_proy = cost.t02_cod_proy AND fte.t02_version  = cost.t02_version AND fte.t08_cod_comp = cost.t08_cod_comp AND fte.t09_cod_act  = cost.t09_cod_act AND fte.t09_cod_sub  = cost.t09_cod_sub AND fte.t10_cod_cost = cost.t10_cod_cost )
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND cost.t10_cate_cost = p.t10_cate_cost
			    AND fte.t01_id_inst  = _idfte
			 )  AS '_nomfte' " ;

SET _temp_comp_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_act_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_sub_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
		       
SET _temp_cat_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.rubro      = (CASE WHEN vmp.subactividad IS NULL THEN vmp.codigo ELSE (vmp.cate_gasto - 80) END) 
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SELECT 1 INTO _contador ;  
WHILE (SELECT COUNT(1) FROM  tmpFuentes) >= _contador DO
	SELECT idfte  ,  nomfte
	INTO   _codfte, _nomfte 
	FROM tmpFuentes 
	WHERE id = _contador;
	
	SET _fte_comp_ope = CONCAT(_fte_comp_ope, ',' , REPLACE(REPLACE(_temp_comp_ope,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_ope  = CONCAT(_fte_act_ope , ',' , REPLACE(REPLACE(_temp_act_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_ope  = CONCAT(_fte_sub_ope , ',' , REPLACE(REPLACE(_temp_sub_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_ope  = CONCAT(_fte_cat_ope , ',' , REPLACE(REPLACE(_temp_cat_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _fte_comp_mp = CONCAT(_fte_comp_mp, ',' , REPLACE(REPLACE(_temp_comp_mp,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_mp  = CONCAT(_fte_act_mp , ',' , REPLACE(REPLACE(_temp_act_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_mp  = CONCAT(_fte_sub_mp , ',' , REPLACE(REPLACE(_temp_sub_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_mp  = CONCAT(_fte_cat_mp , ',' , REPLACE(REPLACE(_temp_cat_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _contador = _contador + 1;
END WHILE;
DROP TEMPORARY TABLE tmpFuentes; 
SET _sql = "
SELECT 	c.t08_cod_comp AS codigo, 
	TRIM(c.t08_comp_desc) AS descripcion,
	NULL AS um,
	NULL AS parcial,
	(SELECT SUM(sub.t09_mta_repro) 
		FROM t09_subact sub 
		WHERE sub.t02_cod_proy = c.t02_cod_proy 
		AND sub.t02_version =c.t02_version 
	  AND sub.t08_cod_comp=c.t08_cod_comp
		) AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta_repro)
	    FROM       t10_cost_sub cost
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=c.t02_cod_proy 
	     AND cost.t02_version =c.t02_version 
	     AND cost.t08_cod_comp=c.t08_cod_comp
	) AS total,
	'componente' AS tipo,
	' ' AS act_add,
	c.t08_cod_comp AS codigo_real
	[_fte_comp_ope]
FROM  t08_comp c
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo, 
	TRIM(a.t09_act) AS descripcion,
	NULL AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS parcial,
	(SELECT SUM(sub.t09_mta_repro) 
		FROM t09_subact sub 
		WHERE sub.t02_cod_proy = a.t02_cod_proy 
		AND sub.t02_version =a.t02_version 
	  AND sub.t08_cod_comp=a.t08_cod_comp
		AND sub.t09_cod_act =a.t09_cod_act
		)  AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta_repro)
	    FROM       t10_cost_sub cost 
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS total,
	'actividad' AS tipo,
	' ' AS act_add,
	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo_real
	[_fte_act_ope]
FROM  t09_act a
WHERE a.t02_cod_proy = _proy
  AND a.t02_version  = _ver
  
UNION ALL
SELECT 	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo, 
	TRIM(s.t09_sub) AS descripcion,
	s.t09_um AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) AS parcial,
	IFNULL(s.t09_mta_repro, 0) AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) * s.t09_mta_repro) AS total,
	'subactividad' AS tipo,
	IF(s.t02_version > 1,
			 IF(s.t09_cod_sub IN (
					SELECT suba.t09_cod_sub	AS subact		 
					FROM t09_subact suba
					WHERE  suba.t02_cod_proy = _proy
					  AND  suba.t08_cod_comp = s.t08_cod_comp 
					  AND  suba.t09_cod_act  = s.t09_cod_act
						AND  suba.t02_version  = 1
					  GROUP BY 1
					  ORDER BY subact
						),'','1')		  
	   ,'') AS act_add	,
	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo_real
	[_fte_sub_ope]
FROM  t09_subact s
WHERE s.t02_cod_proy = _proy 
  AND s.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost 
	   WHERE cost.t02_cod_proy=p.t02_cod_proy 
	     AND cost.t02_version =p.t02_version 
	     AND cost.t08_cod_comp=p.t08_cod_comp
	     AND cost.t09_cod_act =p.t09_cod_act
	     AND cost.t09_cod_sub =p.t09_cod_sub
	     AND cost.t10_cate_cost=t.codi
	) * s.t09_mta_repro) AS total,
	'rubro' AS tipo,
	' ' AS act_add,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
	[_fte_cat_ope]
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  = _ver
GROUP BY 1,2,3 
UNION ALL
 
SELECT 	vmp.componente AS codigo, 
	'Manejo del Proyecto' AS descripcion,
	NULL AS um,
	NULL AS parcial,
	0 AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'componente' AS tipo,
	' ' AS act_add,
	CONCAT(80 + vmp.componente) AS codigo_real
	[_fte_comp_mp]
FROM  v_manejo_proyecto_reprog vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver 
  GROUP BY 1,2,3,4,5
UNION ALL
SELECT 	CONCAT(componente,'.',actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	NULL AS um,
	SUM(vmp.gasto) parcial,
	0 AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'actividad' AS tipo,
	' ' AS act_add,
	CONCAT(80 + componente,'.',actividad) AS codigo_real
	[_fte_act_mp]
FROM  v_manejo_proyecto_reprog vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
 GROUP BY 1,2,3
UNION ALL
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nom_cate_gasto
	 ELSE
	      vmp.subactividad
	 END 
	) AS descripcion,
	vmp.um AS um,
	SUM(vmp.gasto) parcial,
	vmp.meta AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'subactividad' AS tipo,
	'' AS act_add,
	
	CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo_real
	[_fte_sub_mp]
FROM  v_manejo_proyecto_reprog vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.codsub is not null
 GROUP BY 1,2
UNION ALL
SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo,
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'rubro' AS tipo,
	' ' AS act_add,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
	[_fte_cat_mp]
FROM  v_manejo_proyecto_reprog vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.cate_gasto is not null
  GROUP BY 1, 2, 3 
  
ORDER BY codigo_real ; " ; 
  
 
SET _sql = REPLACE(_sql,' _proy', CONCAT(" '",_proy,"'"));
SET _sql = REPLACE(_sql,' _ver', _ver);
SET _sql = REPLACE(_sql,'[_fte_comp_ope]', _fte_comp_ope);
SET _sql = REPLACE(_sql,'[_fte_act_ope]' , _fte_act_ope );
SET _sql = REPLACE(_sql,'[_fte_sub_ope]' , _fte_sub_ope );
SET _sql = REPLACE(_sql,'[_fte_cat_ope]' , _fte_cat_ope );
SET _sql = REPLACE(_sql,'[_fte_comp_mp]', _fte_comp_mp);
SET _sql = REPLACE(_sql,'[_fte_act_mp]' , _fte_act_mp );
SET _sql = REPLACE(_sql,'[_fte_sub_mp]' , _fte_sub_mp );
SET _sql = REPLACE(_sql,'[_fte_cat_mp]' , _fte_cat_mp );
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_presup_fisico_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_presup_fisico_subact`(IN _proy  VARCHAR(10), 
					       IN _comp  INT, 
					       IN _act INT,
					       IN _idFte INT,
					       IN _mes_ini INT,
					       IN _mes_fin INT)
BEGIN
DECLARE _ver  INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
  
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  sub.t09_mta_repro AS meta,
  SUM(cost.t10_cost_parc * sub.t09_mta_repro)  AS total_presup,
  SUM(fn_monto_planificado_fte_periodo(cost.t02_cod_proy, cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , cost.t10_cod_cost,
				         _idFte, _mes_ini, _mes_fin)) AS programado,
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy=cost.t02_cod_proy
       AND gas.t08_cod_comp=cost.t08_cod_comp
       AND gas.t09_cod_act =cost.t09_cod_act
       AND gas.t09_cod_sub =cost.t09_cod_sub
       AND gas.t41_fte_finan=_idFte
      AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
   
    (SELECT max(t51_obs)
      FROM t51_inf_mf_avance_monto inf
      inner join t51_inf_mf cab on (inf.t02_cod_proy=cab.t02_cod_proy and inf.t51_num=cab.t51_num)
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND inf.t51_fuente  = _idFte
       AND cab.t51_per_ini >= _mes_ini 
       AND cab.t51_per_fin <= _mes_fin 
    ) AS observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_presup_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_presup_fuentes`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
SELECT  f.t01_id_inst as codigo, 
	i.t01_sig_inst as fuente, 
	fn_total_aporte_fuentes_financ3(_proy, _ver ,f.t01_id_inst) AS total
FROM t02_fuente_finan f
LEFT JOIN t01_dir_inst i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy = _proy;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rpt_proy_mont_est` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rpt_proy_mont_est`(IN _concurso  VARCHAR(10))
BEGIN
	
SELECT 	nom_ubig AS region, t02_dg_proy.t02_estado,t03_dist_proy.t03_dpto, e.descrip AS estado,t02_dg_proy.t02_pres_tot AS presupuesto , SUBSTR(t02_dg_proy.t02_cod_proy,3,2) as concurso, 
				t02_dg_proy.t02_cod_proy as codigo
	FROM
	    t03_dist_proy 
	    INNER JOIN t02_dg_proy 
		ON (t02_dg_proy.t02_cod_proy = t03_dist_proy.t02_cod_proy)
	    LEFT JOIN adm_ubigeo dep ON (t03_dist_proy.t03_dpto=dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
	    LEFT JOIN  adm_tablas_aux AS e ON (t02_dg_proy.t02_estado=e.codi)
		WHERE  t02_dg_proy.t02_version=fn_ult_version_proy(t02_dg_proy.t02_cod_proy) 
		AND 	SUBSTR(t02_dg_proy.t02_cod_proy,3,2) = _concurso 
		
		
		  	
  GROUP BY t02_dg_proy.t02_cod_proy
	ORDER BY 1 DESC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rta_cump_inf_financ_acum_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rta_cump_inf_financ_acum_mes`(IN _proy VARCHAR(10),  IN _anio INT ,IN _mes INT)
BEGIN
	DECLARE _nummes INT;
SELECT fn_numero_mes(_anio, _mes) INTO _nummes ;

SELECT CONCAT(sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo, suba.t09_sub AS subactividad,
			suba.t09_um AS um,
			IFNULL((SELECT SUM(mtaa.t09_sub_avanc)
						 FROM t09_act_sub_mtas_inf mtaa
						 WHERE mtaa.t02_cod_proy = _proy
						 AND  mtaa.t08_cod_comp = sub.t08_cod_comp
						 AND mtaa.t09_cod_act = sub.t09_cod_act
						 AND mtaa.t09_cod_sub = sub.t09_cod_sub
						 AND fn_numero_mes(mtaa.t09_sub_anio, mtaa.t09_sub_mes) <= _nummes),0) AS meta,
						 
			
					
					 fn_presupuesto_financ(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub, sub.t02_version, _nummes) as presupuesto,
					 fn_gasto_mensual_cto_fte(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub,_nummes, 0) AS gasto,
					 (CASE
						WHEN 
							IFNULL((fn_gasto_mensual_cto_fte(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub,_nummes, 0)/fn_presupuesto_financ(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub, sub.t02_version, _nummes))*100,0) > 100 
						THEN 100
						ELSE 
							IFNULL((fn_gasto_mensual_cto_fte(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub,_nummes, 0)/fn_presupuesto_financ(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub, sub.t02_version, _nummes))*100,0) 
						END
						) AS cumplimiento	 
					
	  FROM t10_cost_sub sub
	  
		INNER JOIN t09_sub_act_mtas mta ON (sub.t02_cod_proy = mta.t02_cod_proy  AND sub.t02_version = mta.t02_version AND sub.t08_cod_comp = mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub = mta.t09_cod_sub)
		INNER JOIN t09_subact suba ON(suba.t02_cod_proy = sub.t02_cod_proy AND sub.t08_cod_comp = suba.t08_cod_comp AND sub.t09_cod_act=suba.t09_cod_act AND sub.t09_cod_sub=suba.t09_cod_sub)
		WHERE sub.t02_cod_proy = _proy
		AND fn_numero_mes(mta.t09_anio, mta.t09_mes) <= _nummes
	 
		
		
	  GROUP BY 1;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_rta_cump_inf_financ_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_rta_cump_inf_financ_mes`(IN _proy VARCHAR(10),  IN _anio INT ,IN _mes INT)
BEGIN
	DECLARE _nummes INT;
SELECT fn_numero_mes(_anio, _mes) INTO _nummes ;
SELECT CONCAT(sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo, suba.t09_sub AS subactividad,
			suba.t09_um AS um,
			mta.t09_mta AS meta,
			mta.t09_mta*fn_costos_parciales(_proy,sub.t02_version, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub) as presupuesto,
		  fn_gasto_mensual_cto_fte(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub,_mes, 1) AS gasto,
					 (CASE
						WHEN 
							IFNULL((fn_gasto_mensual_cto_fte(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub,_mes, 1)/(mta.t09_mta*fn_costos_parciales(_proy,sub.t02_version, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub)))*100,0) > 100 
						THEN 100
						ELSE 
							IFNULL((fn_gasto_mensual_cto_fte(_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub,_mes, 1)/(mta.t09_mta*fn_costos_parciales(_proy,sub.t02_version, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub)))*100,0) 
						END
						) AS cumplimiento	
		FROM t10_cost_sub sub
	  INNER JOIN t09_sub_act_mtas mta ON (sub.t02_cod_proy = mta.t02_cod_proy  AND sub.t02_version = mta.t02_version AND sub.t08_cod_comp = mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub = mta.t09_cod_sub)
		INNER JOIN t09_subact suba ON(suba.t02_cod_proy = sub.t02_cod_proy AND sub.t08_cod_comp = suba.t08_cod_comp AND sub.t09_cod_act=suba.t09_cod_act AND sub.t09_cod_sub=suba.t09_cod_sub)
		WHERE sub.t02_cod_proy = _proy
	  AND mta.t09_anio = _anio
	  AND mta.t09_mes = _mes
		
	  GROUP BY 1;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_acc_directo_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_acc_directo_perfil`(IN _perfil INT)
BEGIN
SELECT 	a.per_cod,
	p.per_des,
	a.mnu_cod,
	m.mnu_nomb,
	m.mnu_target,
	m.mnu_link,
	m.mnu_img ,
	(CASE WHEN INSTR(m.mnu_link,'?')>0 THEN '&' ELSE '?' END) AS cparam
FROM adm_acceso_directo a
INNER JOIN adm_menus    m ON (a.mnu_cod=m.mnu_cod)
INNER JOIN adm_perfiles p ON (a.per_cod=p.per_cod)
WHERE a.per_cod = _perfil
ORDER BY a.mnu_cod ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_actividades` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_actividades`(in _proy varchar(10), _ver int)
BEGIN
		SELECT 
			concat(activ.t08_cod_comp,'.',activ.t09_cod_act) as codigo,
			concat(activ.t08_cod_comp,'.',activ.t09_cod_act, ' ', activ.t09_act ) as actividad,
			activ.t08_cod_comp,
			activ.t09_cod_act,
			activ.t09_act,
			activ.t09_obs
		FROM t09_act activ
		WHERE activ.t02_cod_proy = _proy 
		and activ.t02_version = _ver 
		order by activ.t08_cod_comp, activ.t09_cod_act;
		
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_actividades_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_actividades_comp`(in _proy varchar(10), _ver int, in _comp int)
BEGIN
		SELECT 
			concat(activ.t08_cod_comp,'.',activ.t09_cod_act) as codigo,
			activ.t09_act as actividad,
			activ.t08_cod_comp,
			activ.t09_cod_act,
			activ.t09_act,
			activ.t09_obs
		FROM t09_act activ
		WHERE activ.t02_cod_proy = _proy 
		  and activ.t02_version = _ver 
		  and activ.t08_cod_comp = _comp
		order by activ.t08_cod_comp, activ.t09_cod_act;
		
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_actividad_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_actividad_costeo`(IN _proy varchar(10), 
IN _ver int, 
IN _comp int)
BEGIN
DECLARE _codfe INT ;
DECLARE _ideje INT ;
SELECT 10          INTO _codfe ;
SELECT t01_id_inst INTO _ideje FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
    SELECT
          CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
          act.t09_cod_act,
          act.t09_act AS actividad,
          NULL AS um,
          NULL AS meta,
          SUM(cost.t10_cu * cost.t10_cant) AS ctoparcial,
          SUM((cost.t10_cu * cost.t10_cant) * sub.t09_mta)  AS ctototal,
          
            
          
            
            (SELECT fn_get_fto_act_fte(act.t02_cod_proy, act.t02_version, act.t08_cod_comp, act.t09_cod_act, _codfe)) AS fte_fe,
            
          
            
            (SELECT fn_get_fto_act_fte(act.t02_cod_proy, act.t02_version, act.t08_cod_comp, act.t09_cod_act, _ideje)) AS ejecutor,
            
            
            
            (SELECT fn_get_fto_act_otros(act.t02_cod_proy, act.t02_version, act.t08_cod_comp, act.t09_cod_act, _codfe, _ideje)) AS otros
    FROM       t09_subact     sub  
    INNER JOIN t09_act        act  on(sub.t02_cod_proy = act.t02_cod_proy and sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act) 
    LEFT  JOIN t10_cost_sub   cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
    LEFT  JOIN adm_tablas_aux cat  ON(cost.t10_cate_cost = cat.codi)
    WHERE sub.t02_cod_proy=_proy
      AND sub.t02_version=_ver
      AND sub.t08_cod_comp=_comp
    GROUP BY 1, 2, 3, 4, 5 ;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_act_noc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_act_noc`(IN _proy VARCHAR(10),IN _comp INT)
BEGIN
DECLARE _ver  INT ;
	
	SELECT fn_ult_version_proy(_proy) INTO _ver;
	
	
	
	SELECT 	t09.t02_cod_proy, 
		t09.t02_version, 
		SUBSTRING_INDEX(t09.codigo,'.',1) AS t08_cod_comp, 
		SUBSTRING_INDEX(t09.codigo,'.',-1) AS t09_cod_act,
		t09.descripcion AS t09_act, 
		CONCAT(t09.codigo, '.- ', SUBSTRING(t09.descripcion,1,100)) AS descripcion
	FROM v_actividades t09
	WHERE  t09.t02_cod_proy = _proy 
		AND  t09.t02_version = _ver 
		AND  SUBSTRING_INDEX(t09.codigo,'.',1) = _comp
		AND  SUBSTRING_INDEX(t09.codigo,'.',-1) = (CASE WHEN _comp = 10 THEN 2 ELSE SUBSTRING_INDEX(t09.codigo,'.',-1) END )
	ORDER BY t09.codigo ASC;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_adm_menus` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_adm_menus`( in _modulo char(1))
BEGIN
SELECT  mnu.mnu_cod AS codigo,
        mnu.mnu_nomb AS nommenu,
	(CASE WHEN mnu.mnu_activo='1' THEN 'Activo' ELSE 'Inactivo' END ) AS activo,
	mnu.mnu_parent AS codparent,
	IFNULL(par.mnu_nomb,'') AS parentmenu
FROM      adm_menus mnu
LEFT JOIN adm_menus par ON(mnu.mnu_parent=par.mnu_cod)
   WHERE mnu.mnu_admin = _modulo
   ORDER BY mnu.mnu_cod, mnu.mnu_parent;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_adm_menus_contenedor` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_adm_menus_contenedor`( IN _modulo CHAR(1))
BEGIN
SELECT '' AS codigo,
       'Menu Principal' AS nommenu,
       '' AS parentmenu,
       1 as orden
UNION
SELECT  mnu.mnu_cod      AS codigo,
        mnu.mnu_nomb     AS nommenu,
	'Menu Principal' AS parentmenu,
	2 AS orden
FROM      adm_menus mnu
WHERE mnu.mnu_admin = _modulo
  AND IFNULL(mnu.mnu_parent,'')='' 
  
union
SELECT  DISTINCT
	mnu.mnu_parent AS codigo,
        par.mnu_nomb AS nommenu,
	'' AS parentmenu,
	3 AS orden
FROM      adm_menus mnu
LEFT JOIN adm_menus par ON(mnu.mnu_parent=par.mnu_cod)
WHERE mnu.mnu_admin = _modulo AND IFNULL(mnu.mnu_class,'')<>'' AND IFNULL(mnu.mnu_parent,'') <> '' 
  
union
SELECT  mnu.mnu_cod AS codigo,
        mnu.mnu_nomb AS nommenu,
	par.mnu_nomb AS parentmenu,
	3 AS orden
FROM      adm_menus mnu
LEFT JOIN adm_menus par ON(mnu.mnu_parent=par.mnu_cod)
WHERE mnu.mnu_admin = _modulo AND IFNULL(mnu.mnu_class,'')<>'' AND IFNULL(mnu.mnu_parent,'') <> ''
order by orden, codigo  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_ambito` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_ambito`(IN _proy VARCHAR(10), IN _vs INT)
BEGIN	
	SELECT  t03.t02_cod_proy,
		t03.t02_version,
		t03.t03_dpto,
		t03.t03_prov,
		t03.t03_dist,
		dep.nom_ubig AS dpto,
		pro.nom_ubig AS prov,
		dis.nom_ubig AS dist,
		t03.t03_obs
	FROM t03_dist_proy t03
	LEFT JOIN adm_ubigeo dep ON (t03.t03_dpto=dep.cod_dpto AND dep.cod_prov='00' AND dep.cod_dist='00')
	LEFT JOIN adm_ubigeo pro ON (t03.t03_dpto=pro.cod_dpto AND t03.t03_prov=pro.cod_prov AND pro.cod_dist='00')
	LEFT JOIN adm_ubigeo dis ON (t03.t03_dpto=dis.cod_dpto AND t03.t03_prov=dis.cod_prov AND t03.t03_dist=dis.cod_dist)
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _vs;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_aporte_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_aporte_proy`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN

SELECT 	aporte.tipoinst,
	SUM(aporte.aportefe) AS aportefe,
	SUM(aporte.aporteotros) AS aporteotros
FROM (
	SELECT     proy.t02_cod_proy AS codigo,
	    inst.t01_sig_inst AS institucion,
	    tip.abrev       AS tipoinst,
	    proy.t02_estado       AS estado,
	    (fn_total_aporte_fuentes_financ3(proy.t02_cod_proy ,1, 10 ))           AS aportefe,
	    (
	       SELECT SUM(fn_total_aporte_fuentes_financ3(ftes.t02_cod_proy , 1, ftes.t01_id_inst ))
		 FROM t02_fuente_finan ftes
		WHERE ftes.t02_cod_proy = proy.t02_cod_proy
		  AND ftes.t01_id_inst <> 10
	    )          AS aporteotros
	FROM      t02_dg_proy   proy
	LEFT JOIN t01_dir_inst  inst ON(proy.t01_id_inst=inst.t01_id_inst)
	LEFT JOIN adm_tablas_aux tip ON(inst.t01_tipo_inst=tip.codi)
	LEFT JOIN adm_tablas_aux e ON (proy.t02_estado = e.codi)
	WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy)
		AND 	SUBSTR(proy.t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(proy.t02_cod_proy,3,2) ELSE _concurso END )
		AND 	proy.t02_estado = (CASE WHEN _estado='*' THEN proy.t02_estado ELSE _estado END )    
	ORDER BY (aportefe + aporteotros) DESC  
) AS aporte 
GROUP BY aporte.tipoinst 
ORDER BY 2 DESC,3 DESC;	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_aprueba_pago_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_aprueba_pago_me`(  IN _proy VARCHAR(10),
					    in _visita int,
					    in _aprob int 
				            )
BEGIN
select 	apro.t02_cod_proy, 
	apro.t31_id, 
	apro.t31_id_aprob, 
	apro.t31_mto_aprob, 
	DATE_FORMAT(apro.t31_fec_aprob,'%d/%m/%Y') as t31_fec_aprob, 
	apro.t31_vb, 
	apro.t31_obs_aprob, 
	apro.usr_crea, 
	apro.fch_crea, 
	apro.usr_actu, 
	apro.fch_actu, 
	apro.est_audi,
	proy.t02_nom_proy as titulo,
	ejec.t01_ruc_inst,
	ejec.t01_sig_inst,
	moni.t01_id_inst  as id_moni, 
	moni.t01_ruc_inst as ruc_moni,
	moni.t01_sig_inst as sig_moni,
	proy.t02_fch_isc,
	proy.t02_fch_ini,
	DATE_ADD(proy.t02_fch_isc, INTERVAL proy.t02_num_mes MONTH) AS t02_fch_tsc,
	proy.t02_fch_ire,
	proy.t02_fch_tre,
	proy.t02_fch_tam,
	est.descrip AS estado,
	est.cod_ext AS codestado,
	cta.t01_id_cta
  from     t31_plan_me_aprob apro
LEFT  JOIN t02_dg_proy  proy  ON (apro.t02_cod_proy = proy.t02_cod_proy AND proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy))
LEFT  JOIN t01_dir_inst  ejec ON (proy.t01_id_inst = ejec.t01_id_inst )
LEFT  JOIN t01_dir_inst  moni ON ( SUBSTRING_INDEX(proy.t02_moni_ext,'.',1) = moni.t01_id_inst )
LEFT  JOIN adm_tablas_aux est ON (proy.t02_estado = est.codi)
LEFT  JOIN t02_proy_ctas cta ON (proy.t02_cod_proy=cta.t02_cod_proy)
 where  apro.t02_cod_proy = _proy 
   and  apro.t31_id = _visita
   and  apro.t31_id_aprob = _aprob ;
 
 
 
 
 
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_banco` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_banco`()
BEGIN
    SELECT 
        t00_nom_lar AS nombre_lar, 
        t00_nom_abre AS nombre, 
        t00_cod_bco AS numero
    FROM t00_bancos	
    ORDER BY t00_nom_lar ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_bancos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_bancos`()
BEGIN	
	select 	bco.t00_cod_bco  as codigo,
		bco.t00_nom_abre as abreviado,
		bco.t00_nom_lar  as nombre,
		bco.est_audi     as estado
	from t00_bancos bco;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_bus_doc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_bus_doc`(IN _texto VARCHAR(100))
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(100);
  DECLARE _existe 	INT;
  DECLARE _numrows 	INT;
 
	SELECT 	COUNT(1) 
	INTO _existe
	FROM t70_apo_bib 
	WHERE titulo 
	LIKE CONCAT('%',_texto,'%') OR autor LIKE CONCAT('%',_texto,'%'); 
      	
  IF _existe = 0 THEN
      
    SELECT CONCAT('La búsqueda de ',_texto,' no obtuvo ningún resultado')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  LEAVE TRANX;    
  ELSE  
	SELECT *
	FROM t70_apo_bib 
	WHERE titulo 
	LIKE CONCAT('%',_texto,'%') OR autor LIKE CONCAT('%',_texto,'%'); 
	
       
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_bus_pag` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_bus_pag`(IN _texto VARCHAR(100))
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(100);
  DECLARE _existe 	INT;
  DECLARE _numrows 	INT;
 
	SELECT 	COUNT(1) 
	INTO _existe
	FROM t70_apo_enl 
	WHERE url 
	LIKE CONCAT('%',_texto,'%') OR titulo LIKE CONCAT('%',_texto,'%'); 
	
  IF _existe = 0 THEN
      
    SELECT CONCAT('La búsqueda de ',_texto,' no obtuvo ningún resultado')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  LEAVE TRANX;    
  ELSE  
	SELECT * 
	FROM t70_apo_enl 
	WHERE url 
	LIKE CONCAT('%',_texto,'%') OR titulo LIKE CONCAT('%',_texto,'%'); 
	
       
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_cambio_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_cambio_personal`(IN _proy VARCHAR(10))
BEGIN
SELECT 
	sc.t04_num_soli AS nro,
	date_format(sc.t04_fec_ini,'%d/%m/%Y') as fec_sol,
	date_format(sc.t04_fec_ter,'%d/%m/%Y') as fec_apr,
	CONCAT(ep.t04_ape_pat, ' ' ,ep.t04_ape_mat, ', ', ep.t04_nom_equi) AS antes_per,
	ep.t04_carg_equi AS codcargo,
	per.t03_nom_per AS cargo,
	sc.t04_obs_ejec AS obs,
	CONCAT(sc.t04_ape_pat, ' ' ,sc.t04_ape_mat, ', ', sc.t04_nom_equi) AS nuevo_per,
	(case when sc.t04_aprob_cmt=1 then 'Si' else 'No' end ) AS ap_cmt,
	(CASE WHEN sc.t04_aprob_cmf=1 THEN 'Si' ELSE 'No' END ) AS ap_cmf,
	(CASE WHEN sc.t04_aprob_cmt=1 and sc.t04_aprob_cmf=1 THEN 'Si' ELSE 'No' END ) AS vb
FROM 	  t04_sol_cambio_per sc 
LEFT JOIN t04_equi_proy      ep ON (sc.t02_cod_proy=ep.t02_cod_proy AND sc.t04_id_equi_cambio=ep.t04_id_equi)
LEFT JOIN t03_mp_per         per ON (ep.t02_cod_proy=per.t02_cod_proy AND per.t02_version=1 AND per.t03_id_per=ep.t04_carg_equi)
WHERE sc.t02_cod_proy = _proy
order by sc.t04_num_soli ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_cartafianza` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_cartafianza`( IN _proy varchar(10) )
BEGIN
SELECT 
	cf.t02_cod_proy AS 'proyecto', 
	cf.t02_id_cf    as 'codigo', 
	bco.t00_nom_lar as 'banco',
	cf.t02_des_cf   as 'descrip', 
	FORMAT(cf.t02_mto_cf,2)  as 'monto', 
	cf.t02_num_cf   as 'numero', 
	cf.t02_ser_cf   as 'serie' , 
	DATE_FORMAT(cf.t02_frec_cf,'%d-%m-%Y')  as 'fec_rec', 
	DATE_FORMAT(cf.t02_fven_cf,'%d-%m-%Y')  as 'fec_venc', 
	cf.t02_est_cf   as 'id_est' , 
	est.descrip     as 'estado' ,
	(case when cf.t02_vb_adm='1' then 'Si' else 'No' end) as 'vbadm'
FROM 	  t02_carta_fianza cf
left join t00_bancos       bco on (cf.t02_id_bco = bco.t00_cod_bco)  
LEFT JOIN adm_tablas_aux   est ON (est.idTabla=24 and cf.t02_est_cf = est.cod_ext)
where cf.t02_cod_proy = _proy
ORDER BY cf.t02_fven_cf desc ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_cat_noc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_cat_noc`(IN _proy VARCHAR(10), IN _comp INT, IN _activ INT, IN _subactiv INT)
BEGIN
DECLARE _codfe INT ;
DECLARE _ideje INT ;
DECLARE _ver INT ;
SELECT 10      INTO _codfe ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
IF _comp <> 10 THEN 
SELECT 	cost.t02_cod_proy, 
	cost.t02_version,
	cost.t10_cate_cost,
	cat.cod_ext AS codcat,
	cat.descrip AS categoria,
	CONCAT( cost.t08_cod_comp,'.',cost.t09_cod_act,'.',cost.t09_cod_sub, '.' ,cat.cod_ext , '.-', cat.descrip  ) AS desc_cat
FROM  	  t10_cost_sub   cost
LEFT JOIN adm_tablas_aux cat ON (cost.t10_cate_cost = cat.codi	) 
WHERE cost.t02_cod_proy =_proy
  AND cost.t02_version  = _ver
  AND cost.t08_cod_comp = _comp
  AND cost.t09_cod_act  = _activ
  AND cost.t09_cod_sub  = _subactiv
GROUP BY 1,2,3,4,5,6
ORDER BY desc_cat ;
END IF ;
IF _comp = 10 THEN
SELECT 	cost.t02_cod_proy, 
	cost.t02_version,
	cost.t03_id_equi AS t10_cate_cost,
	cost.t03_id_equi AS codcat,
	cost.t03_nom_equi AS categoria ,
	CONCAT( _comp,'.', _activ,'.', _subactiv, '.', cost.t03_id_equi ,'.-', cost.t03_nom_equi  ) AS desc_cat
FROM  	  t03_mp_equi   cost
WHERE cost.t02_cod_proy = _proy
  AND cost.t02_version  = _ver
ORDER BY cost.t03_id_equi ;
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_componentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_componentes`(in _proy varchar(10))
BEGIN
declare _ver INT;
SELECT fn_ult_version_proy(_proy)  into _ver;
SELECT comp.t08_cod_comp, 
       comp.t08_comp_desc,
       concat(comp.t08_cod_comp,'.- ', comp.t08_comp_desc) as componente
FROM 	t08_comp comp
WHERE comp.t02_cod_proy = _proy 
  AND comp.t02_version  = _ver 
ORDER BY comp.t08_cod_comp;
		
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_comp_noc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_comp_noc`(IN _proy VARCHAR(10))
BEGIN
DECLARE _ver  INT ;
	SELECT fn_ult_version_proy(_proy) INTO _ver;
	
	SELECT t02_cod_proy, 
		t02_version, 
		codigo AS t08_cod_comp, 
		descripcion AS t08_comp_desc, 
		CONCAT(CODIGO,'.- ', SUBSTRING(descripcion,1,120 )) AS descripcion
	FROM v_componentes 
	WHERE  t02_cod_proy = _proy
	AND  t02_version = _ver 
	ORDER BY codigo ASC ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_concepto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_concepto`(IN in_concepto VARCHAR(30))
BEGIN
    CASE in_concepto
        WHEN 'linea' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_linea AS numero
            FROM t00_linea
            ORDER BY t00_nom_lar ASC;
        WHEN 'tasa' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_tasa AS numero
            FROM t00_tasa
            ORDER BY t00_nom_lar ASC;
    WHEN 'parametro' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_param AS numero
            FROM t00_parametro
            ORDER BY t00_nom_lar ASC;
        WHEN 'banco' THEN 
            SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_bco AS numero
            FROM t00_bancos 
            ORDER BY t00_nom_lar ASC;
        WHEN 'moneda' THEN 
           SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_mon AS numero
            FROM t00_tipo_moneda 
            ORDER BY t00_nom_abre ASC;
        WHEN 'tipo_anexo' THEN 
           SELECT 
                t02_anx_tip_desc AS nombre, 
                t02_anx_tip_abrev AS abreviatura, 
                t02_anx_tip_cod AS numero
            FROM t02_proy_anx_tip 
            ORDER BY t02_anx_tip_desc ASC;
        WHEN 'tipo_cuenta' THEN 
           SELECT 
                t00_nom_lar AS nombre, 
                t00_nom_abre AS abreviatura, 
                t00_cod_cta AS numero
            FROM t00_tipo_cuenta 
            ORDER BY t00_nom_abre ASC;
    END CASE;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_concursos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_concursos`()
BEGIN
  SELECT num_conc as numero,
     anio_conc as anio,
     nom_conc as nombre,
     abr_conc as abreviado,
     coment_conc as comentario
    FROM adm_concursos
   ORDER BY num_conc ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_concursos_activos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_concursos_activos`()
BEGIN
SELECT  DISTINCT SUBSTRING(p.t02_cod_proy,3,2) AS codigo,
	c.abr_conc AS abreviatura,
	c.nom_conc AS descripcion
FROM   	  t02_dg_proy p
INNER JOIN adm_concursos c ON (c.num_conc=SUBSTRING(p.t02_cod_proy,3,2))
WHERE  p.t02_version = 1;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_concursos_nuevos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_concursos_nuevos`()
BEGIN
SELECT  DISTINCT c.num_conc AS codigo,
	c.abr_conc AS abreviatura,
	c.nom_conc AS descripcion
FROM adm_concursos c;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_contactos_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_contactos_inst`( in _inst int )
BEGIN
if _inst <=0 then
	SELECT 	i.t01_sig_inst, 
		cto.t01_id_inst, 
		cto.t01_id_cto, 
		cto.t01_dni_cto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		cto.t01_cel_cto, 
		IFNULL(cto.t01_fono_ofi,'') AS t01_fono_ofi, 
		IFNULL(cto.t01_mail_cto,'') AS t01_mail_cto,
		t.descrip AS cargo, 
		cto.usr_crea
	FROM t01_inst_cto cto
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=cto.t01_id_inst)
	ORDER BY nombres, i.t01_sig_inst ;
else
	SELECT 	i.t01_sig_inst, 
		cto.t01_id_inst, 
		cto.t01_id_cto, 
		cto.t01_dni_cto,
		CONCAT(cto.t01_ape_pat, ' ', cto.t01_ape_mat, ', ' , cto.t01_nom_cto ) AS nombres,
		cto.t01_cel_cto, 
		IFNULL(cto.t01_fono_ofi,'') AS t01_fono_ofi, 
		IFNULL(cto.t01_mail_cto,'') AS t01_mail_cto,
		t.descrip AS cargo, 
		cto.usr_crea
	FROM t01_inst_cto cto
	LEFT JOIN adm_tablas_aux t ON (cto.t01_cgo_cto=t.codi)
	LEFT JOIN t01_dir_inst i ON (i.t01_id_inst=cto.t01_id_inst)
	where cto.t01_id_inst = _inst
	ORDER BY nombres, i.t01_sig_inst ;
end if ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_cost_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_cost_fuentes`(IN _proy VARCHAR(10), 
								IN _ver INT, 
								IN _comp INT, 
								IN _activ INT, 
								IN _subact INT, 
								IN _cod_cost INT)
BEGIN
	DECLARE _finantot DOUBLE;
	SELECT 	IFNULL( cost.t10_cost_tot ,0) INTO _finantot
	from t10_cost_sub cost  
	WHERE   cost.t02_cod_proy = _proy 
		AND cost.t02_version  = _ver 
		AND cost.t08_cod_comp = _comp 
		AND cost.t09_cod_act  = _activ 
		AND cost.t09_cod_sub  = _subact 
		AND cost.t10_cod_cost = _cod_cost;
	SELECT 	fina.t02_cod_proy, 
			fina.t01_id_inst ,
			inst.t01_sig_inst,
			fte.t10_cod_cost,
			IFNULL(SUM((CASE WHEN fina.t01_id_inst=fte.t01_id_inst THEN fte.t10_mont ELSE 0 END)),0) AS mtofinan,
			IFNULL(ROUND(((SUM((CASE WHEN fina.t01_id_inst=fte.t01_id_inst THEN fte.t10_mont ELSE 0 END)) * 100) / _finantot),2),0) AS porcentaje
	FROM 	   t02_fuente_finan   fina
	INNER JOIN t01_dir_inst 	  inst ON (fina.t01_id_inst=inst.t01_id_inst)
	LEFT  JOIN t10_cost_fte       fte  ON (fina.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND fte.t08_cod_comp=_comp AND fte.t09_cod_act=_activ AND fte.t09_cod_sub=_subact AND fte.t10_cod_cost=_cod_cost)
	WHERE   fina.t02_cod_proy	= _proy 
	GROUP BY fina.t02_cod_proy, 
			 fina.t01_id_inst ,
			 inst.t01_sig_inst,
			 fte.t10_cod_cost ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_cron_visita` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_cron_visita`( IN _proy VARCHAR(10))
BEGIN
SELECT  vis.t02_cod_proy,
	vis.t46_id,
	vis.t46_anio,
	vis.t46_mes,
	fn_nom_mes(vis.t46_mes) AS nommes,
	vis.t46_obs,
	vis.usr_crea,
	vis.est_audi
FROM t46_cron_visita_mi vis
WHERE  t02_cod_proy=_proy ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_desembolsos_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_desembolsos_fe`( in _proy varchar(10),
					  in _trim int
					 )
BEGIN
if _trim = 1 then
	SELECT 	d.t02_cod_proy, 
		d.t60_id_trim, 
		d.t60_id_desemb, 
		tp.t00_nom_lar as tipopago, 
		DATE_FORMAT( d.t60_fch_giro,'%d/%m/%Y') as t60_fch_giro,
		d.t60_mto_des,
		d.t60_nro_cheque, 
		DATE_FORMAT(d.t60_fch_depo,'%d/%m/%Y') as t60_fch_depo,
		d.t60_obs_tippago
	FROM 	t60_ejecucion_desemb d
	left join t59_aprob_primer_desemb a on(a.t02_cod_proy=d.t02_cod_proy)
	left join t00_tipo_pago  tp on (d.t60_tip_pago=tp.t00_tip_pago)
	where d.t02_cod_proy = _proy
	  and d.t60_id_trim = _trim ;
else
	SELECT 	d.t02_cod_proy, 
		d.t60_id_trim, 
		d.t60_id_desemb, 
		tp.t00_nom_lar AS tipopago, 
		DATE_FORMAT( d.t60_fch_giro,'%d/%m/%Y') AS t60_fch_giro,
		d.t60_mto_des,
		d.t60_nro_cheque, 
		DATE_FORMAT(d.t60_fch_depo,'%d/%m/%Y') AS t60_fch_depo,
		d.t60_obs_tippago
	FROM 	t60_ejecucion_desemb d
	LEFT JOIN t60_aprobacion_desemb a ON(a.t02_cod_proy=d.t02_cod_proy and fn_numero_trim(a.t60_anio,a.t60_trim)=_trim)
	LEFT JOIN t00_tipo_pago  tp ON (d.t60_tip_pago=tp.t00_tip_pago)
	WHERE d.t02_cod_proy = _proy
	  AND d.t60_id_trim = _trim ;
end if ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_desembolsos_fe_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_desembolsos_fe_me`( in _proy varchar(10),
					     in _visita int,
					     in _aprob int
					 )
BEGIN
SELECT 	d.t02_cod_proy, 
	d.t60_id_visita, 
	d.t60_id_nropago,
	d.t60_id_desemb, 
	tp.t00_nom_lar as tipopago, 
	DATE_FORMAT( d.t60_fch_giro,'%d/%m/%Y') as t60_fch_giro,
	d.t60_mto_des,
	d.t60_nro_cheque, 
	DATE_FORMAT(d.t60_fch_depo,'%d/%m/%Y') as t60_fch_depo,
	d.t60_obs_tippago
FROM 	t60_ejecucion_desemb_me d
left join t31_plan_me_aprob     a on (d.t02_cod_proy=a.t02_cod_proy and d.t60_id_visita=a.t31_id and d.t60_id_nropago=a.t31_id_aprob)
left join t00_tipo_pago        tp on (d.t60_tip_pago=tp.t00_tip_pago)
where d.t02_cod_proy = _proy
  and d.t60_id_visita = _visita
  and d.t60_id_nropago = _aprob ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_dup_plan_cap` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_dup_plan_cap`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
	INSERT INTO t12_plan_capac
	SELECT
		c.t02_cod_proy,
		_ver+1,
		c.t08_cod_comp,
		c.t09_cod_act, 
		c.t09_cod_sub,
		c.t12_nro_tema,
		c.t12_hor_cap,
		c.t12_nro_ben,
		c.t12_conten,
		c.t12_modulo,
		NOW(),
		c.usr_crea,
		c.usr_actu,
		c.fch_actu,
		c.est_audi
	FROM t12_plan_capac	c
	WHERE c.t02_cod_proy = _proy
	AND c.t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_equipo_fe_by_cargo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_equipo_fe_by_cargo`(in _cargo int)
BEGIN
SELECT 	fe.t90_id_equi AS codigo,
	CONCAT(TRIM(fe.t90_ape_pat),' ', TRIM(fe.t90_ape_mat), ', ', TRIM(fe.t90_nom_equi)) AS nombres
FROM t90_equi_fe fe
WHERE fe.t90_carg_equi = _cargo 
ORDER BY 2 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_equiv_ejecutor` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_equiv_ejecutor`( in _proy varchar(10) )
BEGIN
SELECT  DISTINCT
	t.t41_cod_ext AS codigo, 
	t.t41_descrip AS descripcion
FROM 	tmp_imp_inf_financ_gastos t
where 	t.t02_cod_proy = _proy 
order by t.t41_cod_ext;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_equiv_sistema` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_equiv_sistema`( in _proy varchar(10) )
BEGIN
SELECT 	c.t08_cod_comp AS codigo, 
	TRIM(c.t08_comp_desc) AS descripcion,
	'componente' AS tipo,
	c.t08_cod_comp AS codigo_real
FROM  t08_comp c
WHERE c.t02_cod_proy = _proy
UNION 
SELECT 	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo, 
	TRIM(a.t09_act) AS descripcion,
	'actividad' AS tipo,
	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo_real
FROM  t09_act a
WHERE a.t02_cod_proy = _proy
UNION 
SELECT 	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo, 
	TRIM(s.t09_sub) AS descripcion,
	'subactividad' AS tipo,
	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo_real
FROM  t09_subact s
WHERE s.t02_cod_proy = _proy 
UNION 
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	'rubro' AS tipo,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
FROM 	  t10_cost_sub p
LEFT JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
group by 1,2,3
 ORDER BY codigo_real ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_equi_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_equi_fe`()
BEGIN
SELECT  fe.t90_id_equi AS codigo, 
	fe.t90_dni_equi AS dni, 
	CONCAT(TRIM(fe.t90_ape_pat), ' ',TRIM(fe.t90_ape_mat), ' ',TRIM(fe.t90_nom_equi) ) AS nombres,
	sex.descrip AS sexo ,
	IF(fe.t90_edad_equi > 0, fe.t90_edad_equi  , '') AS edad,
	IF(fe.t90_cali_equi > 0, fe.t90_cali_equi  , '') AS calificacion,
	fe.t90_mail_equi AS mail, 
	fe.t90_telf_equi AS fono, 
	uni.descrip AS unidad,
	car.descrip AS cargo,
	SUBSTRING(fe.t90_func_equi,1,150) AS funcion,
	fe.t90_direccion AS direccion, 
	(CASE WHEN fe.t90_estado='1' THEN 'Activo' ELSE 'Inactivo' END) AS estado
FROM t90_equi_fe fe
LEFT JOIN  adm_tablas_aux sex ON (fe.t90_sexo_equi=sex.codi)
LEFT JOIN  adm_tablas_aux car ON (fe.t90_carg_equi=car.codi)
LEFT JOIN  adm_tablas_aux uni ON (fe.t90_unid_fe=uni.codi) 
ORDER BY 3 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_equi_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_equi_proy`(IN _proy VARCHAR(10))
BEGIN
SELECT     equi.t02_cod_proy, 
	   equi.t04_id_equi, 
	   equi.t04_dni_equi,
	   CONCAT(equi.t04_ape_pat, ' ', equi.t04_ape_mat , ', ' , equi.t04_nom_equi ) AS nombres,
	   IFNULL(equi.t04_telf_equi,'') AS t04_telf_equi, 
	   IFNULL(equi.t04_mail_equi,'') AS t04_mail_equi,
	   t.descrip AS cargo, 
	   DATE_FORMAT( (case when equi.t04_fec_ini=0 then null else equi.t04_fec_ini end ) ,'%d/%m/%Y') AS fec_ini, 
	   DATE_FORMAT( (CASE WHEN equi.t04_fec_ter=0 THEN NULL ELSE equi.t04_fec_ter END ),'%d/%m/%Y') AS fec_ter, 
	   equi.usr_crea, 
	   equi.t04_func_equi, 
	   equi.t04_exp_lab, 
	   equi.t04_cel_equi, 
	   sex.descrip AS sexo, 
	   equi.t04_edad_equi, 
	   edu.descrip AS educ,
	   (	
		SELECT per.t03_nom_per
		FROM t03_mp_per per
		WHERE per.t02_cod_proy=_proy
		AND per.t02_version=1
		AND per.t03_id_per=equi.t04_carg_equi
	   ) AS cargo,
	   esp.descrip AS especialidad,
	   est.descrip AS estado 
  FROM t04_equi_proy equi
  LEFT JOIN adm_tablas_aux t ON (equi.t04_carg_equi=t.codi)
  LEFT JOIN adm_tablas_aux sex ON (equi.t04_sexo_equi=sex.codi)
  LEFT JOIN adm_tablas_aux edu ON (equi.t04_cali_equi=edu.codi)
  LEFT JOIN adm_tablas_aux est ON (equi.t04_estado=est.codi)
  LEFT JOIN adm_tablas_aux car ON (equi.t04_carg_equi=car.codi)
  LEFT JOIN adm_tablas_aux esp ON (equi.t04_esp_equi=esp.codi)
  WHERE equi.t02_cod_proy = _proy AND t04_estado=113
  ORDER BY nombres; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_fuentes_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_fuentes_financ`(IN _proy VARCHAR(10), IN _showFE BOOLEAN )
BEGIN
DECLARE _ver  INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
IF _showFE THEN
	SELECT 	fina.t02_cod_proy, 
		fina.t01_id_inst ,
		inst.t01_sig_inst,
		inst.t01_nom_inst,
		inst.t01_ruc_inst
	FROM 	   t02_fuente_finan   fina
	INNER JOIN t01_dir_inst       inst ON (fina.t01_id_inst=inst.t01_id_inst)
	WHERE   fina.t02_cod_proy	= _proy 
 	  AND   fina.t01_id_inst  ;
 	  
ELSE
	SELECT 	fina.t02_cod_proy, 
		fina.t01_id_inst ,
		inst.t01_sig_inst,
		inst.t01_nom_inst,
		inst.t01_ruc_inst
	FROM 	   t02_fuente_finan   fina
	INNER JOIN t01_dir_inst       inst ON (fina.t01_id_inst=inst.t01_id_inst)
	WHERE   fina.t02_cod_proy	= _proy 
 	  AND   fina.t01_id_inst NOT IN(10);
 	  
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_act_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_act_se`(IN _proy VARCHAR(10), 
                IN _ver INT,
                IN _comp INT, 
                IN _prod INT, 
                IN _anio INT,
                IN _entregable INT)
BEGIN
	SELECT sub.t08_cod_comp,
	    com.t08_comp_desc AS componente,
	    sub.t09_cod_act,
	    act.t09_act AS actividad,
	    sub.t09_cod_sub,
	    sub.t09_sub AS subactividad,
	    sub.t09_um,
	    sub.t09_mta_repro AS plan_mtatotal,
	    IFNULL(
	    (SELECT SUM(a.t09_sub_avanc) 
	     FROM t09_act_sub_mtas_inf a 
	     WHERE a.t02_cod_proy = sub.t02_cod_proy 
	       AND a.t08_cod_comp = sub.t08_cod_comp 
	       AND a.t09_cod_act = sub.t09_cod_act
	       AND a.t09_cod_sub = sub.t09_cod_sub
	       AND DATE_ADD(DATE_ADD(NOW(), INTERVAL a.t09_sub_anio YEAR), INTERVAL a.t09_sub_mes MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
	    ), 0) AS ejecutado,
	    IFNULL(
	    (SELECT SUM(b.t09_mta) 
         FROM t09_sub_act_mtas b 
         WHERE b.t02_cod_proy = sub.t02_cod_proy 
           AND b.t08_cod_comp = sub.t08_cod_comp 
           AND b.t09_cod_act = sub.t09_cod_act
           AND b.t09_cod_sub = sub.t09_cod_sub
	       AND DATE_ADD(DATE_ADD(NOW(), INTERVAL b.t09_anio YEAR), INTERVAL b.t09_mes MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
	       AND b.t02_version = _ver
	    ), 0) AS programado,
	    inf.t09_obs AS obs
	FROM t09_subact sub
	INNER JOIN t08_comp com ON(sub.t02_cod_proy=com.t02_cod_proy AND sub.t02_version=com.t02_version AND sub.t08_cod_comp=com.t08_cod_comp)
	INNER JOIN t09_act act ON(sub.t02_cod_proy=act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp=act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
	LEFT JOIN t09_act_inf_se inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_prod AND sub.t09_cod_sub=inf.t09_cod_act AND inf.t02_anio=_anio AND inf.t02_entregable=_entregable)
	WHERE sub.t02_cod_proy = _proy
	  AND sub.t02_version = _ver
	  AND sub.t08_cod_comp = _comp
	  AND sub.t09_cod_act = _prod
	GROUP BY sub.t08_cod_comp, com.t08_comp_desc, sub.t09_cod_act, act.t09_act,
	     sub.t09_cod_sub, sub.t09_um, sub.t09_sub, sub.t09_mta;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_act_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_act_si`(IN _proy VARCHAR(10), 
                IN _ver INT,
                IN _comp INT, 
                IN _prod INT, 
                IN _anio INT,
                IN _entregable INT)
BEGIN
    SELECT sub.t08_cod_comp,
        com.t08_comp_desc AS componente,
        sub.t09_cod_act,
        act.t09_act AS actividad,
        sub.t09_cod_sub,
        sub.t09_sub AS subactividad,
        sub.t09_um,
        sub.t09_mta_repro AS plan_mtatotal,
        IFNULL(
        (SELECT SUM(a.t09_sub_avanc) 
         FROM t09_act_sub_mtas_inf a 
         WHERE a.t02_cod_proy = sub.t02_cod_proy 
           AND a.t08_cod_comp = sub.t08_cod_comp 
           AND a.t09_cod_act = sub.t09_cod_act
           AND a.t09_cod_sub = sub.t09_cod_sub
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL a.t09_sub_anio YEAR), INTERVAL a.t09_sub_mes MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
        ), 0) AS ejecutado,
        IFNULL(
        (SELECT SUM(b.t09_mta) 
         FROM t09_sub_act_mtas b 
         WHERE b.t02_cod_proy = sub.t02_cod_proy 
           AND b.t08_cod_comp = sub.t08_cod_comp 
           AND b.t09_cod_act = sub.t09_cod_act
           AND b.t09_cod_sub = sub.t09_cod_sub
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL b.t09_anio YEAR), INTERVAL b.t09_mes MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
           AND b.t02_version = _ver
        ), 0) AS programado,
        inf.t09_obs AS obs
    FROM t09_subact sub
    INNER JOIN t08_comp com ON(sub.t02_cod_proy=com.t02_cod_proy AND sub.t02_version=com.t02_version AND sub.t08_cod_comp=com.t08_cod_comp)
    INNER JOIN t09_act act ON(sub.t02_cod_proy=act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp=act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
    LEFT JOIN t09_act_inf_si inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_prod AND sub.t09_cod_sub=inf.t09_cod_act AND inf.t02_anio=_anio AND inf.t02_entregable=_entregable)
    WHERE sub.t02_cod_proy = _proy
      AND sub.t02_version = _ver
      AND sub.t08_cod_comp = _comp
      AND sub.t09_cod_act = _prod
    GROUP BY sub.t08_cod_comp, com.t08_comp_desc, sub.t09_cod_act, act.t09_act,
         sub.t09_cod_sub, sub.t09_um, sub.t09_sub, sub.t09_mta;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_anx_foto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_anx_foto`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _mes  INT,
				IN _ver INT
				)
BEGIN
select 	anx.t20_cod_anx,
	anx.t20_nom_file,
	anx.t20_url_file,
	anx.t20_desc_file
from t20_inf_mes_anx anx
WHERE  t02_cod_proy=_proy 
    AND  anx.t20_anio    =_anio 
    AND  anx.t20_mes     =_mes 
    AND  anx.t20_ver_inf =_ver ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_anx_foto_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_anx_foto_trim`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _trim  INT,
				IN _ver INT
				)
BEGIN
select 	anx.t25_cod_anx,
	anx.t25_nom_file,
	anx.t25_url_file,
	anx.t25_desc_file
from t25_inf_trim_anx anx
WHERE  t02_cod_proy=_proy 
    AND  anx.t25_anio    =_anio 
    AND  anx.t25_trim    =_trim 
    AND  anx.t25_ver_inf =_ver ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_anx_inf_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_anx_inf_entregable`(
                IN _proy VARCHAR(10), 
                IN _ver INT,
                IN _anio INT, 
                IN _entregable INT)
BEGIN
    SELECT 
	    t25_cod_anx,
	    t25_nom_file,
	    t25_url_file,
	    t25_desc_file
    FROM t25_inf_entregable_anx
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable 
    AND t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_car_ind_prod_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_car_ind_prod_se`(IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _comp INT, 
                        IN _prod INT,
                        IN _ind INT,
                        IN _anio INT,
                        IN _entregable INT)
BEGIN
    SELECT 
        DISTINCT car.t09_cod_act,
        car.t09_cod_act_ind,
        car.t09_cod_act_ind_car,
        car.t09_ind AS nombre,
        inf.t09_obs AS obs,
        inf.t09_avance AS avance
    FROM t09_act_ind_car car
    JOIN t02_entregable_act_ind_car prog ON(car.t02_cod_proy=prog.t02_cod_proy AND car.t02_version = prog.t02_version AND car.t08_cod_comp=prog.t08_cod_comp AND car.t09_cod_act=prog.t09_cod_act AND car.t09_cod_act_ind=prog.t09_cod_act_ind AND car.t09_cod_act_ind_car=prog.t09_cod_act_ind_car)
    LEFT JOIN t09_prod_ind_car_inf_se inf ON(prog.t02_cod_proy=inf.t02_cod_proy AND prog.t08_cod_comp=inf.t08_cod_comp AND prog.t09_cod_act=inf.t09_cod_prod AND prog.t09_cod_act_ind=inf.t09_cod_prod_ind AND prog.t09_cod_act_ind_car=inf.t09_cod_prod_ind_car AND prog.t02_anio=inf.t02_anio AND prog.t02_mes=inf.t02_entregable)
    WHERE car.t02_cod_proy = _proy
      AND car.t02_version = _ver
      AND car.t08_cod_comp = _comp
      AND car.t09_cod_act = _prod
      AND car.t09_cod_act_ind = _ind
      AND prog.t02_anio=_anio 
      AND prog.t02_mes=_entregable
    ORDER BY car.t09_cod_act_ind_car;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_car_ind_prod_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_car_ind_prod_si`(IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _comp INT, 
                        IN _prod INT,
                        IN _ind INT,
                        IN _anio INT,
                        IN _entregable INT)
BEGIN
    SELECT 
        DISTINCT car.t09_cod_act,
        car.t09_cod_act_ind,
        car.t09_cod_act_ind_car,
        car.t09_ind AS nombre,
        inf.t09_obs AS obs,
        inf.t09_avance AS avance
    FROM t09_act_ind_car car
    JOIN t02_entregable_act_ind_car prog ON(car.t02_cod_proy=prog.t02_cod_proy AND car.t02_version = prog.t02_version AND car.t08_cod_comp=prog.t08_cod_comp AND car.t09_cod_act=prog.t09_cod_act AND car.t09_cod_act_ind=prog.t09_cod_act_ind AND car.t09_cod_act_ind_car=prog.t09_cod_act_ind_car AND prog.t02_anio=_anio AND prog.t02_mes=_entregable)
    LEFT JOIN t09_prod_ind_car_inf_si inf ON(prog.t02_cod_proy=inf.t02_cod_proy AND prog.t08_cod_comp=inf.t08_cod_comp AND prog.t09_cod_act=inf.t09_cod_prod AND prog.t09_cod_act_ind=inf.t09_cod_prod_ind AND prog.t09_cod_act_ind_car=inf.t09_cod_prod_ind_car AND prog.t02_anio=_anio AND prog.t02_mes=_entregable)
    WHERE car.t02_cod_proy = _proy
      AND car.t02_version = _ver
      AND car.t08_cod_comp = _comp
      AND car.t09_cod_act = _prod
      AND car.t09_cod_act_ind = _ind
    ORDER BY car.t09_cod_act_ind_car;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_entregable`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
    SELECT 
        inf.t02_cod_proy,
        inf.t25_anio,
        CONCAT('Año ',inf.t25_anio) AS anio,
        inf.t25_entregable,
        fn_numero_entregable(_proy, _ver, inf.t25_anio, inf.t25_entregable) AS entregable,
        DATE_FORMAT(inf.t25_fch_pre,'%d/%m/%Y') AS fec_pre,
        inf.t25_periodo AS periodo,
        (case when inf.t25_vb='1' then 'VB' else '' end) AS vb,
        inf.t25_vb_fch AS vb_fec,
        SUBSTRING(inf.t25_vb_txt,1,205) as aprueba_txt,
        (case when length(inf.t25_conclu)>205 then concat(SUBSTRING(inf.t25_conclu,1,205),' ...') else inf.t25_conclu end ) AS conclusiones,
        est.descrip AS estado
    FROM t25_inf_entregable inf
    LEFT JOIN adm_tablas_aux est ON (inf.t25_estado = est.codi)
    WHERE inf.t02_cod_proy = _proy
    ORDER BY inf.t25_anio, entregable;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_entregable_analisis` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_entregable_analisis`(
                IN _proy VARCHAR(10), 
                IN _ver INT,
                IN _anio INT, 
                IN _entregable  INT)
BEGIN
    SELECT t25_entregable, 
        t25_resulta, 
        t25_conclu, 
        t25_limita, 
        t25_fac_pos, 
        t25_perspec 
    FROM t25_inf_entregable
    WHERE t02_cod_proy=_proy
      AND t25_anio = _anio
      AND t25_entregable  = _entregable
      AND t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_entregable_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_entregable_ind_comp`(IN _proy VARCHAR(10), 
                IN _ver INT,
                IN _comp INT,
                IN _anio INT, 
                IN _entregable INT)
BEGIN
    
    
    SELECT  ind.t08_cod_comp_ind,
        ind.t08_ind AS indicador,
        ind.t08_um,
        
        IFNULL((SELECT a.t08_mta FROM t08_comp_ind a WHERE ind.t02_cod_proy=a.t02_cod_proy
                                            AND a.t02_version=1
                                            AND ind.t08_cod_comp=a.t08_cod_comp
                                            AND ind.t08_cod_comp_ind = a.t08_cod_comp_ind), 0) AS plan_mtaTotal,
        SUM(CASE WHEN fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t08_ind_anio, inf.t08_ind_entregable) < fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, _anio, _entregable)  THEN inf.t08_ind_avanc ELSE 0  END) AS ejec_mtaAcum,
        SUM(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_entregable = _entregable  THEN inf.t08_ind_avanc ELSE 0  END) AS ejec_mtaEntregable,
        SUM(CASE WHEN fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t08_ind_anio, inf.t08_ind_entregable) <= fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, _anio, _entregable) THEN IFNULL(inf.t08_ind_avanc, 0) ELSE 0  END) AS ejec_mtaTotal,
        MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_entregable=_entregable THEN inf.t08_descrip ELSE NULL END) AS descripcion,
        MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_entregable=_entregable THEN inf.t08_logros  ELSE NULL END) AS logros,
        MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_entregable=_entregable THEN inf.t08_dificul ELSE NULL END) AS dificultades,
        MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_entregable=_entregable THEN inf.t08_obs ELSE NULL END) AS observaciones
    FROM       t08_comp_ind ind  
    LEFT JOIN  t08_comp_ind_inf inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp AND ind.t08_cod_comp_ind=inf.t08_cod_comp_ind AND inf.t08_ind_anio<=_anio)
    WHERE  ind.t02_cod_proy=_proy
      AND  ind.t02_version=_ver
      AND  ind.t08_cod_comp=_comp
    GROUP BY ind.t08_cod_comp_ind,
         ind.t08_ind,
         ind.t08_um,
         ind.t08_mta;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_entregable_ind_prop` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_entregable_ind_prop`(IN _proy VARCHAR(10), 
                    IN _ver INT, 
                    IN _anio INT, 
                    IN _entregable INT)
BEGIN

    
    SELECT  ind.t07_cod_prop_ind,
        ind.t07_ind AS indicador,
        ind.t07_um,
        ind.t07_mta AS plan_mtaTotal,
        SUM(0) AS plan_mtaAcum,
        SUM(0) AS plan_mtaEntregable,
        SUM(CASE WHEN fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t07_ind_anio, inf.t07_ind_entregable) < fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, _anio, _entregable) THEN inf.t07_ind_avanc ELSE 0 END) AS ejec_mtaAcum,
        SUM(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_entregable = _entregable THEN inf.t07_ind_avanc ELSE 0 END) AS ejec_mtaEntregable,
        SUM(CASE WHEN fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t07_ind_anio, inf.t07_ind_entregable) <= fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, _anio, _entregable) THEN IFNULL(inf.t07_ind_avanc, 0) ELSE 0 END) AS ejec_mtaTotal,
        MAX(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_entregable=_entregable THEN inf.t07_descrip ELSE NULL END) AS descripcion,
        MAX(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_entregable=_entregable THEN inf.t07_logros  ELSE NULL END) AS logros,
        MAX(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_entregable=_entregable THEN inf.t07_dificul ELSE NULL END) AS dificultades,
        MAX(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_entregable=_entregable THEN inf.t07_observaciones ELSE NULL END) AS observaciones
    FROM t07_prop_ind ind
    LEFT JOIN t07_prop_ind_inf inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t07_cod_prop_ind=inf.t07_cod_prop_ind AND inf.t07_ind_anio<=_anio)
    WHERE ind.t02_cod_proy = _proy 
      AND ind.t02_version = _ver
    GROUP BY ind.t07_cod_prop_ind,
         ind.t07_ind,
         ind.t07_um,
         ind.t07_mta;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_entregable_vb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_entregable_vb`(IN _user VARCHAR(10))
BEGIN
	DECLARE var_all_proy INT DEFAULT 0;
    DECLARE var_type_user INT DEFAULT 0;
    
    SELECT IF(t02_cod_proy = '*', 1, 0), tipo_user INTO var_all_proy, var_type_user FROM adm_usuarios WHERE coduser = _user;
    
    IF var_type_user = 16 THEN  
        IF var_all_proy = 1 THEN
		    SELECT 
                inf.t02_cod_proy AS proy,
                inf.t02_version AS version,
                inf.t25_anio,
                CONCAT('Año ',inf.t25_anio) AS anio,
                inf.t25_entregable,
                fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t25_anio, inf.t25_entregable) AS entregable,
                DATE_FORMAT(inf.t25_fch_pre,'%d/%m/%Y') AS fec_pre,
                inf.t25_periodo AS periodo,
                (case when inf.t25_vb='1' then 'VB' else '' end) AS vb,
                inf.t25_vb_fch AS vb_fec,
                SUBSTRING(inf.t25_vb_txt,1,205) as aprueba_txt,
                (case when length(inf.t25_conclu)>205 then concat(SUBSTRING(inf.t25_conclu,1,205),' ...') else inf.t25_conclu end ) AS conclusiones,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t25_inf_entregable inf, adm_tablas_aux est
            WHERE inf.t25_estado = est.codi 
            AND inf.t25_estado = 46
            AND inf.vb_se = 0
            ORDER BY inf.t02_cod_proy, inf.t25_anio, entregable;
	    ELSE
	       SELECT 
                inf.t02_cod_proy AS proy,
                inf.t02_version AS version,
                inf.t25_anio,
                CONCAT('Año ',inf.t25_anio) AS anio,
                inf.t25_entregable,
                fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t25_anio, inf.t25_entregable) AS entregable,
                DATE_FORMAT(inf.t25_fch_pre,'%d/%m/%Y') AS fec_pre,
                inf.t25_periodo AS periodo,
                (case when inf.t25_vb='1' then 'VB' else '' end) AS vb,
                inf.t25_vb_fch AS vb_fec,
                SUBSTRING(inf.t25_vb_txt,1,205) as aprueba_txt,
                (case when length(inf.t25_conclu)>205 then concat(SUBSTRING(inf.t25_conclu,1,205),' ...') else inf.t25_conclu end ) AS conclusiones,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t25_inf_entregable inf, adm_usuarios u, adm_tablas_aux est
            WHERE inf.t02_cod_proy = u.t02_cod_proy
            AND inf.t25_estado = est.codi 
            AND inf.t25_estado = 46
            AND inf.vb_se = 0
            AND u.coduser = _user
            ORDER BY inf.t02_cod_proy, inf.t25_anio, entregable;
        END IF;
    ELSEIF var_type_user = 13 THEN  
        IF var_all_proy = 1 THEN
            SELECT 
                inf.t02_cod_proy AS proy,
                inf.t02_version AS version,
                inf.t25_anio,
                CONCAT('Año ',inf.t25_anio) AS anio,
                inf.t25_entregable,
                fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t25_anio, inf.t25_entregable) AS entregable,
                DATE_FORMAT(inf.t25_fch_pre,'%d/%m/%Y') AS fec_pre,
                inf.t25_periodo AS periodo,
                (case when inf.t25_vb='1' then 'VB' else '' end) AS vb,
                inf.t25_vb_fch AS vb_fec,
                SUBSTRING(inf.t25_vb_txt,1,205) as aprueba_txt,
                (case when length(inf.t25_conclu)>205 then concat(SUBSTRING(inf.t25_conclu,1,205),' ...') else inf.t25_conclu end ) AS conclusiones,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t25_inf_entregable inf, adm_tablas_aux est
            WHERE inf.t25_estado = est.codi 
            AND inf.t25_estado = 46
            ORDER BY inf.t02_cod_proy, inf.t25_anio, entregable;
        ELSE
           SELECT 
                inf.t02_cod_proy AS proy,
                inf.t02_version AS version,
                inf.t25_anio,
                CONCAT('Año ',inf.t25_anio) AS anio,
                inf.t25_entregable,
                fn_numero_entregable(inf.t02_cod_proy, inf.t02_version, inf.t25_anio, inf.t25_entregable) AS entregable,
                DATE_FORMAT(inf.t25_fch_pre,'%d/%m/%Y') AS fec_pre,
                inf.t25_periodo AS periodo,
                (case when inf.t25_vb='1' then 'VB' else '' end) AS vb,
                inf.t25_vb_fch AS vb_fec,
                SUBSTRING(inf.t25_vb_txt,1,205) as aprueba_txt,
                (case when length(inf.t25_conclu)>205 then concat(SUBSTRING(inf.t25_conclu,1,205),' ...') else inf.t25_conclu end ) AS conclusiones,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t25_inf_entregable inf, adm_usuarios u, adm_tablas_aux est
            WHERE inf.t02_cod_proy = u.t02_cod_proy
            AND inf.t25_estado = est.codi 
            AND inf.t25_estado = 46
            AND u.coduser = _user
            ORDER BY inf.t02_cod_proy, inf.t25_anio, entregable;
        END IF;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ`(IN _proy VARCHAR(10))
BEGIN
SELECT  inf.t02_cod_proy, 
	inf.t40_anio, 
	CONCAT('Año ',inf.t40_anio) AS anio,
	inf.t40_mes, 
	CONCAT('Mes ', inf.t40_mes) AS mes,
	DATE_FORMAT(inf.t40_fch_pre,'%d/%m/%Y') AS fec_pre, 
	inf.t40_periodo,
	fn_nom_mes(inf.t40_periodo) AS periodo,
	SUBSTRING(inf.t40_obs,1,205) AS observaciones,
	est1.descrip AS est_eje,
	est2.descrip AS est_moni,
	FORMAT(IFNULL(
	(
	SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy= inf.t02_cod_proy
	       
	       AND gas.t40_anio=inf.t40_anio
	       AND gas.t40_mes=inf.t40_mes)
	,0), 2) AS monto,
	fn_numero_mes(inf.t40_anio, inf.t40_mes) AS nummes,
	(CONCAT('Mes ', inf.t40_mes, ' (',fn_nom_mes(inf.t40_periodo), ')')) as descripcion
	
FROM 	  t40_inf_financ  inf
LEFT JOIN adm_tablas_aux  est1 ON (inf.t40_est_eje = est1.codi) 
LEFT JOIN adm_tablas_aux  est2 ON (inf.t40_est_mon = est2.codi) 
WHERE 	inf.t02_cod_proy = _proy 
ORDER BY inf.t40_anio, inf.t40_mes, inf.t40_periodo;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_act`(IN _proy VARCHAR(10), 
 IN _comp INT, 
  IN _anio INT,
  IN _mes  INT,
  IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _verIni INT ;
DECLARE _ver_anio  INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_pri_version_proy(_proy) INTO _verIni;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT
  act.t09_cod_act,
  CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
  act.t09_act AS actividad,
 
  IFNULL(
   ( SELECT SUM((c.t10_cu * c.t10_cant) * s.t09_mta)
	FROM               t09_subact     s  
		INNER JOIN t09_act        a  ON(s.t02_cod_proy = a.t02_cod_proy AND s.t02_version=a.t02_version AND s.t08_cod_comp = a.t08_cod_comp AND s.t09_cod_act=a.t09_cod_act) 
		LEFT  JOIN t10_cost_sub   c ON(s.t02_cod_proy = c.t02_cod_proy AND s.t02_version=c.t02_version AND s.t08_cod_comp = c.t08_cod_comp AND s.t09_cod_act=c.t09_cod_act AND s.t09_cod_sub= c.t09_cod_sub )
	WHERE 	      s.t02_cod_proy= cost.t02_cod_proy
		  AND s.t02_version=_ver_anio
		  AND s.t08_cod_comp=cost.t08_cod_comp
		  AND s.t09_cod_act=cost.t09_cod_act
    )
   ,0) AS total_presup,
  
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy=cost.t02_cod_proy
       
       AND gas.t08_cod_comp=cost.t08_cod_comp
       AND gas.t09_cod_act =cost.t09_cod_act
       AND gas.t41_fte_finan=_cod_fte 
       AND gas.t40_anio=_anio 
       AND gas.t40_mes=_mes
    )
   ,0) AS total_ejec,
  
  IFNULL(
    (SELECT SUM(fte.t10_mont) 
     FROM t10_cost_fte fte 
     WHERE    fte.t02_cod_proy = cost.t02_cod_proy 
	  AND fte.t02_version  = _ver_anio
	  AND fte.t08_cod_comp = cost.t08_cod_comp 
	  AND fte.t09_cod_act  = cost.t09_cod_act 
	  AND fte.t01_id_inst  = _cod_fte
    )
    ,0) AS fte_fe,			
				    
  SUM(fn_monto_planificado_fte_anio_mes(cost.t02_cod_proy, cost.t02_version, 
				    cost.t08_cod_comp, cost.t09_cod_act, 
				    cost.t09_cod_sub , cost.t10_cod_cost,
				    _cod_fte , _anio, _mes)) AS planeado     
FROM       t09_subact sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
INNER JOIN t09_act 	act  ON(sub.t02_cod_proy = act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version= _ver_anio
  AND sub.t08_cod_comp= _comp
GROUP BY 1, 2, 3
ORDER BY act.t08_cod_comp, act.t09_cod_act ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_anexos`(
				IN _proy VARCHAR(10), 
				IN _anio INT, 
				IN _mes  INT
				)
BEGIN
SELECT 	anx.t40_cod_anx,
	anx.t40_nom_file,
	anx.t40_url_file,
	anx.t40_desc_file
FROM t40_inf_financ_anx anx
WHERE  t02_cod_proy=_proy 
    AND  anx.t40_anio    =_anio 
    AND  anx.t40_mes     =_mes ;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_categ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_categ`(IN _proy VARCHAR(10), 
   IN _comp INT, 
  IN _activ INT, 
   IN _subactiv INT,
   IN _anio INT,
   IN _mes  INT,
  IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT 	cost.t08_cod_comp AS comp, 
	cost.t09_cod_act  AS activ, 
	cost.t09_cod_sub  AS subact, 
	cat.cod_ext       AS codcat, 
	cost.t10_cate_cost,
	CONCAT( subact.t08_cod_comp,'.', subact.t09_cod_act,'.', subact.t09_cod_sub,'.', cat.cod_ext ) AS codigo,
	cat.codi, cat.descrip AS categoria, 
	
	
	
	IFNULL(
	   ( SELECT SUM(c.t10_cost_parc * s.t09_mta)
		FROM               t09_subact     s  
			INNER JOIN t09_act        a  ON(s.t02_cod_proy = a.t02_cod_proy AND s.t02_version=a.t02_version AND s.t08_cod_comp = a.t08_cod_comp AND s.t09_cod_act=a.t09_cod_act) 
			LEFT  JOIN t10_cost_sub   c ON(s.t02_cod_proy = c.t02_cod_proy AND s.t02_version=c.t02_version AND s.t08_cod_comp = c.t08_cod_comp AND s.t09_cod_act=c.t09_cod_act AND s.t09_cod_sub= c.t09_cod_sub )
		WHERE 	      s.t02_cod_proy= cost.t02_cod_proy
			  AND s.t02_version= _ver_anio
			  AND s.t08_cod_comp=cost.t08_cod_comp
			  AND s.t09_cod_act=cost.t09_cod_act
			  AND s.t09_cod_sub=cost.t09_cod_sub
			  AND c.t10_cate_cost=cost.t10_cate_cost		  
	    )
	   ,0) AS total_presup,
	   
	gas.t41_gasto AS total_ejec,
					    
	IFNULL((SELECT SUM(fte.t10_mont) 
		FROM 		t10_cost_fte fte 
		INNER JOIN  t10_cost_sub cost2 ON (fte.t02_cod_proy = cost2.t02_cod_proy AND fte.t02_version=cost2.t02_version AND fte.t08_cod_comp = cost2.t08_cod_comp AND fte.t09_cod_act=cost2.t09_cod_act AND fte.t09_cod_sub= cost2.t09_cod_sub AND fte.t10_cod_cost=cost2.t10_cod_cost)
		WHERE fte.t02_cod_proy = cost.t02_cod_proy 
		AND fte.t02_version  = _ver_anio
		AND fte.t08_cod_comp = cost.t08_cod_comp 
		AND fte.t09_cod_act=cost.t09_cod_act 
		AND fte.t09_cod_sub= cost.t09_cod_sub 
		AND cost2.t10_cate_cost=cost.t10_cate_cost
		AND fte.t01_id_inst  = _cod_fte ),0) AS fte_fe,
				
	SUM(fn_monto_planificado_fte_anio_mes(cost.t02_cod_proy, cost.t02_version, 
				    cost.t08_cod_comp, cost.t09_cod_act, 
				    cost.t09_cod_sub , cost.t10_cod_cost,
				    _cod_fte , _anio, _mes)) AS planeado   ,
	gas.t41_estado AS estado,
	gas.t41_obs AS observ
FROM 	     t09_subact AS subact 
INNER   JOIN t10_cost_sub AS cost ON (subact.t09_cod_sub = cost.t09_cod_sub  AND subact.t09_cod_act = cost.t09_cod_act AND subact.t08_cod_comp = cost.t08_cod_comp AND subact.t02_version = cost.t02_version AND subact.t02_cod_proy = cost.t02_cod_proy) 
LEFT    JOIN adm_tablas_aux AS cat ON (cost.t10_cate_cost = cat.codi)
LEFT    JOIN t41_inf_financ_gasto AS gas ON (cost.t02_cod_proy=gas.t02_cod_proy AND cost.t08_cod_comp=gas.t08_cod_comp AND cost.t09_cod_act=gas.t09_cod_act AND cost.t09_cod_sub=gas.t09_cod_sub AND cat.cod_ext=gas.t41_cate_gasto AND gas.t41_fte_finan=_cod_fte AND gas.t40_anio=_anio AND gas.t40_mes=_mes)
WHERE 	subact.t02_cod_proy=_proy
    AND subact.t02_version =_ver_anio
    AND subact.t08_cod_comp=_comp
    AND subact.t09_cod_act =_activ
    AND subact.t09_cod_sub = _subactiv
GROUP BY 	1, 2, 3, 4, 5, 6, 7
ORDER BY cost.t08_cod_comp , 
	cost.t09_cod_act  , 
	cost.t09_cod_sub  , 
	cost.t10_cate_cost ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mf`(IN _proy VARCHAR(10))
BEGIN
SELECT 	inf.t51_num AS num, 
	DATE_FORMAT(inf.t51_fch_pre,'%d/%m/%Y') AS fecpre , 
	inf.t51_periodo AS periodo, 
	inf.t51_estado , 
	est.descrip     as estado,
	SUBSTRING(inf.t51_obs,1,150)     AS observa, 
	SUBSTRING(inf.t51_conclu,1,150)  AS conclu, 
	inf.t51_califica AS califica, 
	inf.usr_crea     AS monitor
FROM 	  t51_inf_mf     inf
left join adm_tablas_aux est on (inf.t51_estado=est.codi)
where  inf.t02_cod_proy=_proy ;	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mf_docs` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mf_docs`(IN _proy VARCHAR(10), in _numinf int)
BEGIN
declare _idTablaDocs int ;
select	22 into _idTablaDocs ;
SELECT 	tdoc.cod_ext AS codigo,
	tdoc.codi    as t51_tipdoc,
	tdoc.descrip AS tipodoc,
	idoc.t51_estdoc,
	esta.descrip AS estado,
	idoc.t51_estobs AS observaciones
FROM 	  adm_tablas_aux  tdoc
LEFT JOIN t51_inf_mf_docs idoc ON (idoc.t02_cod_proy = _proy and idoc.t51_num = _numinf and tdoc.codi=idoc.t51_tipdoc)
LEFT JOIN adm_tablas_aux  esta ON (idoc.t51_estdoc = esta.codi)
WHERE tdoc.idTabla = _idTablaDocs ;	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_equi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_equi`(IN _proy VARCHAR(10), 
					          IN _anio INT,
						  IN _mes  INT,
						  IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT ;
DECLARE _comp INT;
DECLARE _act INT ;
DECLARE _equipa INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT 10, 2, 3 INTO _comp, _act, _equipa ;
SELECT  equi.t03_id_equi, 
	CONCAT(_comp,'.',_act,'.', _equipa, '.' , equi.t03_id_equi) AS codigo, 
	equi.t03_nom_equi AS equipo, 
	equi.t03_um AS um,
	equi.t03_costo AS costo,
	
	
	(
	SELECT SUM(e.t03_costo_tot) 
	  FROM t03_mp_equi e 
	 WHERE e.t02_cod_proy = equi.t02_cod_proy
	   AND e.t02_version  = _ver_anio
	   AND e.t03_id_equi  = equi.t03_id_equi
	) AS costo_tot,	
	IFNULL((SELECT SUM(t03_mta) 
	 FROM t03_mp_equi_metas mta 
	 WHERE equi.t02_cod_proy=mta.t02_cod_proy 
	   AND equi.t02_version=mta.t02_version 
	   AND equi.t03_id_equi=mta.t03_id_equi
	   and mta.t03_anio    = _anio
	 ),0) AS meta,
	(
	 SELECT   SUM(t03_monto) 
	 FROM t03_mp_equi_ftes f
	 WHERE f.t02_cod_proy = equi.t02_cod_proy
	   AND f.t02_version  = _ver_anio 
	   AND f.t03_id_equi  = equi.t03_id_equi
	   AND f.t03_id_inst  = _cod_fte
	) AS total_fuente,
	fn_monto_planificado_mp_fte_anio_mes( equi.t02_cod_proy, 
						  equi.t02_version,
						  2,
						  0,
						  equi.t03_id_equi,
						  _cod_fte,
						  _anio,
						  _mes
						) AS planeado,
	
	 ((SELECT SUM(gas.t41_gasto)
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=equi.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _equipa 
	       AND gas.t41_cate_gasto = equi.t03_id_equi
	       AND gas.t41_fte_finan=_cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 )) AS ejecutado,
	 
	 ((SELECT MAX(gas.t41_obs)
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=equi.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _equipa 
	       AND gas.t41_cate_gasto = equi.t03_id_equi
	       AND gas.t41_fte_finan=_cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 )) AS observ
	 
	 
FROM t03_mp_equi equi
WHERE equi.t02_cod_proy = _proy
  AND equi.t02_version  = _ver_anio ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_equi_total` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_equi_total`(IN _proy VARCHAR(10), 
					          IN _anio INT,
						  IN _mes  INT,
						  IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT ;
DECLARE _comp INT;
DECLARE _act INT ;
DECLARE _equipa INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT 10, 2, 3 INTO _comp, _act, _equipa ;
SELECT  
	(
	SELECT SUM(e.t03_costo_tot) 
	FROM t03_mp_equi e 
	WHERE e.t02_cod_proy=equi.t02_cod_proy
	AND e.t02_version = _ver_anio
	) AS gasto_tot,	
	
	SUM(fn_monto_total_planificado_mp_fte( equi.t02_cod_proy, 
					       equi.t02_version,
					       2,
					       0,
					       equi.t03_id_equi,
					       _cod_fte
					   )) AS total_fuente,
	SUM(fn_monto_planificado_mp_fte_anio_mes( equi.t02_cod_proy, 
						  equi.t02_version,
						  2,
						  0,
						  equi.t03_id_equi,
						  _cod_fte,
						  _anio,
						  _mes
						)) AS planeado,
	
	 SUM((SELECT gas.t41_gasto
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=equi.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _equipa
	       AND gas.t41_cate_gasto = equi.t03_id_equi
	       AND gas.t41_fte_finan=_cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 )) AS ejecutado
	 
FROM t03_mp_equi equi 
WHERE equi.t02_cod_proy=_proy
  AND equi.t02_version = _ver_anio ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_equi_total_intervalo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_equi_total_intervalo`(IN pProy VARCHAR(10), 
					          IN pAnio INT,
							  IN pMesIni  INT,
							  IN pMesFin  INT,
							  IN pFte INT)
BEGIN
	DECLARE aVerAnio  INT ;
	DECLARE aCodCom INT;
	DECLARE aCodAct INT ;
	DECLARE aCodEquip INT ;
	SELECT fn_version_proy_poa(pProy, pAnio) INTO aVerAnio ;
	SELECT 10, 2, 3 INTO aCodCom, aCodAct, aCodEquip ;
	SELECT  
			(
			SELECT	SUM(e.t03_costo_tot) 
			FROM	t03_mp_equi e 
			WHERE	e.t02_cod_proy = equi.t02_cod_proy AND e.t02_version = aVerAnio
			) AS gasto_tot,	
		
			SUM(fn_monto_total_planificado_mp_fte( equi.t02_cod_proy, equi.t02_version,
													2, 0,
													equi.t03_id_equi, pFte
													)) AS total_fuente,
													
			SUM(fn_monto_planificado_mp_fte_periodo( equi.t02_cod_proy, equi.t02_version,
													2, 0,
													equi.t03_id_equi, pFte,
													pMesIni, pMesFin
													)) AS planeado,
		
		 SUM((
			SELECT	gas.t41_gasto
			FROM	t41_inf_financ_gasto gas 
			WHERE	gas.t02_cod_proy = equi.t02_cod_proy
				AND gas.t08_cod_comp = aCodCom
				AND gas.t09_cod_act = aCodAct
				AND gas.t09_cod_sub = aCodEquip
				AND gas.t41_cate_gasto = equi.t03_id_equi
				AND gas.t41_fte_finan = pFte
				AND fn_numero_mes(gas.t40_anio, gas.t40_mes) >= pMesIni
				AND fn_numero_mes(gas.t40_anio, gas.t40_mes) <= pMesFin
		 )) AS ejecutado
		 
	FROM t03_mp_equi equi 
	WHERE equi.t02_cod_proy = pProy
	  AND equi.t02_version = aVerAnio ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_gast_adm` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_gast_adm`(IN _proy VARCHAR(10), 
						 IN _anio INT , 
						 IN _mes  INT ,
					         IN _cod_fte INT)
BEGIN
DECLARE _ver  INT default fn_ult_version_proy(_proy) ;
DECLARE _ver_anio  INT DEFAULT fn_version_proy_poa(_proy, _anio);
DECLARE _comp INT ;
DECLARE _act  INT ;
DECLARE _sub  INT ;
DECLARE _cat  INT ;
DECLARE _gastos_adm INT ;
DECLARE _ejecutado DOUBLE;
DECLARE _comentarios TEXT ;
SELECT 10, 4, 0, 0 INTO _comp, _act, _sub , _cat ;
SELECT IFNULL(SUM(t03_monto),0) 
	  INTO _gastos_adm
	  FROM t03_mp_gas_adm
	 WHERE t02_cod_proy = _proy 
	   AND t02_version  = _ver_anio  ;
	   
SELECT SUM(t41_gasto), MAX(t41_obs)
  INTO _ejecutado , _comentarios
  FROM  t41_inf_financ_gasto  
 WHERE t02_cod_proy = _proy
   AND t08_cod_comp   = _comp
   AND t09_cod_act    = _act
   AND t09_cod_sub    = _sub 
   AND t41_cate_gasto = _cat
   AND t41_fte_finan  = _cod_fte
   AND t40_anio       = _anio
   AND t40_mes        = _mes ;
   
SELECT 	CONCAT(_comp,'.',_act )  AS codigo, 
	'Gastos Administrativos' AS descripcion,
	_gastos_adm AS gasto_tot,
	fn_monto_total_planificado_mp_fte   (_proy , _ver_anio, _act, 0, NULL, _cod_fte) AS total_fuente,
	fn_monto_planificado_mp_fte_anio_mes( _proy, _ver_anio, _act, 0, NULL, _cod_fte, _anio, _mes) AS planeado,
	_ejecutado AS ejecutado,
	_comentarios AS observ ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_gast_adm_intervalo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_gast_adm_intervalo`(IN pProy VARCHAR(10), 
														  IN pAnio INT,
														  IN pMesIni  INT,
														  IN pMesFin  INT,
														  IN pFte INT)
BEGIN
	DECLARE aVerAnio  INT DEFAULT fn_version_proy_poa(pProy, pAnio);
	DECLARE aCodCom INT;
	DECLARE aCodAct  INT;
	DECLARE aCodSub  INT;
	DECLARE aCodCat  INT;
	DECLARE aGastosAdm INT;
	DECLARE aEjecutado DOUBLE;
	DECLARE aComments TEXT;
	
	SELECT 10, 4, 0, 0 INTO aCodCom, aCodAct, aCodSub , aCodCat;
	
	SELECT	IFNULL(SUM(t03_monto),0) 
	INTO	aGastosAdm
	FROM	t03_mp_gas_adm
	WHERE	t02_cod_proy = pProy AND t02_version = aVerAnio;
			
	SELECT	IFNULL(SUM(t41_gasto), 0), IFNULL(MAX(t41_obs), '')
	INTO	aEjecutado , aComments
	FROM 	t41_inf_financ_gasto  
	WHERE t02_cod_proy = pProy
		AND t08_cod_comp   = aCodCom
		AND t09_cod_act    = aCodAct
		AND t09_cod_sub    = aCodSub 
		AND t41_cate_gasto = aCodCat
		AND t41_fte_finan  = pFte
		AND fn_numero_mes(t40_anio, t40_mes) >= pMesIni
		AND fn_numero_mes(t40_anio, t40_mes) <= pMesFin;
	
	SELECT CONCAT(aCodCom,'.',aCodAct )  AS codigo, 
		'Gastos Administrativos' AS descripcion,
		aGastosAdm AS gasto_tot,
		fn_monto_total_planificado_mp_fte(pProy , aVerAnio, aCodAct, 0, NULL, pFte) AS total_fuente,
		fn_monto_planificado_mp_fte_periodo( pProy, aVerAnio, aCodAct, 0, NULL, pFte, pMesIni, pMesFin) AS planeado,
		aEjecutado AS ejecutado,
		aComments AS observ ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_gast_func_total` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_gast_func_total`(IN _proy VARCHAR(10), 
					          IN _anio INT,
						  IN _mes  INT,
						  IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT ;
DECLARE _comp INT;
DECLARE _act INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT 10, 3 INTO _comp, _act ;
SELECT 	SUM((gast.t03_cu * gast.t03_cant) * parti.t03_meta) AS gasto_tot,
	(
	 SELECT   SUM(t03_monto) 
	 FROM t03_mp_gas_fun_ftes f
	 WHERE f.t02_cod_proy=gast.t02_cod_proy 
	   AND f.t02_version =gast.t02_version  
	   
	   AND f.t03_id_inst = _cod_fte
	) AS total_fuente,
					   
	SUM(fn_monto_planificado_mp_fte_anio_mes( gast.t02_cod_proy, 
						  gast.t02_version,
						  3,
						  gast.t03_partida,
						  gast.t03_id_gasto,
						  _cod_fte,
						  _anio,
						  _mes
						)) AS planeado,
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=gast.t02_cod_proy
	      
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       
	       
	       AND gas.t41_fte_finan = _cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes = _mes
	),0) AS ejecutado
	
FROM 	   t03_mp_gas_fun_cost gast
INNER JOIN t03_mp_gas_fun_part parti ON (gast.t02_cod_proy=parti.t02_cod_proy AND gast.t02_version=parti.t02_version AND gast.t03_partida=parti.t03_partida)
LEFT JOIN  adm_tablas_aux p ON (gast.t03_partida=p.codi)
LEFT JOIN  adm_tablas_aux c ON (gast.t03_cat_gast=c.codi)
WHERE gast.t02_cod_proy = _proy
  AND gast.t02_version  = _ver_anio ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_gast_func_total_intervalo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_gast_func_total_intervalo`(IN pProy VARCHAR(10), 
					          IN pAnio INT,
							  IN pMesIni  INT,
							  IN pMesFin  INT,
							  IN pFte INT)
BEGIN
	DECLARE aVerAnio  INT ;
	DECLARE aCodCom INT;
	DECLARE aCodAct INT ;
	SELECT fn_version_proy_poa(pProy, pAnio) INTO aVerAnio ;
	SELECT 10, 3 INTO aCodCom, aCodAct;
	SELECT 	
			SUM((gast.t03_cu * gast.t03_cant) * parti.t03_meta) AS gasto_tot,
		
			(
			SELECT	SUM(t03_monto) 
			FROM	t03_mp_gas_fun_ftes f
			WHERE	f.t02_cod_proy = gast.t02_cod_proy AND f.t02_version = gast.t02_version  AND f.t03_id_inst = pFte
			) AS total_fuente,
			
			SUM(fn_monto_planificado_mp_fte_periodo( gast.t02_cod_proy, gast.t02_version,
																	3, gast.t03_partida,
																	gast.t03_id_gasto, pFte,
																	pMesIni, pMesFin
																	)) AS planeado,
			
			IFNULL((
					SELECT	SUM(gas.t41_gasto) 
					FROM	t41_inf_financ_gasto gas 
					WHERE	gas.t02_cod_proy=gast.t02_cod_proy
						AND gas.t08_cod_comp= aCodCom
						AND gas.t09_cod_act = aCodAct
						AND gas.t41_fte_finan = pFte
						AND fn_numero_mes(gas.t40_anio, gas.t40_mes) >= pMesIni
						AND fn_numero_mes(gas.t40_anio, gas.t40_mes) <= pMesFin
					),0) AS ejecutado
		
	FROM 	   t03_mp_gas_fun_cost gast
	INNER JOIN t03_mp_gas_fun_part parti ON (gast.t02_cod_proy = parti.t02_cod_proy 
										AND gast.t02_version = parti.t02_version 
										AND gast.t03_partida = parti.t03_partida)
	LEFT JOIN  adm_tablas_aux p ON (gast.t03_partida = p.codi)
	LEFT JOIN  adm_tablas_aux c ON (gast.t03_cat_gast = c.codi)
	WHERE gast.t02_cod_proy = pProy
	  AND gast.t02_version  = aVerAnio ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_gas_func_categ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_gas_func_categ`(IN _proy VARCHAR(10), 
						IN _anio INT,
						IN _mes  INT,
						IN _parti INT,
						IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _comp INT;
DECLARE _act INT ;
DECLARE _ver_anio  INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT 10, 3  INTO _comp, _act ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 	CONCAT(_comp,'.', _act,'.', p.cod_ext, '.', c.cod_ext) AS codigo,
	CONCAT(_comp,'.', _act,'.', gast.t03_partida, '.', gast.t03_cat_gast) AS codigo_real,
	gast.t03_id_gasto AS idgasto,
	gast.t03_cat_gast,
	c.descrip AS categoria,
	parti.t03_um AS um,
	parti.t03_meta AS  meta,
	(SUM(gast.t03_cu * gast.t03_cant) * parti.t03_meta) AS gasto_tot,
	
	SUM(fn_monto_total_planificado_mp_fte( _proy, 
					       _ver_anio,
					       3,
					       _parti,
					       gast.t03_id_gasto,
					       _cod_fte
					   )) AS total_fuente,
					   
	SUM(fn_monto_planificado_mp_fte_anio_mes( _proy, 
						  _ver_anio,
						  3,
						  _parti,
						  gast.t03_id_gasto,
						  _cod_fte,
						  _anio,
						  _mes
						)) AS planeado,
	
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=gast.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       
	       
	        AND gas.t09_cod_sub = p.cod_ext 
	       AND gas.t41_cate_gasto = c.cod_ext
	       AND gas.t41_fte_finan = _cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes = _mes
	),0) AS ejecutado
	
FROM 	   t03_mp_gas_fun_cost gast
INNER JOIN t03_mp_gas_fun_part parti ON (gast.t02_cod_proy=parti.t02_cod_proy AND gast.t02_version=parti.t02_version AND gast.t03_partida=parti.t03_partida)
LEFT JOIN  adm_tablas_aux p ON (gast.t03_partida=p.codi)
LEFT JOIN  adm_tablas_aux c ON (gast.t03_cat_gast=c.codi)
WHERE gast.t02_cod_proy=_proy
  AND gast.t02_version = _ver_anio
  AND gast.t03_partida = _parti
GROUP BY 1,2,4,5;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_imprevistos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_imprevistos`(IN _proy VARCHAR(10), 
						 IN _anio INT , 
						 IN _mes  INT ,
					         IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT DEFAULT fn_version_proy_poa(_proy, _anio); 
DECLARE _comp INT ;
DECLARE _act  INT ;
DECLARE _sub  INT ;
DECLARE _cat  INT ;
DECLARE _imprev INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 6, 0, 0 INTO _comp, _act, _sub , _cat ;
SELECT IFNULL(SUM(t03_monto),0) 
	  INTO _imprev
	  FROM t03_mp_imprevistos
	 WHERE t02_cod_proy = _proy 
	   AND t02_version  = _ver_anio  ;
SELECT 	CONCAT(_comp,'.',_act )  AS codigo, 
	'Imprevistos' AS descripcion,
	_imprev AS gasto_tot,
	fn_monto_total_planificado_mp_fte   (_proy , _ver_anio, _act, 0, NULL, _cod_fte) AS total_fuente,
	fn_monto_planificado_mp_fte_anio_mes( _proy, _ver_anio, _act, 0, NULL, _cod_fte, _anio, _mes) AS planeado,
	(  SELECT SUM(gas.t41_gasto) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy = _proy
	       
	       AND gas.t08_cod_comp   = _comp
	       AND gas.t09_cod_act    = _act
	       AND gas.t09_cod_sub    = _sub 
	       AND gas.t41_cate_gasto = _cat
	       AND gas.t41_fte_finan  = _cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 ) AS ejecutado,
	 
	 (  SELECT MAX(gas.t41_obs) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy= _proy
	       
	       AND gas.t08_cod_comp   = _comp
	       AND gas.t09_cod_act    = _act
	       AND gas.t09_cod_sub    = _sub
	       AND gas.t41_cate_gasto = _cat	       
	       AND gas.t41_fte_finan  =_cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 ) AS observ ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_imprevistos_intervalo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_imprevistos_intervalo`(IN pProy VARCHAR(10), 
														  IN pAnio INT,
														  IN pMesIni  INT,
														  IN pMesFin  INT,
														  IN pFte INT)
BEGIN
	DECLARE aVerAnio INT DEFAULT fn_version_proy_poa(pProy, pAnio); 
	DECLARE aCodCom INT;
	DECLARE aCodAct INT;
	DECLARE aCodSub INT;
	DECLARE aCodCat INT;
	DECLARE aImprev INT;
	SELECT 10, 6, 0, 0 INTO aCodCom, aCodAct, aCodSub , aCodCat;
	
	SELECT	IFNULL(SUM(t03_monto),0) 
	INTO	aImprev
	FROM	t03_mp_imprevistos
	WHERE	t02_cod_proy = pProy 
		AND t02_version = aVerAnio ;
	
	SELECT	CONCAT(aCodCom,'.',aCodAct )  AS codigo, 
			'Imprevistos' AS descripcion,
			aImprev AS gasto_tot,
			fn_monto_total_planificado_mp_fte (pProy , aVerAnio, aCodAct, 0, NULL, pFte) AS total_fuente,
			fn_monto_planificado_mp_fte_periodo(pProy, aVerAnio, aCodAct, 0, NULL, pFte, pMesIni, pMesFin) AS planeado,
			(SELECT	IFNULL(SUM(gas.t41_gasto), 0) 
			FROM	t41_inf_financ_gasto gas 
			WHERE	gas.t02_cod_proy = pProy
				AND gas.t08_cod_comp   = aCodCom
				AND gas.t09_cod_act    = aCodAct
				AND gas.t09_cod_sub    = aCodSub 
				AND gas.t41_cate_gasto = aCodCat
				AND gas.t41_fte_finan  = pFte
				AND fn_numero_mes(gas.t40_anio, gas.t40_mes) >= pMesIni
				AND fn_numero_mes(gas.t40_anio, gas.t40_mes) <= pMesFin
			) AS ejecutado,
			(SELECT	IFNULL(MAX(gas.t41_obs), '') 
			FROM	t41_inf_financ_gasto gas 
			WHERE	gas.t02_cod_proy= pProy
				AND gas.t08_cod_comp   = aCodCom
				AND gas.t09_cod_act    = aCodAct
				AND gas.t09_cod_sub    = aCodSub
				AND gas.t41_cate_gasto = aCodCat	       
				AND gas.t41_fte_finan  = pFte
				AND fn_numero_mes(gas.t40_anio, gas.t40_mes) >= pMesIni
				AND fn_numero_mes(gas.t40_anio, gas.t40_mes) <= pMesFin
			) AS observ ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_partida` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_partida`(IN _proy varchar(10), 
						IN _anio INT,
						IN _mes  INT,
						IN _cod_fte INT)
BEGIN
DECLARE _ver  INT default fn_ult_version_proy(_proy) ;
DECLARE _comp INT;
DECLARE _act INT ;
DECLARE _ver_anio  INT default fn_version_proy_poa(_proy, _anio);
SELECT 10, 3  INTO _comp, _act ;
SELECT  CONCAT(_comp,'.', _act,'.', p.cod_ext) AS codigo,
	parti.t03_partida  AS idpartida,
	p.descrip 	   AS partida,
	parti.t03_um   	   AS um,
	parti.t03_meta	   AS meta,
	(IFNULL(( SUM(t03_cu * t03_cant)),0) * parti.t03_meta) AS gasto_tot,
	
	SUM(fn_monto_total_planificado_mp_fte( gast.t02_cod_proy, 
					       gast.t02_version,
					       3,
					       gast.t03_partida,
					       gast.t03_id_gasto,
					       _cod_fte
					   )) AS total_fuente,
					   
	SUM(fn_monto_planificado_mp_fte_anio_mes( gast.t02_cod_proy, 
						  gast.t02_version,
						  3,
						  gast.t03_partida,
						  gast.t03_id_gasto,
						  _cod_fte,
						  _anio,
						  _mes
						)) AS planeado,
	
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=parti.t02_cod_proy
	      
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       
	        AND gas.t09_cod_sub = p.cod_ext 
	       AND gas.t41_fte_finan=_cod_fte 
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes = _mes
	),0) AS ejecutado
	
FROM  	  t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux      p     ON(parti.t03_partida=p.codi)
LEFT JOIN t03_mp_gas_fun_cost gast  ON(parti.t02_cod_proy=gast.t02_cod_proy AND parti.t02_version=gast.t02_version AND parti.t03_partida=gast.t03_partida)
LEFT JOIN  adm_tablas_aux     c     ON (gast.t03_cat_gast=c.codi)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version = _ver_anio 
GROUP BY  1,2,3,4,5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_partida_intervalo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_partida_intervalo`(IN pProy VARCHAR(10), 
					          IN pAnio INT,
							  IN pMesIni  INT,
							  IN pMesFin  INT,
							  IN pFte INT)
BEGIN
	
	DECLARE aCodCom INT;
	DECLARE aCodAct INT ;
	DECLARE aVerAnio  INT DEFAULT fn_version_proy_poa(pProy, pAnio);
	SELECT 10, 3  INTO aCodCom, aCodAct;
	SELECT  
			CONCAT(aCodCom,'.', aCodAct,'.', p.cod_ext) AS codigo,
			parti.t03_partida  AS idpartida,
			p.descrip 	   AS partida,
			parti.t03_um   	   AS um,
			parti.t03_meta	   AS meta,
			(IFNULL(( SUM(t03_cu * t03_cant)),0) * parti.t03_meta) AS gasto_tot,
		
			SUM(fn_monto_total_planificado_mp_fte( gast.t02_cod_proy, gast.t02_version,
													3, gast.t03_partida,
													gast.t03_id_gasto, pFte
													)) AS total_fuente,
						   
			SUM(fn_monto_planificado_mp_fte_periodo( gast.t02_cod_proy, gast.t02_version,
													3, gast.t03_partida,
													gast.t03_id_gasto, pFte,
													pMesIni, pMesFin)) AS planeado,
		
			IFNULL((
				SELECT	SUM(gas.t41_gasto) 
				FROM	t41_inf_financ_gasto gas 
				WHERE	gas.t02_cod_proy = parti.t02_cod_proy
					AND gas.t08_cod_comp= aCodCom
					AND gas.t09_cod_act = aCodAct
					AND gas.t09_cod_sub = p.cod_ext 
					AND gas.t41_fte_finan = pFte 
					AND fn_numero_mes(gas.t40_anio, gas.t40_mes) >= pMesIni
					AND fn_numero_mes(gas.t40_anio, gas.t40_mes) <= pMesFin
			),0) AS ejecutado
		
	FROM  	  t03_mp_gas_fun_part parti
	LEFT JOIN adm_tablas_aux      p     ON(parti.t03_partida = p.codi)
	LEFT JOIN t03_mp_gas_fun_cost gast  ON(parti.t02_cod_proy = gast.t02_cod_proy 
										AND parti.t02_version = gast.t02_version 
										AND parti.t03_partida = gast.t03_partida)
	WHERE parti.t02_cod_proy = pProy
	  AND parti.t02_version = aVerAnio 
	GROUP BY  1,2,3,4,5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_per` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_per`(IN _proy VARCHAR(10), 
					    IN _anio INT,
					    IN _mes  INT,
					    IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT ; 
DECLARE _comp INT;
DECLARE _act INT ;
DECLARE _rem INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT 10, 1, 12 INTO _comp, _act, _rem ;
SELECT  per.t03_id_per, 
	CONCAT(_comp,'.',_act,'.', _rem, '.' , per.t03_id_per) AS codigo, 
	per.t03_nom_per AS cargo, 
	aux.abrev AS um,
	per.t03_remu_prom AS promedio,	
	ifnull(( SELECT SUM(t03_mta) 
	    FROM t03_mp_per_metas mta
	   WHERE mta.t02_cod_proy=per.t02_cod_proy
	     AND mta.t02_version = per.t02_version
	     AND mta.t03_id_per  = per.t03_id_per
	     and mta.t03_anio    = _anio
	   ),0) as meta,
	
	(
	SELECT SUM(p.t03_gasto_tot)
	FROM t03_mp_per p
	WHERE p.t02_cod_proy=per.t02_cod_proy
	AND p.t02_version = _ver_anio
	AND p.t03_id_per  =per.t03_id_per
	) AS gasto_tot,	
	fn_monto_planificado_mp_fte_anio_mes( per.t02_cod_proy, 
						 per.t02_version,
						 1,
						 0,
						 per.t03_id_per,
						 _cod_fte,
						 _anio,
						 _mes
						) AS planeado,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_per_ftes fte
	 WHERE fte.t02_cod_proy=per.t02_cod_proy
	   AND fte.t02_version = per.t02_version
	   AND fte.t03_id_per  =per.t03_id_per
	   AND fte.t03_id_inst = _cod_fte
	) AS total_fuente,					
					   
	 (  SELECT SUM(gas.t41_gasto) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=per.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _rem 
	       AND gas.t41_cate_gasto = per.t03_id_per
	       AND gas.t41_fte_finan=_cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 ) AS ejecutado,
	 
	 (  SELECT MAX(gas.t41_obs) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=per.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _rem
	       AND gas.t41_cate_gasto = per.t03_id_per
	       AND gas.t41_fte_finan=_cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 ) AS observ
	 
FROM t03_mp_per per
LEFT JOIN adm_tablas_aux aux ON(per.t03_um=aux.codi)
WHERE per.t02_cod_proy=_proy
  AND per.t02_version = _ver_anio ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_per_total` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_per_total`(IN _proy VARCHAR(10), 
					          IN _anio INT,
						  IN _mes  INT,
						  IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT ;
DECLARE _comp INT;
DECLARE _act INT ;
DECLARE _rem INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT 10, 1, 12 INTO _comp, _act, _rem ;
SELECT  
	
	
	(
	SELECT SUM(p.t03_gasto_tot)
	FROM t03_mp_per p
	WHERE p.t02_cod_proy=per.t02_cod_proy
	AND p.t02_version =_ver_anio 
	) AS gasto_tot,	
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_per_ftes fte
	 WHERE fte.t02_cod_proy=per.t02_cod_proy
	   AND fte.t02_version =_ver_anio
	   AND fte.t03_id_inst = _cod_fte
	   
	) AS total_fuente,
					   
					   
	SUM(fn_monto_planificado_mp_fte_anio_mes( per.t02_cod_proy, 
						 per.t02_version,
						 1,
						 0,
						 per.t03_id_per,
						 _cod_fte,
						 _anio,
						 _mes
						)) AS planeado,
	SUM((SELECT gas.t41_gasto
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=per.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _rem
	       AND gas.t41_cate_gasto=per.t03_id_per
	       AND gas.t41_fte_finan=_cod_fte
	       AND gas.t40_anio= _anio
	       AND gas.t40_mes= _mes
	 )) AS ejecutado
	 
	
	 
FROM t03_mp_per per
WHERE per.t02_cod_proy=_proy
  AND per.t02_version = _ver_anio ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_per_total_intervalo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_mp_per_total_intervalo`(IN pProy VARCHAR(10), 
					          IN pAnio INT,
							  IN pMesIni  INT,
							  IN pMesFin  INT,
							  IN pFte INT)
BEGIN
	DECLARE aVerAnio INT;
	DECLARE aCodCom INT;
	DECLARE aCodAct INT;
	DECLARE aCodSub INT;
	
	SELECT fn_version_proy_poa(pProy, pAnio) INTO aVerAnio ;
	SELECT 10, 1, 12 INTO aCodCom, aCodAct, aCodSub;
	
	SELECT  
			(
			SELECT	SUM(p.t03_gasto_tot)
			FROM	t03_mp_per p
			WHERE	p.t02_cod_proy = per.t02_cod_proy AND p.t02_version = fn_pri_version_proy(per.t02_cod_proy)
			) AS total_presup,
			(
			SELECT	SUM(p.t03_gasto_tot)
			FROM	t03_mp_per p
			WHERE	p.t02_cod_proy = per.t02_cod_proy AND p.t02_version = aVerAnio 
			) AS gasto_tot,
			
			(
			SELECT SUM(t03_monto) 
			FROM t03_mp_per_ftes fte
			WHERE fte.t02_cod_proy = per.t02_cod_proy AND fte.t02_version = aVerAnio AND fte.t03_id_inst = pFte
			) AS total_fuente,
							
			fn_monto_planificado_mp_fte_periodo( per.t02_cod_proy, per.t02_version, 
																	1, 0, 
																	per.t03_id_per, pFte, 
																	pMesIni, pMesFin) AS planeado,
			
			(
				SELECT	SUM(gas.t41_gasto)
				FROM	t41_inf_financ_gasto gas 
				WHERE	gas.t02_cod_proy = per.t02_cod_proy
					AND gas.t08_cod_comp = aCodCom
					AND gas.t09_cod_act = aCodAct
					AND gas.t09_cod_sub = aCodSub
					AND gas.t41_cate_gasto = per.t03_id_per
					AND gas.t41_fte_finan = pFte
					AND fn_numero_mes(gas.t40_anio, gas.t40_mes) >= pMesIni
					AND fn_numero_mes(gas.t40_anio, gas.t40_mes) <= pMesFin
			) AS ejecutado
		 
	FROM	t03_mp_per per
	WHERE	per.t02_cod_proy = pProy
		AND per.t02_version = aVerAnio 
	GROUP BY per.t02_cod_proy, per.t02_version;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_mp_supervision` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_financ_mp_supervision`(IN _proy VARCHAR(10), 
                         IN _anio INT , 
                         IN _mes  INT ,
                         IN _cod_fte INT)
BEGIN
	DECLARE _ver  INT ;
	DECLARE _ver_anio  INT DEFAULT fn_version_proy_poa(_proy, _anio); 
	DECLARE _comp INT ;
	DECLARE _act  INT ;
	DECLARE _sub  INT ;
	DECLARE _cat  INT ;
	DECLARE _supervision DOUBLE;
	DECLARE _supervision_int INT;

	SELECT fn_ult_version_proy(_proy) INTO _ver;
	SELECT 10, 7, 0, 0 INTO _comp, _act, _sub, _cat;
	
	SELECT IFNULL(SUM(t03_monto),0), IFNULL(SUM(t03_monto),0) 
	INTO _supervision, _supervision_int 
    FROM t03_mp_gas_supervision
    WHERE t02_cod_proy = _proy 
    AND t02_version  = _ver_anio;
       
	SELECT CONCAT(_comp,'.',_act ) AS codigo, 
    'Gastos de Supervisión' AS descripcion,
    _supervision_int AS gasto_tot,
    _supervision AS total_fuente,
    (_supervision/12) AS planeado,
    (SELECT SUM(gas.t41_gasto) 
    FROM t41_inf_financ_gasto gas 
    WHERE gas.t02_cod_proy = _proy
	AND gas.t08_cod_comp   = _comp
	AND gas.t09_cod_act    = _act
	AND gas.t09_cod_sub    = _sub 
	AND gas.t41_cate_gasto = _cat
	AND gas.t41_fte_finan  = _cod_fte
	AND gas.t40_anio= _anio
	AND gas.t40_mes= _mes
    ) AS ejecutado,
     
     (SELECT MAX(gas.t41_obs) 
          FROM  t41_inf_financ_gasto gas 
         WHERE gas.t02_cod_proy= _proy
		           AND gas.t08_cod_comp   = _comp
		           AND gas.t09_cod_act    = _act
		           AND gas.t09_cod_sub    = _sub
		           AND gas.t41_cate_gasto = _cat           
		           AND gas.t41_fte_finan  =_cod_fte
		           AND gas.t40_anio= _anio
		           AND gas.t40_mes= _mes
		     ) AS observ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_financ_subact`(IN _proy VARCHAR(10), 
					    IN _comp INT, 
					    IN _activ INT,
					    IN _anio INT,
					    IN _mes  INT,
					    IN _cod_fte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _ver_anio  INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  sub.t09_mta AS meta,
 
  
  IFNULL(
   ( SELECT SUM(c.t10_cost_parc * s.t09_mta)
	FROM               t09_subact     s  
		INNER JOIN t09_act        a  ON(s.t02_cod_proy = a.t02_cod_proy AND s.t02_version=a.t02_version AND s.t08_cod_comp = a.t08_cod_comp AND s.t09_cod_act=a.t09_cod_act) 
		LEFT  JOIN t10_cost_sub   c ON(s.t02_cod_proy = c.t02_cod_proy AND s.t02_version=c.t02_version AND s.t08_cod_comp = c.t08_cod_comp AND s.t09_cod_act=c.t09_cod_act AND s.t09_cod_sub= c.t09_cod_sub )
	WHERE 	      s.t02_cod_proy= cost.t02_cod_proy
		  AND s.t02_version=_ver_anio
		  AND s.t08_cod_comp=cost.t08_cod_comp
		  AND s.t09_cod_act=cost.t09_cod_act
		  AND s.t09_cod_sub=cost.t09_cod_sub		  
    )
   ,0) AS total_presup,
   
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy=cost.t02_cod_proy
       
       AND gas.t08_cod_comp=cost.t08_cod_comp
       AND gas.t09_cod_act =cost.t09_cod_act
       AND gas.t09_cod_sub =cost.t09_cod_sub
       AND gas.t41_fte_finan=_cod_fte 
       AND gas.t40_anio=_anio 
       AND gas.t40_mes=_mes
    )
   ,0) AS total_ejec,
   				    
  IFNULL((SELECT SUM(fte.t10_mont) 
	FROM t10_cost_fte fte 
	WHERE fte.t02_cod_proy = cost.t02_cod_proy 
	AND fte.t02_version  = _ver_anio
	AND fte.t08_cod_comp = cost.t08_cod_comp 
	AND fte.t09_cod_act  = cost.t09_cod_act 
	AND fte.t09_cod_sub  = cost.t09_cod_sub
	AND fte.t01_id_inst  = _cod_fte ),0) AS fte_fe,
				 	
  SUM(fn_monto_planificado_fte_anio_mes(cost.t02_cod_proy, cost.t02_version, 
				    cost.t08_cod_comp, cost.t09_cod_act, 
				    cost.t09_cod_sub , cost.t10_cod_cost,
				    _cod_fte , _anio, _mes)) AS planeado   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver_anio
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_activ
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_financ_vb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_financ_vb`(IN _user VARCHAR(10))
BEGIN
	DECLARE var_all_proy INT DEFAULT 0;
	DECLARE var_type_user INT DEFAULT 0;
	
	SELECT IF(t02_cod_proy = '*', 1, 0), tipo_user INTO var_all_proy, var_type_user FROM adm_usuarios WHERE coduser = _user;
	
	IF var_type_user = 16 THEN  
		IF var_all_proy = 1 THEN
		   SELECT  inf.t02_cod_proy AS proy, 
		        inf.t40_anio, 
		        CONCAT('Año ',inf.t40_anio) AS anio,
		        inf.t40_mes, 
		        CONCAT('Mes ', inf.t40_mes) AS mes,
		        DATE_FORMAT(inf.t40_fch_pre,'%d/%m/%Y') AS fec_pre, 
		        inf.t40_periodo,
		        fn_nom_mes(inf.t40_periodo) AS periodo,
		        SUBSTRING(inf.t40_obs,1,205) AS observaciones,
		        est1.descrip AS est_eje,
		        est2.descrip AS est_moni,
		        FORMAT(IFNULL(
		        (
		        SELECT SUM(gas.t41_gasto) 
		             FROM  t41_inf_financ_gasto gas 
		             WHERE gas.t02_cod_proy= inf.t02_cod_proy
		               AND gas.t40_anio=inf.t40_anio
		               AND gas.t40_mes=inf.t40_mes)
		        ,0), 2) AS monto,
		        fn_numero_mes(inf.t40_anio, inf.t40_mes) AS nummes,
		        (CONCAT('Mes ', inf.t40_mes, ' (',fn_nom_mes(inf.t40_periodo), ')')) as descripcion,
		        IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
		    FROM      t40_inf_financ  inf
		    LEFT JOIN adm_tablas_aux  est1 ON (inf.t40_est_eje = est1.codi) 
		    LEFT JOIN adm_tablas_aux  est2 ON (inf.t40_est_mon = est2.codi)
		    WHERE inf.vb_se = 0
		    AND inf.t40_est_eje = 46
		    ORDER BY inf.t02_cod_proy, inf.t40_anio, inf.t40_mes, inf.t40_periodo;
		ELSE
			SELECT  inf.t02_cod_proy AS proy, 
		        inf.t40_anio, 
		        CONCAT('Año ',inf.t40_anio) AS anio,
		        inf.t40_mes, 
		        CONCAT('Mes ', inf.t40_mes) AS mes,
		        DATE_FORMAT(inf.t40_fch_pre,'%d/%m/%Y') AS fec_pre, 
		        inf.t40_periodo,
		        fn_nom_mes(inf.t40_periodo) AS periodo,
		        SUBSTRING(inf.t40_obs,1,205) AS observaciones,
		        est1.descrip AS est_eje,
		        est2.descrip AS est_moni,
		        FORMAT(IFNULL(
		        (
		        SELECT SUM(gas.t41_gasto) 
		             FROM  t41_inf_financ_gasto gas 
		             WHERE gas.t02_cod_proy= inf.t02_cod_proy
		               AND gas.t40_anio=inf.t40_anio
		               AND gas.t40_mes=inf.t40_mes)
		        ,0), 2) AS monto,
		        fn_numero_mes(inf.t40_anio, inf.t40_mes) AS nummes,
		        (CONCAT('Mes ', inf.t40_mes, ' (',fn_nom_mes(inf.t40_periodo), ')')) as descripcion,
		        IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
		    FROM      t40_inf_financ  inf
		    JOIN adm_usuarios u ON inf.t02_cod_proy = u.t02_cod_proy
		    LEFT JOIN adm_tablas_aux  est1 ON (inf.t40_est_eje = est1.codi) 
		    LEFT JOIN adm_tablas_aux  est2 ON (inf.t40_est_mon = est2.codi) 
		    WHERE inf.vb_se = 0
		    AND inf.t40_est_eje = 46
		    AND u.coduser = _user
		    ORDER BY inf.t02_cod_proy, inf.t40_anio, inf.t40_mes, inf.t40_periodo;
		END IF;
	ELSEIF var_type_user = 13 THEN 
	   IF var_all_proy = 1 THEN
           SELECT  inf.t02_cod_proy AS proy, 
                inf.t40_anio, 
                CONCAT('Año ',inf.t40_anio) AS anio,
                inf.t40_mes, 
                CONCAT('Mes ', inf.t40_mes) AS mes,
                DATE_FORMAT(inf.t40_fch_pre,'%d/%m/%Y') AS fec_pre, 
                inf.t40_periodo,
                fn_nom_mes(inf.t40_periodo) AS periodo,
                SUBSTRING(inf.t40_obs,1,205) AS observaciones,
                est1.descrip AS est_eje,
                est2.descrip AS est_moni,
                FORMAT(IFNULL(
                (
                SELECT SUM(gas.t41_gasto) 
                     FROM  t41_inf_financ_gasto gas 
                     WHERE gas.t02_cod_proy= inf.t02_cod_proy
                       AND gas.t40_anio=inf.t40_anio
                       AND gas.t40_mes=inf.t40_mes)
                ,0), 2) AS monto,
                fn_numero_mes(inf.t40_anio, inf.t40_mes) AS nummes,
                (CONCAT('Mes ', inf.t40_mes, ' (',fn_nom_mes(inf.t40_periodo), ')')) as descripcion,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM      t40_inf_financ  inf
            LEFT JOIN adm_tablas_aux  est1 ON (inf.t40_est_eje = est1.codi) 
            LEFT JOIN adm_tablas_aux  est2 ON (inf.t40_est_mon = est2.codi)
            WHERE inf.t40_est_eje = 46
            ORDER BY inf.t02_cod_proy, inf.t40_anio, inf.t40_mes, inf.t40_periodo;
        ELSE
            SELECT  inf.t02_cod_proy AS proy, 
                inf.t40_anio, 
                CONCAT('Año ',inf.t40_anio) AS anio,
                inf.t40_mes, 
                CONCAT('Mes ', inf.t40_mes) AS mes,
                DATE_FORMAT(inf.t40_fch_pre,'%d/%m/%Y') AS fec_pre, 
                inf.t40_periodo,
                fn_nom_mes(inf.t40_periodo) AS periodo,
                SUBSTRING(inf.t40_obs,1,205) AS observaciones,
                est1.descrip AS est_eje,
                est2.descrip AS est_moni,
                FORMAT(IFNULL(
                (
                SELECT SUM(gas.t41_gasto) 
                     FROM  t41_inf_financ_gasto gas 
                     WHERE gas.t02_cod_proy= inf.t02_cod_proy
                       AND gas.t40_anio=inf.t40_anio
                       AND gas.t40_mes=inf.t40_mes)
                ,0), 2) AS monto,
                fn_numero_mes(inf.t40_anio, inf.t40_mes) AS nummes,
                (CONCAT('Mes ', inf.t40_mes, ' (',fn_nom_mes(inf.t40_periodo), ')')) as descripcion,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM      t40_inf_financ  inf
            JOIN adm_usuarios u ON inf.t02_cod_proy = u.t02_cod_proy
            LEFT JOIN adm_tablas_aux  est1 ON (inf.t40_est_eje = est1.codi) 
            LEFT JOIN adm_tablas_aux  est2 ON (inf.t40_est_mon = est2.codi) 
            WHERE inf.t40_est_eje = 46
            AND u.coduser = _user
            ORDER BY inf.t02_cod_proy, inf.t40_anio, inf.t40_mes, inf.t40_periodo;
        END IF;
	END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_ind_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_ind_act`(IN _proy VARCHAR(10), IN _comp INT, IN _activ INT, _anio INT, _mes INT)
BEGIN
DECLARE _ver INT;

SELECT fn_ult_version_proy(_proy) INTO _ver ;

SELECT 	ind.t08_cod_comp,
	com.t08_comp_desc AS componente,
	ind.t09_cod_act,
	act.t09_act AS actividad,
	ind.t09_cod_act_ind,
	ind.t09_ind AS indicador,
	ind.t09_um,
	ind.t09_mta AS plan_mtatotal,
	
	SUM(CASE WHEN fn_numero_mes(mta.t09_ind_anio,mta.t09_ind_mes) < fn_numero_mes(_anio,_mes) THEN mta.t09_ind_mta ELSE 0 END) AS plan_mtaacum,
	SUM(CASE WHEN mta.t09_ind_anio=_anio AND mta.t09_ind_mes=_mes THEN mta.t09_ind_mta ELSE 0 END) AS plan_mtames,
	IFNULL((SELECT SUM(inf2.t09_ind_avanc) 
	 FROM t09_act_ind_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=ind.t02_cod_proy 
	   AND inf2.t08_cod_comp=ind.t08_cod_comp  
	   AND inf2.t09_cod_act=ind.t09_cod_act 
	   AND inf2.t09_cod_act_ind=ind.t09_cod_act_ind 
	   AND fn_numero_mes(inf2.t09_ind_anio,inf2.t09_ind_mes) < fn_numero_mes(_anio,_mes) 
	   
	 ),0) AS ejec_mtaacum,
	
	MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_mes=_mes THEN inf.t09_ind_avanc ELSE NULL END) AS ejec_mtames,
	IFNULL((SELECT SUM(inf2.t09_ind_avanc) 
	 FROM t09_act_ind_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=ind.t02_cod_proy 
	   AND inf2.t08_cod_comp=ind.t08_cod_comp  
	   AND inf2.t09_cod_act=ind.t09_cod_act 
	   AND inf2.t09_cod_act_ind=ind.t09_cod_act_ind 
	   AND fn_numero_mes(inf2.t09_ind_anio,inf2.t09_ind_mes) < fn_numero_mes(_anio,_mes) 
	   
	 ),0) AS ejec_mtatotal,
	
	MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_mes=_mes THEN inf.t09_descrip ELSE NULL END) AS descripcion,
	MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_mes=_mes THEN inf.t09_logros  ELSE NULL END) AS logros,
	MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_mes=_mes THEN inf.t09_dificul ELSE NULL END) AS dificultades,
	MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_mes=_mes THEN inf.t09_obs ELSE NULL END) AS observaciones
FROM  	   t09_act_ind ind
INNER JOIN t08_comp    com  ON(ind.t02_cod_proy=com.t02_cod_proy AND ind.t02_version=com.t02_version  AND ind.t08_cod_comp=com.t08_cod_comp )
INNER JOIN t09_act     act  ON(ind.t02_cod_proy=act.t02_cod_proy AND ind.t02_version=act.t02_version  AND ind.t08_cod_comp=act.t08_cod_comp AND ind.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_act_ind_mtas mta ON(ind.t02_cod_proy=mta.t02_cod_proy AND ind.t02_version=mta.t02_version  AND ind.t08_cod_comp=mta.t08_cod_comp  AND ind.t09_cod_act = mta.t09_cod_act AND ind.t09_cod_act_ind=mta.t09_cod_act_ind AND mta.t09_ind_anio<=_anio)
LEFT  JOIN t09_act_ind_mtas_inf inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp  AND ind.t09_cod_act=inf.t09_cod_act AND ind.t09_cod_act_ind=inf.t09_cod_act_ind AND inf.t09_ind_anio=_anio AND inf.t09_ind_mes=_mes  )
WHERE ind.t02_cod_proy = _proy
  AND ind.t02_version = _ver
  AND ind.t08_cod_comp = _comp
  AND ind.t09_cod_act = _activ
GROUP BY ind.t08_cod_comp, com.t08_comp_desc, ind.t09_cod_act, act.t09_act ,
	 ind.t09_cod_act_ind, ind.t09_um, ind.t09_ind, ind.t09_mta  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_ind_act_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_ind_act_trim`(	IN _proy varchar(10), 
					IN _comp int, 
					IN _activ int, 
					in _anio int, 
					in _trim int)
BEGIN
declare _mes int;
select (_trim * 3) into _mes; 
call sp_sel_inf_ind_act(_proy, _comp, _activ, _anio, _mes);
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_ind_prod_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_ind_prod_entregable`(IN _proy VARCHAR(10), 
                    IN _ver INT,
                    IN _comp INT,
                    IN _prod INT, 
                    IN _anio INT, 
                    IN _entregable INT)
BEGIN
    
    SELECT  ind.t08_cod_comp,
        com.t08_comp_desc AS componente,
        ind.t09_cod_act,
        act.t09_act AS actividad,
        ind.t09_cod_act_ind,
        ind.t09_ind AS indicador,
        ind.t09_um,
        ind.t09_mta AS plan_mtatotal,
        
        
        IFNULL(
        (SELECT e.t09_cod_act_ind_val 
         FROM t02_entregable_act_ind e 
         WHERE e.t02_cod_proy=ind.t02_cod_proy 
           AND e.t02_version=ind.t02_version
           AND e.t08_cod_comp=ind.t08_cod_comp 
           AND e.t09_cod_act=ind.t09_cod_act
           AND e.t09_cod_act_ind=ind.t09_cod_act_ind
           AND e.t02_anio = _anio
           AND e.t02_mes = _entregable
         ), 0) AS plan_mtames,
        IFNULL(MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_entregable=_entregable THEN inf.t09_ind_avanc ELSE NULL END), 0) AS ejec_mtames,
        IFNULL((SELECT SUM(inf2.t09_ind_avanc) 
         FROM t09_entregable_ind_inf inf2 
         WHERE inf2.t02_cod_proy=ind.t02_cod_proy 
           AND inf2.t08_cod_comp=ind.t08_cod_comp  
           AND inf2.t09_cod_prod=ind.t09_cod_act 
           AND inf2.t09_cod_prod_ind=ind.t09_cod_act_ind 
           AND fn_numero_entregable(ind.t02_cod_proy, ind.t02_version, inf2.t09_ind_anio, inf2.t09_ind_entregable) <= fn_numero_entregable(ind.t02_cod_proy, ind.t02_version, _anio, _entregable) 
         ), 0) AS ejec_mtatotal,
        MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_entregable=_entregable THEN inf.t09_descrip ELSE NULL END) AS descripcion,
        MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_entregable=_entregable THEN inf.t09_logros  ELSE NULL END) AS logros,
        MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_entregable=_entregable THEN inf.t09_dificul ELSE NULL END) AS dificultades,
        MAX(CASE WHEN inf.t09_ind_anio=_anio AND inf.t09_ind_entregable=_entregable THEN inf.t09_obs ELSE NULL END) AS observaciones
    FROM       t09_act_ind ind
    INNER JOIN t08_comp    com  ON(ind.t02_cod_proy=com.t02_cod_proy AND ind.t02_version=com.t02_version AND ind.t08_cod_comp=com.t08_cod_comp )
    INNER JOIN t09_act     act  ON(ind.t02_cod_proy=act.t02_cod_proy AND ind.t02_version=act.t02_version AND ind.t08_cod_comp=act.t08_cod_comp AND ind.t09_cod_act=act.t09_cod_act)
    LEFT JOIN t09_entregable_ind_inf inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp  AND ind.t09_cod_act=inf.t09_cod_prod AND ind.t09_cod_act_ind=inf.t09_cod_prod_ind AND inf.t09_ind_anio=_anio AND inf.t09_ind_entregable=_entregable)
    
    LEFT JOIN t02_entregable_act_ind prog ON(ind.t02_cod_proy=prog.t02_cod_proy AND ind.t02_version=prog.t02_version AND ind.t08_cod_comp=prog.t08_cod_comp AND ind.t09_cod_act = prog.t09_cod_act AND ind.t09_cod_act_ind=prog.t09_cod_act_ind AND prog.t02_anio=_anio AND prog.t02_mes=_entregable)
    WHERE ind.t02_cod_proy = _proy
      AND ind.t02_version = _ver
      AND ind.t08_cod_comp = _comp
      AND ind.t09_cod_act = _prod
      AND ind.t09_ind <> '' 
    GROUP BY ind.t08_cod_comp, com.t08_comp_desc, ind.t09_cod_act, act.t09_act,
         ind.t09_cod_act_ind, ind.t09_um, ind.t09_ind, ind.t09_mta;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_ind_prod_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_ind_prod_se`(IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _comp INT, 
                        IN _prod INT, 
                        IN _anio INT,
                        IN _entregable INT)
BEGIN
    SELECT ind.t08_cod_comp,
        com.t08_comp_desc AS componente,
        ind.t09_cod_act,
        act.t09_act AS actividad,
        ind.t09_cod_act_ind,
        ind.t09_ind AS indicador,
        ind.t09_um,
        ind.t09_mta AS plan_mtatotal,
        IFNULL(
        (SELECT e.t09_cod_act_ind_val 
         FROM t02_entregable_act_ind e 
         WHERE e.t02_cod_proy=ind.t02_cod_proy 
           AND e.t02_version=ind.t02_version
           AND e.t08_cod_comp=ind.t08_cod_comp 
           AND e.t09_cod_act=ind.t09_cod_act
           AND e.t09_cod_act_ind=ind.t09_cod_act_ind
           AND e.t02_anio = _anio
           AND e.t02_mes = _entregable
         ), 0) AS meta_al_entregable,
        IFNULL(
        (SELECT SUM(a.t09_ind_avanc) 
         FROM t09_entregable_ind_inf a 
         WHERE a.t02_cod_proy=ind.t02_cod_proy 
           AND a.t08_cod_comp=ind.t08_cod_comp 
           AND a.t09_cod_prod=ind.t09_cod_act
           AND a.t09_cod_prod_ind=ind.t09_cod_act_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL a.t09_ind_anio YEAR), INTERVAL a.t09_ind_entregable MONTH) < DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtaacum,
        IFNULL(
        (SELECT SUM(b.t09_ind_avanc) 
         FROM t09_entregable_ind_inf b 
         WHERE b.t02_cod_proy=ind.t02_cod_proy 
           AND b.t08_cod_comp=ind.t08_cod_comp 
           AND b.t09_cod_prod=ind.t09_cod_act
           AND b.t09_cod_prod_ind=ind.t09_cod_act_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL b.t09_ind_anio YEAR), INTERVAL b.t09_ind_entregable MONTH) = DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_avance,
        IFNULL(
        (SELECT SUM(c.t09_ind_avanc) 
         FROM t09_entregable_ind_inf c 
         WHERE c.t02_cod_proy=ind.t02_cod_proy 
           AND c.t08_cod_comp=ind.t08_cod_comp 
           AND c.t09_cod_prod=ind.t09_cod_act
           AND c.t09_cod_prod_ind=ind.t09_cod_act_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL c.t09_ind_anio YEAR), INTERVAL c.t09_ind_entregable MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtatotal,
        inf.t09_obs AS obs,
        inf.t09_avance AS avance
    FROM t09_act_ind ind
    INNER JOIN t08_comp com ON(ind.t02_cod_proy=com.t02_cod_proy AND ind.t02_version=com.t02_version AND ind.t08_cod_comp=com.t08_cod_comp)
    INNER JOIN t09_act act ON(ind.t02_cod_proy=act.t02_cod_proy AND ind.t02_version=act.t02_version AND ind.t08_cod_comp=act.t08_cod_comp AND ind.t09_cod_act=act.t09_cod_act)
    LEFT  JOIN t09_prod_ind_inf_se inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp  AND ind.t09_cod_act=inf.t09_cod_prod AND ind.t09_cod_act_ind=inf.t09_cod_prod_ind AND inf.t02_anio=_anio AND inf.t02_entregable=_entregable)
    WHERE ind.t02_cod_proy = _proy
      AND ind.t02_version = _ver
      AND ind.t08_cod_comp = _comp
      AND ind.t09_cod_act = _prod
    GROUP BY ind.t08_cod_comp, com.t08_comp_desc, ind.t09_cod_act, act.t09_act,
         ind.t09_cod_act_ind, ind.t09_um, ind.t09_ind, ind.t09_mta;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_ind_prod_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_ind_prod_si`(IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _comp INT, 
                        IN _prod INT, 
                        IN _anio INT,
                        IN _entregable INT)
BEGIN
    SELECT ind.t08_cod_comp,
        com.t08_comp_desc AS componente,
        ind.t09_cod_act,
        act.t09_act AS actividad,
        ind.t09_cod_act_ind,
        ind.t09_ind AS indicador,
        ind.t09_um,
        ind.t09_mta AS plan_mtatotal,
        IFNULL(
        (SELECT e.t09_cod_act_ind_val 
         FROM t02_entregable_act_ind e 
         WHERE e.t02_cod_proy=ind.t02_cod_proy 
           AND e.t02_version=ind.t02_version
           AND e.t08_cod_comp=ind.t08_cod_comp 
           AND e.t09_cod_act=ind.t09_cod_act
           AND e.t09_cod_act_ind=ind.t09_cod_act_ind
           AND e.t02_anio = _anio
           AND e.t02_mes = _entregable
         ), 0) AS meta_al_entregable,
        IFNULL(
        (SELECT SUM(a.t09_ind_avanc) 
         FROM t09_entregable_ind_inf a 
         WHERE a.t02_cod_proy=ind.t02_cod_proy 
           AND a.t08_cod_comp=ind.t08_cod_comp 
           AND a.t09_cod_prod=ind.t09_cod_act
           AND a.t09_cod_prod_ind=ind.t09_cod_act_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL a.t09_ind_anio YEAR), INTERVAL a.t09_ind_entregable MONTH) < DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtaacum,
        IFNULL(
        (SELECT SUM(b.t09_ind_avanc) 
         FROM t09_entregable_ind_inf b 
         WHERE b.t02_cod_proy=ind.t02_cod_proy 
           AND b.t08_cod_comp=ind.t08_cod_comp 
           AND b.t09_cod_prod=ind.t09_cod_act
           AND b.t09_cod_prod_ind=ind.t09_cod_act_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL b.t09_ind_anio YEAR), INTERVAL b.t09_ind_entregable MONTH) = DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_avance,
        IFNULL(
        (SELECT SUM(c.t09_ind_avanc) 
         FROM t09_entregable_ind_inf c 
         WHERE c.t02_cod_proy=ind.t02_cod_proy 
           AND c.t08_cod_comp=ind.t08_cod_comp 
           AND c.t09_cod_prod=ind.t09_cod_act
           AND c.t09_cod_prod_ind=ind.t09_cod_act_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL c.t09_ind_anio YEAR), INTERVAL c.t09_ind_entregable MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtatotal,
        inf.t09_obs AS obs,
        inf.t09_avance AS avance
    FROM t09_act_ind ind
    INNER JOIN t08_comp com ON(ind.t02_cod_proy=com.t02_cod_proy AND ind.t02_version=com.t02_version AND ind.t08_cod_comp=com.t08_cod_comp)
    INNER JOIN t09_act act ON(ind.t02_cod_proy=act.t02_cod_proy AND ind.t02_version=act.t02_version AND ind.t08_cod_comp=act.t08_cod_comp AND ind.t09_cod_act=act.t09_cod_act)
    LEFT  JOIN t09_prod_ind_inf_si inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp  AND ind.t09_cod_act=inf.t09_cod_prod AND ind.t09_cod_act_ind=inf.t09_cod_prod_ind AND inf.t02_anio=_anio AND inf.t02_entregable=_entregable)
    WHERE ind.t02_cod_proy = _proy
      AND ind.t02_version = _ver
      AND ind.t08_cod_comp = _comp
      AND ind.t09_cod_act = _prod
    GROUP BY ind.t08_cod_comp, com.t08_comp_desc, ind.t09_cod_act, act.t09_act,
         ind.t09_cod_act_ind, ind.t09_um, ind.t09_ind, ind.t09_mta;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mes`(IN _proy VARCHAR(10), 
 IN _anio INT)
BEGIN
DECLARE _fec_ini DATETIME;
SELECT t02_fch_ini  INTO _fec_ini
FROM t02_dg_proy 
WHERE t02_cod_proy = _proy 
AND t02_version  = fn_ult_version_proy(_proy) ;
  
SELECT 	inf.t02_cod_proy, 
	inf.t20_anio, 
	CONCAT('Año ',t20_anio) AS anio,
	inf.t20_mes, 
	CONCAT('Mes ', t20_mes) AS mes,
	inf.t20_ver_inf AS vsinf, 
	DATE_FORMAT(inf.t20_fch_pre,'%d/%m/%Y') AS fec_pre, 
	inf.t20_periodo AS periodo, 
	inf.t20_apro_mt AS apruba_mt, 
	inf.t20_apro_fch AS fec_aprueba, 
	SUBSTRING(inf.t20_dificul,1,205) AS dificultades,
	est.descrip AS estado,
	fn_numero_mes(inf.t20_anio, inf.t20_mes) AS nummes,
	DATE_FORMAT(DATE_ADD(_fec_ini,INTERVAL fn_numero_mes(inf.t20_anio, inf.t20_mes) MONTH),'%d/%m/%Y') AS fec_plan,
	fn_porc_cump_inf_mes(inf.t02_cod_proy, inf.t20_anio, inf.t20_mes) AS cump_mes,
	fn_porc_cump_inf_mes_acum(inf.t02_cod_proy, inf.t20_anio, inf.t20_mes) AS cump_acum_mes
FROM  t20_inf_mes inf
LEFT JOIN adm_tablas_aux est ON (inf.t20_estado = est.codi) 
WHERE   inf.t02_cod_proy = _proy
	AND inf.t20_anio = (CASE WHEN _anio > 0 THEN _anio ELSE inf.t20_anio END)
	AND inf.t20_ver_inf = (SELECT MAX(v.t20_ver_inf) FROM t20_inf_mes v WHERE v.t02_cod_proy=inf.t02_cod_proy AND v.t20_anio=inf.t20_anio AND v.t20_mes=inf.t20_mes) 
ORDER BY inf.t20_anio, inf.t20_mes, t20_fch_pre ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mes_vb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_mes_vb`(IN _user VARCHAR(10))
BEGIN
    DECLARE var_all_proy INT DEFAULT 0;
    DECLARE var_type_user INT DEFAULT 0;
    
    SELECT IF(t02_cod_proy = '*', 1, 0), tipo_user INTO var_all_proy, var_type_user FROM adm_usuarios WHERE coduser = _user;
    
    IF var_type_user = 16 THEN  
        IF var_all_proy = 1 THEN
			SELECT inf.t02_cod_proy AS proy, 
                inf.t20_anio, 
                CONCAT('Año ',t20_anio) AS anio,
                inf.t20_mes, 
                CONCAT('Mes ', t20_mes) AS mes,
                inf.t20_ver_inf AS vsinf, 
                DATE_FORMAT(inf.t20_fch_pre,'%d/%m/%Y') AS fec_pre, 
                inf.t20_periodo AS periodo, 
                inf.t20_apro_fch AS fec_aprueba, 
                SUBSTRING(inf.t20_dificul,1,205) AS dificultades,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t20_inf_mes inf, adm_tablas_aux est
            WHERE inf.t20_estado = est.codi 
            AND inf.t20_estado = 46
            AND inf.vb_se = 0
            ORDER BY inf.t02_cod_proy, inf.t20_anio, inf.t20_mes, t20_fch_pre;
		ELSE
            SELECT inf.t02_cod_proy AS proy, 
                inf.t20_anio, 
                CONCAT('Año ',t20_anio) AS anio,
                inf.t20_mes, 
                CONCAT('Mes ', t20_mes) AS mes,
                inf.t20_ver_inf AS vsinf, 
                DATE_FORMAT(inf.t20_fch_pre,'%d/%m/%Y') AS fec_pre, 
                inf.t20_periodo AS periodo, 
                inf.t20_apro_fch AS fec_aprueba, 
                SUBSTRING(inf.t20_dificul,1,205) AS dificultades,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t20_inf_mes inf, adm_usuarios u, adm_tablas_aux est
            WHERE inf.t02_cod_proy = u.t02_cod_proy
            AND inf.t20_estado = est.codi 
            AND inf.t20_estado = 46
            AND inf.vb_se = 0
            AND u.coduser = _user
            ORDER BY inf.t02_cod_proy, inf.t20_anio, inf.t20_mes, t20_fch_pre;
        END IF;
    ELSEIF var_type_user = 13 THEN 
        IF var_all_proy = 1 THEN
            SELECT inf.t02_cod_proy AS proy, 
                inf.t20_anio, 
                CONCAT('Año ',t20_anio) AS anio,
                inf.t20_mes, 
                CONCAT('Mes ', t20_mes) AS mes,
                inf.t20_ver_inf AS vsinf, 
                DATE_FORMAT(inf.t20_fch_pre,'%d/%m/%Y') AS fec_pre, 
                inf.t20_periodo AS periodo, 
                inf.t20_apro_fch AS fec_aprueba, 
                SUBSTRING(inf.t20_dificul,1,205) AS dificultades,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t20_inf_mes inf, adm_tablas_aux est
            WHERE inf.t20_estado = est.codi 
            AND inf.t20_estado = 46
            ORDER BY inf.t02_cod_proy, inf.t20_anio, inf.t20_mes, t20_fch_pre;
        ELSE
            SELECT inf.t02_cod_proy AS proy, 
                inf.t20_anio, 
                CONCAT('Año ',t20_anio) AS anio,
                inf.t20_mes, 
                CONCAT('Mes ', t20_mes) AS mes,
                inf.t20_ver_inf AS vsinf, 
                DATE_FORMAT(inf.t20_fch_pre,'%d/%m/%Y') AS fec_pre, 
                inf.t20_periodo AS periodo, 
                inf.t20_apro_fch AS fec_aprueba, 
                SUBSTRING(inf.t20_dificul,1,205) AS dificultades,
                est.descrip AS estado,
                IF(inf.vb_se = 1, 'V°B°', '') AS vb_se
            FROM  t20_inf_mes inf, adm_usuarios u, adm_tablas_aux est
            WHERE inf.t02_cod_proy = u.t02_cod_proy
            AND inf.t20_estado = est.codi 
            AND inf.t20_estado = 46
            AND u.coduser = _user
            ORDER BY inf.t02_cod_proy, inf.t20_anio, inf.t20_mes, t20_fch_pre;
        END IF;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_anexos`(
				IN _proy VARCHAR(10), 
				IN _Num INT
				)
BEGIN
SELECT 	anx.t51_cod_anx,
	anx.t51_nom_file,
	anx.t51_url_file,
	anx.t51_desc_file
FROM t51_inf_mf_anexos anx
WHERE  anx.t02_cod_proy=_proy 
  AND  anx.t51_id    = _Num ;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_act`(IN _proy VARCHAR(10), 
   IN _comp INT, 	    IN _num INT  ,	    IN _idFte INT)
BEGIN
DECLARE _ver     INT ;
DECLARE _verIni  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT t51_per_ini, t51_per_fin
  INTO _mes_ini, _mes_fin 
FROM t51_inf_mf inf
WHERE t02_cod_proy = _proy
  AND t51_num = _num ;
  
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1)    ),1) ;
SELECT fn_pri_version_proy(_proy) INTO _verIni ;
  
  
SELECT
  act.t09_cod_act,
  CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
  act.t09_act AS actividad,
  SUM(cost.t10_cost_parc * sub.t09_mta_repro)  AS total_presup,
  
   SUM(fn_monto_planificado_fte_periodo(cost.t02_cod_proy, cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , cost.t10_cod_cost,
				         _idFte, _mes_ini, _mes_fin)) AS programado,
				         
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy  = cost.t02_cod_proy
       AND gas.t08_cod_comp  = cost.t08_cod_comp
       AND gas.t09_cod_act   = cost.t09_cod_act
       AND gas.t41_fte_finan = _idFte
       AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado
FROM       t09_subact sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
INNER JOIN t09_act 	act  ON(sub.t02_cod_proy = act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version= _ver
  AND sub.t08_cod_comp= _comp
GROUP BY 1, 2, 3
ORDER BY act.t08_cod_comp, act.t09_cod_act ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_act2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_act2`(IN _proy VARCHAR(10), 
					     IN _comp INT, 
					     IN _num INT  )
BEGIN
DECLARE _ver     INT ;
declare _verIni  int ;
declare _mes_ini int ;
DECLARE _mes_fin INT ;
select t51_per_ini, t51_per_fin
  into _mes_ini, _mes_fin 
from t51_inf_mf inf
where t02_cod_proy = _proy
  and t51_num = _num ;
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1)    ),1) ;
set _verIni =  fn_pri_version_proy(_proy) ;
SELECT
  act.t09_cod_act,
  CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
  act.t09_act AS actividad,
  NULL as total_meta,
  
  
  SUM(cost.t10_cost_parc * sub.t09_mta_repro)  AS total_presup 
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
INNER JOIN t09_act      act  ON(sub.t02_cod_proy = act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version = _ver
  AND sub.t08_cod_comp= _comp
GROUP BY 1, 2, 3
ORDER BY act.t08_cod_comp, act.t09_cod_act ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_equi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_equi`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	DECLARE _equipa INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 2, 3 INTO _comp, _act, _equipa ;
SELECT  equi.t03_id_equi, 
	CONCAT(_comp,'.',_act,'.', _equipa, '.' , equi.t03_id_equi) AS codigo, 
	equi.t03_nom_equi AS equipo, 
	equi.t03_um AS um,
	equi.t03_costo AS costo,
	
	
	(
	SELECT SUM(e.t03_costo_tot) 
	  FROM t03_mp_equi e 
	 WHERE e.t02_cod_proy = equi.t02_cod_proy
	   AND e.t02_version  = 1
	   AND e.t03_id_equi  = equi.t03_id_equi
	) AS costo_tot,	
	IFNULL((SELECT SUM(t03_mta) 
	 FROM t03_mp_equi_metas mta 
	 WHERE equi.t02_cod_proy=mta.t02_cod_proy 
	   AND equi.t02_version=mta.t02_version 
	   AND equi.t03_id_equi=mta.t03_id_equi
	   and mta.t03_anio    = _ver
	 ),0) AS meta,
	(
	 SELECT   SUM(t03_monto) 
	 FROM t03_mp_equi_ftes f
	 WHERE f.t02_cod_proy = equi.t02_cod_proy
	   AND f.t02_version  = _ver 
	   AND f.t03_id_equi  = equi.t03_id_equi
	   AND f.t03_id_inst  = _cod_fte
	) AS total_fuente,
	fn_monto_planificado_mp_fte_periodo( equi.t02_cod_proy, 
						  equi.t02_version,
						  2,
						  0,
						  equi.t03_id_equi,
						  _cod_fte,
						  _mes_ini,
						  _mes_fin
						) AS planeado,
	
	 IFNULL(((SELECT SUM(gas.t41_gasto)
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=equi.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _equipa 
	       AND gas.t41_cate_gasto = equi.t03_id_equi
	       AND gas.t41_fte_finan=_cod_fte
				 and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	 )),0) AS ejecutado,
	 
	 ((SELECT MAX(gas.t41_obs)
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=equi.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _equipa 
	       AND gas.t41_cate_gasto = equi.t03_id_equi
	       AND gas.t41_fte_finan=_cod_fte
	       and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	 )) AS observ,
	 m.t51_obs AS observaciones,
	 (SELECT IFNULL(SUM(na.t09_mto_no_acept),0) FROM t51_inf_mf_gastos_no_aceptados na WHERE (na.t51_num = _num AND na.t02_cod_proy = equi.t02_cod_proy AND na.t08_cod_comp = 10 AND na.t09_cod_act = 2 AND na.t09_cod_sub = 3 AND na.t09_cod_sub_cat = equi.t03_id_equi and na.t51_fuente = _cod_fte)) AS gasto_no_aceptado
	 
FROM t03_mp_equi equi
LEFT JOIN t51_inf_mf_avance_monto m on (m.t51_num = _num AND m.t02_cod_proy = equi.t02_cod_proy AND m.t08_cod_comp = 2 AND m.t09_cod_act = 3 AND m.t09_cod_sub = equi.t03_id_equi and m.t51_fuente = _cod_fte)
WHERE equi.t02_cod_proy = _proy
  AND equi.t02_version  = _ver
GROUP BY 2;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_equi_total` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_equi_total`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	DECLARE _equipa INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 2, 3 INTO _comp, _act, _equipa ;
SELECT  
	(
	SELECT SUM(e.t03_costo_tot) 
	FROM t03_mp_equi e 
	WHERE e.t02_cod_proy=equi.t02_cod_proy
	AND e.t02_version = _ver
	) AS gasto_tot,	
	
	SUM(fn_monto_total_planificado_mp_fte( equi.t02_cod_proy, 
					       equi.t02_version,
					       2,
					       0,
					       equi.t03_id_equi,
					       _cod_fte
					   )) AS total_fuente,
	IFNULL(SUM(fn_monto_planificado_mp_fte_periodo( equi.t02_cod_proy, 
						  equi.t02_version,
						  2,
						  0,
						  equi.t03_id_equi,
						  _cod_fte,
						  _mes_ini,
						  _mes_fin
						)),0) AS planeado,
	
	 IFNULL(SUM((SELECT gas.t41_gasto
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=equi.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _equipa
	       AND gas.t41_cate_gasto = equi.t03_id_equi
	       AND gas.t41_fte_finan=_cod_fte
				 and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	 )),0) AS ejecutado
	 
FROM t03_mp_equi equi 
WHERE equi.t02_cod_proy=_proy
  AND equi.t02_version = _ver_anio ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_gast_adm` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_gast_adm`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
DECLARE _sub  INT ;
DECLARE _cat  INT ;
DECLARE _gastos_adm INT ;
DECLARE _ejecutado DOUBLE;
DECLARE _comentarios TEXT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 4, 0, 0 INTO _comp, _act, _sub , _cat ;
SELECT IFNULL(SUM(t03_monto),0) 
	  INTO _gastos_adm
	  FROM t03_mp_gas_adm
	 WHERE t02_cod_proy = _proy 
	   AND t02_version  = _ver  ;
	   
SELECT SUM(t41_gasto), MAX(t41_obs)
  INTO _ejecutado , _comentarios
  FROM  t41_inf_financ_gasto  
 WHERE t02_cod_proy = _proy
   AND t08_cod_comp   = _comp
   AND t09_cod_act    = _act
   AND t09_cod_sub    = _sub 
   AND t41_cate_gasto = _cat
   AND t41_fte_finan  = _cod_fte
	 and (fn_numero_mes(t40_anio, t40_mes) BETWEEN _mes_ini AND _mes_fin);
   
SELECT 	CONCAT(_comp,'.',_act )  AS codigo, 
	'Gastos Administrativos' AS descripcion,
	_gastos_adm AS gasto_tot,
	fn_monto_total_planificado_mp_fte   (_proy , _ver, _act, 0, NULL, _cod_fte) AS total_fuente,
	fn_monto_planificado_mp_fte_periodo( _proy, _ver, _act, 0, NULL, _cod_fte, _mes_ini, _mes_fin) AS planeado,
	_ejecutado AS ejecutado,
	_comentarios AS observ ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_gast_func` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_gast_func`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	DECLARE _equipa INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 3 INTO _comp, _act ;
SELECT 	SUM((gast.t03_cu * gast.t03_cant) * parti.t03_meta) AS gasto_tot,
	(
	 SELECT   SUM(t03_monto) 
	 FROM t03_mp_gas_fun_ftes f
	 WHERE f.t02_cod_proy=gast.t02_cod_proy 
	   AND f.t02_version =gast.t02_version  
	   
	   AND f.t03_id_inst = _cod_fte
	) AS total_fuente,			   
	SUM(fn_monto_planificado_mp_fte_periodo( gast.t02_cod_proy, 
						  gast.t02_version,
						  3,
						  gast.t03_partida,
						  gast.t03_id_gasto,
						  _cod_fte,
						  _mes_ini,
						  _mes_fin
						)) AS planeado,
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=gast.t02_cod_proy
	      
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       
	       
	       AND gas.t41_fte_finan = _cod_fte
				and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	),0) AS ejecutado
	
FROM 	   t03_mp_gas_fun_cost gast
INNER JOIN t03_mp_gas_fun_part parti ON (gast.t02_cod_proy=parti.t02_cod_proy AND gast.t02_version=parti.t02_version AND gast.t03_partida=parti.t03_partida)
LEFT JOIN  adm_tablas_aux p ON (gast.t03_partida=p.codi)
LEFT JOIN  adm_tablas_aux c ON (gast.t03_cat_gast=c.codi)
WHERE gast.t02_cod_proy = _proy
  AND gast.t02_version  = _ver ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_gast_func_total` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_gast_func_total`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	DECLARE _equipa INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 3 INTO _comp, _act ;
SELECT 	SUM((gast.t03_cu * gast.t03_cant) * parti.t03_meta) AS gasto_tot,
	(
	 SELECT   SUM(t03_monto) 
	 FROM t03_mp_gas_fun_ftes f
	 WHERE f.t02_cod_proy=gast.t02_cod_proy 
	   AND f.t02_version =gast.t02_version  
	   
	   AND f.t03_id_inst = _cod_fte
	) AS total_fuente,
				   
	SUM(fn_monto_planificado_mp_fte_periodo( gast.t02_cod_proy, 
						  gast.t02_version,
						  3,
						  gast.t03_partida,
						  gast.t03_id_gasto,
						  _cod_fte,
						  _mes_ini,
						  _mes_fin
						)) AS planeado,
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=gast.t02_cod_proy
	      
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       
	       
	       AND gas.t41_fte_finan = _cod_fte
				and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	),0) AS ejecutado
	
FROM 	   t03_mp_gas_fun_cost gast
INNER JOIN t03_mp_gas_fun_part parti ON (gast.t02_cod_proy=parti.t02_cod_proy AND gast.t02_version=parti.t02_version AND gast.t03_partida=parti.t03_partida)
LEFT JOIN  adm_tablas_aux p ON (gast.t03_partida=p.codi)
LEFT JOIN  adm_tablas_aux c ON (gast.t03_cat_gast=c.codi)
WHERE gast.t02_cod_proy = _proy
  AND gast.t02_version  = _ver ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_imprevistos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_imprevistos`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
DECLARE _sub  INT ;
DECLARE _cat  INT ;
DECLARE _imprev INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 6, 0, 0 INTO _comp, _act, _sub , _cat ;
SELECT IFNULL(SUM(t03_monto),0) 
	  INTO _imprev
	  FROM t03_mp_imprevistos
	 WHERE t02_cod_proy = _proy 
	   AND t02_version  = _ver  ;
SELECT 	CONCAT(_comp,'.',_act )  AS codigo, 
	'Imprevistos' AS descripcion,
	_imprev AS gasto_tot,
	fn_monto_total_planificado_mp_fte   (_proy , _ver, _act, 0, NULL, _cod_fte) AS total_fuente,
	fn_monto_planificado_mp_fte_periodo( _proy, _ver, _act, 0, NULL, _cod_fte, _mes_ini, _mes_fin) AS planeado,
	(  SELECT SUM(gas.t41_gasto) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy = _proy
	       
	       AND gas.t08_cod_comp   = _comp
	       AND gas.t09_cod_act    = _act
	       AND gas.t09_cod_sub    = _sub 
	       AND gas.t41_cate_gasto = _cat
	       AND gas.t41_fte_finan  = _cod_fte
	       and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	 ) AS ejecutado,
	 
	 (  SELECT MAX(gas.t41_obs) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy= _proy
	       
	       AND gas.t08_cod_comp   = _comp
	       AND gas.t09_cod_act    = _act
	       AND gas.t09_cod_sub    = _sub
	       AND gas.t41_cate_gasto = _cat	       
	       AND gas.t41_fte_finan  =_cod_fte
	       and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	 ) AS observ ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_list` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_list`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 3  INTO _comp, _act ;
SELECT  CONCAT(_comp,'.', _act,'.', p.cod_ext) AS codigo,
	parti.t03_partida  AS idpartida,
	p.descrip 	   AS partida,
	parti.t03_um   	   AS um,
	parti.t03_meta	   AS meta,
IFNULL((
	    SELECT (IFNULL( SUM(t03_cu * t03_cant),0) * personalizado.t03_meta)
	     FROM  t03_mp_gas_fun_part personalizado
	     WHERE personalizado.t02_cod_proy = _proy
				AND personalizado.t02_version = 1
				AND personalizado.t03_partida = parti.t03_partida
	),0) AS gasto_tot,
 
	
	SUM(fn_monto_total_planificado_mp_fte( gast.t02_cod_proy, 
					       gast.t02_version,
					       3,
					       gast.t03_partida,
					       gast.t03_id_gasto,
					       _cod_fte
					   )) AS total_fuente,
					   
	SUM(fn_monto_planificado_mp_fte_periodo( gast.t02_cod_proy, 
						  gast.t02_version,
						  3,
						  gast.t03_partida,
						  gast.t03_id_gasto,
						  _cod_fte,
						  _mes_ini,
						  _mes_fin
						)) AS planeado,
	
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=parti.t02_cod_proy
	      
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       
	        AND gas.t09_cod_sub = p.cod_ext 
	       AND gas.t41_fte_finan=_cod_fte 
	       and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	),0) AS ejecutado
	
FROM  	  t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux      p     ON(parti.t03_partida=p.codi)
LEFT JOIN t03_mp_gas_fun_cost gast  ON(parti.t02_cod_proy=gast.t02_cod_proy AND parti.t02_version=gast.t02_version AND parti.t03_partida=gast.t03_partida)
LEFT JOIN  adm_tablas_aux     c     ON (gast.t03_cat_gast=c.codi)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version = _ver
GROUP BY  1,2,3,4,5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_partida` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_partida`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 3  INTO _comp, _act ;
SELECT  CONCAT(_comp,'.', _act,'.', p.cod_ext) AS codigo,
	parti.t03_partida  AS idpartida,
	p.descrip 	   AS partida,
	parti.t03_um   	   AS um,
	parti.t03_meta	   AS meta,
IFNULL((
	    SELECT (IFNULL( SUM(t03_cu * t03_cant),0) * personalizado.t03_meta)
	     FROM  t03_mp_gas_fun_part personalizado
	     WHERE personalizado.t02_cod_proy = _proy
				AND personalizado.t02_version = 1
				AND personalizado.t03_partida = parti.t03_partida
	),0) AS gasto_tot,
 
	
	SUM(fn_monto_total_planificado_mp_fte( gast.t02_cod_proy, 
					       gast.t02_version,
					       3,
					       gast.t03_partida,
					       gast.t03_id_gasto,
					       _cod_fte
					   )) AS total_fuente,
					   
	SUM(fn_monto_planificado_mp_fte_periodo( gast.t02_cod_proy, 
						  gast.t02_version,
						  3,
						  gast.t03_partida,
						  gast.t03_id_gasto,
						  _cod_fte,
						  _mes_ini,
						  _mes_fin
						)) AS planeado,
	
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=parti.t02_cod_proy
	      
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       
	        AND gas.t09_cod_sub = p.cod_ext 
	       AND gas.t41_fte_finan=_cod_fte 
	       and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	),0) AS ejecutado
	
FROM  	  t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux      p     ON(parti.t03_partida=p.codi)
LEFT JOIN t03_mp_gas_fun_cost gast  ON(parti.t02_cod_proy=gast.t02_cod_proy AND parti.t02_version=gast.t02_version AND parti.t03_partida=gast.t03_partida)
LEFT JOIN  adm_tablas_aux     c     ON (gast.t03_cat_gast=c.codi)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version = _ver

GROUP BY  1,2,3,4,5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_per` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_per`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	DECLARE _rem INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 1, 12 INTO _comp, _act, _rem ;
SELECT  per.t03_id_per, 
	CONCAT(_comp,'.',_act,'.', _rem, '.' , per.t03_id_per) AS codigo, 
	per.t03_nom_per AS cargo, 
	aux.abrev AS um,
	per.t03_remu_prom AS promedio,	
	ifnull(( SELECT SUM(t03_mta) 
	    FROM t03_mp_per_metas mta
	   WHERE mta.t02_cod_proy=per.t02_cod_proy
	     AND mta.t02_version = per.t02_version
	     AND mta.t03_id_per  = per.t03_id_per
	     and (fn_numero_mes(mta.t03_anio,mta.t03_mes) BETWEEN _mes_ini AND _mes_fin)
	   ),0) as meta,
	
	(
	SELECT SUM(p.t03_gasto_tot)
	FROM t03_mp_per p
	WHERE p.t02_cod_proy=per.t02_cod_proy
	AND p.t02_version = 1
	AND p.t03_id_per = per.t03_id_per
	) AS gasto_tot,	
	fn_monto_planificado_mp_fte_periodo( per.t02_cod_proy, 
						 per.t02_version,
						 1,
						 0,
						 per.t03_id_per,
						 _cod_fte,
						 _mes_ini,
						 _mes_fin 
						) AS planeado,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_per_ftes fte
	 WHERE fte.t02_cod_proy=per.t02_cod_proy
	   AND fte.t02_version = per.t02_version
	   AND fte.t03_id_per  =per.t03_id_per
	   AND fte.t03_id_inst = _cod_fte
	) AS total_fuente,					
					   
	 (  SELECT SUM(gas.t41_gasto) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=per.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _rem 
	       AND gas.t41_cate_gasto = per.t03_id_per
	       AND gas.t41_fte_finan=_cod_fte
				 and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	 ) AS ejecutado,
	 
	 (  SELECT MAX(gas.t41_obs) 
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=per.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _rem
	       AND gas.t41_cate_gasto = per.t03_id_per
	       AND gas.t41_fte_finan=_cod_fte
	       and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	 ) AS observ,
	 m.t51_obs AS observaciones,
	 (SELECT IFNULL(SUM(na.t09_mto_no_acept),0) FROM t51_inf_mf_gastos_no_aceptados na  WHERE (na.t51_num = _num AND na.t02_cod_proy = per.t02_cod_proy AND na.t08_cod_comp = 10 AND na.t09_cod_act = 1 AND na.t09_cod_sub = 12 AND na.t09_cod_sub_cat = per.t03_id_per and na.t51_fuente = _cod_fte)) AS gasto_no_aceptado
FROM t03_mp_per per
INNER JOIN t51_inf_mf_avance_monto m on (m.t51_num = _num AND m.t02_cod_proy = per.t02_cod_proy AND m.t08_cod_comp = 1 AND m.t09_cod_act = 12 AND m.t09_cod_sub = per.t03_id_per and m.t51_fuente = _cod_fte)
LEFT JOIN adm_tablas_aux aux ON(per.t03_um=aux.codi)
WHERE per.t02_cod_proy=_proy
  AND per.t02_version = _ver 
GROUP BY 2;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_mp_personal_total` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_mp_personal_total`(IN _proy VARCHAR(10),  IN _num INT  , IN _cod_fte INT)
BEGIN
	
	DECLARE _ver     INT ;
	DECLARE _verIni  INT ;
	DECLARE _mes_ini INT ;
	DECLARE _mes_fin INT ;
	DECLARE _ver_anio  INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	DECLARE _rem INT ;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
	
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT 10, 1, 12 INTO _comp, _act, _rem ;
SELECT  
	
	
	(
	SELECT SUM((p.t03_gasto_tot)*(_mes_fin - _mes_ini))
	FROM t03_mp_per p
	WHERE p.t02_cod_proy=per.t02_cod_proy
	AND p.t02_version =_ver 
	) AS gasto_tot,	
	(
	 SELECT SUM(t03_monto*(_mes_fin - _mes_ini)) 
	 FROM t03_mp_per_ftes fte
	 WHERE fte.t02_cod_proy=per.t02_cod_proy
	   AND fte.t02_version =_ver
	   AND fte.t03_id_inst = _cod_fte
	   
	) AS total_fuente,
					   
					   
	SUM(fn_monto_planificado_mp_fte_periodo(per.t02_cod_proy, 
						 per.t02_version,
						 1,
						 0,
						 per.t03_id_per,
						 _cod_fte,
						 _mes_ini,
						 _mes_fin
						)) AS planeado,
	SUM((SELECT SUM(gas.t41_gasto)
	      FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=per.t02_cod_proy
	       
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
	       AND gas.t09_cod_sub = _rem
	       AND gas.t41_cate_gasto=per.t03_id_per
	       AND gas.t41_fte_finan=_cod_fte
	       AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
	 )) AS ejecutado
	 
	
	 
FROM t03_mp_per per
WHERE per.t02_cod_proy=_proy
  AND per.t02_version = _ver ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_subact`(IN _proy  VARCHAR(10), 
					       IN _comp  INT, 
					       IN _act INT,
					       IN _num   INT, 
					       IN _idFte INT)
BEGIN
DECLARE _ver  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT t51_per_ini, t51_per_fin   INTO _mes_ini, _mes_fin 
FROM t51_inf_mf inf
WHERE t02_cod_proy = _proy
  AND t51_num = _num ;
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1)    ),1) ;
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  sub.t09_mta_repro AS meta,
  SUM(cost.t10_cost_parc * sub.t09_mta_repro)  AS total_presup,
  
  
   SUM(fn_monto_planificado_fte_periodo(cost.t02_cod_proy, cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , cost.t10_cod_cost,
				         _idFte, _mes_ini, _mes_fin)) AS programado,
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy=cost.t02_cod_proy
       
       AND gas.t08_cod_comp=cost.t08_cod_comp
       AND gas.t09_cod_act =cost.t09_cod_act
       AND gas.t09_cod_sub =cost.t09_cod_sub
       AND gas.t41_fte_finan=_idFte
      AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
   
   (SELECT t51_no_gasto 
      FROM t51_inf_mf_avance_monto inf
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND inf.t51_fuente  = _idFte
       AND t51_num = _num
    ) AS gasto_no_aceptado   ,
    
    (SELECT t51_obs 
      FROM t51_inf_mf_avance_monto inf
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND inf.t51_fuente  = _idFte
       AND t51_num = _num
    ) AS observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_subact2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_subact2`(IN _proy  VARCHAR(10), 
					       IN _comp  INT, 
					       IN _act INT,
					       IN _num   INT )
BEGIN
DECLARE _ver  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT t51_per_ini, t51_per_fin   INTO _mes_ini, _mes_fin 
FROM t51_inf_mf inf
WHERE t02_cod_proy = _proy
  AND t51_num = _num ;
SET _ver = IFNULL(fn_version_proy_poa( _proy,  fn_numero_mes_rev(_mes_fin, 1)    ),1) ;
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  
  sub.t09_mta_repro as meta,
  
  
  SUM(cost.t10_cost_parc * sub.t09_mta_repro) AS total_presup,
  
  fn_meta_programada_periodo(cost.t02_cod_proy , cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub , _mes_ini, _mes_fin) AS programado,
  IFNULL(
   ( SELECT SUM(inf.t09_sub_avanc) 
     FROM  t09_act_sub_mtas_inf inf 
     WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       and inf.t09_cod_sub =sub.t09_cod_sub
       
       AND (fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
   
   (select t51_obs 
      from t51_inf_mf_avance_meta inf
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       and t51_num = _num
    ) as observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_financ_subact_no_gasto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_financ_subact_no_gasto`(IN _proy  VARCHAR(10), 
						        IN _comp  INT, 
						        IN _act   INT,
						        in _sub   int,
		IN _cat INT,				        IN _num   INT,
						        in _idFte int)
BEGIN
DECLARE _ver  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT t51_per_ini, t51_per_fin   INTO _mes_ini, _mes_fin 
FROM t51_inf_mf inf
WHERE t02_cod_proy = _proy
  AND t51_num = _num ;
select 	inf_gasto .* ,
	gna.t09_mto_no_acept,
	gna.t51_obs
from 
	(
		select  concat(gas.t08_cod_comp, '.', gas.t09_cod_act, '.', gas.t09_cod_sub) as codigo,
			gas.t40_anio,
			gas.t40_mes,
			fn_numero_mes(gas.t40_anio, gas.t40_mes) as nummes,
			fn_nom_mes(inf.t40_periodo) as nommes,
			sum(gas.t41_gasto) as gasto
		from      t41_inf_financ_gasto gas
		left join  t40_inf_financ      inf on (gas.t02_cod_proy=inf.t02_cod_proy and gas.t40_anio=inf.t40_anio and gas.t40_mes=inf.t40_mes)
		WHERE gas.t02_cod_proy  = _proy
		  AND gas.t08_cod_comp  = _comp
		  AND gas.t09_cod_act   = _act
		  AND gas.t09_cod_sub   = _sub
		  AND gas.t41_fte_finan = _idFte
		  AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin ) 
		  and gas.t41_gasto is not null 
		group by codigo, gas.t40_anio, gas.t40_mes, nommes 
	) as inf_gasto 
left join t51_inf_mf_gastos_no_aceptados gna on(inf_gasto.codigo = concat(gna.t08_cod_comp,'.',gna.t09_cod_act,'.',gna.t09_cod_sub) and gna.t51_fuente=_idFte and inf_gasto.t40_anio=gna.t09_anio and inf_gasto.t40_mes = gna.t09_mes and gna.t09_cod_sub_cat = _cat)  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_mf_observaciones` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_mf_observaciones`(IN _proy VARCHAR(10), 
					       IN _num INT  )
BEGIN
	select 	obs.t51_obs_id, 
		obs.t51_fecha, 
		DATE_FORMAT(obs.t51_fecha,'%d/%m/%Y') as fecha,
		obs.t51_obs_moni, 
		obs.t51_obs_eje, 
		obs.t51_ok_moni, 
		obs.usr_crea, 
		obs.est_audi
	  from     t51_inf_mf_observa obs
	 left join t51_inf_mf         inf on(obs.t02_cod_proy=inf.t02_cod_proy and obs.t51_num=inf.t51_num)
	 where  obs.t02_cod_proy = _proy
	   and	obs.t51_obs_id <= _num
	   and  obs.t51_obs_moni <> inf.t51_obs
      order by  obs.t51_fecha desc  ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_prob_sol` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_prob_sol`(
				IN _proy varchar(10), 
				IN _anio int, 
				IN _mes  int,
				IN _ver INT
				)
BEGIN
SELECT 	prob.t20_cod_prob,
	prob.t20_problemas,
	prob.t20_soluciones,
	prob.t20_resultados,
	inf.t20_dificul,
	inf.t20_program
FROM 	   t20_inf_mes_prob prob
left join  t20_inf_mes      inf on(prob.t02_cod_proy=inf.t02_cod_proy and prob.t20_anio=inf.t20_anio and prob.t20_mes=inf.t20_mes and prob.t20_ver_inf=inf.t20_ver_inf )
WHERE prob.t02_cod_proy=_proy
  AND prob.t20_anio = _anio
  AND prob.t20_mes  = _mes
  AND prob.t20_ver_inf = _ver
   
UNION 
SELECT 	vprob.t20_cod_prob,
	vprob.t20_problemas,
	vprob.t20_soluciones,
	vprob.t20_resultados,
	'' as t20_dificul,
	'' as t20_program
FROM v_inf_mes_prob_soluc vprob
WHERE vprob.t20_cod_prob NOT IN (
				 SELECT prob2.t20_cod_prob
				 FROM 	   t20_inf_mes_prob prob2 
				 WHERE prob2.t02_cod_proy=_proy
				   AND prob2.t20_anio = _anio
				   AND prob2.t20_mes  = _mes
				   AND prob2.t20_ver_inf = _ver 
				 ) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_se` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_se`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
    SELECT  
        inf.t02_cod_proy,
        inf.t02_anio,
        CONCAT('Año ',inf.t02_anio) AS anio,
        inf.t02_entregable,
        DATE_FORMAT(inf.t30_fch_pre,'%d/%m/%Y') AS fec_pre, 
        inf.t30_periodo AS periodo, 
        inf.t30_estado, 
        est.descrip AS estado,
        SUBSTRING(inf.t30_intro, 1, 150) AS introduccion,
        SUBSTRING(inf.t30_fuentes, 1, 150) AS fuentes,
        fn_numero_entregable(_proy, _ver, inf.t02_anio, inf.t02_entregable) AS entregable
    FROM t30_inf_se inf
    LEFT JOIN adm_tablas_aux est ON (inf.t30_estado = est.codi) 
    WHERE inf.t02_cod_proy = _proy
    ORDER BY entregable ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_se_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_se_anexos`(
                IN _proy VARCHAR(10), 
                IN _anio INT, 
                IN _entregable INT)
BEGIN
	SELECT t30_cod_anx,
	    t30_nom_file,
	    t30_url_file,
	    t30_desc_file
	FROM t30_inf_se_anexos
	WHERE t02_cod_proy = _proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_se_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_se_ind_comp`(IN _proy VARCHAR(10), 
                     IN _ver INT,
                     IN _comp INT,
                     IN _anio INT,
                     IN _entregable INT)
BEGIN
    SELECT 
        ind.t08_cod_comp_ind,
        ind.t08_ind AS indicador,
        ind.t08_um,
        ind.t08_mta AS plan_mtatotal,
        IFNULL(
        (SELECT SUM(a.t08_ind_avanc) 
         FROM t08_comp_ind_inf a 
         WHERE a.t02_cod_proy=ind.t02_cod_proy 
           AND a.t08_cod_comp=ind.t08_cod_comp 
           AND a.t08_cod_comp_ind=ind.t08_cod_comp_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL a.t08_ind_anio YEAR), INTERVAL a.t08_ind_entregable MONTH) < DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtaacum,
        IFNULL(
        (SELECT SUM(b.t08_ind_avanc) 
         FROM t08_comp_ind_inf b 
         WHERE b.t02_cod_proy=ind.t02_cod_proy 
           AND b.t08_cod_comp=ind.t08_cod_comp 
           AND b.t08_cod_comp_ind=ind.t08_cod_comp_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL b.t08_ind_anio YEAR), INTERVAL b.t08_ind_entregable MONTH) = DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_avance,
        IFNULL(
        (SELECT SUM(c.t08_ind_avanc) 
         FROM t08_comp_ind_inf c 
         WHERE c.t02_cod_proy=ind.t02_cod_proy 
           AND c.t08_cod_comp=ind.t08_cod_comp 
           AND c.t08_cod_comp_ind=ind.t08_cod_comp_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL c.t08_ind_anio YEAR), INTERVAL c.t08_ind_entregable MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtatotal,
        inf.t08_obs AS obs,
        inf.t08_avance AS avance
    FROM t08_comp_ind ind
    LEFT JOIN t08_comp_ind_inf_se inf ON (ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp AND ind.t08_cod_comp_ind=inf.t08_cod_comp_ind AND inf.t02_anio=_anio AND inf.t02_entregable=_entregable)
    WHERE ind.t02_cod_proy =_proy
      AND  ind.t02_version = _ver
      AND  ind.t08_cod_comp = _comp
    ORDER BY 1,2;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_se_vb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_se_vb`(IN _user VARCHAR(10))
BEGIN
	DECLARE var_all_proy INT DEFAULT 0;
	
    SELECT IF(t02_cod_proy = '*', 1, 0) INTO var_all_proy FROM adm_usuarios WHERE coduser = _user;
    
    IF var_all_proy = 1 THEN
        SELECT  
	        inf.t02_cod_proy AS proy,
	        inf.t02_anio,
	        CONCAT('Año ',inf.t02_anio) AS anio,
	        inf.t02_entregable,
	        DATE_FORMAT(inf.t30_fch_pre,'%d/%m/%Y') AS fec_pre, 
	        inf.t30_periodo AS periodo, 
	        inf.t30_estado, 
	        est.descrip AS estado,
	        SUBSTRING(inf.t30_intro, 1, 150) AS introduccion,
	        SUBSTRING(inf.t30_fuentes, 1, 150) AS fuentes,
	        fn_numero_entregable(inf.t02_cod_proy, fn_version_proy_poa(inf.t02_cod_proy, inf.t02_anio), inf.t02_anio, inf.t02_entregable) AS entregable
	    FROM t30_inf_se inf, adm_tablas_aux est
	    WHERE inf.t30_estado = est.codi
	    AND inf.t30_estado = 281
	    ORDER BY inf.t02_cod_proy, inf.t02_anio, entregable ASC;
    ELSE
        SELECT  
            inf.t02_cod_proy AS proy,
            inf.t02_anio,
            CONCAT('Año ',inf.t02_anio) AS anio,
            inf.t02_entregable,
            DATE_FORMAT(inf.t30_fch_pre,'%d/%m/%Y') AS fec_pre, 
            inf.t30_periodo AS periodo, 
            inf.t30_estado, 
            est.descrip AS estado,
            SUBSTRING(inf.t30_intro, 1, 150) AS introduccion,
            SUBSTRING(inf.t30_fuentes, 1, 150) AS fuentes,
            fn_numero_entregable(inf.t02_cod_proy, fn_version_proy_poa(inf.t02_cod_proy, inf.t02_anio), inf.t02_anio, inf.t02_entregable) AS entregable
        FROM t30_inf_se inf, adm_usuarios u, adm_tablas_aux est
        WHERE inf.t02_cod_proy = u.t02_cod_proy
        AND inf.t30_estado = est.codi
        AND inf.t30_estado = 281
        AND u.coduser = _user
        ORDER BY inf.t02_cod_proy, inf.t02_anio, entregable ASC;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_si` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_si`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
    SELECT  
        inf.t02_cod_proy,
        inf.t02_anio,
        CONCAT('Año ',inf.t02_anio) AS anio,
        inf.t02_entregable,
        DATE_FORMAT(inf.t45_fch_pre,'%d/%m/%Y') AS fec_pre, 
        inf.t45_periodo AS periodo, 
        inf.t45_estado, 
        est.descrip AS estado,
        SUBSTRING(inf.t45_intro, 1, 150) AS introduccion,
        SUBSTRING(inf.t45_fuentes, 1, 150) AS fuentes,
        fn_numero_entregable(_proy, _ver, inf.t02_anio, inf.t02_entregable) AS entregable
    FROM t45_inf_si inf
    LEFT JOIN adm_tablas_aux est ON (inf.t45_estado = est.codi) 
    WHERE inf.t02_cod_proy = _proy
    ORDER BY entregable ASC;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_si_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_si_anexos`(
                IN _proy VARCHAR(10), 
                IN _anio INT, 
                IN _entregable INT)
BEGIN
    SELECT t45_cod_anx,
        t45_nom_file,
        t45_url_file,
        t45_desc_file
    FROM t45_inf_si_anexos
    WHERE t02_cod_proy = _proy 
    AND t02_anio = _anio 
    AND t02_entregable = _entregable;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_si_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_inf_si_ind_comp`(IN _proy VARCHAR(10), 
                     IN _ver INT,
                     IN _comp INT,
                     IN _anio INT,
                     IN _entregable INT)
BEGIN
    SELECT 
        ind.t08_cod_comp_ind,
        ind.t08_ind AS indicador,
        ind.t08_um,
        ind.t08_mta AS plan_mtatotal,
        IFNULL(
        (SELECT SUM(a.t08_ind_avanc) 
         FROM t08_comp_ind_inf a 
         WHERE a.t02_cod_proy=ind.t02_cod_proy 
           AND a.t08_cod_comp=ind.t08_cod_comp 
           AND a.t08_cod_comp_ind=ind.t08_cod_comp_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL a.t08_ind_anio YEAR), INTERVAL a.t08_ind_entregable MONTH) < DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtaacum,
        IFNULL(
        (SELECT SUM(b.t08_ind_avanc) 
         FROM t08_comp_ind_inf b 
         WHERE b.t02_cod_proy=ind.t02_cod_proy 
           AND b.t08_cod_comp=ind.t08_cod_comp 
           AND b.t08_cod_comp_ind=ind.t08_cod_comp_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL b.t08_ind_anio YEAR), INTERVAL b.t08_ind_entregable MONTH) = DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_avance,
        IFNULL(
        (SELECT SUM(c.t08_ind_avanc) 
         FROM t08_comp_ind_inf c 
         WHERE c.t02_cod_proy=ind.t02_cod_proy 
           AND c.t08_cod_comp=ind.t08_cod_comp 
           AND c.t08_cod_comp_ind=ind.t08_cod_comp_ind
           AND DATE_ADD(DATE_ADD(NOW(), INTERVAL c.t08_ind_anio YEAR), INTERVAL c.t08_ind_entregable MONTH) <= DATE_ADD(DATE_ADD(NOW(), INTERVAL _anio YEAR), INTERVAL _entregable MONTH)
         ),0) AS ejec_mtatotal,
        inf.t08_obs AS obs,
        inf.t08_avance AS avance
    FROM t08_comp_ind ind
    LEFT JOIN t08_comp_ind_inf_si inf ON (ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp AND ind.t08_cod_comp_ind=inf.t08_cod_comp_ind AND inf.t02_anio=_anio AND inf.t02_entregable=_entregable)
    WHERE ind.t02_cod_proy =_proy
      AND  ind.t02_version = _ver
      AND  ind.t08_cod_comp = _comp
    ORDER BY 1,2;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_sub_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_sub_act`(
				IN _proy VARCHAR(10), 
				IN _comp INT, 
				IN _activ INT, 
				IN _anio INT, 
				IN _mes INT)
BEGIN
DECLARE _ver INT;
DECLARE _ver_anio  INT ;

SELECT fn_ult_version_proy(_proy) INTO _ver ;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;

SELECT 	sub.t08_cod_comp,
	com.t08_comp_desc AS componente,
	sub.t09_cod_act,
	act.t09_act AS actividad,
	sub.t09_cod_sub,
	sub.t09_sub AS subactividad,
	sub.t09_um,
	
	sub.t09_mta_repro AS plan_mtatotal,
	sub.t09_mta AS plan_mtaanio,
	
	
	SUM(CASE WHEN fn_numero_mes(mta.t09_anio,mta.t09_mes) < fn_numero_mes(_anio,_mes) THEN mta.t09_mta ELSE 0 END) AS plan_mtaacum,
	SUM(CASE WHEN mta.t09_anio=_anio AND mta.t09_mes=_mes THEN mta.t09_mta ELSE 0 END) AS plan_mtames,
	IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) < fn_numero_mes(_anio,_mes)
	   
	 ),0) AS ejec_mtaacum,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_sub_avanc ELSE NULL END) AS ejec_mtames,
	 IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) <= fn_numero_mes(_anio,_mes)
	   
	 ),0) AS ejec_mtatotal,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_descrip ELSE NULL END) AS descripcion,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_logros  ELSE NULL END) AS logros,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_dificul ELSE NULL END) AS dificultades,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_omt ELSE NULL END) AS omt
FROM  	   t09_subact  sub
INNER JOIN t08_comp    com  ON(sub.t02_cod_proy=com.t02_cod_proy AND sub.t02_version=com.t02_version  AND sub.t08_cod_comp=com.t08_cod_comp )
INNER JOIN t09_act     act  ON(sub.t02_cod_proy=act.t02_cod_proy AND sub.t02_version=act.t02_version  AND sub.t08_cod_comp=act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_sub_act_mtas mta ON(sub.t02_cod_proy=mta.t02_cod_proy AND sub.t02_version=mta.t02_version  AND sub.t08_cod_comp=mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub=mta.t09_cod_sub AND mta.t09_anio<=_anio)
LEFT  JOIN t09_act_sub_mtas_inf inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_act AND sub.t09_cod_sub=inf.t09_cod_sub AND inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes)
WHERE sub.t02_cod_proy=_proy
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act=_activ
  AND sub.t02_version = _ver_anio 
GROUP BY sub.t08_cod_comp, com.t08_comp_desc, sub.t09_cod_act, act.t09_act ,
	 sub.t09_cod_sub, sub.t09_sub , sub.t09_um ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_sub_act_mes_ex` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_sub_act_mes_ex`(IN _proy VARCHAR(10), IN _comp INT, IN _activ INT, IN _anio INT, IN _trim INT)
BEGIN
DECLARE _mes INT;
DECLARE _mes_acum INT;
DECLARE _ver_anio  INT ;

SELECT (_trim * 3) INTO _mes; 
SELECT fn_numero_mes(_anio, _mes) - 3 INTO _mes_acum ;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;

SELECT 	sub.t08_cod_comp,
	com.t08_comp_desc AS componente,
	sub.t09_cod_act,
	act.t09_act AS actividad,
	sub.t09_cod_sub,
	sub.t09_sub AS subactividad,
	sub.t09_um,	
	
	sub.t09_mta_repro AS plan_mtatotal,
	sub.t09_mta AS plan_mtaanio,	
	
	SUM(CASE WHEN fn_numero_mes(mta.t09_anio,mta.t09_mes) < fn_numero_mes(_anio,_mes) THEN mta.t09_mta ELSE 0 END) AS plan_mtaacum,
	SUM(CASE WHEN mta.t09_anio=_anio AND mta.t09_mes=_mes THEN mta.t09_mta ELSE 0 END) AS plan_mtames,
	IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) <= _mes_acum
	 ),0) AS ejec_mtaacum,
	 
	IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) > _mes_acum AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) < fn_numero_mes(_anio,_mes)
	 ),0) AS ejec_mtaacumtrim,
	 
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_sub_avanc ELSE NULL END) AS ejec_mtames,
	 
	 IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) <= fn_numero_mes(_anio,_mes)
	 ),0) AS ejec_mtatotal,
	 
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_descrip ELSE NULL END) AS descripcion,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_logros  ELSE NULL END) AS logros,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_dificul ELSE NULL END) AS dificultades,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_omt ELSE NULL END) AS observaciones
FROM  	   t09_subact  sub
INNER JOIN t08_comp    com  ON(sub.t02_cod_proy=com.t02_cod_proy AND sub.t02_version=com.t02_version  AND sub.t08_cod_comp=com.t08_cod_comp )
INNER JOIN t09_act     act  ON(sub.t02_cod_proy=act.t02_cod_proy AND sub.t02_version=act.t02_version  AND sub.t08_cod_comp=act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_sub_act_mtas mta ON(sub.t02_cod_proy=mta.t02_cod_proy AND sub.t02_version=mta.t02_version  AND sub.t08_cod_comp=mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub=mta.t09_cod_sub AND mta.t09_anio<=_anio)
LEFT  JOIN t09_act_sub_mtas_inf inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_act AND sub.t09_cod_sub=inf.t09_cod_sub AND inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes)
WHERE sub.t02_cod_proy=_proy
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act=_activ
  AND sub.t02_version= _ver_anio
  
GROUP BY sub.t08_cod_comp, com.t08_comp_desc, sub.t09_cod_act, act.t09_act ,
	 sub.t09_cod_sub, sub.t09_um, sub.t09_sub, sub.t09_mta  ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_sub_act_moni_ext` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_sub_act_moni_ext`(IN _proy VARCHAR(10), IN _comp INT,IN _act INT,IN _num INT ,in _verinf int, _mes_ini INT , _mes_fin INT)
BEGIN
DECLARE _ver  INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
_mes_ini, _mes_fin,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  
  sub.t09_mta_repro AS meta,
  
  
  fn_meta_programada_periodo(cost.t02_cod_proy, cost.t08_cod_comp, cost.t09_cod_act, cost.t09_cod_sub , _mes_ini,_mes_fin) AS programado,
  IFNULL(
   ( SELECT SUM(inf.t09_sub_avanc) 
     FROM  t09_act_sub_mtas_inf inf 
     WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       
        AND (fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
   
   (SELECT t45_obs 
      FROM t45_inf_mi_subact inf
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND inf.t45_id = _num
       and inf.t45_ver_inf = _verinf
    ) AS observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
LEFT  JOIN t09_subact   sub_v1 ON(sub.t02_cod_proy = sub_v1.t02_cod_proy AND sub_v1.t02_version=1 AND sub.t08_cod_comp = sub_v1.t08_cod_comp AND sub.t09_cod_act=sub_v1.t09_cod_act AND sub.t09_cod_sub= sub_v1.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;

	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_sub_act_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_sub_act_trim`(IN _proy VARCHAR(10), 
				IN _comp INT, 
				IN _activ INT, 
				IN _anio INT, 
				IN _trim INT)
BEGIN
DECLARE _mes INT;
DECLARE _mes_acum INT;
DECLARE _ver_anio  INT ;

SELECT (_trim * 3) INTO _mes; 
SELECT fn_numero_mes(_anio, _mes) - 3 INTO _mes_acum ;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;

SELECT 	sub.t08_cod_comp,
	com.t08_comp_desc AS componente,
	sub.t09_cod_act,
	act.t09_act AS actividad,
	sub.t09_cod_sub,
	sub.t09_sub AS subactividad,
	sub.t09_um,	
	
	sub.t09_mta_repro AS plan_mtatotal,
	sub.t09_mta AS plan_mtaanio,	
	
	SUM(CASE WHEN fn_numero_mes(mta.t09_anio,mta.t09_mes) < fn_numero_mes(_anio,_mes) THEN mta.t09_mta ELSE 0 END) AS plan_mtaacum,
	SUM(CASE WHEN mta.t09_anio=_anio AND mta.t09_mes=_mes THEN mta.t09_mta ELSE 0 END) AS plan_mtames,
	IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) <= _mes_acum
	 ),0) AS ejec_mtaacum,
	 
	IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) > _mes_acum AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) < fn_numero_mes(_anio,_mes)
	 ),0) AS ejec_mtaacumtrim,
	 
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_sub_avanc ELSE NULL END) AS ejec_mtames,
	 
	 IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND fn_numero_mes(inf2.t09_sub_anio, inf2.t09_sub_mes) <= fn_numero_mes(_anio,_mes)
	 ),0) AS ejec_mtatotal,
	 
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_descrip ELSE NULL END) AS descripcion,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_logros  ELSE NULL END) AS logros,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_dificul ELSE NULL END) AS dificultades,
	 MAX(CASE WHEN inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes THEN inf.t09_omt ELSE NULL END) AS observaciones
FROM  	   t09_subact  sub
INNER JOIN t08_comp    com  ON(sub.t02_cod_proy=com.t02_cod_proy AND sub.t02_version=com.t02_version  AND sub.t08_cod_comp=com.t08_cod_comp )
INNER JOIN t09_act     act  ON(sub.t02_cod_proy=act.t02_cod_proy AND sub.t02_version=act.t02_version  AND sub.t08_cod_comp=act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_sub_act_mtas mta ON(sub.t02_cod_proy=mta.t02_cod_proy AND sub.t02_version=mta.t02_version  AND sub.t08_cod_comp=mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub=mta.t09_cod_sub AND mta.t09_anio<=_anio)
LEFT  JOIN t09_act_sub_mtas_inf inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_act AND sub.t09_cod_sub=inf.t09_cod_sub AND inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes)
WHERE sub.t02_cod_proy=_proy
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act=_activ
  AND sub.t02_version= _ver_anio
  
GROUP BY sub.t08_cod_comp, com.t08_comp_desc, sub.t09_cod_act, act.t09_act ,
	 sub.t09_cod_sub, sub.t09_um, sub.t09_sub, sub.t09_mta  ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_sub_act_trim_back` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_sub_act_trim_back`(
				IN _proy varchar(10), 
				IN _comp int, 
				IN _activ int, 
				IN _anio int, 
				IN _trim int)
BEGIN
DECLARE _mes INT;
SELECT (_trim * 3) INTO _mes; 
CALL sp_sel_inf_sub_act(_proy, _comp, _activ, _anio, _mes);
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_trim` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_trim`(IN _proy VARCHAR(10), 
			    IN _anio INT )
BEGIN
	SELECT 	inf.t02_cod_proy, 
		inf.t25_anio, 
		CONCAT('Año ',inf.t25_anio) AS anio,
		inf.t25_trim, 
		CONCAT('Trim. ', inf.t25_trim) AS 'trim',
		inf.t25_ver_inf AS vsinf, 
		DATE_FORMAT(inf.t25_fch_pre,'%d/%m/%Y') AS fec_pre, 
		inf.t25_periodo AS periodo, 
		(case when inf.t25_apro_mt='1' then 'V.B.' else '' end) AS  aprueba_mt, 
		inf.t25_apro_fch AS aprueba_fec, 
		SUBSTRING(inf.t25_apro_txt,1,205) as aprueba_txt,
		fn_numero_trim(inf.t25_anio, inf.t25_trim) as nrotrim,
		(case when length(inf.t25_conclu)>205 then concat(SUBSTRING(inf.t25_conclu,1,205),' ...') else inf.t25_conclu end ) AS conclusiones,
		est.descrip AS estado,
		fn_porc_cump_inf_trim(inf.t02_cod_proy, inf.t25_anio, inf.t25_trim ) AS cump_trim,
		fn_porc_cump_inf_mes_acum(inf.t02_cod_proy, inf.t25_anio, (inf.t25_trim * 3) ) AS cump_acum_trim
	FROM  t25_inf_trim inf
	LEFT JOIN adm_tablas_aux est ON (inf.t25_estado = est.codi) 
	WHERE   inf.t02_cod_proy = _proy
		AND inf.t25_anio = (CASE WHEN _anio > 0 THEN _anio ELSE inf.t25_anio END)
		AND inf.t25_ver_inf = (SELECT MAX(v.t25_ver_inf) FROM t25_inf_trim v WHERE v.t02_cod_proy=inf.t02_cod_proy AND v.t25_anio=inf.t25_anio AND v.t25_trim=inf.t25_trim) 
	ORDER BY inf.t25_anio, inf.t25_trim, t25_fch_pre ;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_trim_analisis` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_trim_analisis`(
				IN _proy varchar(10), 
				IN _anio int, 
				IN _mes  int,
				IN _ver INT
				)
BEGIN
	SELECT 	inf.t25_trim, 
		inf.t25_resulta, 
		inf.t25_conclu, 
		inf.t25_limita, 
		inf.t25_fac_pos, 
		inf.t25_perspec 
	FROM t25_inf_trim inf
	WHERE inf.t02_cod_proy=_proy
	  AND inf.t25_anio = _anio
	  AND inf.t25_trim  = _mes
	  AND inf.t25_ver_inf = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_trim_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_trim_ind_comp`(IN _proy VARCHAR(10), 
				     IN _comp INT,
				     IN _anio INT, 
				     IN _trim INT)
BEGIN
DECLARE _ver INT;

SELECT fn_ult_version_proy(_proy) INTO _ver ;

SELECT  ind.t08_cod_comp_ind,
	ind.t08_ind AS indicador,
	ind.t08_um,
	ind.t08_mta AS plan_mtatotal,
	SUM(0) 	    AS plan_mtaacum,
	SUM(0) 	    AS plan_mtatrim,
	SUM(CASE WHEN fn_numero_trim(inf.t08_ind_anio,inf.t08_ind_trim) < fn_numero_trim(_anio,_trim)  THEN inf.t08_ind_avanc ELSE 0  END) AS ejec_mtaacum,
	SUM(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_trim = _trim  THEN inf.t08_ind_avanc ELSE 0  END) AS ejec_mtatrim,
	SUM(CASE WHEN fn_numero_trim(inf.t08_ind_anio,inf.t08_ind_trim) <= fn_numero_trim(_anio,_trim) THEN inf.t08_ind_avanc ELSE 0  END) AS ejec_mtatotal,
	MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_trim=_trim THEN inf.t08_descrip ELSE NULL END) AS descripcion,
	MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_trim=_trim THEN inf.t08_logros  ELSE NULL END) AS logros,
	MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_trim=_trim THEN inf.t08_dificul ELSE NULL END) AS dificultades,
	MAX(CASE WHEN inf.t08_ind_anio=_anio AND inf.t08_ind_trim=_trim THEN inf.t08_obs ELSE NULL END) AS observaciones
FROM 	   t08_comp_ind ind  
LEFT JOIN  t08_comp_ind_inf inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t08_cod_comp=inf.t08_cod_comp AND ind.t08_cod_comp_ind=inf.t08_cod_comp_ind AND inf.t08_ind_anio<=_anio)
WHERE  ind.t02_cod_proy=_proy
  AND  ind.t02_version=_ver
  AND  ind.t08_cod_comp=_comp
GROUP BY ind.t08_cod_comp_ind,
	 ind.t08_ind ,
	 ind.t08_um  ,
	 ind.t08_mta  ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_trim_ind_prop` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_trim_ind_prop`(IN _proy VARCHAR(10), 
				     IN _anio INT, 
				     IN _trim INT)
BEGIN
DECLARE _ver INT;

SELECT fn_ult_version_proy(_proy) INTO _ver ;

SELECT 	ind.t07_cod_prop_ind,
	ind.t07_ind AS indicador,
	ind.t07_um,
	ind.t07_mta AS plan_mtatotal,
	SUM(0) 	    AS plan_mtaacum,
	SUM(0) 	    AS plan_mtatrim,
	SUM(CASE WHEN fn_numero_trim(inf.t07_ind_anio,inf.t07_ind_trim) < fn_numero_trim(_anio,_trim) THEN inf.t07_ind_avanc ELSE 0 END) AS ejec_mtaacum,
	SUM(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_trim = _trim THEN inf.t07_ind_avanc ELSE 0 END) AS ejec_mtatrim,
	SUM(CASE WHEN fn_numero_trim(inf.t07_ind_anio,inf.t07_ind_trim) <= fn_numero_trim(_anio,_trim) THEN inf.t07_ind_avanc ELSE 0 END) AS  ejec_mtatotal,
	MAX(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_trim=_trim THEN inf.t07_descrip ELSE NULL END) AS descripcion,
	MAX(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_trim=_trim THEN inf.t07_logros  ELSE NULL END) AS logros,
	MAX(CASE WHEN inf.t07_ind_anio =_anio AND inf.t07_ind_trim=_trim THEN inf.t07_dificul ELSE NULL END) AS dificultades
	
FROM 	  t07_prop_ind ind
LEFT JOIN t07_prop_ind_inf inf ON(ind.t02_cod_proy=inf.t02_cod_proy AND ind.t07_cod_prop_ind=inf.t07_cod_prop_ind AND inf.t07_ind_anio<=_anio)
WHERE ind.t02_cod_proy = _proy 
  AND ind.t02_version = _ver
GROUP BY ind.t07_cod_prop_ind,
	 ind.t07_ind ,
	 ind.t07_um  ,
	 ind.t07_mta ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_unico_anual` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_unico_anual`(IN _proy VARCHAR(10))
BEGIN
	SELECT 	inf.t02_cod_proy, 
			inf.t55_anio, 
			CONCAT('Año ',inf.t55_anio) AS anio,
			inf.t55_ver_inf AS vsinf, 
			DATE_FORMAT(inf.t55_fch_pre,'%d/%m/%Y') AS fec_pre, 
			inf.t55_periodo AS periodo, 
			est.descrip AS estado,
			t55_mt,
			t55_mf,
			t55_cmt,
			t55_cmf,
			inf.t55_reco_proy AS recomendaciones	
	FROM 	t55_inf_unico_anual inf
	LEFT JOIN adm_tablas_aux est ON (inf.t55_estado = est.codi) 
	WHERE	inf.t02_cod_proy = _proy		
	ORDER BY inf.t55_anio, t55_fch_pre ;	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_unico_anual_financ_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_unico_anual_financ_act`(IN _proy VARCHAR(10), 
					    IN _comp INT, 
					    IN _num INT ,
					    IN _cod_fte INT )
BEGIN
DECLARE _ver     INT ;
DECLARE _verIni  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver    ;
SELECT fn_pri_version_proy(_proy) INTO _verIni ;
SELECT t55_per_ini, t55_per_fin
  INTO _mes_ini, _mes_fin 
FROM t55_inf_unico_anual inf
WHERE t02_cod_proy = _proy
  AND t55_id = _num ;
SELECT
  act.t09_cod_act,
  CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
  act.t09_act AS actividad,
  (SUM(cost.t10_cost_parc * sub.t09_mta))  AS total_presup,
  
  SUM(fn_monto_total_planificado_periodo(cost.t02_cod_proy, cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , cost.t10_cod_cost,
				         _mes_ini, _mes_fin)) AS programado,
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy=cost.t02_cod_proy
       AND gas.t08_cod_comp=cost.t08_cod_comp
       AND gas.t09_cod_act =cost.t09_cod_act
       AND gas.t41_fte_finan=_cod_fte 
       AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado
FROM       t09_subact sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
INNER JOIN t09_act 	act  ON(sub.t02_cod_proy = act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version= _ver
  AND sub.t08_cod_comp= _comp
GROUP BY 1, 2, 3
ORDER BY act.t08_cod_comp, act.t09_cod_act ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_unico_anual_financ_act2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_unico_anual_financ_act2`(IN _proy VARCHAR(10), 
					     IN _comp INT, 
					     IN _num INT )
BEGIN
DECLARE _ver     INT ;
DECLARE _verIni  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver    ;
SELECT fn_pri_version_proy(_proy) INTO _verIni ;
SELECT t55_per_ini, t55_per_fin
  INTO _mes_ini, _mes_fin 
FROM t55_inf_unico_anual inf
WHERE t02_cod_proy = _proy
  AND t55_id = _num ;
  
SELECT
  act.t09_cod_act,
  CONCAT( act.t08_cod_comp,'.', act.t09_cod_act) AS codigo,
  act.t09_act AS actividad,
  (
     SELECT SUM(t09_subact.t09_mta) 
       FROM t09_subact 
      WHERE t09_subact.t02_cod_proy = sub.t02_cod_proy 
        AND t09_subact.t02_version  = sub.t02_version
        AND t09_subact.t08_cod_comp = sub.t08_cod_comp
        AND t09_subact.t09_cod_act  = sub.t09_cod_act
   )  AS total_meta,
  
  (SUM(cost.t10_cost_parc * sub.t09_mta))  AS total_presup,
  
  (
   SELECT SUM(fn_meta_total_planificado_periodo(s.t02_cod_proy, s.t02_version, s.t08_cod_comp, s.t09_cod_act, s.t09_cod_sub , _mes_ini, _mes_fin))
     FROM t09_subact s
    WHERE s.t02_cod_proy = sub.t02_cod_proy 
      AND s.t02_version  = sub.t02_version
      AND s.t08_cod_comp = sub.t08_cod_comp
      AND s.t09_cod_act  = sub.t09_cod_act
  ) AS programado,
  
  IFNULL(
   ( SELECT SUM(inf.t09_sub_avanc) 
       FROM  t09_act_sub_mtas_inf inf 
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
        AND inf.t08_cod_comp=sub.t08_cod_comp
        AND inf.t09_cod_act =sub.t09_cod_act
        
        AND (fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
INNER JOIN t09_act      act  ON(sub.t02_cod_proy = act.t02_cod_proy AND sub.t02_version=act.t02_version AND sub.t08_cod_comp = act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
WHERE sub.t02_cod_proy= _proy
  AND sub.t02_version = _ver
  AND sub.t08_cod_comp= _comp
GROUP BY 1, 2, 3
ORDER BY act.t08_cod_comp, act.t09_cod_act ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_unico_anual_financ_subact` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_unico_anual_financ_subact`(IN _proy  VARCHAR(10), 
					       IN _comp  INT, 
					       IN _act INT,
					       IN _num   INT,
					       IN _cod_fte INT )
BEGIN
DECLARE _ver  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT t55_per_ini, t55_per_fin   INTO _mes_ini, _mes_fin 
FROM t55_inf_unico_anual inf
WHERE t02_cod_proy = _proy
  AND t55_id = _num ;
  
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  sub.t09_mta AS meta,
  (SUM(cost.t10_cost_parc * sub.t09_mta))  AS total_presup,
  
  SUM(fn_monto_total_planificado_periodo(cost.t02_cod_proy, cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , cost.t10_cod_cost,
				         _mes_ini, _mes_fin)) AS programado,
  IFNULL(
   ( SELECT SUM(gas.t41_gasto) 
     FROM  t41_inf_financ_gasto gas 
     WHERE gas.t02_cod_proy=cost.t02_cod_proy
       
       AND gas.t08_cod_comp=cost.t08_cod_comp
       AND gas.t09_cod_act =cost.t09_cod_act
       AND gas.t09_cod_sub =cost.t09_cod_sub
       AND gas.t41_fte_finan=_cod_fte 
      AND (fn_numero_mes(gas.t40_anio, gas.t40_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
   
    (SELECT t55_obs 
      FROM t55_inf_unico_anual_avance_presup inf
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND t55_num = _num
    ) AS observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_unico_anual_financ_subact2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_unico_anual_financ_subact2`(IN _proy  VARCHAR(10), 
					       IN _comp  INT, 
					       IN _act INT,
					       IN _num   INT )
BEGIN
DECLARE _ver  INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
SELECT fn_ult_version_proy(_proy) INTO _ver;
SELECT t55_per_ini, t55_per_fin   INTO _mes_ini, _mes_fin 
FROM t55_inf_unico_anual inf
WHERE t02_cod_proy = _proy
  AND t55_id = _num ;
  
SELECT
  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) AS codigo,
  sub.t09_cod_sub,
  sub.t09_sub AS subactividad,
  sub.t09_um  AS um,
  sub.t09_mta AS meta,
  (SUM(cost.t10_cost_parc * sub.t09_mta))  AS total_presup,
  
  fn_meta_total_planificado_periodo(cost.t02_cod_proy , cost.t02_version, 
				         cost.t08_cod_comp, cost.t09_cod_act, 
				         cost.t09_cod_sub , _mes_ini, _mes_fin) AS programado,
  IFNULL(
   ( SELECT SUM(inf.t09_sub_avanc) 
     FROM  t09_act_sub_mtas_inf inf 
     WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       
       AND (fn_numero_mes(inf.t09_sub_anio, inf.t09_sub_mes) BETWEEN _mes_ini AND _mes_fin )
    )
   ,0) AS ejecutado,
   
   (SELECT t55_obs 
      FROM t55_inf_unico_anual_avance_meta inf
      WHERE inf.t02_cod_proy=sub.t02_cod_proy
       AND inf.t08_cod_comp=sub.t08_cod_comp
       AND inf.t09_cod_act =sub.t09_cod_act
       AND inf.t09_cod_sub =sub.t09_cod_sub
       AND t55_num = _num
    ) AS observaciones   
   
FROM       t09_subact   sub 
INNER JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
WHERE sub.t02_cod_proy=_proy
  AND sub.t02_version =_ver
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act =_act
GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_unico_anual_prg_vs_avance_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_unico_anual_prg_vs_avance_comp`(IN _proy VARCHAR(10), 
				     IN _comp INT,
				     IN _anio INT)
BEGIN
	DECLARE _ver INT DEFAULT 1;
	
		SELECT  ind.t08_cod_comp_ind,
				ind.t08_ind AS indicador,
				ind.t08_um,
				ind.t08_mta AS plan_mtatotal,	
				fn_poa_ind_comp_meta_acum_ver_ant(_proy, _comp, ind.t08_cod_comp_ind, _anio) AS meta_acum,
				fn_poa_ind_comp_meta_ver_anual(_proy, _comp, ind.t08_cod_comp_ind, _anio) AS meta_anual,	
				fn_inf_unico_anual_ind_comp_ejec_anual(_proy, _comp, ind.t08_cod_comp_ind, _anio) AS meta_anual_tri,	
				fn_inf_unico_anual_ind_comp_ejec_acum(_proy, _comp, ind.t08_cod_comp_ind, _anio) AS meta_acum_tri,
				fn_inf_unico_anual_ind_comp_meta_anual_ext(_proy, _comp, ind.t08_cod_comp_ind, _anio) AS meta_anual_ext,	
				fn_inf_unico_anual_ind_comp_meta_acum_ext(_proy, _comp, ind.t08_cod_comp_ind, _anio) AS meta_acum_ext,
				fn_poa_ind_comp_meta_eje(_proy, _comp, ind.t08_cod_comp_ind, _anio) AS ejecutado_anio,
				IFNULL(fn_poa_ind_comp_meta_eje_acum(_proy, _comp, ind.t08_cod_comp_ind, _anio),0) AS ejecutado_acum,
				me.t08_descrip AS descrip
	FROM		t08_comp_ind ind  
	LEFT JOIN	t08_comp_ind_inf inf	ON (ind.t02_cod_proy = inf.t02_cod_proy 
										AND ind.t08_cod_comp = inf.t08_cod_comp 
										AND ind.t08_cod_comp_ind = inf.t08_cod_comp_ind 
										AND inf.t08_ind_anio <= _anio)
	LEFT JOIN	t08_comp_ind_inf_me me	ON (ind.t02_cod_proy = me.t02_cod_proy 
										AND ind.t08_cod_comp = me.t08_cod_comp  
										AND ind.t08_cod_comp_ind = me.t08_cod_comp_ind 
										AND me.t02_version = (_anio+1) )
	WHERE	ind.t02_cod_proy = _proy
		AND ind.t02_version = _ver
		AND ind.t08_cod_comp = _comp
	GROUP BY ind.t08_cod_comp_ind, ind.t08_ind, ind.t08_um, ind.t08_mta;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_unico_anual_sub_act_crit` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_unico_anual_sub_act_crit`(IN _proy VARCHAR(10), 
				IN _comp INT, 
				IN _activ INT, 
				IN _anio INT, 
				IN _trim INT)
BEGIN
DECLARE _mes_acum INT;
DECLARE _ver_anio  INT ;
DECLARE _mes  INT DEFAULT 12;

SELECT fn_numero_mes(_anio, _mes) - 12 INTO _mes_acum ;
SELECT fn_version_proy_poa(_proy, _anio) INTO _ver_anio ;

SELECT 	sub.t08_cod_comp,
	com.t08_comp_desc AS componente,
	sub.t09_cod_act,
	act.t09_act AS actividad,
	sub.t09_cod_sub,
	sub.t09_sub AS subactividad,
	sub.t09_um,
	sub.t09_mta_repro AS plan_mtatotal,
	
	fn_inf_unico_anual_sub_act_met_pla_acum( sub.t02_cod_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub, _anio) AS plan_mtaacum ,
	sub.t09_mta AS plan_mtaanio,		
	fn_inf_unico_anual_sub_act_met_ejec_acum( sub.t02_cod_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub, _anio) AS ejec_mtaacum ,		
	IFNULL((SELECT SUM(inf2.t09_sub_avanc) 
	 FROM t09_act_sub_mtas_inf inf2 
	 WHERE inf2.t02_cod_proy=sub.t02_cod_proy 
	   AND inf2.t08_cod_comp=sub.t08_cod_comp  
	   AND inf2.t09_cod_act=sub.t09_cod_act 
	   AND inf2.t09_cod_sub=sub.t09_cod_sub 
	   AND inf2.t09_sub_anio = _anio
	   
	 ),0) AS ejec_mtaanual,
	fn_inf_unico_anual_sub_act_ext_acum( sub.t02_cod_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub, _anio) AS ejec_mtaacumext ,		
	fn_inf_unico_anual_sub_act_ext_anual( sub.t02_cod_proy, sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub, _anio) AS ejec_mtaanualext,
	me.t09_descrip as descrip
FROM  	   t09_subact  sub
INNER JOIN t08_comp    com  ON(sub.t02_cod_proy=com.t02_cod_proy AND sub.t02_version=com.t02_version  AND sub.t08_cod_comp=com.t08_cod_comp )
INNER JOIN t09_act     act  ON(sub.t02_cod_proy=act.t02_cod_proy AND sub.t02_version=act.t02_version  AND sub.t08_cod_comp=act.t08_cod_comp AND sub.t09_cod_act=act.t09_cod_act)
LEFT  JOIN t09_sub_act_mtas mta ON(sub.t02_cod_proy=mta.t02_cod_proy AND sub.t02_version=mta.t02_version  AND sub.t08_cod_comp=mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub=mta.t09_cod_sub AND mta.t09_anio<=_anio)
LEFT  JOIN t09_act_sub_mtas_inf inf ON(sub.t02_cod_proy=inf.t02_cod_proy AND sub.t08_cod_comp=inf.t08_cod_comp  AND sub.t09_cod_act=inf.t09_cod_act AND sub.t09_cod_sub=inf.t09_cod_sub AND inf.t09_sub_anio=_anio AND inf.t09_sub_mes=_mes)
LEFT  JOIN t09_act_sub_mtas_inf_me me ON(sub.t02_cod_proy=me.t02_cod_proy AND sub.t08_cod_comp=me.t08_cod_comp  AND sub.t09_cod_act=me.t09_cod_act AND sub.t09_cod_sub=me.t09_cod_sub AND me.t02_version = (_anio+1) )
WHERE sub.t02_cod_proy=_proy
  AND sub.t08_cod_comp=_comp
  AND sub.t09_cod_act=_activ
  AND sub.t02_version= _ver_anio
  AND sub.t09_act_crit = 1
  
GROUP BY sub.t08_cod_comp, com.t08_comp_desc, sub.t09_cod_act, act.t09_act ,
	 sub.t09_cod_sub, sub.t09_um, sub.t09_sub, sub.t09_mta  ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_visita_financ_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_visita_financ_mf`(IN _proy VARCHAR(10))
BEGIN
SELECT 	inf.t52_num AS num, 
	(CASE WHEN inf.t52_tipo_vis=1 
	      THEN 'Visita de Supervisión Previa al Inicio del Proyecto' 
	      ELSE 'Visita de Supervisión en la Ejecución del Proyecto' 
	  END ) AS tipovisita,
	DATE_FORMAT((CASE WHEN inf.t52_fch_pre=0 THEN NULL ELSE inf.t52_fch_pre END),'%d/%m/%Y') AS fecpre , 
	inf.t52_periodo AS periodo, 
	inf.t52_estado , 
	est.descrip     AS estado,
	inf.t52_nom_per_ent AS nombres,
	inf.t52_car_per_ent AS cargo ,
	cal.descrip     AS califica,
	inf.t52_califica, 
	inf.usr_crea     AS monitor
FROM 	  t52_inf_visita_mf     inf
LEFT JOIN adm_tablas_aux est ON (inf.t52_estado=est.codi)
LEFT JOIN adm_tablas_aux cal ON (inf.t52_califica=cal.codi)
where  inf.t02_cod_proy = _proy ;	
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_inf_visita_mf_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_inf_visita_mf_anexos`(
				IN _proy VARCHAR(10), 
				IN _Num INT
				)
BEGIN
SELECT 	anx.t52_cod_anx,
	anx.t52_nom_file,
	anx.t52_url_file,
	anx.t52_desc_file
FROM t52_inf_visita_mf_anexos anx
WHERE  anx.t02_cod_proy=_proy 
  AND  anx.t52_id    = _Num ;
    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mensajes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mensajes`( )
BEGIN
SELECT 	
	id_men, 
	asu_men, 
	tex_men, 
	ori_men, 
	dest_men, 
	fec_men, 
	usu_men, 
	est_men	 
FROM 
	adm_mensajes
WHERE 	est_men=0;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mensajescp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mensajescp`()
BEGIN
SELECT 	
	id_msj, 
	t04_aprob_cmt, 
	t04_aprob_cmf, 
	t04_fec_ini
FROM 
	t04_sol_cambio_per
where t04_aprob_cmt = '0' OR
			t04_aprob_cmf = '0';
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_menus` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_menus`( in _admin boolean, in _parent varchar(8) )
BEGIN
if _admin = true THEN
  SELECT * 
    FROM adm_menus 
   WHERE mnu_activo='1' AND IFNULL(mnu_parent,'') = _parent
     and mnu_admin = '1'
   ORDER BY mnu_sort ASC ;
end if;
IF _admin = FALSE THEN
  SELECT * 
    FROM adm_menus 
   WHERE mnu_activo='1' AND IFNULL(mnu_parent,'') = _parent
     AND ifnull(mnu_admin,'0')='0'
   ORDER BY mnu_sort ASC ;
END IF;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_menus_by_parent` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_menus_by_parent`( in _parent varchar(8), in _perfil int)
BEGIN
SELECT  mnu.mnu_cod AS codigo,
        mnu.mnu_nomb AS nommenu,
	per.ver,
	per.nuevo,
	per.editar,
	per.eliminar
FROM      adm_menus mnu
left join adm_menus_perfil per on(mnu.mnu_cod=per.mnu_cod and per.per_cod=_perfil) 
WHERE mnu.mnu_parent = _parent
  and IFNULL(mnu.mnu_class,'') = '' 
ORDER BY mnu.mnu_cod, mnu.mnu_parent;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_menus_by_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_menus_by_perfil`( in _perfil int, _parent VARCHAR(8) )
BEGIN
SELECT 	m.mnu_cod,
	m.mnu_nomb,
	m.mnu_link,
	m.mnu_class,
	m.mnu_parent,
	m.mnu_sort,
	m.mnu_target,
	m.mnu_admin,
	(case when mp.per_cod is null then '0' else '1' end ) as 'tiene_permiso',
	mp.per_cod,
	mp.ver,
	mp.editar,
	mp.nuevo,
	mp.eliminar
FROM adm_menus m
LEFT JOIN adm_menus_perfil mp ON (m.mnu_cod=mp.mnu_cod AND mp.per_cod = _perfil )
   WHERE m.mnu_activo='1' 
     AND IFNULL(m.mnu_admin,'0')='0'
     AND IFNULL(mnu_parent,'') = _parent
   ORDER BY m.mnu_sort ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_menus_pagina` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_menus_pagina`( in _mnu varchar(8) )
BEGIN
  SELECT pag_cod as codigo,
	 pag_nomb as nombre,
	 pag_link as link
    FROM adm_menus_pagina 
   WHERE mnu_cod = _mnu
   ORDER BY pag_cod ASC ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_menus_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_menus_perfil`( in _admin boolean, _parent VARCHAR(8), IN _perfil INT )
BEGIN
SELECT 	m.mnu_cod,
	m.mnu_nomb,
	m.mnu_link,
	m.mnu_class,
	m.mnu_parent,
	m.mnu_sort,
	m.mnu_target,
	m.mnu_admin,
	(select count(1) from adm_menus sm where sm.mnu_parent=m.mnu_cod) as submenus,
	if(_parent='', 
		'1',
		(case when mp.per_cod is null then '0' else '1' end )
	  )	 as 'tiene_permiso',
	mp.per_cod,
	mp.ver,
	mp.editar,
	mp.nuevo,
	mp.eliminar
FROM adm_menus m
LEFT JOIN adm_menus_perfil mp ON (m.mnu_cod=mp.mnu_cod AND mp.per_cod = _perfil )
   WHERE m.mnu_activo='1' 
     AND IFNULL(m.mnu_admin,'0')=(case when _admin=true then '1' else '0' end )
     AND IFNULL(mnu_parent,'') = _parent
   ORDER BY m.mnu_sort ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_ml_indicadores_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_ml_indicadores_metas`(IN _proy VARCHAR(10), IN _ver INT, IN _comp INT, IN _activ INT, in _ind int)
BEGIN
		SELECT  _proy, 
				_ver , 
				anio.t02_anio,
				CONCAT('Año ', anio.t02_anio ) AS 'anio',
				SUM(CASE WHEN mta.t09_ind_mes=1 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes1,
				SUM(CASE WHEN mta.t09_ind_mes=2 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes2,
				SUM(CASE WHEN mta.t09_ind_mes=3 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes3,
				SUM(CASE WHEN mta.t09_ind_mes=4 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes4,
				SUM(CASE WHEN mta.t09_ind_mes=5 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes5,
				SUM(CASE WHEN mta.t09_ind_mes=6 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes6,
				SUM(CASE WHEN mta.t09_ind_mes=7 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes7,
				SUM(CASE WHEN mta.t09_ind_mes=8 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes8,
				SUM(CASE WHEN mta.t09_ind_mes=9 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes9,
				SUM(CASE WHEN mta.t09_ind_mes=10 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes10,
				SUM(CASE WHEN mta.t09_ind_mes=11 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes11,
				SUM(CASE WHEN mta.t09_ind_mes=12 AND mta.t09_ind_anio=anio.t02_anio THEN mta.t09_ind_mta ELSE NULL END) AS t09_mes12
		FROM      t02_duracion     anio
		LEFT JOIN t09_act_ind      ind ON(anio.t02_cod_proy=ind.t02_cod_proy AND anio.t02_version=ind.t02_version AND ind.t08_cod_comp=_comp AND ind.t09_cod_act=_activ AND ind.t09_cod_act_ind=_ind)
		LEFT JOIN t09_act_ind_mtas mta ON(ind.t02_cod_proy=mta.t02_cod_proy AND ind.t02_version=mta.t02_version AND ind.t08_cod_comp=mta.t08_cod_comp AND ind.t09_cod_act=mta.t09_cod_act AND ind.t09_cod_act_ind=mta.t09_cod_act_ind) 
		 WHERE anio.t02_cod_proy= _proy
		   AND anio.t02_version = _ver 
		GROUP BY 1,2,3,4;
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_monitor_externo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_monitor_externo`( IN _proy VARCHAR(10),
					   IN _ver INT  )
BEGIN
DECLARE _inst INT ;
DECLARE _cargo INT ;
SELECT 60 INTO _cargo ; 
SELECT p.t01_id_inst
INTO _inst 
FROM  t02_dg_proy p 
WHERE p.t02_cod_proy = _proy
  AND p.t02_version = _ver ;
SELECT 	CONCAT(c.t01_id_inst, '.', c.t01_id_cto) AS codigo,
	CONCAT(TRIM(c.t01_ape_pat), ' ', TRIM(c.t01_ape_mat), ', ', TRIM(c.t01_nom_cto)) AS nombres,
	'contacto' AS tipo,
	CONCAT(SUBSTR(i.t01_sig_inst,1,1)) AS orden,
	c.t01_id_inst AS orden2,
	CONCAT(TRIM(c.t01_ape_pat), ' ', TRIM(c.t01_ape_mat), ', ', TRIM(c.t01_nom_cto)) AS orden3
FROM  t01_inst_cto c
INNER JOIN t01_dir_inst i ON (c.t01_id_inst=i.t01_id_inst)
WHERE c.t01_id_inst NOT IN (_inst)
  AND c.t01_cgo_cto = _cargo
  
UNION 
SELECT 	i.t01_id_inst  AS codigo,
	i.t01_sig_inst AS nombres,
	'institucion'  AS tipo,
	CONCAT(SUBSTR(i.t01_sig_inst,1,1)) AS orden,
	c.t01_id_inst AS orden2,
	'-' AS orden3
FROM  t01_inst_cto c
INNER JOIN t01_dir_inst i ON (c.t01_id_inst=i.t01_id_inst)
WHERE c.t01_id_inst NOT IN (_inst)
  AND c.t01_cgo_cto = _cargo 
ORDER BY  orden ASC, orden2 ASC, orden3 ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_monitor_financiero` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_monitor_financiero`(  )
BEGIN
DECLARE _cargo INT ;
SELECT 70 INTO _cargo ; 
SELECT 	fe.t90_id_equi AS codigo,
	CONCAT(TRIM(fe.t90_ape_pat),' ', TRIM(fe.t90_ape_mat), ', ', TRIM(fe.t90_nom_equi)) AS nombres
FROM t90_equi_fe fe
WHERE fe.t90_carg_equi = _cargo 
ORDER BY 2 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_monitor_tematico` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_monitor_tematico`(  )
BEGIN
DECLARE _cargo INT ;
SELECT 69 INTO _cargo ; 
SELECT 	fe.t90_id_equi AS codigo,
	CONCAT(TRIM(fe.t90_ape_pat),' ', TRIM(fe.t90_ape_mat), ', ', TRIM(fe.t90_nom_equi)) AS nombres
FROM t90_equi_fe fe
WHERE fe.t90_carg_equi = _cargo 
ORDER BY 2 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_montotip_inst_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_montotip_inst_proy`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN
SELECT  IFNULL(adm_tablas_aux.abrev,'') AS tipoinst, 
	SUM(fn_costos_total_proyecto(t02_cod_proy,1)) AS cantidad 
FROM       t01_dir_inst 
INNER JOIN t02_dg_proy ON (t01_dir_inst.t01_id_inst = t02_dg_proy.t01_id_inst)
LEFT  JOIN adm_tablas_aux ON (t01_dir_inst.t01_tipo_inst=adm_tablas_aux.codi)
LEFT  JOIN adm_tablas_aux e ON (t02_dg_proy.t02_estado = e.codi)
WHERE  t02_dg_proy.t02_version = fn_ult_version_proy(t02_dg_proy.t02_cod_proy)
  AND 	SUBSTR(t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(t02_cod_proy,3,2) ELSE _concurso END )
  AND 	t02_estado = (CASE WHEN _estado='*' THEN t02_estado ELSE _estado END )    
GROUP BY adm_tablas_aux.abrev
ORDER BY cantidad DESC;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_equipa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_equipa`( in _proy char(10), in _vs int)
BEGIN
DECLARE _codfe int ;
DECLARE _ideje INT ;
DECLARE _verif_anio INT ;
SELECT fn_anio_x_version_proy(_proy, _vs) INTO _verif_anio ;
select 10 into _codfe ;
SELECT t01_id_inst INTO _ideje
FROM  t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_vs;
SELECT  equi.t03_id_equi as codigo, 
	equi.t03_nom_equi as equipo, 
	equi.t03_um as um,
	equi.t03_costo   as costo, 
	equi.t03_costo_tot as total,
	ifnull((select sum((CASE WHEN _verif_anio < 0 THEN t03_mta ELSE (CASE WHEN t03_anio=_verif_anio THEN t03_mta ELSE 0 END) END)) 
	 from t03_mp_equi_metas mta 
	 where equi.t02_cod_proy=mta.t02_cod_proy and equi.t02_version=mta.t02_version and equi.t03_id_equi=mta.t03_id_equi
	 ),0) as meta,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_equi_ftes fte
	 WHERE equi.t02_cod_proy=fte.t02_cod_proy 
	   AND equi.t02_version =fte.t02_version 
	   AND equi.t03_id_equi  =fte.t03_id_equi
	   and fte.t03_id_inst = _codfe
	) AS fte_fe,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_equi_ftes fte
	 WHERE equi.t02_cod_proy=fte.t02_cod_proy 
	   AND equi.t02_version =fte.t02_version 
	   AND equi.t03_id_equi  =fte.t03_id_equi
	   AND fte.t03_id_inst = _ideje
	) AS ejecutor,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_equi_ftes fte
	 WHERE equi.t02_cod_proy=fte.t02_cod_proy 
	   AND equi.t02_version =fte.t02_version 
	   AND equi.t03_id_equi  =fte.t03_id_equi
	   AND fte.t03_id_inst not in(_codfe, _ideje)
	) AS otros
FROM t03_mp_equi equi
where equi.t02_cod_proy=_proy
  and equi.t02_version = _vs ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_equipa_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_equipa_fuentes`( IN _proy VARCHAR(10), 
					     IN _ver  INT, 
					     IN _equi  INT)
BEGIN
	DECLARE _finantot DOUBLE;
	
	SELECT  ifnull(SUM(fte.t03_monto),0) INTO _finantot
	FROM t03_mp_equi_ftes fte 
	WHERE fte.t02_cod_proy = _proy
	  AND fte.t02_version  = _ver
	  AND fte.t03_id_equi  = _equi 	;
	  
	SELECT 	fina.t02_cod_proy, 
		fina.t01_id_inst ,
		inst.t01_sig_inst,
		fte.t03_id_equi,
		IFNULL(SUM((CASE WHEN fina.t01_id_inst=fte.t03_id_inst THEN fte.t03_monto ELSE 0 END)),0) AS mtofinan,
		IFNULL(ROUND(((SUM((CASE WHEN fina.t01_id_inst=fte.t03_id_inst THEN fte.t03_monto ELSE 0 END)) * 100) / _finantot),2),0) AS porcentaje
	FROM 	   t02_fuente_finan   fina
	INNER JOIN t01_dir_inst       inst ON (fina.t01_id_inst=inst.t01_id_inst)
	LEFT  JOIN t03_mp_equi_ftes    fte  ON (fina.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND fte.t03_id_equi=_equi)
	WHERE   fina.t02_cod_proy = _proy
	GROUP BY fina.t02_cod_proy, 
		 fina.t01_id_inst ,
		 inst.t01_sig_inst,
		 fte.t03_id_equi ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_equipa_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_equipa_metas`(IN _proy VARCHAR(10), IN _ver INT, in _equi int)
BEGIN
SELECT  anio.t02_cod_proy, 
	anio.t02_version , 
	anio.t02_anio,
	CONCAT('Año ', anio.t02_anio ) AS 'anio',
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=1 THEN mta.t03_mta ELSE NULL END) AS t03_mes1,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=2 THEN mta.t03_mta ELSE NULL END) AS t03_mes2,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=3 THEN mta.t03_mta ELSE NULL END) AS t03_mes3,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=4 THEN mta.t03_mta ELSE NULL END) AS t03_mes4,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=5 THEN mta.t03_mta ELSE NULL END) AS t03_mes5,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=6 THEN mta.t03_mta ELSE NULL END) AS t03_mes6,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=7 THEN mta.t03_mta ELSE NULL END) AS t03_mes7,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=8 THEN mta.t03_mta ELSE NULL END) AS t03_mes8,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=9 THEN mta.t03_mta ELSE NULL END) AS t03_mes9,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=10 THEN mta.t03_mta ELSE NULL END) AS t03_mes10,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=11 THEN mta.t03_mta ELSE NULL END) AS t03_mes11,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=12 THEN mta.t03_mta ELSE NULL END) AS t03_mes12,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio THEN mta.t03_mta ELSE 0 END) AS t03_tot_anio
FROM       t02_duracion     anio
LEFT  JOIN t03_mp_equi      equi ON(anio.t02_cod_proy=equi.t02_cod_proy AND anio.t02_version=equi.t02_version and equi.t03_id_equi=_equi)
LEFT  JOIN t03_mp_equi_metas mta ON(equi.t02_cod_proy=mta.t02_cod_proy AND equi.t02_version=mta.t02_version AND equi.t03_id_equi=mta.t03_id_equi)
 WHERE anio.t02_cod_proy= _proy
   AND anio.t02_version = _ver
GROUP BY 1,2,3,4 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_gasfunc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_gasfunc`( in _proy char(10), in _vs int)
BEGIN
DECLARE _codfe int ;
DECLARE _ideje INT ;

select 10 into _codfe ;
SELECT t01_id_inst INTO _ideje
FROM  t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_vs;

SELECT  parti.t03_partida AS idpartida, 
	tab.cod_ext       AS codigo ,
	tab.descrip   	  AS partida,
	parti.t03_um  	  AS um,
	parti.t03_meta 	  AS meta,
	IFNULL((SUM(cost.t03_cu * cost.t03_cant)),0)  AS parcial,
	(IFNULL((SUM(cost.t03_cu * cost.t03_cant)),0) * parti.t03_meta)  AS total  ,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     and fte.t03_id_inst  = _codfe
	)),0) AS fte_fe,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  = _ideje
	)),0) AS ejecutor,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  not in(_codfe, _ideje)
	)),0) AS otros
FROM 	  t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux      tab   ON(parti.t03_partida=tab.codi)
LEFT JOIN t03_mp_gas_fun_cost cost  ON(parti.t02_cod_proy=cost.t02_cod_proy AND parti.t02_version=cost.t02_version AND parti.t03_partida=cost.t03_partida)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version  = _vs 
GROUP BY   1,2,3,4,5  ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_gasfunc_categ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_gasfunc_categ`( in _proy char(10), in _vs int, in _gasfun int)
BEGIN
DECLARE _codfe int ;
DECLARE _ideje INT ;

select 10 into _codfe ;
SELECT t01_id_inst INTO _ideje
FROM  t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_vs;

SELECT  parti.t03_partida AS idpartida,
	cost.t03_cat_gast AS idcategoria,
	CONCAT(tab.cod_ext,'.',cate.cod_ext)AS codigo ,
	cate.descrip   	  AS categoria,
	''  	AS um,
	''	AS meta,
	IFNULL((SUM(cost.t03_cu * cost.t03_cant)),0)  AS parcial,
	(IFNULL((SUM(cost.t03_cu * cost.t03_cant)),0) * parti.t03_meta)  AS total  ,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  = _codfe
	)),0) AS fte_fe,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  = _ideje
	)),0) AS ejecutor,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  NOT IN(_codfe, _ideje)
	)),0) AS otros
FROM 	  t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux      tab   ON(parti.t03_partida=tab.codi)
LEFT JOIN t03_mp_gas_fun_cost cost  ON(parti.t02_cod_proy=cost.t02_cod_proy AND parti.t02_version=cost.t02_version AND parti.t03_partida=cost.t03_partida)
LEFT JOIN adm_tablas_aux      cate  ON(cost.t03_cat_gast=cate.codi)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version  = _vs
  AND parti.t03_partida = _gasfun
GROUP BY   1,2,3,4,5,6  ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_gasfunc_categ_gasto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_gasfunc_categ_gasto`( IN _proy CHAR(10), IN _vs INT, IN _gasfun INT, in _cate int)
BEGIN
DECLARE _codfe INT ;
DECLARE _ideje INT ;

SELECT 10 INTO _codfe ;
SELECT t01_id_inst INTO _ideje
FROM  t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_vs;

SELECT  parti.t03_partida AS idpartida,
	cost.t03_id_gasto AS idgasto,
	CONCAT(tab.cod_ext,'.',cate.cod_ext, '.', cost.t03_id_gasto)AS codigo ,
	cost.t03_descrip  AS gasto,
	cost.t03_um  	AS um,
	0	AS meta,
	cost.t03_cu,
	cost.t03_cant,
	(cost.t03_cu * cost.t03_cant)  AS parcial,
	((cost.t03_cu * cost.t03_cant) * parti.t03_meta)  AS total  ,
	IFNULL((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  = _codfe
	),0) AS fte_fe,
	IFNULL((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  = _ideje
	),0) AS ejecutor,
	IFNULL((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  NOT IN(_codfe, _ideje)
	),0) AS otros
FROM 	  t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux      tab   ON(parti.t03_partida=tab.codi)
LEFT JOIN t03_mp_gas_fun_cost cost  ON(parti.t02_cod_proy=cost.t02_cod_proy AND parti.t02_version=cost.t02_version AND parti.t03_partida=cost.t03_partida)
LEFT JOIN adm_tablas_aux      cate  ON(cost.t03_cat_gast=cate.codi)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version  = _vs 
  AND parti.t03_partida = _gasfun
  AND cost.t03_cat_gast = _cate
ORDER BY   1,2 ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_gasfunc_categ_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_gasfunc_categ_mf`(in _proy char(10), IN _num INT, IN _cod_fte INT , in _gasfun int)
BEGIN
DECLARE _ideje INT ;
DECLARE _mes_ini INT ;
DECLARE _mes_fin INT ;
	DECLARE _comp INT;
	DECLARE _act INT ;
	DECLARE _vs INT ;

SELECT fn_ult_version_proy(_proy) INTO _vs;
SELECT t01_id_inst INTO _ideje
FROM  t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_vs;
	SELECT t51_per_ini, t51_per_fin
		INTO _mes_ini, _mes_fin 
	FROM t51_inf_mf inf
	WHERE t02_cod_proy = _proy
	AND t51_num = _num;
SELECT 10, 3  INTO _comp, _act ;

SELECT  parti.t03_partida AS idpartida,
	cost.t03_cat_gast AS idcategoria,
	CONCAT(tab.cod_ext,'.',cate.cod_ext)AS codigo ,
	cate.descrip   	  AS categoria,
	''  	AS um,
	''	AS meta,
	IFNULL((SUM(cost.t03_cu * cost.t03_cant)),0)  AS parcial,
	(IFNULL((SUM(cost.t03_cu * cost.t03_cant)),0) * parti.t03_meta)  AS total  ,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  = _cod_fte 
	)),0) AS fte_fe,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  = _ideje
	)),0) AS ejecutor,
	IFNULL(sum((
	 SELECT SUM(fte.t03_monto)
	   FROM  t03_mp_gas_fun_ftes fte
	   WHERE fte.t02_cod_proy = cost.t02_cod_proy
	     AND fte.t02_version  = cost.t02_version
	     AND fte.t03_partida  = cost.t03_partida
	     AND fte.t03_id_gasto = cost.t03_id_gasto
	     AND fte.t03_id_inst  NOT IN(_cod_fte, _ideje)
	)),0) AS otros,
SUM(fn_monto_planificado_mp_fte_periodo( cost.t02_cod_proy, 
						  cost.t02_version,
						  3,
						  cost.t03_partida,
						  cost.t03_id_gasto,
						  _cod_fte,
						  _mes_ini,
						  _mes_fin
						)) AS planeado,
	
	IFNULL((
	    SELECT SUM(gas.t41_gasto) 
	     FROM  t41_inf_financ_gasto gas 
	     WHERE gas.t02_cod_proy=parti.t02_cod_proy
	      
	       AND gas.t08_cod_comp= _comp
	       AND gas.t09_cod_act = _act
				 AND gas.t09_cod_sub = tab.cod_ext
	       
	       AND gas.t41_fte_finan=_cod_fte 
	       and (fn_numero_mes(gas.t40_anio,gas.t40_mes) BETWEEN _mes_ini AND _mes_fin)
	),0) AS ejecutado,
	 m.t51_obs AS observaciones,
(SELECT IFNULL(SUM(na.t09_mto_no_acept),0) FROM t51_inf_mf_gastos_no_aceptados na WHERE (na.t51_num = _num AND na.t02_cod_proy = parti.t02_cod_proy AND na.t08_cod_comp = 10 AND na.t09_cod_act = 3   AND na.t09_cod_sub = tab.cod_ext AND na.t09_cod_sub_cat = cate.cod_ext and na.t51_fuente = _cod_fte)) AS gasto_no_aceptado
FROM 	  t03_mp_gas_fun_part parti
LEFT JOIN adm_tablas_aux      tab   ON(parti.t03_partida=tab.codi)
LEFT JOIN t03_mp_gas_fun_cost cost  ON(parti.t02_cod_proy=cost.t02_cod_proy AND parti.t02_version=cost.t02_version AND parti.t03_partida=cost.t03_partida)
LEFT JOIN adm_tablas_aux      cate  ON(cost.t03_cat_gast=cate.codi)
LEFT JOIN t51_inf_mf_avance_monto m on (m.t51_num = _num AND m.t02_cod_proy = parti.t02_cod_proy AND m.t08_cod_comp = 3 AND m.t09_cod_act = tab.cod_ext  AND m.t09_cod_sub = cate.cod_ext and m.t51_fuente = _cod_fte)
WHERE parti.t02_cod_proy = _proy
  AND parti.t02_version  = _vs
  AND parti.t03_partida = _gasfun
GROUP BY   1,2,3,4,5,6  ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_gasfunc_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_gasfunc_fuentes`( IN _proy VARCHAR(10), 
					      IN _ver  INT, 
					      IN _part  INT,
					      IN _gasto INT)
BEGIN
	DECLARE _finantot DOUBLE;
	
	SELECT  IFNULL(SUM(fte.t03_monto),0) INTO _finantot
	FROM t03_mp_gas_fun_ftes fte 
	WHERE fte.t02_cod_proy = _proy
	  AND fte.t02_version  = _ver
	  AND fte.t03_partida  = _part 	
	  AND fte.t03_id_gasto = _gasto ;
	  
	SELECT 	fina.t02_cod_proy, 
		fina.t01_id_inst ,
		inst.t01_sig_inst,
		fte.t03_id_gasto,
		IFNULL(SUM((CASE WHEN fina.t01_id_inst=fte.t03_id_inst THEN fte.t03_monto ELSE 0 END)),0) AS mtofinan,
		IFNULL(ROUND(((SUM((CASE WHEN fina.t01_id_inst=fte.t03_id_inst THEN fte.t03_monto ELSE 0 END)) * 100) / _finantot),2),0) AS porcentaje
	FROM 	   t02_fuente_finan   fina
	INNER JOIN t01_dir_inst       inst ON (fina.t01_id_inst=inst.t01_id_inst)
	LEFT  JOIN t03_mp_gas_fun_ftes    fte  ON (fina.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND fte.t03_partida=_part AND fte.t03_id_gasto=_gasto)
	WHERE   fina.t02_cod_proy = _proy
	GROUP BY fina.t02_cod_proy, 
		 fina.t01_id_inst ,
		 inst.t01_sig_inst,
		 fte.t03_id_gasto ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_gasfunc_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_gasfunc_metas`(IN _proy VARCHAR(10), IN _ver INT, in _partida int)
BEGIN
SELECT  anio.t02_cod_proy, 
	anio.t02_version , 
	anio.t02_anio,
	CONCAT('Año ', anio.t02_anio ) AS 'anio',
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=1 THEN mta.t03_mta ELSE NULL END) AS t03_mes1,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=2 THEN mta.t03_mta ELSE NULL END) AS t03_mes2,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=3 THEN mta.t03_mta ELSE NULL END) AS t03_mes3,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=4 THEN mta.t03_mta ELSE NULL END) AS t03_mes4,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=5 THEN mta.t03_mta ELSE NULL END) AS t03_mes5,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=6 THEN mta.t03_mta ELSE NULL END) AS t03_mes6,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=7 THEN mta.t03_mta ELSE NULL END) AS t03_mes7,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=8 THEN mta.t03_mta ELSE NULL END) AS t03_mes8,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=9 THEN mta.t03_mta ELSE NULL END) AS t03_mes9,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=10 THEN mta.t03_mta ELSE NULL END) AS t03_mes10,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=11 THEN mta.t03_mta ELSE NULL END) AS t03_mes11,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=12 THEN mta.t03_mta ELSE NULL END) AS t03_mes12,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio THEN mta.t03_mta ELSE 0 END) AS t03_tot_anio
FROM       t02_duracion     anio
LEFT  JOIN t03_mp_gas_fun_part      part ON(anio.t02_cod_proy=part.t02_cod_proy AND anio.t02_version=part.t02_version and part.t03_partida=_partida)
LEFT  JOIN t03_mp_gas_fun_metas mta ON(part.t02_cod_proy=mta.t02_cod_proy AND part.t02_version=mta.t02_version AND part.t03_partida=mta.t03_partida)
 WHERE anio.t02_cod_proy= _proy
   AND anio.t02_version = _ver
GROUP BY 1,2,3,4 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_gastos_adm` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_gastos_adm`(_proy VARCHAR(10), _ver INT)
BEGIN
DECLARE _contador INT ;
DECLARE _rowcount INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _sql      TEXT;
DECLARE _subquery TEXT;
DECLARE _sqlMP      TEXT;
DECLARE _subqueryMP TEXT;
CREATE TEMPORARY TABLE tmpFuentesFinanc
( id INT AUTO_INCREMENT,
  actividad VARCHAR(50) ,
  codigo INT,
  fuente VARCHAR(250),
  total_fuente  DOUBLE,
  PRIMARY KEY (id)
) ;
INSERT INTO tmpFuentesFinanc(actividad, codigo, fuente, total_fuente)
SELECT 'Personal del Proyecto' AS Actividad,
    f.t01_id_inst AS codigo,
    i.t01_sig_inst AS fuente,
    IFNULL(SUM(fte.t03_monto),0) AS total_fuente
FROM       t02_fuente_finan f
LEFT  JOIN t01_dir_inst     i   ON(f.t01_id_inst = i.t01_id_inst)
LEFT  JOIN t03_mp_per_ftes  fte ON(f.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND f.t01_id_inst=fte.t03_id_inst)
WHERE f.t02_cod_proy=_proy
GROUP BY 1,2,3
UNION ALL
SELECT 'Equipamiento del Proyecto' AS Actividad,
    f.t01_id_inst AS codigo,
    i.t01_sig_inst AS fuente,
    IFNULL(SUM(fte.t03_monto),0) AS total_fuente
FROM       t02_fuente_finan f
LEFT  JOIN t01_dir_inst     i   ON(f.t01_id_inst = i.t01_id_inst)
LEFT  JOIN t03_mp_equi_ftes  fte ON(f.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND f.t01_id_inst=fte.t03_id_inst)
WHERE f.t02_cod_proy=_proy
GROUP BY 1,2,3
UNION ALL
SELECT 'Gastos de Funcionamiento' AS Actividad,
    f.t01_id_inst AS codigo,
    i.t01_sig_inst AS fuente,
    IFNULL(SUM(fte.t03_monto),0) AS total_fuente
FROM       t02_fuente_finan f
LEFT  JOIN t01_dir_inst     i   ON(f.t01_id_inst = i.t01_id_inst)
LEFT  JOIN t03_mp_gas_fun_ftes  fte ON(f.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND f.t01_id_inst=fte.t03_id_inst)
WHERE f.t02_cod_proy=_proy
GROUP BY 1,2,3 
UNION ALL
SELECT  'Costos Operativos' AS Actividad,
    ins.t01_id_inst AS codigo,
    ins.t01_sig_inst AS fuente,
    SUM(fte.t10_mont) AS total
FROM  t10_cost_fte fte
INNER JOIN t01_dir_inst ins ON ( fte.t01_id_inst=ins.t01_id_inst )
WHERE fte.t02_cod_proy=_proy
  AND fte.t02_version=_ver
  AND fte.t10_mont>0 
GROUP BY 1,2,3 ;
SELECT  tmp.codigo, 
    tmp.fuente,
    SUM(total_fuente) AS financiado,
    
    IFNULL((
       SELECT t03_monto
         FROM t03_mp_gas_adm adm
         WHERE adm.t02_cod_proy=_proy AND adm.t02_version=_ver AND adm.t03_id_inst=tmp.codigo
    ),0) AS costo
  FROM tmpFuentesFinanc AS tmp
GROUP BY tmp.codigo, tmp.fuente ;

DROP TEMPORARY TABLE tmpFuentesFinanc;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_linea_base_imprevistos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_linea_base_imprevistos`(_proy VARCHAR(10), _ver INT)
BEGIN
DECLARE _linea_base double;
DECLARE _imprevistos double;
DECLARE _supervision double;
DECLARE _codfte   INT ;
select 10 into _codfte  ; 


SELECT IFNULL(SUM(t03_monto),0) 
  INTO _linea_base
  FROM t03_mp_linea_base
 WHERE t02_cod_proy = _proy 
   AND t02_version  = _ver 
   and t03_id_inst  = _codfte;
   

SELECT IFNULL(SUM(t03_monto),0) 
  INTO _imprevistos
  FROM t03_mp_imprevistos
 WHERE t02_cod_proy = _proy 
   AND t02_version  = _ver 
   AND t03_id_inst  = _codfte;
   

SELECT IFNULL(SUM(t03_monto),0) 
  INTO _supervision
  FROM t03_mp_gas_supervision
 WHERE t02_cod_proy = _proy 
   AND t02_version  = _ver 
   AND t03_id_inst  = _codfte;

SELECT _linea_base as 'linea_base', 
       _imprevistos as 'imprevistos',
       _supervision as 'supervision';
       
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_personal`( IN _proy CHAR(10), IN _vs INT)
BEGIN
DECLARE _codfe 		INT ;
DECLARE _ideje 		INT ;
DECLARE _verif_anio 	INT ;
DECLARE _est 		INT DEFAULT 113;
SELECT fn_anio_x_version_proy(_proy, _vs) INTO _verif_anio ;
SELECT 10 INTO _codfe ;
SELECT t01_id_inst INTO _ideje
FROM  t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_vs;
SELECT  per.t03_id_per AS codigo, 
	per.t03_nom_per AS cargo, 
	SUBSTRING(per.t03_tdr,1,150)  AS tdr, 
	per.t03_tdr_file AS linktdr, 
	
	aux.descrip AS um,
	per.t03_dedica AS porc_dedica, 
	per.t03_remu   AS remuneracion, 
	per.t03_perma  AS permanencia, 
	per.t03_remu_prom AS promedio,
	per.t03_gasto_tot AS gasto_tot ,
	IFNULL((SELECT SUM((CASE WHEN _verif_anio < 0 THEN t03_mta ELSE (CASE WHEN t03_anio=_verif_anio THEN t03_mta ELSE 0 END) END)) 
	 FROM t03_mp_per_metas mta 
	 WHERE per.t02_cod_proy=mta.t02_cod_proy AND per.t02_version=mta.t02_version AND per.t03_id_per=mta.t03_id_per
	 ),0) AS meta,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_per_ftes fte
	 WHERE per.t02_cod_proy=fte.t02_cod_proy 
	   AND per.t02_version =fte.t02_version 
	   AND per.t03_id_per  =fte.t03_id_per
	   AND fte.t03_id_inst = _codfe
	) AS fte_fe,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_per_ftes fte
	 WHERE per.t02_cod_proy=fte.t02_cod_proy 
	   AND per.t02_version =fte.t02_version 
	   AND per.t03_id_per  =fte.t03_id_per
	   AND fte.t03_id_inst = _ideje
	) AS ejecutor,
	(
	 SELECT SUM(t03_monto) 
	 FROM t03_mp_per_ftes fte
	 WHERE per.t02_cod_proy=fte.t02_cod_proy 
	   AND per.t02_version =fte.t02_version 
	   AND per.t03_id_per  =fte.t03_id_per
	   AND fte.t03_id_inst NOT IN(_codfe,_ideje)
	) AS otros,
	equ.t04_ape_pat AS paterno,
	equ.t04_ape_mat AS materno,
	equ.t04_nom_equi AS nombre,
	equ_aux.descrip AS especialidad		
FROM t03_mp_per per
LEFT JOIN t04_equi_proy equ ON(equ.t02_cod_proy = per.t02_cod_proy AND equ.t04_carg_equi = per.t03_id_per and equ.t04_estado = _est)
LEFT JOIN adm_tablas_aux aux ON(per.t03_um=aux.codi)
LEFT JOIN adm_tablas_aux equ_aux ON(equ_aux.codi = equ.t04_esp_equi)
WHERE per.t02_cod_proy=_proy
  AND per.t02_version = _vs ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_personal_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_personal_fuentes`( IN _proy VARCHAR(10), 
						IN _ver  INT, 
						IN _per  INT)
BEGIN
	DECLARE _finantot DOUBLE;
	
	SELECT  ifnull(SUM(fte.t03_monto),0) INTO _finantot
	FROM t03_mp_per_ftes fte 
	WHERE fte.t02_cod_proy = _proy
	  AND fte.t02_version  = _ver
	  AND fte.t03_id_per   = _per 	;
	SELECT 	fina.t02_cod_proy, 
		fina.t01_id_inst ,
		inst.t01_sig_inst,
		fte.t03_id_per,
		IFNULL(SUM((CASE WHEN fina.t01_id_inst=fte.t03_id_inst THEN fte.t03_monto ELSE 0 END)),0) AS mtofinan,
		IFNULL(ROUND(((SUM((CASE WHEN fina.t01_id_inst=fte.t03_id_inst THEN fte.t03_monto ELSE 0 END)) * 100) / _finantot),2),0) AS porcentaje
	FROM 	   t02_fuente_finan   fina
	INNER JOIN t01_dir_inst       inst ON (fina.t01_id_inst=inst.t01_id_inst)
	LEFT  JOIN t03_mp_per_ftes    fte  ON (fina.t02_cod_proy=fte.t02_cod_proy AND fte.t02_version=_ver AND fte.t03_id_per=_per)
	WHERE   fina.t02_cod_proy = _proy
	GROUP BY fina.t02_cod_proy, 
		 fina.t01_id_inst ,
		 inst.t01_sig_inst,
		 fte.t03_id_per ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_mp_personal_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_mp_personal_metas`(IN _proy VARCHAR(10), IN _ver INT, in _per int)
BEGIN
SELECT  anio.t02_cod_proy, 
	anio.t02_version , 
	anio.t02_anio,
	CONCAT('Año ', anio.t02_anio ) AS 'anio',
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=1 THEN mta.t03_mta ELSE 0 END) AS t03_mes1,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=2 THEN mta.t03_mta ELSE 0 END) AS t03_mes2,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=3 THEN mta.t03_mta ELSE 0 END) AS t03_mes3,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=4 THEN mta.t03_mta ELSE 0 END) AS t03_mes4,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=5 THEN mta.t03_mta ELSE 0 END) AS t03_mes5,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=6 THEN mta.t03_mta ELSE 0 END) AS t03_mes6,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=7 THEN mta.t03_mta ELSE 0 END) AS t03_mes7,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=8 THEN mta.t03_mta ELSE 0 END) AS t03_mes8,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=9 THEN mta.t03_mta ELSE 0 END) AS t03_mes9,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=10 THEN mta.t03_mta ELSE 0 END) AS t03_mes10,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=11 THEN mta.t03_mta ELSE 0 END) AS t03_mes11,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio AND mta.t03_mes=12 THEN mta.t03_mta ELSE 0 END) AS t03_mes12,
	SUM(CASE WHEN mta.t03_anio=anio.t02_anio THEN mta.t03_mta ELSE 0 END) AS t03_tot_anio
FROM       t02_duracion     anio
LEFT  JOIN t03_mp_per       per ON(anio.t02_cod_proy=per.t02_cod_proy AND anio.t02_version=per.t02_version and per.t03_id_per=_per)
LEFT  JOIN t03_mp_per_metas mta ON(per.t02_cod_proy=mta.t02_cod_proy AND per.t02_version=mta.t02_version AND per.t03_id_per=mta.t03_id_per)
 WHERE anio.t02_cod_proy= _proy
   AND anio.t02_version = _ver
GROUP BY 1,2,3,4 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_noobjecion_compra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_noobjecion_compra`(IN _proy VARCHAR(10))
BEGIN
SELECT 	noc.t02_cod_proy AS 'proyecto',
	noc.t02_id_noc AS 'codigo',  
	date_format(noc.t02_fch_ped,'%d/%m/%Y') as t02_fch_ped,
	date_format(noc.t02_fch_apr,'%d/%m/%Y') as t02_fch_apr,
	noc.t02_sco_noc, 
	noc.t02_com_noc, 
	noc.t02_act_noc, 
	noc.t02_sub_noc, 
	noc.t02_par_noc, 
	(
	case when noc.t02_com_noc = 10 then
		(
		 SELECT e.t03_nom_equi 
		   from  t03_mp_equi e
		   where e.t02_cod_proy=_proy
		    AND  e.t02_version=fn_ult_version_proy(_proy)
		    AND  e.t03_id_equi=noc.t02_par_noc
		)
	else
		(
		SELECT 	max( cat.descrip )
		FROM 	     t09_subact AS subact 
		INNER JOIN t10_cost_sub AS cost ON (subact.t02_cod_proy = cost.t02_cod_proy AND subact.t02_version = cost.t02_version AND subact.t08_cod_comp = cost.t08_cod_comp  AND subact.t09_cod_act = cost.t09_cod_act AND subact.t09_cod_sub = cost.t09_cod_sub ) 
		LEFT  JOIN adm_tablas_aux AS cat ON (cost.t10_cate_cost = cat.codi)
		WHERE 	    subact.t02_cod_proy=_proy
		    AND 	    subact.t02_version=fn_ult_version_proy(_proy)
		    AND 	    subact.t08_cod_comp=noc.t02_com_noc
		    AND 	    subact.t09_cod_act=noc.t02_act_noc
		    AND 	    subact.t09_cod_sub = noc.t02_sub_noc
		    AND cod_ext =noc.t02_par_noc    
		)
	 end
	) AS nom_partida,
	FORMAT(noc.t02_spa_noc,2)  AS 'saldo', 
	FORMAT(noc.t02_imp_noc,2)  AS 'importe', 
	noc.t02_ccp_noc, 
	noc.t02_cop_noc, 
	noc.t02_amt_noc, 
	noc.t02_amf_noc, 
	noc.t02_cmf_noc, 
	noc.t02_cmt_noc, 
	noc.t02_pro_noc, 
	noc.t02_obs_noc,
	noc.t02_env_rev,
	noc.t02_env_cor,
	noc.t02_estado 
	FROM  t02_noobjecion_compra noc
	WHERE noc.t02_cod_proy = _proy
	ORDER BY noc.t02_sco_noc ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_noobjecion_compra_anx` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_noobjecion_compra_anx`(
				IN _proy VARCHAR(10), 
				IN _id_noc INT
				)
BEGIN
SELECT 	anx.t02_cod_proy, 
	anx.t02_id_noc, 
	anx.t02_cod_anx, 
	anx.t02_nom_file, 
	anx.t02_url_file, 
	anx.t02_desc_file, 
	anx.usr_crea, 
	anx.fch_crea, 
	anx.usr_actu, 
	anx.fch_actu, 
	anx.est_audi	 
	FROM 
	t02_noobjecion_compra_anx anx
	WHERE  anx.t02_cod_proy=_proy 
        AND anx.t02_id_noc = _id_noc ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_objecion_compra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_objecion_compra`( IN _proy VARCHAR(10) )
BEGIN
SELECT 	oc.t02_cod_proy AS 'proyecto', 
	oc.t02_id_noc AS 'codigo', 
	oc.t02_sco_co, 
	FORMAT(oc.t02_par_co,2)  AS 'partida', 
	FORMAT(oc.t02_spa_co,2)  AS 'saldo', 
	FORMAT(oc.t02_imp_co,2)  AS 'importe', 
	oc.t02_ccp_co,
	oc.t02_cop_co, 
	oc.t02_amt_co, 
	oc.t02_amf_co,
	oc.t02_rmf_co, 	
	oc.t02_rep_co, 	
	oc.t02_obs_co	 
	FROM 
	t02_objecion_compra oc
	WHERE oc.t02_cod_proy = _proy
	ORDER BY oc.t02_sco_co ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_perfiles` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_perfiles`( )
BEGIN
  SELECT per_cod as codigo,
	 per_des as descripcion,
	 per_abrev as abreviado,
	 (select count(coduser) from adm_usuarios u where u.tipo_user=adm_perfiles.per_cod) as numusuarios
    FROM adm_perfiles
   ORDER BY per_des ASC ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_periodo_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_periodo_proy`( IN _proy VARCHAR(10) , IN _anio INT )
BEGIN
DECLARE _ver INT DEFAULT fn_ult_version_proy(_proy) ;
DECLARE _fecini DATETIME ;
DECLARE _nummes INT DEFAULT 1;
declare _dura_proy int default fn_numero_meses_proy(_proy, _ver);
SELECT t02_fch_ini
  INTO _fecini
  FROM t02_dg_proy
 WHERE t02_cod_proy = _proy AND t02_version = _ver ;
 
SELECT 	fechas.inicio,
	fechas.ini_mes,
	fechas.anio,
	fechas.mes,
	MONTH(fechas.ini_mes) AS num_mes,
	fn_nom_mes(MONTH(fechas.ini_mes)) AS nom_mes,
	UPPER(SUBSTRING(fn_nom_mes(MONTH(fechas.ini_mes)),1,3)) AS nom_abrev,
	YEAR(fechas.ini_mes) AS num_anio,
	(case when fn_numero_mes( fechas.anio, fechas.mes) > _dura_proy then '0' else '1' end ) as mes_ok
FROM (
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes-1) MONTH ) AS ini_mes,
	_anio AS anio,
	_nummes   AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes) MONTH ) AS ini_mes,
	_anio AS anio,
	_nummes + 1   AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+1) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 2)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+2) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 3)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+3) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 4)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+4) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 5)  AS mes	
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+5) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 6)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+6) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 7)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+7) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 8)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+8) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 9)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+9) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 10)  AS mes
UNION ALL
SELECT 	_fecini AS inicio,
	DATE_ADD(_fecini,INTERVAL fn_numero_mes(_anio,_nummes+10) MONTH ) AS ini_mes,
	_anio AS anio,
	(_nummes + 11)  AS mes
	
	) AS fechas ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_personal_equi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_personal_equi`(IN _proy VARCHAR(10))
BEGIN

SELECT  
	equi.t02_cod_proy,
	equi.t04_id_equi,
	equi.t04_dni_equi,
	(SELECT a.descrip FROM adm_tablas_aux a WHERE a.codi = equi.t04_sexo_equi) as sexo,
	equi.t04_edad_equi,
	(SELECT a.descrip FROM adm_tablas_aux a WHERE a.codi = equi.t04_cali_equi) as grado,
	equi.t04_mail_equi,
	equi.t04_telf_equi,
	equi.t04_cel_equi,
	equi.t04_fec_ini,
	equi.t04_fec_ter,
	equi.t04_func_equi,
	equi.t04_exp_lab,
(SELECT a.descrip FROM adm_tablas_aux a WHERE a.codi = equi.t04_estado) as estado,
	equi.t04_ape_pat AS paterno,
	equi.t04_ape_mat AS materno,
	equi.t04_nom_equi AS nombre,
	equ_aux.descrip AS especialidad		
FROM t04_equi_proy equi 
LEFT JOIN adm_tablas_aux equ_aux ON(equ_aux.codi = equi.t04_esp_equi)
WHERE equi.t02_cod_proy=_proy;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_at`( IN _proy VARCHAR(10) ,
				      in _ver int
				    )
BEGIN
declare _tiposub int ;
select 72 into _tiposub ;
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  concat( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) as codigo,
	  sub.t08_cod_comp  AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS subact,  
	  sub.t09_sub		AS descripcion, 
	  (CASE WHEN sub.t09_act_crit='1' THEN 'Si' ELSE 'No' END) AS critica,
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t12_nro_tema,
	  plan.t12_hor_cap,
	  plan.t12_nro_ben,
	  plan.t12_conten,
	  plan.t12_modulo,
	  modu.descrip as modulo
	FROM        t09_subact   sub
        LEFT JOIN t12_plan_at plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
        left join adm_tablas_aux modu on (plan.t12_modulo=modu.codi)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  sub.t09_tipo_sub = _tiposub
	ORDER BY
	  sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_capac`( IN _proy VARCHAR(10) ,
				      in _ver int
				    )
BEGIN
declare _tiposub int ;
select 71 into _tiposub ;
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  concat( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) as codigo,
	  sub.t08_cod_comp  AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS subact,  
	  sub.t09_sub		AS descripcion, 
	  (CASE WHEN sub.t09_act_crit='1' THEN 'Si' ELSE 'No' END) AS critica,
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t12_nro_tema,
	  plan.t12_hor_cap,
	  plan.t12_nro_ben,
	  plan.t12_conten,
	  plan.t12_modulo,
	  modu.descrip as modulo
	FROM        t09_subact   sub
        LEFT JOIN t12_plan_capac plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
        left join adm_tablas_aux modu on (plan.t12_modulo=modu.codi)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  sub.t09_tipo_sub = _tiposub
	ORDER BY
	  sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_capac_temas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_capac_temas`(  IN _proy VARCHAR(10) ,
				             IN _ver INT,
				             in _comp int,
				             in _act int,
				             in _sub int
				            )
BEGIN
select 	t08_cod_comp, 
	t09_cod_act, 
	t09_cod_sub, 
	t12_cod_tema, 
	t12_tem_espe, 
	t12_nro_hora, 
	t12_nro_bene, 
	fch_crea
from  t12_plan_capac_tema 
where t02_cod_proy = _proy
  and t02_version  = _ver 
  and t08_cod_comp = _comp
  and t09_cod_act  = _act
  and t09_cod_sub  = _sub 
order by t12_tem_espe ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_cred`(  IN _proy VARCHAR(10) ,
				      in _ver int
				    )
BEGIN
declare _tiposub int ;
select 73 into _tiposub ;
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  CONCAT( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) AS codigo,
	  CONCAT( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub, '.- ', sub.t09_sub) AS subactividad,
	  sub.t08_cod_comp  AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS subact,  
	  sub.t09_sub		AS descripcion, 
	  (CASE WHEN sub.t09_act_crit='1' THEN 'Si' ELSE 'No' END) AS critica,
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t09_cod_sub    as sub2,
	  plan.t12_nro_ben,
	  plan.t12_mto_ben,
	  plan.t12_nro_cuo,
	  plan.t12_tasa_int,
	  plan.t12_obs
	FROM        t09_subact   sub
        LEFT JOIN t12_plan_cred  plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  sub.t09_tipo_sub = _tiposub
	ORDER BY
	  sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_dup_cap_tema` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_dup_cap_tema`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
	INSERT INTO t12_plan_capac_tema
	SELECT
		c.t02_cod_proy,
		_ver+1,
		c.t08_cod_comp,
		c.t09_cod_act,
		c.t09_cod_sub,
		c.t12_cod_tema,
		c.t12_tem_espe,
		c.t12_nro_hora,
		c.t12_nro_bene,
		NOW(),
		c.usr_crea,
		c.usr_actu,
		c.fch_actu,
		c.est_audi
	FROM t12_plan_capac_tema	c
	WHERE c.t02_cod_proy = _proy
	AND c.t02_version = _ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_otros`(IN _proy VARCHAR(10) ,
   in _ver int)
BEGIN
declare _tiposub int default 74 ; 
declare _tiposub2 int default 254 ; 
SELECT	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  concat( sub.t08_cod_comp,'.',sub.t09_cod_act,'.',sub.t09_cod_sub) as codigo,
	  sub.t08_cod_comp  AS comp, 
	  sub.t09_cod_act	AS act, 
	  sub.t09_cod_sub	AS subact,  
	  sub.t09_sub		AS descripcion, 
	  (CASE WHEN sub.t09_act_crit='1' THEN 'Si' ELSE 'No' END) AS critica,
	  sub.t09_um		AS um, 
	  sub.t09_mta		AS meta,
	  plan.t12_producto,
	  plan.t12_nro_ent,
	  plan.t12_nro_ben,
	  plan.t12_tot_ent,
	  plan.t12_conten,
	  plan.t12_tipo,
	  tip.descrip as tipo
	FROM        t09_subact   sub
        LEFT JOIN t12_plan_otros plan ON (sub.t02_cod_proy = plan.t02_cod_proy AND sub.t02_version = plan.t02_version AND sub.t08_cod_comp = plan.t08_cod_comp AND sub.t09_cod_act = plan.t09_cod_act AND sub.t09_cod_sub = plan.t09_cod_sub)
        left join adm_tablas_aux tip on (plan.t12_tipo=tip.codi)
	WHERE  sub.t02_cod_proy = _proy
	  AND  sub.t02_version  = _ver
	  AND  (sub.t09_tipo_sub = _tiposub  || sub.t09_tipo_sub = _tiposub2)
	 
	ORDER BY
	  sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_visita` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_plan_visita`( IN _proy VARCHAR(10), in _visita int)
BEGIN
declare _min_envio_solicitud int ;
if _visita <= 0 THEN
SELECT MIN(t31_id)  into _min_envio_solicitud
FROM t31_plan_me 
WHERE t02_cod_proy = _proy
  AND IFNULL(t31_fec_vis,0) = 0 ;
  
  
SELECT  vis.t02_cod_proy,
	vis.t31_id,
	vis.t31_anio,
	vis.t31_mes,
	fn_nom_mes(vis.t31_mes) AS nommes,
	vis.t31_obs,
	vis.t31_mto_v1,
	vis.t31_mto_v2,
	vis.t31_mto_tot,
	DATE_FORMAT((CASE WHEN vis.t31_fec_vis =0 THEN NULL ELSE vis.t31_fec_vis END),'%d/%m/%Y') AS t31_fec_vis,
	DATE_FORMAT((CASE WHEN vis.t31_fec_ter =0 THEN NULL ELSE vis.t31_fec_ter END),'%d/%m/%Y') AS t31_fec_ter,
	vis.t31_vb_v1,	
	vis.t31_des_v1,
	vis.t31_des_v2,
	vis.t31_des_tot,
	(case when vis.t31_id = _min_envio_solicitud then '1' else '0' end) as 'sol_via',
	vis.usr_crea,
	vis.est_audi
FROM t31_plan_me vis
WHERE  vis.t02_cod_proy=_proy ;
ELSE
SELECT  vis.t02_cod_proy,
	vis.t31_id,
	vis.t31_anio,
	vis.t31_mes,
	fn_nom_mes(vis.t31_mes) AS nommes,
	vis.t31_obs,
	vis.t31_mto_v1,
	vis.t31_mto_v2,
	vis.t31_mto_tot,
	DATE_FORMAT((CASE WHEN vis.t31_fec_vis =0 THEN NULL ELSE vis.t31_fec_vis END),'%d/%m/%Y') AS t31_fec_vis,
	DATE_FORMAT((CASE WHEN vis.t31_fec_ter =0 THEN NULL ELSE vis.t31_fec_ter END),'%d/%m/%Y') AS t31_fec_ter,
	vis.t31_vb_v1,	
	vis.t31_des_v1,
	vis.t31_des_v2,
	vis.t31_des_tot,
	(CASE WHEN vis.t31_id = _min_envio_solicitud THEN '1' ELSE '0' END) AS 'sol_via',
	vis.usr_crea,
	vis.est_audi
FROM t31_plan_me vis
WHERE vis.t02_cod_proy = _proy 
  AND vis.t31_id       = _visita ;

END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_visita_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_visita_act`( 
					IN _proy VARCHAR(10)
						)
BEGIN
SELECT 	t32_id_vta AS num,  
	DATE_FORMAT(t32_fch_vta, '%d/%m/%Y') AS fecha, 
	t32_obj_vta AS objetivo, 
	t32_per_ent AS per_entrevista, 
	t32_rec_nec AS recursos, 
	est_audi
FROM t32_plan_vta 
WHERE t02_cod_proy = _proy ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_plan_visita_act_det` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_plan_visita_act_det`( 
					IN _proy VARCHAR(10),
					IN _vta INT
						)
BEGIN

SELECT  act.t32_id_act,
	act.t32_cod_act,
	tipact.descrip AS actividad,
	DATE_FORMAT(act.t32_fch_ini, '%d/%m/%Y') AS t32_fch_ini, 
	DATE_FORMAT(act.t32_fch_ter, '%d/%m/%Y') AS t32_fch_ter, 
	act.t32_esp_act,
	act.usr_crea,
	act.fch_crea,
	act.est_audi
FROM  	  t32_plan_act act 
LEFT JOIN adm_tablas_aux tipact ON(act.t32_cod_act=tipact.codi)
WHERE t02_cod_proy = _proy 
  AND t32_id_vta   = _vta ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_poa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_poa`(IN _proy VARCHAR(10))
BEGIN
select
	poa.t02_anio,fn_version_proy_poa(_proy,poa.t02_anio) as version,
	concat('Año ', poa.t02_anio) as anio, 
	poa.t02_periodo as periodo, 
	substring(poa.t02_punto_aten,1,200) as punto_atencion, 
	FORMAT((fn_costos_total_proyecto(_proy, fn_version_proy_poa(_proy, poa.t02_anio))),2) as presupuesto,
	e.descrip as estado,
	e2.descrip as estado_mf,
	poa.t02_aprob_cmt as apro_cmt,
	poa.t02_aprob_cmf AS apro_cmf
from 	  t02_poa poa 
left join adm_tablas_aux e on (poa.t02_estado=e.codi)
LEFT JOIN adm_tablas_aux e2 ON (poa.t02_estado_mf=e2.codi)
where 	poa.t02_cod_proy = _proy 
ORDER BY poa.t02_anio asc;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_poa_anexos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_poa_anexos`(
				IN _proy VARCHAR(10), 
				IN _anio INT 
				)
BEGIN
SELECT 	anx.t02_cod_anx,
		anx.t02_nom_file,
		anx.t02_url_file,
		anx.t02_desc_file
  FROM  t02_poa_anexos anx
 WHERE  t02_cod_proy = _proy 
   AND  anx.t02_anio = _anio ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_poa_fin_vb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_poa_fin_vb`(IN _user VARCHAR(10))
BEGIN
    DECLARE var_all_proy INT DEFAULT 0;
    DECLARE var_type_user INT DEFAULT 0;
    
    SELECT IF(t02_cod_proy = '*', 1, 0), tipo_user INTO var_all_proy, var_type_user FROM adm_usuarios WHERE coduser = _user;
    
    IF var_type_user = 16 THEN  
        IF var_all_proy = 1 THEN
            SELECT
                poa.t02_cod_proy AS proy,
                poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
                concat('Año ', poa.t02_anio) AS anio, 
                poa.t02_periodo AS periodo, 
                substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
                FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
                est.descrip AS estado,
                IF(poa.vb_se_fin = 1, 'V°B°', '') AS vb_se
            FROM t02_poa poa, adm_tablas_aux est
            WHERE poa.t02_estado_mf = est.codi 
            AND poa.t02_estado_mf = 259
            AND poa.vb_se_fin = 0 
            ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        ELSE
           SELECT
                poa.t02_cod_proy AS proy,
                poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
                concat('Año ', poa.t02_anio) AS anio, 
                poa.t02_periodo AS periodo, 
                substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
                FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
                est.descrip AS estado,
                IF(poa.vb_se_fin = 1, 'V°B°', '') AS vb_se
            FROM t02_poa poa, adm_usuarios u, adm_tablas_aux est
            WHERE poa.t02_cod_proy = u.t02_cod_proy
            AND poa.t02_estado_mf = est.codi 
            AND poa.t02_estado_mf = 259
            AND poa.vb_se_fin = 0
            AND u.coduser = _user
            ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        END IF;
    ELSEIF var_type_user = 13 THEN  
        IF var_all_proy = 1 THEN
            SELECT
                poa.t02_cod_proy AS proy,
                poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
                concat('Año ', poa.t02_anio) AS anio, 
                poa.t02_periodo AS periodo, 
                substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
                FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
                est.descrip AS estado,
                IF(poa.vb_se_fin = 1, 'V°B°', '') AS vb_se
            FROM t02_poa poa, adm_tablas_aux est
            WHERE poa.t02_estado_mf = est.codi 
            AND poa.t02_estado_mf = 259
            ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        ELSE
           SELECT
                poa.t02_cod_proy AS proy,
                poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
                concat('Año ', poa.t02_anio) AS anio, 
                poa.t02_periodo AS periodo, 
                substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
                FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
                est.descrip AS estado,
                IF(poa.vb_se_fin = 1, 'V°B°', '') AS vb_se
            FROM t02_poa poa, adm_usuarios u, adm_tablas_aux est
            WHERE poa.t02_cod_proy = u.t02_cod_proy
            AND poa.t02_estado_mf = est.codi 
            AND poa.t02_estado_mf = 259
            AND u.coduser = _user
            ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        END IF;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_poa_tec_vb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_poa_tec_vb`(IN _user VARCHAR(10))
BEGIN
    DECLARE var_all_proy INT DEFAULT 0;
	DECLARE var_type_user INT DEFAULT 0;
	
	SELECT IF(t02_cod_proy = '*', 1, 0), tipo_user INTO var_all_proy, var_type_user FROM adm_usuarios WHERE coduser = _user;
	
	IF var_type_user = 16 THEN  
	    IF var_all_proy = 1 THEN
			SELECT
			    poa.t02_cod_proy AS proy,
		        poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
			    concat('Año ', poa.t02_anio) AS anio, 
			    poa.t02_periodo AS periodo, 
			    substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
			    FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
			    est.descrip AS estado,
			    IF(poa.vb_se_tec = 1, 'V°B°', '') AS vb_se
			FROM t02_poa poa, adm_tablas_aux est
			WHERE poa.t02_estado = est.codi 
            AND poa.t02_estado = 46
            AND poa.vb_se_tec = 0 
			ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        ELSE
           SELECT
                poa.t02_cod_proy AS proy,
                poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
                concat('Año ', poa.t02_anio) AS anio, 
                poa.t02_periodo AS periodo, 
                substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
                FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
                est.descrip AS estado,
                IF(poa.vb_se_tec = 1, 'V°B°', '') AS vb_se
            FROM t02_poa poa, adm_usuarios u, adm_tablas_aux est
            WHERE poa.t02_cod_proy = u.t02_cod_proy
            AND poa.t02_estado = est.codi 
            AND poa.t02_estado = 46
            AND poa.vb_se_tec = 0
            AND u.coduser = _user
            ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        END IF;
    ELSEIF var_type_user = 13 THEN  
        IF var_all_proy = 1 THEN
            SELECT
                poa.t02_cod_proy AS proy,
                poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
                concat('Año ', poa.t02_anio) AS anio, 
                poa.t02_periodo AS periodo, 
                substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
                FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
                est.descrip AS estado,
                IF(poa.vb_se_tec = 1, 'V°B°', '') AS vb_se
            FROM t02_poa poa, adm_tablas_aux est
            WHERE poa.t02_estado = est.codi 
            AND poa.t02_estado = 46
            ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        ELSE
           SELECT
                poa.t02_cod_proy AS proy,
                poa.t02_anio,fn_version_proy_poa(poa.t02_cod_proy,poa.t02_anio) AS version,
                concat('Año ', poa.t02_anio) AS anio, 
                poa.t02_periodo AS periodo, 
                substring(poa.t02_punto_aten,1,200) AS punto_atencion, 
                FORMAT((fn_costos_total_proyecto(poa.t02_cod_proy, fn_version_proy_poa(poa.t02_cod_proy, poa.t02_anio))),2) AS presupuesto,
                est.descrip AS estado,
                IF(poa.vb_se_tec = 1, 'V°B°', '') AS vb_se
            FROM t02_poa poa, adm_usuarios u, adm_tablas_aux est
            WHERE poa.t02_cod_proy = u.t02_cod_proy
            AND poa.t02_estado = est.codi 
            AND poa.t02_estado = 46
            AND u.coduser = _user
            ORDER BY poa.t02_cod_proy, poa.t02_anio ASC;
        END IF;
    END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_prod_en_entregable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_sel_prod_en_entregable`(in _proy varchar(10), _ver int, _anio INT, _entregable INT)
BEGIN
    SELECT DISTINCT
        concat(prod.t08_cod_comp,'.',prod.t09_cod_act) as codigo,
        concat(prod.t08_cod_comp,'.',prod.t09_cod_act, ' ', prod.t09_act ) as producto,
        prod.t08_cod_comp,
        prod.t09_cod_act,
        prod.t09_act,
        prod.t09_obs
    FROM t09_act prod 
    JOIN t02_entregable_act_ind prog ON (prod.t02_cod_proy = prog.t02_cod_proy AND prod.t08_cod_comp = prog.t08_cod_comp AND prod.t09_cod_act = prog.t09_cod_act AND prog.t02_anio = _anio AND prog.t02_mes = _entregable)
    WHERE prod.t02_cod_proy = _proy 
    AND prod.t02_version = _ver 
    ORDER BY prod.t08_cod_comp, prod.t09_cod_act;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_proyectos_ejec_desemb_entre` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_proyectos_ejec_desemb_entre`(IN _proy VARCHAR(10), IN _vs INT)
BEGIN

SELECT

  inst.t01_sig_inst AS ejecutor,
  proy.t02_cod_proy AS codigo,  
entre.t02_cod_proy  AS cod,

  proy.t02_nom_proy AS nombre,
  entre.t02_mes AS mes,
  entre.t02_anio AS anio,
  entre.monto_desemb AS monto,
  fn_nom_periodo_entregable(proy.t02_cod_proy, proy.t02_version, entre.t02_anio,entre.t02_mes ) AS periodo, 
  fn_numero_entregable(proy.t02_cod_proy, proy.t02_version, entre.t02_anio,entre.t02_mes) AS entregable 
 
FROM
  t02_entregable entre, t02_dg_proy proy

LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst = inst.t01_id_inst) 
WHERE proy.t02_cod_proy = entre.t02_cod_proy  
  AND entre.t02_cod_proy = _proy 
GROUP BY entre.t02_mes,entre.t02_anio
ORDER BY entre.t02_anio, entre.t02_mes;


END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_proy_anx` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_proy_anx`(
				IN _proy VARCHAR(10), 
				IN _ver INT
				)
BEGIN
SELECT 	anx.t02_cod_anx,
	anx.t02_nom_file,
	anx.t02_url_file,
	anx.t02_desc_file,
	t02_anx_tip_desc
FROM t02_proy_anx anx
LEFT JOIN t02_proy_anx_tip 
        ON (t02_proy_anx_tip.t02_anx_tip_cod = anx.t02_anx_tip_cod)
WHERE  t02_cod_proy=_proy 
       AND  anx.t02_version =_ver ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_proy_est` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_proy_est`(IN _user VARCHAR(20))
BEGIN  


DECLARE _estado_suspendido INT DEFAULT 42 ; 
DECLARE _estado_cancelado INT DEFAULT 43 ; 
DECLARE _estado_cerrado INT DEFAULT 44 ; 

DECLARE _tipouser INT ;
DECLARE _inst VARCHAR(10);
DECLARE _proy VARCHAR(10);
SELECT tipo_user, IFNULL(t01_id_uni,'*'), IFNULL(t02_cod_proy,'*')
INTO  _tipouser, _inst, _proy
FROM adm_usuarios
WHERE coduser = _user ;

IF _tipouser = 16 THEN 
SELECT
    inst.t01_sig_inst AS ejecutor,
    proy.t02_cod_proy AS codigo,
    proy.t02_nro_exp AS 'exp', 
    proy.t02_version AS vs,
    proy.t02_nom_proy AS nombre, 
    DATE_FORMAT(proy.t02_fch_ini,'%d/%m/%Y') AS inicio, 
    DATE_FORMAT(proy.t02_fch_ter,'%d/%m/%Y') AS termino, 
    proy.t01_id_inst, 
    inst.t01_nom_inst AS nomejecutor,
    proy.usr_crea,
    proy.t02_estado
FROM      t02_dg_proy proy
LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy)
  AND proy.t02_estado NOT IN (_estado_suspendido, _estado_cancelado, _estado_cerrado)
  AND proy.t02_moni_ext = (CASE WHEN '*' = _inst THEN proy.t02_moni_ext ELSE _inst END ) 
  AND proy.t02_cod_proy = (CASE WHEN '*' = _proy THEN proy.t02_cod_proy ELSE _proy END ) ;
END IF ;

IF _tipouser = 13 THEN 
SELECT
    inst.t01_sig_inst AS ejecutor,
    proy.t02_cod_proy AS codigo,
    proy.t02_nro_exp AS 'exp', 
    proy.t02_version AS vs,
    proy.t02_nom_proy AS nombre, 
    DATE_FORMAT(proy.t02_fch_ini,'%d/%m/%Y') AS inicio, 
    DATE_FORMAT(proy.t02_fch_ter,'%d/%m/%Y') AS termino, 
    proy.t01_id_inst, 
    inst.t01_nom_inst AS nomejecutor,
    proy.usr_crea,
    proy.t02_estado
FROM      t02_dg_proy proy
LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy)
  AND proy.t02_estado NOT IN (_estado_suspendido, _estado_cancelado, _estado_cerrado)
  AND proy.t02_moni_fina = (CASE WHEN '*' = _inst THEN proy.t02_moni_fina ELSE _inst END ) 
  AND proy.t02_cod_proy = (CASE WHEN '*' = _proy THEN proy.t02_cod_proy ELSE _proy END ) ;
END IF ;

IF _tipouser = 2 THEN 
SELECT
    inst.t01_sig_inst AS ejecutor,
    proy.t02_cod_proy AS codigo,
    proy.t02_nro_exp AS 'exp', 
    proy.t02_version AS vs,
    proy.t02_nom_proy AS nombre, 
    DATE_FORMAT(proy.t02_fch_ini,'%d/%m/%Y') AS inicio, 
    DATE_FORMAT(proy.t02_fch_ter,'%d/%m/%Y') AS termino, 
    proy.t01_id_inst, 
    inst.t01_nom_inst AS nomejecutor,
    proy.usr_crea,
    apr.t02_aprob_ml,
    apr.t02_aprob_cro,
    apr.t02_aprob_pre,
    proy.t02_estado
FROM      t02_dg_proy proy
LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
LEFT JOIN t02_aprob_proy apr ON (proy.t02_cod_proy= apr.t02_cod_proy)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy)
  AND proy.t02_estado NOT IN (_estado_suspendido, _estado_cancelado, _estado_cerrado)
  AND proy.t01_id_inst = (CASE WHEN '*' = _inst THEN proy.t01_id_inst ELSE _inst END ) 
  AND proy.t02_cod_proy = (CASE WHEN '*' = _proy THEN proy.t02_cod_proy ELSE _proy END ) ;
END IF ;

IF _tipouser <> 2 AND _tipouser <> 13 AND _tipouser <> 16  THEN 
SELECT
    inst.t01_sig_inst AS ejecutor,
    proy.t02_cod_proy AS codigo,
    proy.t02_nro_exp AS 'exp', 
    proy.t02_version AS vs,
    proy.t02_nom_proy AS nombre, 
    DATE_FORMAT(proy.t02_fch_ini,'%d/%m/%Y') AS inicio, 
    DATE_FORMAT(proy.t02_fch_ter,'%d/%m/%Y') AS termino, 
    proy.t01_id_inst, 
    inst.t01_nom_inst AS nomejecutor,
    proy.usr_crea,
    proy.t02_estado
FROM      t02_dg_proy proy
LEFT JOIN t01_dir_inst inst ON (proy.t01_id_inst=inst.t01_id_inst)
WHERE proy.t02_version = fn_ult_version_proy(proy.t02_cod_proy)
  AND proy.t02_estado NOT IN (_estado_suspendido, _estado_cancelado, _estado_cerrado)
  AND proy.t02_cod_proy = (CASE WHEN '*' = _proy THEN proy.t02_cod_proy ELSE _proy END ) ;
END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_reportes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_reportes`( IN _cat INT)
BEGIN
IF IFNULL(_cat,0)=0 THEN
	
	SELECT  DISTINCT
		NULL AS codigo, 
		cat.nom_cate AS titulo, 
		NULL AS descripcion,
		NULL AS url, 
		NULL  AS parametros, 
		cat.cod_cate ,
		cat.nom_cate AS categoria,
		cat.cod_cate AS idsort
	FROM adm_reportes_categ cat 
	LEFT JOIN adm_reportes rep ON (rep.cat_rpt = cat.cod_cate)
	
	UNION ALL
	
	SELECT  rep.cod_rpt AS codigo, 
		rep.tit_rpt AS titulo, 
		rep.des_rpt AS descripcion,
		rep.url_rpt AS url, 
		rep.url_param  AS parametros, 
		rep.cat_rpt ,
		cat.nom_cate AS categoria,
		CONCAT(cat.cod_cate,'.',rep.cat_rpt) AS idsort
	FROM adm_reportes rep 
	LEFT JOIN adm_reportes_categ cat ON (rep.cat_rpt=cat.cod_cate)
	WHERE rep.estado = 1
	
	ORDER BY idsort ;
ELSE
	SELECT  rep.cod_rpt AS codigo, 
		rep.tit_rpt AS titulo, 
		rep.des_rpt AS descripcion,
		rep.url_rpt AS url, 
		rep.url_param  AS parametros, 
		rep.cat_rpt ,
		cat.nom_cate AS categoria
	FROM adm_reportes rep 
	LEFT JOIN adm_reportes_categ cat ON (rep.cat_rpt=cat.cod_cate)
	WHERE rep.estado = 1
	  AND rep.cat_rpt = _cat;
END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_reportes_categorias` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_reportes_categorias`()
BEGIN
	SELECT 	cod_cate AS codigo, 
		nom_cate AS descripcion
	FROM 	adm_reportes_categ 
	ORDER BY cod_cate ASC;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_resp_cargo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_resp_cargo`(IN _cargo INT)
BEGIN
SELECT 	CONCAT(c.t01_id_inst, '.', c.t01_id_cto) AS codigo,
	CONCAT(TRIM(c.t01_ape_pat), ' ', TRIM(c.t01_ape_mat), ', ', TRIM(c.t01_nom_cto)) AS nombres,
	'contacto' AS tipo
FROM  t01_inst_cto c
WHERE c.t01_cgo_cto = _cargo
UNION 
SELECT 	i.t01_id_inst  AS codigo,
	i.t01_sig_inst AS nombres,
	'institucion'  AS tipo
FROM  t01_inst_cto c
INNER JOIN t01_dir_inst i ON (c.t01_id_inst=i.t01_id_inst)
WHERE c.t01_cgo_cto = _cargo
ORDER BY codigo, nombres ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_res_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_res_inst`(IN _inst INT)
BEGIN
	SELECT		t1.t01_id_cto,
				t1.t01_id_inst,
				t1.t01_cgo_cto,
				CONCAT(t1.t01_ape_pat, ' ', t1.t01_ape_mat, ' ', t1.t01_nom_cto) AS nombres,
				t1.t01_dni_cto,
				t2.descrip AS cargo,
				t1.t01_fono_ofi,
				t1.t01_cel_cto,
				t01_mail_cto
	FROM		t01_inst_cto t1
	LEFT JOIN	adm_tablas_aux t2 ON (t2.codi = t1.t01_cgo_cto)
	WHERE		t1.t01_id_inst = _inst AND t01_rep_flg = '1'
	ORDER BY	nombres;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_sector_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_sector_prod`(IN _proy VARCHAR(10))
BEGIN   
    SELECT  t02.t02_cod_proy,
        t02.t02_sector_main,
        t02.t02_sector,
        t02.t02_subsec,
        secmain.nom_tabla AS sector_main,
        sec.descrip AS sector,
        sub.descrip AS subsector,
        t02.t02_obs
    FROM t02_sector_prod t02
    LEFT JOIN adm_tablas secmain ON (t02.t02_sector_main=secmain.cod_tabla)
    LEFT JOIN adm_tablas_aux sec ON (t02.t02_sector=sec.codi)
    LEFT JOIN adm_tablas_aux2 sub ON (t02.t02_subsec=sub.codi)
    WHERE t02_cod_proy = _proy ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_sec_inst_proy2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_sec_inst_proy2`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN
		DECLARE _contador INT ;
		DECLARE _sql_filas TEXT;
		DECLARE _sql TEXT;
		DECLARE _tipoinst VARCHAR(20);
		DROP TEMPORARY TABLE IF EXISTS tmpTipoInst;
		CREATE TEMPORARY TABLE tmpTipoInst
		( id INT AUTO_INCREMENT,
		  codigo INT,
		  nombre VARCHAR(250),
		  PRIMARY KEY (id)
		) ;
		INSERT INTO tmpTipoInst(codigo, nombre)
			SELECT  DISTINCT
				IFNULL(a.codi,0) AS codi,
				IFNULL(a.abrev,'') AS abrev
			FROM			t01_dir_inst	AS i
				INNER JOIN	t02_dg_proy 	AS p ON (i.t01_id_inst = p.t01_id_inst)
				LEFT JOIN	adm_tablas_aux	AS a ON (i.t01_tipo_inst = a.codi )
				LEFT JOIN	adm_tablas_aux	AS e ON (p.t02_estado = e.codi)
			WHERE	p.t02_version = fn_ult_version_proy(p.t02_cod_proy) 		AND
					SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END )		AND
					p.t02_estado = (CASE WHEN _estado='*' THEN p.t02_estado ELSE _estado END )   
			GROUP BY a.descrip
			ORDER BY COUNT(p.t02_cod_proy) DESC; 
		SELECT 1 , ' ' INTO _contador, _sql_filas ;
		WHILE (SELECT COUNT(1) FROM  tmpTipoInst) >= _contador DO
			SELECT nombre 
			INTO _tipoinst 
			FROM tmpTipoInst 
			WHERE id=_contador ;
			
			SET _sql_filas = CONCAT(_sql_filas, ' , COUNT(IF(a.abrev = "', _tipoinst, '",p.t01_id_inst,NULL )) AS \'', _tipoinst, '\'');
			SELECT _contador +1 INTO _contador ;
		END WHILE ;
		SELECT CONCAT('
				SELECT
				a.abrev, s.descrip ' ,
				_sql_filas, 
				', FORMAT(SUM(p.t02_pres_fe), 2) AS "APORTE FE", 
				FORMAT(SUM(p.t02_pres_otro), 2) AS "OTROS APORTES", 
				FORMAT(IFNULL(SUM(p.t02_pres_fe)+SUM(p.t02_pres_otro),0), 2) AS "PRESUPUESTO TOTAL" ',
				' FROM      t02_dg_proy   AS  p
				  LEFT JOIN t01_dir_inst   AS  i ON (i.t01_id_inst = p.t01_id_inst)
				  LEFT JOIN adm_tablas_aux AS  a ON (a.codi = i.t01_tipo_inst)
				  LEFT JOIN adm_tablas_aux AS  s ON (s.codi = p.t02_sect_prod) 
				  LEFT JOIN  adm_tablas_aux AS e ON (p.t02_estado=e.codi)
				WHERE  p.t02_version = fn_pri_version_proy(p.t02_cod_proy) 
				  AND p.t02_estado = ', IF (_estado = '*', 'p.t02_estado', _estado), ' 
				  GROUP BY s.descrip 
				  ORDER BY -s.descrip DESC, s.descrip') INTO _sql;
		
		SELECT _sql INTO @txtsql;
		PREPARE stmt FROM @txtsql;
		EXECUTE stmt;
		DEALLOCATE PREPARE stmt; 
		DROP TEMPORARY TABLE tmpTipoInst;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_sec_inst_proy3` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_sec_inst_proy3`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN
	SELECT	w.region,
			w.actividad, 
			w.cantidad,
			fn_costo_presupuesto_fe(w.t02_cod_proy, w.t02_version) AS FE, 
			fn_costo_presupuesto_otros(w.t02_cod_proy, w.t02_version) AS OTROS
	FROM (
		SELECT	p.t02_cod_proy,
				p.t02_version,
				dep.nom_ubig AS region, 
				s.descrip AS actividad,
				COUNT(DISTINCT p.t02_cod_proy) AS cantidad
		FROM		t02_dg_proy  	p 
		LEFT JOIN 	t03_dist_proy 	dp	ON (dp.t02_cod_proy = p.t02_cod_proy AND dp.t02_version = p.t02_version)
		LEFT JOIN	adm_ubigeo 		dep ON (dp.t03_dpto = dep.cod_dpto AND dep.cod_prov = '00' AND dep.cod_dist = '00')
		LEFT JOIN	adm_tablas_aux  s 	ON (s.codi = p.t02_sect_prod) 
		WHERE 	p.t02_version = 1
			AND SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END ) 
			AND p.t02_estado = (CASE WHEN _estado='*' THEN p.t02_estado ELSE _estado END ) 
		GROUP BY p.t02_cod_proy, p.t02_version, dep.nom_ubig, s.descrip 
		) w;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_subactividad` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_subactividad`( IN _proy VARCHAR(10) ,
				    IN _ver INT,
				    IN _comp INT,
				    IN _act INT
									  )
BEGIN
SELECT	  sub.t02_cod_proy, 
		  sub.t02_version, 
		  sub.t08_cod_comp  AS comp, 
		  sub.t09_cod_act	AS act, 
		  sub.t09_cod_sub	AS subact,  
		  sub.t09_sub		AS descripcion, 
		  (CASE WHEN sub.t09_act_crit='1' THEN 'Si' ELSE 'No' END) AS critica,
		  sub.t09_um		AS um, 
		  sub.t09_mta		AS meta,
		  SUM(CASE WHEN mta.t09_anio=1 THEN mta.t09_mta ELSE NULL END) AS a1,
		  SUM(CASE WHEN mta.t09_anio=2 THEN mta.t09_mta ELSE NULL END) AS a2,
		  SUM(CASE WHEN mta.t09_anio=3 THEN mta.t09_mta ELSE NULL END) AS a3,
		  SUM(CASE WHEN mta.t09_anio=4 THEN mta.t09_mta ELSE NULL END) AS a4,
		  SUM(CASE WHEN mta.t09_anio=5 THEN mta.t09_mta ELSE NULL END) AS a5,
		  IF(sub.t02_version > 1,
			 IF(sub.t09_cod_sub IN (
					SELECT sub.t09_cod_sub	AS subact		 
					FROM t09_subact       sub
					WHERE  sub.t02_cod_proy = _proy
					  AND  sub.t02_version  = 1
					  AND  sub.t08_cod_comp = _comp
					  AND  sub.t09_cod_act  = _act
					  GROUP BY 1
					  ORDER BY subact
						),'','1')		  
		  ,'') AS act_add	,
		  sub.t09_fv	  as fv
		FROM        t09_subact       sub
		  LEFT JOIN t09_sub_act_mtas mta ON (sub.t02_cod_proy = mta.t02_cod_proy AND sub.t02_version = mta.t02_version AND sub.t08_cod_comp = mta.t08_cod_comp AND sub.t09_cod_act = mta.t09_cod_act AND sub.t09_cod_sub = mta.t09_cod_sub)
		WHERE  sub.t02_cod_proy = _proy
		  AND  sub.t02_version  = _ver
		  AND  sub.t08_cod_comp = _comp
		  AND  sub.t09_cod_act  = _act
		GROUP BY 1,2,3,4,5,6,7,8,9
		ORDER BY 
		  sub.t08_cod_comp, sub.t09_cod_act, sub.t09_cod_sub;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_subactividad_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_subactividad_costeo`(IN _proy varchar(10), IN _ver int, IN _comp int, IN _activ int)
BEGIN
DECLARE _codfe int ;
DECLARE _ideje INT ;
select 10 		   into _codfe ;
SELECT t01_id_inst INTO _ideje FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
SELECT
	  CONCAT( sub.t08_cod_comp,'.', sub.t09_cod_act,'.', sub.t09_cod_sub) as codigo,
	  sub.t09_cod_sub,
	  sub.t09_sub as subactividad,
	  sub.t09_um  as um,
	  sub.t09_mta as meta,
	  (SUM(cost.t10_cu * cost.t10_cant) )  as ctoparcial,
	  (SUM(cost.t10_cu * cost.t10_cant) * sub.t09_mta)  as ctototal,
	  IFNULL((SELECT SUM(fte.t10_mont) 
				FROM t10_cost_fte fte 
			   where fte.t02_cod_proy = cost.t02_cod_proy 
				 and fte.t02_version  = cost.t02_version
				 AND fte.t08_cod_comp = cost.t08_cod_comp 
				 AND fte.t09_cod_act=cost.t09_cod_act 
				 AND fte.t09_cod_sub= cost.t09_cod_sub),0) as fuentesfinan,
				 
	   IFNULL((SELECT SUM(fte.t10_mont) 
				FROM t10_cost_fte fte 
			   WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				 AND fte.t02_version  = cost.t02_version
				 AND fte.t08_cod_comp = cost.t08_cod_comp 
				 AND fte.t09_cod_act  = cost.t09_cod_act 
				 AND fte.t09_cod_sub  = cost.t09_cod_sub
				 and fte.t01_id_inst  = _codfe ),0) AS fte_fe,
				 
		IFNULL((SELECT SUM(fte.t10_mont) 
				FROM t10_cost_fte fte 
			   WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				 AND fte.t02_version  = cost.t02_version
				 AND fte.t08_cod_comp = cost.t08_cod_comp 
				 AND fte.t09_cod_act  = cost.t09_cod_act 
				 AND fte.t09_cod_sub  = cost.t09_cod_sub
				 AND fte.t01_id_inst  = _ideje ),0) AS ejecutor,
				 
		IFNULL((SELECT SUM(fte.t10_mont) 
				FROM t10_cost_fte fte 
			   WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				 AND fte.t02_version  = cost.t02_version
				 AND fte.t08_cod_comp = cost.t08_cod_comp 
				 AND fte.t09_cod_act  = cost.t09_cod_act 
				 AND fte.t09_cod_sub  = cost.t09_cod_sub
				 AND fte.t01_id_inst  not in(_ideje, _codfe) ),0) AS otros
	FROM       t09_subact sub 
	LEFT  JOIN t10_cost_sub cost ON(sub.t02_cod_proy = cost.t02_cod_proy and sub.t02_version=cost.t02_version  AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub= cost.t09_cod_sub )
	LEFT  JOIN adm_tablas_aux cat ON (cost.t10_cate_cost = cat.codi)
	WHERE sub.t02_cod_proy=_proy
	  AND sub.t02_version =_ver
	  AND sub.t08_cod_comp=_comp
	  AND sub.t09_cod_act =_activ
	GROUP BY 1, 2, 3, 4, 5 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_subactividad_costeo_categ` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_subactividad_costeo_categ`(IN _proy varchar(10), IN _ver int, IN _comp int, IN _activ int, IN _subactiv int)
BEGIN
DECLARE _codfe INT ;
DECLARE _ideje INT ;
SELECT 10 		   INTO _codfe ;
SELECT t01_id_inst INTO _ideje FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
SELECT 	cost.t08_cod_comp as comp, 
	    cost.t09_cod_act  as activ, 
		cost.t09_cod_sub  as subact, 
		cat.cod_ext       as codcat, 
		cost.t10_cate_cost,
		CONCAT( subact.t08_cod_comp,'.', subact.t09_cod_act,'.', subact.t09_cod_sub,'.', cat.cod_ext ) as codigo,
		cat.codi, cat.descrip as categoria, 
		CONCAT( subact.t08_cod_comp,'.', subact.t09_cod_act,'.', subact.t09_cod_sub,'.', cat.cod_ext,'.- ', cat.descrip) AS desc_cat,
	        (SUM(cost.t10_cu * cost.t10_cant) )  as ctoparcial,
		(SUM(cost.t10_cu * cost.t10_cant) * subact.t09_mta)  as ctototal,
		IFNULL(
			   (SELECT SUM(fte.t10_mont) 
				FROM 		t10_cost_fte fte 
				INNER JOIN  t10_cost_sub cost2 ON (fte.t02_cod_proy = cost2.t02_cod_proy and fte.t02_version=cost2.t02_version AND fte.t08_cod_comp = cost2.t08_cod_comp AND fte.t09_cod_act=cost2.t09_cod_act AND fte.t09_cod_sub= cost2.t09_cod_sub AND fte.t10_cod_cost=cost2.t10_cod_cost)
				WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				and fte.t02_version  = cost.t02_version
				AND fte.t08_cod_comp = cost.t08_cod_comp 
				AND fte.t09_cod_act=cost.t09_cod_act 
				AND fte.t09_cod_sub= cost.t09_cod_sub 
				AND cost2.t10_cate_cost=cost.t10_cate_cost)
			   ,0) AS fuentesfinan,
		
		IFNULL((SELECT SUM(fte.t10_mont) 
				FROM 		t10_cost_fte fte 
				INNER JOIN  t10_cost_sub cost2 ON (fte.t02_cod_proy = cost2.t02_cod_proy AND fte.t02_version=cost2.t02_version AND fte.t08_cod_comp = cost2.t08_cod_comp AND fte.t09_cod_act=cost2.t09_cod_act AND fte.t09_cod_sub= cost2.t09_cod_sub AND fte.t10_cod_cost=cost2.t10_cod_cost)
				WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				AND fte.t02_version  = cost.t02_version
				AND fte.t08_cod_comp = cost.t08_cod_comp 
				AND fte.t09_cod_act=cost.t09_cod_act 
				AND fte.t09_cod_sub= cost.t09_cod_sub 
				AND cost2.t10_cate_cost=cost.t10_cate_cost
				AND fte.t01_id_inst  = _codfe ),0) AS fte_fe,
				 
		IFNULL((SELECT SUM(fte.t10_mont) 
				FROM 		t10_cost_fte fte 
				INNER JOIN  t10_cost_sub cost2 ON (fte.t02_cod_proy = cost2.t02_cod_proy AND fte.t02_version=cost2.t02_version AND fte.t08_cod_comp = cost2.t08_cod_comp AND fte.t09_cod_act=cost2.t09_cod_act AND fte.t09_cod_sub= cost2.t09_cod_sub AND fte.t10_cod_cost=cost2.t10_cod_cost)
				WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				AND fte.t02_version  = cost.t02_version
				AND fte.t08_cod_comp = cost.t08_cod_comp 
				AND fte.t09_cod_act=cost.t09_cod_act 
				AND fte.t09_cod_sub= cost.t09_cod_sub 
				AND cost2.t10_cate_cost=cost.t10_cate_cost
				AND fte.t01_id_inst  = _ideje ),0) AS ejecutor,
				 
		IFNULL((SELECT SUM(fte.t10_mont) 
				FROM 		t10_cost_fte fte 
				INNER JOIN  t10_cost_sub cost2 ON (fte.t02_cod_proy = cost2.t02_cod_proy AND fte.t02_version=cost2.t02_version AND fte.t08_cod_comp = cost2.t08_cod_comp AND fte.t09_cod_act=cost2.t09_cod_act AND fte.t09_cod_sub= cost2.t09_cod_sub AND fte.t10_cod_cost=cost2.t10_cod_cost)
				WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				AND fte.t02_version  = cost.t02_version
				AND fte.t08_cod_comp = cost.t08_cod_comp 
				AND fte.t09_cod_act=cost.t09_cod_act 
				AND fte.t09_cod_sub= cost.t09_cod_sub 
				AND cost2.t10_cate_cost=cost.t10_cate_cost
				AND fte.t01_id_inst  NOT IN(_ideje, _codfe) ),0) AS otros
			   
			   
			   
			   
			   
FROM 	     t09_subact AS subact 
INNER JOIN t10_cost_sub AS cost ON (subact.t02_cod_proy = cost.t02_cod_proy and subact.t02_version = cost.t02_version and subact.t08_cod_comp = cost.t08_cod_comp  and subact.t09_cod_act = cost.t09_cod_act AND subact.t09_cod_sub = cost.t09_cod_sub ) 
LEFT  JOIN adm_tablas_aux AS cat ON (cost.t10_cate_cost = cat.codi)
WHERE 	    subact.t02_cod_proy=_proy
    AND 	    subact.t02_version=_ver
    AND 	    subact.t08_cod_comp=_comp
    AND 	    subact.t09_cod_act=_activ
    AND 	    subact.t09_cod_sub = _subactiv
GROUP BY 	1, 2, 3, 4, 5, 6, 7
ORDER BY cost.t08_cod_comp , 
	     cost.t09_cod_act  , 
		 cost.t09_cod_sub  , 
		 cost.t10_cate_cost ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_subactividad_costeo_gastos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_subactividad_costeo_gastos`(IN _proy varchar(10), IN _ver int, IN _comp int, IN _activ int, IN _subactiv int, IN _categ int)
BEGIN
DECLARE _codfe INT default 10;
DECLARE _ideje INT ;
SELECT t01_id_inst INTO _ideje FROM t02_dg_proy WHERE t02_cod_proy=_proy AND t02_version=_ver;
	SELECT 	cost.t02_cod_proy, 
		cost.t02_version, 
		cost.t08_cod_comp, 
		cost.t09_cod_act, 
		cost.t09_cod_sub, 
		cost.t10_cod_cost, 
		cost.t10_cost, 
		cost.t10_um, 
		cost.t10_cant, 
		cost.t10_cu, 
		cost.t10_cost_parc, 
		(sub.t09_mta * cost.t10_cost_parc ) as t10_cost_tot, 
		sub.t09_mta,
		cost.t10_obs_mf,
		IFNULL((SELECT SUM(fte.t10_mont) 
				  FROM t10_cost_fte fte 
				 where fte.t02_cod_proy = cost.t02_cod_proy 
				   and fte.t02_version = cost.t02_version 
				   AND fte.t08_cod_comp = cost.t08_cod_comp 
				   AND fte.t09_cod_act=cost.t09_cod_act 
				   AND fte.t09_cod_sub= cost.t09_cod_sub 
				   AND fte.t10_cod_cost=cost.t10_cod_cost),0 ) as fuentesfinan,
				   
		IFNULL((SELECT SUM(fte.t10_mont) 
				  FROM t10_cost_fte fte 
				 WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				   AND fte.t02_version = cost.t02_version 
				   AND fte.t08_cod_comp = cost.t08_cod_comp 
				   AND fte.t09_cod_act=cost.t09_cod_act 
				   AND fte.t09_cod_sub= cost.t09_cod_sub 
				   AND fte.t10_cod_cost=cost.t10_cod_cost
				   and fte.t01_id_inst  = _codfe),0 ) AS fte_fe,
		
		IFNULL((SELECT SUM(fte.t10_mont) 
				  FROM t10_cost_fte fte 
				 WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				   AND fte.t02_version = cost.t02_version 
				   AND fte.t08_cod_comp = cost.t08_cod_comp 
				   AND fte.t09_cod_act=cost.t09_cod_act 
				   AND fte.t09_cod_sub= cost.t09_cod_sub 
				   AND fte.t10_cod_cost=cost.t10_cod_cost
				   AND fte.t01_id_inst  = _ideje),0 ) AS ejecutor,
		
		IFNULL((SELECT SUM(fte.t10_mont) 
				  FROM t10_cost_fte fte 
				 WHERE fte.t02_cod_proy = cost.t02_cod_proy 
				   AND fte.t02_version = cost.t02_version 
				   AND fte.t08_cod_comp = cost.t08_cod_comp 
				   AND fte.t09_cod_act=cost.t09_cod_act 
				   AND fte.t09_cod_sub= cost.t09_cod_sub 
				   AND fte.t10_cod_cost=cost.t10_cod_cost
				   AND fte.t01_id_inst NOT IN(_ideje, _codfe) ),0 ) AS otros
		
FROM 		t09_subact     sub 
INNER JOIN    t10_cost_sub  cost ON (sub.t02_cod_proy = cost.t02_cod_proy AND sub.t02_version = cost.t02_version AND sub.t08_cod_comp = cost.t08_cod_comp AND sub.t09_cod_act = cost.t09_cod_act AND sub.t09_cod_sub = cost.t09_cod_sub)
WHERE 	    sub.t02_cod_proy=_proy
    AND 	    sub.t02_version=_ver
    AND 	    sub.t08_cod_comp=_comp
    AND 	    sub.t09_cod_act=_activ
    AND 	    sub.t09_cod_sub = _subactiv
    AND 	    cost.t10_cate_cost=_categ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_sub_noc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_sub_noc`(IN _proy VARCHAR(10),IN _comp INT, IN _act INT)
BEGIN
DECLARE _ver  INT DEFAULT fn_ult_version_proy(_proy);
DECLARE _anio INT DEFAULT 1 ;
	
SELECT
	  sub.t02_cod_proy, 
	  sub.t02_version, 
	  _comp  AS comp, 
	  _act   AS act, 
	  SUBSTRING_INDEX(sub.codigo,'.',-1)	AS subact,  
	  sub.descripcion		AS descripcion, 
	  CONCAT(sub.codigo, '.- ', SUBSTRING(sub.descripcion,1,100)) AS descrip
FROM      v_subactividades sub
WHERE  sub.t02_cod_proy = _proy 
  AND  sub.t02_version = _ver 
  AND  SUBSTRING_INDEX(sub.codigo,'.',2)  = CONCAT(_comp,'.', _act)
ORDER BY sub.codigo ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_supervisor_intitucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_supervisor_intitucion`( IN _proy VARCHAR(10),
					         IN _ver INT  )
BEGIN
DECLARE _inst INT ;
DECLARE _cargo INT ;
SELECT 61 INTO _cargo ; 
SELECT p.t01_id_inst
INTO _inst 
FROM  t02_dg_proy p 
WHERE p.t02_cod_proy = _proy
  AND p.t02_version = _ver ;
SELECT 	c.t01_id_cto AS codigo,
	CONCAT(TRIM(c.t01_ape_pat), ' ', TRIM(c.t01_ape_mat), ', ', TRIM(c.t01_nom_cto)) AS nombres
  FROM  t01_inst_cto c
 WHERE  c.t01_id_inst = _inst
   AND  c.t01_cgo_cto = _cargo
ORDER BY 2 ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tablas_aux` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tablas_aux`( in _idtabla int )
BEGIN
  
  SELECT codi as codigo, 
	 descrip as descripcion, 
	 abrev   as abreviatura, 
	 ifnull(cod_ext,'-') as externo, 
	 (case when flg_act='1' then 'Activo' else 'Inactivo' end) as activo, 
	 orden, 
	 usu_crea
	FROM adm_tablas_aux 
	where idTabla = _idtabla  ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tablas_aux_2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tablas_aux_2`( IN _idtabla INT, IN _idtablaaux INT )
BEGIN
  
  SELECT codi as codigo, 
	 descrip as descripcion, 
	 abrev   as abreviatura, 
	 ifnull(cod_ext,'-') as externo, 
	 (case when flg_act='1' then 'Activo' else 'Inactivo' end) as activo, 
	 orden, 
	 usu_crea
	FROM adm_tablas_aux2 
	WHERE idTabla = _idtabla AND id_tabla_aux = _idtablaaux ;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tipocuenta` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tipocuenta`()
BEGIN	
	select 	tcu.t00_cod_cta  as codigo,
		tcu.t00_nom_abre as abreviado,
		tcu.t00_nom_lar  as nombre,
		tcu.est_audi     as estado
	from t00_tipo_cuenta tcu;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tipomoneda` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tipomoneda`()
BEGIN	
	SELECT 	mon.t00_cod_mon  AS codigo,
		mon.t00_nom_abre AS abreviado,
		mon.t00_nom_lar  AS nombre,
		mon.est_audi     AS estado
	FROM t00_tipo_moneda mon;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tipopago` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tipopago`()
BEGIN	
	SELECT 	tpa.t00_tip_pago  AS codigo,
		tpa.t00_nom_abre AS abreviado,
		tpa.t00_nom_lar  AS nombre,
		tpa.est_audi     AS estado
	FROM t00_tipo_pago tpa;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tipo_anx_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tipo_anx_proy`()
BEGIN
SELECT 	t02_anx_tip_cod AS codigo,
	t02_anx_tip_desc AS descripcion, 
	t02_anx_tip_abrev AS abreviatura
FROM    t02_proy_anx_tip ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tipo_serv_tema` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tipo_serv_tema`(IN _anio INT, IN _concurso VARCHAR(10))
BEGIN
	DECLARE anio INT;
	
	SELECT MAX(t25_anio) INTO anio FROM t25_inf_trim 
	WHERE t25_periodo LIKE CONCAT("%",_anio,"%");
	
	SELECT		"Capacitación" AS servicio, 
				SUM(plan.t12_nro_ben) AS benef,
				plan.t12_modulo,
				modu.descrip AS modulo
	FROM		t12_plan_capac plan
	INNER JOIN	adm_tablas_aux modu ON (plan.t12_modulo = modu.codi)
	WHERE		plan.t02_version = (anio+1)
			AND SUBSTR(plan.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(plan.t02_cod_proy,3,2) ELSE _concurso END)
	GROUP BY plan.t12_modulo
	UNION 
	SELECT 		"Asistencia Técnica" AS servicio,
				SUM(plan.t12_nro_ben) AS benef,
				plan.t12_modulo,
				modu.descrip AS modulo
	FROM		t12_plan_at plan
	INNER JOIN	adm_tablas_aux modu ON (plan.t12_modulo=modu.codi)
	WHERE		plan.t02_version = (anio+1)
			AND SUBSTR(plan.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(plan.t02_cod_proy,3,2) ELSE _concurso END)
	GROUP BY plan.t12_modulo
	UNION 
	SELECT		"Créditos" AS servicio,
				SUM(plan.t12_nro_ben) AS benef,
				"" t12_modulo,
				"" AS modulo
	FROM		t12_plan_cred plan
	WHERE		plan.t02_version = (anio+1)
			AND SUBSTR(plan.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(plan.t02_cod_proy,3,2) ELSE _concurso END)
	GROUP BY t12_modulo
	UNION 
	SELECT		"Otros Servicios" AS servicio,
				SUM(plan.t12_nro_ben) AS benef,
				plan.t12_tipo,
				modu.descrip AS modulo
	FROM		t12_plan_otros plan
	INNER JOIN	adm_tablas_aux modu ON (plan.t12_tipo=modu.codi)
	WHERE 		plan.t02_version = (anio+1)
			AND SUBSTR(plan.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(plan.t02_cod_proy,3,2) ELSE _concurso END)
	GROUP BY plan.t12_tipo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tipo_serv_tema_region` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tipo_serv_tema_region`(IN _anio INT, IN _concurso VARCHAR(10))
BEGIN
	DECLARE anio INT;
	SELECT MAX(t25_anio) INTO anio FROM t25_inf_trim WHERE t25_periodo LIKE CONCAT("%",_anio,"%");
	
	(SELECT		"1" AS sort_ord,
				"Capacitación" AS servicio, 
				plan.t12_nro_tema,
				plan.t12_hor_cap,
				SUM(plan.t12_nro_ben) AS benef,
				plan.t12_modulo,
				modu.descrip AS modulo,
				u.nom_ubig AS region,
				des.descrip
	FROM		t12_plan_capac	plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	(SELECT t02_cod_proy, t02_version, t03_dpto 
				 FROM t03_dist_proy 
				 GROUP BY t02_cod_proy, t02_version)	dis	ON (dis.t02_cod_proy = p.t02_cod_proy AND 
																dis.t02_version = p.t02_version)
	LEFT JOIN	adm_tablas_aux	modu	ON (plan.t12_modulo = modu.codi)
	LEFT JOIN	adm_tablas_aux	des		ON (p.t02_sect_prod = des.codi)
	LEFT JOIN	adm_ubigeo		u		ON (u.cod_dpto = dis.t03_dpto AND 
											u.cod_prov = "00" AND 
											u.cod_dist = "00")
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND	plan.t02_version = (anio+1)
	GROUP BY plan.t12_modulo, u.nom_ubig)
	
	UNION
	
	(SELECT		"2" AS sort_ord,
				"Asistencia Técnica" AS servicio,
				plan.t12_nro_tema,
				plan.t12_hor_cap,
				SUM(plan.t12_nro_ben) AS benef,
				plan.t12_modulo,
				modu.descrip AS modulo,
				u.nom_ubig AS region,
				des.descrip
	FROM		t12_plan_at		plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	(SELECT t02_cod_proy, t02_version, t03_dpto 
				 FROM t03_dist_proy 
				 GROUP BY t02_cod_proy, t02_version)	dis	ON (dis.t02_cod_proy = p.t02_cod_proy AND 
																dis.t02_version = p.t02_version)
	LEFT JOIN	adm_tablas_aux	modu	ON (plan.t12_modulo = modu.codi)
	LEFT JOIN	adm_tablas_aux	des		ON (p.t02_sect_prod = des.codi)
	LEFT JOIN	adm_ubigeo		u		ON (u.cod_dpto = dis.t03_dpto AND 
											u.cod_prov = "00" AND 
											u.cod_dist = "00")
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND	plan.t02_version = (anio+1)
	GROUP BY plan.t12_modulo, u.nom_ubig)
	
	UNION
	
	(SELECT		"3" AS sort_ord,
				"Créditos" AS servicio,
				NULL AS t12_nro_tema,
				NULL AS t12_hor_cap,
				SUM(plan.t12_nro_ben) AS benef,
				"" t12_modulo,
				"" AS modulo,
				u.nom_ubig AS region,
				des.descrip
	FROM		t12_plan_cred	plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	(SELECT t02_cod_proy, t02_version, t03_dpto 
				 FROM t03_dist_proy 
				 GROUP BY t02_cod_proy, t02_version)	dis	ON (dis.t02_cod_proy = p.t02_cod_proy AND 
																dis.t02_version = p.t02_version)
	LEFT JOIN	adm_tablas_aux	des ON (p.t02_sect_prod = des.codi)
	LEFT JOIN	adm_ubigeo 		u	ON (u.cod_dpto = dis.t03_dpto AND 
										u.cod_prov = "00" AND 
										u.cod_dist = "00")
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND plan.t02_version = (anio+1)
	GROUP BY t12_modulo, u.nom_ubig)
	
	UNION
	
	(SELECT		"4" AS sort_ord,
				"Otros Servicios" AS servicio,
				NULL AS t12_nro_tema,
				NULL AS t12_hor_cap,
				SUM(plan.t12_nro_ben) AS benef,
				plan.t12_tipo,
				modu.descrip AS modulo,
				u.nom_ubig AS region,
				des.descrip
	FROM		t12_plan_otros	plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	(SELECT t02_cod_proy, t02_version, t03_dpto 
				 FROM t03_dist_proy 
				 GROUP BY t02_cod_proy, t02_version)	dis	ON (dis.t02_cod_proy = p.t02_cod_proy AND 
																dis.t02_version = p.t02_version)
	LEFT JOIN	adm_tablas_aux	modu	ON (plan.t12_tipo = modu.codi)
	LEFT JOIN	adm_tablas_aux	des		ON (p.t02_sect_prod = des.codi)
	LEFT JOIN	adm_ubigeo 		u		ON (u.cod_dpto = dis.t03_dpto AND 
											u.cod_prov = "00" AND 
											u.cod_dist = "00")
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND plan.t02_version = (anio+1)
	GROUP BY plan.t12_tipo, u.nom_ubig)
	ORDER BY sort_ord, modulo, -region DESC, region;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tipo_serv_tema_sector` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tipo_serv_tema_sector`(IN _anio INT, IN _concurso VARCHAR(10))
BEGIN
	DECLARE anio INT;
	SELECT MAX(t25_anio) INTO anio FROM t25_inf_trim WHERE t25_periodo LIKE CONCAT("%",_anio,"%");
	
	(SELECT		"1" AS sort_ord,
				"Capacitación" AS servicio, 
				plan.t12_modulo,
				modu.descrip AS modulo,
				p.t02_sect_prod,
				des.descrip AS actividad,
				SUM(plan.t12_nro_ben) AS benef
	FROM		t12_plan_capac	plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	adm_tablas_aux	modu	ON (plan.t12_modulo = modu.codi)
	LEFT JOIN	adm_tablas_aux	des		ON (p.t02_sect_prod = des.codi)
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND	plan.t02_version = (anio+1)
	GROUP BY plan.t12_modulo, p.t02_sect_prod)
	
	UNION
	
	(SELECT		"2" AS sort_ord,
				"Asistencia Técnica" AS servicio,
				plan.t12_modulo,
				modu.descrip AS modulo,
				p.t02_sect_prod,
				des.descrip AS actividad,
				SUM(plan.t12_nro_ben) AS benef
	FROM		t12_plan_at		plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	adm_tablas_aux	modu	ON (plan.t12_modulo = modu.codi)
	LEFT JOIN	adm_tablas_aux	des		ON (p.t02_sect_prod = des.codi)
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND	plan.t02_version = (anio+1)
	GROUP BY plan.t12_modulo, p.t02_sect_prod)
	
	UNION
	
	(SELECT		"3" AS sort_ord,
				"Créditos" AS servicio,
				"" t12_modulo,
				"" AS modulo,
				p.t02_sect_prod,
				des.descrip AS actividad,
				SUM(plan.t12_nro_ben) AS benef
	FROM		t12_plan_cred	plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	adm_tablas_aux	des ON (p.t02_sect_prod = des.codi)
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND plan.t02_version = (anio+1)
	GROUP BY t12_modulo, p.t02_sect_prod)
	
	UNION
	
	(SELECT		"4" AS sort_ord,
				"Otros Servicios" AS servicio,
				plan.t12_tipo,
				modu.descrip AS modulo,
				p.t02_sect_prod,
				des.descrip AS actividad,
				SUM(plan.t12_nro_ben) AS benef
	FROM		t12_plan_otros	plan
	INNER JOIN	t02_dg_proy		p 		ON (p.t02_cod_proy = plan.t02_cod_proy AND 
											p.t02_version = plan.t02_version)
	LEFT JOIN	adm_tablas_aux	modu	ON (plan.t12_tipo = modu.codi)
	LEFT JOIN	adm_tablas_aux	des		ON (p.t02_sect_prod = des.codi)
	WHERE		SUBSTR(p.t02_cod_proy,3,2) = (CASE WHEN _concurso = "*" THEN SUBSTR(p.t02_cod_proy,3,2) ELSE _concurso END)
			AND plan.t02_version = (anio+1)
	GROUP BY plan.t12_tipo, p.t02_sect_prod)
	ORDER BY sort_ord, modulo, -actividad DESC, actividad;
	
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tip_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tip_inst`()
BEGIN
SELECT  DISTINCT
	IFNULL(a.codi,0) AS codi
	, IFNULL(a.abrev,'') AS abrev
	
FROM
    t01_dir_inst AS i
    INNER JOIN t02_dg_proy AS p ON (i.t01_id_inst = p.t01_id_inst)
    LEFT JOIN adm_tablas_aux AS a ON (i.t01_tipo_inst = a.codi )
    LEFT JOIN adm_tablas_aux AS e ON (p.t02_estado = e.codi)
WHERE  p.t02_version=fn_ult_version_proy(p.t02_cod_proy) 
  AND  e.cod_ext IN(1,4,5)
GROUP BY a.descrip
ORDER BY COUNT(p.t02_cod_proy) DESC; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_tip_inst_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_tip_inst_proy`(IN _concurso  VARCHAR(10), IN _estado  VARCHAR(10))
BEGIN
SELECT
      IFNULL(adm_tablas_aux.abrev,'--') AS tipoinst
    , COUNT(t02_dg_proy.t02_cod_proy) AS cantidad,
		SUM(fn_costo_presupuesto_fe(t02_dg_proy.t02_cod_proy, t02_dg_proy.t02_version)) AS FE,
		SUM(fn_costo_presupuesto_otros(t02_dg_proy.t02_cod_proy, t02_dg_proy.t02_version)) AS otros,
		fn_costos_total_proyecto(t02_dg_proy.t02_cod_proy, t02_dg_proy.t02_version) AS total, 
		t01_dir_inst.t01_tipo_inst
FROM
    t01_dir_inst
    INNER JOIN t02_dg_proy ON (t01_dir_inst.t01_id_inst = t02_dg_proy.t01_id_inst)
    LEFT JOIN adm_tablas_aux ON (adm_tablas_aux.codi = t01_dir_inst.t01_tipo_inst)
    LEFT JOIN adm_tablas_aux e ON (t02_dg_proy.t02_estado = e.codi)
WHERE  t02_dg_proy.t02_version = fn_ult_version_proy(t02_dg_proy.t02_cod_proy)	 
  AND 	SUBSTR(t02_cod_proy,3,2) = (CASE WHEN _concurso='*' THEN SUBSTR(t02_cod_proy,3,2) ELSE _concurso END )
  AND 	t02_estado = (CASE WHEN _estado='*' THEN t02_estado ELSE _estado END )    
GROUP BY adm_tablas_aux.descrip
ORDER BY 2 DESC ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_ubigeo_case` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_ubigeo_case`(IN _dpto CHAR(2), IN _prov CHAR(2), IN _dist CHAR(2))
BEGIN
	 
	SELECT 	cod_case AS codigo, 
		nom_case AS descripcion
	FROM adm_caserios 
	WHERE cod_dpto= _dpto
	  AND cod_prov= _prov
	  AND cod_dist= _dist
	ORDER BY cod_dpto ASC,
		 cod_prov ASC,
		 cod_dist ASC,
		 cod_case ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_ubigeo_dist` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_ubigeo_dist`(IN _dpto CHAR(2), IN _prov CHAR(2))
BEGIN
	SELECT 	cod_dist AS codigo, 
		nom_ubig AS descripcion
	FROM adm_ubigeo 
	WHERE cod_dpto= _dpto
	  AND cod_prov= _prov
	  AND cod_dist<>'00'
	ORDER BY cod_dpto ASC,
		 cod_prov ASC,
		 cod_dist ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_ubigeo_dpto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_ubigeo_dpto`()
BEGIN
	SELECT 	cod_dpto AS codigo, 
		nom_ubig AS descripcion
	FROM adm_ubigeo 
	WHERE cod_prov='00'
	  AND cod_dist='00'
	ORDER BY cod_dpto ASC ;
		
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_ubigeo_prov` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_ubigeo_prov`(IN _dpto CHAR(2))
BEGIN
	SELECT 	cod_prov AS codigo, 
		nom_ubig AS descripcion
	FROM adm_ubigeo 
	WHERE cod_dpto= _dpto
	  AND cod_prov<>'00'
	  AND cod_dist='00'
	ORDER BY cod_dpto ASC,
		 cod_prov ASC ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_usuario` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_usuario`(IN _usr varchar(20) )
BEGIN
SELECT  usu.coduser, 
	usu.tipo_user as idperfil, 
	usu.nom_user, 
	usu.mail, 
	usu.estado,
	per.per_des as perfil, 
	IFNULL(usu.t01_id_uni,-1) AS t01_id_uni,
	ifnull(usu.t02_cod_proy,'*') as  t02_cod_proy,
	fn_ult_version_proy(usu.t02_cod_proy) as t02_version
FROM  adm_usuarios usu
left join adm_perfiles per on (usu.tipo_user=per.per_cod)
WHERE usu.coduser=_usr ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_usuarios` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_usuarios`(IN _perfil char(5) )
BEGIN
SELECT  usu.coduser, 
	usu.nom_user, 
	usu.mail, 
	per.per_abrev as perfil, 
	ifnull(usu.t02_cod_proy,'*') as  t02_cod_proy,
	(CASE WHEN usu.estado='1' THEN 'Activo' ELSE 'Inactivo' END) AS estado
FROM  adm_usuarios usu
left join adm_perfiles per on (usu.tipo_user=per.per_cod)
WHERE ifnull(usu.tipo_user,'*')=(case when _perfil='*' then IFNULL(usu.tipo_user,'*') else _perfil end) ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_sel_usuarios_activos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_sel_usuarios_activos`( )
BEGIN
DECLARE _limite_minutos INT DEFAULT 24 ; 
DECLARE _fechalimite DATETIME ; 
DECLARE _fechaahora DATETIME DEFAULT NOW() ; 
DECLARE _existe INT DEFAULT 0 ;
SET _fechalimite = DATE_ADD(_fechaahora, INTERVAL (_limite_minutos * -1) MINUTE ) ;

UPDATE  adm_usuarios_activos
   SET  estado = '0'
WHERE fecha < (_fechalimite) ;
SELECT 	ua.coduser,
	ua.fecha,
	ua.pub_ip,
	ua.id_session,
	u.nom_user,
	u.mail,
	u.t01_id_uni 	AS 'institucion',
	u.t02_cod_proy 	AS 'proyecto',
	u.tipo_user 	AS 'idperfil',
	p.per_des 	AS 'nomperfil'
FROM adm_usuarios_activos ua
INNER JOIN adm_usuarios u ON(ua.coduser = u.coduser)
LEFT  JOIN adm_perfiles p ON (u.tipo_user = p.per_cod)
WHERE ua.estado = '1' ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_solicita_aprobacion_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_solicita_aprobacion_proyecto`(
			IN  _proy VARCHAR(10), 
			IN  _tipo varchar(5) , 
			IN  _usr VARCHAR(20))
trx1:BEGIN
declare _ver  INT default 1 ;
declare _msg  text default '';
declare _cont int default 0;
if UPPER(_tipo) = 'ML' then
  update t02_aprob_proy 
     set t02_aprob_ml = 1
   where t02_cod_proy = _proy ;
   commit ;
   SELECT true AS ret, '' AS msg ;  
end if ;
IF UPPER(_tipo) = 'CRON' THEN
  SET _cont = 1;
  
  CALL sp_validate_cronograma(_proy, _ver);
  
  IF(SELECT COUNT(1) FROM tmp_mensajes) > 0 THEN
     while (SELECT COUNT(1) FROM tmp_mensajes) >= _cont do
     
	select concat(_msg, '\n', 'SubActividad: [', comp, '.', act, '.', sub,'] ', mensaje)
	  into _msg 
	from tmp_mensajes 
	where id = _cont ;
	
	set _cont=_cont +1 ;
	
     end while ;   
     
     drop temporary table tmp_mensajes ;
     ROLLBACK ;
     
     SELECT FALSE AS ret, _msg AS msg ;  
     
     LEAVE trx1 ;
  else
    UPDATE t02_aprob_proy 
       SET t02_aprob_cro = 1
     WHERE t02_cod_proy = _proy ;
   COMMIT ;
   SELECT TRUE AS ret, '' AS msg ;  
  END IF ;
END IF ;
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_strTempTable` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_strTempTable`(IN _nomtable VARCHAR(50), IN _texto VARCHAR(6000), IN _separator CHAR(1))
BEGIN
    DECLARE _txtsql VARCHAR(6000);
    DECLARE _droptable VARCHAR(200);
    DECLARE _createtable VARCHAR(5000);
        
    SELECT CONCAT('DROP TEMPORARY TABLE IF EXISTS`',_nomtable,'` ; \n' ) INTO _droptable;
    SELECT CONCAT('CREATE TEMPORARY TABLE `',_nomtable,'`','(id INT(11) NOT NULL AUTO_INCREMENT, txt VARCHAR(100), PRIMARY KEY  (id)); ') INTO _createtable ;
  
    SELECT  _droptable INTO @txtcreatedrop;
    PREPARE stmt FROM @txtcreatedrop;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt; 
    
    SELECT  _createtable INTO @txtcreatedrop;
    PREPARE stmt FROM @txtcreatedrop;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt; 
   SELECT REPLACE(_texto,_separator, ''' UNION ALL SELECT ''') INTO _txtsql ;
   SELECT CONCAT('SELECT ''', _txtsql, ''' AS texto; ') INTO _txtsql;
   
   
   SELECT CONCAT('INSERT INTO `',_nomtable,'` (txt) \n', _txtsql) INTO @txtsql;
   
   PREPARE stmt FROM @txtsql;
   EXECUTE stmt;
   DEALLOCATE PREPARE stmt; 
   
   
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_ambito_geo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_ambito_geo`(
			IN _proy VARCHAR(10), 
			IN _vs   INT ,
			IN _dpto_old CHAR(2), 
			IN _prov_old CHAR(2), 
			IN _dist_old CHAR(2), 
			IN _dpto CHAR(2), 
			IN _prov CHAR(2), 
			IN _dist CHAR(2), 
			IN _obs  TEXT, 
			IN _usr VARCHAR(20))
BEGIN
DECLARE _existe INT ;
SELECT COUNT(t03_dpto) 
  INTO   _existe
  FROM t03_dist_proy
  WHERE t02_cod_proy  = _proy
    AND t02_version   = _vs
    AND t03_dpto    = _dpto
    AND t03_prov    = _prov
    AND t03_dist    = _dist 
    AND CONCAT(t03_dpto,t03_prov,t03_dist) <> CONCAT(_dpto_old,_prov_old,_dist_old);    
    
IF _existe = 0 THEN 
  UPDATE t03_dist_proy 
     SET t03_dpto = _dpto , 
	 t03_prov = _prov , 
	 t03_dist = _dist ,
	 t03_obs  = _obs , 
	 usr_actu = _usr ,
	 fch_actu = NOW()
   WHERE t02_cod_proy  = _proy
    AND t02_version   = _vs
    AND t03_dpto    = _dpto_old
    AND t03_prov    = _prov_old
    AND t03_dist    = _dist_old ;
  

SELECT ROW_COUNT() AS numrows, _dist AS codigo, '' AS 'error' ;
ELSE
SELECT 0 AS numrows, 0 AS codigo, 'Ya existe el Ambito Geografico que intenta actualizar' AS 'error' ;
END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_aprueba_desemb_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_aprueba_desemb_me`(
			IN _proy VARCHAR(10), 
			IN _vista INT, 
			IN _id INT, 
			IN _aprob  CHAR(1),
			IN _mto_apro DOUBLE, 
			in _obs text ,
			IN _usr VARCHAR(20))
BEGIN
replace INTO t31_plan_me_aprob 
	(t02_cod_proy, 
	t31_id, 
	t31_id_aprob, 
	t31_mto_aprob, 
	t31_fec_aprob, 
	t31_vb, 
	t31_obs_aprob, 
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu, 
	est_audi
	)
	VALUES
	( _proy , 
	  _vista , 
	  _id , 
	  _mto_apro, 
	  now(), 
	  _aprob , 
	  _obs, 
	  _usr, 
	  now(), 
	  null, 
	  null, 
	 '1'
	);
	
SELECT row_count() AS numrows, _id AS codigo ;  
					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_aprueba_desemb_parcial` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_aprueba_desemb_parcial`(
			IN pProy VARCHAR(10),
			IN pAnio INT,
			IN pTrim INT,
			IN pMtoPlan DOUBLE,
			IN pIdAprob BIGINT,
			IN pNroAprob TINYINT,
			IN pMtoParApro DOUBLE,
			IN pAproMT  CHAR(1),
			IN pObsMT TEXT,
			IN pAproMF  CHAR(1),
			IN pObsMF TEXT,
			IN pAproCMT  CHAR(1),
			IN pObsCMT TEXT,
			IN pAproCMF  CHAR(1),
			IN pObsCMF TEXT,
			IN pUser VARCHAR(20))
BEGIN
DECLARE aFchAprob DATETIME DEFAULT NOW();
DECLARE aPerfil INT;
DECLARE aRowCount INT DEFAULT 0;
DECLARE aTotMtoAprob DOUBLE;
SELECT tipo_user INTO aPerfil FROM adm_usuarios WHERE coduser = pUser;
SELECT IFNULL(pIdAprob, 0) INTO pIdAprob;




IF pIdAprob > 0 AND aPerfil = 13 THEN 
	UPDATE	t60_aprob_desemb_parcial
	SET 	t60_apro_mt = pAproMT,	
			t60_obs_mt = pObsMT,
			t60_fch_apro_mt = (CASE WHEN pAproMT = '1' THEN aFchAprob ELSE NULL END),
			t60_fch_apro_mf = (CASE WHEN pAproMT = '1' THEN aFchAprob ELSE NULL END),
			usr_actu = pUser,
			fch_actu = NOW()
	WHERE 	t60_id_aprob = pIdAprob AND t60_nro_aprob = pNroAprob;
	SELECT ROW_COUNT() INTO aRowCount;
END IF;



IF pIdAprob > 0 AND aPerfil = 15 THEN
	UPDATE	t60_aprob_desemb_parcial
	SET 	t60_apro_cmt = pAproCMT,
			t60_obs_cmt = pObsCMT,
			t60_fch_apro_cmt = (CASE WHEN pAproCMT = '1' THEN aFchAprob ELSE NULL END),
			t60_fch_apro_cmf = (CASE WHEN pAproCMT = '1' THEN aFchAprob ELSE NULL END),
			t60_fch_aprob = IF ((t60_apro_cmf = '1' AND pAproCMT = '1'), aFchAprob, t60_fch_aprob),
			usr_actu = pUser,
			fch_actu = NOW()
	WHERE 	t60_id_aprob = pIdAprob AND t60_nro_aprob = pNroAprob;
	SELECT ROW_COUNT() INTO aRowCount;
END IF;



IF (aRowCount = 0) THEN
	IF (pAproCMT != '1') THEN
		SET aFchAprob = NULL;
	END IF;
	
	IF (!EXISTS(SELECT * FROM t60_aprobacion_desemb WHERE t60_id_aprob = pIdAprob)) THEN
		INSERT INTO t60_aprobacion_desemb 
			(t02_cod_proy, 		t60_anio,		t60_trim, 
			t60_mto_plan,		t60_mto_aprob,	t60_apro_mt, 
			t60_obs_mt,			t60_apro_mf,	t60_obs_mf, 
			usr_crea,			fch_crea,		est_audi)
			VALUES
			(pProy,				pAnio,			pTrim, 
			pMtoPlan,			pMtoParApro,	pAproCMT, 
			pObsCMT, 			pAproCMF, 		pObsCMT,
			pUser,				NOW(), 			'1');
		SELECT LAST_INSERT_ID() INTO pIdAprob;
	END IF;
	IF IFNULL(pNroAprob, 0) = 0 THEN 
		SELECT IFNULL(MAX(t60_nro_aprob), 0) + 1 
		INTO pNroAprob 
		FROM t60_aprob_desemb_parcial
		WHERE t60_id_aprob = pIdAprob;
	END IF;
	
	IF (pNroAprob <= 3) THEN
		IF (pNroAprob = 3) THEN
			SELECT	t1.t60_mto_plan - t2.mto_acum AS saldo_aprob
			INTO	pMtoParApro
			FROM	t60_aprobacion_desemb t1 
			JOIN	(SELECT t60_id_aprob, SUM(t60_mto_par_aprob) AS mto_acum
						FROM t60_aprob_desemb_parcial
						GROUP BY t60_id_aprob) t2 
					ON (t1.t60_id_aprob = t2.t60_id_aprob)
			WHERE t1.t60_id_aprob = pIdAprob;		
		END IF;
		
		INSERT INTO t60_aprob_desemb_parcial (
			t60_id_aprob,	t60_nro_aprob,	t60_mto_par_aprob,
			t60_apro_mt,	t60_obs_mt,		t60_fch_apro_mt,
			t60_apro_mf,	t60_obs_mf,		t60_fch_apro_mf,
			t60_apro_cmt,	t60_obs_cmt,	t60_fch_apro_cmt,
			t60_apro_cmf,	t60_obs_cmf,	t60_fch_apro_cmf,
			usr_crea,		fch_crea,		est_audi)
			VALUES (
			pIdAprob,		pNroAprob,		pMtoParApro,
			pAproMT,		pObsMT,			(CASE WHEN pAproMT = '1' THEN CURDATE() ELSE NULL END),
			pAproMF,		pObsMF,			(CASE WHEN pAproMF = '1' THEN CURDATE() ELSE NULL END),
			pAproCMT,		pObsCMT,		(CASE WHEN pAproCMT = '1' THEN CURDATE() ELSE NULL END),
			pAproCMF,		pObsCMF,		(CASE WHEN pAproCMF = '1' THEN CURDATE() ELSE NULL END),
			pUser, 			NOW(),			'1');
		SELECT ROW_COUNT() INTO aRowCount ;
	ELSE
		SELECT "Numero maximo de Aprobaciones de Desembolsos alcanzado (3)." AS errorMsg;
	END IF;
ELSE



	SELECT t60_apro_cmt, t60_obs_cmt, t60_apro_cmf, t60_obs_cmf
	INTO pAproCMT, pObsCMT, pAproCMF, pObsCMF
	FROM t60_aprob_desemb_parcial
	WHERE t60_id_aprob = pIdAprob AND t60_nro_aprob = pNroAprob;
	
	IF (pAproCMT = '1') THEN
					
		SELECT SUM(t60_mto_par_aprob) INTO aTotMtoAprob
		FROM t60_aprob_desemb_parcial
		WHERE t60_id_aprob = pIdAprob;
		
		UPDATE	t60_aprobacion_desemb
		SET		t60_mto_aprob	= aTotMtoAprob,
				t60_fch_aprob	= CURDATE(),
				t60_is_desemb	= '0',
				t60_apro_mt		= '1',
				t60_obs_mt		= pObsCMT,
				t60_apro_mf		= '1',
				t60_obs_mf		= pObsCMF,
				usr_actu		= pUser,
				fch_actu		= NOW()
		WHERE	t60_id_aprob = pIdAprob;
		
	END IF;
END IF ;
SELECT aRowCount AS numRows, pIdAprob AS codAprob,  pNroAprob AS nroAprob;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_aprueba_primer_desemb` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_aprueba_primer_desemb`(
			IN _proy VARCHAR(10), 
			IN _mto_apro DOUBLE, 
			in _apro_cta  char(1),
			IN _apro_cf  CHAR(1),
			IN _apro_cvf  CHAR(1),
			IN _apro_od  CHAR(1),
			IN _obs_mf TEXT ,
			IN _usr VARCHAR(20))
BEGIN
declare _fch_aprob DATETIME default now();
declare _anio INT default 1 ; 
declare _trim INT default 1 ; 
declare _apro_mf  CHAR(1);
declare _rowcount int default 0 ; 
declare _id_aprob bigint ;
select t59_id_aprob
into _id_aprob
from t59_aprob_primer_desemb
where t02_cod_proy = _proy ;
if EXISTS(select t59_id_aprob from t59_aprob_primer_desemb where  t02_cod_proy=_proy) then
	UPDATE t59_aprob_primer_desemb 
	   SET 	t02_cod_proy = _proy , 
	        t59_car_fianza    = _apro_cf,
	        t59_cons_aper_cta = _apro_cta,
	        t59_conv_firma    = _apro_cvf,
	        t59_otros_docum   = _apro_od,
	        t59_aprueba_mf    = (case when (_apro_cf + _apro_cta + _apro_cvf + _apro_od)=4 then '1' else '0' end ),
	        t59_obs_aprob     = _obs_mf,
	        t59_mto_aprob     = _mto_apro,		
		usr_actu = _usr , 
		fch_actu = NOW()
	 WHERE 	t59_id_aprob = IFNULL(_id_aprob,0) ;
	
	select ROW_COUNT() into _rowcount ;
else
 SELECT IFNULL(MAX(t59_id_aprob),0)+1 
     INTO _id_aprob 
     FROM t59_aprob_primer_desemb ;
     
    INSERT INTO t59_aprob_primer_desemb 
	(t59_id_aprob, 
	t02_cod_proy, 
	t59_car_fianza, 
	t59_cons_aper_cta, 
	t59_conv_firma, 
	t59_otros_docum, 
	t59_aprueba_mf, 
	t59_obs_aprob, 
	t59_mto_aprob, 
	t59_fch_aprob, 
	t59_is_desemb, 
	t60_mto_desemb, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
	VALUES
	( _id_aprob, 
	  _proy, 
	  _apro_cf,
	  _apro_cta, 
	  _apro_cvf, 
	  _apro_od, 
	  (CASE WHEN (_apro_cf + _apro_cta + _apro_cvf + _apro_od)=4 THEN '1' ELSE '0' END ), 
	  _obs_mf, 
	  _mto_apro, 
	  now(), 
	  '0', 
	  0, 
	  _usr, 
	  now(), 
	  '1'
	);
	
	SELECT ROW_COUNT() INTO _rowcount ;
end if ;
	
SELECT _rowcount AS numrows, _id_aprob AS codigo ;  
					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_banco` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_banco`(IN _id int, IN _nom VARCHAR(50), IN _abre VARCHAR(15), IN _usr VARCHAR(20))
BEGIN
    UPDATE t00_bancos 
    SET t00_nom_lar=_nom,
        t00_nom_abre=_abre,
        usr_actu  = _usr, 
        fch_actu  = NOW()
    WHERE t00_cod_bco = _id;
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_cambio_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_cambio_personal`(IN _t02_cod_proy 	VARCHAR(10),
					 IN _t04_num_soli  	INT, 
					 IN _t04_dni_equi  	VARCHAR(20),
					 IN _t04_ape_pat  	VARCHAR(50),
					 IN _t04_ape_mat  	VARCHAR(50),
					 IN _t04_nom_equi	VARCHAR(50), 
					 IN _t04_sexo_equi  	INT,
					 IN _t04_edad_equi  	INT,
					 IN _t04_cali_equi  	INT,
					 IN _t04_telf_equi  	VARCHAR(50),
					 IN _t04_cel_equi  	VARCHAR(20),
					 IN _t04_mail_equi  	VARCHAR(20),
					 IN _t04_exp_lab  	TEXT,
					 IN _t04_func_equi  	TEXT,
					 IN _t04_especialidad  	INT,
					 IN _t04_adj_cv 	VARCHAR(250),
					 IN _t04_adj_sol 	VARCHAR(250),
					 IN _t04_id_equi_cambio INT,
					 IN _t04_saldo_part     DOUBLE,
					 IN _t04_obs_ejec	TEXT,		
					 IN _t04_aprob_mt INT,
					 IN _t04_aprob_mf INT,
					 IN _t04_aprob_cmt INT,
					 IN _t04_aprob_cmf INT,
					 IN _t04_resp_ejec INT,
					 IN _t04_resp_ejec_obs TEXT,		
					 IN _UserID  		CHAR(20), IN _t04_fec_ter date)
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _numrows      INT ;
  DECLARE _idSol	INT; 
  DECLARE _t04_carg_equi INT ;
  
IF EXISTS(SELECT t04_dni_equi FROM t04_equi_proy WHERE t02_cod_proy=_t02_cod_proy AND t04_dni_equi=_t04_dni_equi) THEN 
	SELECT CONCAT('El personal  \"',_t04_ape_pat,' ',_t04_ape_mat, ', ', _t04_nom_equi ,'\" ya esta registrado en el Equipo Ejecutor del Proyecto')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;      
END IF ;
IF EXISTS(SELECT t04_dni_equi FROM t04_sol_cambio_per WHERE t02_cod_proy=_t02_cod_proy AND t04_dni_equi=_t04_dni_equi AND t04_num_soli <> _t04_num_soli) THEN 
	SELECT CONCAT('El personal  \"',_t04_ape_pat,' ',_t04_ape_mat, ', ', _t04_nom_equi ,'\" ya fue registrado en otra Solicitud de Cambio de Personal')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;      
END IF ;
  
SELECT t04_carg_equi 
  INTO _t04_carg_equi
  FROM t04_equi_proy
 WHERE t02_cod_proy = _t02_cod_proy
   AND t04_id_equi  = _t04_id_equi_cambio ;
 
UPDATE t04_sol_cambio_per 
	SET
	t04_dni_equi = _t04_dni_equi , 
	t04_ape_pat = _t04_ape_pat , 
	t04_ape_mat = _t04_ape_mat , 
	t04_nom_equi = _t04_nom_equi , 
	t04_sexo_equi = _t04_sexo_equi , 
	t04_edad_equi = _t04_edad_equi , 
	t04_cali_equi = _t04_cali_equi , 
	t04_mail_equi = _t04_mail_equi , 
	t04_telf_equi = _t04_telf_equi , 
	t04_cel_equi = _t04_cel_equi , 
	t04_carg_equi = _t04_carg_equi , 
	t04_esp_equi = _t04_especialidad , 
	t04_fec_ter = (CASE WHEN _t04_fec_ter='' THEN t04_fec_ter ELSE _t04_fec_ter END ),  
	t04_func_equi = _t04_func_equi , 
	t04_exp_lab = _t04_exp_lab , 
	t04_adj_cv = (CASE WHEN _t04_adj_cv='' THEN t04_adj_cv ELSE _t04_adj_cv END ), 
	t04_adj_sol = (CASE WHEN _t04_adj_sol='' THEN t04_adj_sol ELSE _t04_adj_sol END ),  
	t04_id_equi_cambio = _t04_id_equi_cambio , 
	t04_saldo_part = _t04_saldo_part , 
	t04_obs_ejec = _t04_obs_ejec , 	
	t04_aprob_mt = (CASE WHEN _t04_aprob_mt='' THEN t04_aprob_mt ELSE _t04_aprob_mt END ),   
	t04_aprob_mf = (CASE WHEN _t04_aprob_mf='' THEN t04_aprob_mf ELSE _t04_aprob_mf END ),   
	t04_aprob_cmt = (CASE WHEN _t04_aprob_cmt='' THEN t04_aprob_cmt ELSE _t04_aprob_cmt END ), 
	t04_aprob_cmf = (CASE WHEN _t04_aprob_cmf='' THEN t04_aprob_cmf ELSE _t04_aprob_cmf END ), 
	t04_resp_ejec = (CASE WHEN _t04_resp_ejec='' THEN t04_resp_ejec ELSE _t04_resp_ejec END ), 
	t04_resp_ejec_obs = (CASE WHEN _t04_resp_ejec_obs='' THEN t04_resp_ejec_obs ELSE _t04_resp_ejec_obs END ),   	
	usr_actu = _UserID , 
	fch_actu = NOW() 
	
	WHERE
	t04_num_soli = _t04_num_soli AND t02_cod_proy = _t02_cod_proy ;
SELECT ROW_COUNT() INTO _numrows;
COMMIT;
SELECT _numrows AS numrows, _idSol AS codigo, '' AS msg ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_cartafianza` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_cartafianza`(
			IN _idcf INT,
			IN _proy  varchar(10),
			IN _bco   int ,
			IN _desc  text, 
			in _monto double,
			IN _num   varchar(20),
			in _serie varchar(20),
			in _fec_rec datetime,
			in _fec_gir datetime,
			in _fec_venc datetime,
			in _vb_adm  char(1),
			in _obs_adm text,
			in _fname varchar(150),
			IN _usr varchar(20)
			)
transX : BEGIN
  DECLARE _msg  varchar(100);
  DECLARE _id   int ;
  declare _estado INT;
  IF exists(select _num from t02_carta_fianza where  t02_cod_proy = _proy and t02_num_cf=_num and t02_id_cf<>_idcf)  THEN
    SELECT CONCAT('El Numero de Carta Fianza:', _num, ' ya fue registrado en otro proyecto  ','\"',_proy,'\"')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    LEAVE transX ;  
  end if ;
  
  
  select (case when _fec_venc > now() then 1 ELSE 0 END ) into _estado;
  
  
	update 	t02_carta_fianza 
	   set 	t02_id_bco = _bco, 
		t02_des_cf = _desc, 
		t02_mto_cf = _monto, 
		t02_num_cf = _num, 
		t02_ser_cf = _serie, 
		t02_frec_cf = _fec_rec, 
		t02_fgir_cf = _fec_gir, 
		t02_fven_cf = _fec_venc, 
		t02_est_cf = _estado, 
		t02_file_cf = (case when trim(_fname)='' then t02_file_cf else _fname end), 
		t02_vb_adm  = (CASE WHEN _vb_adm='' THEN t02_vb_adm ELSE _vb_adm END),
		t02_obs_adm = _obs_adm,
		usu_actu    = _usr, 
		fch_actu    = now()
	 where t02_cod_proy = _proy 
	   and t02_id_cf = _idcf ;
  
    SELECT ROW_COUNT() AS numrows, _idcf AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_concepto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_concepto`(IN in_concepto VARCHAR(30), IN in_id int, IN in_nom VARCHAR(50), IN in_abre VARCHAR(15), IN in_usr VARCHAR(20))
BEGIN
    CASE in_concepto
        WHEN 'linea' THEN 
            UPDATE t00_linea   
            SET t00_nom_lar = in_nom,
                t00_nom_abre = in_abre,
                usr_actu = in_usr, 
                fch_actu = NOW()
            WHERE t00_cod_linea = in_id;
        WHEN 'tasa' THEN 
            UPDATE t00_tasa
            SET t00_nom_lar = in_nom,
                t00_nom_abre = in_abre,
                usr_actu = in_usr, 
                fch_actu = NOW()
            WHERE t00_cod_tasa = in_id;
        WHEN 'parametro' THEN 
            UPDATE t00_parametro
            SET t00_nom_lar = in_nom,
                t00_nom_abre = in_abre,
                usr_actu = in_usr, 
                fch_actu = NOW()
            WHERE t00_cod_param = in_id;
        WHEN 'banco' THEN 
            UPDATE t00_bancos 
            SET t00_nom_lar = in_nom,
                t00_nom_abre = in_abre,
                usr_actu = in_usr, 
                fch_actu = NOW()
            WHERE t00_cod_bco = in_id;
        WHEN 'moneda' THEN 
            UPDATE t00_tipo_moneda 
            SET t00_nom_lar = in_nom,
                t00_nom_abre = in_abre,
                usr_actu = in_usr, 
                fch_actu = NOW()
            WHERE t00_cod_mon = in_id;
        WHEN 'tipo_anexo' THEN 
            UPDATE t02_proy_anx_tip 
            SET t02_anx_tip_desc = in_nom,
                t02_anx_tip_abrev = in_abre,
                usr_actu = in_usr, 
                fch_actu = NOW()
            WHERE t02_anx_tip_cod = in_id;
        WHEN 'tipo_cuenta' THEN 
            UPDATE t00_tipo_cuenta 
            SET t00_nom_lar = in_nom,
                t00_nom_abre = in_abre,
                usr_actu = in_usr, 
                fch_actu = NOW()
            WHERE t00_cod_cta = in_id;
    END CASE;
    
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_concurso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_concurso`(IN _id    int , 
IN _anio int, IN _nom   VARCHAR(50), 
			IN _abre  VARCHAR(15),
	IN _coment VARCHAR(200),		IN _usr   VARCHAR(20))
BEGIN
	UPDATE adm_concursos 
	SET anio_conc   = _anio ,
			nom_conc=_nom,
			abr_conc=_abre,
			coment_conc=_coment,
	    usr_actu  = _usr , 
	    fec_actu  = NOW()
	WHERE num_conc = _id ;
     
  SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_costeo`(IN _proy VARCHAR(10), 
				 IN _ver INT, 
				 IN _comp INT, IN _activ INT, 
				 IN _subact INT 		, 
				 IN _cod_cost INT, 
				 IN _descrip VARCHAR(200) , 
				 IN _categ INT,
				 IN _um 	VARCHAR(50) , 
				 IN _cant	DOUBLE		   , 
				 IN _cu	DOUBLE,
				 in _obs_mf text,
				 IN _usr VARCHAR(20))
BEGIN
  DECLARE _meta_sub DOUBLE;
 SELECT IFNULL(t09_mta,0) INTO _meta_sub
  FROM 	 t09_subact 
  WHERE  t02_cod_proy	= _proy AND t02_version	= _ver		AND
		 t08_cod_comp	= _comp AND t09_cod_act	= _activ	AND
		 t09_cod_sub	= _subact ;
		 
 UPDATE t10_cost_sub 
	SET
		t10_cost = _descrip, 
		t10_cate_cost = _categ, 
		t10_um	 = _um  , 
		t10_cant = _cant, 
		t10_cu	 = _cu,
		t10_cost_parc=(_cant * _cu), 
		t10_cost_tot = (_meta_sub * (_cant * _cu)), 
		t10_obs_mf   = _obs_mf,
		usr_actu	 = _usr,
		fch_actu   	 = NOW()
 WHERE  t02_cod_proy	= _proy AND t02_version	= _ver		AND
		 t08_cod_comp	= _comp AND t09_cod_act	= _activ	AND
		 t09_cod_sub	= _subact AND t10_cod_cost=_cod_cost;	  
		  						
SELECT ROW_COUNT() AS numrows, _cod_cost AS codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_cost_fte_finan` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_cost_fte_finan`(IN _proy VARCHAR(10), IN _ver INT    ,  IN _comp INT, 
								  IN _activ INT       , IN _subact INT ,  IN _cod_cost INT, 
								  IN _cod_inst INT    , IN _monto DOUBLE, IN _usr VARCHAR(20))
BEGIN
 DECLARE _cod_fte  INt ;
 declare _rowcount int ; 
 
 SELECT  t10_cod_fte
   INTO  _cod_fte
   from  t10_cost_fte
  WHERE  t02_cod_proy	= _proy 
    AND  t02_version	= _ver		
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND	 t09_cod_sub	= _subact 
    AND  t10_cod_cost   = _cod_cost
    AND  t01_id_inst    = _cod_inst ;
  
  if _cod_fte is null then 
	BEGIN
		 SELECT  IFNULL(MAX(t10_cod_fte),0)+1 
		   INTO  _cod_fte 
		   FROM  t10_cost_fte
		  WHERE  t02_cod_proy	= _proy 
			AND  t02_version	= _ver		
			AND  t08_cod_comp	= _comp 
			AND  t09_cod_act	= _activ	
			AND	 t09_cod_sub	= _subact 
			AND  t10_cod_cost   = _cod_cost;
			
		insert into t10_cost_fte 
					(	
					t02_cod_proy, 		t02_version, 
					t08_cod_comp, 		t09_cod_act, 
					t09_cod_sub, 		t10_cod_cost, 
					t10_cod_fte, 		t01_id_inst, 
					t10_mont, 			usr_crea, 
					fch_crea, 			est_audi  
					)
			values
					(
					_proy   ,   _ver ,
					_comp   ,   _activ,
					_subact ,   _cod_cost, 
					_cod_fte,   _cod_inst,
					_monto  ,   _usr,
					NOW()   ,   '1'
					);
		select ROW_COUNT() into _rowcount ;
	END;
  else
	BEGIN
		UPDATE t10_cost_fte 
		SET t10_mont = _monto, 
			usr_actu = _usr,
			fch_actu = NOW()
		WHERE  	t02_cod_proy= _proy 
		  AND  	t02_version	= _ver		
		  AND	t08_cod_comp= _comp 
		  AND  	t09_cod_act	= _activ	
		  AND	t09_cod_sub	= _subact 
		  AND  	t10_cod_cost= _cod_cost
		  AND  	t10_cod_fte = _cod_fte ;
		
		SELECT ROW_COUNT() INTO _rowcount ;
      END;
  end if; 
 
if _rowcount > 0 then
	UPDATE t10_cost_fte
	   SET t10_porc = fn_porc_aporte_fte_costos_operativos( t02_cod_proy, t02_version, t08_cod_comp, t09_cod_act, t09_cod_sub, t10_cod_cost, t10_cod_fte)
	WHERE  t02_cod_proy = _proy 
	  AND  t02_version  = _ver		
	  AND  t08_cod_comp = _comp 
	  AND  t09_cod_act  = _activ	
	  AND  t09_cod_sub  = _subact 
	  AND  t10_cod_cost = _cod_cost;
end if;
 
					
SELECT _rowcount AS numrows, _cod_fte AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_cost_total_fte_finan` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_cost_total_fte_finan`(IN _proy VARCHAR(10), 
					       IN _ver INT    ,  
					       IN _comp INT, 								  
					       IN _activ INT       , 
					       IN _subact INT ,  
					       IN _cod_cost INT)
BEGIN
 
DELETE FROM t10_cost_fte 
WHERE  	t02_cod_proy    = _proy 
  AND  	t02_version	= _ver		
  AND	t08_cod_comp 	= _comp 
  AND  	t09_cod_act	= _activ	
  AND	t09_cod_sub	= _subact 
  AND  	t10_cod_cost 	= _cod_cost
  AND   t10_mont =0 ;
  
update t02_fuente_finan
   set t02_mto_financ = fn_total_aporte_fuentes_financ(t02_cod_proy, 1 , t01_id_inst)
 where t02_cod_proy=_proy ;
 
UPDATE t10_cost_fte f
SET f.t10_porc = (SELECT ((f.t10_mont / c.t10_cost_tot)*100)
		    FROM       t10_cost_sub c 
		   INNER JOIN t09_subact   p ON (c.t02_cod_proy = p.t02_cod_proy AND c.t02_version  = p.t02_version AND c.t08_cod_comp  = p.t08_cod_comp AND c.t09_cod_act=p.t09_cod_act AND c.t09_cod_sub=p.t09_cod_sub)
		 WHERE f.t02_cod_proy = c.t02_cod_proy 
		   AND f.t02_version  = c.t02_version 
		   AND f.t08_cod_comp  = c.t08_cod_comp 
		   AND f.t09_cod_act=c.t09_cod_act 
		   AND f.t09_cod_sub=c.t09_cod_sub 
		   AND f.t10_cod_cost=c.t10_cod_cost)  
WHERE f.t02_cod_proy = _proy
  AND f.t02_version  = _ver  
  AND f.t08_cod_comp = _comp 
  AND f.t09_cod_act  = _activ	
  AND f.t09_cod_sub  = _subact 
  AND f.t10_cod_cost = _cod_cost ;
 
 
 
					
SELECT ROW_COUNT() AS numrows;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_cron_visita_mi` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_cron_visita_mi`(
			IN _proy VARCHAR(10), 
			IN _id INT,
			IN _anio INT, 
			IN _mes INT, 
			IN _obs TEXT, 
			IN _usr VARCHAR(20))
BEGIN
 
  UPDATE t46_cron_visita_mi 
     SET t46_anio = _anio , 
	t46_mes  = _mes , 
	t46_obs  = _obs , 
	usr_actu = _usr ,
	fch_actu = NOW()
  WHERE
	t02_cod_proy = _proy AND t46_id = _id ;
  

SELECT ROW_COUNT() AS numrows, _id AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_ctas_inst` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_ctas_inst`(
			IN _id_inst INT,
			IN _id_cta INT, 
			IN _bco	INT,
			IN _codcta INT,
			IN _nrocta VARCHAR(20), 
			IN _mon INT,
			IN _usr VARCHAR(20))
BEGIN
    UPDATE t01_inst_ctas 
	SET t00_cod_bco = _bco, 
	t00_cod_cta = _codcta, 
	t01_nro_cta = _nrocta, 
	t00_cod_mon = _mon, 
	usr_actu = _usr, 
	fch_actu = NOW()
	WHERE t01_id_inst = _id_inst
	AND t01_id_cta = _id_cta;
    
    SELECT ROW_COUNT() AS numrows, _id_cta AS codigo, '' AS msg ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_cta_inst_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_cta_inst_proy`(
            IN _proy VARCHAR(10), 
            IN _t01_bco     INT ,
            IN _codcta      INT ,
            IN _nrocta  VARCHAR(25), 
            IN _mon         INT ,
            IN _benef       VARCHAR(100),
            IN _usr_crea    VARCHAR(20))
TRX1:BEGIN
    DECLARE _id INT ;
    DECLARE _t01_id_inst INT ;
    DECLARE _rowcount INT;
    DECLARE _existe BOOLEAN ;
    
        
    IF NOT EXISTS(SELECT pcta.t01_id_cta   FROM  t02_proy_ctas pcta  INNER JOIN t01_inst_ctas cta ON(pcta.t01_id_inst=cta.t01_id_inst AND pcta.t01_id_cta=cta.t01_id_cta)   WHERE pcta.t02_cod_proy = _proy AND cta.t01_nro_cta=_nrocta    and pcta.est_audi='1' ) THEN
       
    IF EXISTS(SELECT pcta.t01_id_cta   FROM  t02_proy_ctas pcta  INNER JOIN t01_inst_ctas cta ON(pcta.t01_id_inst=cta.t01_id_inst AND pcta.t01_id_cta=cta.t01_id_cta)   WHERE cta.t01_nro_cta=_nrocta   and pcta.est_audi='1') THEN
        SELECT -1 AS numrows, 0 AS codigo, 'La Cuenta Bancaria ya fue registrada' AS msg ;
        LEAVE TRX1;
    END IF ;
    END IF;
    
    
    SELECT t01_id_inst 
      INTO _t01_id_inst
      FROM t02_dg_proy 
     WHERE t02_cod_proy=_proy 
       AND t02_version=fn_ult_version_proy(_proy);
    
    IF NOT EXISTS(SELECT t01_id_cta FROM t01_inst_ctas WHERE t01_id_inst = _t01_id_inst AND t00_cod_bco = _t01_bco AND t01_nro_cta=_nrocta ) THEN
    SELECT IFNULL( MAX(t01_id_cta),0)+1 INTO _id  FROM t01_inst_ctas WHERE t01_id_inst = _t01_id_inst ; 
    
     UPDATE t02_proy_ctas SET est_audi = '0' WHERE t02_cod_proy = _proy ;
     
     INSERT INTO t01_inst_ctas 
    (t01_id_inst, 
    t01_id_cta, 
    t00_cod_bco, 
    t00_cod_cta, 
    t01_nro_cta, 
    t00_cod_mon, 
    t01_txt_ref, 
    t01_cta_def, 
    usr_crea, 
    fch_crea, 
    est_audi
    )
    VALUES
    ( _t01_id_inst,
    _id,
    _t01_bco,
    _codcta,
    _nrocta,
    _mon,
    '',
    '1',
    _usr_crea,
    NOW(),
    '1'
    );
    
    SELECT ROW_COUNT() INTO _rowcount ;
    
    ELSE 
    SELECT t01_id_cta 
      INTO _id
    FROM t01_inst_ctas 
    WHERE t01_id_inst = _t01_id_inst 
      AND t00_cod_bco = _t01_bco 
      AND t01_nro_cta = _nrocta ;
      
    SELECT 1 INTO _rowcount ;
    END IF ;
    
    
    
    
    
    UPDATE t02_proy_ctas SET est_audi = '0' WHERE t02_cod_proy = _proy ;
    
    

    CALL sp_upd_cta_proy(_proy, _t01_id_inst , _id, _benef, _usr_crea) ;
    
    SELECT _rowcount AS numrows, _id AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_cta_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_cta_proy`(
			in _proy    varchar(10),
			IN _idinst  int ,
			IN _idcta   int , 
			IN _benef   VARCHAR(50),
			IN _usu     VARCHAR(20)
			)
BEGIN
   
replace INTO t02_proy_ctas 
	(
	t02_cod_proy, 
	t01_id_inst, 
	t01_id_cta, 
	t02_nom_benef, 
	usr_crea, 
	fch_crea, 
	usr_actu, 
	fch_actu, 
	est_audi
	)
	VALUES
	( _proy, 
	 _idinst,
	_idcta,
	_benef ,
	_usu,
	now(),
	_usu ,
	now(),
	'1'
	);  
  
  
    SELECT ROW_COUNT()  AS numrows, _idcta AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_desembolso` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_desembolso`(
			IN  _proy VARCHAR(10), 
			IN  _trim INT,
			IN  _iddesemb INT,
			IN  _tpaog INT,
			IN  _inst_ori INT,
			IN  _cta_ori  INT,
			IN  _inst_dest INT,
			IN  _cta_dest  INT,
			IN  _nom_benef VARCHAR(150),
			IN  _fec_giro DATETIME,
			IN  _fec_depo DATETIME,
			IN  _mto_desm  DOUBLE,
			IN  _nro_cheq  VARCHAR(100),
			IN  _obs       TEXT,
			IN  _usr VARCHAR(20))
trx1:BEGIN
DECLARE _msg   TEXT;
    
UPDATE t60_ejecucion_desemb 
   SET 	t60_tip_pago = _tpaog, 
	t60_inst_ori = _inst_ori, 
	t60_cta_ori  = _cta_ori, 
	t01_id_inst  = _inst_dest, 
	t01_id_cta   = _cta_dest, 
	t60_nom_benef= _nom_benef , 
	t60_fch_giro = _fec_giro, 
	t60_fch_depo = _fec_depo, 
	t60_mto_des  = _mto_desm, 
	t60_nro_cheque  = _nro_cheq, 
	t60_obs_tippago = _obs, 
	usr_actu = _usr, 
	fch_actu = NOW()
    WHERE t02_cod_proy = _proy 
      AND t60_id_trim = _trim
      AND t60_id_desemb = _iddesemb ;
  
    
  SELECT ROW_COUNT() AS numrows, _iddesemb AS codigo, '' AS msg ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_desembolso_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_desembolso_me`(
			IN  _proy VARCHAR(10), 
			IN  _visita INT,
			in  _aprob int,
			in  _iddesemb int,
			IN  _tpaog INT,
			IN  _inst_ori INT,
			IN  _cta_ori  INT,
			IN  _inst_dest INT,
			IN  _cta_dest  INT,
			IN  _nom_benef VARCHAR(150),
			IN  _fec_giro DATETIME,
			IN  _fec_depo DATETIME,
			IN  _mto_desm  DOUBLE,
			IN  _nro_cheq  VARCHAR(100),
			IN  _obs       TEXT,
			IN  _usr VARCHAR(20))
trx1:BEGIN
DECLARE _msg   TEXT;
    
update t60_ejecucion_desemb_me 
   set 	t60_tip_pago = _tpaog, 
	t60_inst_ori = _inst_ori, 
	t60_cta_ori  = _cta_ori, 
	t01_id_inst  = _inst_dest, 
	t01_id_cta   = _cta_dest, 
	t60_nom_benef= _nom_benef , 
	t60_fch_giro = _fec_giro, 
	t60_fch_depo = _fec_depo, 
	t60_mto_des  = _mto_desm, 
	t60_nro_cheque  = _nro_cheq, 
	t60_obs_tippago = _obs, 
	usr_actu = _usr, 
	fch_actu = now()
    where t02_cod_proy = _proy 
      and t60_id_visita = _visita
      and t60_id_nropago = _aprob
      and t60_id_desemb = _iddesemb ;
  
    
  SELECT ROW_COUNT() AS numrows, _iddesemb AS codigo, '' AS msg ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_dg` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_dg`(IN _proy VARCHAR(10), 
    IN _tip CHAR(4), 
    IN _est INT  ,  
  IN _msg TEXT ,
 IN _usr VARCHAR(20))
BEGIN
DECLARE _rowcount INT DEFAULT 0 ; 
DECLARE _nomejec VARCHAR(30) ;
SELECT t01_sig_inst 
  INTO _nomejec 
  FROM t01_dir_inst 
 WHERE t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_proy AND p.t02_version=1);
IF _tip = 'ieva' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_dg_proy
		   SET 	fch_actu   = NOW()		
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_admin(	_proy, 
						'Informe de estado del proyecto',
						CONCAT('El proyecto ', _proy, ', se encuentra habilitado para el ingreso de los documentos correspondientes. \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF ;
IF _tip = 'pre' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_aprob_pre = _est ,
			t02_fch_pre   = NOW(),
			t02_aprob_pre_mon = NULL,
			t02_obs_pre	= ''
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_aprob_pre, t02_fch_pre, usu_crea, fch_crea)
		        VALUES(_proy, _est, NOW(), _usr, NOW() );
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud Aprobación del Presupuesto',
						CONCAT('El proyecto ', _proy, ', ha solicitado la Aprobación del Presupuesto \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF ;
IF _tip = 'proy' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_aprob_proy = _est ,
			t02_fch_aprob_proy  = NOW(),
			t02_obs_aprob_proy	= ''
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_aprob_proy, t02_fch_aprob_proy, usu_crea, fch_crea)
		        VALUES(_proy, _est, NOW(), _usr, NOW() );
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud Aprobación del Proyecto',
						CONCAT('El proyecto ', _proy, ', ha solicitado su Aprobación para el continuar con el ingreso del Marco Lógico \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF ;
IF _tip = 'vbpy' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_vb_proy = _est ,
			t02_fch_vb_proy  = NOW(),
			t02_obs_vb_proy	= ''
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_vb_proy, t02_fch_vb_proy, usu_crea, fch_crea)
		        VALUES(_proy, _est, NOW(), _usr, NOW() );
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud Aprobación del Proyecto',
						CONCAT('El proyecto ', _proy, ', ha solicitado su Aprobación para continuar con el ingreso del Marco Lógico \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF;
IF _tip = 'evml' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_ml = _est ,
			t02_fch_env_ml = NOW()
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_ml, t02_fch_env_ml, usu_crea, fch_crea)
		        VALUES(_proy, _est, NOW(), _usr, NOW() );
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud Revisión Marco Lógico',
						CONCAT('El proyecto ', _proy, ', ha solicitado su Revisión del Marco Lógico \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF;
IF _tip = 'evpr' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_pre = _est ,
			t02_fch_env_pre = NOW()
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_pre, t02_fch_env_pre, usu_crea, fch_crea)
		        VALUES(_proy, _est, NOW(), _usr, NOW() );
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud Revisión del Presupuesto',
						CONCAT('El proyecto ', _proy, ', ha solicitado su Revisión del Presupuesto \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF;
IF _tip = 'evel' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_el = _est ,
			t02_fch_env_el = NOW()
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_el, t02_fch_env_el, usu_crea, fch_crea)
		        VALUES(_proy, _est, NOW(), _usr, NOW() );
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud Revisión del Equipo Lider',
						CONCAT('El proyecto ', _proy, ', ha solicitado su Revisión del Equipo Lider \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF;
IF _tip = 'evcr' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_cro = _est ,
			t02_fch_env_cro = NOW()
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_cro, t02_fch_env_cro, usu_crea, fch_crea)
		        VALUES(_proy, _est, NOW(), _usr, NOW() );
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud Revisión del Cronograma de Actividades',
						CONCAT('El proyecto ', _proy, ', ha solicitado su Revisión del Cronograma de Actividades \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF;
IF _tip = 'scp' THEN
SET _rowcount =1;
	UPDATE t04_sol_cambio_per 
		   SET 	t04_aprob_cmf = 1, 
		    	t04_aprob_cmt = 1 
		 WHERE t02_cod_proy = _proy ;
	SET _rowcount = ROW_COUNT() ;
	IF _rowcount >0 THEN
		CALL sp_ins_mensaje_proy_a_ejecutor(	_proy, 
						'Solicitud de Cambio de Personal',
						CONCAT('La solicitud de cambio del personal del proyecto ', _proy, ', ha sido aprobada \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
		END IF;	
END IF;
IF _tip = 'srdg' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_dg_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_dg_proy 
		   SET 	env_rev = _est 
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_fe(	_proy, 
						'Solicitud de Revisión de Datos Generales del Proyecto',
						CONCAT('El proyecto ', _proy, ', ha solicitado la revisión de sus Datos Generales \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF;
SELECT _rowcount AS numrows, _proy AS codigo ;  
					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_equi_fe` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_equi_fe`(
			IN _id INT,
			IN _dni VARCHAR(20),
			IN _ape_pat VARCHAR(50),
			IN _ape_mat VARCHAR(50),
			IN _nom VARCHAR(50),
			IN _sexo  INT,
			IN _edad  INT,
			IN _cali  INT,
			IN _mail  VARCHAR(50),
			IN _telf  VARCHAR(50),
			IN _unid INT,
			IN _carg  INT,
			IN _func VARCHAR(200),
			IN _dire VARCHAR(200),
			IN _usr CHAR(20))
BEGIN
  DECLARE _msg    VARCHAR(100);
  DECLARE _existe INT ;
  
  SELECT COUNT(1)
  INTO _existe
  FROM t90_equi_fe
  WHERE t90_dni_equi = _dni 
    AND t90_id_equi <> _id ;
  
  IF _existe > 0 THEN
    SELECT CONCAT('La Persona que intenta actualizar, tiene un DNI ', _dni, ' que ya fue registrado...')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
  ELSE
  
	UPDATE t90_equi_fe 
	SET
	t90_dni_equi = _dni , 
	t90_ape_pat = _ape_pat, 
	t90_ape_mat = _ape_mat , 
	t90_nom_equi = _nom , 
	t90_sexo_equi = _sexo, 
	t90_edad_equi = _edad, 
	t90_cali_equi = _cali, 
	t90_mail_equi = _mail, 
	t90_telf_equi = _telf, 
	t90_unid_fe = _unid , 
	t90_carg_equi = _carg, 
	t90_func_equi = _func, 
	t90_direccion = _dire, 
	
	usr_actu = _usr, 
	fch_actu = NOW() 
	WHERE
	t90_id_equi = _id ;
    SELECT ROW_COUNT()  AS numrows, _id AS codigo, '' AS msg ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_equi_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_equi_proy`(IN _t02_cod_proy 	VARCHAR(10), 
					 IN _t04_id_equi 	INT,  
					 IN _t04_dni_equi 	VARCHAR(20),
					 IN _t04_ape_pat 	VARCHAR(50),
					 IN _t04_ape_mat 	VARCHAR(50), 
					 IN _t04_nom_equi 	VARCHAR(50), 
					 IN _t04_sexo_equi 	INT, 
					 IN _t04_edad_equi 	INT,
					 IN _t04_cali_equi 	INT,
					 IN _t04_telf_equi 	VARCHAR(50),
					 IN _t04_cel_equi 	VARCHAR(20),
					 IN _t04_mail_equi 	VARCHAR(20),
					 IN _t04_exp_lab 	TEXT, 
					 IN _t04_func_equi 	TEXT,
					 IN _t04_carg_equi 	INT,
					 IN _t04_especialidad 	INT,					 
					 IN _fec_ini   		DATETIME,
					 IN _fec_ter   		DATETIME,
					 IN _t04_estado 	INT,
					 IN _UserID 		CHAR(20),
					 IN _fecha 		DATETIME,
					 IN _est_audi 		CHAR(1), IN _t04_especialidad_otro varchar(30))
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _existe1 	INT;
  DECLARE _existe2 	INT;
  DECLARE _numrows 	INT;
  DECLARE _apellido   	VARCHAR(50);
  DECLARE _nombre	VARCHAR(50);
  DECLARE _funcion   	TEXT;
  DECLARE _estado   	INT DEFAULT 113;
  
 
  
SELECT COUNT(1),
	r.t04_ape_pat, 
	r.t04_nom_equi 
INTO _existe1,_apellido,_nombre
FROM t04_equi_proy r 
WHERE t02_cod_proy=_t02_cod_proy AND t04_dni_equi=_t04_dni_equi AND t04_estado=_estado AND t04_id_equi<>_t04_id_equi ;
IF _existe1 > 0 THEN
	SELECT CONCAT('El personal  \"',_apellido,' ',_nombre,'\" esta registrado')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;      
END IF; 
 
SELECT 	COUNT(1), 
	r.t04_ape_pat, 
	r.t04_nom_equi, 
	r.t04_func_equi
INTO _existe2, _apellido, _nombre, _funcion
FROM t04_equi_proy r
WHERE r.t02_cod_proy = _t02_cod_proy 
  AND t04_estado=_estado 
  AND t04_carg_equi <> ''
  AND t04_carg_equi =_t04_carg_equi 
  AND t04_id_equi<>_t04_id_equi ;
IF _existe2 > 0 THEN
	SELECT CONCAT('El cargo fue asignado a \"',_apellido,' ',_nombre,'\" ')
	INTO _msg ;
	SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
	LEAVE TRANX;    
END IF ;
UPDATE t04_equi_proy 
SET
t02_cod_proy = _t02_cod_proy , 
t04_id_equi = _t04_id_equi , 
t04_dni_equi = _t04_dni_equi  , 
t04_ape_pat = _t04_ape_pat  , 
t04_ape_mat = _t04_ape_mat , 
t04_nom_equi = _t04_nom_equi , 
t04_sexo_equi = _t04_sexo_equi, 
t04_edad_equi = _t04_edad_equi , 
t04_cali_equi = _t04_cali_equi  , 
t04_mail_equi = _t04_mail_equi , 
t04_telf_equi = _t04_telf_equi  , 
t04_cel_equi = _t04_cel_equi , 
t04_carg_equi = _t04_carg_equi , 
t04_esp_equi = _t04_especialidad , 
t04_fec_ini   = _fec_ini ,
t04_fec_ter   =  _fec_ter,
t04_func_equi = _t04_func_equi , 
t04_exp_lab = _t04_exp_lab , 
t04_estado = _t04_estado , 
usr_actu = _UserID, 
fch_actu = NOW() , 
est_audi = _est_audi,
t04_esp_otro= _t04_especialidad_otro 	
WHERE t02_cod_proy = _t02_cod_proy 
  AND t04_id_equi = _t04_id_equi  ;	
	
SELECT ROW_COUNT() INTO _numrows;
COMMIT;
SELECT _numrows AS numrows, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_analisis` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_analisis`(
            IN _proy varchar(10), 
            IN _ver INT,
            IN _anio INT, 
            IN _entregable INT, 
            IN _resul TEXT, 
            IN _concl TEXT, 
            IN _limit TEXT,
            IN _facto TEXT,
            IN _persp TEXT,
            IN _usr varchar(20))
BEGIN
    DECLARE _numrows INT;
  
    UPDATE t25_inf_entregable
    SET t25_resulta = _resul,
    t25_conclu = _concl,
    t25_limita = _limit,
    t25_fac_pos = _facto,
    t25_perspec = _persp,
    usr_actu = _usr
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable 
    AND t02_version = _ver;
    
    SELECT ROW_COUNT() INTO _numrows;
    
    SELECT _numrows AS numrows, _ver AS codigo;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_at`(  
                        IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _anio INT, 
                        IN _entregable INT,
                        IN _comp INT,
                        IN _act  INT,
                        IN _sub  INT,
                        IN _beneficiarios  TEXT, 
                        IN _calificaciones TEXT,
                        IN _user   VARCHAR(20))
BEGIN
    DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempBenefAT',_beneficiarios,'|');
        CALL sp_strTempTable('TTempCalifAT',_calificaciones,'|');
        
    START TRANSACTION ;
        
    DELETE FROM t25_inf_entregable_at 
    WHERE t02_cod_proy = _proy  
      AND t08_cod_comp = _comp
      AND t09_cod_act = _act 
      AND t09_cod_sub = _sub 
      AND t25_anio = _anio
      AND t25_entregable = _entregable
      AND t02_version = _ver
      AND t11_cod_bene IN (SELECT b.txt FROM TTempBenefAT b INNER JOIN TTempCalifAT c ON b.id=c.id WHERE c.txt <> "");
      
    INSERT INTO t25_inf_entregable_at 
        (t02_cod_proy,
        t02_version,
        t08_cod_comp, 
        t09_cod_act, 
        t09_cod_sub, 
        t25_anio, 
        t25_entregable, 
        t11_cod_bene, 
        t15_avance, 
        fch_crea, 
        usr_crea, 
        usr_actu, 
        fch_actu, 
        est_audi
        )
    SELECT _proy,
        _ver,
        _comp,
        _act,
        _sub,
        _anio,
        _entregable  ,
        b.txt AS benef,
        c.txt AS avanc,
        NOW(),
        _user,
        NULL,
        NULL,
        '1'
    FROM TTempBenefAT b
    INNER JOIN TTempCalifAT c ON(b.id=c.id)
    WHERE c.txt <> "" ;
    
    SELECT ROW_COUNT() INTO _rowcount;
    
    COMMIT ;
    
    DROP TEMPORARY TABLE TTempBenefAT;
    DROP TEMPORARY TABLE TTempCalifAT;
    
    SELECT _rowcount AS numrows, _sub AS codigo ;
         
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_cab`(IN _proy varchar(10), 
            IN _ver INT,
            IN _anio INT, 
            IN _entregable INT, 
            IN _periodo VARCHAR(50), 
            IN _fchpres DATETIME, 
            IN _estado INT,
            IN _usr VARCHAR(20),
            IN _obs_gp TEXT, 
	    IN _intro_gp TEXT, 
            IN _vb_se INT)
BEGIN
    UPDATE t25_inf_entregable 
    SET t25_fch_pre = _fchpres, 
        t25_periodo = _periodo, 
        t25_estado  = _estado, 
        usr_actu = _usr, 
        fch_actu = now(),
        obs_gp = _obs_gp,
	intro_gp = _intro_gp,
        vb_se = _vb_se
    WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable 
    AND t02_version = _ver;
    
    SELECT ROW_COUNT() as numrows, _ver as codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_cambio_estado` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_cambio_estado`(
            IN _proy VARCHAR(10),
            IN _ver INT,
            IN _anio INT,
            IN _entregable INT, 
            IN _estado INT,
            IN _obs_gp TEXT)
BEGIN
 UPDATE t25_inf_entregable 
  SET   t25_estado  = _estado,
        t25_fch_pre = (CASE WHEN _estado=46 THEN NOW() ELSE t25_fch_pre END),
        obs_gp = _obs_gp
  WHERE t02_cod_proy = _proy 
    AND t25_anio = _anio 
    AND t25_entregable = _entregable 
    AND t02_version = _ver;
     
  SELECT ROW_COUNT() AS numrows , '' AS msg;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_capac`(  
                        IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _anio INT, 
                        IN _entregable INT,
                        IN _comp INT,
                        IN _act  INT,
                        IN _sub  INT,
                        IN _tema INT,
                        IN _beneficiarios  text, 
                        IN _calificaciones text,
                        IN _user   VARCHAR(20))
BEGIN
    DECLARE _rowcount INT;
    
    CALL sp_strTempTable('TTempBenef',_beneficiarios,'|');
    CALL sp_strTempTable('TTempCalif',_calificaciones,'|');

    START TRANSACTION ;
        
    DELETE FROM t25_inf_entregable_capac 
    WHERE t02_cod_proy = _proy  
      AND t08_cod_comp = _comp
      AND t09_cod_act = _act 
      AND t09_cod_sub = _sub 
      AND t12_cod_tema = _tema
      AND t25_anio = _anio
      AND t25_entregable = _entregable
      AND t02_version = _ver
      AND t11_cod_bene IN (SELECT b.txt FROM TTempBenef b INNER JOIN TTempCalif c ON b.id=c.id WHERE c.txt <> "");
      
    INSERT INTO t25_inf_entregable_capac 
        (t02_cod_proy,
        t02_version,
        t08_cod_comp, 
        t09_cod_act, 
        t09_cod_sub, 
        t12_cod_tema, 
        t25_anio, 
        t25_entregable, 
        t11_cod_bene, 
        t15_avance, 
        fch_crea, 
        usr_crea, 
        usr_actu, 
        fch_actu, 
        est_audi
        )
    SELECT _proy,
        _ver,
        _comp,
        _act,
        _sub,
        _tema,
        _anio,
        _entregable,
        b.txt AS benef,
        c.txt AS avanc,
        NOW(),
        _user,
        NULL,
        NULL,
        '1'
    FROM TTempBenef b
    INNER JOIN TTempCalif c ON(b.id=c.id)
    WHERE c.txt <> "";
    
    SELECT ROW_COUNT() INTO _rowcount;
    
    COMMIT;
    
    DROP TEMPORARY TABLE TTempBenef;
    DROP TEMPORARY TABLE TTempCalif;
    
    SELECT _rowcount AS numrows, _tema AS codigo ;
         
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_ind_comp_obs` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_ind_comp_obs`(IN _proy VARCHAR(10), 
    IN _ver INT, IN _comp INT, IN _compind INT, IN _anio INT, IN _entregable INT, 
    IN _avance DOUBLE, IN _descrip TEXT, IN _logros TEXT,
    IN _dificul TEXT,IN _obs TEXT, IN _usr TEXT)
BEGIN
	 DECLARE _existe INT;
	 
	 SELECT  IFNULL(COUNT(t08_cod_comp_ind),0)
	   INTO  _existe
	   FROM  t08_comp_ind_inf
	  WHERE  t02_cod_proy    = _proy 
	    and  t08_cod_comp    = _comp
	    AND  t08_cod_comp_ind= _compind 
	    AND  t08_ind_anio    = _anio
	    AND  t08_ind_entregable    = _entregable ;
	  
	  IF _existe <= 0 THEN 
	    BEGIN
	        INSERT INTO t08_comp_ind_inf 
	            (
	            t02_cod_proy, 
	            t02_version, 
	            t08_cod_comp,
	            t08_cod_comp_ind, 
	            t08_ind_anio, 
	            t08_ind_entregable, 
	            t08_ind_avanc, 
	            t08_descrip, 
	            t08_logros, 
	            t08_dificul,
	            t08_obs,
	            usr_crea, 
	            fch_crea, 
	            est_audi
	            )
	            VALUES
	            (
	            _proy   ,   
	            _ver ,
	            _comp,
	            _compind ,   
	            _anio , 
	            _entregable , 
	            _avance , 
	            _descrip ,
	            _logros  ,
	            _dificul ,
	            _obs,
	            _usr,
	            NOW()   ,   
	            '1'
	            );
	        
	    END;
	  ELSE
	    BEGIN
	        UPDATE t08_comp_ind_inf 
	           SET  t08_ind_avanc=_avance,
	            t08_descrip=_descrip, 
	            t08_logros=_logros, 
	            t08_dificul=_dificul, 
	            t08_obs = _obs,
	            usr_actu = _usr,
	            fch_actu = NOW()
	          WHERE  t02_cod_proy    = _proy 
	            AND  t08_cod_comp    = _comp
	            AND  t08_cod_comp_ind= _compind 
	            AND  t08_ind_anio    = _anio
	            AND  t08_ind_entregable    = _entregable ;
	      END;
	  END IF; 
	 
	 SELECT ROW_COUNT() INTO _existe;
	 
	 DELETE FROM t08_comp_ind_inf 
	  WHERE  t02_cod_proy   = _proy
	    AND  t08_cod_comp   = _comp 
	    AND  t08_ind_anio   = _anio
	    AND  t08_ind_entregable   = _entregable 
	    AND  (t08_ind_avanc  <=0 AND t08_descrip='' AND t08_logros='' AND t08_dificul='' and t08_obs) ;
	 
	      
	SELECT _existe AS numrows, _compind AS codigo ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_ind_producto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_entregable_ind_producto`(IN _proy VARCHAR(10), 
    IN _ver INT, IN _comp INT,IN _prod INT, IN _prodind INT, 
    IN _anio INT,IN _entregable INT, IN _avance DOUBLE, 
    IN _descrip TEXT, IN _logros TEXT, IN _dificul TEXT, 
    IN _obs TEXT, IN _usr VARCHAR(20))
BEGIN
	DECLARE _existe INT;
    
    SELECT  IFNULL(COUNT(t09_cod_prod_ind), 0)
    INTO _existe
    FROM t09_entregable_ind_inf
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t09_cod_prod_ind = _prodind 
    AND t09_ind_anio = _anio
    AND t09_ind_entregable = _entregable;
  
    IF _existe <= 0 THEN 
	    BEGIN
	        INSERT INTO t09_entregable_ind_inf 
	        (
	        t02_cod_proy, 
	        t02_version, 
	        t08_cod_comp, 
	        t09_cod_prod, 
	        t09_cod_prod_ind, 
	        t09_ind_anio, 
	        t09_ind_entregable, 
	        t09_ind_avanc, 
	        t09_descrip, 
	        t09_logros, 
	        t09_dificul,
	        t09_obs,
	        usr_crea, 
	        fch_crea, 
	        est_audi
	        )
	        VALUES
	        (
	        _proy,
	        _ver,
	        _comp,   
	        _prod,
	        _prodind,
	        _anio,
	        _entregable,
	        _avance,
	        _descrip,
	        _logros,
	        _dificul,
	        _obs,
	        _usr,
	        NOW(),
	        '1'
	        );
	    END;
    ELSE
	    BEGIN
	        UPDATE t09_entregable_ind_inf 
	           SET  t09_ind_avanc=_avance,
	            t09_descrip=_descrip, 
	            t09_logros=_logros, 
	            t09_dificul=_dificul,
	            t09_obs = _obs,
	            usr_actu = _usr,
	            fch_actu = NOW()
	          WHERE  t02_cod_proy   = _proy 
	            AND  t08_cod_comp   = _comp 
	            AND  t09_cod_prod    = _prod    
	            AND  t09_cod_prod_ind= _prodind 
	            AND  t09_ind_anio   = _anio
	            AND  t09_ind_entregable = _entregable;
        END;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t09_entregable_ind_inf 
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t09_ind_anio = _anio
    AND t09_ind_entregable = _entregable 
    AND (t09_ind_avanc  <=0 AND t09_descrip='' AND t09_logros='' AND t09_dificul='')
    AND t02_version = _ver;
 
    SELECT _existe AS numrows, _prodind AS codigo;                  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_ind_prop` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_ind_prop`(
                    IN _proy VARCHAR(10),
                    IN _ver INT,
                    IN _propind INT,  
                    IN _anio INT, 
                    IN _entregable INT, 
                    IN _avance DOUBLE, 
                    IN _descrip TEXT,
                    IN _logros  TEXT,
                    IN _dificul TEXT,
                    IN _observaciones TEXT,
                    IN _usr VARCHAR(20)
                   )
BEGIN
 DECLARE _existe INT;
 
 SELECT  IFNULL(COUNT(t07_cod_prop_ind),0)
   INTO  _existe
   FROM  t07_prop_ind_inf
  WHERE  t02_cod_proy    = _proy 
    AND  t07_cod_prop_ind= _propind 
    AND  t07_ind_anio    = _anio
    AND  t07_ind_entregable    = _entregable;
  
  IF _existe <= 0 THEN 
    BEGIN
        INSERT INTO t07_prop_ind_inf 
            (
            t02_cod_proy, 
            t02_version, 
            t07_cod_prop_ind, 
            t07_ind_anio, 
            t07_ind_entregable, 
            t07_ind_avanc, 
            t07_descrip, 
            t07_logros, 
            t07_dificul, 
            t07_observaciones,
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,   
            _ver,
            _propind,   
            _anio, 
            _entregable, 
            _avance, 
            _descrip,
            _logros,
            _dificul,
            _observaciones,
            _usr,
            NOW(),   
            '1'
            );
        
    END;
  ELSE
    BEGIN
        UPDATE t07_prop_ind_inf 
           SET  t07_ind_avanc=_avance,
            t07_descrip=_descrip, 
            t07_logros=_logros, 
            t07_dificul=_dificul,
            t07_observaciones = _observaciones,
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE t02_cod_proy = _proy 
            AND t07_cod_prop_ind = _propind 
            AND t07_ind_anio = _anio
            AND t07_ind_entregable = _entregable 
            AND t02_version = _ver;
      END;
  END IF; 
 
 SELECT ROW_COUNT() INTO _existe;
 
 DELETE FROM t07_prop_ind_inf 
  WHERE t02_cod_proy   = _proy 
    AND t07_ind_anio   = _anio
    AND t07_ind_entregable    = _entregable 
    AND (t07_ind_avanc  <=0 AND t07_descrip='' AND t07_logros='' AND t07_dificul='')
    AND t02_version = _ver;
 
    SELECT _existe AS numrows, _propind AS codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_entregable_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_entregable_otros`(  
                        IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _anio INT, 
                        IN _entregable INT,
                        IN _comp INT,
                        IN _act  INT,
                        IN _sub  INT,
                        IN _beneficiarios  TEXT, 
                        IN _calificaciones TEXT,
                        IN _valores        TEXT,
                        IN _user   VARCHAR(20))
BEGIN
    DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempBenefOtros',_beneficiarios,'|');
        CALL sp_strTempTable('TTempCalifOtros',_calificaciones,'|');
        CALL sp_strTempTable('TTempValuesOtros',_valores,'|');
        
    START TRANSACTION ;
        
    DELETE FROM t25_inf_entregable_otros
    WHERE t02_cod_proy = _proy  
    AND t08_cod_comp = _comp
    AND t09_cod_act = _act 
    AND t09_cod_sub = _sub 
    AND t25_anio = _anio
    AND t25_entregable = _entregable
    AND t02_version = _ver 
    AND t11_cod_bene IN (SELECT b.txt FROM TTempBenefOtros b INNER JOIN TTempCalifOtros c ON b.id=c.id WHERE c.txt <> "");
      
    INSERT INTO t25_inf_entregable_otros 
        (t02_cod_proy,
        t02_version,
        t08_cod_comp, 
        t09_cod_act, 
        t09_cod_sub, 
        t25_anio, 
        t25_entregable, 
        t11_cod_bene, 
        t15_avance, 
        t15_valor,
        fch_crea, 
        usr_crea, 
        usr_actu, 
        fch_actu, 
        est_audi
        )
    SELECT _proy,
        _ver,
        _comp,
        _act,
        _sub,
        _anio,
        _entregable,
        b.txt AS benef,
        c.txt AS avanc,
        (case when c.txt='1' then d.txt  else null end)AS valor,
        NOW(),
        _user,
        NULL,
        NULL,
        '1'
    FROM TTempBenefOtros b
    INNER JOIN TTempCalifOtros c ON(b.id=c.id)
    INNER JOIN TTempValuesOtros d on(b.id=d.id)
    WHERE c.txt <> "" ;
    
    SELECT ROW_COUNT() INTO _rowcount;
    
    COMMIT ;
    
    DROP TEMPORARY TABLE TTempBenefOtros;
    DROP TEMPORARY TABLE TTempCalifOtros;
    DROP TEMPORARY table TTempValuesOtros;
    
    SELECT _rowcount AS numrows, _sub AS codigo ;
         
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_financ_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_financ_cab`(IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _mes INT, 
            IN _anio_new INT, 
            IN _mes_new INT, 
            IN _fchpres DATETIME , 
            IN _periodo VARCHAR(50), 
            IN _obs  TEXT ,
            in _obsmoni text,
            IN _est_eje INT,
            IN _est_mon INT,
            IN _usr VARCHAR(20),                           
            IN _inf_financ_ter INT,
            IN _vb_se INT)
BEGIN
  UPDATE t40_inf_financ 
  SET   t40_anio = _anio_new, 
    t40_mes  = _mes_new, 
    t40_fch_pre = _fchpres, 
    t40_periodo = _periodo, 
    t40_est_eje = _est_eje, 
    t40_est_mon = _est_mon,
    t40_obs     = _obs,
    t40_obs_moni= _obsmoni,
    usr_actu = _usr, 
    inf_fi_ter = _inf_financ_ter,
    fch_actu = NOW(),
    vb_se = _vb_se
  WHERE t02_cod_proy=_proy 
    AND t40_anio=_anio 
    AND t40_mes=_mes;
    
    SELECT ROW_COUNT() AS numrows, _mes AS codigo;
                
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_financ_excedentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_financ_excedentes`(
			IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _mes INT, 
			IN _fec     DATETIME,
			IN _caja    DOUBLE,
			IN _bco_mn  DOUBLE,
			IN _ent_ren DOUBLE,
			IN _cxc	    DOUBLE,
			IN _cxp     DOUBLE,
			IN _caja_obs    TEXT,
			IN _bco_mn_obs  TEXT,
			IN _ent_ren_obs TEXT,
			IN _cxc_obs     TEXT,
			IN _cxp_obs     TEXT,
			IN _usr VARCHAR(20))
BEGIN
  DECLARE _cuentas_por_pagar DOUBLE ;
  
  IF _cxp > 0 THEN 
	SET _cuentas_por_pagar = (_cxp * -1) ;
  ELSE
	SET _cuentas_por_pagar = _cxp  ;
  END IF ;
  UPDATE t40_inf_financ 
  SET 	
	t40_cor_ctb = _fec    ,
	t40_caja    = _caja   ,
	t40_bco_mn  = _bco_mn ,
	t40_ent_rend= _ent_ren,
	t40_cxc     = _cxc    ,
	t40_cxp     = _cuentas_por_pagar    ,
	t40_caja_obs    = _caja_obs    ,
	t40_bco_mn_obs  = _bco_mn_obs  ,
	t40_ent_rend_obs= _ent_ren_obs ,
	t40_cxc_obs     = _cxc_obs     ,
	t40_cxp_obs     = _cxp_obs     ,
	t40_exc         = (_caja + _bco_mn +  _ent_ren + _cxc + _cuentas_por_pagar ),
	usr_actu = _usr, 
	fch_actu = NOW()
  WHERE t02_cod_proy=_proy 
    AND t40_anio=_anio 
    AND t40_mes=_mes ;

SELECT ROW_COUNT() AS numrows, _mes AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_financ_gastos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_financ_gastos`(
					IN _proy VARCHAR(10), 
					IN _comp INT, 
					IN _activ INT       , 
					IN _subact INT ,  
					IN _rubro INT,
					IN _fuente INT, 
					IN _anio INT , 
					IN _mes INT,
					IN _gasto DOUBLE, 
					IN _estado INT,
					IN _obs  TEXT,
					IN _usr VARCHAR(20)
				   )
BEGIN
 DECLARE _existe INT;
 DECLARE _ver 	  INT; 
 
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  IFNULL(COUNT(t41_cate_gasto),0)
   INTO  _existe
   FROM  t41_inf_financ_gasto
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND	 t09_cod_sub    = _subact 
    AND  t41_cate_gasto = _rubro
    AND  t41_fte_finan  = _fuente 
    AND  t40_anio	= _anio 
    AND  t40_mes	= _mes ;
  
  IF _existe <= 0 THEN 
	BEGIN
	
	INSERT INTO t41_inf_financ_gasto 
		(
		t02_cod_proy, 
		t40_anio, 
		t40_mes, 
		t02_version, 
		t08_cod_comp, 
		t09_cod_act, 
		t09_cod_sub, 
		t41_cate_gasto, 
		t41_fte_finan, 
		t41_gasto, 
		t41_estado, 
		t41_obs, 
		usr_crea, 
		fch_crea
		)
	VALUES
		(
		_proy   ,  
		_anio , 
		_mes ,
		_ver ,
		_comp   ,   
		_activ,
		_subact ,   
		_rubro , 
		_fuente,
		_gasto , 
		_estado,
		_obs ,
		_usr,
		NOW() 	
		);
	END;
  ELSE
	BEGIN
	 UPDATE t41_inf_financ_gasto 
	    SET t41_gasto = _gasto , 
		t41_estado = _estado , 
		t41_obs = _obs , 
		usr_actu = _usr , 
		fch_actu = NOW() 
	  WHERE t02_cod_proy = _proy
	    AND t40_anio = _anio 
	    AND t40_mes = _mes 
	    
	    AND t08_cod_comp = _comp 
	    AND t09_cod_act = _activ
	    AND t09_cod_sub = _subact
	    AND t41_cate_gasto = _rubro
	    AND t41_fte_finan = _fuente ;
      END;
  END IF; 
 
  SELECT ROW_COUNT() INTO _existe;
  
 DELETE FROM t41_inf_financ_gasto 
  WHERE t02_cod_proy = _proy
    AND t40_anio = _anio 
    AND t40_mes = _mes 
    AND t08_cod_comp = _comp 
    AND t09_cod_act = _activ
    AND t09_cod_sub = _subact
    AND t41_fte_finan = _fuente 
    AND  (t41_gasto  =0 AND t41_obs='');
 
 

SELECT _existe AS numrows, _rubro AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_financ_gastos_coment` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_financ_gastos_coment`(
					IN _proy VARCHAR(10), 
					IN _comp INT, 
					IN _activ INT       , 
					IN _subact INT ,  
					IN _rubro INT,
					IN _fuente INT, 
					IN _anio INT , 
					IN _mes INT,
					IN _obs  TEXT,
					IN _usr VARCHAR(20)
				   )
BEGIN
 DECLARE _existe INT;
 DECLARE _ver 	  INT; 
 
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  IFNULL(COUNT(t41_cate_gasto),0)
   INTO  _existe
   FROM  t41_inf_financ_gasto
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND	 t09_cod_sub    = _subact 
    AND  t41_cate_gasto = _rubro
    AND  t41_fte_finan  = _fuente 
    AND  t40_anio	= _anio 
    AND  t40_mes	= _mes ;
  
  IF _existe <= 0 THEN 
	BEGIN
	
	INSERT INTO t41_inf_financ_gasto 
		(
		t02_cod_proy, 
		t40_anio, 
		t40_mes, 
		t02_version, 
		t08_cod_comp, 
		t09_cod_act, 
		t09_cod_sub, 
		t41_cate_gasto, 
		t41_fte_finan, 
		t41_gasto, 
		t41_estado, 
		t41_obs, 
		usr_crea, 
		fch_crea
		)
	VALUES
		(
		_proy   ,  
		_anio , 
		_mes ,
		_ver ,
		_comp   ,   
		_activ,
		_subact ,   
		_rubro , 
		_fuente,
		null , 
		null,
		_obs ,
		_usr,
		NOW() 	
		);
	END;
  ELSE
	BEGIN
	 UPDATE t41_inf_financ_gasto 
	    SET t41_obs = _obs , 
		usr_actu = _usr , 
		fch_actu = NOW() 
	  WHERE t02_cod_proy = _proy
	    AND t40_anio = _anio 
	    AND t40_mes = _mes 
	    
	    AND t08_cod_comp = _comp 
	    AND t09_cod_act = _activ
	    AND t09_cod_sub = _subact
	    AND t41_cate_gasto = _rubro
	    AND t41_fte_finan = _fuente ;
      END;
  END IF; 
 
  SELECT ROW_COUNT() INTO _existe;
 
 

SELECT _existe AS numrows, _rubro AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_financ_otro_gasto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_financ_otro_gasto`(
			IN _proy VARCHAR(10), 
			IN _anio INT, 
			IN _mes INT, 
			IN _otro DOUBLE,
			IN _bco  DOUBLE,
			IN _otro_obs TEXT,
			IN _bco_obs  TEXT,
			IN _usr VARCHAR(20))
BEGIN
  UPDATE t40_inf_financ 
  SET 	
	t40_otro_ing = _otro, 
	t40_abo_bco  = _bco, 
	t40_otro_ing_obs = _otro_obs,
	t40_abo_bco_obs  = _bco_obs,
	usr_actu = _usr, 
	fch_actu = NOW()
  WHERE t02_cod_proy=_proy 
    AND t40_anio=_anio 
    AND t40_mes=_mes ;
	
SELECT ROW_COUNT() AS numrows, _mes AS codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mes_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_mes_cab`(
            IN _proy varchar(10), 
            IN _anio INT, 
            IN _mes INT, 
            IN _anio_new INT, 
            IN _mes_new INT, 
            in _verInf int,
            IN _periodo varchar(50), 
            IN _fchpres datetime , 
            IN _estado INT,
            IN _usr varchar(20),
            IN _vb_se INT)
BEGIN
  update t20_inf_mes 
  set   t20_anio = _anio_new, 
    t20_mes  = _mes_new, 
    t20_fch_pre = _fchpres, 
    t20_periodo = _periodo, 
    t20_estado  = _estado, 
    t02_version = fn_ult_version_proy(_proy), 
    usr_actu = _usr, 
    fch_actu = now(),
    vb_se = _vb_se
  where t02_cod_proy=_proy 
    and t20_anio=_anio 
    and t20_mes=_mes 
    and t20_ver_inf = _verInf;
    
    SELECT ROW_COUNT() AS numrows, _verInf AS codigo ;                  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mes_cab_dif_pro` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mes_cab_dif_pro`(
			IN _proy varchar(10), 
			IN _anio INT, 
			IN _mes INT, 
			in _verInf int,
			IN _dificul varchar(6000), 
			IN _program VARCHAR(6000), 
			IN _usr varchar(20))
BEGIN
  declare _numrows int;
  update t20_inf_mes 
  set 	t20_dificul = _dificul,
	t20_program = _program
  where t02_cod_proy=_proy 
    and t20_anio=_anio 
    and t20_mes=_mes 
    and t20_ver_inf =_verInf;
 select ROW_COUNT() into _numrows;
 DELETE FROM t20_inf_mes_prob 
  WHERE  t02_cod_proy=_proy 
    AND  t20_anio    =_anio 
    AND  t20_mes     =_mes 
    AND  t20_ver_inf =_verinf 
    AND  (t20_problemas='' AND t20_soluciones='' AND t20_resultados='');
select _numrows as numrows, _verInf as codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mes_cam_est` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mes_cam_est`(
			IN _proy VARCHAR(10),
			IN _anio INT,
			IN _mes INT, 
			IN _verInf INT,	
			IN _estado INT)
BEGIN
 UPDATE t20_inf_mes 
  SET 	t20_estado  = _estado,
        t20_fch_pre =(CASE WHEN _estado=46 THEN NOW() ELSE t20_fch_pre END)	
  WHERE t02_cod_proy=_proy 
    AND t20_anio=_anio 
    AND t20_mes=_mes 
    AND t20_ver_inf = _verInf;
     
  SELECT ROW_COUNT() AS numrows , '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mes_financ_cam_est` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mes_financ_cam_est`(IN _proy VARCHAR(10), IN _anio INT,  IN _mes INT, IN _estado INT)
BEGIN
 UPDATE t40_inf_financ 
  SET 	t40_est_eje  = _estado,
        t40_fch_pre =(CASE WHEN _estado=46 THEN NOW() ELSE t40_fch_pre END)	
  WHERE t02_cod_proy =_proy 
    AND t40_anio=_anio
    AND t40_mes=_mes;
  SELECT ROW_COUNT() AS numrows , '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mes_ind_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mes_ind_act`(IN _proy VARCHAR(10),IN _comp INT,IN _activ INT,IN _actind INT ,IN _anio INT,IN _mes INT,IN _avance DOUBLE,in _descrip varchar(2500),in _logros  varchar(2500),in _dificul varchar(2500),IN _usr VARCHAR(20))
BEGIN
 DECLARE _existe INt;
 declare _ver 	  INT; 
 
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  ifnull(count(t09_cod_act_ind),0)
   INTO  _existe
   from  t09_act_ind_mtas_inf
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND	 t09_cod_act_ind= _actind 
    AND  t09_ind_anio   = _anio
    AND  t09_ind_mes    = _mes ;
  
  if _existe <= 0 then 
	BEGIN
		INSERT INTO t09_act_ind_mtas_inf 
			(
			t02_cod_proy, 
			t02_version, 
			t08_cod_comp, 
			t09_cod_act, 
			t09_cod_act_ind, 
			t09_ind_anio, 
			t09_ind_mes, 
			t09_ind_avanc, 
			t09_descrip, 
			t09_logros, 
			t09_dificul,
			usr_crea, 
			fch_crea, 
			est_audi
			)
			VALUES
			(
			_proy   ,   
			_ver ,
			_comp   ,   
			_activ,
			_actind ,   
			_anio , 
			_mes , 
			_avance , 
			_descrip ,
			_logros  ,
			_dificul ,
			_usr,
			NOW()   ,   
			'1'
			);
		
	END;
  else
	BEGIN
		UPDATE t09_act_ind_mtas_inf 
		   SET  t09_ind_avanc=_avance,
			t09_descrip=_descrip, 
			t09_logros=_logros, 
			t09_dificul=_dificul,
			usr_actu = _usr,
			fch_actu = NOW()
		  WHERE  t02_cod_proy	= _proy 
		    AND	 t08_cod_comp	= _comp 
		    AND  t09_cod_act	= _activ	
		    AND	 t09_cod_act_ind= _actind 
		    AND  t09_ind_anio   = _anio
		    AND  t09_ind_mes    = _mes ;
      END;
  end if; 
 
  SELECT ROW_COUNT() INTO _existe;
 
 delete from t09_act_ind_mtas_inf 
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND  t09_ind_anio   = _anio
    AND  t09_ind_mes    = _mes 
    and  (t09_ind_avanc  <=0 and t09_descrip='' and t09_logros='' and t09_dificul='') ;
 
		  						
SELECT _existe AS numrows, _actind AS codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mes_prob_solu` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mes_prob_solu`(
					IN _proy VARCHAR(10), 
					IN _anio INT, 
					IN _mes INT ,
					in _verinf int,
					in _cod_prob int,
					in _prob varchar(6000),
					in _soluc  varchar(6000),
					in _resul varchar(6000),
					IN _usr VARCHAR(20)
				   )
BEGIN
 DECLARE _existe INt;
 SELECT  ifnull(count(t20_cod_prob),0)
   INTO  _existe
   from  t20_inf_mes_prob
  WHERE  t02_cod_proy	= _proy 
    AND  t20_anio   	= _anio
    and  t20_mes    	= _mes
    and  t20_ver_inf    = _verinf
    AND  t20_cod_prob   = _cod_prob ;
  
  if _existe <= 0 then 
	BEGIN
		INSERT INTO t20_inf_mes_prob 
				(t02_cod_proy, 
				t20_anio, 
				t20_mes, 
				t20_ver_inf, 
				t20_cod_prob, 
				t20_problemas, 
				t20_soluciones, 
				t20_resultados, 
				usr_crea, 
				fch_crea, 
				est_audi
				)
				VALUES
				(_proy, 
				_anio, 
				_mes, 
				_verinf, 
				_cod_prob, 
				_prob, 
				_soluc, 
				_resul, 
				_usr, 
				now(), 
				'1'
				);
		
	END;
  else
	BEGIN
		UPDATE t20_inf_mes_prob 
		SET
			t20_problemas = _prob , 
			t20_soluciones = _soluc , 
			t20_resultados = _resul , 
			usr_actu = _usr , 
			fch_actu = now() 
		WHERE	t02_cod_proy=_proy 
		  and t20_anio=_anio 
		  AND t20_mes=_mes 
		  AND t20_ver_inf=_verinf 
		  AND t20_cod_prob=_cod_prob ;
      END;
  end if; 
 
  SELECT ROW_COUNT() INTO _existe;
		  						
SELECT _existe AS numrows, _cod_prob AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mes_sub_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mes_sub_act`(IN _proy VARCHAR(10), 
					IN _comp INT, 
					IN _activ INT       , 
					IN _subact INT ,  
					IN _anio INT, 
					IN _mes INT    , 
					IN _avance DOUBLE, 
					IN _descrip VARCHAR(2500),
					IN _logros  VARCHAR(2500),
					IN _dificul VARCHAR(2500),
					IN _omt TEXT,
					IN _usr VARCHAR(20))
BEGIN
 DECLARE _existe INT;
 DECLARE _ver 	  INT; 
 
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  IFNULL(COUNT(t09_cod_sub),0)
   INTO  _existe
   FROM  t09_act_sub_mtas_inf
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND	 t09_cod_sub	= _subact 
    AND  t09_sub_anio   = _anio
    AND  t09_sub_mes    = _mes ;
  
  IF _existe <= 0 THEN 
	BEGIN
		INSERT INTO t09_act_sub_mtas_inf 
			(
			t02_cod_proy, 
			t02_version, 
			t08_cod_comp, 
			t09_cod_act, 
			t09_cod_sub, 
			t09_sub_anio, 
			t09_sub_mes, 
			t09_sub_avanc, 
			t09_descrip, 
			t09_logros, 
			t09_dificul, 
			t09_omt,
			usr_crea, 
			fch_crea, 
			est_audi
			)
			VALUES
			(
			_proy   ,   
			_ver ,
			_comp   ,   
			_activ,
			_subact ,   
			_anio , 
			_mes , 
			_avance , 
			_descrip ,
			_logros  ,
			_dificul ,  
			_omt , 
			_usr,
			NOW()   ,   
			'1'
			);
		
	END;
  ELSE
	BEGIN
		UPDATE t09_act_sub_mtas_inf 
		   SET  t09_sub_avanc=_avance,
			t09_descrip=_descrip, 
			t09_logros=_logros, 
			t09_dificul=_dificul, 
			t09_omt=_omt,
			usr_actu = _usr,
			fch_actu = NOW()
		  WHERE  t02_cod_proy	= _proy 
		    AND	 t08_cod_comp	= _comp 
		    AND  t09_cod_act	= _activ	
		    AND	 t09_cod_sub	= _subact 
		    AND  t09_sub_anio   = _anio
		    AND  t09_sub_mes    = _mes ;
      END;
  END IF; 
 
 SELECT ROW_COUNT() INTO _existe;
 
 DELETE FROM t09_act_sub_mtas_inf 
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND  t09_sub_anio   = _anio
    AND  t09_sub_mes    = _mes 
    AND  (t09_sub_avanc  <=0 AND t09_descrip='' AND t09_logros='' AND t09_dificul=''  AND t09_omt='' ) ;
 
		  						
SELECT _existe AS numrows, _subact AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mf_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mf_cab`(IN  _proy VARCHAR(10), 
			in  _num  int ,
			IN  _fchpres DATETIME , 
			IN  _per_ini INT ,
			IN  _per_fin INT ,
			IN  _estado INT,
			IN  _usr VARCHAR(20),   IN _obs_cmt VARCHAR(200))
BEGIN
DECLARE _periodo VARCHAR(50);
SELECT CONCAT(fn_nom_mes(t40_periodo), ' ' , YEAR(t40_fch_pre))
  INTO _periodo
  FROM t40_inf_financ 
 WHERE t02_cod_proy = _proy
   AND fn_numero_mes(t40_anio, t40_mes) = _per_ini ;
  
SELECT CONCAT(_periodo, ' - ' , fn_nom_mes(t40_periodo), ' ' , YEAR(t40_fch_pre))
  INTO _periodo
  FROM t40_inf_financ 
 WHERE t02_cod_proy = _proy
   AND fn_numero_mes(t40_anio, t40_mes) = _per_fin ;
  UPDATE t51_inf_mf 
  SET 	t51_fch_pre = _fchpres, 
	t51_per_ini = _per_ini, 
	t51_per_fin = _per_fin, 
	t51_periodo = _periodo,
	t51_estado     = _estado,
	usr_actu = _usr, 
	fch_actu = NOW(),
	t51_obs_cmt=_obs_cmt
  WHERE t02_cod_proy=_proy 
    AND t51_num =_num  ;
    
					
SELECT ROW_COUNT() AS numrows, _num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mf_comentarios` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mf_comentarios`(
			IN _proy VARCHAR(10), 
			IN _num INT, 
			IN _coment TEXT, 
			IN _usr VARCHAR(20))
BEGIN
DECLARE _ROWCOUNT INT ;
declare _ncomnet int ;
  UPDATE t51_inf_mf 
     SET t51_obs = _coment ,	 
	 usr_actu = _usr , 
	 fch_actu = NOW() 
   WHERE t02_cod_proy = _proy
     AND t51_num = _num ;
  SELECT ROW_COUNT() INTO _ROWCOUNT ;
  
  IF not EXISTS(SELECT t51_obs_id FROM t51_inf_mf_observa WHERE t02_cod_proy = _proy and t51_num = _num and t51_obs_moni = _coment) then
     select IFNULL(max(t51_obs_id),0)+1 
       into _ncomnet
       from t51_inf_mf_observa 
      WHERE t02_cod_proy = _proy 
        AND t51_num = _num ;
	
     INSERT INTO t51_inf_mf_observa 
				(t02_cod_proy, 
				t51_num, 
				t51_obs_id, 
				t51_fecha, 
				t51_obs_moni, 
				usr_crea, 
				fch_crea, 
				est_audi
				)
			VALUES  (
				 _proy,
				 _num ,
				 _ncomnet,
				 now(),
				 _coment,
				 _usr,
				 now(),
				 '1'
				);
     
  end if ;
	
SELECT _ROWCOUNT AS numrows, _num AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mf_coment_fisico` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mf_coment_fisico`(
			IN  _proy VARCHAR(10), 
			IN  _num  INT ,
			IN  _comp INT,
			IN  _act  INT,
			IN  _sub  INT,
			IN  _coment TEXT, 
			IN  _usr VARCHAR(20))
BEGIN
DECLARE _existe INT ; 
SELECT COUNT(1)
INTO _existe 
FROM t51_inf_mf_avance_meta
WHERE t02_cod_proy = _proy
  AND t51_num      = _num 
  AND t08_cod_comp = _comp
  AND t09_cod_act  = _act
  AND t09_cod_sub  = _sub  ;
  
  
IF _existe > 0 THEN 
     UPDATE t51_inf_mf_avance_meta 
	SET t51_obs = _coment ,
	    usr_actu   = _usr , 
	    fch_actu   = NOW() 
	WHERE t02_cod_proy = _proy
	  AND t51_num      = _num 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub  ;
ELSE
     
    IF _coment <>'' THEN
     INSERT INTO t51_inf_mf_avance_meta 
	(t02_cod_proy, 
	 t51_num, 
	 t08_cod_comp,
	 t09_cod_act,
	 t09_cod_sub,
	 t51_obs,
	 usr_crea, 
	 fch_crea, 
	 est_audi
	)
	VALUES
	(_proy , 
	 _num, 
	 _comp,
	 _act,
	 _sub,
	 _coment,
	_usr, 
	NOW(), 
	'1'
	);
     END IF ;
     
END IF ;
    
					
SELECT ROW_COUNT() AS numrows, _num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mf_coment_presup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mf_coment_presup`(
			IN  _proy  VARCHAR(10), 
			IN  _num   INT ,
			in  _comp  int,
			in  _act   int,
			in  _sub   int,
			in  _idFte int,
			IN  _coment text, 
			IN  _usr VARCHAR(20))
BEGIN
declare _existe int ; 
select count(1)
into _existe 
from t51_inf_mf_avance_monto
where t02_cod_proy = _proy
  and t51_num      = _num 
  and t08_cod_comp = _comp
  and t09_cod_act  = _act
  and t09_cod_sub  = _sub  
  and t51_fuente   = _idFte ;
  
  
if _existe > 0 then 
     update t51_inf_mf_avance_monto 
	set t51_obs = _coment ,
	    usr_actu   = _usr , 
	    fch_actu   = NOW() 
	WHERE t02_cod_proy = _proy
	  AND t51_num      = _num 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub  
	  and t51_fuente   = _idFte ;
else
     
    if _coment <>'' then
     insert into t51_inf_mf_avance_monto 
	(t02_cod_proy, 
	 t51_num, 
	 t08_cod_comp,
	 t09_cod_act,
	 t09_cod_sub,
	 t51_fuente,
	 t51_obs,
	 usr_crea, 
	 fch_crea, 
	 est_audi
	)
	values
	(_proy , 
	 _num, 
	 _comp,
	 _act,
	 _sub,
	 _idFte,
	 _coment,
	_usr, 
	now(), 
	'1'
	);
     end if ;
     
end if ;
    
					
SELECT ROW_COUNT() AS numrows, _num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mf_conclusiones` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mf_conclusiones`(
			IN _proy VARCHAR(10), 
			IN _num INT, 
			IN _conclu TEXT, 
			IN _calif  int ,
			IN _usr VARCHAR(20))
BEGIN
  UPDATE t51_inf_mf 
     SET t51_conclu = _conclu , 
	 t51_califica = _calif , 
	 usr_actu = _usr , 
	 fch_actu = NOW() 
   WHERE t02_cod_proy = _proy
     AND t51_num = _num ;
	
SELECT ROW_COUNT() AS numrows, _num AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mf_eva_doc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mf_eva_doc`(
			IN  _proy VARCHAR(10), 
			IN  _num  INT ,
			IN  _tipdoc int , 
			IN  _estdoc INT ,
			IN  _obsdoc text ,
			IN  _usr VARCHAR(20))
BEGIN
declare _existe int ; 
select count(1)
into _existe 
from t51_inf_mf_docs
where t02_cod_proy = _proy
  and t51_num      = _num 
  and t51_tipdoc   =  _tipdoc;
if _existe > 0 then 
     update t51_inf_mf_docs 
	set t51_estdoc = _estdoc , 
	    t51_estobs = _obsdoc , 
	    usr_actu   = _usr , 
	    fch_actu   = NOW() 
	WHERE t02_cod_proy = _proy
	  AND t51_num      = _num 
	  AND t51_tipdoc   =  _tipdoc;
else
     
    if _estdoc >0 or _obsdoc <>'' then
     insert into t51_inf_mf_docs 
	(t02_cod_proy, 
	 t51_num, 
	 t51_tipdoc, 
	 t51_estdoc, 
	 t51_estobs, 
	 usr_crea, 
	 fch_crea, 
	 est_audi
	)
	values
	(_proy , 
	 _num, 
	_tipdoc, 
	_estdoc, 
	_obsdoc, 
	_usr, 
	now(), 
	'1'
	);
     end if ;
     
end if ;
    
					
SELECT ROW_COUNT() AS numrows, _num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_mf_excedentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_mf_excedentes`(
			IN _proy VARCHAR(10), 
			IN _Num INT,  
			IN _fec     DATETIME,
			IN _caja    DOUBLE,
			IN _bco_mn  DOUBLE,
			IN _ent_ren DOUBLE,
			IN _cxc	    DOUBLE,
			IN _cxp     DOUBLE,
			IN _caja_obs    TEXT,
			IN _bco_mn_obs  TEXT,
			IN _ent_ren_obs TEXT,
			IN _cxc_obs     TEXT,
			IN _cxp_obs     TEXT,
			IN _usr VARCHAR(20))
BEGIN
  UPDATE t51_inf_mf 
  SET 	
	t51_cor_ctb = _fec    ,
	t51_caja    = _caja   ,
	t51_bco_mn  = _bco_mn ,
	t51_ent_rend= _ent_ren,
	t51_cxc     = _cxc    ,
	t51_cxp     = _cxp    ,
	t51_exc     = (_caja + _bco_mn +  _ent_ren + _cxc + _cxp),
	t51_caja_obs    = _caja_obs    ,
	t51_bco_mn_obs  = _bco_mn_obs  ,
	t51_ent_rend_obs= _ent_ren_obs ,
	t51_cxc_obs     = _cxc_obs     ,
	t51_cxp_obs     = _cxp_obs     ,
	usr_actu = _usr, 
	fch_actu = NOW()
  WHERE t02_cod_proy=_proy 
    AND t51_num = _Num ;

SELECT ROW_COUNT() AS numrows, _Num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_monint_adicional` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_monint_adicional`(
			IN _proy   VARCHAR(10), 
			IN _num    INT, 
			IN _verInf INT,
			IN _eva1   INT, 
			IN _eva2   INT , 
			IN _eva3   INT,
			IN _eva4   INT,
			IN _eva5   INT,
			IN _eva6   INT,
			IN _eva7   INT,
			IN _eva1_obs VARCHAR(2500), 
			IN _eva2_obs VARCHAR(2500), 
			IN _eva3_obs VARCHAR(2500),
			IN _eva4_obs VARCHAR(2500),
			IN _eva5_obs VARCHAR(2500),
			IN _eva6_obs VARCHAR(2500),
			IN _eva7_obs VARCHAR(2500),
			IN _logros   TEXT,
			IN _dificu   TEXT,
			IN _reco_proy TEXT,
			IN _reco_fe   TEXT,
			IN _califica  TEXT,
			IN _usr VARCHAR(20))
BEGIN
  UPDATE t45_inf_mi 
     SET t45_eva1 = _eva1 , 
	 t45_eva2 = _eva2 , 
	 t45_eva3 = _eva3 , 
	 t45_eva4 = _eva4 , 
	 t45_eva5 = _eva5 ,
	 t45_eva6 = _eva6 ,
	 t45_eva7 = _eva7 ,
	 
	 t45_eva1_obs = _eva1_obs,  
	 t45_eva2_obs = _eva2_obs,
	 t45_eva3_obs = _eva3_obs, 
	 t45_eva4_obs = _eva4_obs,
	 t45_eva5_obs = _eva5_obs, 
	 t45_eva6_obs = _eva6_obs,
	 t45_eva7_obs = _eva7_obs,
	 t45_logros   = _logros, 
	 t45_dificul  = _dificu, 
	 t45_reco_proy= _reco_proy, 
	 t45_reco_fe  = _reco_fe, 
	 t45_califica = _califica, 
	 usr_actu = _usr , 
	 fch_actu = NOW() 
   WHERE t02_cod_proy = _proy
     AND t45_id = _num
     AND t45_ver_inf = _verInf ;
     
	
SELECT ROW_COUNT() AS numrows, _verInf AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_monint_avanc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_monint_avanc`(
			IN _proy varchar(10), 
			IN _num INT, 
			in _verInf int,
			IN _avance_comp text, 
			IN _avance_capc text , 
			IN _avance_fina text,
			IN _usr varchar(20))
BEGIN
  UPDATE t45_inf_mi 
     SET t45_avance_comp = _avance_comp , 
	 t45_avance_cap  = _avance_capc , 
	 t45_avance_fin  = _avance_fina , 
	 usr_actu = _usr , 
	 fch_actu = now() 
   WHERE t02_cod_proy = _proy
     AND t45_id = _num
     AND t45_ver_inf = _verInf ;
	
select ROW_COUNT() as numrows, _verInf as codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_se_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_se_act`(
                    IN _proy VARCHAR(10), 
                    IN _comp INT, 
                    IN _prod INT, 
                    IN _act INT ,  
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _usr VARCHAR(20)
                   )
BEGIN
    DECLARE _existe INT;
 
    SELECT IFNULL(COUNT(t09_cod_act),0)
    INTO _existe
    FROM t09_act_inf_se
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod
    AND t09_cod_act = _act
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
    IF _existe <= 0 THEN 
        INSERT INTO t09_act_inf_se 
            (
            t02_cod_proy,
            t02_anio,
            t02_entregable,
            t08_cod_comp, 
            t09_cod_prod, 
            t09_cod_act, 
            t09_obs, 
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,
            _anio,
            _entregable,
            _comp,
            _prod,
            _act,  
            _obs,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t09_act_inf_se 
           SET t09_obs = _obs, 
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE t02_cod_proy = _proy 
            AND t08_cod_comp = _comp 
            AND t09_cod_prod = _prod    
            AND t09_cod_act = _act 
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t09_act_inf_se 
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND t09_obs = '';
 
    SELECT _existe AS numrows;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_se_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_se_cab`(IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _periodo VARCHAR(50), 
            IN _fchpres DATETIME , 
            IN _estado INT,
            IN _intro TEXT,
            IN _fuentes TEXT,
            IN _fec_ini_vis DATETIME,
            IN _fec_ter_vis DATETIME,
            IN _obs TEXT,
            IN _usr VARCHAR(20))
BEGIN
    UPDATE  t30_inf_se 
    SET     t30_fch_pre     = _fchpres, 
            t30_estado      = _estado, 
            t30_intro       = _intro,
            t30_fuentes     = _fuentes,
            t30_fec_ini_vis = _fec_ini_vis,
            t30_fec_ter_vis = _fec_ter_vis,
            t30_obs         = _obs,
            usr_actu        = _usr, 
            fch_actu        = NOW() 
    WHERE   t02_cod_proy = _proy
        AND t02_anio = _anio
        AND t02_entregable = _entregable;
        
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_se_calif` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_se_calif`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _eva1 INT, 
            IN _eva2 INT , 
            IN _eva3 INT,
            IN _eva4 INT,
            IN _eva5 INT,
            IN _eva6 INT,
            IN _eva7 INT,
            IN _cali TEXT,
            IN _usr VARCHAR(20))
BEGIN
  UPDATE t30_inf_se 
     SET t30_crit_eva1 = _eva1, 
     t30_crit_eva2 = _eva2, 
     t30_crit_eva3 = _eva3, 
     t30_crit_eva4 = _eva4, 
     t30_crit_eva5 = _eva5,
     t30_crit_eva6 = _eva6,
     t30_crit_eva7 = _eva7,
     t30_califica  = _cali,
     usr_actu = _usr, 
     fch_actu = NOW() 
   WHERE t02_cod_proy = _proy
     AND t02_anio = _anio
     AND t02_entregable = _entregable;
     
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_se_conc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_se_conc`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _avance TEXT, 
            IN _logros TEXT , 
            IN _dificul TEXT,
            IN _recom_proy TEXT,
            IN _recom_fe TEXT,
            IN _usr VARCHAR(20))
BEGIN
  UPDATE t30_inf_se 
     SET t30_avance = _avance, 
     t30_logros = _logros, 
     t30_dificul = _dificul, 
     t30_reco_proy = _recom_proy,
     t30_reco_fe = _recom_fe,
     usr_actu = _usr,
     fch_actu = NOW() 
   WHERE t02_cod_proy = _proy
     AND t02_anio = _anio
     AND t02_entregable = _entregable;

    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_se_ind_car_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_se_ind_car_prod`(
                    IN _proy VARCHAR(10),
                    IN _comp INT,
                    IN _prod INT,
                    IN _prod_ind INT,  
                    IN _prod_ind_car INT,
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _avance DOUBLE,
                    IN _usr VARCHAR(20)
                   )
BEGIN
    DECLARE _existe INT;
    
    SELECT IFNULL(COUNT(t09_cod_prod_ind_car),0)
    INTO _existe
    FROM t09_prod_ind_car_inf_se
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t09_cod_prod_ind = _prod_ind 
    AND t09_cod_prod_ind_car = _prod_ind_car 
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
  IF _existe <= 0 THEN 
        INSERT INTO t09_prod_ind_car_inf_se 
            (
            t02_cod_proy, 
            t08_cod_comp, 
            t09_cod_prod, 
            t09_cod_prod_ind, 
            t09_cod_prod_ind_car,
            t02_anio,
            t02_entregable, 
            t09_obs,
            t09_avance,
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,   
            _comp,   
            _prod,
            _prod_ind,
            _prod_ind_car,
            _anio,
            _entregable,
            _obs,
            _avance,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t09_prod_ind_car_inf_se 
           SET  t09_obs = _obs,
            t09_avance = _avance,
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE  t02_cod_proy = _proy 
            AND  t08_cod_comp = _comp 
            AND  t09_cod_prod = _prod    
            AND  t09_cod_prod_ind = _prod_ind
            AND  t09_cod_prod_ind_car = _prod_ind_car
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t09_prod_ind_car_inf_se 
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod 
    AND t09_cod_prod_ind = _prod_ind
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND (t09_obs = '' OR t09_obs = NULL)
    AND (t09_avance = NULL OR t09_avance=0);
 
    SELECT _existe AS numrows;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_se_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_se_ind_comp`(
                    IN _proy VARCHAR(10), 
                    IN _comp INT ,
                    IN _compind INT ,  
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _avance DOUBLE,
                    IN _usr VARCHAR(20)
                   )
BEGIN
    DECLARE _existe INT;
 
    SELECT IFNULL(COUNT(t08_cod_comp_ind),0)
    INTO _existe
    FROM t08_comp_ind_inf_se
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp
    AND t08_cod_comp_ind= _compind 
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
    IF _existe <= 0 THEN 
        INSERT INTO t08_comp_ind_inf_se 
            (
            t02_cod_proy, 
            t08_cod_comp,
            t08_cod_comp_ind, 
            t02_anio,
            t02_entregable, 
            t08_obs,
            t08_avance,
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,   
            _comp,
            _compind,   
            _anio,
            _entregable,
            _obs,
            _avance,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t08_comp_ind_inf_se 
           SET t08_obs = _obs,
            t08_avance = _avance,
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE t02_cod_proy = _proy 
            AND t08_cod_comp = _comp
            AND t08_cod_comp_ind = _compind 
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t08_comp_ind_inf_se 
    WHERE t02_cod_proy = _proy
    AND t08_cod_comp = _comp 
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND (t08_obs = '' OR t08_obs = NULL)
    AND (t08_avance = NULL OR t08_avance=0);
 
    SELECT _existe AS numrows; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_se_ind_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_se_ind_prod`(
                    IN _proy VARCHAR(10),
                    IN _comp INT,
                    IN _prod INT,
                    IN _prod_ind INT,  
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _avance DOUBLE,
                    IN _usr VARCHAR(20)
                   )
BEGIN
	DECLARE _existe INT;
    
	SELECT IFNULL(COUNT(t09_cod_prod_ind),0)
    INTO _existe
    FROM t09_prod_ind_inf_se
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t09_cod_prod_ind = _prod_ind 
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
  IF _existe <= 0 THEN 
        INSERT INTO t09_prod_ind_inf_se 
            (
            t02_cod_proy, 
            t08_cod_comp, 
            t09_cod_prod, 
            t09_cod_prod_ind, 
            t02_anio,
            t02_entregable, 
            t09_obs,
            t09_avance,
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,   
            _comp,   
            _prod,
            _prod_ind,   
            _anio,
            _entregable,
            _obs,
            _avance,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t09_prod_ind_inf_se 
           SET  t09_obs = _obs,
            t09_avance = _avance,
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE  t02_cod_proy = _proy 
            AND  t08_cod_comp = _comp 
            AND  t09_cod_prod = _prod    
            AND  t09_cod_prod_ind = _prod_ind 
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t09_prod_ind_inf_se 
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND (t09_obs = '' OR t09_obs = NULL)
    AND (t09_avance = NULL OR t09_avance=0);
 
    SELECT _existe AS numrows, _prod_ind AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_si_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_si_act`(
                    IN _proy VARCHAR(10), 
                    IN _comp INT, 
                    IN _prod INT, 
                    IN _act INT ,  
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _usr VARCHAR(20)
                   )
BEGIN
    DECLARE _existe INT;
 
    SELECT IFNULL(COUNT(t09_cod_act),0)
    INTO _existe
    FROM t09_act_inf_si
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod
    AND t09_cod_act = _act
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
    IF _existe <= 0 THEN 
        INSERT INTO t09_act_inf_si 
            (
            t02_cod_proy,
            t02_anio,
            t02_entregable,
            t08_cod_comp, 
            t09_cod_prod, 
            t09_cod_act, 
            t09_obs, 
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,
            _anio,
            _entregable,
            _comp,
            _prod,
            _act,  
            _obs,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t09_act_inf_si 
           SET t09_obs = _obs, 
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE t02_cod_proy = _proy 
            AND t08_cod_comp = _comp 
            AND t09_cod_prod = _prod    
            AND t09_cod_act = _act 
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t09_act_inf_si 
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND t09_obs = '';
 
    SELECT _existe AS numrows;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_si_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_si_cab`(IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _periodo VARCHAR(50), 
            IN _fchpres DATETIME , 
            IN _estado INT,
            IN _intro TEXT,
            IN _fuentes TEXT,
            IN _fec_ini_vis DATETIME,
            IN _fec_ter_vis DATETIME,
            IN _obs TEXT,
            IN _usr VARCHAR(20))
BEGIN
    UPDATE  t45_inf_si 
    SET     t45_fch_pre     = _fchpres, 
            t45_estado      = _estado, 
            t45_intro       = _intro,
            t45_fuentes     = _fuentes,
            t45_fec_ini_vis = _fec_ini_vis,
            t45_fec_ter_vis = _fec_ter_vis,
            t45_obs         = _obs,
            usr_actu        = _usr, 
            fch_actu        = NOW() 
    WHERE   t02_cod_proy = _proy
        AND t02_anio = _anio
        AND t02_entregable = _entregable;
        
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_si_calif` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_si_calif`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _eva1 INT, 
            IN _eva2 INT , 
            IN _eva3 INT,
            IN _eva4 INT,
            IN _eva5 INT,
            IN _eva6 INT,
            IN _eva7 INT,
            IN _cali TEXT,
            IN _usr VARCHAR(20))
BEGIN
  UPDATE t45_inf_si 
     SET t45_crit_eva1 = _eva1, 
     t45_crit_eva2 = _eva2, 
     t45_crit_eva3 = _eva3, 
     t45_crit_eva4 = _eva4, 
     t45_crit_eva5 = _eva5,
     t45_crit_eva6 = _eva6,
     t45_crit_eva7 = _eva7,
     t45_califica  = _cali,
     usr_actu = _usr, 
     fch_actu = NOW() 
   WHERE t02_cod_proy = _proy
     AND t02_anio = _anio
     AND t02_entregable = _entregable;
     
    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_si_conc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_si_conc`(
            IN _proy VARCHAR(10), 
            IN _anio INT, 
            IN _entregable INT,
            IN _avance TEXT, 
            IN _logros TEXT , 
            IN _dificul TEXT,
            IN _recom_proy TEXT,
            IN _recom_fe TEXT,
            IN _usr VARCHAR(20))
BEGIN
  UPDATE t45_inf_si 
     SET t45_avance = _avance, 
     t45_logros = _logros, 
     t45_dificul = _dificul, 
     t45_reco_proy = _recom_proy,
     t45_reco_fe = _recom_fe,
     usr_actu = _usr,
     fch_actu = NOW() 
   WHERE t02_cod_proy = _proy
     AND t02_anio = _anio
     AND t02_entregable = _entregable;

    SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_si_ind_car_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_si_ind_car_prod`(
                    IN _proy VARCHAR(10),
                    IN _comp INT,
                    IN _prod INT,
                    IN _prod_ind INT,  
                    IN _prod_ind_car INT,
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _avance DOUBLE,
                    IN _usr VARCHAR(20)
                   )
BEGIN
    DECLARE _existe INT;
    
    SELECT IFNULL(COUNT(t09_cod_prod_ind_car),0)
    INTO _existe
    FROM t09_prod_ind_car_inf_si
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t09_cod_prod_ind = _prod_ind 
    AND t09_cod_prod_ind_car = _prod_ind_car 
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
  IF _existe <= 0 THEN 
        INSERT INTO t09_prod_ind_car_inf_si 
            (
            t02_cod_proy, 
            t08_cod_comp, 
            t09_cod_prod, 
            t09_cod_prod_ind, 
            t09_cod_prod_ind_car,
            t02_anio,
            t02_entregable, 
            t09_obs,
            t09_avance,
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,   
            _comp,   
            _prod,
            _prod_ind,
            _prod_ind_car,
            _anio,
            _entregable,
            _obs,
            _avance,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t09_prod_ind_car_inf_si 
           SET  t09_obs = _obs,
            t09_avance = _avance,
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE  t02_cod_proy = _proy 
            AND  t08_cod_comp = _comp 
            AND  t09_cod_prod = _prod    
            AND  t09_cod_prod_ind = _prod_ind
            AND  t09_cod_prod_ind_car = _prod_ind_car
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t09_prod_ind_car_inf_si 
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod 
    AND t09_cod_prod_ind = _prod_ind
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND (t09_obs = '' OR t09_obs = NULL)
    AND (t09_avance = NULL OR t09_avance=0);
 
    SELECT _existe AS numrows;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_si_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_si_ind_comp`(
                    IN _proy VARCHAR(10), 
                    IN _comp INT ,
                    IN _compind INT ,  
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _avance DOUBLE,
                    IN _usr VARCHAR(20)
                   )
BEGIN
    DECLARE _existe INT;
 
    SELECT IFNULL(COUNT(t08_cod_comp_ind),0)
    INTO _existe
    FROM t08_comp_ind_inf_si
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp
    AND t08_cod_comp_ind= _compind 
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
    IF _existe <= 0 THEN 
        INSERT INTO t08_comp_ind_inf_si 
            (
            t02_cod_proy, 
            t08_cod_comp,
            t08_cod_comp_ind, 
            t02_anio,
            t02_entregable, 
            t08_obs,
            t08_avance,
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,   
            _comp,
            _compind,   
            _anio,
            _entregable,
            _obs,
            _avance,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t08_comp_ind_inf_si 
           SET t08_obs = _obs,
            t08_avance = _avance,
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE t02_cod_proy = _proy 
            AND t08_cod_comp = _comp
            AND t08_cod_comp_ind = _compind 
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t08_comp_ind_inf_si 
    WHERE t02_cod_proy = _proy
    AND t08_cod_comp = _comp 
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND (t08_obs = '' OR t08_obs = NULL)
    AND (t08_avance = NULL OR t08_avance=0);
 
    SELECT _existe AS numrows; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_si_ind_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_inf_si_ind_prod`(
                    IN _proy VARCHAR(10),
                    IN _comp INT,
                    IN _prod INT,
                    IN _prod_ind INT,  
                    IN _anio INT,
                    IN _entregable INT,
                    IN _obs TEXT,
                    IN _avance DOUBLE,
                    IN _usr VARCHAR(20)
                   )
BEGIN
    DECLARE _existe INT;
    
    SELECT IFNULL(COUNT(t09_cod_prod_ind),0)
    INTO _existe
    FROM t09_prod_ind_inf_si
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t09_cod_prod_ind = _prod_ind 
    AND t02_anio = _anio
    AND t02_entregable = _entregable;
  
  IF _existe <= 0 THEN 
        INSERT INTO t09_prod_ind_inf_si 
            (
            t02_cod_proy, 
            t08_cod_comp, 
            t09_cod_prod, 
            t09_cod_prod_ind, 
            t02_anio,
            t02_entregable, 
            t09_obs,
            t09_avance,
            usr_crea, 
            fch_crea, 
            est_audi
            )
            VALUES
            (
            _proy,   
            _comp,   
            _prod,
            _prod_ind,   
            _anio,
            _entregable,
            _obs,
            _avance,
            _usr,
            NOW(),   
            '1'
            );
    ELSE
        UPDATE t09_prod_ind_inf_si 
           SET  t09_obs = _obs,
            t09_avance = _avance,
            usr_actu = _usr,
            fch_actu = NOW()
          WHERE  t02_cod_proy = _proy 
            AND  t08_cod_comp = _comp 
            AND  t09_cod_prod = _prod    
            AND  t09_cod_prod_ind = _prod_ind 
            AND t02_anio = _anio
            AND t02_entregable = _entregable;
    END IF; 
 
    SELECT ROW_COUNT() INTO _existe;
 
    DELETE FROM t09_prod_ind_inf_si 
    WHERE t02_cod_proy = _proy 
    AND t08_cod_comp = _comp 
    AND t09_cod_prod = _prod    
    AND t02_anio = _anio
    AND t02_entregable = _entregable
    AND (t09_obs = '' OR t09_obs = NULL)
    AND (t09_avance = NULL OR t09_avance=0);
 
    SELECT _existe AS numrows, _prod_ind AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_analisis` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_analisis`(
			IN _proy varchar(10), 
			IN _anio INT, 
			IN _trim INT, 
			in _verInf int,
			IN _resul varchar(6000), 
			IN _concl VARCHAR(6000), 
			in _limit varchar(6000),
			in _facto varchar(6000),
			in _persp varchar(6000),
			IN _usr varchar(20))
BEGIN
  declare _numrows int;
  update t25_inf_trim
  set 	t25_resulta= _resul,
	t25_conclu = _concl,
	t25_limita = _limit,
	t25_fac_pos= _facto,
	t25_perspec= _persp,
	usr_actu   = _usr
  where t02_cod_proy=_proy 
    and t25_anio=_anio 
    and t25_trim=_trim 
    and t25_ver_inf =_verInf;
select ROW_COUNT() into _numrows;

select _numrows as numrows, _verInf as codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_at`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _anio INT, 
					    IN _trim INT,
					    IN _comp INT,
					    IN _act  INT,
					    IN _sub  INT,
					    IN _beneficiarios  TEXT, 
					    IN _calificaciones TEXT,
					    IN _user   VARCHAR(20))
BEGIN
	DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempBenef1',_beneficiarios,'|');
        CALL sp_strTempTable('TTempCalif1',_calificaciones,'|');
        
	START TRANSACTION ;
        
	DELETE FROM t25_inf_trim_at 
	WHERE t02_cod_proy = _proy  
	  AND t08_cod_comp  = _comp
	  AND t09_cod_act  = _act 
	  AND t09_cod_sub  = _sub 
	  AND t25_anio     = _anio
	  AND t25_trim     = _trim ;
	INSERT INTO t25_inf_trim_at 
		(t02_cod_proy, 
		t08_cod_comp, 
		t09_cod_act, 
		t09_cod_sub, 
		t25_anio, 
		t25_trim, 
		t11_cod_bene, 
		t15_avance, 
		fch_crea, 
		usr_crea, 
		usr_actu, 
		fch_actu, 
		est_audi
		)
	SELECT 	_proy  , 
		_comp  ,
		_act   ,
		_sub   ,
		_anio  ,
		_trim  ,
		b.txt AS benef,
		c.txt AS avanc,
		NOW(),
		_user,
		NULL,
		NULL,
		'1'
	FROM TTempBenef1 b
	INNER JOIN TTempCalif1 c ON(b.id=c.id)
	WHERE c.txt <> "" ;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	COMMIT ;
	
	DROP TEMPORARY TABLE TTempBenef1;
	DROP TEMPORARY TABLE TTempCalif1;
	
	SELECT _rowcount AS numrows, _sub AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_capac`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _anio INT, 
					    IN _trim INT,
					    in _comp int,
					    in _act  int,
					    in _sub  int,
					    in _tema int,
					    IN _beneficiarios  text, 
					    in _calificaciones text,
					    IN _user   VARCHAR(20))
BEGIN
	DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempBenef',_beneficiarios,'|');
        CALL sp_strTempTable('TTempCalif',_calificaciones,'|');
        
	START TRANSACTION ;
        
	DELETE FROM t25_inf_trim_capac 
	WHERE t02_cod_proy = _proy  
	  AND t08_cod_comp  = _comp
	  AND t09_cod_act  = _act 
	  AND t09_cod_sub  = _sub 
	  and t12_cod_tema = _tema
	  and t25_anio     = _anio
	  and t25_trim     = _trim ;
	INSERT INTO t25_inf_trim_capac 
		(t02_cod_proy, 
		t08_cod_comp, 
		t09_cod_act, 
		t09_cod_sub, 
		t12_cod_tema, 
		t25_anio, 
		t25_trim, 
		t11_cod_bene, 
		t15_avance, 
		fch_crea, 
		usr_crea, 
		usr_actu, 
		fch_actu, 
		est_audi
		)
	SELECT 	_proy  , 
		_comp  ,
		_act   ,
		_sub   ,
		_tema  ,
		_anio  ,
		_trim  ,
		b.txt AS benef,
		c.txt AS avanc,
		NOW(),
		_user,
		NULL,
		NULL,
		'1'
	FROM TTempBenef b
	INNER JOIN TTempCalif c ON(b.id=c.id)
	WHERE c.txt <> "" ;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	commit ;
	
	DROP TEMPORARY TABLE TTempBenef;
	DROP TEMPORARY TABLE TTempCalif;
	
	SELECT _rowcount AS numrows, _tema AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_cred`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _comp INT,
					    IN _act  INT,
					    IN _sub  INT,
					    in _anio int,
					    in _trim int,
					    IN _beneficiarios  TEXT, 
					    IN _montos  TEXT, 
					    IN _user   VARCHAR(20))
BEGIN
	DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempBen',_beneficiarios,'|');
        CALL sp_strTempTable('TTempMto',_montos,'|');
        
	START TRANSACTION ;
	
	delete from t25_inf_trim_cred
	where t02_cod_proy = _proy  
	  AND t08_cod_comp = _comp 
	  AND t09_cod_act  = _act  
	  AND t09_cod_sub  = _sub 
	  AND t25_anio     = _anio
	  and t25_trim     = _trim ;
	insert into t25_inf_trim_cred 
		(t02_cod_proy, 
		t08_cod_comp, 
		t09_cod_act, 
		t09_cod_sub, 
		t25_anio, 
		t25_trim, 
		t11_cod_bene, 
		t15_avance, 
		fch_crea, 
		usr_crea, 
		est_audi
		)
        SELECT 	_proy  , 
		_comp  ,
		_act   ,
		_sub   ,
		_anio ,
		_trim ,
		b.txt AS benef,
		m.txt AS monto,
		NOW() AS fecha,
		_user AS usuario,
		'1'   AS estado
	FROM 	   TTempBen b
	INNER JOIN TTempMto m ON(m.id = b.id)
	WHERE b.txt <> "" ;
		
	SELECT ROW_COUNT() INTO _rowcount;
	
	COMMIT ;
	
	DROP TEMPORARY TABLE TTempBen;
	DROP TEMPORARY TABLE TTempMto;
	
	SELECT _rowcount AS numrows, _sub AS codigo, '' AS msg ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_ind_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_ind_act`(
					IN _proy VARCHAR(10), 
					IN _comp INT, 
					IN _activ INT       , 
					IN _actind INT ,  
					IN _anio INT, 
					IN _trim INT    , 
					IN _avance DOUBLE, 
					in _descrip varchar(2500),
					in _logros  varchar(2500),
					in _dificul varchar(2500),
					IN _usr VARCHAR(20)
				   )
BEGIN
 declare _mes 	 INT; 
 
 SELECT (_trim * 3) INTO _mes; 
 
 call sp_upd_inf_mes_ind_act(	_proy , 
				_comp , 
				_activ , 
				_actind ,  
				_anio , 
				_mes , 
				_avance , 
				_descrip ,
				_logros  ,
				_dificul ,
				_usr);
 					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_ind_act_obs` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_ind_act_obs`(IN _proy VARCHAR(10),IN _comp INT,IN _activ INT,IN _actind INT ,IN _anio INT,IN _mes INT,IN _avance DOUBLE,in _descrip varchar(2500),in _logros  varchar(2500),in _dificul varchar(2500),in _obs varchar(2500),IN _usr VARCHAR(20))
BEGIN
 DECLARE _existe INt;
 declare _ver 	  INT; 
 set _mes = _mes*3;
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  ifnull(count(t09_cod_act_ind),0)
   INTO  _existe
   from  t09_act_ind_mtas_inf
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND	 t09_cod_act_ind= _actind 
    AND  t09_ind_anio   = _anio
    AND  t09_ind_mes    = _mes ;
  
  if _existe <= 0 then 
	BEGIN
		INSERT INTO t09_act_ind_mtas_inf 
			(
			t02_cod_proy, 
			t02_version, 
			t08_cod_comp, 
			t09_cod_act, 
			t09_cod_act_ind, 
			t09_ind_anio, 
			t09_ind_mes, 
			t09_ind_avanc, 
			t09_descrip, 
			t09_logros, 
			t09_dificul, 
			t09_obs,
			usr_crea, 
			fch_crea, 
			est_audi
			)
			VALUES
			(
			_proy   ,   
			_ver ,
			_comp   ,   
			_activ,
			_actind ,   
			_anio , 
			_mes , 
			_avance , 
			_descrip ,
			_logros  ,
			_dificul ,
			_obs,
			_usr,
			NOW()   ,   
			'1'
			);
		
	END;
  else
	BEGIN
		UPDATE t09_act_ind_mtas_inf 
		   SET  t09_ind_avanc=_avance,
			t09_descrip=_descrip, 
			t09_logros=_logros, 
			t09_dificul=_dificul,
			t09_obs = _obs,
			usr_actu = _usr,
			fch_actu = NOW()
		  WHERE  t02_cod_proy	= _proy 
		    AND	 t08_cod_comp	= _comp 
		    AND  t09_cod_act	= _activ	
		    AND	 t09_cod_act_ind= _actind 
		    AND  t09_ind_anio   = _anio
		    AND  t09_ind_mes    = _mes ;
      END;
  end if; 
 
  SELECT ROW_COUNT() INTO _existe;
 
 delete from t09_act_ind_mtas_inf 
  WHERE  t02_cod_proy	= _proy 
    AND	 t08_cod_comp	= _comp 
    AND  t09_cod_act	= _activ	
    AND  t09_ind_anio   = _anio
    AND  t09_ind_mes    = _mes 
    and  (t09_ind_avanc  <=0 and t09_descrip='' and t09_logros='' and t09_dificul='' and t09_obs='') ;
 
		  						
SELECT _existe AS numrows, _actind AS codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_ind_comp`(IN _proy VARCHAR(10),  in _comp int ,
 IN _compind INT , IN _anio INT,	IN _trim INT    , 
IN _avance DOUBLE, 
 IN _descrip VARCHAR(2500),
 IN _logros  VARCHAR(2500),
	IN _dificul VARCHAR(2500),
IN _usr VARCHAR(20))
BEGIN
 DECLARE _existe INT;
 DECLARE _ver 	  INT; 
 
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  IFNULL(COUNT(t08_cod_comp_ind),0)
   INTO  _existe
   FROM  t08_comp_ind_inf
  WHERE  t02_cod_proy	 = _proy 
    and  t08_cod_comp    = _comp
    AND	 t08_cod_comp_ind= _compind 
    AND  t08_ind_anio    = _anio
    AND  t08_ind_trim    = _trim ;
  
  IF _existe <= 0 THEN 
	BEGIN
		INSERT INTO t08_comp_ind_inf 
			(
			t02_cod_proy, 
			t02_version, 
			t08_cod_comp,
			t08_cod_comp_ind, 
			t08_ind_anio, 
			t08_ind_trim, 
			t08_ind_avanc, 
			t08_descrip, 
			t08_logros, 
			t08_dificul, 
			usr_crea, 
			fch_crea, 
			est_audi
			)
			VALUES
			(
			_proy   ,   
			_ver ,
			_comp,
			_compind ,   
			_anio , 
			_trim , 
			_avance , 
			_descrip ,
			_logros  ,
			_dificul ,   
			_usr,
			NOW()   ,   
			'1'
			);
		
	END;
  ELSE
	BEGIN
		UPDATE t08_comp_ind_inf 
		   SET  t08_ind_avanc=_avance,
			t08_descrip=_descrip, 
			t08_logros=_logros, 
			t08_dificul=_dificul, 
			usr_actu = _usr,
			fch_actu = NOW()
		  WHERE  t02_cod_proy	 = _proy 
		    AND  t08_cod_comp    = _comp
		    AND	 t08_cod_comp_ind= _compind 
		    AND  t08_ind_anio    = _anio
		    AND  t08_ind_trim    = _trim ;
      END;
  END IF; 
 
 SELECT ROW_COUNT() INTO _existe;
 
 DELETE FROM t08_comp_ind_inf 
  WHERE  t02_cod_proy	= _proy
    AND  t08_cod_comp   = _comp 
    AND  t08_ind_anio   = _anio
    AND  t08_ind_trim   = _trim 
    AND  (t08_ind_avanc  <=0 AND t08_descrip='' AND t08_logros='' AND t08_dificul='') ;
 
		
SELECT _existe AS numrows, _compind AS codigo ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_ind_comp_obs` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_ind_comp_obs`(IN _proy VARCHAR(10),  in _comp int , IN _compind INT , IN _anio INT, IN _trim INT , IN _avance DOUBLE, IN _descrip VARCHAR(2500),IN _logros  VARCHAR(2500),IN _dificul VARCHAR(2500),IN _obs VARCHAR(2500), IN _usr VARCHAR(20))
BEGIN
 DECLARE _existe INT;
 DECLARE _ver 	  INT; 
 
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  IFNULL(COUNT(t08_cod_comp_ind),0)
   INTO  _existe
   FROM  t08_comp_ind_inf
  WHERE  t02_cod_proy	 = _proy 
    and  t08_cod_comp    = _comp
    AND	 t08_cod_comp_ind= _compind 
    AND  t08_ind_anio    = _anio
    AND  t08_ind_trim    = _trim ;
  
  IF _existe <= 0 THEN 
	BEGIN
		INSERT INTO t08_comp_ind_inf 
			(
			t02_cod_proy, 
			t02_version, 
			t08_cod_comp,
			t08_cod_comp_ind, 
			t08_ind_anio, 
			t08_ind_trim, 
			t08_ind_avanc, 
			t08_descrip, 
			t08_logros, 
			t08_dificul,
			t08_obs,
			usr_crea, 
			fch_crea, 
			est_audi
			)
			VALUES
			(
			_proy   ,   
			_ver ,
			_comp,
			_compind ,   
			_anio , 
			_trim , 
			_avance , 
			_descrip ,
			_logros  ,
			_dificul ,
			_obs,
			_usr,
			NOW()   ,   
			'1'
			);
		
	END;
  ELSE
	BEGIN
		UPDATE t08_comp_ind_inf 
		   SET  t08_ind_avanc=_avance,
			t08_descrip=_descrip, 
			t08_logros=_logros, 
			t08_dificul=_dificul, 
			t08_obs = _obs,
			usr_actu = _usr,
			fch_actu = NOW()
		  WHERE  t02_cod_proy	 = _proy 
		    AND  t08_cod_comp    = _comp
		    AND	 t08_cod_comp_ind= _compind 
		    AND  t08_ind_anio    = _anio
		    AND  t08_ind_trim    = _trim ;
      END;
  END IF; 
 
 SELECT ROW_COUNT() INTO _existe;
 
 DELETE FROM t08_comp_ind_inf 
  WHERE  t02_cod_proy	= _proy
    AND  t08_cod_comp   = _comp 
    AND  t08_ind_anio   = _anio
    AND  t08_ind_trim   = _trim 
    AND  (t08_ind_avanc  <=0 AND t08_descrip='' AND t08_logros='' AND t08_dificul='' and t08_obs) ;
 
		
SELECT _existe AS numrows, _compind AS codigo ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_ind_prop` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_ind_prop`(
					IN _proy VARCHAR(10), 
					IN _propind INT ,  
					IN _anio INT, 
					IN _trim INT    , 
					IN _avance DOUBLE, 
					IN _descrip VARCHAR(2500),
					IN _logros  VARCHAR(2500),
					IN _dificul VARCHAR(2500),
					IN _usr VARCHAR(20)
				   )
BEGIN
 DECLARE _existe INT;
 DECLARE _ver 	  INT; 
 
 SELECT fn_ult_version_proy(_proy) INTO _ver ;
 
 SELECT  IFNULL(COUNT(t07_cod_prop_ind),0)
   INTO  _existe
   FROM  t07_prop_ind_inf
  WHERE  t02_cod_proy	 = _proy 
    AND	 t07_cod_prop_ind= _propind 
    AND  t07_ind_anio    = _anio
    AND  t07_ind_trim    = _trim ;
  
  IF _existe <= 0 THEN 
	BEGIN
		INSERT INTO t07_prop_ind_inf 
			(
			t02_cod_proy, 
			t02_version, 
			t07_cod_prop_ind, 
			t07_ind_anio, 
			t07_ind_trim, 
			t07_ind_avanc, 
			t07_descrip, 
			t07_logros, 
			t07_dificul, 
			usr_crea, 
			fch_crea, 
			est_audi
			)
			VALUES
			(
			_proy   ,   
			_ver ,
			_propind ,   
			_anio , 
			_trim , 
			_avance , 
			_descrip ,
			_logros  ,
			_dificul ,   
			_usr,
			NOW()   ,   
			'1'
			);
		
	END;
  ELSE
	BEGIN
		UPDATE t07_prop_ind_inf 
		   SET  t07_ind_avanc=_avance,
			t07_descrip=_descrip, 
			t07_logros=_logros, 
			t07_dificul=_dificul, 
			usr_actu = _usr,
			fch_actu = NOW()
		  WHERE  t02_cod_proy	 = _proy 
		    AND	 t07_cod_prop_ind= _propind 
		    AND  t07_ind_anio    = _anio
		    AND  t07_ind_trim    = _trim ;
      END;
  END IF; 
 
 SELECT ROW_COUNT() INTO _existe;
 
 DELETE FROM t07_prop_ind_inf 
  WHERE  t02_cod_proy	= _proy 
    AND  t07_ind_anio   = _anio
    AND  t07_ind_trim    = _trim 
    AND  (t07_ind_avanc  <=0 AND t07_descrip='' AND t07_logros='' AND t07_dificul='') ;
 
		
SELECT _existe AS numrows, _propind AS codigo ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_otros`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _anio INT, 
					    IN _trim INT,
					    IN _comp INT,
					    IN _act  INT,
					    IN _sub  INT,
					    IN _beneficiarios  TEXT, 
					    IN _calificaciones TEXT,
					    IN _valores        TEXT,
					    IN _user   VARCHAR(20))
BEGIN
	DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempBenef1',_beneficiarios,'|');
        CALL sp_strTempTable('TTempCalif1',_calificaciones,'|');
        CALL sp_strTempTable('TTempValues',_valores,'|');
        
	START TRANSACTION ;
        
	DELETE FROM t25_inf_trim_otros
	WHERE t02_cod_proy = _proy  
	  AND t08_cod_comp  = _comp
	  AND t09_cod_act  = _act 
	  AND t09_cod_sub  = _sub 
	  AND t25_anio     = _anio
	  AND t25_trim     = _trim ;
	  
	INSERT INTO t25_inf_trim_otros 
		(t02_cod_proy, 
		t08_cod_comp, 
		t09_cod_act, 
		t09_cod_sub, 
		t25_anio, 
		t25_trim, 
		t11_cod_bene, 
		t15_avance, 
		t15_valor,
		fch_crea, 
		usr_crea, 
		usr_actu, 
		fch_actu, 
		est_audi
		)
	SELECT 	_proy  , 
		_comp  ,
		_act   ,
		_sub   ,
		_anio  ,
		_trim  ,
		b.txt AS benef,
		c.txt AS avanc,
		(case when c.txt='1' then d.txt  else null end)AS valor,
		NOW(),
		_user,
		NULL,
		NULL,
		'1'
	FROM TTempBenef1 b
	INNER JOIN TTempCalif1 c ON(b.id=c.id)
	inner join TTempValues d on(b.id=d.id)
	WHERE c.txt <> "" ;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	COMMIT ;
	
	DROP TEMPORARY TABLE TTempBenef1;
	DROP TEMPORARY TABLE TTempCalif1;
	drop TEMPORARY table TTempValues ;
	
	SELECT _rowcount AS numrows, _sub AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_sub_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_sub_act`(
					IN _proy VARCHAR(10), 
					IN _comp INT, 
					IN _activ INT       , 
					IN _subact INT ,  
					IN _anio INT, 
					IN _trim INT    , 
					IN _avance DOUBLE, 
					in _descrip varchar(2500),
					in _logros  varchar(2500),
					in _dificul varchar(2500),
					IN _omt TEXT,
					IN _usr VARCHAR(20)
				   )
BEGIN
 DECLARE _mes 	 INT; 
 
 SELECT (_trim * 3) INTO _mes; 
 call sp_upd_inf_mes_sub_act(	_proy , 
				_comp , 
				_activ , 
				_subact ,  
				_anio , 
				_mes , 
				_avance , 
				_descrip ,
				_logros  ,
				_dificul ,
				_omt,
				_usr );
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_trim_upd_est` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_trim_upd_est`(IN _proy VARCHAR(10),
			IN _anio INT,
			IN _trim INT, 
	IN _obs VARCHAR(50),		IN _verInf INT,	
			IN _estado INT)
BEGIN
 UPDATE t25_inf_trim 
  SET 	t25_estado  = _estado,
        t25_fch_pre =(CASE WHEN _estado=46 THEN NOW() ELSE t25_fch_pre END),
			  obs_mt=_obs
  WHERE t02_cod_proy=_proy 
   AND t25_anio=_anio 
   AND t25_trim=_trim 
   AND t25_ver_inf = _verInf;
     
  SELECT ROW_COUNT() AS numrows , '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_unico_anual_adicional` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_unico_anual_adicional`(IN _proy   VARCHAR(10), 
			IN _num    INT, 
			IN _eva1   INT, 
			IN _eva2   INT , 
			IN _eva3   INT,
			IN _eva4   INT,
			IN _eva5   INT,
			IN _eva6   INT,
			IN _eva7   INT,
			IN _eva1_obs VARCHAR(2500), 
			IN _eva2_obs VARCHAR(2500), 
			IN _eva3_obs VARCHAR(2500),
			IN _eva4_obs VARCHAR(2500),
			IN _eva5_obs VARCHAR(2500),
			IN _eva6_obs VARCHAR(2500),
			IN _eva7_obs VARCHAR(2500),
			IN _logros   TEXT,
			IN _dificu   TEXT,
			IN _reco_proy TEXT,
			IN _reco_fe   TEXT,
			IN _califica  TEXT,
			IN _t55_cmt INT, 
			IN _t55_cmf INT,
			IN _estado INT,
			IN _usr VARCHAR(20))
BEGIN
	DECLARE aCmtFlg CHAR(1);
	DECLARE aCmfFlg CHAR(1);
	
	SELECT	t55_cmt, t55_cmf
	INTO	aCmtFlg, aCmfFlg
	FROM	t55_inf_unico_anual
	WHERE	t02_cod_proy = _proy AND t55_id = _num;
	
	UPDATE	t55_inf_unico_anual 
	SET		t55_eva1 = _eva1 , 
			t55_eva2 = _eva2 , 
			t55_eva3 = _eva3 , 
			t55_eva4 = _eva4 , 
			t55_eva5 = _eva5 ,
			t55_eva6 = _eva6 ,
			t55_eva7 = _eva7 ,
			t55_eva1_obs = _eva1_obs,  
			t55_eva2_obs = _eva2_obs,
			t55_eva3_obs = _eva3_obs, 
			t55_eva4_obs = _eva4_obs,
			t55_eva5_obs = _eva5_obs, 
			t55_eva6_obs = _eva6_obs,
			t55_eva7_obs = _eva7_obs,
			t55_logros   = _logros, 
			t55_dificultades  = _dificu, 
			t55_reco_proy= _reco_proy, 
			t55_reco_fe  = _reco_fe, 
			t55_recomendaciones = _califica, 
			t55_cmt = _t55_cmt,
			t55_cmf = _t55_cmf,
			t55_estado = case
							when ((_t55_cmt = 1 AND _t55_cmf = 1) AND 
									(aCmtFlg != 1 OR aCmfFlg != 1) AND 
									(_estado IS NOT NULL AND _estado > 0)) then
								_estado
							else
								t55_estado
						end,
			usr_actu = _usr , 
			fch_actu = NOW() 
	WHERE	t02_cod_proy = _proy
		AND t55_id = _num;
     
	
SELECT ROW_COUNT() AS numrows, _num AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_unico_anual_analisis_avanc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_unico_anual_analisis_avanc`(
			IN _proy VARCHAR(10), 
			IN _num INT, 
			IN _avance_comp TEXT, 
			IN _avance_capc TEXT , 
			IN _avance_fina TEXT,
			IN _mt_flg CHAR(1),
			IN _mf_flg CHAR(1),
			IN _estado INT,
			IN _usr VARCHAR(20))
BEGIN
	DECLARE aMtFlg CHAR(1);
	DECLARE aMfFlg CHAR(1);
	DECLARE aCurrState INT;
	DECLARE aNomEjec VARCHAR(30);
	DECLARE StateElab INT DEFAULT 45;
	DECLARE StateRev  INT DEFAULT 46;
	DECLARE StateCorr INT DEFAULT 47;
	DECLARE StateAppr INT DEFAULT 257;
	
	DECLARE aNumRows INT;
	DECLARE aCodigo INT;
	
	SELECT	t55_mt, t55_mf, t55_estado
	INTO	aMtFlg, aMfFlg, aCurrState
	FROM	t55_inf_unico_anual
	WHERE	t02_cod_proy = _proy AND t55_id = _num;
	
	IF (_estado IS NOT NULL AND _estado > 0) THEN
		
		UPDATE	t55_inf_unico_anual
		SET		t55_avan_comp = _avance_comp , 
				t55_avan_cap  = _avance_capc , 
				t55_avan_fin  = _avance_fina , 
				t55_mt = IFNULL(_mt_flg, 0),
				t55_mf = IFNULL(_mf_flg, 0),
				t55_estado = _estado,
				usr_actu = _usr ,
				fch_actu = NOW() 
		WHERE	t02_cod_proy = _proy
			AND t55_id = _num ;
		SELECT ROW_COUNT(), _num INTO aNumRows, aCodigo ;
			
		IF ((aCurrState = StateElab OR aCurrState = StateCorr) AND (_estado = StateRev)) THEN
			SELECT	t01_sig_inst 
			INTO	aNomEjec 
			FROM	t01_dir_inst 
			WHERE	t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p 
									WHERE p.t02_cod_proy = _proy AND p.t02_version = 1);
			CALL sp_ins_mensaje_proy_a_personalizado(	_proy, 
														'Solicitud de Revisión del Informe Único Anual', 
														CONCAT('El proyecto ', _proy, ', ha solicitado la revisión de su Informe Único Anual. \n\nPuede revisar el informe haciendo <a href="http://localhost/sgp/sme/monitoreofe/informes/inf_unico_anual_list.php?txtCodProy=',_proy,'"> click Aquí </a>' ),
														aNomEjec,
														_usr,
														4);
		END IF;
	ELSE
	
		UPDATE	t55_inf_unico_anual
		SET		t55_avan_comp = _avance_comp , 
				t55_avan_cap  = _avance_capc , 
				t55_avan_fin  = _avance_fina , 
				t55_mt = _mt_flg,
				t55_mf = _mf_flg,
				usr_actu = _usr , 
				fch_actu = NOW() 
		WHERE	t02_cod_proy = _proy
			AND t55_id = _num ;
			
		SELECT ROW_COUNT(), _num INTO aNumRows, aCodigo ;
	END IF;
	
		
	SELECT aNumRows AS numrows, aCodigo AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_unico_anual_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_unico_anual_cab`(IN _proy VARCHAR(10), 
			IN _anio INT, 
		IN _ini INT , IN _fin INT,	IN _periodo VARCHAR(50), 
			IN _fchpres DATETIME , 
			IN _estado INT,
			IN _usr VARCHAR(20))
BEGIN
UPDATE t55_inf_unico_anual
SET 
   t55_anio=_anio,
		t55_per_ini=_ini, 
	t55_per_fin=_fin,
	t55_periodo=_periodo,
	t55_fch_pre=_fchpres,
	t55_estado=_estado,
	usr_actu=_usr,
	fch_actu=NOW()
  WHERE
	t02_cod_proy=_proy AND t55_anio=_anio;

SELECT ROW_COUNT() AS numrows, _anio AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_unico_anual_coment_avanc_fisico` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_unico_anual_coment_avanc_fisico`(
			IN  _proy VARCHAR(10), 
			IN  _num  INT ,
			IN  _comp INT,
			IN  _act  INT,
			IN  _sub  INT,
			IN  _coment TEXT, 
			IN  _usr VARCHAR(20))
BEGIN
DECLARE _existe INT ; 
SELECT COUNT(1)
INTO _existe 
FROM t55_inf_unico_anual_avance_meta
WHERE t02_cod_proy = _proy
  AND t55_num      = _num 
  AND t08_cod_comp = _comp
  AND t09_cod_act  = _act
  AND t09_cod_sub  = _sub  ;
  
  
IF _existe > 0 THEN 
     UPDATE t55_inf_unico_anual_avance_meta
	SET t55_obs = _coment ,
	    usr_actu   = _usr , 
	    fch_actu   = NOW() 
	WHERE t02_cod_proy = _proy
	  AND t55_num      = _num 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub  ;
ELSE
     
    IF _coment <>'' THEN
     INSERT INTO t55_inf_unico_anual_avance_meta 
	(t02_cod_proy, 
	 t55_num, 
	 t08_cod_comp,
	 t09_cod_act,
	 t09_cod_sub,
	 t55_obs,
	 usr_crea, 
	 fch_crea, 
	 est_audi
	)
	VALUES
	(_proy , 
	 _num, 
	 _comp,
	 _act,
	 _sub,
	 _coment,
	_usr, 
	NOW(), 
	'1'
	);
     END IF ;
     
END IF ;
    
					
SELECT ROW_COUNT() AS numrows, _num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_unico_anual_coment_presup` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_unico_anual_coment_presup`(
			IN  _proy  VARCHAR(10), 
			IN  _num   INT ,
			IN  _comp  INT,
			IN  _act   INT,
			IN  _sub   INT,
			IN  _idFte INT,
			IN  _coment TEXT, 
			IN  _usr VARCHAR(20))
BEGIN
DECLARE _existe INT ; 
SELECT COUNT(1)
INTO _existe 
FROM t55_inf_unico_anual_avance_presup
WHERE t02_cod_proy = _proy
  AND t55_num      = _num 
  AND t08_cod_comp = _comp
  AND t09_cod_act  = _act
  AND t09_cod_sub  = _sub  
  AND t55_fuente   = _idFte ;
  
  
IF _existe > 0 THEN 
     UPDATE t55_inf_unico_anual_avance_presup 
	SET t55_obs = _coment ,
	    usr_actu   = _usr , 
	    fch_actu   = NOW() 
	WHERE t02_cod_proy = _proy
	  AND t55_num      = _num 
	  AND t08_cod_comp = _comp
	  AND t09_cod_act  = _act
	  AND t09_cod_sub  = _sub  
	  AND t55_fuente   = _idFte ;
ELSE
     
    IF _coment <>'' THEN
     INSERT INTO t55_inf_unico_anual_avance_presup 
	(t02_cod_proy, 
	 t55_num, 
	 t08_cod_comp,
	 t09_cod_act,
	 t09_cod_sub,
	 t55_fuente,
	 t55_obs,
	 usr_crea, 
	 fch_crea, 
	 est_audi
	)
	VALUES
	(_proy , 
	 _num, 
	 _comp,
	 _act,
	 _sub,
	 _idFte,
	 _coment,
	_usr, 
	NOW(), 
	'1'
	);
     END IF ;
     
END IF ;
    
					
SELECT ROW_COUNT() AS numrows, _num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_inf_visita_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_inf_visita_mf`(IN _t02_cod_proy VARCHAR(10),
					IN _t52_num INT ,
					IN _t52_tipo_vis INT ,
					IN _t52_per_ini INT  ,
					IN _t52_per_fin INT  ,
					IN _t52_nom_per_ent VARCHAR(50),
					IN _t52_car_per_ent VARCHAR(30),
					IN _t52_quest_01 CHAR(1)  ,
					IN _t52_obs_01 TEXT,
					IN _t52_quest_02 CHAR(1)  ,
					IN _t52_obs_02 TEXT,
					IN _t52_quest_03 CHAR(1)  ,
					IN _t52_obs_03 TEXT,
					IN _t52_quest_04 CHAR(1)  ,
					IN _t52_obs_04 TEXT,
					IN _t52_quest_05 CHAR(1)  ,
					IN _t52_obs_05 TEXT,
					IN _t52_quest_06 CHAR(1)  ,
					IN _t52_obs_06 TEXT,
					IN _t52_quest_07 CHAR(1)  ,
					IN _t52_obs_07 TEXT,
					IN _t52_quest_08 CHAR(1)  ,
					IN _t52_obs_08 TEXT,
					IN _t52_quest_09 CHAR(1)  ,
					IN _t52_obs_09 TEXT,
					IN _t52_quest_10 CHAR(1)  ,
					IN _t52_obs_10 TEXT,
					IN _t52_quest_11 CHAR(1)  ,
					IN _t52_obs_11 TEXT,
					IN _t52_quest_12 CHAR(1)  ,
					IN _t52_obs_12 TEXT,
					IN _t52_quest_13 CHAR(1)  ,
					IN _t52_obs_13 TEXT,
					IN _t52_quest_14 CHAR(1)  ,
					IN _t52_obs_14 TEXT,
					IN _t52_quest_15 CHAR(1)  ,
					IN _t52_obs_15 TEXT,
					IN _t52_quest_16 CHAR(1)  ,
					IN _t52_obs_16 TEXT,
					IN _t52_quest_17 CHAR(1)  ,
					IN _t52_obs_17 TEXT,
					IN _t52_quest_18 CHAR(1)  ,
					IN _t52_obs_18 TEXT,
					IN _t52_quest_19 CHAR(1)  ,
					IN _t52_obs_19 TEXT,
					IN _t52_quest_20 CHAR(1)  ,
					IN _t52_obs_20 TEXT,
					IN _t52_quest_21 CHAR(1)  ,
					IN _t52_obs_21 TEXT,
					IN _t52_quest_22 CHAR(1)  ,
					IN _t52_obs_22 TEXT,
					IN _t52_quest_23 CHAR(1)  ,
					IN _t52_obs_23 TEXT,
					IN _t52_fch_pre DATETIME  ,
					IN _t52_estado INT  ,
					IN _t52_obs TEXT ,
					IN _t52_conclu TEXT ,
					IN _t52_califica INT  ,
					IN _usr CHAR(20),  IN _obs_cmt VARCHAR(200))
BEGIN
DECLARE _periodo VARCHAR(50);
SELECT CONCAT ( (
		    SELECT CONCAT(fn_nom_mes(t40_periodo), ' ' ,YEAR(t40_fch_pre))
		      FROM t40_inf_financ 
		     WHERE t02_cod_proy = _t02_cod_proy
		       AND fn_numero_mes(t40_anio, t40_mes) = _t52_per_ini
		 ),
		 ' - ' ,
		 (
		    SELECT CONCAT(fn_nom_mes(t40_periodo), ' ' ,YEAR(t40_fch_pre))
		      FROM t40_inf_financ 
		     WHERE t02_cod_proy = _t02_cod_proy
		       AND fn_numero_mes(t40_anio, t40_mes) = _t52_per_fin 
		 )
	       )
	INTO _periodo ;
 
 
 
UPDATE  t52_inf_visita_mf 
   SET 	t52_tipo_vis = _t52_tipo_vis,
	t52_per_ini = _t52_per_ini,
	t52_per_fin = _t52_per_fin,
	t52_nom_per_ent = _t52_nom_per_ent,
	t52_car_per_ent = _t52_car_per_ent,
	t52_quest_01 = _t52_quest_01,
	t52_obs_01 = _t52_obs_01,
	t52_quest_02 = _t52_quest_02,
	t52_obs_02 = _t52_obs_02,
	t52_quest_03 = _t52_quest_03,
	t52_obs_03 = _t52_obs_03,
	t52_quest_04 = _t52_quest_04,
	t52_obs_04 = _t52_obs_04,
	t52_quest_05 = _t52_quest_05,
	t52_obs_05 = _t52_obs_05,
	t52_quest_06 = _t52_quest_06,
	t52_obs_06 = _t52_obs_06,
	t52_quest_07 = _t52_quest_07,
	t52_obs_07 = _t52_obs_07,
	t52_quest_08 = _t52_quest_08,
	t52_obs_08 = _t52_obs_08,
	t52_quest_09 = _t52_quest_09,
	t52_obs_09 = _t52_obs_09,
	t52_quest_10 = _t52_quest_10,
	t52_obs_10 = _t52_obs_10,
	t52_quest_11 = _t52_quest_11,
	t52_obs_11 = _t52_obs_11,
	t52_quest_12 = _t52_quest_12,
	t52_obs_12 = _t52_obs_12,
	t52_quest_13 = _t52_quest_13,
	t52_obs_13 = _t52_obs_13,
	t52_quest_14 = _t52_quest_14,
	t52_obs_14 = _t52_obs_14,
	t52_quest_15 = _t52_quest_15,
	t52_obs_15 = _t52_obs_15,
	t52_quest_16 = _t52_quest_16,
	t52_obs_16 = _t52_obs_16,
	t52_quest_17 = _t52_quest_17,
	t52_obs_17 = _t52_obs_17,
	t52_quest_18 = _t52_quest_18,
	t52_obs_18 = _t52_obs_18,
	t52_quest_19 = _t52_quest_19,
	t52_obs_19 = _t52_obs_19,
	t52_quest_20 = _t52_quest_20,
	t52_obs_20 = _t52_obs_20,
	t52_quest_21 = _t52_quest_21,
	t52_obs_21 = _t52_obs_21,
	t52_quest_22 = _t52_quest_22,
	t52_obs_22 = _t52_obs_22,
	t52_quest_23 = _t52_quest_23,
	t52_obs_23 = _t52_obs_23,
	t52_periodo = _periodo ,
	t52_fch_pre = _t52_fch_pre,
	t52_estado = _t52_estado,
	t52_obs = _t52_obs,
	t52_conclu = _t52_conclu,
	t52_califica = _t52_califica,
	usr_actu = _usr,
	fch_actu = now(),
	t52_obs_cmt= _obs_cmt
WHERE t02_cod_proy = _t02_cod_proy
  AND t52_num = _t52_num ;
 
					
SELECT ROW_COUNT() AS numrows, _t52_num AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_institucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_institucion`( 
					IN _t01_id_inst   INT , 
					IN _t01_ruc_inst   VARCHAR(15) , 
					IN _t01_sig_inst   VARCHAR(50) , 
					IN _t01_nom_inst   VARCHAR(200),
					IN _t01_fch_fund   DATE        ,   
					IN _t01_pres_anio  DOUBLE      , 
					IN _t01_dpto       CHAR(2)     , 
					IN _t01_prov       CHAR(2)     ,
					IN _t01_dist       CHAR(2)     ,
					IN _t01_dire_inst  VARCHAR(200), 
					IN _t01_ciud_inst  VARCHAR(50) ,
					IN _t01_fono_inst  VARCHAR(50) , 
					IN _t01_fax_inst   VARCHAR(50) ,
					IN _t01_mail_inst  VARCHAR(50) ,
					IN _t01_web_inst   VARCHAR(50) ,
					IN _t01_ape_rep    VARCHAR(70) ,
					IN _t01_nom_rep    VARCHAR(50) ,
					IN _t01_carg_rep   VARCHAR(50) ,
					IN _t01_tipo_inst  INT(11)  ,
					IN _t01_fono2  VARCHAR(50) , 
					IN _t01_rpm  VARCHAR(15) , 
					IN _t01_rpc  VARCHAR(15) , 
					IN _t01_next  VARCHAR(15) , 
					IN _t01_relfe VARCHAR(100),
					IN _usu  	VARCHAR(20)
				    )
TRANX : BEGIN
  DECLARE _msg   	VARCHAR(150);
  DECLARE _existe 	INT;
  DECLARE _numrows 	INT;
  
  
SELECT COUNT(1)
  INTO _existe
  FROM t01_dir_inst
 WHERE t01_ruc_inst=_t01_ruc_inst AND t01_id_inst <> _t01_id_inst ;
	
  IF _existe > 0 THEN
      
    SELECT CONCAT('Ya existe otra Institucion, con el RUC:',_t01_ruc_inst,'.')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
     
    LEAVE TRANX;    
  END IF ;
  
  IF EXISTS(SELECT t01_sig_inst FROM t01_dir_inst WHERE t01_sig_inst = _t01_sig_inst AND t01_id_inst <> _t01_id_inst) THEN
      
    SELECT CONCAT('La Institucion, ',_t01_sig_inst,', ya fue registrada')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
     
    LEAVE TRANX;    
  END IF ;
 UPDATE t01_dir_inst 
    SET t01_ruc_inst = _t01_ruc_inst, 
	t01_sig_inst = UPPER(_t01_sig_inst), 
	t01_nom_inst = _t01_nom_inst, 
	t01_fch_fund = _t01_fch_fund, 
	t01_pres_anio= _t01_pres_anio, 
	t01_dpto     = _t01_dpto, 
	t01_prov     = _t01_prov, 
	t01_dist     = _t01_dist, 
	t01_dire_inst= _t01_dire_inst, 
	t01_ciud_inst= _t01_ciud_inst, 
	t01_fono_inst= _t01_fono_inst, 
	t01_fax_inst = _t01_fax_inst, 
	t01_mail_inst= _t01_mail_inst, 
	t01_web_inst = _t01_web_inst, 
	t01_ape_rep  = _t01_ape_rep, 
	t01_nom_rep  = _t01_nom_rep, 
	t01_carg_rep = _t01_carg_rep, 
	t01_tipo_inst= _t01_tipo_inst, 
	t01_fono2_inst = _t01_fono2, 
        t01_rpm_inst   = _t01_rpm,
	t01_next_inst  = _t01_next ,
	t01_rpc_inst   = _t01_rpc,
	t01_rel_fe     = _t01_relfe,
	usr_actu = _usu, 
	fch_actu = NOW()
 WHERE t01_id_inst  = _t01_id_inst ;
	
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    
    SELECT _numrows AS numrows, '' AS msg , _t01_id_inst AS codigo ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mensajes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mensajes`(IN _array VARCHAR(100))
BEGIN
UPDATE adm_mensajes 
	SET
	est_men = '1'
	WHERE
	id_men IN (_array);
	SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mensajescp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mensajescp`(IN _array VARCHAR(100))
BEGIN
UPDATE adm_mensajes 
	SET
	est_men = '0'
	WHERE
	id_men IN (_array);
	SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_menu` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_menu`(
            in _cod   varchar(8),
            in _nom   varchar(50) ,
            IN _link  varchar(250), 
            in _isparent char(1),
            in _parent varchar(10),
            IN _targ   VARCHAR(10),
            in _img    varchar(100),
            in _act    char(1),
            in _ord    int,
            in _mod    char(1))
BEGIN
  declare _class varchar(20);
  
   select (case when _isparent='1' then 'MenuBarItemSubmenu' else '' end )
   into  _class;
   
   UPDATE adm_menus 
      SET
    mnu_nomb = _nom , 
    mnu_link = _link, 
    mnu_target = _targ , 
    mnu_parent = _parent , 
    mnu_activo = _act , 
    mnu_class  = _class , 
    mnu_sort   = _ord , 
    mnu_img    = _img , 
    mnu_admin  = _mod
    WHERE mnu_cod  = _cod ;   
     
    SELECT ROW_COUNT() AS numrows, _cod AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_menu_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_menu_perfil`(
			in _prf   int,
			in _menus   text ,
			IN _accesos text ,
			in _usr varchar(20) )
BEGIN
  DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempMenus',_menus,'|');
        CALL sp_strTempTable('TTempAccce',_accesos,'|');
        
	START TRANSACTION ;
        
	DELETE FROM adm_menus_perfil 
	WHERE per_cod = _prf ;
	  
	INSERT INTO adm_menus_perfil 
		(per_cod, 
		mnu_cod, 
		ver, 
		nuevo, 
		editar, 
		eliminar,
		usu_crea,
		fch_crea
		)
	SELECT 	_prf  , 
		m.txt AS codmenu,
		substring(a.txt,1,1) AS ver,
		SUBSTRING(a.txt,3,1) AS nuevo,
		SUBSTRING(a.txt,5,1) AS editar,
		SUBSTRING(a.txt,7,1) AS eliminar,
		_usr,
		NOW()
	FROM TTempMenus m
	INNER JOIN TTempAccce a ON(m.id=a.id)
	WHERE m.txt <> "" ;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	COMMIT ;
	
	DROP TEMPORARY TABLE TTempMenus;
	DROP TEMPORARY TABLE TTempAccce;
	
	SELECT _rowcount AS numrows, _prf AS codigo ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_ml_indicadores_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_ml_indicadores_metas`(IN _proy VARCHAR(10), IN _ver INT, IN _comp INT, IN _activ INT, IN _ind INT, IN _anio int, IN _meses varchar(500), IN _user varchar(20))
BEGIN
		DECLARE	_metatotal DOUBLE;
		declare _rowcount int;
		
		delete from t09_act_ind_mtas 
		WHERE t02_cod_proy = _proy  
		  and t02_version  = _ver   
		  and t08_cod_comp = _comp  
		  and t09_cod_act  = _activ 
		  and t09_cod_act_ind = _ind 
		  and t09_ind_anio = _anio ;
    
        CALL sp_strTempTable('TTempMeses',_meses,'|');
		
		INSERT INTO t09_act_ind_mtas 
				(
				 t02_cod_proy, 
				 t02_version, 
				 t08_cod_comp, 
				 t09_cod_act, 
				 t09_cod_act_ind, 
				 t09_ind_anio, 
				 t09_ind_mes, 
				 t09_ind_mta, 
				 usr_crea, 
				 fch_crea, 
				 usr_actu, 
				 fch_actu, 
				 est_audi
				)
		SELECT 	_proy  , 
				_ver   ,
				_comp  ,
				_activ , 
				_ind   , 
				_anio  ,
				id as mes,
				txt as t09_ind_mta,
				_user,
				NOw(),
				null,
				null,
				'1'
		FROM TTempMeses
		where txt > 0 ;
		
		select ROW_COUNT() into _rowcount;
		
		DROP TEMPORARY TABLE TTempMeses;
		select sum(t09_ind_mta) into _metatotal
		  FROM t09_act_ind_mtas 
		 WHERE t02_cod_proy = _proy  
		   AND t02_version  = _ver   
		   AND t08_cod_comp = _comp  
		   AND t09_cod_act  = _activ 
		   AND t09_cod_act_ind = _ind ;
		   
		if _metatotal > 0 then
			update t09_act_ind 
			set t09_mta = _metatotal
			 WHERE t02_cod_proy = _proy  
			   AND t02_version  = _ver   
			   AND t08_cod_comp = _comp  
			   AND t09_cod_act  = _activ 
			   AND t09_cod_act_ind = _ind ;
		end if;
		
		
		SELECT _rowcount AS numrows, _ind AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_monitor` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_monitor`(_proy VARCHAR(10))
BEGIN
DECLARE _inst INT ;
DECLARE _code INT ;
select p.t02_moni_ext
into _inst
FROM  t02_dg_proy p 
WHERE p.t02_cod_proy = _proy
and p.t02_version=fn_ult_version_proy(_proy);
select SUBSTRING(_inst,INSTR(_inst,'.')+1) INTO _code;
UPDATE t01_dir_inst
		   SET 	t01_rel_fe = 242 
		 WHERE t01_id_inst = _code ;
SELECT ROW_COUNT() AS numrows;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_equipa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_equipa`(IN _proy varchar(10), 
			in _ver  int,
			in _equi int,
			in _nom   varchar(100),
			in _um    varchar(30),
			IN _cu     DOUBLE,
			IN _cant   DOUBLE,
			in _monto  DOUBLE,
			in _met    DOUBLE,
			IN _usr varchar(20), IN _mpar int,  IN _mrep INT)
BEGIN
  UPDATE t03_mp_equi 
     SET
	t03_nom_equi = _nom , 
	t03_um = _um , 
	t03_cu = _cu,
	t03_cant = _cant,
	t03_costo = _monto , 
	t03_costo_tot = (_monto * _met) , 
	usr_actu = _usr,
	t03_mta_proy=_mpar,
	fch_actu = NOW(), 
		t03_mta_repro=_mrep
	WHERE t02_cod_proy = _proy
	  AND t02_version  = _ver
	  AND t03_id_equi  = _equi ;

select ROW_COUNT() as numrows, _equi as codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_equipa_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_equipa_fuentes`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _equi INT, 
					    IN _insts  varchar(500), 
					    IN _montos varchar(500), 
					    IN _user   varchar(20))
BEGIN
declare _rowcount int;
DECLARE _costotot DOUBLE ;
declare _aniopoa  int default fn_anio_x_version_proy(_proy,_ver);
SELECT t03_costo_tot 
  INTO _costotot
  FROM t03_mp_equi
WHERE t02_cod_proy = _proy  
  AND t02_version  = _ver   
  AND t03_id_equi  = _equi ;
delete from t03_mp_equi_ftes 
WHERE t02_cod_proy = _proy  
  and t02_version  = _ver   
  and t03_id_equi  = _equi ;
CALL sp_strTempTable('TTempInst',_insts,'|');
CALL sp_strTempTable('TTempMont',_montos,'|');
        
		
		INSERT INTO t03_mp_equi_ftes 
				(
				t02_cod_proy, 
				t02_version, 
				t03_id_equi, 
				t03_id_inst, 
				t03_monto, 
				t03_porc,
				usr_crea, 
				fch_crea, 
				usr_actu, 
				fch_actu, 
				est_audi
				)
			SELECT 	_proy  , 
				_ver   ,
				_equi   ,
				i.txt as inst,
				m.txt as monto,
				(( m.txt / _costotot )*100),
				_user,
				NOw(),
				null,
				null,
				'1'
		FROM TTempInst i
		inner join TTempMont m on(i.id=m.id)
		where i.txt > 0 and m.txt > 0;
		
		select ROW_COUNT() into _rowcount;
		
		DROP TEMPORARY TABLE TTempInst;
		DROP TEMPORARY TABLE TTempMont;
		
		SELECT _rowcount AS numrows, _equi AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_equipa_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_equipa_metas`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _equi INT, 
					    IN _anio int, 
					    IN _meses varchar(500), 
					    IN _user varchar(20))
BEGIN
		declare _rowcount int;
		
		delete from t03_mp_equi_metas 
		WHERE t02_cod_proy = _proy  
		  and t02_version  = _ver   
		  and t03_id_equi  = _equi  
		  and t03_anio     = _anio ;
    
        CALL sp_strTempTable('TTempMesesEqui',_meses,'|');
		
		INSERT INTO t03_mp_equi_metas 
				(
				 t02_cod_proy, 
				 t02_version, 
				 t03_id_equi, 
				 t03_anio, 
				 t03_mes, 
				 t03_mta, 
				 usr_crea, 
				 fch_crea, 
				 usr_actu, 
				 fch_actu, 
				 est_audi
				)
			SELECT 	_proy  , 
				_ver   ,
				_equi   ,
				_anio  ,
				id as mes,
				txt as meta,
				_user,
				NOw(),
				null,
				null,
				'1'
		FROM TTempMesesEqui
		where txt > 0 ;
		
		select ROW_COUNT() into _rowcount;
		
		DROP TEMPORARY TABLE TTempMesesEqui;
		SELECT _rowcount AS numrows, _equi AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_gasfunc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_gasfunc`(IN _proy varchar(10), 
			in _ver  int,
			in _part_old INT,
			IN _part_new INT,
			in _um   varchar(30),
			in _met  DOUBLE,
			IN _usr varchar(20), IN _mpar INT, IN _mrep int)
BEGIN
 
 declare _existe int;
 
 select count(1) 
   into _existe
 from t03_mp_gas_fun_part 
 where t02_cod_proy= _proy
   and t02_version = _ver
   and t03_partida = _part_new
   and t03_partida <> _part_old ;
 
  
  if _existe > 0 then
	SELECT 0 AS numrows, 
	       _part_new AS codigo, 
	       'La Partida ya ha sido registrada, en este Proyecto' AS error;
  else
	update t03_mp_gas_fun_part 
	set t03_partida = _part_new,
	    t03_um   = _um,
	    t03_meta = _met ,
	    usr_actu = _usr, 
	    fch_actu = now(),
			t03_mta_proy=_mpar,
			t03_mta_repro=_mrep
	 where t02_cod_proy = _proy
	   and t02_version  = _ver
	   and t03_partida  = _part_old ;
	   
	
	select ROW_COUNT() as numrows, _part_new as codigo, '' as error;
  end if;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_gasfunc_costeo` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_gasfunc_costeo`(
			IN _proy varchar(10), 
			in _ver  int,
			in _part INT,
			in _idgasto int,
			in _gasto varchar(100),
			in _um   varchar(30),
			in _cant DOUBLE,
			in _pu   double,
			in _cate int,
			IN _usr varchar(20))
BEGIN
 
  update t03_mp_gas_fun_cost 
     set t03_descrip = _gasto, 
	 t03_um      = _um, 
	 t03_cu      = _pu , 
	 t03_cant    = _cant, 
	 t03_cat_gast= _cate, 
	 usr_actu    = _usr, 
	 fch_actu    = NOW()
   where t02_cod_proy = _proy
     and t02_version  = _ver
     and t03_partida  = _part
     and t03_id_gasto = _idgasto ; 
	
	select ROW_COUNT() as numrows, _part as partida, _idgasto AS codigo, '' as error;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_gasfunc_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_gasfunc_fuentes`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _part INT, 
					    IN _gasto INT,
					    IN _insts  VARCHAR(500), 
					    IN _montos VARCHAR(500), 
					    IN _user   VARCHAR(20))
BEGIN
	DECLARE _rowcount INT;
	declare _costotot DOUBLE;
	declare _meta     int ;
	
	SELECT sum(t03_mta)
	  INTO _meta
	  FROM t03_mp_gas_fun_metas
	 WHERE t02_cod_proy = _proy
	   AND t02_version  = _ver
	   AND t03_partida  = _part;
	   
	 SELECT (t03_cu * t03_cant) * _meta
	  INTO _costotot
	  FROM t03_mp_gas_fun_cost
	 WHERE t02_cod_proy = _proy
	   AND t02_version  = _ver
	   AND t03_partida  = _part
	   AND t03_id_gasto = _gasto ;
	
	DELETE FROM t03_mp_gas_fun_ftes 
	WHERE t02_cod_proy = _proy  
	  AND t02_version  = _ver
	  AND t03_partida  = _part  
	  AND t03_id_gasto  = _gasto ;
    
        CALL sp_strTempTable('TTempInst',_insts,'|');
        CALL sp_strTempTable('TTempMont',_montos,'|');
        
		
		INSERT INTO t03_mp_gas_fun_ftes 
				(
				t02_cod_proy, 
				t02_version, 
				t03_partida, 
				t03_id_gasto,
				t03_id_inst, 
				t03_monto, 
				t03_porc,
				usr_crea, 
				fch_crea, 
				usr_actu, 
				fch_actu, 
				est_audi
				)
			SELECT 	_proy  , 
				_ver   ,
				_part  ,
				_gasto ,
				i.txt AS inst,
				m.txt AS monto,
				(( m.txt / _costotot )*100),
				_user,
				NOW(),
				NULL,
				NULL,
				'1'
		FROM TTempInst i
		INNER JOIN TTempMont m ON(i.id=m.id)
		WHERE i.txt > 0 AND m.txt > 0;
		
		SELECT ROW_COUNT() INTO _rowcount;
		
		DROP TEMPORARY TABLE TTempInst;
		DROP TEMPORARY TABLE TTempMont;
		
		SELECT _rowcount AS numrows, _gasto AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_gasfunc_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_gasfunc_metas`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _part INT, 
					    IN _anio int, 
					    IN _meses varchar(500), 
					    IN _user varchar(20))
BEGIN
		declare _rowcount int;
		
		delete from t03_mp_gas_fun_metas 
		WHERE t02_cod_proy = _proy  
		  and t02_version  = _ver   
		  and t03_partida  = _part  
		  and t03_anio     = _anio ;
    
        CALL sp_strTempTable('TTempMesesPartidas',_meses,'|');
		
		INSERT INTO t03_mp_gas_fun_metas 
				(
				 t02_cod_proy, 
				 t02_version, 
				 t03_partida, 
				 t03_anio, 
				 t03_mes, 
				 t03_mta, 
				 usr_crea, 
				 fch_crea, 
				 usr_actu, 
				 fch_actu, 
				 est_audi
				)
			SELECT 	_proy  , 
				_ver   ,
				_part   ,
				_anio  ,
				id as mes,
				txt as meta,
				_user,
				NOw(),
				null,
				null,
				'1'
		FROM TTempMesesPartidas
		where txt > 0 ;
		
		select ROW_COUNT() into _rowcount;
		
		DROP TEMPORARY TABLE TTempMesesPartidas;
		SELECT _rowcount AS numrows, _part AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_gastos_adm` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_gastos_adm`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _insts  VARCHAR(500), 
					    IN _montos VARCHAR(500), 
					    IN _user   VARCHAR(20))
BEGIN
	DECLARE _rowcount INT;
	
	DELETE FROM t03_mp_gas_adm
	WHERE t02_cod_proy = _proy  
	  AND t02_version  = _ver;
    
        CALL sp_strTempTable('TTempInstAdm',_insts,'|');
        CALL sp_strTempTable('TTempMontAdm',_montos,'|');
		
	INSERT INTO t03_mp_gas_adm
			(
			t02_cod_proy, 
			t02_version, 
			t03_id_inst, 
			t03_monto, 
			usr_crea, 
			fch_crea, 
			usr_actu, 
			fch_actu, 
			est_audi
			)
		SELECT 	_proy  , 
			_ver   ,
			i.txt AS inst,
			m.txt AS monto,
			_user,
			NOW(),
			NULL,
			NULL,
			'1'
	FROM TTempInstAdm i
	INNER JOIN TTempMontAdm m ON(i.id=m.id)
	WHERE i.txt > 0 AND m.txt > 0;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	DROP TEMPORARY TABLE TTempInstAdm;
	DROP TEMPORARY TABLE TTempMontAdm;
	
	SELECT _rowcount AS numrows, _proy AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_linea_base_imprevistos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_mp_linea_base_imprevistos`(  
                        IN _proy VARCHAR(10), 
                        IN _ver INT, 
                        IN _mto_lb DOUBLE, 
                        IN _mto_imp DOUBLE,
                        IN _mto_sup DOUBLE,
                        IN _usr   VARCHAR(20))
BEGIN
 declare _idFE int;
 declare _rows int ;
 select 10 into _idFE;  
 
    REPLACE INTO t03_mp_linea_base ( t02_cod_proy, 
                                    t02_version, 
                                    t03_id_inst, 
                                    t03_monto, 
                                    usr_crea, 
                                    fch_crea, 
                                    usr_actu, 
                                    fch_actu, 
                                    est_audi) 
                            VALUES ( _proy ,
                                    _ver, 
                                    _idFE, 
                                    _mto_lb, 
                                    _usr, 
                                    now(), 
                                    _usr, 
                                    now(), 
                                    '1'
                                    );
                                    
    CALL sp_linea_base_recalcular(_proy, _ver, _idFE, _usr);
                                    
    REPLACE INTO t03_mp_imprevistos (t02_cod_proy, 
                                    t02_version, 
                                    t03_id_inst, 
                                    t03_monto, 
                                    usr_crea, 
                                    fch_crea, 
                                    usr_actu, 
                                    fch_actu, 
                                    est_audi) 
                            VALUES ( _proy ,
                                    _ver, 
                                    _idFE, 
                                    _mto_imp, 
                                    _usr, 
                                    NOW(), 
                                    _usr, 
                                    NOW(), 
                                    '1'
                                    );
    REPLACE INTO t03_mp_gas_supervision (t02_cod_proy, 
                                    t02_version, 
                                    t03_id_inst, 
                                    t03_monto, 
                                    usr_crea, 
                                    fch_crea, 
                                    usr_actu, 
                                    fch_actu, 
                                    est_audi) 
                            VALUES( _proy ,
                                    _ver, 
                                    _idFE, 
                                    _mto_sup, 
                                    _usr, 
                                    NOW(), 
                                    _usr, 
                                    NOW(), 
                                    '1'
                                    );
                                    
    select ROW_COUNT() into _rows ;
    
    call sp_upd_proyecto_costos(_proy, _ver);
                                
    SELECT _rows AS numrows, _proy AS codigo ;
         
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_personal` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_personal`(IN _proy varchar(10), 
			in _ver  int,
			in _idper   INT ,
			in _nom  varchar(50),
			in _tdr  text,
			in _um   int,
			in _dedica double,
			in _remu   DOUBLE,
			in _perma  double,
			in _met    int,
			IN _usr varchar(20), IN  _mpar INT, IN _mrepro INT)
BEGIN
  UPDATE t03_mp_per 
	SET
	t03_nom_per  = _nom , 
	t03_tdr      = _tdr , 
	t03_um 	     = _um , 
	t03_dedica   = _dedica , 
	t03_remu     = _remu , 
	t03_perma    = _perma , 
	t03_remu_prom = fn_remun_prom_mes(_remu, _dedica, _um) , 
	t03_gasto_tot = ( fn_remun_prom_mes(_remu, _dedica, _um) * _met) , 
	usr_actu = _usr , 
	fch_actu = NOW(),
  t03_mta_proy = _mpar,
	t03_mta_repro=_mrepro
	WHERE t02_cod_proy = _proy  
	  AND t02_version  = _ver  
	  AND t03_id_per   = _idper ;

select ROW_COUNT() as numrows, _idper as codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_personal_fuentes` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_personal_fuentes`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _per INT, 
					    IN _insts  varchar(500), 
					    IN _montos varchar(500), 
					    IN _user   varchar(20))
BEGIN
declare _rowcount int;
declare _costotot double ;
SELECT t03_gasto_tot
  INTO _costotot
  FROM t03_mp_per
WHERE t02_cod_proy = _proy  
  AND t02_version  = _ver   
  AND t03_id_per   = _per ;
delete from t03_mp_per_ftes 
WHERE t02_cod_proy = _proy  
  and t02_version  = _ver   
  and t03_id_per   = _per ;
CALL sp_strTempTable('TTempInst',_insts,'|');
CALL sp_strTempTable('TTempMont',_montos,'|');
        
		
		INSERT INTO t03_mp_per_ftes 
				(
				t02_cod_proy, 
				t02_version, 
				t03_id_per, 
				t03_id_inst, 
				t03_monto, 
				t03_porc,
				usr_crea, 
				fch_crea, 
				usr_actu, 
				fch_actu, 
				est_audi
				)
			SELECT 	_proy  , 
				_ver   ,
				_per   ,
				i.txt as inst,
				m.txt as monto,
				(( m.txt / _costotot )*100),
				_user,
				NOw(),
				null,
				null,
				'1'
		FROM TTempInst i
		inner join TTempMont m on(i.id=m.id)
		where i.txt > 0 and m.txt > 0;
		
		select ROW_COUNT() into _rowcount;
		
		DROP TEMPORARY TABLE TTempInst;
		DROP TEMPORARY TABLE TTempMont;
		
		SELECT _rowcount AS numrows, _per AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_personal_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_personal_metas`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _per INT, 
					    IN _anio int, 
					    IN _meses varchar(500), 
					    IN _user varchar(20))
BEGIN
		declare _rowcount int;
		
		delete from t03_mp_per_metas 
		WHERE t02_cod_proy = _proy  
		  and t02_version  = _ver   
		  and t03_id_per   = _per  
		  and t03_anio     = _anio ;
    
        CALL sp_strTempTable('TTempMesesPer',_meses,'|');
		
		INSERT INTO t03_mp_per_metas 
				(
				 t02_cod_proy, 
				 t02_version, 
				 t03_id_per, 
				 t03_anio, 
				 t03_mes, 
				 t03_mta, 
				 usr_crea, 
				 fch_crea, 
				 usr_actu, 
				 fch_actu, 
				 est_audi
				)
			SELECT 	_proy  , 
				_ver   ,
				_per   ,
				_anio  ,
				txt as mes,
				1 as meta,
				_user,
				NOw(),
				null,
				null,
				'1'
		FROM TTempMesesPer
		where txt > 0 ;
		
		select ROW_COUNT() into _rowcount;
		
		DROP TEMPORARY TABLE TTempMesesPer;
		SELECT _rowcount AS numrows, _per AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_personal_TDR` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_personal_TDR`(
			IN _proy varchar(10), 
			in _ver  int,
			in _idper   INT ,
			in _url  varchar(100),
			IN _usr varchar(20))
BEGIN
  UPDATE t03_mp_per 
	SET
	t03_tdr_file = _url,
	usr_actu = _usr , 
	fch_actu = NOW()  
	WHERE t02_cod_proy = _proy  
	  AND t02_version  = _ver  
	  AND t03_id_per   = _idper ;

select ROW_COUNT() as numrows, _idper as codigo;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_mp_total_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_mp_total_metas`(  IN _proy VARCHAR(10), 
					   IN _ver    INT, 
					   IN _act  INT, 
					   IN _subact INT,
					   IN _anio   INT
					)
BEGIN
	DECLARE	_metatotal DOUBLE;
	DECLARE _verif_anio INT ;
	
	SELECT fn_verificar_anio(_proy, _ver) INTO _verif_anio ;
	
	if _act = 1 then 
	
		SELECT SUM((CASE WHEN _verif_anio < 0 THEN t03_mta ELSE (CASE WHEN t03_anio=_verif_anio THEN t03_mta ELSE 0 END) END)) 
		  INTO _metatotal
		  FROM t03_mp_per_metas 
		 WHERE t02_cod_proy = _proy  
		   AND t02_version  = _ver   
		   AND t03_id_per  = _subact ;
		   
		UPDATE t03_mp_per 
		   SET t03_gasto_tot = (_metatotal * t03_remu_prom)
		 WHERE t02_cod_proy = _proy  
		   AND t02_version  = _ver   
		   AND t03_id_per  = _subact ;
	
	end if ;
	
	IF _act = 2 THEN 
	
		SELECT SUM((CASE WHEN _verif_anio < 0 THEN t03_mta ELSE (CASE WHEN t03_anio=_verif_anio THEN t03_mta ELSE 0 END) END)) 
		  INTO _metatotal
		  FROM t03_mp_equi_metas 
		 WHERE t02_cod_proy = _proy  
		   AND t02_version  = _ver   
		   AND t03_id_equi  = _subact ;
		   
		UPDATE t03_mp_equi 
		   SET t03_costo_tot = (_metatotal * t03_costo)
		 WHERE t02_cod_proy = _proy  
		   AND t02_version  = _ver   
		   AND t03_id_equi  = _subact ;
	
	END IF ;
	
	IF _act = 3 THEN 
	
		SELECT SUM((CASE WHEN _verif_anio < 0 THEN t03_mta ELSE (CASE WHEN t03_anio=_verif_anio THEN t03_mta ELSE 0 END) END)) 
		  INTO _metatotal
		  FROM t03_mp_gas_fun_metas 
		 WHERE t02_cod_proy = _proy  
		   AND t02_version  = _ver   
		   AND t03_partida  = _subact ;
		   
		UPDATE t03_mp_gas_fun_part 
		   set t03_meta = _metatotal
		 WHERE t02_cod_proy = _proy  
		   AND t02_version  = _ver   
		   AND t03_partida  = _subact ;
	
	END IF ;	
	
 	SELECT ROW_COUNT() AS numrows, _verif_anio AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_noobjecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_noobjecioncompra`(IN _t02_cod_proy	VARCHAR(10) , 
			IN _t02_id_noc 	INT ,
			IN _t02_sco_noc		VARCHAR(10) , 
			IN _com			INT,
			IN _act			INT,
			IN _sub			INT,
			IN _t02_par_noc		INT,
			IN _t02_spa_noc		DOUBLE,  
			IN _t02_imp_noc		DOUBLE,  
			IN _t02_ccp_noc		CHAR(1), 
			IN _t02_cop_noc		CHAR(1), 
			IN _t02_amt_noc		CHAR(1), 
			IN _t02_amf_noc		CHAR(1), 			
			IN _t02_cmf_noc		CHAR(1),
			IN _t02_cmt_noc		CHAR(1), 
			IN _t02_pro_noc		CHAR(1), 
			IN _t02_obs_noc		TEXT,			
			IN _usr 		VARCHAR(20))
transX : BEGIN
  DECLARE _msg  VARCHAR(100);
	DECLARE _state INT;
    
  IF EXISTS(SELECT t02_sco_noc FROM t02_noobjecion_compra WHERE t02_cod_proy = _t02_cod_proy AND t02_sco_noc = _t02_sco_noc AND t02_id_noc <>_t02_id_noc)  THEN
    SELECT CONCAT('La No Objeción de Compra: ',_t02_sco_noc, ' ya fue registrada ')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    LEAVE transX ;  
  END IF ;
IF _t02_amf_noc = 'S' THEN
SET _state=266;
END IF;
IF _t02_amf_noc = 'N' THEN
SET _state=270;
END IF;
IF _t02_amt_noc = 'S' THEN
SET _state=267;
END IF;
IF _t02_amt_noc = 'N' THEN
SET _state=267;
END IF;
IF _t02_cmf_noc = 'S' THEN
SET _state=269;
END IF;
IF _t02_cmt_noc = 'S' THEN
SET _state=268;   
END IF;
IF _t02_cmt_noc = 'N' THEN
SET _state=268;  
END IF; 
 UPDATE t02_noobjecion_compra 
	SET
	t02_cod_proy = _t02_cod_proy , 
	t02_id_noc = _t02_id_noc , 
	t02_sco_noc = _t02_sco_noc , 
	t02_com_noc = _com , 
	t02_act_noc = _act , 
	t02_sub_noc = _sub , 
	t02_par_noc = _t02_par_noc , 
	t02_spa_noc = _t02_spa_noc , 
	t02_imp_noc = _t02_imp_noc , 
	t02_ccp_noc = _t02_ccp_noc , 
	t02_cop_noc = _t02_cop_noc , 
	t02_amt_noc = _t02_amt_noc , 
	t02_amf_noc = _t02_amf_noc , 
	t02_cmf_noc = _t02_cmf_noc , 
	t02_cmt_noc = _t02_cmt_noc , 
	t02_pro_noc = _t02_pro_noc , 
	t02_obs_noc = _t02_obs_noc , 
	usu_actu = _usr , 
	fch_actu = NOW() ,
	t02_fch_apr= NOW() ,
	est_audi = '1',
	t02_estado= _state
		
	WHERE
	t02_cod_proy = _t02_cod_proy AND t02_id_noc = _t02_id_noc ;
	
  SELECT ROW_COUNT() AS numrows, _t02_id_noc AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_objecioncompra` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_objecioncompra`(
			IN _t02_cod_proy 	VARCHAR(10) , 
			IN _t02_id_noc 	INT ,			
			IN _t02_sco_co	VARCHAR(10) , 
			IN _t02_par_co	DOUBLE, 
			IN _t02_spa_co	DOUBLE,  
			IN _t02_imp_co	DOUBLE,  
			IN _t02_ccp_co	CHAR(1), 
			IN _t02_cop_co	CHAR(1), 
			IN _t02_amt_co	CHAR(1), 
			IN _t02_amf_co	CHAR(1), 
			IN _t02_rmf_co	CHAR(1), 
			IN _t02_rep_co	CHAR(1), 
			IN _t02_obs_co	TEXT,
			IN _usr VARCHAR(20)
			)
transX : BEGIN
  DECLARE _msg  VARCHAR(100);
    
  IF EXISTS(SELECT t02_sco_co FROM t02_objecion_compra WHERE t02_cod_proy = _t02_cod_proy AND t02_sco_co = _t02_sco_co AND t02_id_noc <>_t02_id_noc)  THEN
    SELECT CONCAT('La Objeción de Compra: ',_t02_sco_co, ' ya fue registrada ')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    LEAVE transX ;  
  END IF ;
    
 UPDATE t02_objecion_compra 
	SET
	t02_sco_co = _t02_sco_co , 
	t02_par_co = _t02_par_co , 
	t02_spa_co = _t02_spa_co , 
	t02_imp_co = _t02_imp_co , 
	t02_ccp_co = _t02_ccp_co , 
	t02_cop_co = _t02_cop_co , 
	t02_amt_co = _t02_amt_co , 
	t02_amf_co = _t02_amf_co , 
	t02_rmf_co = _t02_rmf_co , 
	t02_rep_co = _t02_rep_co , 
	t02_obs_co = _t02_obs_co , 
	usu_actu = _usr , 
	fch_actu = NOW() , 
	est_audi = '1'
	
	WHERE
	t02_cod_proy = _t02_cod_proy AND t02_id_noc = _t02_id_noc ;
	
  SELECT ROW_COUNT() AS numrows, _t02_id_noc AS codigo, '' AS msg ;
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_perfil` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_perfil`(
			IN _id    int , 
			IN _nom   VARCHAR(50), 
			IN _abre  VARCHAR(15),
			IN _usr   VARCHAR(20))
BEGIN
	UPDATE adm_perfiles 
	SET per_des   = _nom , 
	    per_abrev = _abre , 
	    usr_actu  = _usr , 
	    fch_actu  = NOW()
	WHERE per_cod = _id ;
     
  SELECT ROW_COUNT() AS numrows, _id AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_at` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_at`(
			IN _proy varchar(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			in _modu int,
			IN _ntemas DOUBLE,
			IN _nhoras DOUBLE,
			IN _nbenef DOUBLE,
			IN _cont text, 
			IN _usr varchar(20))
BEGIN
declare _existe int ;
select count(1) into _existe
  from t12_plan_at 
 where t02_cod_proy = _proy 
   and	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub  ;
  
if _existe > 0 then 
     UPDATE t12_plan_at 
	SET	t12_nro_tema = _ntemas,
		t12_hor_cap  = _nhoras,
		t12_nro_ben  = _nbenef,
		t12_conten = _cont , 
		t12_modulo = _modu , 
		usr_actu   = _usr , 
		fch_actu   = now()
	 WHERE t02_cod_proy = _proy 
	   AND	t02_version = _ver 
	   AND	t08_cod_comp= _comp
	   AND	t09_cod_act = _act 
	   AND	t09_cod_sub = _sub  ;
	
else
    INSERT INTO t12_plan_at 
	(t02_cod_proy, 
	 t02_version, 
	 t08_cod_comp, 
	 t09_cod_act, 
	 t09_cod_sub, 
	 t12_nro_tema, 
	 t12_hor_cap ,
	 t12_nro_ben ,
	 t12_conten, 
	 t12_modulo, 
	 fch_crea, 
	 usr_crea, 
	 est_audi
	)
	VALUES
	(_proy, 
	 _ver, 
	 _comp, 
	 _act, 
	 _sub, 
	 _ntemas,
	 _nhoras,
	 _nbenef,
	 _cont , 
	 _modu , 
	 now(), 
	 _usr, 
	 '1'
	);
	
end if ;
	
select ROW_COUNT() as numrows, _sub as codigo ;  
				
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_capac` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_capac`(IN _proy varchar(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			in _modu int,
			IN _cont text, 
			IN _usr varchar(20),  IN _horas_total DOUBLE,  IN _benef_total DOUBLE)
BEGIN
declare _existe int ;
select count(1) into _existe
  from t12_plan_capac 
 where t02_cod_proy = _proy 
   and	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub  ;
  
if _existe > 0 then 
     UPDATE t12_plan_capac 
	SET	t12_conten = _cont , 
		t12_modulo = _modu , 
		usr_actu   = _usr ,
		t12_hor_cap=_horas_total,
		t12_nro_ben=_benef_total,
		fch_actu   = now()
	 WHERE t02_cod_proy = _proy 
	   AND	t02_version = _ver 
	   AND	t08_cod_comp= _comp
	   AND	t09_cod_act = _act 
	   AND	t09_cod_sub = _sub  ;
	
else
    INSERT INTO t12_plan_capac 
	(t02_cod_proy, 
	t02_version, 
	t08_cod_comp, 
	t09_cod_act, 
	t09_cod_sub, 
	t12_conten, 
	t12_modulo,
	t12_hor_cap,
	t12_nro_ben,
	fch_crea, 
	usr_crea, 
	est_audi
	)
	VALUES
	(_proy, 
	 _ver, 
	 _comp, 
	 _act, 
	 _sub, 
	 _cont, 
	 _modu ,
	_horas_total,
	_benef_total,
	now(), 
	_usr, 
	'1'
	);
	
end if ;
select ROW_COUNT() as numrows, _sub as codigo ;  					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_capac_tema` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_capac_tema`(IN _proy VARCHAR(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			in _idtema int,
			IN _nomtema varchar(250),
			in _horas   double,
			IN _benef   DOUBLE,			
			IN _usr VARCHAR(20), IN _horas_total double, IN _benef_total double)
BEGIN
DECLARE _rowcount INT ;
declare _nrotemas double ;
DECLARE _nrohoras DOUBLE ;
DECLARE _nrobenef DOUBLE ;
UPDATE t12_plan_capac_tema 
   SET	t12_tem_espe = _nomtema , 
	t12_nro_hora = _horas , 
	t12_nro_bene = _benef ,
	usr_actu   = _usr , 
	fch_actu   = NOW()
 WHERE t02_cod_proy = _proy 
   AND	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub  
   and  t12_cod_tema=_idtema;
   
   select ROW_COUNT() into _rowcount ;
   
   select count(t12_cod_tema),  sum(t12_nro_hora), sum(t12_nro_bene)
     into  _nrotemas, _nrohoras, _nrobenef 
     from t12_plan_capac_tema   
    WHERE t02_cod_proy = _proy 
      AND t02_version = _ver 
      AND t08_cod_comp= _comp
      AND t09_cod_act = _act 
      AND t09_cod_sub = _sub ;
    UPDATE t12_plan_capac 
	SET t12_nro_tema = _nrotemas , 
	    t12_hor_cap  = _nrohoras , 
	    t12_nro_ben  = _nrobenef ,
	    usr_actu     = _usr , 
	    fch_actu     = NOW()
	 WHERE t02_cod_proy = _proy 
	   AND	t02_version = _ver 
	   AND	t08_cod_comp= _comp
	   AND	t09_cod_act = _act 
	   AND	t09_cod_sub = _sub  ;

SELECT _rowcount AS numrows, _sub AS codigo ;  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_cred` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_cred`(
			IN _proy varchar(10), 
			IN _ver INT, 
			IN _comp INT, 
			IN _act INT, 
			IN _sub INT, 
			IN _nbenef  DOUBLE,
			IN _monto   DOUBLE,
			IN _ncuotas DOUBLE,
			in _obs text,
			IN _usr varchar(20))
BEGIN
declare _existe int ;
select count(1) into _existe
  from t12_plan_cred 
 where t02_cod_proy = _proy 
   and	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub  ;
  
if _existe > 0 then 
     UPDATE t12_plan_cred 
	SET	t12_nro_ben  = _nbenef,
		t12_mto_ben  = _monto,
		t12_nro_cuo  = _ncuotas,
		t12_obs      = _obs , 
		usr_actu     = _usr , 
		fch_actu     = now()
	 WHERE t02_cod_proy = _proy 
	   AND	t02_version = _ver 
	   AND	t08_cod_comp= _comp
	   AND	t09_cod_act = _act 
	   AND	t09_cod_sub = _sub  ;
	
else
    INSERT INTO t12_plan_cred 
	(t02_cod_proy, 
	 t02_version, 
	 t08_cod_comp, 
	 t09_cod_act, 
	 t09_cod_sub, 
	 t12_nro_ben, 
	 t12_mto_ben ,
	 t12_nro_cuo ,
	 t12_obs, 
	 fch_crea, 
	 usr_crea, 
	 est_audi
	)
	VALUES
	(_proy, 
	 _ver, 
	 _comp, 
	 _act, 
	 _sub, 
	 _nbenef,
	 _monto,
	 _ncuotas,
	 _obs , 
	 now(), 
	 _usr, 
	 '1'
	);
	
end if ;
	
select ROW_COUNT() as numrows, _sub as codigo ;  
				
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_cred_benef` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_cred_benef`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _comp INT,
					    IN _act  INT,
					    IN _sub  INT,
					    IN _beneficiarios  TEXT, 
					    IN _user   VARCHAR(20))
TRANX : BEGIN
	DECLARE _rowcount INT;
	
	if (select count(1) from t12_plan_cred where t02_cod_proy=_proy and t02_version=_ver and t08_cod_comp=_comp and t09_cod_act=_act and t09_cod_sub=_sub ) <=0  then
	   SELECT 0 AS numrows, 0 AS codigo, 'No se ha grabado el numero de Beneficiarios del Plan de Creditos' AS msg ;
	   leave TRANX ;
	end if ;
      
    
    
        CALL sp_strTempTable('TTempBenef2',_beneficiarios,'|');
        
	START TRANSACTION ;
        
	INSERT INTO t12_plan_cred_benef 
		(t02_cod_proy,
		t02_version, 
		t08_cod_comp, 
		t09_cod_act, 
		t09_cod_sub, 
		t11_cod_benef, 
		fch_crea, 
		usr_crea, 
		est_audi
		)
	SELECT 	_proy  , 
		_ver,
		_comp  ,
		_act   ,
		_sub   ,
		b.txt AS benef,
		NOW(),
		_user,
		'1'
	FROM TTempBenef2 b
	WHERE b.txt <> "" 
	  and b.txt not in( select bf.t11_cod_benef 
				from t12_plan_cred_benef bf 
				where bf.t02_cod_proy = _proy
				  and bf.t02_version  = _ver
				  and bf.t08_cod_comp = _comp
				  and bf.t09_cod_act  = _act
				  and bf.t09_cod_sub  = _sub) ;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	COMMIT ;
	
	DROP TEMPORARY TABLE TTempBenef2;
	
	if _rowcount <=0 then
		SELECT _rowcount AS numrows, _sub AS codigo, 'Los Beneficiarios seleccionados ya fueron registrados anteriormente' as msg ;
	else
		SELECT _rowcount AS numrows, _sub AS codigo, '' AS msg ;
	end if ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_cred_benef_montos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_cred_benef_montos`(  
					    IN _proy VARCHAR(10), 
					    IN _ver INT, 
					    IN _comp INT,
					    IN _act  INT,
					    IN _sub  INT,
					    IN _beneficiarios  TEXT, 
					    IN _montos  TEXT, 
					    IN _cuotas  TEXT, 
					    IN _tasas  TEXT, 
					    IN _user   VARCHAR(20))
BEGIN
	DECLARE _rowcount INT;
    
        CALL sp_strTempTable('TTempBen',_beneficiarios,'|');
        CALL sp_strTempTable('TTempMto',_montos,'|');
        CALL sp_strTempTable('TTempCuo',_cuotas,'|');
        CALL sp_strTempTable('TTempTas',_tasas,'|');
        
	START TRANSACTION ;
      
	UPDATE t12_plan_cred_benef ben,
		(
		SELECT 	_proy  , 
			_ver   ,
			_comp  ,
			_act   ,
			_sub   ,
			b.txt AS benef,
			m.txt as monto,
			c.txt as cuotas,
			t.txt as tasa,
			NOW() as fecha,
			_user as usuario,
			'1'   as estado
		FROM 	   TTempBen b
		inner join TTempMto m on(m.id = b.id)
		inner join TTempCuo c ON(c.id = b.id)
		inner join TTempTas t ON(t.id = b.id)
		WHERE b.txt <> "" ) a
	SET
		ben.t12_mto_ben = a.monto , 
		ben.t12_nro_cuo = a.cuotas,
		ben.t12_tasa_int = a.tasa , 
		ben.usr_actu = a.usuario , 
		ben.fch_actu = a.fecha 
	where 	ben.t02_cod_proy = a._proy  
	  and	ben.t02_version  = a._ver  
	  and	ben.t08_cod_comp = a._comp 
	  and	ben.t09_cod_act  = a._act  
	  and	ben.t09_cod_sub  = a._sub 
	  and	ben.t11_cod_benef = a.benef ;
	
	SELECT ROW_COUNT() INTO _rowcount;
	
	COMMIT ;
	
	DROP TEMPORARY TABLE TTempBen;
	DROP TEMPORARY TABLE TTempMto;
	DROP TEMPORARY TABLE TTempCuo;
	DROP TEMPORARY TABLE TTempTas;
	SELECT _rowcount AS numrows, _sub AS codigo, '' as msg ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_otros` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_otros`(
			IN _proy   varchar(10), 
			IN _ver    INT, 
			IN _comp   INT, 
			IN _act    INT, 
			IN _sub    INT, 
			IN _nombre VARCHAR(30),
			in _tipo   int,
			IN _nent   DOUBLE,
			IN _nbenef DOUBLE,
			IN _ntot   DOUBLE,
			IN _cont   text, 
			IN _usr    varchar(20))
BEGIN
declare _existe int ;
select count(1) into _existe
  from t12_plan_otros 
 where t02_cod_proy = _proy 
   and	t02_version = _ver 
   AND	t08_cod_comp= _comp
   AND	t09_cod_act = _act 
   AND	t09_cod_sub = _sub  ;
  
if _existe > 0 then 
     UPDATE t12_plan_otros 
	SET	t12_producto = _nombre,
		t12_nro_ent  = _nent,
		t12_nro_ben  = _nbenef,
		t12_tot_ent  = _ntot,
		t12_conten = _cont , 
		t12_tipo   = _tipo , 
		usr_actu   = _usr , 
		fch_actu   = now()
	 WHERE t02_cod_proy = _proy 
	   AND	t02_version = _ver 
	   AND	t08_cod_comp= _comp
	   AND	t09_cod_act = _act 
	   AND	t09_cod_sub = _sub  ;
	
else
    INSERT INTO t12_plan_otros 
	(t02_cod_proy, 
	 t02_version, 
	 t08_cod_comp, 
	 t09_cod_act, 
	 t09_cod_sub, 
	 t12_producto,
	 t12_nro_ent, 
	 t12_nro_ben ,
	 t12_tot_ent,
	 t12_conten, 
	 t12_tipo, 
	 fch_crea, 
	 usr_crea, 
	 est_audi
	)
	VALUES
	(_proy, 
	 _ver, 
	 _comp, 
	 _act, 
	 _sub, 
	 _nombre,
	 _nent,
	 _nbenef,
	 _ntot,
	 _cont , 
	 _tipo , 
	 now(), 
	 _usr, 
	 '1'
	);
	
end if ;
	
select ROW_COUNT() as numrows, _sub as codigo ;  
				
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_visita_cab` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_visita_cab`(
			IN _proy VARCHAR(10), 
			IN _idvta  INT,
			IN _fch DATETIME ,
			IN _ter DATETIME , 
			IN _obj text, 
			IN _per text, 
			IN _rec text, 
			IN _usr VARCHAR(20))
BEGIN
  UPDATE t32_plan_vta 
   
  SET t32_fch_vta = _fch, 
	 t32_fch_ter = _ter,
	 t32_obj_vta = _obj, 
	 t32_per_ent = _per, 
	 t32_rec_nec = _rec, 
	 usr_actu    = 
_usr,
	 fch_actu    = NOW()
   WHERE t02_cod_proy= _proy
     AND t32_id_vta  =_idvta ;
	

SELECT ROW_COUNT() AS numrows, _idvta AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_visita_det` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_plan_visita_det`(
			IN _proy VARCHAR(10), 
			IN _vta INT,
			IN _idact INT,
			IN _act INT,
			IN _ini DATETIME , 
			IN _ter DATETIME , 
			IN _esp VARCHAR(1000), 
			IN _usr VARCHAR(20))
BEGIN
 
  UPDATE t32_plan_act 
     SET t32_cod_act = _act,
	 t32_fch_ini = _ini,
	 t32_fch_ter = _ter,
	 t32_esp_act = _esp,
	 usr_actu    = _usr, 
	 fch_crea    = NOW()
   WHERE t02_cod_proy = _proy
     AND t32_id_vta = _vta
     AND t32_id_act = _idact ;
	 

SELECT ROW_COUNT() AS numrows, _idact AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_plan_visita_me` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`soporte`@`%` PROCEDURE `sp_upd_plan_visita_me`(
			IN _proy VARCHAR(10), 
			IN _id INT,
			IN _anio INT, 
			IN _mes INT, 
			IN _obs TEXT, 
			in _mto1 double,
			IN _mto2 DOUBLE,
			IN _fecvis datetime,
			IN _fecter DATETIME,
			IN _vb char(1),			
			IN _usr VARCHAR(20))
BEGIN
 
  UPDATE t31_plan_me 
     SET t31_anio = _anio , 
	t31_mes  = _mes , 
	t31_obs  = _obs , 
	t31_mto_v1 = _mto1,
	t31_mto_v2 = _mto2,
	t31_mto_tot = (_mto1 + _mto2),
	t31_fec_vis = _fecvis,
	t31_fec_ter = _fecter,
	t31_vb_v1   = _vb ,	
	usr_actu = _usr ,
	fch_actu = NOW()
  WHERE
	t02_cod_proy = _proy AND t31_id = _id ;
  

SELECT ROW_COUNT() AS numrows, _id AS codigo ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_poa_ind_act` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_poa_ind_act`(IN _proy VARCHAR(10), in _ver  int, IN _comp INT ,IN _act INT,IN _compind INT ,  IN _meta DOUBLE,IN _obs VARCHAR(5000),IN _usr VARCHAR(20))
BEGIN
 UPDATE t09_act_ind 
	SET
		t09_mta = _meta , 
		t09_obs = _obs , 
		usr_actu = _usr , 
		fch_actu = NOW() 
	WHERE t02_cod_proy = _proy
	  and t02_version  = _ver
	  AND t08_cod_comp = _comp 
		AND t09_cod_act = _act
	  and t09_cod_act_ind = _compind ;
		 
		
	SELECT ROW_COUNT() AS numrows, _compind AS codigo ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_poa_ind_comp` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_poa_ind_comp`(
					IN _proy VARCHAR(10), 
					in _ver  int, 
					IN _comp INT ,
					IN _compind INT ,  
					IN _meta DOUBLE, 
					IN _obs VARCHAR(5000),
					IN _usr VARCHAR(20)
				   )
BEGIN
 
 UPDATE t08_comp_ind 
	SET
		t08_mta = _meta , 
		t08_obs = _obs , 
		usr_actu = _usr , 
		fch_actu = NOW() 
	WHERE t02_cod_proy = _proy
	  and t02_version  = _ver
	  AND t08_cod_comp = _comp 
	  and t08_cod_comp_ind = _compind ;
		 
		
SELECT ROW_COUNT() AS numrows, _compind AS codigo ; 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_poa_subact_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_poa_subact_metas`(IN _proy VARCHAR(10), 
					   IN _ver    INT, 
					   IN _comp   INT, 
					   IN _activ  INT, 
					   IN _subact INT, 
					   IN _anio   int, 
					   IN _meses  varchar(500),
					   in _mpar   double,
					   in _mrprog DOUBLE, 
					   IN _user   varchar(20))
BEGIN
DECLARE	_metatotal DOUBLE;
declare _rowcount int;
		
	
delete from t09_sub_act_mtas 
WHERE t02_cod_proy = _proy  
and t02_version  = _ver   
and t08_cod_comp = _comp  
and t09_cod_act  = _activ 
and t09_cod_sub  = _subact 
and t09_anio     = _anio ;
CALL sp_strTempTable('TTempMeses',_meses,'|');
INSERT INTO t09_sub_act_mtas 
		(
		 t02_cod_proy, 
		 t02_version, 
		 t08_cod_comp, 
		 t09_cod_act, 
		 t09_cod_sub, 
		 t09_anio, 
		 t09_mes, 
		 t09_mta, 
		 usr_crea, 
		 fch_crea, 
		 usr_actu, 
		 fch_actu, 
		 est_audi
		)
SELECT 	_proy  ,
		_ver   ,
		_comp  ,
		_activ , 
		_subact   , 
		_anio  ,
		id as mes,
		txt as t09_mta,
		_user,
		NOw(),
		null,
		null,
		'1'
FROM TTempMeses
where txt > 0 ;
select ROW_COUNT() into _rowcount;	
DROP TEMPORARY TABLE TTempMeses;
update t09_subact 
   set t09_mta_proy  = _mpar  ,
       t09_mta_repro = _mrprog
WHERE t02_cod_proy = _proy  
  AND t02_version  = _ver   
  AND t08_cod_comp = _comp  
  AND t09_cod_act  = _activ 
  AND t09_cod_sub  = _subact ; 
sELECT _rowcount AS numrows, _subact AS codigo ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_poa_subact_metas2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_poa_subact_metas2`(IN _proy VARCHAR(10), 
					    IN _ver    INT, 
					    IN _comp   INT, 
					    IN _activ  INT, 
					    IN _subact INT, 
					    IN _anio   int)
BEGIN
DECLARE	_costototal DOUBLE;
declare _metas double ;
SELECT IFNULL(SUM(t09_mta),0) 
  into _metas
  FROM t09_sub_act_mtas 
 WHERE t02_cod_proy = _proy     
   AND t02_version  = _ver   
   AND t08_cod_comp = _comp  
   AND t09_cod_act  = _activ 
   AND t09_cod_sub  = _subact 
   AND t09_anio     = _anio ;
update t09_subact 
   SET t09_mta = _metas
 WHERE t02_cod_proy = _proy  
   AND t02_version  = _ver   
   AND t08_cod_comp = _comp  
   AND t09_cod_act  = _activ 
   AND t09_cod_sub  = _subact ;
   
update t10_cost_sub
   set t10_cost_tot = t10_cost_parc * _metas
 WHERE t02_cod_proy = _proy  
   AND t02_version  = _ver   
   AND t08_cod_comp = _comp  
   AND t09_cod_act  = _activ 
   AND t09_cod_sub  = _subact ;
   
update t10_cost_fte fte
INNER JOIN t10_cost_sub cost ON (fte.t02_cod_proy=cost.t02_cod_proy AND fte.t02_version=cost.t02_version AND fte.t08_cod_comp=cost.t08_cod_comp AND fte.t09_cod_act=cost.t09_cod_act AND fte.t09_cod_sub=cost.t09_cod_sub AND fte.t10_cod_cost=cost.t10_cod_cost)
set fte.t10_mont = (cost.t10_cost_tot * (fte.t10_porc/100))
WHERE fte.t02_cod_proy = _proy
  AND fte.t02_version  = _ver
  AND fte.t08_cod_comp = _comp  
  AND fte.t09_cod_act  = _activ 
  AND fte.t09_cod_sub  = _subact ;
  
   
sELECT ROW_COUNT() AS numrows, _subact AS codigo ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_poa_subact_observa` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_poa_subact_observa`(IN _proy VARCHAR(10), 
					     IN _ver    INT, 
					     IN _comp   INT, 
					     IN _activ  INT, 
					     IN _subact INT, 
					     IN _obs    text)
BEGIN
update t09_subact 
   SET t09_obs_mt = _obs
 WHERE t02_cod_proy = _proy  
   AND t02_version  = _ver   
   AND t08_cod_comp = _comp  
   AND t09_cod_act  = _activ 
   AND t09_cod_sub  = _subact ;
   
sELECT ROW_COUNT() AS numrows, _subact AS codigo ;
	 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_proyecto` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_proyecto`( IN _version INT,
                    IN _nro_exp VARCHAR(20) ,
                    IN _cod_linea INT,
                    IN _inst INT,
                    IN _cod_proy VARCHAR(10) ,
                    IN _nom_proy VARCHAR(250) ,
                    IN _fch_apro DATE,                                  
                    IN _estado INT,                                 
                    IN _fin TEXT ,
                    IN _pro TEXT,
                    IN _ben_obj VARCHAR(5000) ,
                    IN _amb_geo VARCHAR(5000) ,
                    IN _moni_tema INT,
                    IN _moni_fina INT,
                    IN _moni_ext VARCHAR(10) ,
                    IN _sup_inst INT,
                    IN _dire_proy VARCHAR(200),
                    IN _ciud_proy VARCHAR(50) ,                                 
                    IN _tele_proy VARCHAR(30) ,
                    IN _fax_proy VARCHAR(30) ,
                    IN _mail_proy VARCHAR(50) ,                                 
                    IN _t02_fch_isc  DATE ,
                    IN _t02_fch_ire  DATE ,
                    IN _t02_fch_tre  DATE ,
                    IN _t02_fch_tam  DATE ,
                    IN _t02_num_mes INT,    
                    IN _t02_num_mes_amp INT,                                
                    IN _t02_cre_fe CHAR(1),
                    IN _t02_gratificacion       VARCHAR(10),
                    IN _t02_porc_cts        VARCHAR(10),
                    IN _t02_porc_ess        VARCHAR(10),
                    IN _t02_porc_gast_func      VARCHAR(10),
                    IN _t02_porc_linea_base     VARCHAR(10),
                    IN _t02_porc_imprev     VARCHAR(10),
                    IN _t02_proc_gast_superv     VARCHAR(10),
		    IN _t02_inst_asoc TEXT,
                    IN _usr VARCHAR(20),
                    IN _vb TINYINT)
BEGIN
    DECLARE _msg        VARCHAR(100);
    DECLARE _existe     INT ;
    DECLARE _fch_ini    DATE;
    DECLARE _fch_ter    DATE;
    DECLARE _num_rows   INT ;  
    DECLARE _numrows    INT ; 
    DECLARE _fcredito   INT DEFAULT 200;
    DECLARE _aporteFE DOUBLE;
 
SET AUTOCOMMIT=0;
START TRANSACTION;
 
    SELECT _t02_fch_ire, (CASE WHEN IFNULL(DATEDIFF(_t02_fch_tre, _t02_fch_tam),0) <> 0 THEN _t02_fch_tam ELSE _t02_fch_tre END)
    INTO _fch_ini, _fch_ter;
        
    UPDATE t02_dg_proy 
       SET
        t02_nro_exp = _nro_exp , 
        t00_cod_linea = _cod_linea , 
        t01_id_inst = _inst ,   
        t02_nom_proy = _nom_proy , 
        t02_fch_apro = _fch_apro , 
        t02_fch_ini = _fch_ini , 
        t02_fch_ter = _fch_ter , 
        t02_fin     = _fin , 
        t02_pro     = _pro , 
        t02_ben_obj = _ben_obj , 
        t02_amb_geo = _amb_geo ,
        t02_cre_fe  = _t02_cre_fe, 
        t02_moni_tema = _moni_tema , 
        t02_moni_fina = _moni_fina , 
        t02_moni_ext = _moni_ext , 
        t02_sup_inst = _sup_inst , 
        t02_dire_proy = _dire_proy , 
        t02_ciud_proy = _ciud_proy , 
        t02_tele_proy = _tele_proy , 
        t02_fax_proy = _fax_proy , 
        t02_mail_proy = _mail_proy ,        
        t02_fch_isc = _t02_fch_isc ,
        t02_fch_ire = _t02_fch_ire ,
        t02_fch_tre = _t02_fch_tre ,
        t02_fch_tam = _t02_fch_tam ,
        t02_num_mes = _t02_num_mes ,
        t02_num_mes_amp = _t02_num_mes_amp ,
        t02_estado = _estado , 
        usr_actu = _usr , 
        fch_actu = NOW(),
	    t02_inst_asoc = _t02_inst_asoc

    WHERE t02_cod_proy = _cod_proy 
      AND t02_version = _version ;
    SELECT ROW_COUNT() INTO _num_rows;
    
    UPDATE t02_tasas_proy SET  
        t02_gratificacion = _t02_gratificacion,
        t02_porc_cts = _t02_porc_cts,
        t02_porc_ess = _t02_porc_ess,
        t02_porc_gast_func = _t02_porc_gast_func, 
        t02_porc_linea_base = _t02_porc_linea_base, 
        t02_porc_imprev = _t02_porc_imprev,
        t02_proc_gast_superv = _t02_proc_gast_superv,
        usr_actu = _usr,
        fch_actu = NOW()
    WHERE t02_cod_proy = _cod_proy AND t02_version = _version;
    
    CALL sp_calcula_anios_proy(_cod_proy, _version);
    
    IF _t02_cre_fe='S' THEN 
      CALL sp_ins_fte_fin(_cod_proy,_fcredito,'','','',_usr,NOW());
    END IF;
    
    IF _vb = 1 THEN
        UPDATE t02_aprob_proy
        SET t02_cod_proy = _cod_proy, 
	        t02_vb_proy = 1, 
	        t02_fch_vb_proy = NOW(), 
	        usu_crea = _usr, 
	        fch_crea = NOW()
        WHERE t02_cod_proy = _cod_proy;
        
        UPDATE t02_dg_proy 
        SET t02_estado = 41 
        WHERE t02_cod_proy = _cod_proy 
        AND t02_version = _version;
    ELSE
        UPDATE t02_aprob_proy
        SET t02_cod_proy = _cod_proy, 
	        t02_vb_proy = NULL, 
	        t02_fch_vb_proy = NULL, 
	        usu_crea = _usr, 
	        fch_crea = NOW()
        WHERE t02_cod_proy = _cod_proy;
        
        UPDATE t02_dg_proy 
        SET t02_estado = 40  
        WHERE t02_cod_proy = _cod_proy 
        AND t02_version = _version;
    END IF;
    
    
    SET _aporteFE = fn_total_aporte_fuentes_financ3(_cod_proy, _version , 10);
    
    UPDATE t03_mp_linea_base 
    SET t03_monto = ((_aporteFE * _t02_porc_linea_base) / 100)
    WHERE t02_cod_proy = _cod_proy AND t02_version = _version; 
   
    UPDATE t03_mp_gas_supervision 
    SET t03_monto = ((_aporteFE * _t02_proc_gast_superv) / 100)
    WHERE t02_cod_proy = _cod_proy AND t02_version = _version;
    
    call sp_upd_proyecto_costos(_cod_proy, _version);
    
 COMMIT ;
    SELECT _num_rows  AS numrows, _cod_proy AS codigo, _msg AS msg ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_proyecto_costos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_proyecto_costos`(IN _proy varchar(10), in _ver INT )
BEGIN
	update t02_dg_proy
	set    t02_mto_line_base = (SELECT IFNULL(SUM(t03_monto),0) 
	                              FROM t03_mp_linea_base
	                             WHERE t02_cod_proy = _proy AND t02_version = _ver ) ,
	       t02_mto_imprevisto = (SELECT IFNULL(SUM(t03_monto),0) 
	                               FROM t03_mp_imprevistos
	                              WHERE t02_cod_proy = _proy AND t02_version = _ver),
	       t02_pres_tot = fn_costos_total_proyecto(_proy, _ver),
	       t02_pres_fe = fn_costo_presupuesto_fe(_proy, _ver),
	       t02_pres_otro = fn_costo_presupuesto_otros(_proy, _ver),
	       t02_mto_supervision = (SELECT IFNULL(SUM(t03_monto),0) 
                                   FROM t03_mp_gas_supervision
                                  WHERE t02_cod_proy = _proy AND t02_version = _ver)
	where t02_cod_proy=_proy
	  and t02_version =_ver;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_relacioninstitucion` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_relacioninstitucion`(IN _t01_id_inst   INT , 
		IN _t01_relfe VARCHAR(100),
					IN _usu  	VARCHAR(20))
BEGIN
  DECLARE _numrows 	INT;
  
 UPDATE t01_dir_inst 
    SET 
	t01_rel_fe     = _t01_relfe,
	usr_actu = _usu, 
	fch_actu = NOW()
 WHERE t01_id_inst  = _t01_id_inst ;
	
    SELECT ROW_COUNT() INTO _numrows;
    COMMIT;
    
    SELECT _numrows AS numrows, '' AS msg , _t01_id_inst AS codigo ;
     
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_sector_prod` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_sector_prod`(
            IN _proy VARCHAR(10), 
            IN _sectmain_old INT, 
            IN _sect_old INT, 
            IN _subs_old INT, 
            IN _sectmain INT, 
            IN _sect INT, 
            IN _subs INT, 
            IN _obs TEXT, 
            IN _usr VARCHAR(20))
BEGIN
DECLARE _existe INT ;
SELECT COUNT(1) INTO _existe
FROM t02_sector_prod
WHERE   t02_cod_proy = _proy 
    AND t02_sector_main   = _sectmain 
    AND t02_sector   = _sect 
    AND t02_subsec   = _subs
    AND (t02_sector_main   <> _sectmain_old AND t02_sector   <> _sect_old   AND t02_subsec   <> _subs_old ) ;
IF _existe = 0 THEN 
  UPDATE t02_sector_prod 
     SET t02_sector_main = _sectmain , 
     t02_sector = _sect , 
     t02_subsec = _subs , 
     t02_obs  = _obs , 
     usr_actu = _usr ,
     fch_actu = NOW()
  WHERE t02_cod_proy = _proy 
    AND t02_sector_main   = _sectmain_old 
    AND t02_sector   = _sect_old 
    AND t02_subsec   = _subs_old  ;
  

SELECT ROW_COUNT() AS numrows, _subs AS codigo, '' AS 'error' ;
ELSE
SELECT 0 AS numrows, 0 AS codigo, 'Ya existe el Sector Productivo que intenta actualizar' AS 'error' ;
END IF;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_sol_aprob` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_sol_aprob`(IN _proy VARCHAR(10), 
    IN _tip VARCHAR(20), 
    IN _est INT  ,  
    IN _msg TEXT ,
    IN _usr VARCHAR(20))
BEGIN
DECLARE _rowcount INT DEFAULT 0 ; 
DECLARE _nomejec VARCHAR(30) ;

SELECT t01_sig_inst 
  INTO _nomejec 
  FROM t01_dir_inst 
 WHERE t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_proy AND p.t02_version=1);
IF _tip = 'ml' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_aprob_ml = _est ,
            t02_fch_ml   = NOW(),
            t02_aprob_ml_mon = NULL,
            t02_obs_ml  = ''
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_aprob_ml, t02_fch_ml, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_ejecutor(    _proy, 
                        'Aprobación del Marco Lógico',
                        CONCAT('El Marco Lógico del proyecto ', _proy, ', ha sido aprobado, para continuar con el ingreso del Cronograma de Actividades. \n\n', _msg,  '\n\nPuede revisar el proyecto haciendo <a href="http://localhost/test/sme/proyectos/planifica/ml_index.php?txtCodProy=',_proy,'"> click Aquí </a>' ),
                        _nomejec,
                        _usr
                         ) ;
    END IF ;
    
END IF ;
IF _tip = 'cron' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_aprob_cro = _est ,
            t02_fch_cro   = NOW(),
            t02_aprob_cro_mon = NULL,
            t02_obs_cro = ''
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_aprob_cro, t02_fch_cro, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_ejecutor(    _proy, 
                        'Aprobación del Cronograma de Actividades',
                        CONCAT('El proyecto ', _proy, 
                                ' Cuenta con el VoBo del cronograma de actividades, ',
                                'puede continuar con el registro del presupuesto inicial. \n\n', _msg, '\n' ),
                        _nomejec,
                        _usr
                         ) ;
    END IF ;
END IF ;
IF _tip = 'pre' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_aprob_pre = _est ,
            t02_fch_pre   = NOW(),
            t02_aprob_pre_mon = NULL,
            t02_obs_pre = ''
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_aprob_pre, t02_fch_pre, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_ejecutor(    _proy, 
                        'Aprobación del Presupuesto',
                        CONCAT('El proyecto ', _proy, 
                        ' cuenta con el VoBo del presupuesto inicial, ',
                        'proceda a registrar Equipo Líder, Sector Productivo, Ambito Geográfico, ',
                        'Planes Específicos y Padrón de Beneficiarios, éste último debe ser revisado periodicamente. \n\n', _msg, '\n' ),
                        _nomejec,
                        _usr
                         ) ;
    END IF ;
END IF ;
IF _tip = 'proy' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_aprob_proy = _est ,
            t02_fch_aprob_proy  = NOW(),
            t02_obs_aprob_proy  = ''
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_aprob_proy, t02_fch_aprob_proy, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_personalizado(   _proy, 
                        'Aprobación del Proyecto',
                        CONCAT('El proyecto ', _proy, ', ha sido aprobado. \n\n', _msg, '\n\nPuede revisar el proyecto haciendo <a href="http://localhost/test/sme/proyectos/datos/lista.php?txtCodProy=',_proy,'"> click Aquí </a>' ),
                        _nomejec,
                        _usr, 4
                         ) ;
    END IF ;
END IF ;
IF _tip = 'vbpy' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_vb_proy = _est ,
            t02_fch_vb_proy  = NOW(),
            t02_obs_vb_proy = ''
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_vb_proy, t02_fch_vb_proy, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_personalizado(   _proy, 
                        'Solicitud Aprobación del Proyecto',
                        CONCAT('El proyecto ', _proy, ', ha solicitado su Aprobación para continuar con el ingreso del Marco Lógico. \n\n', _msg, '\n\nPuede revisar el proyecto haciendo <a href="http://localhost/test/sme/proyectos/datos/lista.php?txtCodProy=',_proy,'"> click Aquí </a>' ),
                        _nomejec,
                        _usr, 3
                         ) ;
    END IF ;
END IF;
IF _tip = 'evml' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_env_ml = _est ,
            t02_fch_env_ml = NOW()
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_ml, t02_fch_env_ml, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_mt(  _proy, 
                        'Solicitud Revisión Marco Lógico',
                        CONCAT('El proyecto ', _proy, ', ha solicitado la Revisión del Marco Lógico. \n\n', _msg, '\n\nPuede revisar el proyecto haciendo <a href="http://localhost/test/sme/proyectos/planifica/ml_index.php?txtCodProy=',_proy,'"> click Aquí </a>' ),
                        _nomejec,
                        _usr
                         ) ;
    END IF ;
END IF;
IF _tip = 'evpr' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_env_pre = _est ,
            t02_fch_env_pre = NOW()
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_pre, t02_fch_env_pre, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_mf(  _proy, 
                        'Solicitud Revisión del Presupuesto',
                        CONCAT('El proyecto ', _proy, ', solicita la revisión del presupuesto inicial. \n\n', _msg, '\n' ),
                        _nomejec,
                        _usr
                         ) ;
    END IF ;
END IF;
IF _tip = 'evel' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_env_el = _est ,
            t02_fch_env_el = NOW()
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_el, t02_fch_env_el, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_fe(  _proy, 
                        'Solicitud Revisión del Equipo Lider',
                        CONCAT('El proyecto ', _proy, ', ha solicitado su Revisión del Equipo Lider \n\n', _msg ),
                        _nomejec,
                        _usr
                         ) ;
    END IF ;
END IF;
IF _tip = 'evcr' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_env_cro = _est ,
            t02_fch_env_cro = NOW()
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_cro, t02_fch_env_cro, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_mt(  _proy, 
                        'Solicitud Revisión del Cronograma de Actividades',
                        CONCAT('El proyecto ', _proy, ', solicita la Revisión del Cronograma de Actividades. \n\n', _msg, '\n' ),
                        _nomejec,
                        _usr
                         ) ;
    END IF ;
END IF;
IF _tip = 'scp' THEN
SET _rowcount =1;
    UPDATE t04_sol_cambio_per 
           SET  t04_aprob_cmf = 1, 
                t04_aprob_cmt = 1 
         WHERE t02_cod_proy = _proy ;
    SET _rowcount = ROW_COUNT() ;
    IF _rowcount >0 THEN
        CALL sp_ins_mensaje_proy_a_ejecutor(    _proy, 
                        'Solicitud de Cambio de Personal',
                        CONCAT('La solicitud de cambio del personal del proyecto ', _proy, ', ha sido aprobada \n\n', _msg ),
                        _nomejec,
                        _usr
                         ) ;
        END IF; 
END IF;
IF _tip = 'srdg' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_dg_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_dg_proy 
           SET  env_rev = _est 
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    
    END IF;
    
    IF _rowcount >0 THEN 
        CALL sp_ins_mensaje_proy_a_personalizado(   _proy, 
                        'Solicitud de Revisión de Datos Generales del Proyecto',
                        CONCAT('El proyecto ', _proy, ', ha solicitado la revisión de sus Datos Generales. \n\n', _msg, '\n\nPuede revisar el proyecto haciendo <a href="http://localhost/test/sme/proyectos/datos/lista.php?txtCodProy=',_proy,'"> click Aquí </a>' ),
                        _nomejec,
                        _usr,
                        1
                         ) ;
    END IF ;
END IF;

IF _tip = 'evcrprod' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_env_croprod = _est ,
            t02_fch_env_croprod = NOW()
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_croprod, t02_fch_env_croprod, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN
        CALL sp_ins_mensaje_proy_a_mt(  _proy, 
                        'Solicitud Revisión del Cronograma de Productos',
                        CONCAT('El proyecto ', _proy, ', solicita la Revisión del Cronograma de Productos. \n\n', _msg, '\n' ),
                        _nomejec,
                        _usr
                         );
    END IF ;
END IF;

IF _tip = 'cronprod' THEN
    IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
        UPDATE t02_aprob_proy 
           SET  t02_aprob_croprod = _est ,
            t02_fch_croprod   = NOW(),
            t02_aprob_croprod_mon = NULL,
            t02_obs_croprod = ''
         WHERE t02_cod_proy = _proy ;
         SET _rowcount = ROW_COUNT() ;
    ELSE
        INSERT INTO t02_aprob_proy(t02_cod_proy, t02_aprob_croprod, t02_fch_croprod, usu_crea, fch_crea)
                VALUES(_proy, _est, NOW(), _usr, NOW() );
        SET _rowcount = ROW_COUNT() ;
    END IF;
    
    IF _rowcount >0 THEN
        CALL sp_ins_mensaje_proy_a_ejecutor(    _proy, 
                        'Aprobación del Cronograma de Actividades',
                        CONCAT('El proyecto ', _proy, 
                                ' Cuenta con el VoBo del cronograma de actividades, ',
                                'puede continuar con el registro del presupuesto inicial. \n\n', _msg, '\n' ),
                        _nomejec,
                        _usr
                         );
    END IF ;
END IF ;


SELECT _rowcount AS numrows, _proy AS codigo ;  
                    
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_sol_aprob_eje` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_sol_aprob_eje`(IN _proy VARCHAR(10), 
    IN _tip CHAR(4), 
    IN _est INT  ,  
  IN _msg TEXT ,
 IN _usr VARCHAR(20), IN _code int)
BEGIN
DECLARE _rowcount INT DEFAULT 0 ; 
DECLARE _nomejec VARCHAR(30) ;
SELECT t01_sig_inst 
  INTO _nomejec 
  FROM t01_dir_inst 
 WHERE t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_proy AND p.t02_version=1);
IF _tip = 'scp' THEN
SET _rowcount =1;
	UPDATE t04_sol_cambio_per 
		   SET 	t04_aprob_cmf = 1, 
		    	t04_aprob_cmt = 1,
					t04_fec_ter = NOW(),
					fch_actu = NOW()
		 WHERE t02_cod_proy = _proy 
and t04_num_soli=_code;
	SET _rowcount = ROW_COUNT() ;
	IF _rowcount >0 THEN
		CALL sp_ins_mensaje_proy_a_ejecutor(	_proy, 
						'Solicitud de Cambio de Personal',
						CONCAT('La solicitud de cambio del personal del proyecto ', _proy, ', ha sido aprobada \n\n', _msg ),
						_nomejec,
						_usr
					     ) ;
		END IF;	
END IF;
SELECT _rowcount AS numrows, _proy AS codigo ;  
					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_sol_aprob_mf` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_sol_aprob_mf`(IN _proy VARCHAR(10), 
    IN _tip CHAR(4),  
    IN _est INT  ,  IN _msg TEXT ,
 IN _usr VARCHAR(20), IN _code int)
BEGIN
DECLARE _rowcount INT DEFAULT 0 ; 
DECLARE _nomejec VARCHAR(30) ;
declare _periodo_ref varchar(50);
SELECT t01_sig_inst 
  INTO _nomejec 
  FROM t01_dir_inst 
 WHERE t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_proy AND p.t02_version=1);
IF _tip = 'reff' THEN
	UPDATE	t51_inf_mf 
	SET 	t51_estado = _est, 
			fch_actu = NOW()
	 WHERE	t02_cod_proy = _proy 
		and t51_num = _code;
	SET _rowcount = ROW_COUNT() ;
	IF _rowcount >0 THEN
		select	t51_periodo
		into	_periodo_ref
		from	t51_inf_mf
		WHERE 	t02_cod_proy = 	_proy AND t51_num = _code;
		CALL sp_ins_mensaje_proy_a_financ(	_proy, 
						'Solicitud de Revisión de Informe de Evaluación Financiera de Fondoempleo',
						CONCAT('La evaluación financiera No. ', _code, ' del periodo ', _periodo_ref, 
								' del proyecto ', _proy, ', solicita la revisión del informe de Evaluación Financiera de Fondoempleo  \n\n', _msg ),
						_nomejec,
						_usr,
						_tip
					     ) ;
		END IF;	
END IF;
IF _tip = 'ceff' THEN
	UPDATE	t51_inf_mf 
	SET 	t51_estado = _est, 
			fch_actu = NOW()
	WHERE	t02_cod_proy = _proy 
		and t51_num=_code;
	SET _rowcount = ROW_COUNT() ;
	IF _rowcount >0 THEN
		SELECT	t51_periodo
		INTO	_periodo_ref
		FROM	t51_inf_mf
		WHERE 	t02_cod_proy = 	_proy AND t51_num = _code;
		CALL sp_ins_mensaje_proy_a_financ(	_proy, 
						'Solicitud de Corrección del informe de Evaluación Financiera de Fondoempleo',
						CONCAT('La evaluación financiera No. ', _code, ' del periodo ', _periodo_ref, 
								' del proyecto ', _proy, 
								' ha sido observada, levante las observaciones y solicite nuevamente la revisión  \n\n', _msg ),
						_nomejec,
						_usr,
						_tip
						
					     ) ;
		END IF;	
END IF;
IF _tip = 'aeff' THEN
	UPDATE	t51_inf_mf 
	SET		t51_estado = _est, 
			fch_actu = NOW()
	WHERE	t02_cod_proy = _proy 
		and t51_num=_code;
	SET _rowcount = ROW_COUNT() ;
	IF _rowcount >0 THEN
		SELECT	t51_periodo
		INTO	_periodo_ref
		FROM	t51_inf_mf
		WHERE 	t02_cod_proy = 	_proy AND t51_num = _code;
		CALL sp_ins_mensaje_proy_a_financ(	_proy, 
						'Aprobación del Informe de Evaluación Financiera de Fondoempleo',
						CONCAT('La evaluación financiera No. ', _code, ' del periodo ', _periodo_ref, 
								' del proyecto ', _proy, ' ha sido aprobado  \n\n', _msg ),
						_nomejec,
						_usr,
						_tip
					     ) ;
		END IF;	
END IF;
SELECT _rowcount AS numrows, _proy AS codigo ;  
					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_sol_correc` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = '' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_sol_correc`(IN _proy VARCHAR(10),  IN _tip CHAR(8),  IN _est INT,  IN _msg TEXT, IN _usr VARCHAR(20))
BEGIN
DECLARE _rowcount INT DEFAULT 0 ; 
DECLARE _nomejec VARCHAR(30) ;
SELECT t01_sig_inst 
  INTO _nomejec 
  FROM t01_dir_inst 
 WHERE t01_id_inst = (SELECT p.t01_id_inst FROM t02_dg_proy p WHERE p.t02_cod_proy=_proy AND p.t02_version=1);
IF _tip = 'ml' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_ml = _est ,
			t02_obs_ml	= ''
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_ml)
		        VALUES(_proy, _est);
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_ejecutor(	_proy, 
						'Correccin del Marco Lgico',
						CONCAT('Seores Ejecutores del proyecto ', _proy, ', su Marco Lgico ha sido observado y solicita su correccin. \n\n', _msg, '\n\nPuede revisar el proyecto haciendo <a href="http://localhost/sgp/sme/proyectos/planifica/ml_index.php?txtCodProy=',_proy,'"> click Aqu </a>' ),
						_nomejec,
						_usr
					     ) ;
	END IF ;
END IF ;
IF _tip = 'cron' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_cro = _est ,
			t02_obs_cro	= ''
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_cro)
		        VALUES(_proy, _est);
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_ejecutor(	_proy, 
						'Correccin del Cronograma de Actividades',
						CONCAT('El cronograma de actividades del proyecto ', _proy, 
							', ha sido observado, levante las observaciones y solicite nuevamente su revisin. \n\n', _msg, '\n' ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF ;


IF _tip = 'cronprod' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_croprod = _est ,
			t02_obs_croprod	= ''
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_croprod)
		        VALUES(_proy, _est);
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_ejecutor(	_proy, 
						'Correccin del Cronograma de Productos',
						CONCAT('El cronograma de productos del proyecto ', _proy, 
							', ha sido observado, levante las observaciones y solicite nuevamente su revisin. \n\n', _msg, '\n' ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF ;


IF _tip = 'pre' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy 
		   SET 	t02_env_pre = _est ,
			t02_obs_pre	= ''
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, t02_env_pre)
		        VALUES(_proy, _est);
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_ejecutor(	_proy, 
						'Correccin del Presupuesto',
						CONCAT('El presupuesto inicial del proyecto ', _proy, 
						'ha sido observado, levante las observaciones y solicite nuevamente la revisin. \n\n', _msg, '\n' ),
						_nomejec,
						_usr
					     ) ;
			
	END IF ;
END IF ;
IF _tip = 'proy' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_dg_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_dg_proy 
		   SET 	env_rev = _est
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_dg_proy(t02_cod_proy, env_rev)
		        VALUES(_proy, _est);
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_personalizado(	_proy, 
						'Correcin Datos Generales del Proyecto',
						CONCAT('El proyecto ', _proy, ', ha solicitado la Correccin de los Datos Generales para su Aprobacin.\n\n', _msg, '\n\nPuede revisar el proyecto haciendo <a href="http://localhost/sgp/sme/proyectos/datos/lista.php?txtCodProy=',_proy,'"> click Aqu </a>' ),
						_nomejec,
						_usr,
						2
					     ) ;
			
	END IF ;
END IF ;
IF _tip = 'vbpr' THEN
	IF EXISTS(SELECT t02_cod_proy FROM t02_aprob_proy WHERE t02_cod_proy = _proy) THEN
		UPDATE t02_aprob_proy
		   SET 	t02_vb_proy = _est
		 WHERE t02_cod_proy = _proy ;
		 SET _rowcount = ROW_COUNT() ;
	ELSE
		INSERT INTO t02_aprob_proy(t02_cod_proy, env_rev)
		        VALUES(_proy, _est);
		SET _rowcount = ROW_COUNT() ;
	END IF;
	
	IF _rowcount >0 THEN 
		CALL sp_ins_mensaje_proy_a_personalizado(	_proy, 
						'Correcin Datos Generales del Proyecto',
						CONCAT('El proyecto ', _proy, ', ha solicitado la Correccin de los Datos Generales para su Aprobacin\n\n', _msg ),
						_nomejec,
						_usr, 6
					     ) ;
			
	END IF ;
END IF ;
SELECT _rowcount AS numrows, _proy AS codigo ;  
					
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_sol_env_proy` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_sol_env_proy`(IN _solicitud INT,                     IN _cod_proy VARCHAR(10) ,                     IN _version INT)
BEGIN
	
	UPDATE t02_dg_proy
	SET env_sol_apro   = _solicitud
	   
	WHERE t02_cod_proy = _cod_proy 
	  AND t02_version = _version ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_subact_total_metas` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_subact_total_metas`(	   IN _proy VARCHAR(10), 
						   IN _ver    INT, 
						   IN _comp   INT, 
						   IN _activ  INT, 
						   IN _subact INT,
						   in _anio   int
						   )
BEGIN
	DECLARE	_metatotal DOUBLE;
	declare _rowcount int;
	declare _verif_anio int ;
	
	select fn_verificar_anio(_proy, _ver) into _verif_anio ;
	
	delete from t09_sub_act_mtas 
	WHERE t02_cod_proy = _proy  
	  and t02_version  = _ver   
	  and t08_cod_comp = _comp  
	  and t09_cod_act  = _activ 
	  and t09_cod_sub  = _subact 
	  and t09_mta     <= 0 ;
	
	select sum((case when _verif_anio < 0 then t09_mta else (CASE WHEN t09_anio=_verif_anio THEN t09_mta ELSE 0 END) end)) 
	  into _metatotal
	  FROM t09_sub_act_mtas 
	 WHERE t02_cod_proy = _proy  
	   AND t02_version  = _ver   
	   AND t08_cod_comp = _comp  
	   AND t09_cod_act  = _activ 
	   AND t09_cod_sub  = _subact 
	   
	   ;
		   
	
	update t09_subact 
	set t09_mta = _metatotal
	 WHERE t02_cod_proy = _proy  
	   AND t02_version  = _ver   
	   AND t08_cod_comp = _comp  
	   AND t09_cod_act  = _activ 
	   AND t09_cod_sub  = _subact ;
	 
		
		
 	 sELECT _rowcount AS numrows, _subact AS codigo ;
		 
    END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_tablasaux` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_tablasaux`(
			in _cod    int,
			IN _nom    VARCHAR(100) ,
			IN _abrev  VARCHAR(15), 
			IN _ext    VARCHAR(20),
			IN _tabla  INT,
			IN _ord    INT,
			IN _act    CHAR(1),
			IN _usu    VARCHAR(20))
BEGIN
  DECLARE _msg    VARCHAR(100);
  DECLARE _existe   INT ;
  DECLARE _rowcount INT ;
  
  
  SELECT COUNT(1)
  INTO _existe
  FROM adm_tablas_aux
  WHERE descrip = _nom  
    AND idTabla = _tabla
    and codi <> _cod ;
  
  IF _existe > 0 THEN
    SELECT CONCAT('El Tipo ', _nom, ' ya fue registrado para esta Tabla Auxiliar ')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  ELSE
     
    update adm_tablas_aux 
       set descrip = _nom, 
	   abrev = _abrev, 
	   cod_ext = _ext, 
	   flg_act = _act, 
	   idTabla = _tabla, 
	   orden   = _ord, 
	   usu_actu= _usu, 
	   fec_actu= now()
	where codi = _cod ;
	
    SELECT ROW_COUNT() INTO _rowcount ;
    SELECT _rowcount  AS numrows, _cod AS codigo, '' AS msg ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_tablasaux2` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_tablasaux2`(
			in _cod    int,
			IN _nom    VARCHAR(100) ,
			IN _abrev  VARCHAR(15), 
			IN _ext    VARCHAR(20),
			IN _tabla  INT,
			in _aux    int,
			IN _ord    INT,
			IN _act    CHAR(1),
			IN _usu    VARCHAR(20))
BEGIN
  DECLARE _msg    VARCHAR(100);
  DECLARE _existe   INT ;
  DECLARE _rowcount INT ;
  
  
  SELECT COUNT(1)
  INTO _existe
  FROM adm_tablas_aux2
  WHERE descrip = _nom  
    AND id_tabla_aux = _aux
    and codi <> _cod ;
  
  IF _existe > 0 THEN
    SELECT CONCAT('El Tipo ', _nom, ' ya fue registrado para esta Tabla Auxiliar ')
    INTO _msg ;
    SELECT 0 AS numrows, 0 AS codigo, _msg AS msg ;
    
  ELSE
     
    update adm_tablas_aux2 
       set descrip = _nom, 
	   abrev = _abrev, 
	   cod_ext = _ext, 
	   flg_act = _act, 
	   idTabla = _tabla, 
	   id_tabla_aux = _aux,
	   orden   = _ord, 
	   usu_actu= _usu, 
	   fec_actu= now()
	where codi = _cod ;
	
    SELECT ROW_COUNT() INTO _rowcount ;
    SELECT _rowcount  AS numrows, _cod AS codigo, '' AS msg ;
     
  END IF ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_usuarios` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_usuarios`(
			IN _usu    varchar(20), 
			IN _nomusu varchar(100), 
			in _mail   VARCHAR(100),
			IN _perfil INT, 
			in _inst   varchar(10),
			in _proy   varchar(10),
			IN _estado INT,
			IN _usr    varchar(20))
BEGIN
  
   
  
    update adm_usuarios 
       set 
	tipo_user = _perfil, 
	nom_user  = _nomusu, 
	mail      = _mail, 
	t01_id_uni= _inst, 
	t02_cod_proy=_proy, 
	estado=_estado, 
	usr_actu=_usr, 
	fch_actu=NOW()
    where coduser = _usu ;
     
  SELECT ROW_COUNT() AS numrows, _usu AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_usuarios_activos` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_usuarios_activos`(	IN _user VARCHAR(10), 
						IN _ip   varchar(15),
						in _idses varchar(50)
					   )
BEGIN
declare _limite_minutos int default 24 ; 
DECLARE _fechalimite datetime ; 
DECLARE _fechaahora DATETIME DEFAULT now() ; 
declare _existe int default 0 ;
set _fechalimite = date_add(_fechaahora, interval (_limite_minutos * -1) minute ) ;

update  adm_usuarios_activos
   set  estado = '0'
where fecha < (_fechalimite) ;

select count(1) 
  into _existe
  from adm_usuarios_activos
 where coduser = _user ;
 
if _existe > 0 then
	replace into adm_usuarios_activos(coduser, pub_ip, fecha, id_session, estado)
	values(_user, _ip, _fechaahora, _idses, '1');
else
	insert INTO adm_usuarios_activos(coduser, pub_ip, fecha, id_session, estado)
	VALUES(_user, _ip, _fechaahora, _idses, '1');
end if ;
SELECT ROW_COUNT() AS numrows, _user AS codigo ;   
  
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_upd_usuarios_pwd` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_upd_usuarios_pwd`(
			IN _usu    varchar(20), 
			IN _newpwd varchar(20), 
			IN _usr    varchar(20))
BEGIN
    
    REPLACE INTO adm_md5_pwd(codigo, codigomd5) 
                  VALUES(_newpwd, MD5(_newpwd));
    
    update adm_usuarios 
       set 
	clave_user = md5(_newpwd),
	usr_actu = _usr, 
	fch_actu = NOW()
    where coduser = _usu ;
     
  SELECT ROW_COUNT() AS numrows, _usu AS codigo, '' AS msg ;
     
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_up_gastos_no_aceptados` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_up_gastos_no_aceptados`(IN _proy varchar(10), 
					     in _idInf int,
					     IN _comp INT, 
					     IN _activ INT, 
					     IN _subact INT, 
	IN _cat INT,				     in _idFte int,
					     in _periodos varchar(200),
					     in _montos   varchar(200),
					     IN _observa  text, 
					     IN _usr varchar(20))
BEGIN
  declare _rowcount int ;
  declare _gasto_no_aceptado DOUBLE ;
  declare _observaciones  text ;  
  
  CALL sp_strTempTable('TTempPeriodos', _periodos,'|');  
  CALL sp_strTempTable('TTempMontos'  , _montos,'|');  
  CALL sp_strTempTable('TTempObserva' , _observa,'|');  
  
  
  replace INTO t51_inf_mf_gastos_no_aceptados 
	(t02_cod_proy, 
	t51_num, 
	t08_cod_comp, 
	t09_cod_act, 
	t09_cod_sub,
	t09_cod_sub_cat, 
	t09_anio, 
	t09_mes, 
	t51_fuente,
	t09_mto_no_acept, 
	t51_obs, 
	usr_crea, 
	fch_crea, 
	est_audi
	)
     select _proy  , 
	    _idInf ,
	    _comp  , 
	    _activ , 
	    _subact,
			_cat,
	    SUBSTRING_INDEX(p.txt,'.',1),
	    SUBSTRING_INDEX(p.txt,'.',-1),
	    _idFte,
	    m.txt,
	    o.txt,
	    _usr ,
	    now(),
	    '1'
     from       TTempPeriodos  p
     inner join TTempMontos    m on (p.id=m.id)
     inner join TTempObserva   o on (p.id=o.id) ;
  SELECT ROW_COUNT() INTO _rowcount;
   
  DROP TEMPORARY TABLE TTempPeriodos;
  DROP TEMPORARY TABLE TTempMontos;
  DROP TEMPORARY TABLE TTempObserva;
  
  delete from t51_inf_mf_gastos_no_aceptados  
   where t09_mto_no_acept <= 0 ;
 	  
  SELECT  SUM(n.t09_mto_no_acept) AS gasto_no_aceptado,
	  GROUP_CONCAT( CONCAT(   CONVERT(_utf8'Año ' USING latin1) ,n.t09_anio, ' - Mes ', n.t09_mes,': ', n.t51_obs) SEPARATOR '\n') AS observaciones
    into  _gasto_no_aceptado , _observaciones
    FROM t51_inf_mf_gastos_no_aceptados n
   WHERE n.t02_cod_proy = _proy 
     AND n.t51_num      = _idInf
     AND n.t51_fuente   = _idFte
     and n.t08_cod_comp = _comp 
     and n.t09_cod_act  = _activ 
     and n.t09_cod_sub  = _subact ;
 
 if EXISTS(select t09_cod_sub from t51_inf_mf_avance_monto where t02_cod_proy = _proy AND t51_num = _idInf AND t51_fuente = _idFte AND t08_cod_comp = _comp AND t09_cod_act = _activ) then
	 UPDATE t51_inf_mf_avance_monto 
	    SET t51_no_gasto = _gasto_no_aceptado,
		t51_obs      = _observaciones
	  WHERE t02_cod_proy = _proy
	    AND t51_num      = _idInf 
	    AND t08_cod_comp = _comp  
	    AND t09_cod_act  = _activ 
	    AND t09_cod_sub  = _subact 
	    AND t51_fuente   = _idFte ;
 else
	    INSERT INTO t51_inf_mf_avance_monto (t02_cod_proy, t51_num, t08_cod_comp, t09_cod_act, t09_cod_sub,t51_fuente, t51_obs       , t51_no_gasto      , usr_crea, fch_crea, est_audi )
					VALUES	( _proy      , _idInf , _comp	    , _activ     , _subact  , _idFte    , _observaciones, _gasto_no_aceptado, _usr    , now()   , '' ) ;  
 end if ;
  select _rowcount as numrows, _subact as codigo ;  	
  				
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `sp_validate_cronograma` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `sp_validate_cronograma`(in _proy varchar(10), in _ver int)
BEGIN
drop TEMPORARY table if EXISTS tmp_mensajes ;
CREATE TEMPORARY TABLE tmp_mensajes 
( id INT AUTO_INCREMENT,
  comp INT,
  act  INT,
  sub  INT,
  mensaje VARCHAR(250),
  PRIMARY KEY (`id`)
) ;

insert into tmp_mensajes(comp, act, sub, mensaje)
SELECT 	metas.componente,
	metas.actividad,
	metas.subactividad,
	concat('La Meta Total es:', metas.metatotal, ', y la suma de las metas Mensuales (',metaparciales,') no cubren la Meta total.') 
FROM (
	SELECT 	sub.t08_cod_comp AS componente, 
		sub.t09_cod_act  AS actividad,
		sub.t09_cod_sub  AS subactividad,
		sub.t09_mta      AS metatotal,
		SUM(mta.t09_mta) AS metaparciales
	  FROM 	   t09_sub_act_mtas mta
	RIGHT JOIN t09_subact       sub ON (mta.t02_cod_proy=sub.t02_cod_proy AND mta.t02_version=sub.t02_version AND mta.t08_cod_comp=sub.t08_cod_comp AND mta.t09_cod_act=sub.t09_cod_act AND mta.t09_cod_sub=sub.t09_cod_sub)
	WHERE mta.t02_cod_proy = _proy
	  AND mta.t02_version  = _ver
	GROUP BY sub.t08_cod_comp, 
		sub.t09_cod_act,
		sub.t09_cod_sub 
	) AS metas 
WHERE metas.metatotal <> metas.metaparciales ;
INSERT INTO tmp_mensajes(comp, act, sub, mensaje)
SELECT 	mta.t08_cod_comp AS componente, 
	mta.t09_cod_act  AS actividad,
	mta.t09_cod_sub  AS subactividad,
	CONCAT('Meta no valida en el mes (', GROUP_CONCAT(DISTINCT fn_numero_mes(mta.t09_anio, mta.t09_mes)  SEPARATOR ','), '), ya que la duracion del Proyecto es de ',proy.t02_num_mes,' meses.') 
  FROM 	   t09_sub_act_mtas mta
LEFT  JOIN t02_dg_proy      proy ON (mta.t02_cod_proy=proy.t02_cod_proy AND proy.t02_version=1)
WHERE mta.t02_cod_proy = _proy
  AND mta.t02_version  = _ver
  AND fn_numero_mes(mta.t09_anio, mta.t09_mes) > proy.t02_num_mes
GROUP BY mta.t08_cod_comp, 
	mta.t09_cod_act,
	mta.t09_cod_sub ;
select * from tmp_mensajes ;
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;
/*!50003 DROP PROCEDURE IF EXISTS `__sp_rpt_presup_analitico` */;
/*!50003 SET @saved_cs_client      = @@character_set_client */ ;
/*!50003 SET @saved_cs_results     = @@character_set_results */ ;
/*!50003 SET @saved_col_connection = @@collation_connection */ ;
/*!50003 SET character_set_client  = utf8 */ ;
/*!50003 SET character_set_results = utf8 */ ;
/*!50003 SET collation_connection  = utf8_general_ci */ ;
/*!50003 SET @saved_sql_mode       = @@sql_mode */ ;
/*!50003 SET sql_mode              = 'NO_AUTO_VALUE_ON_ZERO' */ ;
DELIMITER ;;
CREATE DEFINER=`root`@`localhost` PROCEDURE `__sp_rpt_presup_analitico`(IN _proy VARCHAR(10), IN _ver INT)
BEGIN
DECLARE _sql      LONGTEXT;
DECLARE _contador  INT ;
DECLARE _codfte   INT ;
DECLARE _nomfte   VARCHAR(50) ;
DECLARE _codFE    INT DEFAULT 10 ;

DECLARE _temp_comp_ope VARCHAR(500);
DECLARE _temp_act_ope  VARCHAR(500);
DECLARE _temp_sub_ope  VARCHAR(500);
DECLARE _temp_cat_ope  VARCHAR(700);
DECLARE _fte_comp_ope TEXT DEFAULT '';
DECLARE _fte_act_ope  TEXT DEFAULT '';
DECLARE _fte_sub_ope  TEXT DEFAULT '';
DECLARE _fte_cat_ope  TEXT DEFAULT '';

DECLARE _temp_comp_mp VARCHAR(500);
DECLARE _temp_act_mp  VARCHAR(500);
DECLARE _temp_sub_mp  VARCHAR(500);
DECLARE _temp_cat_mp  VARCHAR(700);
DECLARE _fte_comp_mp TEXT DEFAULT '';
DECLARE _fte_act_mp  TEXT DEFAULT '';
DECLARE _fte_sub_mp  TEXT DEFAULT '';
DECLARE _fte_cat_mp  TEXT DEFAULT '';

DROP TEMPORARY TABLE IF EXISTS tmpFuentes;
CREATE TEMPORARY TABLE tmpFuentes 
( id INT AUTO_INCREMENT,
  idfte INT,
  nomfte VARCHAR(250),
  PRIMARY KEY (id)
) ;
INSERT INTO tmpFuentes(idfte, nomfte)
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
inner JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  AND f.t01_id_inst = _codFE
UNION ALL
SELECT 	f.t01_id_inst,
	i.t01_sig_inst
FROM 	  t02_fuente_finan f
inner JOIN t01_dir_inst     i ON (f.t01_id_inst=i.t01_id_inst)
WHERE f.t02_cod_proy=_proy 
  AND f.t01_id_inst <> _codFE ;
  

SET _temp_comp_ope= "(SELECT 	SUM(fte.t10_mont)
		       FROM 	t10_cost_fte fte
		      WHERE fte.t02_cod_proy = c.t02_cod_proy
		        AND fte.t02_version  = c.t02_version
		        AND fte.t08_cod_comp = c.t08_cod_comp
		        AND fte.t01_id_inst  = _idfte
		     ) AS '_nomfte' " ;
SET _temp_act_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = a.t02_cod_proy
			    AND fte.t02_version  = a.t02_version
			    AND fte.t08_cod_comp = a.t08_cod_comp
			    AND fte.t09_cod_act  = a.t09_cod_act
			    AND fte.t01_id_inst  = _idfte
			)  AS '_nomfte' " ;
			
SET _temp_sub_ope = " (  SELECT SUM(fte.t10_mont)
			   FROM t10_cost_fte fte
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND fte.t01_id_inst  = _idfte
			 ) AS '_nomfte' " ;
			 
SET _temp_cat_ope = "  ( SELECT  SUM(fte.t10_mont)
			   FROM     t10_cost_fte fte
			 INNER JOIN t10_cost_sub cost ON ( fte.t02_cod_proy = cost.t02_cod_proy AND fte.t02_version  = cost.t02_version AND fte.t08_cod_comp = cost.t08_cod_comp AND fte.t09_cod_act  = cost.t09_cod_act AND fte.t09_cod_sub  = cost.t09_cod_sub AND fte.t10_cod_cost = cost.t10_cod_cost )
			  WHERE fte.t02_cod_proy = s.t02_cod_proy
			    AND fte.t02_version  = s.t02_version
			    AND fte.t08_cod_comp = s.t08_cod_comp
			    AND fte.t09_cod_act  = s.t09_cod_act
			    AND fte.t09_cod_sub  = s.t09_cod_sub
			    AND cost.t10_cate_cost = p.t10_cate_cost
			    AND fte.t01_id_inst  = _idfte
			 )  AS '_nomfte' " ;

SET _temp_comp_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_act_mp= "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SET _temp_sub_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
		       
SET _temp_cat_mp = "  (	  SELECT SUM(aporte_fuente)
			    FROM v_manejo_proyecto_fuentes fte 
			   WHERE fte.proyecto = vmp.proyecto
			     AND fte.vs  = vmp.vs
			     AND fte.componente = vmp.componente
			     AND fte.actividad  = vmp.actividad
			     AND fte.codsub     = vmp.codsub
			     AND fte.rubro      = (CASE WHEN vmp.subactividad IS NULL THEN vmp.codigo ELSE (vmp.cate_gasto - 80) END) 
			     AND fte.idinst = _idfte
		       ) AS '_nomfte' " ;
SELECT 1 INTO _contador ;  
WHILE (SELECT COUNT(1) FROM  tmpFuentes) >= _contador DO
	SELECT idfte  ,  nomfte
	INTO   _codfte, _nomfte 
	FROM tmpFuentes 
	WHERE id = _contador;
	
	SET _fte_comp_ope = CONCAT(_fte_comp_ope, ',' , REPLACE(REPLACE(_temp_comp_ope,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_ope  = CONCAT(_fte_act_ope , ',' , REPLACE(REPLACE(_temp_act_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_ope  = CONCAT(_fte_sub_ope , ',' , REPLACE(REPLACE(_temp_sub_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_ope  = CONCAT(_fte_cat_ope , ',' , REPLACE(REPLACE(_temp_cat_ope ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _fte_comp_mp = CONCAT(_fte_comp_mp, ',' , REPLACE(REPLACE(_temp_comp_mp,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_act_mp  = CONCAT(_fte_act_mp , ',' , REPLACE(REPLACE(_temp_act_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_sub_mp  = CONCAT(_fte_sub_mp , ',' , REPLACE(REPLACE(_temp_sub_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	SET _fte_cat_mp  = CONCAT(_fte_cat_mp , ',' , REPLACE(REPLACE(_temp_cat_mp ,'_idfte', _codfte),'_nomfte', _nomfte) ) ;
	
	SET _contador = _contador + 1;
END WHILE;
DROP TEMPORARY TABLE tmpFuentes; 
SET _sql = "
SELECT 	c.t08_cod_comp AS codigo, 
	TRIM(c.t08_comp_desc) AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=c.t02_cod_proy 
	     AND cost.t02_version =c.t02_version 
	     AND cost.t08_cod_comp=c.t08_cod_comp
	) AS total,
	'componente' AS tipo,
	' ' AS act_add,
	c.t08_cod_comp AS codigo_real
	[_fte_comp_ope]
FROM  t08_comp c
WHERE c.t02_cod_proy = _proy
  AND c.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo, 
	TRIM(a.t09_act) AS descripcion,
	NULL AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS parcial,
	NULL AS meta,
	( SELECT SUM((cost.t10_cant * cost.t10_cu) * sub.t09_mta)
	    FROM       t10_cost_sub cost 
	    INNER JOIN t09_subact   sub  ON(sub.t02_cod_proy=cost.t02_cod_proy AND sub.t02_version=cost.t02_version AND sub.t08_cod_comp=cost.t08_cod_comp AND sub.t09_cod_act=cost.t09_cod_act AND sub.t09_cod_sub=cost.t09_cod_sub)
	   WHERE cost.t02_cod_proy=a.t02_cod_proy 
	     AND cost.t02_version =a.t02_version 
	     AND cost.t08_cod_comp=a.t08_cod_comp
	     AND cost.t09_cod_act =a.t09_cod_act
	) AS total,
	'actividad' AS tipo,
	' ' AS act_add,
	CONCAT(a.t08_cod_comp,'.',a.t09_cod_act) AS codigo_real
	[_fte_act_ope]
FROM  t09_act a
WHERE a.t02_cod_proy = _proy
  AND a.t02_version  = _ver
  
UNION ALL
SELECT 	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo, 
	TRIM(s.t09_sub) AS descripcion,
	s.t09_um AS um,
	(
	  SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) AS parcial,
	s.t09_mta AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost
	   WHERE cost.t02_cod_proy=s.t02_cod_proy 
	     AND cost.t02_version =s.t02_version 
	     AND cost.t08_cod_comp=s.t08_cod_comp
	     AND cost.t09_cod_act =s.t09_cod_act
	     AND cost.t09_cod_sub =s.t09_cod_sub 
	) * s.t09_mta) AS total,
	'subactividad' AS tipo,
	IF(s.t02_version > 1,
			 IF(s.t09_cod_sub IN (
					SELECT suba.t09_cod_sub	AS subact		 
					FROM t09_subact suba
					WHERE  suba.t02_cod_proy = _proy
					  AND  suba.t08_cod_comp = s.t08_cod_comp 
					  AND  suba.t09_cod_act  = s.t09_cod_act
						AND  suba.t02_version  = 1
					  GROUP BY 1
					  ORDER BY subact
						),'','1')		  
	   ,'') AS act_add	,
	CONCAT(s.t08_cod_comp,'.',s.t09_cod_act, '.', s.t09_cod_sub) AS codigo_real
	[_fte_sub_ope]
FROM  t09_subact s
WHERE s.t02_cod_proy = _proy 
  AND s.t02_version  = _ver
UNION ALL
SELECT 	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', t.cod_ext) AS codigo,
	TRIM(t.descrip) AS descripcion,
	NULL AS um,
	SUM(p.t10_cant * p.t10_cu) AS parcial,
	NULL AS meta,
	(( SELECT SUM(cost.t10_cant * cost.t10_cu) 
	    FROM t10_cost_sub cost 
	   WHERE cost.t02_cod_proy=p.t02_cod_proy 
	     AND cost.t02_version =p.t02_version 
	     AND cost.t08_cod_comp=p.t08_cod_comp
	     AND cost.t09_cod_act =p.t09_cod_act
	     AND cost.t09_cod_sub =p.t09_cod_sub
	     AND cost.t10_cate_cost=t.codi
	) * s.t09_mta) AS total,
	'rubro' AS tipo,
	' ' AS act_add,
	CONCAT(p.t08_cod_comp,'.', p.t09_cod_act,'.', p.t09_cod_sub,'.', p.t10_cate_cost) AS codigo_real
	[_fte_cat_ope]
FROM 	  t10_cost_sub p
INNER JOIN t09_subact  s ON(s.t02_cod_proy=p.t02_cod_proy AND s.t02_version=p.t02_version AND s.t08_cod_comp=p.t08_cod_comp AND s.t09_cod_act=p.t09_cod_act AND s.t09_cod_sub=p.t09_cod_sub)
LEFT  JOIN adm_tablas_aux t ON (p.t10_cate_cost=t.codi) 
WHERE p.t02_cod_proy = _proy 
  AND p.t02_version  = _ver
GROUP BY 1,2,3 
UNION ALL
 
SELECT 	vmp.componente AS codigo, 
	'Manejo del Proyecto' AS descripcion,
	NULL AS um,
	NULL AS parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'componente' AS tipo,
	' ' AS act_add,
	CONCAT(80 + vmp.componente) AS codigo_real
	[_fte_comp_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver 
  GROUP BY 1,2,3,4,5
UNION ALL
SELECT 	CONCAT(componente,'.',actividad) AS codigo, 
	vmp.nom_actividad AS descripcion,
	NULL AS um,
	SUM(vmp.gasto) parcial,
	NULL AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'actividad' AS tipo,
	' ' AS act_add,
	CONCAT(80 + componente,'.',actividad) AS codigo_real
	[_fte_act_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
 GROUP BY 1,2,3
UNION ALL
SELECT 	CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nom_cate_gasto
	 ELSE
	      vmp.subactividad
	 END 
	) AS descripcion,
	vmp.um AS um,
	SUM(vmp.gasto) parcial,
	vmp.meta AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'subactividad' AS tipo,
	'' AS act_add,
	
	CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub) AS codigo_real
	[_fte_sub_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.codsub is not null
 GROUP BY 1,2
UNION ALL
SELECT 	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo)
	 ELSE
	      CONCAT(vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto - 80))
	 END 
	) AS codigo,
	
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      vmp.nombre
	 ELSE
	      vmp.nom_cate_gasto
	 END 
	) AS descripcion,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.um ELSE NULL END )AS um,
	SUM(vmp.gasto) parcial,
	(CASE WHEN vmp.subactividad IS NULL THEN vmp.meta ELSE NULL END )AS meta,
	SUM(vmp.gasto * vmp.meta) AS total,
	'rubro' AS tipo,
	' ' AS act_add,
	(CASE WHEN vmp.subactividad IS NULL THEN 
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',vmp.codigo + 10)
	 ELSE
	      CONCAT(80 + vmp.componente,'.',vmp.actividad, '.', vmp.codsub,'.',(vmp.cate_gasto))
	 END 
	) AS codigo_real
	[_fte_cat_mp]
FROM  v_manejo_proyecto_completo vmp
WHERE vmp.proyecto = _proy
  AND vmp.vs = _ver
  and vmp.cate_gasto is not null
  GROUP BY 1, 2, 3 
  
ORDER BY codigo_real ; " ; 
  
 
SET _sql = REPLACE(_sql,' _proy', CONCAT(" '",_proy,"'"));
SET _sql = REPLACE(_sql,' _ver', _ver);
SET _sql = REPLACE(_sql,'[_fte_comp_ope]', _fte_comp_ope);
SET _sql = REPLACE(_sql,'[_fte_act_ope]' , _fte_act_ope );
SET _sql = REPLACE(_sql,'[_fte_sub_ope]' , _fte_sub_ope );
SET _sql = REPLACE(_sql,'[_fte_cat_ope]' , _fte_cat_ope );
SET _sql = REPLACE(_sql,'[_fte_comp_mp]', _fte_comp_mp);
SET _sql = REPLACE(_sql,'[_fte_act_mp]' , _fte_act_mp );
SET _sql = REPLACE(_sql,'[_fte_sub_mp]' , _fte_sub_mp );
SET _sql = REPLACE(_sql,'[_fte_cat_mp]' , _fte_cat_mp );
SELECT _sql INTO @txtsql;
PREPARE stmt FROM @txtsql;
EXECUTE stmt;
DEALLOCATE PREPARE stmt;  
 
 
 
END ;;
DELIMITER ;
/*!50003 SET sql_mode              = @saved_sql_mode */ ;
/*!50003 SET character_set_client  = @saved_cs_client */ ;
/*!50003 SET character_set_results = @saved_cs_results */ ;
/*!50003 SET collation_connection  = @saved_col_connection */ ;

--
-- Final view structure for view `v_actividades`
--

/*!50001 DROP TABLE IF EXISTS `v_actividades`*/;
/*!50001 DROP VIEW IF EXISTS `v_actividades`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_actividades` AS select `a`.`t02_cod_proy` AS `t02_cod_proy`,`a`.`t02_version` AS `t02_version`,concat(`a`.`t08_cod_comp`,_utf8'.',`a`.`t09_cod_act`) AS `codigo`,`a`.`t09_act` AS `descripcion` from `t09_act` `a` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',1) AS `codigo`,_utf8'Personal del Proyecto' AS `descripcion` from `t02_dg_proy` `p` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',2) AS `codigo`,_utf8'Equipamiento del Proyecto' AS `descripcion` from `t02_dg_proy` `p` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',3) AS `codigo`,_utf8'Gastos de Funcionamientos' AS `descripcion` from `t02_dg_proy` `p` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',4) AS `codigo`,_utf8'Gastos Administrativos' AS `descripcion` from `t02_dg_proy` `p` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',5) AS `codigo`,_utf8'Línea de Base Y Evaluación de Impacto' AS `descripcion` from `t02_dg_proy` `p` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',6) AS `codigo`,_utf8'Imprevistos' AS `descripcion` from `t02_dg_proy` `p` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_aportes_proyectos`
--

/*!50001 DROP TABLE IF EXISTS `v_aportes_proyectos`*/;
/*!50001 DROP VIEW IF EXISTS `v_aportes_proyectos`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_aportes_proyectos` AS select `proy`.`t02_cod_proy` AS `codigo`,`inst`.`t01_sig_inst` AS `institucion`,`tip`.`abrev` AS `tipoinst`,`fn_total_aporte_fuentes_financ3`(`proy`.`t02_cod_proy`,1,10) AS `aportefe`,(select sum(`fn_total_aporte_fuentes_financ3`(`ftes`.`t02_cod_proy`,1,`ftes`.`t01_id_inst`)) from `t02_fuente_finan` `ftes` where ((`ftes`.`t02_cod_proy` = `proy`.`t02_cod_proy`) and (`ftes`.`t01_id_inst` <> 10))) AS `aporteotros` from (((`t02_dg_proy` `proy` left join `t01_dir_inst` `inst` on((`proy`.`t01_id_inst` = `inst`.`t01_id_inst`))) left join `adm_tablas_aux` `tip` on((`inst`.`t01_tipo_inst` = `tip`.`codi`))) left join `adm_tablas_aux` `e` on((`proy`.`t02_estado` = `e`.`codi`))) where ((`proy`.`t02_version` = `fn_ult_version_proy`(`proy`.`t02_cod_proy`)) and (`e`.`cod_ext` in (1,4,5))) order by (`aportefe` + `aporteotros`) desc */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_componentes`
--

/*!50001 DROP TABLE IF EXISTS `v_componentes`*/;
/*!50001 DROP VIEW IF EXISTS `v_componentes`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_componentes` AS select `c`.`t02_cod_proy` AS `t02_cod_proy`,`c`.`t02_version` AS `t02_version`,`c`.`t08_cod_comp` AS `codigo`,`c`.`t08_comp_desc` AS `descripcion` from `t08_comp` `c` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,10 AS `codigo`,_utf8'Manejo del Proyecto' AS `descripcion` from `t02_dg_proy` `p` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_cuentas_proy`
--

/*!50001 DROP TABLE IF EXISTS `v_cuentas_proy`*/;
/*!50001 DROP VIEW IF EXISTS `v_cuentas_proy`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_cuentas_proy` AS select `pcta`.`t02_cod_proy` AS `t02_cod_proy`,`pcta`.`t01_id_inst` AS `t01_id_inst`,`pcta`.`t01_id_cta` AS `t01_id_cta`,`bco`.`t00_nom_abre` AS `banco`,`bco`.`t00_nom_lar` AS `banco2`,`tcta`.`t00_nom_lar` AS `tcuenta`,`mon`.`t00_nom_lar` AS `moneda`,`cta`.`t01_cta_def` AS `is_default`,`pcta`.`est_audi` AS `est_audi`,`cta`.`t01_nro_cta` AS `nrocuenta`,`pcta`.`t02_nom_benef` AS `t02_nom_benef`,concat(`cta`.`t01_nro_cta`,' - ',`bco`.`t00_nom_abre`) AS `descripcion` from ((((`t02_proy_ctas` `pcta` left join `t01_inst_ctas` `cta` on(((`pcta`.`t01_id_inst` = `cta`.`t01_id_inst`) and (`pcta`.`t01_id_cta` = `cta`.`t01_id_cta`)))) left join `t00_bancos` `bco` on((`cta`.`t00_cod_bco` = `bco`.`t00_cod_bco`))) left join `t00_tipo_cuenta` `tcta` on((`cta`.`t00_cod_cta` = `tcta`.`t00_cod_cta`))) left join `t00_tipo_moneda` `mon` on((`cta`.`t00_cod_mon` = `mon`.`t00_cod_mon`))) order by `pcta`.`t02_cod_proy` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_inf_mes_prob_soluc`
--

/*!50001 DROP TABLE IF EXISTS `v_inf_mes_prob_soluc`*/;
/*!50001 DROP VIEW IF EXISTS `v_inf_mes_prob_soluc`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_inf_mes_prob_soluc` AS select 1 AS `t20_cod_prob`,_utf8'' AS `t20_problemas`,_utf8'' AS `t20_soluciones`,_utf8'' AS `t20_resultados` union all select 2 AS `t20_cod_prob`,_utf8'' AS `t20_problemas`,_utf8'' AS `t20_soluciones`,_utf8'' AS `t20_resultados` union all select 3 AS `t20_cod_prob`,_utf8'' AS `t20_problemas`,_utf8'' AS `t20_soluciones`,_utf8'' AS `t20_resultados` union all select 4 AS `t20_cod_prob`,_utf8'' AS `t20_problemas`,_utf8'' AS `t20_soluciones`,'' AS `t20_resultados` union all select 5 AS `t20_cod_prob`,_utf8'' AS `t20_problemas`,_utf8'' AS `t20_soluciones`,_utf8'' AS `t20_resultados` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_manejo_proyecto`
--

/*!50001 DROP TABLE IF EXISTS `v_manejo_proyecto`*/;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_manejo_proyecto` AS select `per`.`t02_cod_proy` AS `proyecto`,`per`.`t02_version` AS `vs`,10 AS `componente`,1 AS `actividad`,_utf8'Personal del Proyecto' AS `nom_actividad`,12 AS `codsub`,NULL AS `subactividad`,12 AS `cate_gasto`,_utf8'Remuneraciones' AS `nom_cate_gasto`,`per`.`t03_id_per` AS `codigo`,`per`.`t03_nom_per` AS `nombre`,`unm`.`descrip` AS `um`,`per`.`t03_remu_prom` AS `gasto`,`per`.`t03_gasto_tot` AS `total`,(select sum(`mta`.`t03_mta`) AS `meta` from `t03_mp_per_metas` `mta` where ((`per`.`t02_cod_proy` = `mta`.`t02_cod_proy`) and (`per`.`t02_version` = `mta`.`t02_version`) and (`per`.`t03_id_per` = `mta`.`t03_id_per`))) AS `meta` from (`t03_mp_per` `per` left join `adm_tablas_aux` `unm` on((`per`.`t03_um` = `unm`.`codi`))) union all select `equi`.`t02_cod_proy` AS `proyecto`,`equi`.`t02_version` AS `vs`,10 AS `componente`,2 AS `actividad`,_utf8'Equipamiento del Proyecto' AS `nom_actividad`,3 AS `codsub`,NULL AS `subactividad`,3 AS `cate_gasto`,_utf8'Equipos y Bienes Duraderos' AS `nom_cate_gasto`,`equi`.`t03_id_equi` AS `codigo`,`equi`.`t03_nom_equi` AS `nombre`,`equi`.`t03_um` AS `um`,`equi`.`t03_costo` AS `gasto`,`equi`.`t03_costo_tot` AS `total`,(select sum(`mta`.`t03_mta`) AS `meta` from `t03_mp_equi_metas` `mta` where ((`equi`.`t02_cod_proy` = `mta`.`t02_cod_proy`) and (`equi`.`t02_version` = `mta`.`t02_version`) and (`equi`.`t03_id_equi` = `mta`.`t03_id_equi`))) AS `meta` from `t03_mp_equi` `equi` union all select `cost`.`t02_cod_proy` AS `proyecto`,`cost`.`t02_version` AS `vs`,10 AS `componente`,3 AS `actividad`,_utf8'Gastos de Funcionamiento' AS `nom_actividad`,`p`.`cod_ext` AS `codsub`,`p`.`descrip` AS `subactividad`,`cost`.`t03_cat_gast` AS `cate_gasto`,`c`.`descrip` AS `nom_cate_gasto`,concat(`p`.`cod_ext`,_utf8'.',`cost`.`t03_id_gasto`) AS `codigo`,`cost`.`t03_descrip` AS `nombre`,`cost`.`t03_um` AS `um`,(`cost`.`t03_cu` * `cost`.`t03_cant`) AS `gasto`,((`cost`.`t03_cu` * `cost`.`t03_cant`) * `parti`.`t03_meta`) AS `total`,`parti`.`t03_meta` AS `meta` from (((`t03_mp_gas_fun_cost` `cost` join `t03_mp_gas_fun_part` `parti` on(((`cost`.`t02_cod_proy` = `parti`.`t02_cod_proy`) and (`cost`.`t02_version` = `parti`.`t02_version`) and (`cost`.`t03_partida` = `parti`.`t03_partida`)))) left join `adm_tablas_aux` `p` on((`parti`.`t03_partida` = `p`.`codi`))) left join `adm_tablas_aux` `c` on((`cost`.`t03_cat_gast` = `c`.`codi`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_manejo_proyecto_completo`
--

/*!50001 DROP TABLE IF EXISTS `v_manejo_proyecto_completo`*/;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_completo`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`soporte`@`%` SQL SECURITY DEFINER */
/*!50001 VIEW `v_manejo_proyecto_completo` AS select `per`.`t02_cod_proy` AS `proyecto`,`per`.`t02_version` AS `vs`,10 AS `componente`,1 AS `actividad`,'Personal del Proyecto' AS `nom_actividad`,12 AS `codsub`,NULL AS `subactividad`,12 AS `cate_gasto`,'Remuneraciones' AS `nom_cate_gasto`,`per`.`t03_id_per` AS `codigo`,`per`.`t03_nom_per` AS `nombre`,`unm`.`descrip` AS `um`,`per`.`t03_remu_prom` AS `gasto`,`per`.`t03_gasto_tot` AS `total`,(select sum(`mta`.`t03_mta`) AS `meta` from `t03_mp_per_metas` `mta` where ((`per`.`t02_cod_proy` = `mta`.`t02_cod_proy`) and (`per`.`t02_version` = `mta`.`t02_version`) and (`per`.`t03_id_per` = `mta`.`t03_id_per`))) AS `meta` from (`t03_mp_per` `per` left join `adm_tablas_aux` `unm` on((`per`.`t03_um` = `unm`.`codi`))) union all select `equi`.`t02_cod_proy` AS `proyecto`,`equi`.`t02_version` AS `vs`,10 AS `componente`,2 AS `actividad`,'Equipamiento del Proyecto' AS `nom_actividad`,3 AS `codsub`,NULL AS `subactividad`,3 AS `cate_gasto`,'Equipos y Bienes Duraderos' AS `nom_cate_gasto`,`equi`.`t03_id_equi` AS `codigo`,`equi`.`t03_nom_equi` AS `nombre`,`equi`.`t03_um` AS `um`,`equi`.`t03_costo` AS `gasto`,`equi`.`t03_costo_tot` AS `total`,(select sum(`mta`.`t03_mta`) AS `meta` from `t03_mp_equi_metas` `mta` where ((`equi`.`t02_cod_proy` = `mta`.`t02_cod_proy`) and (`equi`.`t02_version` = `mta`.`t02_version`) and (`equi`.`t03_id_equi` = `mta`.`t03_id_equi`))) AS `meta` from `t03_mp_equi` `equi` union all select `cost`.`t02_cod_proy` AS `proyecto`,`cost`.`t02_version` AS `vs`,10 AS `componente`,3 AS `actividad`,'Gastos de Funcionamiento' AS `nom_actividad`,`p`.`cod_ext` AS `codsub`,`p`.`descrip` AS `subactividad`,`cost`.`t03_cat_gast` AS `cate_gasto`,`c`.`descrip` AS `nom_cate_gasto`,concat(`parti`.`t03_partida`,'.',`cost`.`t03_id_gasto`) AS `codigo`,`cost`.`t03_descrip` AS `nombre`,`cost`.`t03_um` AS `um`,(`cost`.`t03_cu` * `cost`.`t03_cant`) AS `gasto`,((`cost`.`t03_cu` * `cost`.`t03_cant`) * `parti`.`t03_meta`) AS `total`,`parti`.`t03_meta` AS `meta` from (((`t03_mp_gas_fun_cost` `cost` join `t03_mp_gas_fun_part` `parti` on(((`cost`.`t02_cod_proy` = `parti`.`t02_cod_proy`) and (`cost`.`t02_version` = `parti`.`t02_version`) and (`cost`.`t03_partida` = `parti`.`t03_partida`)))) left join `adm_tablas_aux` `p` on((`parti`.`t03_partida` = `p`.`codi`))) left join `adm_tablas_aux` `c` on((`cost`.`t03_cat_gast` = `c`.`codi`))) union all select `adm`.`t02_cod_proy` AS `proyecto`,`adm`.`t02_version` AS `vs`,10 AS `componente`,4 AS `actividad`,'Gastos Administrativos' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Gastos Administrativos' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`adm`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`adm`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_gas_adm` `adm` left join `t02_dg_proy` `p` on(((`adm`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`adm`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 union all select `lba`.`t02_cod_proy` AS `proyecto`,`lba`.`t02_version` AS `vs`,10 AS `componente`,5 AS `actividad`,'Línea de Base y Evaluación de Impacto' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Línea de Base y Evaluación de Impacto' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`lba`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`lba`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_linea_base` `lba` left join `t02_dg_proy` `p` on(((`lba`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`lba`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 union all select `imp`.`t02_cod_proy` AS `proyecto`,`imp`.`t02_version` AS `vs`,10 AS `componente`,6 AS `actividad`,'Imprevistos' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Imprevistos' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`imp`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`imp`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_imprevistos` `imp` left join `t02_dg_proy` `p` on(((`imp`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`imp`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 union all select `sup`.`t02_cod_proy` AS `proyecto`,`sup`.`t02_version` AS `vs`,10 AS `componente`,7 AS `actividad`,'Gastos de Supervisión' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Gastos de Supervisión' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`sup`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`sup`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_gas_supervision` `sup` left join `t02_dg_proy` `p` on(((`sup`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`sup`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_manejo_proyecto_fuentes`
--

/*!50001 DROP TABLE IF EXISTS `v_manejo_proyecto_fuentes`*/;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_fuentes`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`soporte`@`%` SQL SECURITY DEFINER */
/*!50001 VIEW `v_manejo_proyecto_fuentes` AS select `fte`.`t02_cod_proy` AS `proyecto`,`fte`.`t02_version` AS `vs`,10 AS `componente`,1 AS `actividad`,12 AS `codsub`,`fte`.`t03_id_per` AS `rubro`,'Personal del Proyecto' AS `nomactividad`,`fte`.`t03_id_inst` AS `idinst`,`i`.`t01_sig_inst` AS `siglas`,`fte`.`t03_monto` AS `aporte_fuente` from (`t03_mp_per_ftes` `fte` left join `t01_dir_inst` `i` on((`fte`.`t03_id_inst` = `i`.`t01_id_inst`))) union all select `fte`.`t02_cod_proy` AS `proyecto`,`fte`.`t02_version` AS `vs`,10 AS `componente`,2 AS `actividad`,3 AS `codsub`,`fte`.`t03_id_equi` AS `rubro`,'Equipamiento del Proyecto' AS `nomactividad`,`fte`.`t03_id_inst` AS `idinst`,`i`.`t01_sig_inst` AS `siglas`,`fte`.`t03_monto` AS `aporte_fuente` from (`t03_mp_equi_ftes` `fte` left join `t01_dir_inst` `i` on((`fte`.`t03_id_inst` = `i`.`t01_id_inst`))) union all select `fte`.`t02_cod_proy` AS `proyecto`,`fte`.`t02_version` AS `vs`,10 AS `componente`,3 AS `actividad`,`p`.`cod_ext` AS `codsub`,`c`.`cod_ext` AS `rubro`,'Gastos de Funcionamiento' AS `nomactividad`,`fte`.`t03_id_inst` AS `idinst`,`i`.`t01_sig_inst` AS `siglas`,`fte`.`t03_monto` AS `aporte_fuente` from (((((`t03_mp_gas_fun_ftes` `fte` join `t03_mp_gas_fun_cost` `cost` on(((`fte`.`t02_cod_proy` = `cost`.`t02_cod_proy`) and (`fte`.`t02_version` = `cost`.`t02_version`) and (`fte`.`t03_partida` = `cost`.`t03_partida`) and (`fte`.`t03_id_gasto` = `cost`.`t03_id_gasto`)))) join `t03_mp_gas_fun_part` `parti` on(((`cost`.`t02_cod_proy` = `parti`.`t02_cod_proy`) and (`cost`.`t02_version` = `parti`.`t02_version`) and (`cost`.`t03_partida` = `parti`.`t03_partida`)))) left join `t01_dir_inst` `i` on((`fte`.`t03_id_inst` = `i`.`t01_id_inst`))) left join `adm_tablas_aux` `p` on((`parti`.`t03_partida` = `p`.`codi`))) left join `adm_tablas_aux` `c` on((`cost`.`t03_cat_gast` = `c`.`codi`))) union all select `fte`.`t02_cod_proy` AS `proyecto`,`fte`.`t02_version` AS `vs`,10 AS `componente`,4 AS `actividad`,NULL AS `codsub`,NULL AS `rubro`,'Gastos Administrativos' AS `nomactividad`,`fte`.`t03_id_inst` AS `idinst`,`i`.`t01_sig_inst` AS `siglas`,`fte`.`t03_monto` AS `aporte_fuente` from (`t03_mp_gas_adm` `fte` left join `t01_dir_inst` `i` on((`fte`.`t03_id_inst` = `i`.`t01_id_inst`))) union all select `fte`.`t02_cod_proy` AS `proyecto`,`fte`.`t02_version` AS `vs`,10 AS `componente`,5 AS `actividad`,NULL AS `codsub`,NULL AS `rubro`,'Línea de Base' AS `nomactividad`,`fte`.`t03_id_inst` AS `idinst`,`i`.`t01_sig_inst` AS `siglas`,`fte`.`t03_monto` AS `aporte_fuente` from (`t03_mp_linea_base` `fte` left join `t01_dir_inst` `i` on((`fte`.`t03_id_inst` = `i`.`t01_id_inst`))) union all select `fte`.`t02_cod_proy` AS `proyecto`,`fte`.`t02_version` AS `vs`,10 AS `componente`,6 AS `actividad`,NULL AS `codsub`,NULL AS `rubro`,'Imprevistos' AS `nomactividad`,`fte`.`t03_id_inst` AS `idinst`,`i`.`t01_sig_inst` AS `siglas`,`fte`.`t03_monto` AS `aporte_fuente` from (`t03_mp_imprevistos` `fte` left join `t01_dir_inst` `i` on((`fte`.`t03_id_inst` = `i`.`t01_id_inst`))) union all select `fte`.`t02_cod_proy` AS `proyecto`,`fte`.`t02_version` AS `vs`,10 AS `componente`,7 AS `actividad`,NULL AS `codsub`,NULL AS `rubro`,'Gastos de Supervisión' AS `nomactividad`,`fte`.`t03_id_inst` AS `idinst`,`i`.`t01_sig_inst` AS `siglas`,`fte`.`t03_monto` AS `aporte_fuente` from (`t03_mp_gas_supervision` `fte` left join `t01_dir_inst` `i` on((`fte`.`t03_id_inst` = `i`.`t01_id_inst`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_manejo_proyecto_metas`
--

/*!50001 DROP TABLE IF EXISTS `v_manejo_proyecto_metas`*/;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_metas`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_manejo_proyecto_metas` AS select `pmta`.`t02_cod_proy` AS `t02_cod_proy`,`pmta`.`t02_version` AS `t02_version`,10 AS `cod_comp`,1 AS `cod_activ`,`pmta`.`t03_id_per` AS `cod_sub`,`pmta`.`t03_anio` AS `anio`,`pmta`.`t03_mes` AS `mes`,`pmta`.`t03_mta` AS `meta` from `t03_mp_per_metas` `pmta` union all select `emta`.`t02_cod_proy` AS `t02_cod_proy`,`emta`.`t02_version` AS `t02_version`,10 AS `cod_comp`,2 AS `cod_activ`,`emta`.`t03_id_equi` AS `cod_sub`,`emta`.`t03_anio` AS `anio`,`emta`.`t03_mes` AS `mes`,`emta`.`t03_mta` AS `meta` from `t03_mp_equi_metas` `emta` union all select `gfmta`.`t02_cod_proy` AS `t02_cod_proy`,`gfmta`.`t02_version` AS `t02_version`,10 AS `cod_comp`,3 AS `cod_activ`,`p`.`cod_ext` AS `cod_sub`,`gfmta`.`t03_anio` AS `anio`,`gfmta`.`t03_mes` AS `mes`,`gfmta`.`t03_mta` AS `meta` from (`t03_mp_gas_fun_metas` `gfmta` left join `adm_tablas_aux` `p` on((`gfmta`.`t03_partida` = `p`.`codi`))) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_manejo_proyecto_reprog`
--

/*!50001 DROP TABLE IF EXISTS `v_manejo_proyecto_reprog`*/;
/*!50001 DROP VIEW IF EXISTS `v_manejo_proyecto_reprog`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`soporte`@`%` SQL SECURITY DEFINER */
/*!50001 VIEW `v_manejo_proyecto_reprog` AS select `per`.`t02_cod_proy` AS `proyecto`,`per`.`t02_version` AS `vs`,10 AS `componente`,1 AS `actividad`,'Personal del Proyecto' AS `nom_actividad`,12 AS `codsub`,NULL AS `subactividad`,12 AS `cate_gasto`,'Remuneraciones' AS `nom_cate_gasto`,`per`.`t03_id_per` AS `codigo`,`per`.`t03_nom_per` AS `nombre`,`unm`.`descrip` AS `um`,`per`.`t03_remu_prom` AS `gasto`,`per`.`t03_gasto_tot` AS `total`,`per`.`t03_mta_repro` AS `meta` from (`t03_mp_per` `per` left join `adm_tablas_aux` `unm` on((`per`.`t03_um` = `unm`.`codi`))) union all select `equi`.`t02_cod_proy` AS `proyecto`,`equi`.`t02_version` AS `vs`,10 AS `componente`,2 AS `actividad`,'Equipamiento del Proyecto' AS `nom_actividad`,3 AS `codsub`,NULL AS `subactividad`,3 AS `cate_gasto`,'Equipos y Bienes Duraderos' AS `nom_cate_gasto`,`equi`.`t03_id_equi` AS `codigo`,`equi`.`t03_nom_equi` AS `nombre`,`equi`.`t03_um` AS `um`,`equi`.`t03_costo` AS `gasto`,`equi`.`t03_costo_tot` AS `total`,`equi`.`t03_mta_repro` AS `meta` from `t03_mp_equi` `equi` union all select `cost`.`t02_cod_proy` AS `proyecto`,`cost`.`t02_version` AS `vs`,10 AS `componente`,3 AS `actividad`,'Gastos de Funcionamiento' AS `nom_actividad`,`p`.`cod_ext` AS `codsub`,`p`.`descrip` AS `subactividad`,`cost`.`t03_cat_gast` AS `cate_gasto`,`c`.`descrip` AS `nom_cate_gasto`,concat(`parti`.`t03_partida`,'.',`cost`.`t03_id_gasto`) AS `codigo`,`cost`.`t03_descrip` AS `nombre`,`cost`.`t03_um` AS `um`,(`cost`.`t03_cu` * `cost`.`t03_cant`) AS `gasto`,((`cost`.`t03_cu` * `cost`.`t03_cant`) * `parti`.`t03_mta_repro`) AS `total`,`parti`.`t03_mta_repro` AS `meta` from (((`t03_mp_gas_fun_cost` `cost` join `t03_mp_gas_fun_part` `parti` on(((`cost`.`t02_cod_proy` = `parti`.`t02_cod_proy`) and (`cost`.`t02_version` = `parti`.`t02_version`) and (`cost`.`t03_partida` = `parti`.`t03_partida`)))) left join `adm_tablas_aux` `p` on((`parti`.`t03_partida` = `p`.`codi`))) left join `adm_tablas_aux` `c` on((`cost`.`t03_cat_gast` = `c`.`codi`))) union all select `adm`.`t02_cod_proy` AS `proyecto`,`adm`.`t02_version` AS `vs`,10 AS `componente`,4 AS `actividad`,'Gastos Administrativos' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Gastos Administrativos' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`adm`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`adm`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_gas_adm` `adm` left join `t02_dg_proy` `p` on(((`adm`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`adm`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 union all select `lba`.`t02_cod_proy` AS `proyecto`,`lba`.`t02_version` AS `vs`,10 AS `componente`,5 AS `actividad`,'Línea de Base y Evaluación de Impacto' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Línea de Base y Evaluación de Impacto' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`lba`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`lba`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_linea_base` `lba` left join `t02_dg_proy` `p` on(((`lba`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`lba`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 union all select `imp`.`t02_cod_proy` AS `proyecto`,`imp`.`t02_version` AS `vs`,10 AS `componente`,6 AS `actividad`,'Imprevistos' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Imprevistos' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`imp`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`imp`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_imprevistos` `imp` left join `t02_dg_proy` `p` on(((`imp`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`imp`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 union all select `sup`.`t02_cod_proy` AS `proyecto`,`sup`.`t02_version` AS `vs`,10 AS `componente`,7 AS `actividad`,'Gastos de Supervisión' AS `nom_actividad`,NULL AS `codsub`,NULL AS `subactividad`,NULL AS `cate_gasto`,'Gastos de Supervisión' AS `nom_cate_gasto`,0 AS `codigo`,0 AS `nombre`,'Mes' AS `um`,(sum(`sup`.`t03_monto`) / `p`.`t02_num_mes`) AS `gasto`,sum(`sup`.`t03_monto`) AS `total`,`p`.`t02_num_mes` AS `meta` from (`t03_mp_gas_supervision` `sup` left join `t02_dg_proy` `p` on(((`sup`.`t02_cod_proy` = `p`.`t02_cod_proy`) and (`sup`.`t02_version` = `p`.`t02_version`)))) group by 1,2,3,4,5,6,7,8,9,10,11,12 */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_matriz_proyectos`
--

/*!50001 DROP TABLE IF EXISTS `v_matriz_proyectos`*/;
/*!50001 DROP VIEW IF EXISTS `v_matriz_proyectos`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_matriz_proyectos` AS select `proy`.`t02_cod_proy` AS `codigo`,`proy`.`t02_version` AS `version`,`proy`.`t02_nro_exp` AS `expediente`,`proy`.`t01_id_inst` AS `codinst`,`proy`.`t02_nom_proy` AS `titulo`,date_format(`proy`.`t02_fch_ini`,'%d/%m/%Y') AS `inicio`,date_format(`proy`.`t02_fch_ter`,'%d/%m/%Y') AS `termino`,date_format(`proy`.`t02_fch_ire`,'%d/%m/%Y') AS `inic_real`,`proy`.`t02_fin` AS `finalidad`,`proy`.`t02_pro` AS `proposito`,`ins`.`t01_sig_inst` AS `siglas`,`ins`.`t01_nom_inst` AS `nominst`,`proy`.`t02_amb_geo` AS `ambito`,`proy`.`t02_ben_obj` AS `beneficiarios`,`proy`.`t02_sup_inst` AS `supervisor_inst`,`est`.`descrip` AS `estado`,`proy`.`t02_dire_proy` AS `direccion`,`proy`.`t02_ciud_proy` AS `ciudad`,`proy`.`t02_tele_proy` AS `telefono`,`proy`.`t02_mail_proy` AS `mail`,`proy`.`t02_pres_tot` AS `presupuesto`,`proy`.`t02_moni_ext` AS `cod_me`,concat(`mt`.`t90_ape_pat`,' ',`mt`.`t90_ape_mat`,', ',`mt`.`t90_nom_equi`) AS `moni_tema`,concat(`mf`.`t90_ape_pat`,' ',`mf`.`t90_ape_mat`,', ',`mf`.`t90_nom_equi`) AS `moni_fina`,concat(`sup`.`t01_ape_pat`,' ',`sup`.`t01_ape_mat`,', ',`sup`.`t01_nom_cto`) AS `supe_inst`,concat(`ext`.`t01_ape_pat`,' ',`ext`.`t01_ape_mat`,', ',`ext`.`t01_nom_cto`) AS `moni_exte`,(`proy`.`t02_num_mes` - (`proy`.`t02_num_mes` * (1 / 3))) AS `inf_planeados`,((to_days(curdate()) - to_days(`proy`.`t02_fch_ini`)) / 30) AS `tot_planeados_fecha`,`sec`.`descrip` AS `sector`,`ssec`.`descrip` AS `subsector`,`est`.`cod_ext` AS `codestado`,`ins`.`t01_tipo_inst` AS `codtipoinst`,`tip`.`abrev` AS `tipoinst`,`proy`.`t02_sect_prod` AS `codsector`,substr(`proy`.`t02_cod_proy`,3,2) AS `concurso`,`proy`.`t02_estado` AS `est`,`proy`.`t02_num_mes` AS `durameses`,`proy`.`t02_fch_ini` AS `t02_fch_ini`,`proy`.`t02_fch_ter` AS `t02_fch_ter`,`ins`.`t01_dpto` AS `t01_dpto`,`proy`.`t02_fch_tre` AS `t02_fch_tre`,`proy`.`t02_fch_tam` AS `t02_fch_tam`,`proy`.`t02_num_mes_amp` AS `t02_num_mes_amp`,if(((`proy`.`t02_fch_ire` is not null) and (date_format(`proy`.`t02_fch_ire`,'%d/%m/%Y') <> '00/00/0000')),`proy`.`t02_fch_ire`,`proy`.`t02_fch_ini`) AS `fecha_inicio`,(case when (`proy`.`t02_estado` = 41) then if((ifnull(`proy`.`t02_num_mes_amp`,0) > 0),`proy`.`t02_fch_tam`,`proy`.`t02_fch_tre`) else `proy`.`t02_fch_tre` end) AS `fecha_termino` from (((((((((`t02_dg_proy` `proy` join `t01_dir_inst` `ins` on((`proy`.`t01_id_inst` = `ins`.`t01_id_inst`))) left join `adm_tablas_aux` `est` on((`proy`.`t02_estado` = `est`.`codi`))) left join `t90_equi_fe` `mt` on((`proy`.`t02_moni_tema` = `mt`.`t90_id_equi`))) left join `t90_equi_fe` `mf` on((`proy`.`t02_moni_fina` = `mf`.`t90_id_equi`))) left join `t01_inst_cto` `sup` on(((`proy`.`t01_id_inst` = `sup`.`t01_id_inst`) and (`proy`.`t02_sup_inst` = `sup`.`t01_id_cto`)))) left join `t01_inst_cto` `ext` on((`proy`.`t02_moni_ext` = concat(`ext`.`t01_id_inst`,'.',`ext`.`t01_id_cto`)))) left join `adm_tablas_aux` `sec` on((`proy`.`t02_sect_prod` = `sec`.`codi`))) left join `adm_tablas_aux2` `ssec` on((`proy`.`t02_subsect_prod` = `ssec`.`codi`))) left join `adm_tablas_aux` `tip` on((`ins`.`t01_tipo_inst` = `tip`.`codi`))) where (`proy`.`t02_version` = `fn_ult_version_proy`(`proy`.`t02_cod_proy`)) order by `proy`.`t02_cod_proy` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_meses_anio`
--

/*!50001 DROP TABLE IF EXISTS `v_meses_anio`*/;
/*!50001 DROP VIEW IF EXISTS `v_meses_anio`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_meses_anio` AS select 1 AS `idmes`,_utf8'Enero' AS `nommes`,_utf8'Ene' AS `abreviado` union select 2 AS `idmes`,_utf8'Febrero' AS `nommes`,_utf8'Feb' AS `abreviado` union select 3 AS `idmes`,_utf8'Marzo' AS `nommes`,_utf8'Mar' AS `abreviado` union select 4 AS `idmes`,_utf8'Abril' AS `nommes`,_utf8'Abr' AS `abreviado` union select 5 AS `idmes`,_utf8'Mayo' AS `nommes`,_utf8'May' AS `abreviado` union select 6 AS `idmes`,_utf8'Junio' AS `nommes`,_utf8'Jun' AS `abreviado` union select 7 AS `idmes`,_utf8'Julio' AS `nommes`,_utf8'Jul' AS `abreviado` union select 8 AS `idmes`,_utf8'Agosto' AS `nommes`,_utf8'Ago' AS `abreviado` union select 9 AS `idmes`,_utf8'Setiembre' AS `nommes`,_utf8'Set' AS `abreviado` union select 10 AS `idmes`,_utf8'Octubre' AS `nommes`,_utf8'Oct' AS `abreviado` union select 11 AS `idmes`,_utf8'Noviembre' AS `nommes`,_utf8'Nov' AS `abreviado` union select 12 AS `idmes`,_utf8'Diciembre' AS `nommes`,_utf8'Dic' AS `abreviado` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_metas_proyecto_inicial`
--

/*!50001 DROP TABLE IF EXISTS `v_metas_proyecto_inicial`*/;
/*!50001 DROP VIEW IF EXISTS `v_metas_proyecto_inicial`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_metas_proyecto_inicial` AS select distinct `mta`.`t02_cod_proy` AS `proyecto`,`proy`.`t02_fch_ini` AS `inicio`,`mta`.`t03_anio` AS `anio`,`mta`.`t03_mes` AS `mes`,(`proy`.`t02_fch_ini` + interval `fn_numero_mes`(`mta`.`t03_anio`,(`mta`.`t03_mes` - 1)) month) AS `ini_mes`,(`mta`.`t03_mes` % 3) AS `residuo` from (`t03_mp_per_metas` `mta` left join `t02_dg_proy` `proy` on(((`mta`.`t02_cod_proy` = `proy`.`t02_cod_proy`) and (`proy`.`t02_version` = `fn_ult_version_proy`(`proy`.`t02_cod_proy`))))) where (`mta`.`t02_version` = 1) */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_periodos_proyecto`
--

/*!50001 DROP TABLE IF EXISTS `v_periodos_proyecto`*/;
/*!50001 DROP VIEW IF EXISTS `v_periodos_proyecto`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_periodos_proyecto` AS select `anio_mes`.`proyecto` AS `proyecto`,`anio_mes`.`inicio` AS `inicio`,`anio_mes`.`anio` AS `anio`,`anio_mes`.`mes` AS `mes`,`anio_mes`.`ini_mes` AS `ini_mes`,month(`anio_mes`.`ini_mes`) AS `num_mes`,`fn_nom_mes`(month(`anio_mes`.`ini_mes`)) AS `nom_mes`,ucase(substr(`fn_nom_mes`(month(`anio_mes`.`ini_mes`)),1,3)) AS `nom_abrev`,year(`anio_mes`.`ini_mes`) AS `num_anio`,(case when (`anio_mes`.`residuo` = 0) then truncate((`anio_mes`.`mes` / 3),0) else (truncate((`anio_mes`.`mes` / 3),0) + 1) end) AS `trimestre` from `v_metas_proyecto_inicial` `anio_mes` order by `anio_mes`.`anio`,`anio_mes`.`mes` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;

--
-- Final view structure for view `v_subactividades`
--

/*!50001 DROP TABLE IF EXISTS `v_subactividades`*/;
/*!50001 DROP VIEW IF EXISTS `v_subactividades`*/;
/*!50001 SET @saved_cs_client          = @@character_set_client */;
/*!50001 SET @saved_cs_results         = @@character_set_results */;
/*!50001 SET @saved_col_connection     = @@collation_connection */;
/*!50001 SET character_set_client      = utf8 */;
/*!50001 SET character_set_results     = utf8 */;
/*!50001 SET collation_connection      = utf8_general_ci */;
/*!50001 CREATE ALGORITHM=UNDEFINED */
/*!50013 DEFINER=`root`@`localhost` SQL SECURITY DEFINER */
/*!50001 VIEW `v_subactividades` AS select `s`.`t02_cod_proy` AS `t02_cod_proy`,`s`.`t02_version` AS `t02_version`,concat(`s`.`t08_cod_comp`,_utf8'.',`s`.`t09_cod_act`,_utf8'.',`s`.`t09_cod_sub`) AS `codigo`,`s`.`t09_sub` AS `descripcion`,`s`.`t09_um` AS `um`,`s`.`t09_mta` AS `meta` from `t09_subact` `s` union all select `gf`.`t02_cod_proy` AS `t02_cod_proy`,`gf`.`t02_version` AS `t02_version`,concat(10,_utf8'.',3,_utf8'.',`p`.`cod_ext`) AS `codigo`,`p`.`descrip` AS `descripcion`,`gf`.`t03_um` AS `um`,`gf`.`t03_meta` AS `meta` from (`t03_mp_gas_fun_part` `gf` left join `adm_tablas_aux` `p` on((`gf`.`t03_partida` = `p`.`codi`))) union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',1,_utf8'.',12) AS `codigo`,_utf8'Remuneraciones' AS `descripcion`,NULL AS `um`,NULL AS `meta` from `t02_dg_proy` `p` union all select distinct `p`.`t02_cod_proy` AS `t02_cod_proy`,`p`.`t02_version` AS `t02_version`,concat(10,_utf8'.',2,_utf8'.',3) AS `codigo`,_utf8'Equipos y Bienes Duraderos' AS `descripcion`,NULL AS `um`,NULL AS `meta` from `t02_dg_proy` `p` */;
/*!50001 SET character_set_client      = @saved_cs_client */;
/*!50001 SET character_set_results     = @saved_cs_results */;
/*!50001 SET collation_connection      = @saved_col_connection */;
/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;

/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;
/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;
/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;
/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;
/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;
/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;
/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;

-- Dump completed on 2014-04-21  7:55:59
